<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Nettyå®æˆ˜ â€” åŸºç¡€Demoä¸APIç½‘å…³å®æˆ˜</title>
    <link href="/2021/10/06/netty-demo-and-simple-gateway/"/>
    <url>/2021/10/06/netty-demo-and-simple-gateway/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä¸Šä¸€å°èŠ‚æˆ‘ä»¬æ€»ç»“äº†Reactoræ¨¡å‹ï¼ŒNettyåŸºäºä¸»ä»Reactoræ¨¡å‹è®¾è®¡äº†è‡ªå·±çš„æ¨¡å‹ç»“æ„ï¼Œä½¿å¾—Nettyåœ¨ä¸åŒçš„åœºæ™¯ä¸‹éƒ½æœ‰éå¸¸äº®çœ¼çš„æ€§èƒ½å’Œå¯ç”¨æ€§è¡¨ç°ã€‚è¿›å…¥åˆ°è¿™ä¸€å°èŠ‚ï¼Œæˆ‘åˆæƒ³åˆ°äº†é‚£å¥è¯â€Talk is cheap, show me codeâ€ã€‚è™½ç„¶ä¸Šä¸€å°èŠ‚æˆ‘ä»¬ç®€å•å†™äº†ä¸€ä¸ªâ€œå¿«é€Ÿå¼€å§‹â€ï¼Œä½†æ˜¯è¿™å¯¹äºè¦è¾¾åˆ°å¿«é€Ÿä½¿ç”¨Nettyè¿›è¡Œç½‘ç»œå¼€å‘çš„ç›®çš„è¿˜è¿œè¿œä¸å¤Ÿã€‚åœ¨ä¸€å°èŠ‚ä¸­æˆ‘ä»¬ä¼šé€šè¿‡ä¸€ç³»åˆ—çš„Demoç¤ºä¾‹ç†Ÿæ‚‰Nettyçš„å¼€å‘ï¼Œä»ä»£ç ä¸­æ„Ÿå—ä»–ä»¬çš„ç‰¹æ€§ã€‚æœ€åæˆ‘ä»¬ä¼šé€šè¿‡ä¸€ä¸ªç®€å•çš„èŠå¤©åŠ æ·±æˆ‘ä»¬å¯¹Nettyå„ä¸ªæ ¸å¿ƒç»„ä»¶çš„ç†è§£ã€‚æœ€åæˆ‘ä»¬åŠ¨æ‰‹è®¾è®¡å®è·µä¸€ä¸ªAPIç½‘å…³ï¼Œè®¤è¯†ç½‘å…³çš„åŠŸèƒ½å’Œç»“æ„ï¼ŒåŒæ—¶ä¹Ÿè¿›å…¥æå‡æˆ‘ä»¬ä½¿ç”¨Nettyè¿›è¡Œç½‘ç»œå¼€å‘çš„ç†Ÿç»ƒåº¦ï¼ŒåŒæ—¶ä¸ºåç»­æ·±å…¥æºç æ‰“ä¸‹åŸºç¡€ã€‚è¿™ä¸€å°èŠ‚ä»£ç æ¯”è¾ƒå¤šï¼Œä¸è¦å®³æ€•è€å¿ƒçœ‹å®Œå¹¶ä»˜è¯¸å®è·µï¼Œä¸€å®šä¼šæ”¶è·æ»¡æ»¡ã€‚</p><h1 id="Demoç¤ºä¾‹"><a href="#Demoç¤ºä¾‹" class="headerlink" title="Demoç¤ºä¾‹"></a>Demoç¤ºä¾‹</h1><p>åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Nettyç¼–å†™å‡ ä¸ªæˆ‘ä»¬å¸¸è§çš„æœåŠ¡ç±»å‹ï¼Œå…¶ä¸­åŒ…æ‹¬HttpServerå’ŒWebSocketæœåŠ¡ã€‚æˆ‘ä»¬è¿˜ä¼šä¸€èµ·ç¼–å†™Nettyçš„idelæ£€æµ‹çš„Demoï¼Œå®ƒå¸¸ç”¨äºè¿›è¡ŒæœåŠ¡é—´å¿ƒè·³åŒ…çš„å¼€å‘ï¼Œè¿˜ä¼šç®€å•å®è·µæˆ‘ä»¬ä¸Šä¸€å°èŠ‚è¯´åˆ°çš„<code>inboundHandler</code>å’Œ<code>outboundHandler</code>ï¼Œæ„Ÿå—ä»–ä»¬åœ¨ä»£ç ä¸­çš„ç‰¹æ€§ã€‚ä¸ºåç»­çš„ä½¿ç”¨Nettyè¿›è¡ŒAPIç½‘å…³çš„å¼€å‘å®æˆ˜åŸºç¡€ã€‚</p><h2 id="HttpæœåŠ¡"><a href="#HttpæœåŠ¡" class="headerlink" title="HttpæœåŠ¡"></a>HttpæœåŠ¡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyHttpServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8001</span>;<br>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerBootstrap bootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>            bootstrap.group(bossGroup, workerGroup)<br>                    .channel(NioServerSocketChannel.class)<br>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">4096</span>)<br>                    .option(ChannelOption.SO_RCVBUF, <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>)<br>                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>)<br><span class="hljs-comment">//                    .handler(new LoggingHandler(LogLevel.INFO))</span><br>                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> HttpServerCodec())<br>                                    .addLast(<span class="hljs-keyword">new</span> HttpObjectAggregator(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>))<br>                                    .addLast(<span class="hljs-keyword">new</span> HttpHandler());<br>                        &#125;<br>                    &#125;);<br>            ChannelFuture future = bootstrap.bind(port).sync();<br>            System.out.println(<span class="hljs-string">&quot;server started and listening port &quot;</span>+ port);<br>            future.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workerGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Httpçš„ChannelHandler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        FullHttpRequest request = (FullHttpRequest) msg;<br><span class="hljs-comment">//        System.out.println(request.uri());</span><br>        sndHttpResp(ctx.channel(), <span class="hljs-string">&quot;&#123;\&quot;status\&quot;: 1, \&quot;message\&quot;:\&quot;hello netty\&quot;&#125;&quot;</span>, request);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        cause.printStackTrace();<br>        ctx.channel().close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è¿”å›å®¢æˆ·ç«¯å“åº”</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> channel å½“å‰è¿æ¥channel</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg å“åº”æ¶ˆæ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request httpè¯·æ±‚</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sndHttpResp</span><span class="hljs-params">(Channel channel, String msg, FullHttpRequest request)</span> </span>&#123;<br>        DefaultFullHttpResponse response = <span class="hljs-keyword">new</span> DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK, Unpooled.wrappedBuffer(msg.getBytes(StandardCharsets.UTF_8)));<br>        response.headers().set(HttpHeaderNames.CONTENT_TYPE, HttpHeaderValues.APPLICATION_JSON);<br>        response.headers().setInt(HttpHeaderNames.CONTENT_LENGTH, response.content().readableBytes());<br>        <span class="hljs-keyword">if</span> (!HttpUtil.isKeepAlive(request)) &#123;<br>            channel.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            response.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);<br>            channel.writeAndFlush(response);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªç”¨Nettyå®ç°çš„HttpServerçš„å®ä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»£ç åˆ†æˆäº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸Šé¢éƒ¨åˆ†æ˜¯Nettyçš„Serverï¼Œå®ƒçš„å¤§ä½“çš„ç»“æ„å’Œä¹‹å‰çš„ç»“æ„éƒ½æ˜¯ä¸€è‡´çš„ã€‚åœ¨NettyæœåŠ¡çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬è¦ç€é‡å…³æ³¨ChildHandlerã€‚åœ¨ä¸Šä¸€å°èŠ‚æˆ‘ä»¬çŸ¥é“ChildHandleræ˜¯æœ€åæ‰§è¡Œä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œå¯¹äºæˆ‘ä»¬HttpServeræ¥è¯´ï¼Œ<strong>å®ƒå’Œå…¶ä»–çš„TCPServerå¹¶æ²¡æœ‰ä»€ä¹ˆæœ¬è´¨çš„åŒºåˆ«ï¼Œåº”ç”¨å±‚ä»¥ä¸‹éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªæœ‰åœ¨ç¼–è§£ç çš„æ—¶å€™è¦æ³¨æ„Httpåè®®çš„æ ¼å¼</strong>ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°Nettyé€šè¿‡<code>HttpServerCodec</code>å’Œ<code>HttpObjectAggregator</code> çš„æ–¹å¼å¯¹HttpServerçš„é€‚é…ã€‚æ‰€ä»¥ä»è¿™é‡Œæˆ‘ä»¬ä¸éš¾å¯ä»¥æ‹“å±•æ€è€ƒï¼Œæˆ‘ä»¬å¦‚æœéœ€è¦è‡ªå®šä¹‰åè®®çš„è¯æ˜¯å¦å¯ä»¥ä»è¿™é‡Œä¸‹æ‰‹å‘¢ï¼Ÿä¸‹é¢çš„éƒ¨åˆ†æ˜¯HttpHandlerçš„å®ç°ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¤„ç†ä¸šåŠ¡é€»è¾‘çš„åœ°æ–¹ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•çš„ç»™å‰ç«¯é‡æ–°è¿”å›ä¸€ä¸ªHttpResponseå°±å¯ä»¥äº†ã€‚</p><blockquote><p>åœ¨è¿™ä¸ªdemoä¸­åœ¨æ¯æ¬¡å¯åŠ¨å®ŒæˆæœåŠ¡åçš„ç¬¬ä¸€æ¬¡è°ƒç”¨éƒ½ä¼šå‡ºç°ä¸€ä¸ªå†…å­˜æ³„æ¼çš„å¼‚å¸¸</p><p>io.netty.util.ResourceLeakDetector reportTracedLeak</p><p>ä¸¥é‡: LEAK: ByteBuf.release() was not called before itâ€™s garbage-collected. See <a href="https://netty.io/wiki/reference-counted-objects.html">https://netty.io/wiki/reference-counted-objects.html</a> for more information.</p><p>æœåŠ¡ä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶ä¸”è¿™é‡Œçš„ç¼–è§£ç å…¶ä¹Ÿéƒ½æ˜¯ä½¿ç”¨Nettyæä¾›çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™æ ·é—®é¢˜ï¼Œææ€•åªæœ‰æ·±å…¥æºç æ‰èƒ½æ¢å…¶ç©¶ç«Ÿå§ğŸ™ˆ</p></blockquote><p>å¯¹æ¯”æˆ‘ä»¬ä½¿ç”¨Socketç¼–å†™çš„ç®€å•çš„HttpæœåŠ¡ï¼ŒNettyçš„æ€§èƒ½æœ‰éå¸¸æ˜æ˜¾çš„æå‡ã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨wrkå‹æµ‹çš„ç»“æœï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs markdown">-- socket <br>daiwei@daiweideMacBook-Pro ~ % wrk -t10 -c10 -d5s --latency  http://127.0.0.1:8081<br>Running 5s test @ http://127.0.0.1:8081<br>  10 threads and 10 connections<br>  Thread Stats   Avg      Stdev     Max   +/- Stdev<br><span class="hljs-code">    Latency     5.05ms   23.84ms 225.27ms   95.38%</span><br><span class="hljs-code">    Req/Sec     2.43k   719.68     6.96k    87.96%</span><br><span class="hljs-code">  Latency Distribution</span><br><span class="hljs-code">     50%  171.00us</span><br><span class="hljs-code">     75%  194.00us</span><br><span class="hljs-code">     90%  266.00us</span><br><span class="hljs-code">     99%  147.61ms</span><br><span class="hljs-code">  119295 requests in 5.06s, 10.69MB read</span><br><span class="hljs-code">  Socket errors: connect 0, read 118887, write 404, timeout 0</span><br><span class="hljs-code">Requests/sec:  23560.89</span><br><span class="hljs-code">Transfer/sec:      2.11MB</span><br><span class="hljs-code"></span><br><span class="hljs-code">-- Netty</span><br><span class="hljs-code">daiwei@daiweideMacBook-Pro ~ % wrk -t10 -c10 -d5s --latency  http://127.0.0.1:8001</span><br><span class="hljs-code">Running 5s test @ http://127.0.0.1:8001</span><br><span class="hljs-code">  10 threads and 10 connections</span><br><span class="hljs-code">  Thread Stats   Avg      Stdev     Max   +/- Stdev</span><br><span class="hljs-code">    Latency     1.49ms   10.13ms 124.27ms   97.88%</span><br><span class="hljs-code">    Req/Sec    11.07k     4.14k   16.54k    73.95%</span><br><span class="hljs-code">  Latency Distribution</span><br><span class="hljs-code">     50%   71.00us</span><br><span class="hljs-code">     75%   95.00us</span><br><span class="hljs-code">     90%  228.00us</span><br><span class="hljs-code">     99%   63.43ms</span><br><span class="hljs-code">  550359 requests in 5.10s, 69.81MB read</span><br><span class="hljs-code">Requests/sec: 107857.46</span><br><span class="hljs-code">Transfer/sec:     13.68MB</span><br></code></pre></td></tr></table></figure><h2 id="WebSocketæœåŠ¡"><a href="#WebSocketæœåŠ¡" class="headerlink" title="WebSocketæœåŠ¡"></a>WebSocketæœåŠ¡</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyWebsocketServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8002</span>;<br>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        EventLoopGroup workerGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerBootstrap bootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>            bootstrap.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)<br>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>)<br>                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> HttpServerCodec())<br>                                    .addLast(<span class="hljs-keyword">new</span> HttpObjectAggregator(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>))<br>                                    .addLast(<span class="hljs-keyword">new</span> WebSocketServerProtocolHandler(<span class="hljs-string">&quot;/websocket&quot;</span>))<br>                                    .addLast(<span class="hljs-keyword">new</span> MyWebSocketHandler());<br>                        &#125;<br>                    &#125;);<br>            ChannelFuture channelFuture = bootstrap.bind(port).sync();<br>            System.out.println(<span class="hljs-string">&quot;netty websocket server started and listening at port &quot;</span> + port);<br>            channelFuture.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workerGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ä¸šåŠ¡å¤„ç†çš„ChannelHandler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWebSocketHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SimpleChannelInboundHandler</span>&lt;<span class="hljs-title">TextWebSocketFrame</span>&gt; </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, TextWebSocketFrame msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;receive message [&quot;</span>+ msg.text() +<span class="hljs-string">&quot;] from web &quot;</span>);<br>        ctx.channel().writeAndFlush(<span class="hljs-keyword">new</span> TextWebSocketFrame(<span class="hljs-string">&quot;[&quot;</span> + DateFormatUtil.nowStr() + <span class="hljs-string">&quot;]: æœåŠ¡ç«¯æ”¶åˆ°æ¶ˆæ¯[&quot;</span> + msg.text() + <span class="hljs-string">&quot;]&quot;</span>));<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        cause.printStackTrace();<br>        ctx.channel().close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç æ˜¯Nettyå®ç°WebSocketçš„æœåŠ¡ç«¯éƒ¨åˆ†ï¼Œæ•´ä½“ç»“æ„ä¸Šå’Œæˆ‘ä»¬å‰é¢æ„å»ºçš„HttpServeræ˜¯ä¸€è‡´çš„ï¼Œä¸åŒçš„åœ°æ–¹åœ¨äºChildChannelä¸­çš„handleræ˜¯ä¸ä¸€æ ·çš„ã€‚ç›¸è¾ƒäºHttpServerï¼ŒWebSocket å¤šäº†ä¸ªå¤„ç†å™¨<code>WebSocketServerProtocolHandler</code>ï¼Œè¿™ä¸ªhandlerä»åå­—å°±èƒ½çœ‹å‡ºæ¥æ˜¯ä¸€ä¸ªç”¨äºWebSocketåè®®çš„handlerï¼Œæ„é€ è¿™ä¸ªhandleréœ€è¦ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå°±æ˜¯æˆ‘ä»¬SocketæœåŠ¡æ‰€ç›‘å¬çš„åœ°å€ï¼Œæœ€ååŠ ä¸Šæˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡å¤„ç†å™¨ã€‚æˆ‘ä»¬å®ç°çš„ä¸šåŠ¡å¤„ç†handlerå’Œå‰é¢çš„HttpHandleræœ‰ä¸€ç‚¹ç‚¹ä¸åŒï¼Œè¿™æ¬¡æˆ‘ä»¬ç»§æ‰¿çš„æ˜¯<code>SimpleChannelInboundHandler</code>ï¼Œè¿™ä¸ªç±»ä¹Ÿæ˜¯<code>channelInboundHandlerAdapter</code>çš„å­ç±»ï¼Œè¿™ä¸ªå­ç±»ç‰¹æ®Šçš„åœ°æ–¹åœ¨äºæä¾›äº†ä¸€ä¸ªæ³›å‹ï¼Œå³ä¸ºreadæ–¹æ³•ä¸­çš„messageçš„ç±»å‹ã€‚å¦‚æœåœ¨readæ–¹æ³•ä¸­è¿›è¡Œç±»å‹è½¬æ¢ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚å½“ç„¶Websocketå…‰æœ‰æœåŠ¡ç«¯æ˜¯è¿œè¿œä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦é¡µé¢çš„é…åˆä½¿ç”¨ã€‚ä»¥ä¸‹æ˜¯é¡µé¢çš„HTMLä»£ç ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><br><span class="javascript">    <span class="hljs-keyword">var</span> socket;</span><br><span class="javascript">    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.WebSocket) &#123;</span><br><span class="javascript">        socket = <span class="hljs-keyword">new</span> WebSocket(<span class="hljs-string">&quot;ws://localhost:8002/websocket&quot;</span>);</span><br><span class="javascript">        socket.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><br><span class="javascript">            <span class="hljs-keyword">var</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;respText&#x27;</span>);</span><br><span class="javascript">            rt.value = rt.value + <span class="hljs-string">&quot;\n&quot;</span> + ev.data;</span><br>        &#125;<br><br><span class="javascript">        socket.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><br><span class="javascript">            <span class="hljs-keyword">var</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;respText&#x27;</span>);</span><br><span class="javascript">            rt.value = <span class="hljs-string">&quot;è¿æ¥å¼€å¯äº†&quot;</span>;</span><br>        &#125;<br><br><span class="javascript">        socket.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ev</span>) </span>&#123;</span><br><span class="javascript">            <span class="hljs-keyword">var</span> rt = <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&#x27;respText&#x27;</span>);</span><br><span class="javascript">            rt.value = <span class="hljs-string">&quot;è¿æ¥å…³é—­äº†&quot;</span>;</span><br>        &#125;<br><span class="javascript">    &#125; <span class="hljs-keyword">else</span> &#123;</span><br><span class="javascript">        alter(<span class="hljs-string">&quot;å½“æµè§ˆå™¨ä¸æ”¯æŒ webSocket&quot;</span>);</span><br>    &#125;<br><br><span class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send</span>(<span class="hljs-params">msg</span>) </span>&#123;</span><br><span class="javascript">        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">window</span>.socket) &#123;</span><br><span class="javascript">            <span class="hljs-keyword">return</span>;</span><br>        &#125;<br>        if (socket.readyState == WebSocket.OPEN) &#123;<br>            socket.send(msg);<br>        &#125;<br>    &#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;message&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 300px; width: 300px;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;å‘ç”Ÿæ¶ˆæ¯&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;send(this.form.message.value)&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">textarea</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;respText&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;height: 300px; width: 300px;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">textarea</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;æ¸…ç©ºå†…å®¹&quot;</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;document.getElementById(&#x27;respText&#x27;).value = &#x27;&#x27;&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>å¯åŠ¨åç«¯æœåŠ¡å¹¶ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ä¸Šé¢çš„HTMLä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„é¡µé¢ï¼Œå½“æˆ‘ä»¬çœ‹åˆ°è¿æ¥å¼€å¯å³è¡¨æ˜å½“å‰websocketè¿æ¥å·²ç»å»ºç«‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210925154930.png"></p><p>åœ¨å·¦ä¾§çš„æ–‡æœ¬æ¡†ä¸­è¾“å…¥æ–‡å­—å¹¶ç‚¹å‡»å‘é€æ•°æ®ï¼Œæˆ‘ä»¬çš„NettyæœåŠ¡ç«¯å³å¯æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶ä¸”æ·»åŠ ä¸€äº›å†…å®¹å°†æ¶ˆæ¯è¿”å›ç»™å‰ç«¯ï¼ŒåŒæ—¶åœ¨åç«¯è¾“å‡ºç»“æ„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210925155653.png"></p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs markdown">console è¾“å‡ºï¼š<br>netty websocket server started and listening at port 8002<br>receive message [ä¸ç§¯è·¬æ­¥ï¼Œæ— ä»¥è‡³åƒé‡Œã€‚] from web <br></code></pre></td></tr></table></figure><h2 id="Idelï¼ˆç©ºé—²ï¼‰æ£€æµ‹"><a href="#Idelï¼ˆç©ºé—²ï¼‰æ£€æµ‹" class="headerlink" title="Idelï¼ˆç©ºé—²ï¼‰æ£€æµ‹"></a>Idelï¼ˆç©ºé—²ï¼‰æ£€æµ‹</h2><p><strong>åœ¨ç½‘ç»œè¿æ¥ä¸­å¤„äºidel(ç©ºé—²)çŠ¶æ€æ˜¯éå¸¸å¸¸è§çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ç»å¸¸éœ€è¦ä¾æ®idelçŠ¶æ€è¿›è¡Œä¸€äº›ç®€å•çš„å¼€å‘ï¼Œä¾‹å¦‚åˆ†å¸ƒå¼æœåŠ¡ä¸­çš„å¿ƒè·³æ¢æ´»ã€‚</strong>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯åœ¨ä¸€å®šæ—¶é—´æ²¡æœ‰è¿›è¡Œä»»ä½•çš„è¯»å†™è¯·æ±‚ï¼Œå°±å¯ä»¥è®¤ä¸ºä¸¤ä¸ªæœåŠ¡ä¹‹é—´çš„è¿æ¥æ˜¯ç©ºé—²çš„ã€‚ä½¿ç”¨Nettyè¿›è¡Œidelï¼ˆç©ºé—²ï¼‰æ£€æµ‹æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚çœ‹ä¸‹é¢çš„ç¤ºä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8801</span>;<br>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        EventLoopGroup workGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerBootstrap bootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>            bootstrap.group(bossGroup, workGroup)<br>                    .channel(NioServerSocketChannel.class)<br>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">512</span>)<br>                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>)<br>                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> IdleStateHandler(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, TimeUnit.SECONDS))<br>                                    .addLast(<span class="hljs-keyword">new</span> HelloHandler());<br>                        &#125;<br>                    &#125;);<br>            ChannelFuture future = bootstrap.bind(port).sync();<br>            System.out.println(<span class="hljs-string">&quot;æœåŠ¡å¯åŠ¨å®Œæˆ, ç›‘å¬ç«¯å£ http://127.0.0.1:&quot;</span> + port);<br>            future.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * helloHandler å¤„ç†å™¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»channelä¸­è¯»æ•°æ®ã€‚æ‰§è¡Œä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæˆ–è€…åŠ å…¥ä¸€äº›hookè§¦å‘åç»­ä¸šåŠ¡ã€‚</span><br><span class="hljs-comment">     * åŒæ—¶å¯ä»¥é€šè¿‡channelå‘é€æ•°æ®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg ä»channelä¸­è¯»åˆ°çš„æ•°æ®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ByteBuf byteBuf = (ByteBuf) msg;<br>        System.out.println(<span class="hljs-string">&quot;message[&quot;</span>+ byteBuf.toString(StandardCharsets.UTF_8) +<span class="hljs-string">&quot;] receivedï¼and &quot;</span> +<br>                <span class="hljs-string">&quot;message is from [&quot;</span> + ctx.channel().remoteAddress().toString() + <span class="hljs-string">&quot;]&quot;</span>);<br>        ByteBuf toClientMsg = Unpooled.copiedBuffer( <span class="hljs-string">&quot;hello!&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        ctx.channel().writeAndFlush(toClientMsg);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * äº‹ä»¶è§¦å‘æ–¹æ³•</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> evt äº‹ä»¶</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">userEventTriggered</span><span class="hljs-params">(ChannelHandlerContext ctx, Object evt)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (evt <span class="hljs-keyword">instanceof</span> IdleStateEvent) &#123;<br>            IdleStateEvent event = (IdleStateEvent) evt;<br>            IdleState state = event.state();<br>            System.out.println(state.toString());<br>            <span class="hljs-keyword">if</span> (IdleState.ALL_IDLE.equals(state)) &#123;<br>                System.out.println(<span class="hljs-string">&quot;all idle and close channel&quot;</span>);<br>                ctx.channel().close();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ•æ‰åˆ°äº†å¼‚å¸¸æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œè¾“å‡ºå¼‚å¸¸ï¼Œå…³é—­èµ„æº</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause å¼‚å¸¸ä¿¡æ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ctx.close();<br>        cause.printStackTrace();<br>        <span class="hljs-keyword">super</span>.exceptionCaught(ctx, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¾‹å­æ˜¯Nettyå…¥é—¨é‚£å°èŠ‚å¿«é€Ÿå¼€å§‹çš„ä¾‹å­æ”¹è¿‡æ¥çš„ï¼Œè¿™é‡Œä¿®æ”¹äº†ä¸¤ä¸ªåœ°æ–¹ã€‚ç¬¬ä¸€ä¸ªåœ°æ–¹æ˜¯åœ¨childHandler ä¸­æ·»åŠ äº†<code>new IdleStateHandler(2, 5, 8, TimeUnit.SECONDS)</code>ï¼Œè¿™æ˜¯è¿æ¥ç©ºé—²æ£€æµ‹çš„Handlerï¼Œå…¶ä¸­å…¥å‚<code>2</code>è¡¨ç¤ºå½“è¯»ç©ºé—²è¶…è¿‡2ç§’è§¦å‘ä¸€æ¬¡è¯»ç©ºé—²çš„ideläº‹ä»¶ï¼Œ<code>5</code>è¡¨ç¤ºå†™ç©ºé—²è¶…è¿‡5ç§’è§¦å‘ä¸€æ¬¡å†™ç©ºé—²çš„ideläº‹ä»¶ï¼Œ<code>8</code>è¡¨ç¤ºè¯»å’Œå†™åŒæ—¶ç©ºé—²è¶…è¿‡8ç§’è§¦å‘ä¸€æ¬¡è¯»å†™ç©ºé—²äº‹ä»¶ã€‚äº‹ä»¶è§¦å‘æ–¹æ³•å†™ä½äºIdleStateHandleråé¢çš„HelloHandlerçš„ä¸­ï¼Œå³ä¸Šé¢è¿™æ®µä»£ç çš„<code>userEventTriggered</code>æ–¹æ³•ä¸­ã€‚åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå¦‚æœæ˜¯IdelStatEventï¼ˆè¿æ¥ç©ºé—²äº‹ä»¶ï¼‰è¾“å‡ºä»–ä»¬çš„äº‹ä»¶ç±»å‹ï¼Œå¹¶æœ€ååˆ¤æ–­å¦‚æœæ˜¯è¯»å†™ç©ºé—²åˆ™å…³é—­ç©ºé—²è¿æ¥ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs markdown">console è¾“å‡ºï½<br><br>æœåŠ¡å¯åŠ¨å®Œæˆ, ç›‘å¬ç«¯å£ http://127.0.0.1:8801<br>message[hello server!] receivedï¼and message is from [/127.0.0.1:49529]<br>READER<span class="hljs-emphasis">_IDLE</span><br><span class="hljs-emphasis">READER_</span>IDLE<br>WRITER<span class="hljs-emphasis">_IDLE</span><br><span class="hljs-emphasis">READER_</span>IDLE<br>ALL<span class="hljs-emphasis">_IDLE</span><br><span class="hljs-emphasis">all idle and close channel</span><br></code></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰ç¼–è§£ç "><a href="#è‡ªå®šä¹‰ç¼–è§£ç " class="headerlink" title="è‡ªå®šä¹‰ç¼–è§£ç "></a>è‡ªå®šä¹‰ç¼–è§£ç </h2><p>æˆ‘ä»¬å‰é¢ä»‹ç»äº†<strong>ChannelPipelineæä¾›äº†ä¸€ä¸ªå®¹å™¨ï¼Œåœ¨è¿™ä¸ªå®¹å™¨å†…åŒ…å«å¾ˆå¤šçš„ChannelHandler</strong>ï¼Œè¿™äº›ChannelHandleræä¾›äº†ä¸€ä¸ªAPIè°ƒç”¨é“¾ã€‚ChannelPipelineç®¡ç†è¿™æ²¿ç€é“¾å…¥ç«™å’Œå‡ºç«™çš„äº‹ä»¶æµåŠ¨ã€‚ä¸‹é¢æ˜¯Netty ChannelPiplineçš„Docæ–‡æ¡£è¯´æ˜ï¼Œè¿™ä¸ªå›¾å¾ˆå½¢è±¡çš„æè¿°äº†ChannelPiplineçš„ä½œç”¨ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs sh">                                             I/O Request<br>                                          via Channel or<br>                                      ChannelHandlerContext<br>                                                    |<br>+---------------------------------------------------+---------------+<br>|                           ChannelPipeline         |               |<br>|                                                  \|/              |<br>|    +---------------------+            +-----------+----------+    |<br>|    | Inbound Handler  N  |            | Outbound Handler  1  |    |<br>|    +----------+----------+            +-----------+----------+    |<br>|              /|\                                  |               |<br>|               |                                  \|/              |<br>|    +----------+----------+            +-----------+----------+    |<br>|    | Inbound Handler N-1 |            | Outbound Handler  2  |    |<br>|    +----------+----------+            +-----------+----------+    |<br>|              /|\                                  .               |<br>|               .                                   .               |<br>| ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|<br>|        [ method call]                       [method call]         |<br>|               .                                   .               |<br>|               .                                  \|/              |<br>|    +----------+----------+            +-----------+----------+    |<br>|    | Inbound Handler  2  |            | Outbound Handler M-1 |    |<br>|    +----------+----------+            +-----------+----------+    |<br>|              /|\                                  |               |<br>|               |                                  \|/              |<br>|    +----------+----------+            +-----------+----------+    |<br>|    | Inbound Handler  1  |            | Outbound Handler  M  |    |<br>|    +----------+----------+            +-----------+----------+    |<br>|              /|\                                  |               |<br>+---------------+-----------------------------------+---------------+<br>                |                                  \|/<br>+---------------+-----------------------------------+---------------+<br>|               |                                   |               |<br>|       [ Socket.read() ]                    [ Socket.write() ]     |<br>|                                                                   |<br>|  Netty Internal I/O Threads (Transport Implementation)            |<br>+-------------------------------------------------------------------+<br></code></pre></td></tr></table></figure><p>å…¥ç«™äº‹ä»¶è‡ªä¸‹è€Œä¸Šçš„å…¥ç«™ç¨‹åºå³<code>inBoundHandler</code>å¤„ç†ï¼Œå‡ºç«™äº‹ä»¶åˆ™æœ‰å‡ºç«™ç¨‹åº<code>outBoundHandler</code>å¤„ç†ï¼Œ<strong>åœ¨Nettyä¸­æ¯ä¸ªChanneléƒ½æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªChannelPipelineä¸ä¹‹å¯¹åº”ã€‚</strong>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬çš„inBoundå’ŒoutBoundå°±åƒæ˜¯ä¸€ä¸ªâ€œå¤§çš„åˆ‡é¢åŒ…è£¹ç€â€å®é™…çš„ä¸šåŠ¡å¤„ç†è¿‡ç¨‹ã€‚<strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ handlerçš„æ–¹å¼å¢åŠ åŠŸèƒ½</strong>ï¼Œå°±åƒå‰é¢ä¸€ä¸ªDemoæˆ‘ä»¬æŠŠIdleStateHandleråŠ å…¥åˆ°ChannelPipelineä¸­æ·»åŠ ä¸€ä¸ªidelæ£€æµ‹åŠŸèƒ½ä¸€æ ·ã€‚å½“ç„¶è¿™ä¸ªåŒ…è£¹åœ¨å®é™…ä¸šåŠ¡å‰åçš„ä¸»è¦è¿˜æ˜¯ç¼–è§£ç æ“ä½œï¼Œå°±åƒæˆ‘ä»¬å‰é¢ç¼–å†™Httpçš„æœåŠ¡ç«¯å’ŒWebSocketçš„æœåŠ¡ç«¯ä¸€æ ·ã€‚ä»–ä»¬éƒ½åœ¨ChannelPiplelineä¸­æ·»åŠ äº†<code>HttpServerCodec</code>æˆ–<code>WebSocketServerProtocolHandler</code>æ¥æ”¯æŒHttpæœåŠ¡æˆ–WebSocketæœåŠ¡ã€‚åŒç†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„ç¼–è§£ç å™¨å®ç°è‡ªå®šä¹‰åè®®çš„æ•ˆæœã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * ç¼–ç å™¨</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/4/12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MessageToByteEncoder</span>&lt;<span class="hljs-title">Object</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RpcSerializer serializer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NettyEncoder</span><span class="hljs-params">(Class&lt;?&gt; clazz, RpcSerializer serializer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.clazz = clazz;<br>        <span class="hljs-keyword">this</span>.serializer = serializer;<br>    &#125;<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 2021/4/12 è¿™é‡Œå¯ä»¥å¼€å‘ä¸€ä¸ªå¯æ‹“å±•çš„åè®®</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (clazz.isInstance(msg)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">this</span>.serializer.serialize(msg);<br>                out.writeInt(bytes.length);<br>                out.writeBytes(bytes);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                log.error(<span class="hljs-string">&quot;server catch exception!&quot;</span>, e);<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è§£ç å™¨</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/4/12</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyDecoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ByteToMessageDecoder</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RpcSerializer serializer;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NettyDecoder</span><span class="hljs-params">(Class&lt;?&gt; clazz, RpcSerializer serializer)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.clazz = clazz;<br>        <span class="hljs-keyword">this</span>.serializer = serializer;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-keyword">if</span> (in.readableBytes() &lt; <span class="hljs-number">4</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        in.markReaderIndex();<br>        <span class="hljs-keyword">int</span> len = in.readInt();<br>        <span class="hljs-keyword">if</span> (len &lt; <span class="hljs-number">0</span>) &#123;<br>            ctx.close();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (in.readableBytes() &lt; len) &#123;<br>            in.resetReaderIndex();<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-keyword">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[len];<br>        in.readBytes(bytes);<br>        <span class="hljs-keyword">try</span> &#123;<br>            Object msg = serializer.deserialize(bytes, clazz);<br>            out.add(msg);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            log.error(<span class="hljs-string">&quot;server catch exception!&quot;</span>, e);<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä¹‹å‰å†™çš„ä¸¤ä¸ªç¼–è§£ç å™¨ï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥åºåˆ—åŒ–å®ç°å®ä¾‹ï¼Œå®ç°RCPçš„ç¼–è§£ç é€»è¾‘ã€‚åªè¦åœ¨ä¸¤ä¸ªæœåŠ¡ä¹‹é—´åŠ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ç¼–è§£ç å™¨ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬è‡ªå®šä¹‰åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„åºåˆ—åŒ–åè®®ï¼Œæé«˜æ•°æ®ä¼ è¾“çš„å®‰å…¨æ€§å’Œå¯é æ€§ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„åè®®ã€‚</p><blockquote><p>æˆ‘ä»¬è‡ªå®šä¹‰åè®®è¿˜æ˜¯è¦è§£å†³ä¸€ä¸ªé—®é¢˜å°±æ˜¯<strong>TCPçš„ç²˜åŒ…ã€åŠåŒ…å’ŒåŠç²˜åŒ…</strong>çš„é—®é¢˜ã€‚</p><p><strong>ä»€ä¹ˆæ˜¯TCç²˜åŒ…é—®é¢˜</strong></p><p>TCPæ²¾åŒ…å°±æ˜¯æŒ‡å‘é€æ–¹å‘é€çš„è‹¥å¹²åŒ…æ•°æ®åˆ°è¾¾æ¥æ”¶æ–¹æ—¶æ²¾æˆäº†ä¸€åŒ…ï¼Œä»æ¥æ”¶ç¼“å†²åŒºæ¥çœ‹ï¼Œåä¸€åŒ…æ•°æ®çš„å¤´ä¼šç´§ç´§æ¥ç€å‰ä¸€åŒ…æ•°æ®çš„å°¾ï¼Œå‡ºç°æ²¾åŒ…çš„åŸå› æ˜¯å¤šæ–¹é¢çš„ï¼Œå¯èƒ½æ¥è‡ªå‘é€æ–¹ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªæ¥æ”¶æ–¹ã€‚</p><p><strong>é€ æˆTCPç²˜åŒ…çš„åŸå› </strong></p><ul><li><p>å‘é€æ–¹åŸå› ï¼ŒTCPé»˜è®¤ä½¿ç”¨Nagleç®—æ³•ï¼Œè€ŒNagleç®—æ³•ä¸»è¦åšä¸¤ä»¶äº‹ï¼š</p></li><li><ul><li>åªæœ‰ä¸Šä¸€ä¸ªåˆ†ç»„å¾—åˆ°ç¡®è®¤ï¼Œæ‰ä¼šå‘é€ä¸‹ä¸€ç»„ã€‚</li><li>æ”¶é›†å¤šä¸ªå°åˆ†ç»„ï¼Œåœ¨ä¸€ä¸ªç¡®è®¤åˆ°æ¥æ—¶ä¸€èµ·å‘é€ã€‚</li></ul></li></ul><p>å› æ­¤Nagleç®—æ³•é€ æˆå‘é€æ–¹å¯èƒ½ä¼šå‡ºç°ç²˜åŒ…é—®é¢˜ã€‚</p><ul><li>æ¥æ”¶æ–¹åŸå› ï¼ŒTCPæ¥æ”¶çš„æ•°æ®åŒ…æ—¶ï¼Œå¹¶ä¸ä¼šé©¬ä¸Šäº¤åˆ°åº”ç”¨å±‚è¿›è¡Œå¤„ç†ï¼Œæˆ–è€…è¯´æ˜¯åº”ç”¨å±‚ä¸ä¼šç«‹å³å¤„ç†ã€‚å®é™…ä¸Šï¼ŒTCPå°†æ¥æ”¶åˆ°çš„æ•°æ®åŒ…ä¿å­˜åœ¨æ¥æ”¶ç¼“å­˜é‡Œï¼Œç„¶ååº”ç”¨ç¨‹åºä¸»åŠ¨ä»ç¼“å­˜è¯»å–æ”¶åˆ°çš„åˆ†ç»„ã€‚è¿™æ ·ï¼Œå¦‚æœTCPæ¥æ”¶æ•°æ®åˆ°åˆ°ç¼“å­˜çš„é€Ÿåº¦ï¼Œå¤šä¸ªåŒ…å°±ä¼šè¢«ç¼“å­˜ï¼Œåº”ç”¨ç¨‹åºå°±æœ‰å¯èƒ½è¯»å–åˆ°å¤šä¸ªé¦–å°¾ç›¸æ¥ç²˜åˆ°ä¸€èµ·çš„åŒ…ã€‚</li></ul><p><strong>å¦‚ä½•å¤„ç†ç²˜åŒ…é—®é¢˜</strong></p><ul><li>å‘é€æ–¹ï¼Œå¯¹äºå‘é€æ–¹é€ æˆçš„ç²˜åŒ…é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡å…³é—­Nagleç®—æ³•æ¥è§£å†³ï¼Œä½¿ç”¨TCP_NODELAYé€‰é¡¹æ¥å…³é—­ç®—æ³•ã€‚</li><li>æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹æ²¡æœ‰åŠæ³•æ¥å¤„ç†ç²˜åŒ…ç°è±¡ï¼Œåªèƒ½äº¤ç»™åº”ç”¨å±‚æ¥å¤„ç†ã€‚</li></ul></blockquote><p>åº”ç”¨å±‚è¯»å–æ•°æ®çš„æ—¶å€™ï¼ŒæŒ‰ç…§æ•°æ®çš„é•¿åº¦ä¸€æ‰¹æ‰¹è¯»å–æ•°æ®ä»è€Œè§£å†³ç²˜åŒ…é—®é¢˜ã€‚åŒæ—¶åœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦å°†æ•°æ®çš„é•¿åº¦åŠ å…¥åˆ°ä¼ è¾“çš„æ•°æ®ä¸­ï¼Œæ–¹ä¾¿è¯»å–çš„æ—¶å€™åˆ‡å‰²æ•°æ®åŒ…ã€‚Nettyé€šè¿‡æ·»åŠ ç¼–è§£ç å™¨çš„æ–¹å¼æ¥å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><blockquote><p>âš ï¸æ·»åŠ ç¼–è§£ç å™¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„è¦<strong>æŠŠå®ƒä»¬åŠ åˆ°å¤„ç†é€»è¾‘å‰é¢</strong>ï¼Œæ‰èƒ½å®ç°â€œä¸šåŠ¡å¤„ç†å™¨å‰åè¢«åŒ…è£¹â€çš„æ•ˆæœã€‚</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç‚¹ç®€å•çš„å•°å—¦ä¸€ä¸‹ï¼Œå°±æ˜¯InBoundHandlerå’ŒoutBoundHandlerï¼Œè¿™äº›Handleréƒ½æ˜¯ChildHandlerï¼Œä¹Ÿéƒ½æ˜¯ChannelPipelineé‡Œé¢çš„Handlerã€‚ChannelPipelineä¸­æä¾›äº†åŒå‘çš„Handleré“¾å¤´å°¾å¼•ç”¨åˆ†åˆ«æ˜¯<code>head</code>å’Œ<code>tail</code>ã€‚<strong>ç„¶åå…¥ç«™äº‹ä»¶ä»</strong><code>head</code><strong>å¼€å§‹ä»å‰å‘åéå†æ‰§è¡ŒinBoundHandlerï¼Œè€Œå‡ºç«™äº‹ä»¶ä»</strong><code>tail</code><strong>å¼€å§‹ä»åå‘å‰éå†æ‰§è¡ŒoutBoundhandlerã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921211125.png"></p><p>å› ä¸ºä¸¤ç§ç±»å‹çš„Handleræ˜¯åœ¨ä¸€ä¸ªè°ƒç”¨é“¾ä¸Šï¼Œæ‰€ä»¥åœ¨éå†è¿‡ç¨‹ä¸­éœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯å½“å‰éœ€è¦çš„æ‰§è¡Œçš„handlerï¼ŒNettyé€šè¿‡ä¸€ä¸‹éå¸¸å·§å¦™çš„æ–¹å¼å®ç°ã€‚æˆ‘ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯é€šè¿‡ä¸€ä¸ªå­—æ®µæ ‡æ˜ï¼Œç»“æœå¹¶ä¸æ˜¯ï¼Œæ˜¯é€šè¿‡<strong>æ¯ä¸ªhandlerå®ä¾‹ä¸­çš„executionMaskçš„æ•°å€¼è¿›è¡Œå¤æ‚çš„ä½è¿ç®—æ¥å®ç°åŒºåˆ†ï¼ŒçœŸçš„å¾ˆå·§å¦™ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ä¸€äº›å¸¸é‡ç”¨äºè®¡ç®—</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MASK_ONLY_INBOUND =  MASK_CHANNEL_REGISTERED |<br>    MASK_CHANNEL_UNREGISTERED | MASK_CHANNEL_ACTIVE | MASK_CHANNEL_INACTIVE | MASK_CHANNEL_READ |<br>    MASK_CHANNEL_READ_COMPLETE | MASK_USER_EVENT_TRIGGERED | MASK_CHANNEL_WRITABILITY_CHANGED;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MASK_ALL_INBOUND = MASK_EXCEPTION_CAUGHT | MASK_ONLY_INBOUND;<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MASK_ONLY_OUTBOUND =  MASK_BIND | MASK_CONNECT | MASK_DISCONNECT |<br>    MASK_CLOSE | MASK_DEREGISTER | MASK_READ | MASK_WRITE | MASK_FLUSH;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MASK_ALL_OUTBOUND = MASK_EXCEPTION_CAUGHT | MASK_ONLY_OUTBOUND;<br><br><span class="hljs-comment">// å¾ªç¯æ‰¾åˆ°å½“å‰éœ€è¦æ‰§è¡Œçš„InboundHandler</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> AbstractChannelHandlerContext <span class="hljs-title">findContextInbound</span><span class="hljs-params">(<span class="hljs-keyword">int</span> mask)</span> </span>&#123;<br>    AbstractChannelHandlerContext ctx = <span class="hljs-keyword">this</span>;<br>    EventExecutor currentExecutor = executor();<br>    <span class="hljs-keyword">do</span> &#123;<br>        ctx = ctx.next;<br>    &#125; <span class="hljs-keyword">while</span> (skipContext(ctx, currentExecutor, mask, MASK_ONLY_INBOUND));<br>    <span class="hljs-keyword">return</span> ctx;<br>&#125;<br><br><span class="hljs-comment">// æ˜¯å¦è¦è·³è¿‡</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">skipContext</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">    AbstractChannelHandlerContext ctx, EventExecutor currentExecutor, <span class="hljs-keyword">int</span> mask, <span class="hljs-keyword">int</span> onlyMask)</span> </span>&#123;<br>    <span class="hljs-comment">// Ensure we correctly handle MASK_EXCEPTION_CAUGHT which is not included in the MASK_EXCEPTION_CAUGHT</span><br>    <span class="hljs-keyword">return</span> (ctx.executionMask &amp; (onlyMask | mask)) == <span class="hljs-number">0</span> ||<br>        <span class="hljs-comment">// We can only skip if the EventExecutor is the same as otherwise we need to ensure we offload</span><br>        <span class="hljs-comment">// everything to preserve ordering.</span><br>        <span class="hljs-comment">//</span><br>        <span class="hljs-comment">// See https://github.com/netty/netty/issues/10067</span><br>        (ctx.executor() == currentExecutor &amp;&amp; (ctx.executionMask &amp; mask) == <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="APIç½‘å…³å®æˆ˜"><a href="#APIç½‘å…³å®æˆ˜" class="headerlink" title="APIç½‘å…³å®æˆ˜"></a>APIç½‘å…³å®æˆ˜</h1><p>åœ¨å‰é¢çš„æ¢³ç†çš„å†…å®¹ä¸­æˆ‘ä»¬ä»‹ç»è¿‡ç½‘å…³ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸‰å±‚çš„è½¬å‘è®¾å¤‡ï¼Œå¾€å¾€æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ã€ä¸‰å±‚äº¤æ¢æœºæˆ–æ˜¯é˜²ç«å¢™ã€‚å®ƒæ˜¯ä¸€ä¸ªç½‘æ®µçš„å…¥å£å’Œå‡ºå£ï¼Œè¿æ¥è¿™å¤šä¸ªç½‘æ®µï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦è®¿é—®ä¸åœ¨å½“å‰ç½‘æ®µçš„æœåŠ¡ï¼Œæ•°æ®åŒ…å°±è¦é€šè¿‡ç½‘å…³çš„è·¯ç”±è½¬å‘ã€‚é‚£æˆ‘ä»¬ä»Šå¤©è¦ä»‹ç»çš„è¿™ä¸ªç½‘å…³å’Œé‚£ä¸ªç½‘å…³åˆæœ‰ä¸€äº›ä¸ä¸€æ ·ã€‚æˆ‘ä»¬è¿™ä¸ªç½‘å…³æ˜¯å’ŒæœåŠ¡é›†ç¾¤æœ‰å…³ï¼Œåœ¨ä»¥å‰çš„å•æœºæ—¶ä»£ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨æœåŠ¡å‰é¢åŠ ä¸€ä¸ªNginxåšä¸€ä¸ªåå‘ä»£ç†ï¼Œå°†è¯·æ±‚å‡åŒ€çš„åˆ†é…åˆ°å‡ ä¸ªç›¸åŒçš„å®ä¾‹ä¸Šå³å¯ã€‚ä½†æ˜¯åœ¨ä¸ºæœåŠ¡æ¶æ„ä¸­ï¼Œä¸åŒçš„æœåŠ¡ä¹‹é—´æœåŠ¡è°ƒç”¨å·²ç»å˜å¾—éå¸¸å¤æ‚ï¼Œå¦‚æœç›´æ¥æŠŠæœåŠ¡æ¥å£æš´éœ²ç»™å®¢æˆ·ç«¯åŠ¿å¿…ä¼šæœ‰å„ç§å„æ ·çš„é—®é¢˜ã€‚<strong>å› æ­¤æˆ‘ä»¬æä¾›ä¸€ä¸ªç‰¹å®šçš„å¾®æœåŠ¡ï¼Œæ‰€æœ‰çš„è¯·æ±‚é€šè¿‡è¿™ä¸ªæœåŠ¡å†æ¬¡åˆ†æ´¾è½¬å‘ç»™ç›®æ ‡çš„å¾®æœåŠ¡æ¥å£</strong>ã€‚è€Œè¿™æ ·ç‰¹å®šçš„å¾®æœåŠ¡å°±æ˜¯æˆ‘ä»¬çš„APIç½‘å…³ã€‚APIç½‘å…³æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„åŸºç¡€ç»„ä»¶ï¼Œä½äºæ¥å…¥å±‚ä¹‹ä¸‹å’Œä¸šåŠ¡æœåŠ¡å±‚ä¹‹ä¸Šã€‚</p><h2 id="ç½‘å…³ä¸å¾®æœåŠ¡é›†ç¾¤"><a href="#ç½‘å…³ä¸å¾®æœåŠ¡é›†ç¾¤" class="headerlink" title="ç½‘å…³ä¸å¾®æœåŠ¡é›†ç¾¤"></a>ç½‘å…³ä¸å¾®æœåŠ¡é›†ç¾¤</h2><p>å¦‚æœæˆ‘ä»¬å°†ä¸Šé¢çš„ä»‹ç»çš„ç½‘å…³åº”ç”¨åˆ°å®é™…çš„æœåŠ¡çš„æ‹“æ‰‘å›¾ä¸­ï¼Œå°±å¯ä»¥å¾—ç±»ä¼¼äºä¸‹é¢çš„æ¶æ„å›¾ã€‚æˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸€ä¸ªæœåŠ¡å®ä¾‹æä¾›ä¸€ä¸ªç½‘å…³(Gateway)ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸€ç»„æœåŠ¡é…ç½®ä¸€ä¸ªï¼Œç”šè‡³å¯ä»¥ä¸ºæ•´ä¸ªæœåŠ¡é›†ç¾¤é…ç½®ä¸€ä¸ªæ¥å…¥çš„ç½‘å…³(Gateway)ï¼Œè¿™æ ·æ•´ä½“ç³»ç»Ÿçš„å¤æ‚åº¦å°±å˜å¾—ç®€å•èµ·æ¥ï¼Œé›†ä¸­é‡å¤çš„ç®€å•åŠŸèƒ½ä¹Ÿå¯ä»¥æ”¾åœ¨ç½‘å…³ä¸­å®ç°ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210927010419.png"></p><p>ä¸Šé¢çš„å›¾å±•ç¤ºäº†ä¸€ä¸ªå¤šå±‚ç½‘å…³çš„æ¶æ„ï¼Œå…¶ä¸­ä¸€ä¸ªæ€»çš„ç½‘å…³æ¥å…¥æ‰€æœ‰çš„æµé‡ï¼Œå¹¶åˆ†å‘ç»™ä¸åŒçš„å­ç³»ç»Ÿï¼Œè¿˜æœ‰äºŒçº§ç½‘å…³ç”¨äºåšå„ä¸ªå­ç³»ç»Ÿçš„æ¥å…¥ã€‚é€šè¿‡ç½‘å…³ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠåˆ†å¸ƒå¼æ¶æ„ç»„æˆä¸€ä¸ªæ˜Ÿå‹æ¶æ„ï¼Œç”±ç½‘å…³å¯¹æœåŠ¡çš„è¯·æ±‚è¿›è¡Œè·¯ç”±å’Œåˆ†å‘ã€‚</p><h2 id="ä¸»è¦åŠŸèƒ½"><a href="#ä¸»è¦åŠŸèƒ½" class="headerlink" title="ä¸»è¦åŠŸèƒ½"></a>ä¸»è¦åŠŸèƒ½</h2><p>ä½œä¸ºä¸€ä¸ªç³»ç»Ÿæ¨¡å—çš„å…¥å£å’Œå‡ºå£ï¼Œå¦‚æœè¦å®ç°å¯¹æ¥å£æœåŠ¡çš„ç®¡ç†åº”è¯¥å®ç°ä¸€ä¸‹çš„ä¸€äº›åŠŸèƒ½ã€‚</p><ul><li><p><strong>è¯·æ±‚è·¯ç”±</strong>ï¼Œç½‘å…³ä½œä¸ºç½‘ç»œçš„å‡ºå…¥å£ä¸€å®šè¦å…·æœ‰è¯·æ±‚è·¯ç”±çš„åŠŸèƒ½ã€‚å¯¹äºè°ƒç”¨ç«¯æ¥è¯´ï¼Œå¹¶ä¸çŸ¥é“çœŸæ­£è°ƒç”¨çš„æœåŠ¡åœ°å€ï¼Œä¸€ç±»æœåŠ¡çš„åœ°å€ç»Ÿä¸€äº¤ç»™ç½‘å…³å¤„ç†ã€‚</p></li><li><p><strong>æœåŠ¡æ³¨å†ŒåŠŸèƒ½</strong>ï¼Œä¸ºäº†èƒ½å¤Ÿä»£ç†åé¢çš„æœåŠ¡ï¼Œå¹¶æŠŠè¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œç½‘å…³åº”è¯¥å…·å¤‡æœåŠ¡æ³¨å†ŒåŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åç«¯çš„å®ä¾‹å¯ä»¥å°†æœåŠ¡æ³¨å†Œåˆ°ç½‘å…³ä¸Šã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ³¨å†ŒæœåŠ¡ä¹Ÿå°±æ˜¯æ³¨å†Œæä¾›æœåŠ¡çš„APIæ¥å£ï¼Œç½‘å…³å†é€šè¿‡ç­–ç•¥ä»è¿™äº›æ³¨å†Œçš„æ¥å£ä¸­é€‰æ‹©ä¸€ä¸ªè¿›è¡Œè·¯ç”±è°ƒç”¨ã€‚</p></li><li><p><strong>è´Ÿè½½å‡è¡¡</strong>ï¼Œä¸€ä¸ªç½‘å…³å¯ä»¥æ³¨å†Œå¤šä¸ªæœåŠ¡å®ä¾‹ï¼Œé‚£ä¹ˆæŒ‰ç…§ä»€ä¹ˆæ ·çš„è·¯ç”±ç­–ç•¥è¿›è¡Œè·¯ç”±è¯·æ±‚å°±æ˜¯ä¸€ä¸ªéœ€è¦è§£å†³çš„é—®é¢˜ã€‚ç®€å•ä¸€ç‚¹çš„å¯ä»¥ç›´æ¥æ˜¯è½®è¯¢æˆ–éšæœºã€‚å¤æ‚ä¸€ç‚¹çš„å¯ä»¥è®¾è®¡æƒé‡éšæœºç­‰è´Ÿè½½ç­–ç•¥ã€‚</p></li><li><p><strong>å¼¹åŠ›è®¾è®¡</strong>ï¼Œç½‘å…³è¿˜å¯ä»¥æŠŠå¼¹åŠ›è®¾è®¡ä¸­çš„é‚£äº›å¼‚æ­¥ã€é‡è¯•ã€å¹‚ç­‰ã€æµæ§ã€ç†”æ–­ã€ç›‘æ§ç­‰éƒ½å®ç°è¿›å»ã€‚è¿™æ ·ï¼Œå¯ä»¥åƒService Meshé‚£æ ·ï¼Œè®©åº”ç”¨æœåŠ¡åªå…³å¿ƒè‡ªå·±çš„ä¸šåŠ¡é€»è¾‘è€Œä¸ç”¨è€ƒè™‘æ§åˆ¶é€»è¾‘ï¼ˆæ§åˆ¶é¢ï¼‰ã€‚</p></li><li><p><strong>å®‰å…¨æ–¹é¢</strong>ï¼ŒSSLåŠ å¯†åŠè¯ä¹¦ç®¡ç†ã€SessionéªŒè¯ã€æˆæƒã€æ•°æ®æ ¡éªŒï¼Œä»¥åŠé»‘ç™½åå•ç­‰ã€‚é”™è¯¯å¤„ç†è¶Šé«˜å¤„ç†ä½ç½®è¶Šé å‰è¶Šå¥½ï¼Œæ‰€ä»¥ï¼Œç½‘å…³å¯ä»¥åšåˆ°ä¸€ä¸ªå…¨ç«™çš„æ¥å…¥ç»„ä»¶æ¥å¯¹åç«¯çš„æœåŠ¡è¿›è¡Œä¿æŠ¤ã€‚å½“ç„¶ï¼Œç½‘å…³è¿˜å¯ä»¥åšæ›´å¤šæ›´æœ‰è¶£çš„äº‹ï¼Œæ¯”å¦‚ï¼šç°åº¦å‘å¸ƒã€APIèšåˆã€APIç¼–æ’ã€‚</p></li></ul><blockquote><p>ä¸Šé¢çš„è¿™äº›ç‚¹ï¼Œç®€å•å½’çº³ä¸‹å¯ä»¥æ€»ç»“ä¸ºä»¥ä¸‹çš„å››ä¸ªåŠŸèƒ½ç‚¹ï¼š</p><ol><li><p><strong>è¯·æ±‚æ¥å…¥</strong>ï¼Œä½œä¸ºæ‰€æœ‰APIæ¥å£çš„æœåŠ¡è¯·æ±‚çš„æ¥å…¥ç‚¹ã€‚</p></li><li><p><strong>èšåˆä¸šåŠ¡</strong>ï¼Œä½œä¸ºæ‰€æœ‰åç«¯æœåŠ¡çš„èšåˆç‚¹ã€‚</p></li><li><p><strong>ä¸­ä»‹ç­–ç•¥</strong>ï¼Œå®ç°å®‰å…¨ã€éªŒè¯ã€è·¯ç”±ã€è¿‡æ»¤ã€æµæ§ç­‰ç­–ç•¥ã€‚</p></li><li><p><strong>ç»Ÿä¸€ç®¡ç†</strong>ï¼Œå¯¹æ‰€æœ‰APIæœåŠ¡å’Œç­–ç•¥è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚</p></li></ol></blockquote><h2 id="è®¾è®¡é‡ç‚¹"><a href="#è®¾è®¡é‡ç‚¹" class="headerlink" title="è®¾è®¡é‡ç‚¹"></a>è®¾è®¡é‡ç‚¹</h2><p>ç½‘å…³æ˜¯æˆ‘ä»¬æœåŠ¡çš„å…¥å£å’Œå‡ºå£ï¼Œæ‰€æœ‰çš„æµé‡éƒ½ä¼šç»è¿‡ç½‘å…³ï¼Œå› æ­¤é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§å¾ˆè‡ªç„¶è€Œç„¶çš„æˆä¸ºæˆ‘ä»¬çš„è®¾è®¡æŒ‡æ ‡ã€‚ç½‘å…³çš„è®¾è®¡åº”è¯¥åƒè®¸å¤šæœåŠ¡ä¸€æ ·ï¼Œåº”è¯¥å¯ä»¥éšç€ç¡¬ä»¶æ°´å¹³çš„æå‡ï¼Œæå‡æ•´ä½“çš„æœåŠ¡èƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å…·æœ‰å¼ºå¤§çš„æ°´å¹³æ‹“å±•èƒ½åŠ›ã€‚æˆ‘ä»¬æ—¶å¸¸è¿˜éœ€è¦æ·»åŠ ä¸€äº›è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘åœ¨ç½‘å…³ä¸Šï¼Œä¾‹å¦‚å¸¸è§çš„ä¸€äº›ç™»å½•ã€é‰´æƒã€é™æµç­‰æ“ä½œã€‚</p><ul><li><p><strong>é«˜æ€§èƒ½</strong>ï¼ŒæŠ€æœ¯é€‰å‹è®¾è®¡ä¸Šï¼Œç½‘å…³ä¸åº”è¯¥ä¹Ÿä¸èƒ½æˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç³»ç»Ÿç“¶é¢ˆã€‚å¯¹äºé«˜æ€§èƒ½ï¼Œæœ€å¥½æ˜¯ä½¿ç”¨é«˜æ€§èƒ½çš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€‚å¦‚Cï¼ŒC++ã€GOæˆ–Javaã€‚ç½‘å…³å¯¹åç«¯çš„è¯·æ±‚ï¼Œä»¥åŠå¯¹å‰ç«¯çš„è¯·æ±‚çš„æœåŠ¡ä¸€å®šè¦ä½¿ç”¨å¼‚æ­¥é˜»å¡çš„I/Oæ¥ç¡®ä¿åç«¯å»¶è¿Ÿä¸ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºä¸­å‡ºç°æ€§èƒ½é—®é¢˜ã€‚</p></li><li><p><strong>é«˜å¯ç”¨</strong>ï¼Œæ‰€æœ‰çš„æµé‡å’Œè°ƒç”¨éƒ½ä¼šç»è¿‡ç½‘å…³ï¼Œæ‰€ä»¥ç½‘å…³å¿…é¡»æˆä¸ºä¸€ä¸ªé«˜å¯ç”¨çš„ç»„ä»¶ï¼Œå®ƒçš„ç¨³å®šä¹‹é—´å…³ç³»åˆ°æ‰€æœ‰æœåŠ¡çš„ç¨³å®šï¼Œå¦‚æœä¸€ç‰‡æœåŠ¡çš„ç½‘å…³å‡ºç°æ•…éšœï¼Œå°†ä¼šé€ æˆè¿™ä¸€ç‰‡æœåŠ¡çš„ä¸å¯ç”¨ã€‚</p></li></ul><blockquote><p> å¦‚æœè¦åšåˆ°é«˜å¯ç”¨å¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªæ–¹å‘æ‹“å±•ã€‚</p><ul><li><p><strong>é›†ç¾¤åŒ–</strong>ï¼ŒæœåŠ¡é›†ç¾¤ï¼Œé™ä½å•ä¸ªæœåŠ¡è´Ÿè½½ï¼ŒåŒæ—¶æå‡æœåŠ¡å®¹é”™æ€§ã€‚</p></li><li><p><strong>æœåŠ¡åŒ–</strong>ï¼Œç½‘å…³è¿˜éœ€è¦åšåˆ°åœ¨ä¸é—´æ–­çš„æƒ…å†µä¸‹ä¿®æ”¹é…ç½®ï¼Œè°ƒæ•´è‡ªå·±é…ç½®åï¼Œå¯ä»¥å¿«é€Ÿé‡å¯ã€‚<strong>æˆ–æ˜¯è¯´é€šè¿‡æŸäº›æ–¹å¼å¯ä»¥åŠ¨æ€ä¿®æ”¹é…ç½®ä¿¡æ¯ã€‚</strong></p></li><li><p><strong>æŒç»­åŒ–</strong>ï¼Œå½“æŸä¸ªæœåŠ¡ä¸‹çº¿åï¼Œå¯ä»¥ä¿è¯æµé‡ä¸ä¼šè¿›å…¥åˆ°å½“å‰çš„æ­£åœ¨ä¸‹çº¿çš„æœåŠ¡ä¸Šã€‚è€ŒæœåŠ¡ä¸Šçº¿åï¼ŒæœåŠ¡å¯ä»¥å¿«é€Ÿåœ°åˆ†æ‘Šæ•´ä½“çš„è´Ÿè½½ã€‚</p></li></ul></blockquote><ul><li><strong>é«˜æ‰©å±•</strong>ï¼Œå› ä¸ºç½‘å…³éœ€è¦æ‰¿æ¥æ‰€æœ‰çš„ä¸šåŠ¡æµé‡å’Œè¯·æ±‚ï¼Œï¼Œæ‰€ä»¥ä¸€å®šä¼šæˆ–å¤šæˆ–å°‘æœ‰ä¸€äº›ä¸šåŠ¡é€»è¾‘ã€‚è€Œè¿™äº›ä¸šåŠ¡é€»è¾‘æ˜¯å¤šå˜å’Œä¸ç¡®å®šçš„ï¼Œå› æ­¤æˆ‘ä»¬çš„æœåŠ¡è¿˜éœ€è¦å¯æ‹“å±•ï¼Œå¹¶ä¸”èƒ½è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚</li></ul><h2 id="ç½‘å…³å¯¹æ¯”"><a href="#ç½‘å…³å¯¹æ¯”" class="headerlink" title="ç½‘å…³å¯¹æ¯”"></a>ç½‘å…³å¯¹æ¯”</h2><p>ç½‘å…³ä¾æ®ä¸åŒçš„åŠŸèƒ½å’Œå…³æ³¨ç‚¹ä¹Ÿæœ‰ä¸åŒçš„åˆ†ç±»ï¼Œåˆ†ä¸ºæµé‡ç½‘å…³å’Œä¸šåŠ¡ç½‘å…³ã€‚æµé‡ç½‘å…³é¡¾åæ€ä¹‰å°±æ˜¯æ§åˆ¶æµé‡è¿›å…¥é›†ç¾¤çš„ç½‘å…³ï¼Œå¯¹äºä¸€ä¸ªæœåŠ¡æ‰¿è½½çš„æµé‡æ˜¯éå¸¸å¤§çš„ï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯æœ‰æ•ˆçš„è¯·æ±‚ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦å°†æ— æ•ˆçš„è¯·æ±‚æŒ¡åœ¨å¤–é¢ï¼Œé™ä½æ•´ä½“æœåŠ¡çš„å‹åŠ›ã€‚è€Œä¸šåŠ¡ç½‘å…³ï¼Œé¡¾åæ€ä¹‰å’Œä¸šåŠ¡è´´çš„æ¯”è¾ƒè¿‘ï¼Œæ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ï¼Œä¸»è¦åšä¸€äº›åŸºç¡€åŠŸèƒ½çš„æ‰©å±•ï¼Œæ¯”å¦‚è¯·æ±‚è½¬å‘ï¼Œåè®®é€‚é…ï¼Œç†”æ–­é™æµç­‰ã€‚ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20211005100142.png"></p><h3 id="åŠŸèƒ½å¯¹æ¯”"><a href="#åŠŸèƒ½å¯¹æ¯”" class="headerlink" title="åŠŸèƒ½å¯¹æ¯”"></a>åŠŸèƒ½å¯¹æ¯”</h3><p>ä¸šåŠ¡ç½‘å…³çš„åŠŸèƒ½æ›´å¤šå’Œåº”ç”¨ä¸šåŠ¡ç›¸å…³æ¥æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œè€Œæµé‡å…³æ³¨çš„æ›´å¤šçš„æ˜¯æµé‡è´Ÿè½½å‹åŠ›ä¿è¯æœåŠ¡ç¨³å®šå®‰å…¨ã€‚<strong>æµé‡ç½‘å…³</strong>é€šå¸¸åŒ…æ‹¬ä¸‹é¢ä¸€äº›åŠŸèƒ½ï¼š</p><ul><li><p><strong>å…¨å±€æ€§æµæ§ã€‚</strong></p></li><li><p><strong>æ—¥å¿—ç»Ÿè®¡ã€‚</strong></p></li><li><p><strong>é˜²æ­¢SQLæ³¨å…¥ã€‚</strong></p></li><li><p><strong>é˜²æ­¢Webæ”»å‡»ã€‚</strong></p></li><li><p><strong>å±è”½å·¥å…·æ‰«æã€‚</strong></p></li><li><p><strong>é»‘ç™½åå•ã€‚</strong></p></li><li><p><strong>è¯ä¹¦/åŠ è§£å¯†å¤„ç†ã€‚</strong></p></li></ul><p>æµé‡é€šå¸¸åªæœ‰ä¸€äº›å…¨å±€æ€§çš„APIç®¡ç†ç­–ç•¥ï¼Œä»ä¸Šé¢çš„ä¸»è¦åŠŸèƒ½ä¹Ÿä¸éš¾å‘ç°è¿™ä¸€ç‚¹ã€‚æµé‡ç½‘å…³æ€»ä½“åŠŸèƒ½ä¸Šç±»ä¼¼é˜²ç«å¢™ã€‚Kongå°±æ˜¯å…¸å‹çš„æµé‡ç½‘å…³ã€‚å¯ä»¥çœ‹åˆ°ä¸‹é¢ä¹Ÿéƒ½æ˜¯ä¸€äº›æµé‡æ§åˆ¶ç­–ç•¥ï¼ŒåŒ…æ‹¬ä¸€äº›æ—¥å¿—è®°å½•ï¼Œå®‰å…¨ã€ç›‘æ§ç­‰åŠŸèƒ½ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20211005115210.png"></p><p><strong>ä¸šåŠ¡ç½‘å…³</strong>é€šå¸¸åŒ…å«ä¸‹é¢çš„ä¸€äº›åŠŸèƒ½ï¼š</p><ul><li><p><strong>æœåŠ¡çº§åˆ«æµé‡æ§åˆ¶ã€‚</strong></p></li><li><p><strong>æœåŠ¡é™çº§ä¸ç†”æ–­ã€‚</strong></p></li><li><p><strong>è·¯ç”±ä¸è´Ÿè½½å‡è¡¡ã€ç°åº¦ç­–ç•¥ã€‚</strong></p></li><li><p><strong>æœåŠ¡è¿‡æ»¤ã€èšåˆä¸å‘ç°ã€‚</strong></p></li><li><p><strong>æƒé™éªŒè¯ä¸å‚æ•°æ ¡éªŒã€‚</strong></p></li><li><p><strong>å¤šçº§ç¼“å­˜ç­–ç•¥ã€‚</strong></p></li></ul><p>ä¸šåŠ¡ç½‘å…³ç›¸è¾ƒäºæµé‡ç½‘å…³ä¼šæ›´è´´è¿‘ä¸šåŠ¡ï¼Œä»ä¸Šé¢çš„å¸¸åŒ…æ‹¬çš„åŠŸèƒ½ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œä¸šåŠ¡ç½‘å…³æ›´å¤šæ˜¯å’ŒæœåŠ¡ç›¸å…³ï¼Œæœ‰å¾ˆå¤šåº”ç”¨å±‚éœ€è¦è€ƒè™‘çš„äº‹æƒ…ï¼Œå°±å¯ä»¥ä¾æ‰˜äºä¸šåŠ¡ç½‘å…³ï¼Œä¾‹å¦‚çº¿ç¨‹æ¨¡å‹ã€åè®®é€‚é…ã€ç†”æ–­é™æµå’ŒæœåŠ¡ç¼–æ’ç­‰ã€‚ä¸‹é¢è¿™ä¸ªå°±æ˜¯ä¸€ä¸ªç½‘ä¸šåŠ¡ç½‘å…³çš„ç»“æ„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20211005101559.png"></p><h3 id="ä¸»æµç½‘å…³"><a href="#ä¸»æµç½‘å…³" class="headerlink" title="ä¸»æµç½‘å…³"></a>ä¸»æµç½‘å…³</h3><p>ç›®å‰å¸¸è§çš„å¼€æºç½‘å…³å¤§è‡´æŒ‰ç…§è¯­è¨€å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç±»ï¼š</p><ul><li><p>Nginx+luaï¼šOpenRestyã€Kongã€Orangeã€Abtesting gatewayç­‰</p></li><li><p>Javaï¼šZuul/Zuul2ã€Spring Cloud Gatewayã€Kaazing KWGã€graviteeã€shenyuï¼ˆsoulï¼‰ç­‰ã€‚</p></li><li><p>Goï¼šJanusã€fagongziã€Grpc-gateway</p></li><li><p>Dotnetï¼šOcelot</p></li><li><p>NodeJSï¼šExpress Gatewayã€Micro Gateway</p></li></ul><p>ç›®å‰æŒ‰ç…§ä½¿ç”¨æ•°é‡ã€æˆç†Ÿåº¦ç­‰æŒ‡æ ‡æ¥åˆ’åˆ†ã€‚ç›®å‰ä¸»æµçš„æœ‰4ä¸ªï¼š</p><ul><li><p>OpenResty</p></li><li><p>Kong</p></li><li><p>Zuul/Zuul2</p></li><li><p>Spring Cloud Gateway</p></li></ul><p>è¿™é‡Œæˆ‘ä»¬å°±ä¸æ·±å…¥æ¢³ç†äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æ‰¾å¯¹åº”é¡¹ç›®çš„ç¤¾åŒºå’Œæ–‡æ¡£ç»§ç»­æ·±å…¥å­¦ä¹ ã€‚</p><h2 id="ç¼–ç å®æˆ˜"><a href="#ç¼–ç å®æˆ˜" class="headerlink" title="ç¼–ç å®æˆ˜"></a>ç¼–ç å®æˆ˜</h2><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†å…³ç½‘å…³çš„ä¸€äº›çŸ¥è¯†ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†ä½¿ç”¨Nettyå®ç°ä¸€ä¸ªç®€å•çš„APIç½‘å…³ã€‚è¿™ä¸ªç½‘å…³çš„åŠŸèƒ½åŒ…æ‹¬åŸºç¡€çš„è¿‡æ»¤ï¼Œè·¯ç”±ç­‰åŠŸèƒ½ã€‚æ•´ä½“çš„åŠŸèƒ½ç»“æ„å¦‚ä¸‹å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20211005150931.png"></p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåŸºäºNettyçš„HTTP Serverï¼Œè¿™ä¸ªéƒ¨åˆ†åœ¨å‰é¢çš„Demoä¸­å·²ç»å†™è¿‡å¾ˆå¤šä¸ªäº†ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šèµ˜è¿°äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * netty ç½‘å…³æœåŠ¡</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyGateWayServer</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> DEFAULT_PORT = <span class="hljs-number">8888</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> port;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;String&gt; proxyServers;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">NettyGateWayServer</span><span class="hljs-params">(Integer port, List&lt;String&gt; proxyServers)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.port = port != <span class="hljs-keyword">null</span> ? port : DEFAULT_PORT;<br>        <span class="hljs-keyword">if</span> (proxyServers == <span class="hljs-keyword">null</span> || proxyServers.size() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;gateway need at least one server instance!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">this</span>.proxyServers = proxyServers;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">2</span>);<br>        EventLoopGroup workGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>            serverBootstrap.option(ChannelOption.SO_BACKLOG, <span class="hljs-number">128</span>)<br>                    .option(ChannelOption.SO_REUSEADDR, <span class="hljs-keyword">true</span>)<br>                    .option(ChannelOption.SO_RCVBUF, <span class="hljs-number">32</span> * <span class="hljs-number">1024</span>)<br>                    .option(EpollChannelOption.SO_REUSEPORT, <span class="hljs-keyword">true</span>)<br>                    .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)<br>                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>);<br>            serverBootstrap.group(bossGroup, workGroup).channel(NioServerSocketChannel.class)<br>                    .handler(<span class="hljs-keyword">new</span> LoggingHandler(LogLevel.INFO))<br>                    .childHandler(<span class="hljs-keyword">new</span> MyHttpInitializer(<span class="hljs-keyword">this</span>.proxyServers));<br><br>            ChannelFuture future = serverBootstrap.bind(port).sync();<br>            future.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;NettyGateWayServer&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;port=&quot;</span> + port +<br>                <span class="hljs-string">&quot;, proxyServers=&quot;</span> + proxyServers +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨å‰é¢çš„Demoä¸­ï¼Œæˆ‘ä»¬æ˜¯ChildHandlerçš„å®ç°ç›´æ¥ä½œä¸ºå†…éƒ¨ç±»çš„æ–¹å¼ç›´æ¥æ”¾åœ¨NettyServerä¸­ï¼Œä½†æ˜¯è¿™ä¹ˆæˆ‘ä»¬å•ç‹¬æ”¾åœ¨ä¸€ä¸ªç±»æ–‡ä»¶ä¸­ï¼Œè¿™ä¸¤ç§å†™æ³•æ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«ã€‚åœ¨è¿™é‡Œçš„å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * childHandler å®ç°</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHttpInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInitializer</span>&lt;<span class="hljs-title">SocketChannel</span>&gt; </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpRouterHandler httpRouterHandler;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyHttpInitializer</span><span class="hljs-params">(List&lt;String&gt; proxyServers)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.httpRouterHandler = <span class="hljs-keyword">new</span> HttpRouterHandler(proxyServers);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        HttpFilterChain chain = HttpFilterChain.createDefault().addFilter(<span class="hljs-keyword">new</span> PathCheckFilter())<br>                .addFilter(<span class="hljs-keyword">new</span> HeaderAdderFilter());<br>        socketChannel.pipeline().addLast(<span class="hljs-keyword">new</span> HttpServerCodec())<br>                .addLast(<span class="hljs-keyword">new</span> HttpObjectAggregator(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>))<br>                .addLast(<span class="hljs-keyword">new</span> HttpFilterHandler(chain)).addLast(httpRouterHandler);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå®ç°ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªæ„é€ å™¨éœ€è¦ä¼ å…¥ä¸€ä¸ª<code>List&lt;String&gt;</code>å³å®ä¾‹çš„åœ°å€åˆ—è¡¨ã€‚ç„¶åä½¿ç”¨è¿™ä¸ªåœ°å€<code>List</code>åˆ›å»ºå‡ºä¸€ä¸ª<code>RouterHandler</code>ã€‚é€šè¿‡è¿™ä¸ª<code>RouterHandler</code>å®ç°ä¸åŒçš„è¯·æ±‚è·¯ç”±ç­–ç•¥ã€‚è¿™æ˜¯ä¸€ä¸ªHttpServerçš„å®ç°ï¼Œæœ€åæ·»åŠ äº†æˆ‘ä»¬ä¸¤ä¸ªè‡ªå®šä¹‰çš„Handlerï¼Œä¸€ä¸ªæ˜¯è¿‡æ»¤å™¨Handlerï¼Œå¦å¤–ä¸€ä¸ªæ˜¯è·¯ç”±Handlerã€‚åœ¨ä¸‹é¢çš„<code>initChannel</code>æˆ‘ä»¬è¿˜åˆ›å»ºäº†<code>HttpFilterChain</code>å³ä¸€ä¸ªè¿‡æ»¤é“¾ï¼Œåœ¨è¿™ä¸ªè¿‡æ»¤é“¾ä¸­åŠ å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨å®ä¾‹ã€‚å…¶ä¸­è¿‡æ»¤é“¾å’Œè¿‡æ»¤å™¨å®ç°å¦‚ä¸‹ï¼Œéƒ½éå¸¸ç®€å•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpFilterChain</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;HttpRequestFilter&gt; filters;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">HttpFilterChain</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.filters = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> HttpFilterChain <span class="hljs-title">createDefault</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpFilterChain();<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> HttpFilterChain <span class="hljs-title">addFilter</span><span class="hljs-params">(HttpRequestFilter filter)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.filters.add(filter);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;HttpRequestFilter&gt; <span class="hljs-title">getFilters</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.filters;<br>    &#125;<br><br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">HttpRequestFilter</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">filter</span><span class="hljs-params">(FullHttpRequest request, ChannelHandlerContext ctx)</span></span>;<br>&#125;<br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PathCheckFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HttpRequestFilter</span></span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">filter</span><span class="hljs-params">(FullHttpRequest request, ChannelHandlerContext ctx)</span> </span>&#123;<br>        String uri = request.uri();<br>        <span class="hljs-keyword">return</span> uri.contains(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å› ä¸ºfitleræ–¹æ³•ä¼šä¼ å…¥<code>FullHttpRequest</code>ï¼Œæˆ‘ä»¬å¾€å¾€å¯ä»¥åœ¨è¿™é‡Œå®Œæˆä¸€äº›é‰´æƒæˆ–æ˜¯å¾€å¤´ä¸­åŠ å…¥ä¸€äº›ä¸šåŠ¡éœ€è¦çš„æ•°æ®ï¼Œä¾‹å¦‚ä¸‹é¢è¿™ä¸ªå®ç°ã€‚</p><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs vbscript">/**<br> * Created by Daiwei <span class="hljs-keyword">on</span> <span class="hljs-number">2021</span>/<span class="hljs-number">1</span>/<span class="hljs-number">29</span><br> */<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> HeaderAdderFilter implements HttpRequestFilter &#123;<br><br>    @Override<br>    <span class="hljs-keyword">public</span> boolean <span class="hljs-built_in">filter</span>(FullHttpRequest <span class="hljs-built_in">request</span>, ChannelHandlerContext ctx) &#123;<br>        <span class="hljs-built_in">request</span>.headers().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;daiwei&quot;</span>);<br>        <span class="hljs-built_in">request</span>.headers().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-number">25</span>);<br>        <span class="hljs-built_in">request</span>.headers().<span class="hljs-keyword">set</span>(<span class="hljs-string">&quot;addr&quot;</span>, <span class="hljs-string">&quot;shanghai&quot;</span>);<br>        return <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨<code>ChannelPipline</code>ä¸­æˆ‘ä»¬åŠ å…¥äº†ä¸¤ä¸ªè‡ªå®šä¹‰çš„<code>Handler</code>ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªè¿‡æ»¤å™¨handlerï¼Œç¬¬äºŒä¸ªæ˜¯è·¯ç”±handlerã€‚è¿™ä¸¤ä¸ªhandlerå®ç°äº†å¯¹è¯·æ±‚çš„è¿‡æ»¤å’Œè½¬å‘ã€‚ä¸‹é¢çš„ä»£ç æ˜¯è¿™ä¸¤ä¸ªhandlerçš„å®ç°ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è¿‡æ»¤å™¨å¤„ç†å™¨</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpFilterHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpFilterChain filterChain;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HttpFilterHandler</span><span class="hljs-params">(HttpFilterChain filterChain)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.filterChain = filterChain;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        FullHttpRequest fullHttpRequest = (FullHttpRequest) msg;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (doFilter(fullHttpRequest, ctx)) &#123;<br>                ctx.fireChannelRead(msg);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                DefaultFullHttpResponse unAuthResp = HttpNettyHelper.genUnAuthResp();<br>                <span class="hljs-keyword">if</span> (!HttpUtil.isKeepAlive(fullHttpRequest)) &#123;<br>                    ctx.writeAndFlush(unAuthResp).addListener(ChannelFutureListener.CLOSE);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    unAuthResp.headers().set(HttpHeaderNames.CONNECTION, HttpHeaderNames.KEEP_ALIVE);<br>                    ctx.writeAndFlush(unAuthResp);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            ReferenceCountUtil.release(msg);<br>        &#125;<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ‰§è¡Œè¿‡æ»¤é“¾</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(FullHttpRequest request, ChannelHandlerContext ctx)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (HttpRequestFilter filter : <span class="hljs-keyword">this</span>.filterChain.getFilters()) &#123;<br>            <span class="hljs-keyword">if</span> (!filter.filter(request, ctx)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸€æ®µçš„é€»è¾‘ä¹Ÿéå¸¸ç®€å•ï¼Œ<code>channelRead</code>æ–¹æ³•è¯»å–è¯·æ±‚ï¼Œç„¶åè°ƒç”¨è¿‡æ»¤é“¾<code>doFilter</code>ï¼Œå¦‚æœè¿‡æ»¤ä¸é€šè¿‡ï¼Œç›´æ¥è¿”å›ä¸€ä¸ªæ ¡éªŒä¸é€šè¿‡çš„å“åº”ï¼Œå¦‚æœè¿‡æ»¤é€šè¿‡ç›´æ¥æ‹‰èµ·è°ƒç”¨ä¸‹ä¸€ä¸ª<code>channelPipline</code>çš„ä¸‹ä¸€ä¸ª<code>inboundHandler</code>ï¼Œå³è´Ÿè´£è·¯ç”±çš„handlerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * è·¯ç”±å¤„ç†å™¨</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/25</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@ChannelHandler</span>.Sharable<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpRouterHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> HttpRouter router;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CloseableHttpAsyncClient httpClient;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ThreadPoolExecutor executorService;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> SUCCESS_CODE = <span class="hljs-number">200</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NUM_OF_CORE = Runtime.getRuntime().availableProcessors();<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> KEEP_ALIVE = <span class="hljs-number">8L</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> QUEUE_SIZE = <span class="hljs-number">1024</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HttpRouterHandler</span><span class="hljs-params">(List&lt;String&gt; proxyServers)</span> </span>&#123;<br><br><br>        IOReactorConfig ioConfig = IOReactorConfig.custom()<br>                .setConnectTimeout(<span class="hljs-number">1000</span>)<br>                .setSoTimeout(<span class="hljs-number">1000</span>)<br>                .setIoThreadCount(NUM_OF_CORE)<br>                .setRcvBufSize(<span class="hljs-number">32</span> * <span class="hljs-number">1024</span>)<br>                .build();<br><br>        httpClient = HttpAsyncClients.custom().setMaxConnTotal(<span class="hljs-number">40</span>)<br>                .setMaxConnPerRoute(<span class="hljs-number">8</span>).setDefaultIOReactorConfig(ioConfig)<br>                .setKeepAliveStrategy(((httpResponse, httpContext) -&gt; <span class="hljs-number">6000</span>)).build();<br><br>        httpClient.start();<br><br>        <span class="hljs-keyword">this</span>.executorService = <span class="hljs-keyword">new</span> ThreadPoolExecutor(NUM_OF_CORE, NUM_OF_CORE, KEEP_ALIVE, TimeUnit.SECONDS,<br>                <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(QUEUE_SIZE), <span class="hljs-keyword">new</span> ThreadPoolExecutor.CallerRunsPolicy());<br>        <span class="hljs-keyword">this</span>.router = <span class="hljs-keyword">new</span> RoundRobinRouter(proxyServers);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        String host = <span class="hljs-keyword">this</span>.router.route();<br>        FullHttpRequest request = (FullHttpRequest) msg;<br>        String url = host + request.uri();<br>        <span class="hljs-keyword">this</span>.executorService.submit(() -&gt; executeAndWrite(request, ctx, url));<br>    &#125;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è°ƒç”¨å¹¶è¿”å›</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> url</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">executeAndWrite</span><span class="hljs-params">(FullHttpRequest request, ChannelHandlerContext ctx, String url)</span> </span>&#123;<br>        <span class="hljs-keyword">final</span> HttpGet httpGet = <span class="hljs-keyword">new</span> HttpGet(url);<br>        httpGet.setHeader(HTTP.CONN_DIRECTIVE, HTTP.CONN_KEEP_ALIVE);<br>        <span class="hljs-keyword">this</span>.httpClient.execute(httpGet, <span class="hljs-keyword">new</span> FutureCallback&lt;HttpResponse&gt;() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">completed</span><span class="hljs-params">(HttpResponse httpResponse)</span> </span>&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    writeResp(httpResponse, request, ctx);<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">failed</span><span class="hljs-params">(Exception e)</span> </span>&#123;<br>                httpGet.abort();<br>                FullHttpResponse resp = HttpNettyHelper.genFailedResp();<br>                ctx.writeAndFlush(resp);<br>                e.printStackTrace();<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancelled</span><span class="hljs-params">()</span> </span>&#123;<br>                httpGet.abort();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeResp</span><span class="hljs-params">(HttpResponse response, FullHttpRequest request, ChannelHandlerContext ctx)</span> </span>&#123;<br>        FullHttpResponse resp = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (response.getStatusLine().getStatusCode() == SUCCESS_CODE) &#123;<br>                <span class="hljs-keyword">byte</span>[] bytes = EntityUtils.toByteArray(response.getEntity());<br>                resp = HttpNettyHelper.genBaseResp(bytes);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                resp = HttpNettyHelper.genFailedResp();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>            resp = HttpNettyHelper.genFailedResp();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            <span class="hljs-keyword">if</span> (request != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">if</span> (!HttpUtil.isKeepAlive(request)) &#123;<br>                    ctx.write(resp).addListener(ChannelFutureListener.CLOSE);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    ctx.write(resp);<br>                &#125;<br>            &#125;<br>            ctx.flush();<br>        &#125;<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç±»æ„é€ æ–¹æ³•é‡Œåˆ›å»ºä¸€ä¸ª<code>httpClient</code>ç”¨æ¥è¿›è¡Œè½¬å‘æ“ä½œï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªè·¯ç”±å™¨ã€‚åœ¨è¯»å–è¯·æ±‚çš„æ–¹æ³•<code>channelRead</code>ä¸­ï¼Œä½¿ç”¨è·¯ç”±å™¨è·¯ç”±å‡ºä¸‹ä¸€æ¬¡çš„è½¬å‘çš„åœ°å€ã€‚å¹¶ä¸”è¿›è¡Œè¯·æ±‚çš„è½¬å‘æ“ä½œã€‚å½“éƒ½åˆ°å›å¤è¯·æ±‚åï¼Œå†å°†å“åº”è¿”å›ç»™è°ƒç”¨æ–¹ã€‚æ•´ä¸ªæµç¨‹ä¸‹æ¥ï¼Œä¸€æ¬¡è¯·æ±‚çš„è¿‡æ»¤å’Œè½¬å‘å°±å®Œæˆäº†ã€‚æ³¨æ„è¿™é‡Œçš„è·¯ç”±è§„åˆ™æ˜¯<code>RoundRobinRouter</code>å³è½®è¯¢çš„è·¯ç”±è§„åˆ™ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoundRobinRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpRouter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger cnt = <span class="hljs-keyword">new</span> AtomicInteger();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RoundRobinRouter</span><span class="hljs-params">(List&lt;String&gt; proxyServers)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(proxyServers);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">route</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.proxyServers.get(cnt.getAndIncrement() % <span class="hljs-keyword">this</span>.proxyServers.size());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æˆ‘è¿˜é¡ºå¸¦å®ç°äº†éšæœºçš„è·¯ç”±è§„åˆ™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomRouter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpRouter</span> </span>&#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Random rdn;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RandomRouter</span><span class="hljs-params">(List&lt;String&gt; proxyServers)</span> </span>&#123;<br>        <span class="hljs-keyword">super</span>(proxyServers);<br>        <span class="hljs-keyword">this</span>.rdn = <span class="hljs-keyword">new</span> Random();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">route</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.proxyServers.get(<span class="hljs-keyword">this</span>.rdn.nextInt(proxyServers.size()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨æˆ‘ä»¬å®ç°çš„è¿™ä¸ªè·¯ç”±handlerä¸­æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œä¹‹å‰æˆ‘ä»¬æåˆ°å½“ä¸€ä¸ªè¿æ¥è¿æ¥ä¸Šåï¼ŒNettyéƒ½ä¼šä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºä¸€ä¸ªChannelPiplineã€‚é‚£ä¹ˆè¿™å°±æ„å‘³ç€ï¼Œæ¯å½“ä¸€ä¸ªè¿æ¥è¿ä¸Šéƒ½ä¼šåˆå§‹åŒ–piplineä¸­çš„handlerã€‚å¯¹äº<code>HttpFilterHandler</code>æ¥è¯´åˆ›å»ºå¼€é”€å¹¶ä¸å¤§ï¼Œä½†æ˜¯å¯¹äº<code>HttpRouterHandler</code>å°±å®Œå…¨ä¸ä¸€æ ·äº†ï¼Œåœ¨è·¯ç”±handlerä¸­ï¼Œä¸ä»…ä»…éœ€è¦åˆ›å»ºä¸€ä¸ª<code>HttpClient</code>è¿˜éœ€è¦èµ‹å€¼ä¸€ä¸ªè·¯ç”±ï¼ˆRouterï¼‰ï¼Œå¦‚æœæ¯ä¸€ä¸ªè¯·æ±‚éƒ½è¦åˆ›å»ºè¿™ä¹ˆå¤šä¸œè¥¿ï¼Œé‚£æ€§èƒ½çš„å¼€é”€å°±éå¸¸çš„ä¸ä¹è§‚äº†ã€‚åŒæ—¶æˆ‘ä»¬æˆ‘ä»¬è½®è¯¢çš„ç­–ç•¥æ˜¯é€šè¿‡ä¸€ä¸ª<code>AtomicInteger</code>ä¸æ–­çš„å»è‡ªå¢å®ç°çš„ï¼Œé‚£ä¹ˆå¦‚æœæ¯æ¬¡è¯·æ±‚è¿›æ¥éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„<code>AtomicInteger</code>è®¡æ•°å™¨ï¼Œè¿™è½®è¯¢çš„ç­–ç•¥å°±æ˜¯æœ‰é—®é¢˜çš„ã€‚å› æ­¤å¦‚æœæˆ‘ä»¬è¦ç°å®è½®è¯¢ä¸”é¿å…æ¯æ¬¡è¿æ¥åˆ›å»ºä¸€ä¸ª<code>HttpClient</code>ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒä»¬é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥åˆ°RouterHandlerä¸­ï¼Œä¹Ÿå¯ä»¥è®©è¿™ä¸ªRouterHandleråœ¨ä¸åŒçš„è¿æ¥ä¸­è¿›è¡Œå…±äº«ã€‚å…±äº«çš„æ–¹æ³•å¾ˆç®€å•ï¼Œåªè¦åœ¨Handlerä¸Šæ·»åŠ æ³¨è§£<code>@ChannelHandler.Sharable</code>æ—¢å¯ä»¥è®©å½“å‰Handlerå®ç°åœ¨ä¸åŒçš„ChannelPiplineä¸­å…±äº«ã€‚å½“ç„¶æˆ‘å»ºè®®ä½¿ç”¨ä¼ å…¥çš„æ–¹å¼æ¥å®ç°ï¼Œè¿™ç§æ–¹å¼å¯ä»¥é¿å…ä¸åŒè¿æ¥ä¹‹é—´èµ„æºçš„å…±äº«ï¼Œå‡å°‘èµ„æºçš„ç«äº‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/1/29</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServerApplication</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8888</span>;<br>        List&lt;String&gt; serverList = Arrays.asList(<span class="hljs-string">&quot;http://127.0.0.1:8801&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:8802&quot;</span>, <span class="hljs-string">&quot;http://127.0.0.1:8803&quot;</span>);<br>        NettyGateWayServer server = <span class="hljs-keyword">new</span> NettyGateWayServer(port, serverList);<br>        System.out.println(<span class="hljs-string">&quot;my gateway is listening at http:127.0.0.1:&quot;</span>+ port + <span class="hljs-string">&quot; for &quot;</span> + server.toString());<br>        <span class="hljs-keyword">try</span> &#123;<br>            server.run();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœ€åè¿™æ˜¯ä¸€ä¸ªæ•´ä¸ªé¡¹ç›®çš„mainå‡½æ•°ï¼Œè¿™é‡Œçš„ServerListæ˜¯å†™æ­»çš„ï¼Œå½“ç„¶æˆ‘ä»¬å¯ä»¥æ¥å…¥æ³¨å†Œä¸­å¿ƒï¼Œæ¥å®ç°å¯ç”¨æœåŠ¡åˆ—è¡¨çš„åŠ¨æ€æ‹‰å–ã€‚ä»¥ä¸Šå°±æ˜¯æ•´ä¸ªç®€å•çš„APIç½‘å…³çš„è®¾è®¡ä¸ç¼–ç ã€‚</p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬æ¥ç€ä¸Šä¸€å°èŠ‚çš„Demoï¼Œç»§ç»­æ·±å…¥ç¼–å†™äº†ä¸€äº›Demoå®ä¾‹ï¼Œç†Ÿæ‚‰æŒæ¡ä½¿ç”¨Nettyè¿›è¡Œç½‘ç»œç¼–ç¨‹ï¼Œä»ä»£ç å±‚é¢æ„Ÿå—Nettyçš„ç‰¹æ€§ã€‚Demoç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬æ¢³ç†ä½¿ç”¨Nettyç¼–å†™HttpæœåŠ¡ã€WebSocketæœåŠ¡ï¼Œéƒ½æ˜¯æˆ‘ä»¬å¸¸ç”¨ç”¨åˆ°çš„Serverç±»å‹ã€‚éšåæˆ‘ä»¬é€šè¿‡Idelæ£€æµ‹å’Œè‡ªå®šä¹‰ç¼–è§£ç å™¨çš„ä¾‹å­ï¼Œç†Ÿæ‚‰æˆ‘ä»¬å®é™…å¼€å‘è¿‡ç¨‹ä¸­çš„ä¸€äº›ä½¿ç”¨å®ä¾‹ã€‚ç¼–å†™å®Œæˆè¿™äº›ä»£ç ç¤ºä¾‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹æˆ‘ä»¬çš„ç½‘å…³å®æˆ˜ï¼Œæˆ‘ä»¬å…ˆæ˜¯ä»‹ç»äº†ç½‘å…³ï¼Œå·²ç»ç½‘å…³åœ¨å¾®æœåŠ¡ä¸­æ‰®æ¼”çš„è§’è‰²ã€‚éšåæˆ‘ä»¬æŒ‰ç…§ç½‘å…³çš„ä¸åŒç±»å‹ï¼Œå°†ç½‘å…³åˆ†ä¸ºæµé‡ç½‘å…³å’Œä¸šåŠ¡ç½‘å…³ï¼Œä»¥åŠä»–ä»¬çš„è®¾è®¡é‡ç‚¹å’ŒåŠŸèƒ½ä¾§é‡ç‚¹ã€‚æœ€åæˆ‘ä»¬åŠ¨æ‰‹å®æˆ˜ç¼–å†™ä¸€ä¸ªç®€å•çš„APIç½‘å…³ï¼Œåˆ†æå®ç°äº†ä¸€ä¸ªAPIç½‘å…³çš„ä¸€äº›åŸºç¡€åŠŸèƒ½ã€‚åœ¨æ¥ä¸‹æ¥çš„æ¢³ç†ä¸­ï¼Œæˆ‘ä»¬å°†æ·±å…¥Nettyçš„æ ¸å¿ƒç»„ä»¶çš„æºç è¿›è¡Œåˆ†æï¼Œä¸€å®šéå¸¸æœ‰æ„æ€ï¼ŒåŠ æ²¹ğŸ˜</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li><a href="https://blog.csdn.net/weixin_41047704/article/details/85340311">ä»€ä¹ˆæ˜¯TCPç²˜åŒ…ï¼Ÿæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜</a></li><li><a href="https://www.cnblogs.com/Courage129/p/14446586.html">äº¿çº§æµé‡æ¶æ„ä¹‹ç½‘å…³è®¾è®¡æ€è·¯ã€å¸¸è§ç½‘å…³å¯¹æ¯”</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>NIOä¸ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œç¼–ç¨‹ â€” Reactoræ¨¡å‹ä¸Nettyå…¥é—¨</title>
    <link href="/2021/09/22/reactor-model-and-netty-getting-start/"/>
    <url>/2021/09/22/reactor-model-and-netty-getting-start/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰é¢æˆ‘ä»¬ä»‹ç»äº†ç½‘ç»œçš„åŸºç¡€çŸ¥è¯†ï¼Œsocketç½‘ç»œç¼–ç¨‹å’ŒIOæ¨¡å‹ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬æ¥å…¥é—¨Nettyã€‚å¯¹äºå¾ˆå¤šç¨‹åºå‘˜æ¥è¯´ï¼ŒNettyæ˜¯éå¸¸é¥è¿œçš„ã€‚å¾ˆå¤šç¨‹åºå‘˜è®¤ä¸ºå¹³æ—¶çš„å¼€å‘è¿‡ç¨‹ä¸­åŸºæœ¬ä¸ä¼šä½¿ç”¨åˆ°Nettyï¼Œå¦‚æœä½ ä¹Ÿæ˜¯è¿™ä¹ˆè®¤ä¸ºçš„é‚£å°±å¤§é”™ç‰¹é”™äº†ã€‚å› ä¸ºæˆ‘ä»¬è™½ç„¶ä¸ä¼šç›´æ¥å†™Nettyçš„ä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬æ¯å¤©éƒ½åœ¨é—´æ¥ä½¿ç”¨Nettyï¼Œå¤§åˆ°æˆ‘ä»¬çš„RPCæ¡†æ¶dubboã€å¤§æ•°æ®çš„Hadoopï¼Œå°åˆ°Redisçš„å·¥å…·åŒ…ï¼Œå‡ ä¹æ‰€æœ‰å®ç°ç½‘ç»œé€šä¿¡çš„æ¡†æ¶éƒ½æ˜¯åŸºäºNettyå®ç°çš„ã€‚æ‰€ä»¥å­¦ä¹ NettyæŒæ¡Nettyä¸è®ºæ˜¯å¯¹äºæˆ‘ä»¬æ¥è¯´éƒ½æ˜¯å¼€å‘ç½‘ç»œç¨‹åºï¼Œè¿˜æ˜¯æ’æŸ¥ç½‘ç»œé—®é¢˜ï¼Œäº¦æˆ–æ˜¯æ¡†æ¶è®¾è®¡æ€æƒ³ä¸Šçš„æå‡éƒ½æœ‰è«å¤§çš„å¸®åŠ©ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬å…ˆä»æœ€åŸºæœ¬çš„Nettyçš„ç»“æ„æ¨¡å‹å¼€å§‹ï¼Œå…ˆå»ºç«‹ä¸€ä¸ªNettyçš„åŸºæœ¬çš„è®¤çŸ¥ï¼Œéšåæˆ‘ä»¬ç¼–å†™Nettyçš„HelloWorldåŠ æ·±å¯¹Nettyçš„ä¸€äº›æ¨¡å—ç‚¹çš„ç†è§£ã€‚æˆ‘ä»¬å‘è½¦å•¦ï½</p><h1 id="ä¸ºä»€ä¹ˆæ˜¯Netty"><a href="#ä¸ºä»€ä¹ˆæ˜¯Netty" class="headerlink" title="ä¸ºä»€ä¹ˆæ˜¯Netty"></a>ä¸ºä»€ä¹ˆæ˜¯Netty</h1><p>Nettyæ˜¯ç›®å‰æœ€æµè¡Œçš„ç”±JBOSSæä¾›çš„ä¸€ä¸ªJavaå¼€æºNIOæ¡†æ¶ï¼ŒNettyæä¾›å¼‚æ­¥çš„ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œåº”ç”¨ç¨‹åºæ¡†æ¶å’Œå·¥å…·ï¼Œç”¨æ¥å¿«é€Ÿå¼€å‘é«˜æ€§èƒ½ã€é«˜å¯é çš„ç½‘ç»œæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ç¨‹åºã€‚</p><h2 id="Nettyçš„ä¼˜ç‚¹"><a href="#Nettyçš„ä¼˜ç‚¹" class="headerlink" title="Nettyçš„ä¼˜ç‚¹"></a>Nettyçš„ä¼˜ç‚¹</h2><p>Nettyæä¾›äº†ç›¸å¯¹ååˆ†ç®€å•æ˜“ç”¨çš„APIï¼Œéå¸¸é€‚åˆç½‘ç»œç¼–ç¨‹ã€‚Nettyæ˜¯å®Œå…¨åŸºäºNIOå®ç°çš„ï¼ŒNettyæä¾›äº†æ‰€æœ‰IOæ“ä½œéƒ½æ˜¯å¼‚æ­¥éé˜»å¡çš„ï¼Œé€šè¿‡<code>Future-Listener</code>æœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥æ–¹ä¾¿çš„ä¸»åŠ¨è·å–æˆ–è€…é€šè¿‡é€šçŸ¥æœºåˆ¶è·å¾—IOæ“ä½œç»“æœã€‚Nettyæ— ç–‘æ˜¯NIOçš„è€å¤§ï¼Œå®ƒçš„å¥å£®æ€§ã€å¯å®šåˆ¶æ€§ã€å¯æ‹“å±•æ€§å’Œå¼ºå¤§çš„åŠŸèƒ½æ€§èƒ½åœ¨åŒç±»æ¡†æ¶ä¸­éƒ½æ˜¯é¦–å±ˆä¸€æŒ‡çš„ã€‚Nettyçš„ä¼˜ç‚¹å¯ä»¥æ€»ç»“å¦‚ä¸‹ï¼š</p><ol><li><p><strong>APIä½¿ç”¨ç®€å•ï¼Œå¼€å‘é—¨æ§›ä½ã€‚</strong></p></li><li><p><strong>åŠŸèƒ½å¼ºå¤§ï¼Œé¢„ç½®äº†å¤šç§ç¼–è§£ç åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§ä¸»æµåè®®ã€‚</strong></p></li><li><p><strong>å®šåˆ¶åŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥é€šè¿‡ChannelHandlerå¯¹é€šä¿¡æ¡†æ¶è¿›è¡Œçµæ´»åœ°æ‰©å±•ã€‚</strong></p></li><li><p><strong>æ€§èƒ½é«˜ï¼Œé€šè¿‡ä¸å…¶ä»–ä¸šç»©ä¸»æµNIOæ¡†æ¶å¯¹æ¯”ï¼ŒNettyçš„ç»¼åˆæ€§èƒ½æœ€ä¼˜ã€‚</strong></p></li><li><p><strong>æˆç†Ÿã€ç¨³å®šï¼ŒNettyä¿®å¤äº†å·²ç»å‘ç°çš„JDK NIO bugï¼Œä¸šåŠ¡å¼€å‘äººå‘˜ä¸éœ€è¦åœ¨å¼€å‘è¿‡ç¨‹ä¸­å› ä¸ºNIOçš„BUGè€Œçƒ¦æ¼ã€‚</strong></p></li><li><p><strong>ç¤¾åŒºæ´»è·ƒï¼Œç‰ˆæœ¬è¿­ä»£å‘¨æœŸçŸ­ï¼Œå‘ç°çš„bugå¯ä»¥è¢«åŠæ—¶ä¿®å¤ï¼ŒåŒæ—¶ï¼Œæ›´å¤šçš„æ–°åŠŸèƒ½ä¼šåŠ å…¥ã€‚</strong></p></li><li><p><strong>ç»å†äº†å¤§è§„æ¨¡çš„å•†ä¸šåº”ç”¨ï¼Œè´¨é‡å¾—åˆ°éªŒè¯ã€‚</strong></p></li></ol><blockquote><p>é«˜æ€§èƒ½çš„åè®®æœåŠ¡å™¨çš„ç‰¹æ€§ï¼š<br><strong>é«˜ååã€ä½å»¶è¿Ÿã€ä½å¼€é”€ã€é›¶æ‹·è´ã€å¯æ‰©å®¹ã€æ¾è€¦åˆï¼ˆç½‘ç»œé€»è¾‘å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼‰ã€ä½¿ç”¨æ–¹ä¾¿ã€å¯ç»´æŠ¤æ€§å¥½ã€‚</strong></p><p>Nettyçš„å…¼å®¹ç‰¹æ€§ï¼š</p><ul><li><p>JDKå…¼å®¹æ€§ï¼š</p><ul><li>Netty 3.x ï¼šJDK5</li><li>Netty 4.x ï¼šJDK6</li><li>Netty 5.xï¼šå·²ç»åºŸå¼ƒ</li></ul></li><li><p>åè®®å…¼å®¹æ€§:</p><ul><li>å…¼å®¹å¤§éƒ¨åˆ†é€šç”¨åè®®</li><li>æ”¯æŒè‡ªå®šä¹‰åè®®</li></ul></li><li><p>åŸºäºNettyå¯å®ç°æ„å»ºå®ç°ä¼—å¤šæœåŠ¡ç±»å‹ï¼ŒåŒ…æ‹¬ä½†ä¸ä»…é™äºï¼š</p><ul><li>HTTP Server</li><li>HTTPS Server</li><li>WebSocket Server</li><li>TCP Server</li><li>UDP Server</li></ul></li></ul></blockquote><h2 id="ä¸å°½å¦‚äººæ„çš„NIO"><a href="#ä¸å°½å¦‚äººæ„çš„NIO" class="headerlink" title="ä¸å°½å¦‚äººæ„çš„NIO"></a>ä¸å°½å¦‚äººæ„çš„NIO</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“Javaæœ‰è‡ªå·±å®ç°çš„nioï¼ŒåŒæ—¶Nettyä¹Ÿæ˜¯åŸºäºJava nioå®ç°çš„ã€‚æœ‰çš„åŒå­¦å¯èƒ½è¿˜æ˜¯ä¼šè¯´ï¼Œæˆ‘çœ‹socketå°±æŒºå¥½ï¼Œç®€å•åŸç”Ÿï¼Œæˆ‘å°±æ˜¯å–œæ¬¢ç”¨è‡ªå·±å»å°è£…ï¼Œä¸ç”¨Nettyè¡Œä¸è¡Œå‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æˆ‘è¿˜æ˜¯å»ºè®®ä½ ä½¿ç”¨Nettyè¿›è¡Œç½‘ç»œå¼€å‘ï¼Œå…·ä½“çš„åŸå› é‚£è¿˜å¾—ä»Java nioè‡ªèº«è¯´èµ·ã€‚<strong>åœ¨JDK1.8çš„NIOä¸­ä¾ç„¶å­˜åœ¨ä¸€äº›é—®é¢˜</strong>ï¼Œè¿™äº›é—®é¢˜åœ¨ç¼–å†™NIOç¨‹åºæ—¶å€™éœ€è¦æ ¼å¤–æ³¨æ„âš ï¸ï¼š</p><ul><li><strong>NIOè·¨å¹³å°çš„å…¼å®¹æ€§é—®é¢˜</strong>ã€‚NIOæ˜¯åº•å±‚APIï¼Œå®ƒçš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿé’ˆå¯¹IOæ“ä½œçš„APIsï¼Œæ‰€ä»¥Javaèƒ½åœ¨æ‰€æœ‰æ“ä½œç³»ç»Ÿä¸­å®ç°ç»Ÿä¸€çš„æ¥å£ï¼Œå¹¶ç”¨ä¸€è‡´çš„è¡Œä¸ºæ¥æ“ä½œIOæ˜¯å¾ˆä¼Ÿå¤§çš„ã€‚<strong>ä½¿ç”¨NIOç»å¸¸å‘ç°ä»£ç åœ¨Linuxä¸Šæ­£å¸¸è¿è¡Œï¼Œä½†åœ¨Windowsä¸Šå°±ä¼šå‡ºç°é—®é¢˜</strong>ã€‚æ‰€ä»¥ç¼–å†™ç¨‹åºï¼Œç‰¹åˆ«æ˜¯NIOç¨‹åºï¼Œç‰¹åˆ«æ˜¯NIOï¼Œéœ€è¦åœ¨ç¨‹åºæ”¯æŒçš„æ‰€æœ‰æ“ä½œç³»ç»Ÿä¸Šè¿›è¡ŒåŠŸèƒ½æµ‹è¯•ï¼Œå¦åˆ™ä½ å¯èƒ½ä¼šç¢°åˆ°ä¸€äº›è«åå…¶å¦™çš„é—®é¢˜ã€‚NIO2çœ‹èµ·æ¥å¾ˆç†æƒ³ï¼Œä½†æ˜¯<strong>NIO2åªæ”¯æŒjdk1.7+ï¼Œè‹¥ä½ çš„ç¨‹åºåœ¨Java1.6ä¸Šè¿è¡Œï¼Œåˆ™æ— æ³•ä½¿ç”¨NIO2</strong>ã€‚å¦å¤–ï¼ŒJava7çš„NIO2ä¸­æ²¡æœ‰æä¾›DatagramSocketçš„æ”¯æŒï¼Œæ‰€ä»¥NIO2åªæ”¯æŒTCPç¨‹åºï¼Œä¸æ”¯æŒUDPç¨‹åºã€‚</li><li><strong>NIOå¯¹ç¼“å†²åŒºçš„èšåˆå’Œåˆ†æ•£æ“ä½œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</strong>ã€‚å¾ˆå¤šChannelçš„å®ç°æ”¯æŒGatherå’ŒScatterã€‚è¿™ä¸ªåŠŸèƒ½å…è®¸ä»å¤šä¸ªByteBufferä¸­è¯»å…¥æˆ–å†™å…¥ï¼Œè¿™æ ·åšå¯ä»¥æœ‰æ›´å¥½çš„æ€§èƒ½ã€‚æ“ä½œç³»ç»Ÿåº•å±‚çŸ¥é“å¦‚ä½•å¤„ç†è¿™äº›å†™å…¥/è¯»å‡ºï¼Œå¹¶ä¸”èƒ½ä»¥æœ€æœ‰æ•ˆçš„æ–¹å¼å¤„ç†ã€‚å¦‚æœè¦åˆ†å‰²çš„æ•°æ®åœ¨å¤šä¸ªä¸åŒçš„ByteBufferä¸­ï¼Œä½¿ç”¨Gather/Scatteræ˜¯æ¯”è¾ƒå¥½çš„æ–¹å¼ã€‚</li></ul><blockquote><p>scatter/gatheræŒ‡çš„åœ¨å¤šä¸ªç¼“å†²åŒºä¸Šå®ç°ä¸€ä¸ªç®€å•çš„I/Oæ“ä½œï¼Œæ¯”å¦‚ä»é€šé“ä¸­è¯»å–æ•°æ®åˆ°å¤šä¸ªç¼“å†²åŒºï¼Œæˆ–ä»å¤šä¸ªç¼“å†²åŒºå†™å…¥æ•°æ®åˆ°é€šé“ï¼›</p><ol><li>scatterï¼ˆåˆ†æ•£ï¼‰ï¼šæŒ‡çš„æ˜¯<strong>ä»é€šé“ä¸­è¯»å–æ•°æ®åˆ†æ•£åˆ°å¤šä¸ªç¼“å­˜åŒºBufferçš„è¿‡ç¨‹</strong>ï¼Œè¯¥è¿‡ç¨‹ä¼šå°†æ¯ä¸ªç¼“å­˜åŒºå¡«æ»¡ï¼Œç›´è‡³é€šé“ä¸­æ— æ•°æ®æˆ–ç¼“å†²åŒºæ²¡æœ‰ç©ºé—´ã€‚</li><li>gatterï¼ˆèšé›†ï¼‰ï¼šæŒ‡çš„æ˜¯<strong>å°†å¤šä¸ªç¼“å†²åŒºBufferèšé›†èµ·æ¥å†™å…¥åˆ°é€šé“çš„è¿‡ç¨‹</strong>ï¼Œè¯¥è¿‡ç¨‹ç±»ä¼¼äºå°†å¤šä¸ªç¼“å†²åŒºçš„å†…å®¹è¿æ¥èµ·æ¥å†™å…¥é€šé“ã€‚</li></ol></blockquote><ul><li><strong>Squashing the famous epoll bugï¼ˆå‹ç¢è‘—åçš„epoll bugï¼‰</strong>ï¼ŒLinux-like OSsçš„<strong>é€‰æ‹©å™¨ä½¿ç”¨çš„æ˜¯epoll-bugä¹Ÿå¯èƒ½ä¼šå¯¼è‡´æ— æ•ˆçš„çŠ¶æ€é€‰æ‹©å’Œ100%çš„CPUåˆ©ç”¨ç‡</strong>ã€‚è¦è§£å†³<strong>epoll-bugçš„å”¯ä¸€æ–¹æ³•æ˜¯å›æ”¶æ—§çš„é€‰æ‹©å™¨ï¼Œå°†å…ˆå‰æ³¨å†Œçš„é€šé“å®ä¾‹è½¬ç§»åˆ°æ–°åˆ›å»ºçš„é€‰æ‹©å™¨ä¸Š</strong>ã€‚NIOå¯¹epollé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯æœ‰é™åˆ¶çš„ï¼ŒNettyæä¾›äº†æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚</li></ul><h1 id="Netty-æ¨¡å‹ä»‹ç»"><a href="#Netty-æ¨¡å‹ä»‹ç»" class="headerlink" title="Netty æ¨¡å‹ä»‹ç»"></a>Netty æ¨¡å‹ä»‹ç»</h1><p>Nettyçš„çº¿ç¨‹æ¨¡å‹ä¹Ÿä¸æ˜¯ä¸€ä¸Šæ¥ç°åœ¨çš„ä¸»ä»Reactoræ¨¡å‹ï¼Œä¹Ÿæœ‰ä¸€ä¸ªæ€è€ƒè¿›åŒ–çš„è¿‡ç¨‹ã€‚åœ¨Doug Leeç¼–å†™çš„ã€ŠScalable IO in Javaã€‹ä¸­æœ‰å¾ˆå¥½çš„è¡¨è¿°ï¼Œè¯´æ˜äº†æ•´ä¸ªçº¿ç¨‹æ¨¡å‹çš„å˜åŒ–è¿‡ç¨‹ã€‚å­¦ä¹ Nettyçš„çº¿ç¨‹æ¨¡å‹éå¸¸æ¨èå»çœ‹çœ‹è‹±æ–‡ç‰ˆæœ¬ï¼Œä¸è®ºæ˜¯å¯¹åŠ æ·±å¯¹Nettyçº¿ç¨‹çš„ç†è§£ï¼Œè¿˜æ˜¯å¯¹é€æ­¥çš„ç»“æ„è®¾è®¡éƒ½æœ‰å¾ˆå¤§çš„å¯å‘ä½œç”¨ã€‚</p><blockquote><p>åœ¨ä»‹ç»ä¹‹å‰æˆ‘ä»¬å…ˆéœ€è¦ä»‹ç»å‡ ä¸ªåŸºæœ¬çš„æ¦‚å¿µï¼š</p><ul><li><p><strong>Channel</strong>ï¼Œé€šé“ï¼ŒJava NIOä¸­çš„åŸºç¡€æ¦‚å¿µï¼Œä»£è¡¨ä¸€ä¸ª<strong>æ‰“å¼€çš„è¿æ¥ï¼Œå¯ä»¥æ‰§è¡Œè¯»å–/å†™å…¥IOæ“ä½œ</strong>ã€‚Nettyå¯¹Channelçš„æ‰€æœ‰IOæ“ä½œéƒ½æ˜¯éé˜»å¡çš„ã€‚</p></li><li><p><strong>ChannelFuture</strong>ï¼ŒJavaçš„Futureæ¥å£ï¼Œåªèƒ½æŸ¥è¯¢æ“ä½œçš„å®Œæˆæƒ…å†µï¼Œæˆ–è€…é˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…æ“ä½œå®Œæˆã€‚Nettyå°è£…ä¸€ä¸ªChannelFutureæ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥å°†å›è°ƒæ–¹æ³•ä¼ ç»™ChannelFutrueï¼Œåœ¨æ“ä½œæ‰§è¡Œå®Œæˆæ—¶è‡ªåŠ¨æ‰§è¡Œã€‚</p></li><li><p><strong>Event &amp; Handler</strong>ï¼Œ <strong>NettyåŸºäºäº‹ä»¶é©±åŠ¨</strong>ï¼Œäº‹ä»¶å’Œå¤„ç†å™¨å¯ä»¥å…³è”åˆ°å…¥ç«™å’Œå‡ºæˆ˜æ•°æ®æµã€‚</p></li><li><p><strong>Encoder &amp; Decoder</strong>ï¼Œå¤„ç†ç½‘ç»œIOæ—¶ï¼Œéœ€è¦<strong>è¿›è¡Œåºåˆ—åŒ–ä¸ååºåˆ—åŒ–</strong>ï¼Œè½¬æ¢Javaå¯¹è±¡ä¸å­—èŠ‚æµã€‚å¯¹å…¥ç«™æ•°æ®è¿›è¡Œè§£ç ï¼ŒåŸºç±»æ˜¯<code>ByteToMessageDecoder</code>ã€‚å¯¹å‡ºæˆ˜æ•°æ®è¿›è¡Œç¼–ç ï¼ŒåŸºç±»æ˜¯<code>MessageToByteEncoder</code>ã€‚</p></li><li><p><strong>ChannelPipeline</strong>ï¼Œæ•°æ®å¤„ç†ç®¡é“å°±æ˜¯<strong>äº‹ä»¶å¤„ç†å™¨é“¾</strong>ã€‚æœ‰é¡ºåºï¼ŒåŒä¸€Channelçš„å‡ºæˆ˜å¤„ç†å™¨å’Œå…¥ç«™å¤„ç†å™¨åœ¨åŒä¸€åˆ—è¡¨ä¸­ã€‚</p></li></ul></blockquote><h2 id="åŸºç¡€æ¨¡å‹æŠ½è±¡"><a href="#åŸºç¡€æ¨¡å‹æŠ½è±¡" class="headerlink" title="åŸºç¡€æ¨¡å‹æŠ½è±¡"></a>åŸºç¡€æ¨¡å‹æŠ½è±¡</h2><p>å¯¹äºç½‘ç»œæœåŠ¡éƒ½æœ‰ä¸€ä¸ªé€šç”¨çš„å¤„ç†ç»“æ„å³<code>read</code>ã€<code>decode</code>ã€<code>processService</code>ã€<code>encode</code>ã€<code>send</code>ã€‚å½“ç„¶ä»–ä»¬å†…éƒ¨çš„é€»è¾‘å¹¶ä¸ä¸€æ ·ï¼Œä¾‹å¦‚å¯¹åº”ä¸åŒçš„è¯·æ±‚æ•°æ®ç±»å‹ä¼šæœ‰ä¸ä¸€æ ·çš„ç¼–è§£ç å½¢å¼ï¼Œä¸åŒçš„ä¸šåŠ¡é€»è¾‘ä¹Ÿä¼šæœ‰ä¸ä¸€æ ·çš„å¤„ç†æ–¹å¼ã€‚ä½†æ˜¯ä»–ä»¬å¤„ç†æµç¨‹çš„ç»“æ„éƒ½æ˜¯ç›¸é€šçš„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210919113913.png"></p><p>æ­£å› ä¸ºè¿™ç¬¬ä¸€å±‚æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç»å…¸æŠ½è±¡ç»“æ„ï¼Œå³ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥å¤šä¸ªServiceï¼Œä¸€ä¸ªServiceå¯¹æ¥å¤šä¸ªHandlerï¼Œå¹¶ä¸”æ¯ä¸ªHandleréƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210919123721.png"></p><p>è¿™ä¸ªç»“æ„å°±å¯¹åº”æˆ‘ä»¬å‰é¢ä»‹ç»çš„æ›´å¤šçš„è¿æ¥ä¸­çš„<strong>å¤šçº¿ç¨‹</strong>çš„è§£å†³æ–¹æ¡ˆã€‚å³æ¯ä¸ªè¿æ¥éƒ½ç”±ä¸€ä¸ªhandlerå¿«é€Ÿå¤„ç†ã€‚ä½†æ˜¯è¿™æ ·çš„ç»“æ„ä¹Ÿå­˜åœ¨æ˜æ˜¾çš„å¼Šç«¯ï¼Œå°±æ˜¯æ‰©å±•æ€§ä¸å¤Ÿã€‚ä¸èƒ½éšç€å¤–éƒ¨èµ„æºçš„æå‡å¢åŠ æ€§èƒ½ï¼Œéšç€è¿æ¥çš„å¢åŠ Serverè¿æ¥è¶Šæ¥è¶Šå¤šçš„æœåŠ¡ï¼Œæ•´ä¸ªè´Ÿè½½å—åˆ°Serverè¿æ¥æ•°é‡çš„é™åˆ¶ã€‚å¯¹äºNettyæ•´ä¸ªå‘å±•çš„è¿‡ç¨‹æˆ‘ä»¬å¯ä»¥æœ‰ä»¥ä¸‹ä¸€äº›æ‹“å±•æ€è€ƒã€‚</p><blockquote><p>ä»¥ä¸‹è¿™äº›å†…å®¹éƒ½æ˜¯ä»Scalable in Javaé‡Œé¢æ‘˜å–å‡ºæ¥çš„ï¼Œæ˜¯Reactoræ¨¡å‹è®¾è®¡ä¸Šçš„ä¸€äº›æ€è€ƒï¼Œæˆ‘è§‰å¾—å¯¹äºä¸€äº›ç»“æ„ä¸Šçš„è®¾è®¡éå¸¸å…·æœ‰å¯å‘æ„ä¹‰ï¼Œå€¼å¾—åå¤å“ã€‚å…¶ä¸­æœ‰ä¸€å¥è¯éå¸¸æŒ‡çš„æ€è€ƒğŸ¤”ã€‚</p><p>Divide-and-conquer is usually the best approach for achieving any scalability goal</p><p>--</p><p>åˆ†æ²»æ€æƒ³é€šå¸¸æ˜¯å¤„ç†çš„å¯æ‹“å±•æ€§é—®é¢˜çš„æœ€å¥½æ–¹æ³•ã€‚</p><p><strong>å¯¹äºæ‹“å±•æ€§æˆ‘ä»¬å¯ä»¥ä»ä¸‹é¢å‡ ä¸ªæ–¹é¢æ€è€ƒ</strong>ï¼š</p><ul><li>åœ¨å¢åŠ è´Ÿè½½çš„æƒ…å†µä¸‹ï¼Œæ€§èƒ½ç¼“æ…¢çš„é™çº§ï¼ˆè¿æ¥æ›´å¤šçš„å®¢æˆ·ç«¯ï¼‰ã€‚</li><li>å¯ä»¥éšç€ç¡¬ä»¶èµ„æºçš„æå‡ï¼Œä¸æ–­æå‡æ•´ä½“æ€§èƒ½ï¼ˆCPUã€å†…å­˜ã€ç¡¬ç›˜å’Œå¸¦å®½ç­‰ï¼‰ã€‚</li><li>è¿˜æœ‰ä¸€äº›å¯ç”¨æ€§å’Œæ€§èƒ½æŒ‡æ ‡<ul><li>ä½å»¶è¿Ÿã€‚</li><li>èƒ½åœ¨æœ€é«˜è´Ÿè½½ä¸‹ç¨³å®šè¿è¡Œã€‚</li><li>å¯ä»¥è°ƒèŠ‚æ€§èƒ½æŒ‡æ ‡ã€‚</li></ul></li><li>åˆ†æ²»æ€æƒ³</li></ul><p>è¿™é‡Œè°ˆåˆ°äº†åˆ†æ²»æ€æƒ³ï¼Œå‰é¢Doug Lee ä¹Ÿæåˆ°äº†åˆ†æ²»æ€æƒ³æ˜¯å¤„ç†æ‰©å±•æ€§é—®é¢˜çš„æœ€å¥½è§£å†³åŠæ³•ï¼Œé‚£æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹åˆ†æ²»æ€æƒ³åˆæ˜¯æ€ä¹ˆåœ¨IOä¸­ä½“ç°çš„å§ã€‚Java NIO ä¸­çš„åˆ†æ²»æ€æƒ³ï¼š</p><ul><li>å°†å¤§ä»»åŠ¡åˆ‡åˆ†æˆå¤šä¸ªå°ä»»åŠ¡ï¼Œå¹¶ä¸”æ¯ä¸ªå°ä»»åŠ¡éƒ½æ˜¯éé˜»å¡çš„ã€‚</li><li>äº‹ä»¶é©±åŠ¨ï¼Œå½“ä»»åŠ¡è¾¾åˆ°å°±å¯ä»¥è¢«å¤„ç†ï¼Œé€šå¸¸ç”¨ä¸€ä¸ªIOäº‹ä»¶è§¦å‘æ¡ä»¶ã€‚</li><li>åŸºæœ¬çš„Java NIOæœºåˆ¶æ”¯æŒã€‚<ul><li>éé˜»å¡çš„è¯»å’Œå†™ã€‚</li><li>åˆ†æ´¾ä»»åŠ¡å’ŒIOäº‹ä»¶è¿›è¡Œå…³è”ã€‚     </li></ul></li><li>æ— ç©·æ— å°½çš„æ‹“å±•æ€§<ul><li>å¯ä»¥ä¾æ®ä»»åŠ¡é©±åŠ¨è®¾è®¡æ¨¡å¼è®¾è®¡æ›´å¤šçš„å¤„ç†å™¨ã€‚</li></ul></li></ul></blockquote><h2 id="äº‹ä»¶é©±åŠ¨æ¨¡å‹"><a href="#äº‹ä»¶é©±åŠ¨æ¨¡å‹" class="headerlink" title="äº‹ä»¶é©±åŠ¨æ¨¡å‹"></a>äº‹ä»¶é©±åŠ¨æ¨¡å‹</h2><p>ä¸Šé¢æˆ‘ä»¬æåˆ°äº†äº‹ä»¶é©±åŠ¨ã€‚<strong>äº‹ä»¶é©±åŠ¨å°±æ˜¯åŸºäºäº‹ä»¶è§¦å‘æ‹‰èµ·ç¨‹åºçš„æ‰§è¡Œ</strong>ã€‚ä¾‹å¦‚Javaé‡Œé¢çš„AWTå³Javaæ¡Œé¢çª—å£ç¨‹åºï¼Œå¦‚æœä½ å†™è¿‡JWTæˆ–è€…è¯´æ˜¯.netæ¡Œé¢åº”ç”¨ç¨‹åºï¼Œé‚£è‚¯å®šçŸ¥é“å¦‚æœæƒ³è¦è¿™äº›ç¨‹åºæ­£å¸¸çš„æ‰§è¡Œä¸€å®šå°†ç‚¹å‡»äº‹ä»¶å’Œä¸€ä¸ªå¤„ç†å™¨ç»‘å®šï¼Œå½“ç”¨æˆ·ç‚¹å‡»æŸä¸ªbuttonå°±ä¼šè§¦å‘æ‰§è¡Œç‰¹å®šHandlerã€‚æˆ‘ä»¬çš„webå‰ç«¯äº¤äº’ä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œåªä¸è¿‡è¿™äº›æ“ä½œå‰ç«¯å¸®æˆ‘ä»¬å¤„ç†äº†ï¼Œç„¶åå‰ç«¯ç›´æ¥è§¦å‘å¯¹åº”çš„æ¥å£é€»è¾‘ã€‚æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾å±•ç¤ºï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210919154652.png"></p><p>äº‹ä»¶é©±åŠ¨ç›¸è¾ƒäºå…¶ä»–çš„ä¸€äº›æ–¹å¼æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚<strong>é€šå¸¸æ¥è¯´ä¸€æ®µé€»è¾‘çš„æ‰§è¡Œç”±æŸä¸ªäº‹ä»¶è§¦å‘ã€‚è¿™æ„å‘³ç€æ›´å°‘çš„èµ„æºæ¶ˆè€—ï¼Œå¹¶ä¸éœ€è¦å¯¹äºæ¯ä¸ªå®¢æˆ·ç«¯éƒ½ç”¨ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œçº¿ç¨‹èµ„æºå¯ä»¥æ± åŒ–å…¬ç”¨</strong>ï¼Œ<strong>åŒæ—¶ä¹Ÿä¼šç”±æ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œæ›´å°‘çš„é”</strong>ã€‚å¦‚æœåŸºäºè¿™æ ·çš„è®¾è®¡å°±éœ€è¦æ·»åŠ ä¸€ä¸ªdispatcherï¼Œä½¿ç”¨dispatcherå°†äº‹ä»¶åˆ†æ´¾åˆ°å¯¹åº”çš„handlerï¼Œä½†æ˜¯dispatcherå¯èƒ½æˆä¸ºæ€§èƒ½çš„ç“¶é¢ˆï¼Œå› ä¸ºæ¯ä¸ªè¿æ¥éƒ½éœ€è¦é€šè¿‡è¿™é‡Œåˆ†æ´¾åˆ°å¯¹åº”çš„å¤„ç†å™¨å¤„ç†ï¼Œè¿™ä¸ªéƒ¨åˆ†è¿˜éœ€è¦å¼€æ”¾äº‹ä»¶å’Œhandlerçš„ç»‘å®šï¼Œå¯ä»¥åœ¨é¡¹ç›®å¯åŠ¨æ—¶æˆ–ç¨‹åºè¿è¡ŒæœŸé—´è¿›è¡Œäº‹ä»¶å’Œhandlerçš„ç»‘å®šã€‚</p><h2 id="Reactorå•çº¿ç¨‹æ¨¡å‹"><a href="#Reactorå•çº¿ç¨‹æ¨¡å‹" class="headerlink" title="Reactorå•çº¿ç¨‹æ¨¡å‹"></a>Reactorå•çº¿ç¨‹æ¨¡å‹</h2><p>æˆ‘ä»¬çš„æ¨¡å‹å¹¶æ²¡æœ‰ç›´æ¥é‡‡ç”¨è¿™ç§æ¨¡å¼è€Œæ˜¯ä½¿ç”¨äº†å“åº”ï¼ˆReactorï¼‰æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸çš„æåˆ°çš„Nettyçš„Reactoræ¨¡å‹ã€‚Reactorå’Œæˆ‘ä»¬çš„å“åº”å¼è¿˜æ˜¯å¾ˆç›¸ä¼¼çš„ï¼Œé¦–å…ˆæ˜¯<strong>äº‹ä»¶é©±åŠ¨ï¼Œæœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¹¶å‘è¾“å…¥æºï¼Œæœ‰ä¸€ä¸ªService Handlerå’Œå¤šä¸ªEventHandlersã€‚è¿™ä¸ªService Handlerä¼šåŒæ­¥çš„å°†è¾“å…¥çš„è¯·æ±‚å¤šè·¯å¤ç”¨å¹¶åˆ†å‘ç»™ç›¸åº”çš„EventHandlerã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210919172031.png"></p><p>ä¸Šé¢è¿™ä¸ªç‰ˆæœ¬æ˜¯Reactorçš„å•çº¿ç¨‹ç‰ˆæœ¬ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šacceptoråï¼Œç„¶ååˆ†æ´¾ç»™å¯¹åº”çš„Handlerå¤„ç†æ‰§è¡Œã€‚ä½†æ˜¯ä¸€ä¸ªè¿æ¥è¿æ¥ä¸Šacceptorä¹‹åï¼Œæ‰€æœ‰çš„I/Oæ“ä½œéƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šå®Œæˆï¼Œæ­¤æ—¶çº¿ç¨‹èŒè´£åŒ…æ‹¬ï¼š<strong>æ¥æ”¶æ–°è¿æ¥è¯·æ±‚ã€è¯»å†™æ“ä½œ</strong>ç­‰ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸Šåï¼Œ<strong>åœ¨å¤„ç†å®Œæˆsendä¹‹å‰ï¼Œacceptoréƒ½å¤„äºé˜»å¡çŠ¶æ€</strong>ï¼Œè¿™æå¤§çš„å½±å“äº†Reactorçš„æ•´ä½“æ€§èƒ½ã€‚ä¾æ®è¿™ä¸ªé€»è¾‘æˆ‘ä»¬Nettyæ„å»ºå‡ºæ¥çš„Reactoræ¨¡å‹å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921105854.png"></p><p>Nettyå¯¹äºè¿™ç§æ¨¡å¼çš„ç¼–ç å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">EventLoopGroup eventGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup(<span class="hljs-number">1</span>);<br>ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>serverBootstrap.group(eventGroup);<br></code></pre></td></tr></table></figure><h2 id="Reactorå¤šçº¿ç¨‹æ¨¡å‹"><a href="#Reactorå¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="Reactorå¤šçº¿ç¨‹æ¨¡å‹"></a>Reactorå¤šçº¿ç¨‹æ¨¡å‹</h2><p>Reactorå¤šçº¿ç¨‹æ¨¡å‹å’ŒReactorå•çº¿ç¨‹æ¨¡å‹çš„åŒºåˆ«å°±åœ¨äº<strong>å¤„ç†è¿æ¥çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œå¤„ç†å…·ä½“ä¸šåŠ¡é€»è¾‘æ˜¯å¦å¤–ä¸€ç»„çº¿ç¨‹</strong>ï¼Œè¿™æ ·çš„å¥½å¤„å°±æ˜¯ï¼Œ<strong>ä¸€ä¸ªè¿æ¥acceptoråŒæ—¶å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥äº‹ä»¶</strong>ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210919194246.png"></p><p>Reactorå¤šçº¿ç¨‹æ¨¡å‹åœ¨ç»å¤§å¤šæ•°åœºæ™¯ä¸‹éƒ½èƒ½æ»¡è¶³æ€§èƒ½éœ€æ±‚ã€‚ä½†æ˜¯è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œ<strong>åªæœ‰ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£ç›‘å¬å’Œå¤„ç†æ‰€æœ‰çš„å®¢æˆ·ç«¯è¿æ¥</strong>ã€‚å¦‚æœé‡åˆ°è¿æ¥é£æš´ï¼Œä¸€ä¸ªçº¿ç¨‹æ˜¯å¾ˆæœ‰å¯èƒ½æ‰›ä¸ä½çš„ã€‚åŒæ—¶é€šè¿‡æˆ‘ä»¬å‰é¢ä»‹ç»è¿‡çš„TCPä¸‰æ¬¡æ¡æ‰‹ï¼Œä¸€ä¸ªè¿æ¥çš„èƒŒåä¼šæœ‰å¤šæ¬¡çš„æ¡æ‰‹äº¤äº’ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹çš„Reactorçš„å‹åŠ›è¿˜æ˜¯å¾ˆå¤§çš„ã€‚Nettyçš„Reactorå¤šçº¿ç¨‹æ¨¡å‹å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921121722.png"></p><p>Nettyå¯¹äºReactorå¤šçº¿ç¨‹ç‰ˆæœ¬çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">EventLoopGroup eventGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>serverBootstrap.group(eventGroup);<br></code></pre></td></tr></table></figure><p><strong>åœ¨è¿æ¥äº†å¾ˆå¤šçš„å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªacceptorçº¿ç¨‹å¯èƒ½ä¼šæˆä¸ºæ•´ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆã€‚</strong>ä¸ºäº†è§£å†³è¿™ä¸ªæ½œåœ¨çš„æ€§èƒ½é—®é¢˜ï¼Œåˆæœ‰äº†ä¸‹é¢çš„ç¬¬ä¸‰ç§Reactoræ¨¡å‹ã€‚</p><h2 id="Reactorä¸»ä»å¤šçº¿ç¨‹æ¨¡å¼"><a href="#Reactorä¸»ä»å¤šçº¿ç¨‹æ¨¡å¼" class="headerlink" title="Reactorä¸»ä»å¤šçº¿ç¨‹æ¨¡å¼"></a>Reactorä¸»ä»å¤šçº¿ç¨‹æ¨¡å¼</h2><p>Reactorä¸»ä»å¤šçº¿ç¨‹æ¨¡å¼çš„ç‰¹ç‚¹æ˜¯ï¼Œ<strong>æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯çš„è¿æ¥ä¸å†æ˜¯ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹ï¼Œè€Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹æ± </strong>ã€‚acceptoræ¥æ”¶åˆ°å®¢æˆ·ç«¯TCPè¿æ¥è¯·æ±‚å¹¶å¤„ç†å®Œæˆåï¼ˆè¿™é‡Œçš„å¤„ç†åŒ…æ‹¬æ¡æ‰‹ã€è®¤è¯ç­‰æ“ä½œï¼‰ï¼Œä¸€æ—¦é“¾è·¯å»ºç«‹æˆåŠŸï¼Œå°±å°†é“¾è·¯æ³¨å†Œåˆ°åç«¯çš„ subReactorçº¿ç¨‹æ± I/Oçº¿ç¨‹ä¸Šï¼Œç”±I/Oçº¿ç¨‹è´Ÿè´£åç»­çš„æ“ä½œã€‚ä¸€ä¸‹å°±æ˜¯è¿™ä¸ªæ¨¡å‹çš„ç¤ºæ„å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210920004557.png"></p><p>åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„çº¿ç¨‹æ¨¡å‹æ¼”å˜åˆ°æœ€ç»ˆçš„ä¸»ä»Reactoræ¨¡å¼ï¼Œåˆ†ä¸ºä¸¤ä¸ªReactorï¼Œ<strong>ç¬¬ä¸€ä¸ªReactorå¤„ç†è¿æ¥æœ‰å…³çš„æ“ä½œï¼Œè€Œç¬¬äºŒä¸ªReactorè´Ÿè´£å¤„ç†ä¸šåŠ¡æœ‰å…³çš„æ“ä½œ</strong>ã€‚å½“è¿æ¥å¾ˆå¤šå®¢æˆ·ç«¯æ—¶å€™ï¼Œæ•´ä¸ªè¿æ¥å‹åŠ›è¢«å‡åŒ€çš„åˆ†æ‘Šåˆ°mainReactorçš„å¤šä¸ªçº¿ç¨‹ä¸Šï¼Œå†é…åˆsubReactorå°†ä¸šåŠ¡å¤„ç†åˆ†å‘åˆ°å„ä¸ªworkerçº¿ç¨‹ä¸Šï¼Œä½¿å¾—æ•´ä¸ªæ¨¡å‹åœ¨æ¯”è¾ƒé«˜çš„è´Ÿè½½ä¸‹ä¾æ—§æœ‰å¾ˆé«˜çš„æ€§èƒ½è¡¨ç°ã€‚å¹¶ä¸”æ˜¯å¯ä»¥é€šè¿‡æå‡æœºå™¨æ€§èƒ½æ¥æå‡æ•´ä½“æœåŠ¡çš„æ€§èƒ½ï¼Œå¯æ ¹æ®å®é™…éœ€è¦æ¥é…ç½®åˆé€‚çš„æ€§èƒ½èŒƒå›´ã€‚æŒ‰ç…§è¿™ä¸ªæ¨¡å‹å»ºç«‹çš„Nettyæ¨¡å‹å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921124236.png"></p><p>Nettyå¯¹ä¸Šé¢ä¸»ä»çš„Reactoræ¨¡å¼çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>EventLoopGroup workGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>ServerBootstrap serverBootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>serverBootstrap.group(bossGroup, workerGroup);<br></code></pre></td></tr></table></figure><h1 id="å¿«é€Ÿå¼€å§‹"><a href="#å¿«é€Ÿå¼€å§‹" class="headerlink" title="å¿«é€Ÿå¼€å§‹"></a>å¿«é€Ÿå¼€å§‹</h1><p>åœ¨æ¢³ç†è¿‡å‰é¢çš„æ¨¡å‹ä¹‹åï¼Œæˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•çš„Demoï¼Œå¿«é€Ÿä¸Šæ‰‹Nettyã€‚è¿™æ¬¡æˆ‘ä»¬å†™ä¸€ä¸ªå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯äº’ç›¸è¯´Helloçš„ç¨‹åºï¼Œä»£ç ç›¸è¾ƒäºSockeç¨‹åºä¼šæœ‰æœ‰ç‚¹é•¿ï¼Œè¦è€å¿ƒçœ‹å®Œï½ã€‚ä½¿ç”¨çš„Nettyç‰ˆæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.netty<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>netty-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.1.51.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>æœåŠ¡ç«¯çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8801</span>;<br>        EventLoopGroup bossGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        EventLoopGroup workGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerBootstrap bootstrap = <span class="hljs-keyword">new</span> ServerBootstrap();<br>            bootstrap.group(bossGroup, workGroup)<br>                    .channel(NioServerSocketChannel.class)<br>                    .option(ChannelOption.SO_BACKLOG, <span class="hljs-number">512</span>)<br>                    .childOption(ChannelOption.SO_KEEPALIVE, <span class="hljs-keyword">true</span>)<br>                    .childHandler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                            ch.pipeline().addLast(<span class="hljs-keyword">new</span> HelloHandler());<br>                        &#125;<br>                    &#125;);<br>            ChannelFuture future = bootstrap.bind(port).sync();<br>            System.out.println(<span class="hljs-string">&quot;æœåŠ¡å¯åŠ¨å®Œæˆ, ç›‘å¬ 127.0.0.1:&quot;</span> + port);<br>            future.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * helloHandler å¤„ç†å™¨</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ä»channelä¸­è¯»æ•°æ®ã€‚æ‰§è¡Œä¸€äº›ä¸šåŠ¡æ“ä½œï¼Œæˆ–è€…åŠ å…¥ä¸€äº›hookè§¦å‘åç»­ä¸šåŠ¡ã€‚</span><br><span class="hljs-comment">     * åŒæ—¶å¯ä»¥é€šè¿‡channelå‘é€æ•°æ®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg ä»channelä¸­è¯»åˆ°çš„æ•°æ®</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ByteBuf byteBuf = (ByteBuf) msg;<br>        System.out.println(<span class="hljs-string">&quot;message[&quot;</span>+ byteBuf.toString(StandardCharsets.UTF_8) +<span class="hljs-string">&quot;] receivedï¼hello there and &quot;</span> +<br>                <span class="hljs-string">&quot;message is from [&quot;</span> + ctx.channel().remoteAddress().toString() + <span class="hljs-string">&quot;]&quot;</span>);<br>        ByteBuf toClientMsg = Unpooled.copiedBuffer( <span class="hljs-string">&quot;hello!&quot;</span>.getBytes(StandardCharsets.UTF_8));<br>        ctx.channel().writeAndFlush(toClientMsg);<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åœ¨å¤„ç†è¿‡ç¨‹ä¸­æ•æ‰åˆ°äº†å¼‚å¸¸æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œè¾“å‡ºå¼‚å¸¸ï¼Œå…³é—­èµ„æº</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx ä¸Šä¸‹æ–‡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> cause å¼‚å¸¸ä¿¡æ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ctx.close();<br>        <span class="hljs-keyword">super</span>.exceptionCaught(ctx, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/21</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NettyClient</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        String host = <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8801</span>;<br>        NioEventLoopGroup eventLoopGroup = <span class="hljs-keyword">new</span> NioEventLoopGroup();<br>        <span class="hljs-keyword">try</span> &#123;<br>            Bootstrap bootstrap = <span class="hljs-keyword">new</span> Bootstrap();<br>            bootstrap.group(eventLoopGroup).channel(NioSocketChannel.class)<br>                    .handler(<span class="hljs-keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>                    ch.pipeline().addLast(<span class="hljs-keyword">new</span> ClientHelloHandler());<br>                &#125;<br>            &#125;);<br>            ChannelFuture channelFuture = bootstrap.connect(host, port).sync();<br>            channelFuture.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            eventLoopGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * å®¢æˆ·ç«¯çš„ChannelHandler</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClientHelloHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChannelInboundHandlerAdapter</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ByteBuf buf = (ByteBuf) msg;<br>        System.out.println(<span class="hljs-string">&quot;receive message [&quot;</span> + buf.toString(StandardCharsets.UTF_8) + <span class="hljs-string">&quot;] from server!&quot;</span>);<br>    ctx.close();<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * å½“æœ‰channelè¿æ¥ä¸Šå‘é€æ¶ˆæ¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> ctx</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        ctx.writeAndFlush(Unpooled.copiedBuffer(<span class="hljs-string">&quot;hello server!&quot;</span>.getBytes(StandardCharsets.UTF_8)));<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        cause.printStackTrace();<br>        <span class="hljs-keyword">super</span>.exceptionCaught(ctx, cause);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">Serverç«¯è¾“å‡ºï¼š</span><br><span class="hljs-string">æœåŠ¡å¯åŠ¨å®Œæˆ,</span> <span class="hljs-string">ç›‘å¬</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8801</span><br><span class="hljs-string">message[hello</span> <span class="hljs-string">server!]</span> <span class="hljs-string">receivedï¼and</span> <span class="hljs-string">message</span> <span class="hljs-string">is</span> <span class="hljs-string">from</span> [<span class="hljs-string">/127.0.0.1:55370</span>]<br><span class="hljs-meta">---</span><br><span class="hljs-string">Clientç«¯è¾“å‡ºï¼š</span><br><span class="hljs-string">receive</span> <span class="hljs-string">message</span> [<span class="hljs-string">hello!</span>] <span class="hljs-string">from</span> <span class="hljs-string">server!</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯æœ€åŸºç¡€çš„ä¸€ä¸ªå…¥é—¨çš„demoï¼Œä½†æ˜¯ç›¸æ¯”äºSocketè¿˜æ˜¯å¤æ‚äº†ä¸å°‘ğŸ˜‚ã€‚å…ˆå¯åŠ¨æœåŠ¡ç«¯å¯åŠ¨å¹¶ç›‘å¬8801ç«¯å£ï¼ŒæœåŠ¡ç«¯å¯åŠ¨åè¾“å‡ºæ—¥å¿—ä¿¡æ¯â€œæœåŠ¡å¯åŠ¨å®Œæˆ, ç›‘å¬ç«¯å£ 127.0.0.1:8801â€ã€‚éšåæˆ‘ä»¬å¯åŠ¨å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯è¿æ¥127.0.0.1:8081ï¼Œéšåè¿æ¥æˆåŠŸåï¼Œå®¢æˆ·ç«¯çš„Nettyå›è°ƒ<code>channelActive</code>è¿™ä¸ªæ–¹æ³•ï¼Œç„¶åå®¢æˆ·ç«¯å‘é€ä¸€ä¸ªâ€œhello serverâ€æ¶ˆæ¯ã€‚ç„¶åæœåŠ¡ç«¯æ¥æ”¶åˆ°æ¶ˆæ¯å¹¶å°†ä¿¡æ¯è¾“å‡ºåˆ°consoleï¼Œç„¶åæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯â€œhelloâ€ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œå°†æ¶ˆæ¯è¾“å…¥åˆ°consoleå¹¶å…³é—­channelæ–­å¼€è¿æ¥ã€‚</p><h1 id="ç»„ä»¶å’Œè¿è¡Œæµç¨‹ä»‹ç»"><a href="#ç»„ä»¶å’Œè¿è¡Œæµç¨‹ä»‹ç»" class="headerlink" title="ç»„ä»¶å’Œè¿è¡Œæµç¨‹ä»‹ç»"></a>ç»„ä»¶å’Œè¿è¡Œæµç¨‹ä»‹ç»</h1><p>å¯¹äºæ¥è§¦è¿‡Nettyçš„åŒå­¦ï¼Œä¸Šé¢çš„ä¾‹å­ä¼šæ„Ÿè§‰éå¸¸ç®€å•ï¼Œæ²¡æœ‰æ¥è§¦è¿‡Nettyçš„å°ä¼™ä¼´æ¥è¯´ï¼Œè¿™ä¸ªDemoæ¥è§¦ä¸‹æ¥è¿˜æ˜¯æœ‰ä¸€äº›éš¾åº¦çš„ï¼Œå°¤å…¶ä¸€äº›é™Œç”Ÿçš„ç±»ã€‚è¿™äº›é™Œç”Ÿçš„ç±»éƒ½æ˜¯Nettyçš„æ ¸å¿ƒç»„ä»¶ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä»‹ç»è¿™äº›ç»„ä»¶çš„åŸºæœ¬åŠŸèƒ½å’ŒNettyçš„è¿è¡Œæµç¨‹ã€‚</p><h2 id="åŸºæœ¬ç»„ä»¶"><a href="#åŸºæœ¬ç»„ä»¶" class="headerlink" title="åŸºæœ¬ç»„ä»¶"></a>åŸºæœ¬ç»„ä»¶</h2><p>å…¶ä¸­æˆ‘ä»¬çš„æ ¸å¿ƒç»„ä»¶åŒ…æ‹¬<code>EventLoop</code>ã€<code>Bootstrap&amp;ServerBootstrap</code>ã€<code>Channel</code>ã€<code>ChannelHandler</code>ã€<code>ChannelPipeline</code>ã€<code>ChannelFuture</code>ç­‰ã€‚è¿™äº›æ ¸å¿ƒç»„ä»¶æ”¯æ’‘èµ·äº†NettyåŸºæœ¬çš„ä¸»ä»Reactorç»“æ„ã€‚</p><ul><li><p><strong>EventLoop</strong>ï¼š<strong>EventLoopç”¨äºå¤„ç†Channelçš„I/Oæ“ä½œ</strong>ã€‚ä¸€ä¸ªå•ä¸€çš„<code>EventLoop</code>é€šå¸¸ä¼šå¤„ç†å¤šä¸ª<code>Channel</code>äº‹ä»¶ã€‚ä¸€ä¸ª<code>EventLoopGroup</code>å¯ä»¥å«æœ‰å¤šäºä¸€ä¸ª<code>EventLoop</code>å’Œæä¾›äº†ä¸€ç§è¿­ä»£ç”¨äºæ£€ç´¢æ¸…å•ä¸­çš„ä¸‹ä¸€ä¸ªã€‚</p></li><li><p><strong>Bootstrap&amp;ServerBootstrap</strong>ï¼š<strong>Nettyåº”ç”¨ç¨‹åºé€šè¿‡è®¾ç½®</strong><code>bootstrap</code><strong>å¼•å¯¼ç±»æ¥å®Œæˆï¼Œè¯¥ç±»æä¾›äº†ä¸€ä¸ªç”¨äºåº”ç”¨ç½‘ç»œé…ç½®çš„å®¹å™¨</strong>ã€‚BootstrapæœåŠ¡ç«¯çš„æ˜¯<code>ServerBootstrap</code>ï¼Œå®¢æˆ·ç«¯æ˜¯<code>Bootstrap</code>ã€‚</p></li><li><p><strong>Channel</strong>ï¼šNettyä¸­çš„æ¥å£ Channel å®šä¹‰äº†ä¸ socket ä¸°å¯Œçš„äº¤äº’çš„æ“ä½œé›†ï¼š<code>bind</code>ï¼Œ<code>close</code>ï¼Œ<code>config</code>ï¼Œ<code>connect</code>ï¼Œ<code>isActive</code>ï¼Œ<code>isOpen</code>ï¼Œ<code>isWritable</code>ï¼Œ<code>read</code>ï¼Œ<code>write</code>ç­‰ç­‰ã€‚</p></li><li><p><strong>ChannelHandler</strong>ï¼š<strong>ChannelHandler æ”¯æŒéå¸¸å¤šçš„åè®®ï¼Œå¹¶ä¸”æä¾›ç”¨äºæ•°æ®å¤„ç†çš„å®¹å™¨ï¼ŒChannelHandlerä¸­çš„æ–¹æ³•ç”±ç‰¹å®šçš„äº‹ä»¶è§¦å‘</strong>ï¼Œå¸¸ç”¨çš„ä¸€ä¸ªæ¥å£æ˜¯<code>ChannelInboundHandler</code>ï¼Œè¯¥ç±»å‹ä¸»è¦æ–¹æ³•å…¥ç«™è¯»æ•°æ®ï¼ˆsocketè¯»äº‹ä»¶ï¼‰ã€‚</p></li><li><p><strong>ChannelPipeline</strong>ï¼š<strong>ChannelPipelineæä¾›äº†ä¸€ä¸ªå®¹å™¨ç»™ChannelHandleré“¾å¹¶æä¾›äº†ä¸€ä¸ªAPIè°ƒç”¨ï¼Œç”¨äºç®¡ç†æ²¿ç€é“¾å…¥ç«™å’Œå‡ºç«™äº‹ä»¶çš„æµåŠ¨</strong>ã€‚æ¯ä¸ªChanneléƒ½æœ‰è‡ªå·±çš„ChannelPipelineï¼Œå½“Channelåˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»ºçš„ã€‚ä¸‹å›¾å³å¯è¯´æ˜ä¸¤è€…çš„å…³ç³»ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921211125.png"></p></li><li><p><strong>ChannelFuture</strong>ï¼š<strong>Netty æ‰€æœ‰çš„I/Oæ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„</strong>ã€‚å› ä¸ºä¸€ä¸ªæ“ä½œå¯èƒ½æ— æ³•ç«‹å³è¿”å›ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ–¹æ³•åœ¨ä»¥åè·å–ä»–çš„ç»“æœï¼Œå‡ºäºè¿™ä¸ªç›®çš„ï¼ŒNettyæä¾›äº†æ¥å£<code>ChannelFuture</code>çš„<code>addListener</code>æ–¹æ³•ã€‚</p></li></ul><p>Nettyæ˜¯ä¸€ä¸ªéé˜»å¡ã€äº‹ä»¶é©±åŠ¨çš„ç½‘ç»œæ¡†æ¶ã€‚Nettyå®é™…ä¸Šæ˜¯ä½¿ç”¨Threadsï¼ˆå¤šçº¿ç¨‹ï¼‰å¤„ç†I/Oäº‹ä»¶çš„ï¼Œå¯¹äºç†Ÿæ‚‰å¤šçº¿ç¨‹ç¼–ç¨‹å¯èƒ½éœ€è¦å…³æ³¨ä»£ç åŒæ­¥ã€‚ä½†æ˜¯è¿™æ ·å¹¶ä¸å¥½ï¼ŒåŒæ­¥ä¼šä¸¥é‡å½±å“åˆ°ç¨‹åºçš„æ€§èƒ½ï¼Œçº¿ç¨‹é—´çš„åŒæ­¥æ“ä½œä¹Ÿå®¹æ˜“äº§ç”Ÿbugã€‚Nettyçš„è®¾è®¡ä¿è¯äº†å¤„ç†äº‹ä»¶ä¸ä¼šåˆåŒæ­¥ï¼Œå› ä¸ºå¤„ç†æŸä¸ªChanneläº‹ä»¶æ˜¯è¢«æ·»åŠ åˆ°ä¸€ä¸ªEventLoopä¸­çš„ï¼Œä»¥åè¯¥Channeläº‹ä»¶éƒ½æ˜¯ç”±è¯¥EventLoopçš„çº¿ç¨‹å¤„ç†ï¼Œå¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä¹‹é—´èµ„æºæ˜¯éš”ç¦»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´Nettyä¸éœ€è¦è¿›è¡Œçº¿ç¨‹é—´çš„åŒæ­¥èµ„æºç«äº‰æ“ä½œã€‚EventLoopåœ¨EventLoopGroupä¸­ï¼Œä»–ä»¬çš„å…³ç³»å¯ä»¥ç†è§£ä¸ºçº¿ç¨‹å’Œçº¿ç¨‹æ± çš„å…³ç³»ã€‚</p><h2 id="è¿è¡Œæµç¨‹åˆ†æ"><a href="#è¿è¡Œæµç¨‹åˆ†æ" class="headerlink" title="è¿è¡Œæµç¨‹åˆ†æ"></a>è¿è¡Œæµç¨‹åˆ†æ</h2><p>æˆ‘ä»¬æ¢³ç†å®Œæ ¸å¿ƒç»„ä»¶ä¹‹åï¼Œåœ¨çœ‹å‰é¢çš„ä»£ç å°±æ¸…æ™°å¾ˆå¤šäº†ï¼Œæˆ‘ä»¬ä¸Šé¢åˆ—ä¸¾çš„æ ¸å¿ƒç»„ä»¶ä¹ŸåŸºæœ¬åœ¨ä»£ç ä¸­éƒ½æœ‰ä½¿ç”¨ã€‚ä»–ä»¬é€šè¿‡ServerBootstrapè”ç³»åœ¨ä¸€èµ·ï¼Œé€šè¿‡<code>Group()</code>æ–¹æ³•å°†ä¸¤ä¸ª<code>EventLoopGroup</code>å®ä¾‹ï¼ˆNioEventLoopGroupï¼‰ç»„æˆä¸»ä»Reactorï¼Œç„¶åä½¿ç”¨<code>option()</code>æ–¹æ³•é…ç½®å¯è°ƒå‚æ•°ï¼Œä½¿ç”¨<code>channel()</code>å‡½æ•°æŒ‡å®šç›‘å¬çš„SocketChannelç±»å‹ã€‚éšåä½¿ç”¨<code>childChannel(new ChannelInitializer&lt;&gt;&#123;...&#125;)</code> æ„é€ å‡ºåç»­çš„<code>Pipeline</code>ã€<code>channelHandler</code>ç­‰ã€‚<strong>é»˜è®¤æƒ…å†µä¸‹æ¯æœ‰ä¸€ä¸ªè¿æ¥åˆ›å»ºï¼Œè¿™ä¸ªéƒ¨åˆ†éƒ½ä¼šåˆ›å»ºä¸€æ¬¡</strong>ã€‚æœ€åå°†æ•´ä¸ªæœåŠ¡ç»‘å®šåœ¨æŸä¸ªç›‘å¬ç«¯å£ï¼Œç„¶åè¿”å›ä¸€ä¸ª<code>ChannelFuture</code>å¯¹è±¡ã€‚è¿™ä¸ªæœåŠ¡ç«¯å°±ç®—æ˜¯å¯åŠ¨å®Œæ¯•ã€‚å› ä¸ºEventLoopGroupæœ¬è´¨ä¸Šæ˜¯ä¸ªçº¿ç¨‹æ± ï¼Œæ‰€ä»¥æœ€åè¦ä¼˜é›…çš„å…³é—­å›æ”¶èµ„æºå³<code>shutdwonGracefully()</code>ï¼Œä»¥ä¸‹è¿™å¼ å›¾æ˜¯Serverç«¯çš„Nettyä¸»ä»Reactorçš„å·¥ä½œç¤ºæ„å›¾ã€‚</p><blockquote><p>ServerSocketChannelï¼ŒSocketChannelä¹‹é—´çš„å…³ç³»å’ŒServerSocketä¸Socketä¹‹é—´çš„å…³ç³»ç±»ä¼¼ã€‚ </p></blockquote><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210921223233.png"></p><p>æ•´ä¸ªå·¥ä½œæè¿°å¦‚ä¸‹ï¼š</p><ol><li>NettyæŠ½è±¡å‡ºä¸¤ç»„çº¿ç¨‹æ± ï¼Œ<strong>BossGroup ä¸“é—¨è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥ï¼ŒworkerGroup ä¸“é—¨è´Ÿè´£ç½‘ç»œçš„è¯»å†™</strong>ã€‚ä»–ä»¬çš„ç±»å‹éƒ½æ˜¯NioEventLoopGroupã€‚</li><li>NioEventLoopGroupç›¸å½“äºä¸€ä¸ª<strong>äº‹ä»¶å¾ªç¯ç»„ï¼Œè¿™ä¸ªç»„ä¸­åŒ…å«äº†å¾ˆå¤šä¸ªäº‹ä»¶å¾ªç¯</strong>ï¼Œæ¯ä¸ªäº‹ä»¶å¾ªç¯æ˜¯NioEventLoopã€‚</li><li>NioEventLoopæ ‡è¯†ä¸€ä¸ªä¸æ–­å¾ªç¯çš„æ‰§è¡Œå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œ<strong>æ¯ä¸ªNioEventLoopéƒ½æœ‰ä¸€ä¸ªselectorï¼Œç”¨äºç›‘å¬ç»‘å®šåœ¨å…¶ä¸Šçš„socketç½‘ç»œé€šä¿¡</strong>ã€‚</li><li>NioEventLoopGroupå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå³åŒ…å«å¤šä¸ªNioEventLoopã€‚</li><li>æ¯ä¸ªBossNioEventLoopå¾ªç¯çš„æ­¥éª¤åˆ†ä¸º3æ­¥ï¼š<ol><li><strong>è½®è¯¢acceptäº‹ä»¶</strong>ã€‚</li><li><strong>å¤„ç†acceptäº‹ä»¶ï¼Œä¸clientå»ºç«‹è¿æ¥ï¼Œç”ŸæˆNioSocketChannelï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°æŸä¸ªworker NioEventLoopä¸Šçš„selectorã€‚</strong></li><li><strong>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³runAllTasksã€‚</strong></li></ol></li><li>æ¯ä¸ªWorkerNioEventLoopå¾ªç¯æ‰§è¡Œçš„æ­¥éª¤ï¼š<ol><li><strong>è½®è¯¢read/writeäº‹ä»¶ã€‚</strong></li><li><strong>å¤„ç†I/Oäº‹ä»¶ï¼Œå³read/writeäº‹ä»¶ï¼Œåœ¨å¯¹åº”NioSocketChannelå¤„ç†ã€‚</strong></li><li><strong>å¤„ç†ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œå³runAllTasksã€‚</strong></li></ol></li><li><strong>æ¯ä¸ªworker NIOEventLoopå¤„ç†ä¸šåŠ¡ä¼šä½¿ç”¨pipelineï¼Œpipelineä¸­åŒ…å«äº†channel</strong>ï¼Œå³é€šè¿‡pipelineå¯ä»¥è·å–åˆ°å¯¹åº”çš„é€šé“ï¼Œç®¡é“ä¸­ç»´æŠ¤äº†å¾ˆå¤šçš„å¤„ç†å™¨ã€‚</li></ol><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬å…ˆæŠ›å‡ºäº†ä¸€ä¸ªç–‘é—®ï¼Ÿä¸ºä»€ä¹ˆæ˜¯Nettyï¼Œéšåæˆ‘ä»¬æ¢³ç†äº†Nettyçš„ä¼˜ç‚¹å’ŒJava NIO çš„ç¼ºç‚¹ï¼Œæ€»ç»“å¾—å‡ºå¥½ç”¨å¼ºå¤§ä¸”æ‹“å±•æ€§é«˜çš„Nettyæ˜¯æˆ‘ä»¬é¦–é€‰çš„ç½‘ç»œç¼–ç¨‹å·¥å…·è¿™ä¸€ç»“è®ºã€‚éšåæˆ‘ä»¬ä»‹ç»äº†Nettyçš„æ¨¡å‹çš„æ¼”è¿›ï¼Œè¿™ä¸€éƒ¨åˆ†æˆ‘ä»¬ä¸€èµ·é¡ºç€Doug Leeåœ¨ã€ŠScalable IO in Javaã€‹ä¸­çš„è§‚ç‚¹ï¼ŒæŠŠNettyçš„æ¨¡å‹æ¢³ç†äº†ä¸€è¾¹ã€‚ä¸€å¼€å§‹æˆ‘ä»¬æ˜¯ä¸€ä¸ªç®€å•çš„å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ä¸€ä¸ªServerï¼Œç„¶åServerè°ƒç”¨ä¸€ä¸ªåŒ…å«è¯»å–å‘é€ï¼Œç¼–è§£ç å’Œä¸šåŠ¡å¤„ç†çš„è°ƒç”¨é“¾ã€‚å¾ˆæ˜æ˜¾è¿™ä¸ªç»“æ„ä¸å…·å¤‡é«˜å¯ç”¨æ€§å’Œé«˜æ‹“å±•æ€§ã€‚å…¶å®æˆ‘ä»¬çš„ç½‘ç»œç¨‹åºå’ŒJava AWTç¨‹åºæœ‰å¼‚æ›²åŒå·¥ä¹‹å¤„ï¼Œä»–ä»¬éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ã€‚åŸºäºäº‹ä»¶é©±åŠ¨æ•´ä½“å¯ä»¥è·å¾—æ›´é«˜çš„æ•ˆç‡ï¼Œæ›´å°‘çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯ç¼–ç ä¼šç›¸è¾ƒå˜å¾—ç¨å¤æ‚ä¸€äº›ã€‚Reactorçš„å•çº¿ç¨‹ç‰ˆæœ¬å‡ºç°äº†ï¼Œè¿™ä¸ªç‰ˆæœ¬å½“ä¸€ä¸ªacceptorç›‘å¬åˆ°æœåŠ¡åï¼Œdispatcherå†å°†ä»»åŠ¡åˆ†æ´¾ç»™å¯¹åº”çš„å¤„ç†æµç¨‹è¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªæ¨¡å‹å­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¤„ç†è¿‡ç¨‹ä»å§‹è‡³ç»ˆéƒ½æ˜¯å•çº¿ç¨‹çš„ï¼Œåœ¨è¿™ä¸ªè¿æ¥æœªå®Œæˆå¤„ç†ä¹‹å‰ï¼Œacceptorå§‹ç»ˆæ— æ³•å¤„ç†ä¸‹ä¸€ä¸ªè¿æ¥ã€‚æ­£å› ä¸ºå¦‚æ­¤æœ‰äº†Reactorçš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå¤šçº¿ç¨‹ç‰ˆæœ¬å’Œå•çº¿ç¨‹ç‰ˆæœ¬çš„æœ€å¤§åŒºåˆ«å°±æ˜¯å•çº¿ç¨‹åŒæ—¶åªèƒ½å¤„ç†ä¸€ä¸ªè¿æ¥ï¼Œè€Œå¤„ç†äº‹ä»¶çš„æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œä¸€ä¸ªacceptorå¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªè¿æ¥ã€‚ä½†æ˜¯é¢å¯¹æµ·é‡è¿æ¥ï¼Œä¸€ä¸ªacceptorè¿˜æ˜¯ä¼šå­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚å› æ­¤æˆ‘ä»¬å°†ä¸€ä¸ªReactoråˆ‡åˆ†å¼€æ¥ï¼Œä¸»Reactorè´Ÿè´£è¿æ¥ï¼Œä»Reactorè´Ÿè´£ä¸šåŠ¡å¤„ç†ï¼Œå¹¶ä¸”ä»–ä»¬éƒ½æ˜¯ä½¿ç”¨çº¿ç¨‹æ± è¿›è¡Œå¤„ç†ï¼Œä½¿å¾—æ•´ä½“çš„ååèƒ½åŠ›å¤§å¹…æå‡ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬Nettyå‚ç…§çš„ä¸»ä»Reactoræ¨¡å¼ã€‚æœ€åæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªNettyçš„HelloWorldï¼Œéšåæˆ‘ä»¬ä»‹ç»äº†å…¶ä¸­çš„åŸºç¡€ç»„ä»¶å’ŒNettyæ•´ä½“çš„å·¥ä½œæµç¨‹ã€‚è¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬æ²¡æœ‰æ·±å…¥æºç ç»†è®²ï¼Œå› ä¸ºä¼šæœ‰ä¸“é—¨çš„æºç åˆ†æç¯‡è¿›è¡Œè§£è¯»åˆ†æã€‚åŠ æ²¹ï¼Œæœªæ¥å¯æœŸï¼</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li><p><a href="https://blog.csdn.net/weixin_39710966/article/details/114201686">java nio epoll bug_JAVA NIOå­˜åœ¨çš„é—®é¢˜</a></p></li><li><p><a href="https://developer.aliyun.com/article/371352">Java NIOä¸­çš„é€šé“Channelï¼ˆäºŒï¼‰åˆ†æ•£/èšé›† Scatter/Gather</a></p></li><li><p><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">Scalable IO in Javaï¼ˆDoug Leaï¼‰</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?biz=MzIwNTI2ODY5OA==&mid=2649938635&idx=1&sn=fc22d218fb1529e8f4c1fcb659838d75">Netty å…¥é—¨ï¼Œè¿™ä¸€ç¯‡æ–‡ç« å°±å¤Ÿäº†</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>NIOä¸ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œç¼–ç¨‹ â€” Socketç¼–ç¨‹ä¸IOæ¨¡å‹</title>
    <link href="/2021/09/15/socket-and-io/"/>
    <url>/2021/09/15/socket-and-io/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰é¢çš„ä¸¤å°èŠ‚ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç½‘ç»œçš„åŸºç¡€çŸ¥è¯†åŒ…æ‹¬ä¸€äº›ç½‘ç»œæ¨¡å‹å’Œåè®®ã€‚æˆ‘ä»¬å¸¸è¯´Talk is cheap, show me code.è¿™ä¸€å°èŠ‚æˆ‘ä»¬å°†è§£é”Socketç½‘ç»œç¼–ç¨‹ï¼Œé€šè¿‡Socketæ¥ç¼–å†™ç®€å•ä¸€äº›ç®€å•çš„ç½‘ç»œå°ç¨‹åºã€‚æˆ‘å¾ˆæ—©ä¹‹å‰å°±æ¥è§¦è¿‡Socketç½‘ç»œç¼–ç¨‹ï¼Œä¹Ÿèƒ½å†™ä¸€äº›ç®€å•çš„ç¨‹åºï¼Œä½†æ˜¯å§‹ç»ˆæ„Ÿè§‰socketç¦»æˆ‘å¾ˆé¥è¿œï¼Œä¸æ¸…æ¥šsocketåˆ°åº•æ˜¯ä»€ä¹ˆä»¥åŠsocketæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚å¦‚æœä½ ä¹Ÿæœ‰å’Œæˆ‘ä¸€æ ·çš„ç–‘é—®ï¼Œé€šè¿‡è¿™ä¸€å°èŠ‚çš„æ¢³ç†è®©æˆ‘ä»¬ä¸€èµ·ææ‡‚socketï¼Œè§£é”socketæŠ€èƒ½ç‚¹ã€‚åœ¨ç¼–å†™å®Œsocketç¨‹åºä¹‹åï¼Œæˆ‘ä»¬è¿˜ä¼šæ€è€ƒå¦‚ä½•æé«˜æˆ‘ä»¬socketç½‘ç»œç¨‹åºçš„å¤„ç†ååé‡è¿æ¥æ•°ï¼Œå¹¶ä¸”å¼•å…¥æˆ‘ä»¬çš„IOæ¨¡å‹ï¼Œæ·±å…¥ç†è§£å‡ ç§å¸¸è§çš„IOæ¨¡å‹ã€‚</p><h1 id="ä»€ä¹ˆæ˜¯Socket"><a href="#ä»€ä¹ˆæ˜¯Socket" class="headerlink" title="ä»€ä¹ˆæ˜¯Socket"></a>ä»€ä¹ˆæ˜¯Socket</h1><p>Socketè¿™ä¸ªåå­—å¾ˆæœ‰æ„æ€ï¼Œåœ¨å¾ˆå¤šä¹¦ä¸­ç¿»è¯‘ä¸ºå¥—æ¥å­—ï¼Œæˆ‘ä»¥å‰çœ‹åˆ°å¥—æ¥å­—æ€»æ˜¯æ„Ÿè§‰å¾ˆé™Œç”Ÿéš¾ä»¥ç†è§£ã€‚Socketåœ¨è‹±è¯­ä¸­æ˜¯æ’åº§ï¼Œæ’æ§½çš„æ„æ€ã€‚æˆ‘ä»¬å†™çš„Socketè™½ç„¶æ˜¯ä»£ç ï¼Œä½†æ˜¯å¯ä»¥æƒ³è±¡æˆ<strong>æˆ‘ä»¬çš„æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ä¸­é—´æœ‰â€œä¸€æ ¹ç½‘çº¿å¹¶ä¸”ä¸¤å¤´æœ‰æ’åº§â€</strong>ã€‚æˆ‘ä»¬çš„ç¨‹åºåªè¦é€‚é…è¿™ä¸ªæ’åº§ï¼Œä¸¤ä¸ªç«¯ä¹‹é—´å°±å¯ä»¥ç›¸äº’é€šä¿¡äº†ï¼Œè€Œè¿™ä¸ªâ€œæ’åº§â€å°±æ˜¯æˆ‘ä»¬çš„Socketã€‚Socketæ˜¯åº”ç”¨å±‚ä¸TCP/IPåè®®æ—é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œå®ƒæ˜¯ä¸€ç»„æ¥å£ã€‚è¿™ä¸€å±‚åŠ å…¥åˆ°æˆ‘ä»¬çš„ç½‘ç»œæ¨¡å‹åçš„æ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210909015223.png"></p><p>åœ¨ä¸Šé¢çš„å›¾ä¸­ä¸éš¾çœ‹å‡ºSocketæ¥å£æ˜¯ä½äºä¼ è¾“å±‚ä¸Šæ–¹çš„ä¸€ä¸ªä¸­é—´å±‚ï¼Œ<strong>é€šè¿‡è¿™ä¸ªä¸­é—´å±‚æä¾›çš„æ¥å£ï¼ŒJavaåº”ç”¨å¯ä»¥è¿›è¡Œç½‘ç»œé€šä¿¡</strong>ï¼Œè¿™ä¹Ÿä½“ç°äº†â€œsocketæ’åº§â€çš„å­—é¢æ„æ€ã€‚</p><h1 id="ä»£ç ç¤ºä¾‹ä»¥åŠè°ƒç”¨è¿‡ç¨‹"><a href="#ä»£ç ç¤ºä¾‹ä»¥åŠè°ƒç”¨è¿‡ç¨‹" class="headerlink" title="ä»£ç ç¤ºä¾‹ä»¥åŠè°ƒç”¨è¿‡ç¨‹"></a>ä»£ç ç¤ºä¾‹ä»¥åŠè°ƒç”¨è¿‡ç¨‹</h1><p>æˆ‘ä»¬å¸¸è¯´talk is chepï¼Œshow me codeã€‚åœ¨è¿™ä¸ªéƒ¨åˆ†ï¼Œå°†ä½¿ç”¨Socketå®ç°ä¸€ä¸ªHTTPæœåŠ¡å™¨ï¼Œè¿˜ä¼šç”¨Scoketå®ç°ä¸€ä¸ªäº’ç›¸é€šä¿¡çš„Serverå’ŒClientã€‚ä»ä»£ç çš„è§’åº¦çœ‹çœ‹socketæ˜¯æ€ä¹ˆæ“ä½œå¯¹æ¥ä¸Šä¸‹å±‚ï¼Œåˆ†æåœ¨TCPä¸‹å’ŒUDPä¸‹Socketçš„è°ƒç”¨å¤„ç†é€»è¾‘ã€‚</p><h2 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h2><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨Socketå®ç°çš„ä¸€ä¸ªç®€å•çš„HTTPæœåŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.daiwei.socket.http;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/9</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;<br>        ServerSocket serverSocket = <span class="hljs-keyword">new</span> ServerSocket(<span class="hljs-number">8081</span>);<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            Socket socket = serverSocket.accept();<br>            service(socket);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * socket å¤„ç†æœåŠ¡</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> socket </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">service</span><span class="hljs-params">(Socket socket)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String body = <span class="hljs-string">&quot;hello socket&quot;</span>;<br>            StringBuilder response = <span class="hljs-keyword">new</span> StringBuilder();<br>            response.append(<span class="hljs-string">&quot;HTTP/1.1 200 OK\r\n&quot;</span>)<br>                    .append(<span class="hljs-string">&quot;Content-Length: &quot;</span>).append(body.getBytes().length).append(<span class="hljs-string">&quot;\r\n&quot;</span>)<br>                    .append(<span class="hljs-string">&quot;Content-Type: text/plain; charset-utf-8\r\n&quot;</span>)<br>                    .append(<span class="hljs-string">&quot;\r\n&quot;</span>)<br>                    .append(body).append(<span class="hljs-string">&quot;\r\n&quot;</span>);<br><br>            OutputStream outputStream = socket.getOutputStream();<br>            outputStream.write(response.toString().getBytes());<br>            outputStream.flush();<br><br>            socket.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨<code>wrk</code>è¿›è¡Œç®€å•çš„å‹æµ‹ï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹çš„ç»“æœã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">daiwei@daiweideMacBook-Pro ~ % wrk -t2 -c10 -d10s http://localhost:8081<br>Running 10s <span class="hljs-built_in">test</span> @ http://localhost:8081<br>  2 threads and 10 connections<br>  Thread Stats   Avg      Stdev     Max   +/- Stdev<br>    Latency     2.59ms   14.88ms 213.08ms   96.55%<br>    Req/Sec     9.91k     2.65k   11.99k    87.50%<br>  192565 requests <span class="hljs-keyword">in</span> 10.03s, 16.90MB <span class="hljs-built_in">read</span><br>  Socket errors: connect 0, <span class="hljs-built_in">read</span> 191661, write 903, timeout 0<br>Requests/sec:  19192.30<br>Transfer/sec:      1.68MB<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨Socketå®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é—´ç®€å•çš„é€šè¡Œï¼Œä»¥ä¸‹çš„ä»£ç æ˜¯å®¢æˆ·ç«¯clientå‘æœåŠ¡ç«¯serverè¿æ¥å¹¶å‘é€ä¸€æ®µmessageã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.daiwei.socket.app;<br><br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/9</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketAppServer</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> port = <span class="hljs-number">8888</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerSocket serverSocket = <span class="hljs-keyword">new</span> ServerSocket(port);<br>            System.out.println(<span class="hljs-string">&quot;server is running and listening at &quot;</span> + port);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>                Socket socket = serverSocket.accept();<br>                InputStream is = socket.getInputStream();<br>                BufferedReader bufferedReader = <span class="hljs-keyword">new</span> BufferedReader(<span class="hljs-keyword">new</span> InputStreamReader(is));<br>                String res;<br>                <span class="hljs-keyword">while</span> ((res= bufferedReader.readLine()) != <span class="hljs-keyword">null</span>) &#123;<br>                    System.out.println(<span class="hljs-string">&quot;message checked from [&quot;</span> + res + <span class="hljs-string">&quot;]&quot;</span>);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">package</span> com.daiwei.socket.app;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Created by Daiwei on 2021/9/9</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocketAppClient</span> </span>&#123;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">200</span>; i++) &#123;<br>            socketSendMsg(<span class="hljs-string">&quot;hello server of &quot;</span> + i);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * é€šè¿‡socket å‘é€æ¶ˆæ¯åˆ°serverç«¯</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> msg</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">socketSendMsg</span><span class="hljs-params">(String msg)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Socket socket = <span class="hljs-keyword">new</span> Socket(<span class="hljs-string">&quot;127.0.0.1&quot;</span>, <span class="hljs-number">8888</span>);<br>            OutputStream outputStream = socket.getOutputStream();<br>            PrintWriter printWriter = <span class="hljs-keyword">new</span> PrintWriter(outputStream);<br>            printWriter.write(msg);<br>            printWriter.flush();<br><br>            printWriter.close();<br>            outputStream.close();<br>            socket.close();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Socketè°ƒç”¨è¿‡ç¨‹åˆ†æ"><a href="#Socketè°ƒç”¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="Socketè°ƒç”¨è¿‡ç¨‹åˆ†æ"></a>Socketè°ƒç”¨è¿‡ç¨‹åˆ†æ</h2><p>åœ¨ä¸Šé¢çš„ä»£ç ä¸­æˆ‘ä»¬ä¹Ÿä¸éš¾å‘ç°ï¼Œsocketå»ºç«‹çš„è¿æ¥çš„å‚æ•°æ˜¯éå¸¸ç®€æ´çš„ï¼Œå®¢æˆ·ç«¯åªéœ€è¦æä¾›ä¸€ä¸ªç›®æ ‡ä¸»æœºIPå’Œç«¯å£å·ï¼ŒæœåŠ¡ç«¯åˆ™éœ€è¦æä¾›ä¸€ä¸ªæœåŠ¡ç›‘å¬çš„ç«¯å£å·å³å¯ã€‚socketç¼–ç¨‹è¿›è¡Œæ˜¯ç«¯åˆ°ç«¯çš„é€šè¡Œã€‚æ‰¿æ¥ä¸Šé¢çš„åº”ç”¨å±‚ï¼Œå¯¹æ¥ä¸‹é¢çš„ä¼ è¾“å±‚å’Œç½‘ç»œå±‚ã€‚é’ˆå¯¹ç½‘ç»œå±‚ï¼Œsocketéœ€è¦æŒ‡å®šæ˜¯<code>IPv4</code>è¿˜æ˜¯<code>IPv6</code>ã€‚åˆ†åˆ«å¯¹åº”è¿™å®ç°ç±»<code>java.net.Inet4Address</code>å’Œ<code>java.net.Inet6Address</code>ã€‚æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼ŒTCPåè®®æ˜¯åŸºäºæ•°æ®æµçš„è€ŒUDPæ˜¯åŸºäºæ•°æ®æŠ¥çš„ã€‚åœ¨socketæºç ä¸­æœ‰ä»¥ä¸‹çš„ä¸€ä¸ªç§æœ‰æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Socket</span><span class="hljs-params">(SocketAddress address, SocketAddress localAddr, </span></span><br><span class="hljs-function"><span class="hljs-params">               <span class="hljs-keyword">boolean</span> stream)</span> <span class="hljs-keyword">throws</span> IOException </span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­å½“å‚æ•°streamè®¾ç½®ä¸º<code>true</code>æ—¶ï¼Œå½“å‰socketä½¿ç”¨åˆ™æ˜¯TCPåè®®ï¼Œåæ­£åˆ™ä¸ºUDPåè®®ã€‚ä½†æ˜¯æˆ‘å‘ç°è°ƒç”¨è¿™ä¸ªæ„é€ çš„<strong>æœªè¢«åºŸå¼ƒ</strong>çš„æ–¹æ³•streamå‚æ•°éƒ½æ˜¯trueã€‚è¿™å°±æ„å‘³ç€æˆ‘ä»¬åˆ›å»ºçš„socketéƒ½æ˜¯åŸºäºTCPçš„ã€‚æœ‰ä¸¤ä¸ª<strong>åºŸå¼ƒäº†</strong>çš„æ„é€ æ–¹æ³•å¯ä»¥ä¼ å…¥streamå‚æ•°æŒ‡å®šä½¿ç”¨UDPåè®®ã€‚å¹¶ä¸”åœ¨æ³¨é‡Šä¸­å¯ä»¥å‘ç°ä»¥ä¸‹ä¸€æ®µè¯´æ˜ã€‚</p><blockquote><p>If UDP socket is used, TCP/IP related socket options will not apply.</p><p>Deprecated Use DatagramSocket instead for UDP transport.</p><p>-â€“</p><p>å¦‚æœä½¿ç”¨UDP socketè¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆTCP/IPæœ‰å…³çš„ä¸€äº›socketé…ç½®å‚æ•°å°†ä¸ç”Ÿæ•ˆï¼Œ</p><p>åºŸå¼ƒä½¿ç”¨æ•°æ®æŠ¥æ–‡Socketä»£æ›¿UDPæ•°æ®ä¼ è¾“ã€‚</p></blockquote><h3 id="åŸºäºTCPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ"><a href="#åŸºäºTCPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="åŸºäºTCPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ"></a>åŸºäºTCPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ</h3><p>ä¸¤ç«¯åˆ›å»ºäº†socketä¹‹åï¼Œæ¥ä¸‹æ¥çš„è¿‡ç¨‹ä¸­ï¼ŒTCPå’ŒUDPç¨æœ‰ä¸åŒã€‚TCPçš„æœåŠ¡ç«¯è¦ç›‘å¬ä¸€ä¸ªç«¯å£ï¼Œä¸€èˆ¬æ˜¯å…ˆè°ƒç”¨<code>bind()</code>å‡½æ•°ï¼Œç»™è¿™ä¸ªsocketèµ‹äºˆä¸€ä¸ªIPåœ°å€å’Œç«¯å£ã€‚ä¸ºä»€ä¹ˆéœ€è¦ç«¯å£ï¼Ÿå½“ä¸€ä¸ªæ•°æ®åŒ…åˆ°è¾¾åï¼Œå†…æ ¸è¦é€šè¿‡TCPå¤´çš„ç«¯å£å·æ‰¾åˆ°è¿™ä¸ªæ•°æ®åŒ…æ‰€å±çš„åº”ç”¨ç¨‹åºã€‚å¦‚æœä¸€å°æœºå™¨æœ‰å¤šä¸ªIPåœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼Œä¹Ÿå¯ä»¥ç›‘å¬ä¸€ä¸ªç½‘å¡ï¼ˆç›‘å¬<code>0.0.0.0</code>å³å¯ç›‘å¬æ‰€æœ‰ç½‘å¡ï¼‰ã€‚å½“æœåŠ¡ç«¯æœ‰äº†IPå’Œç«¯å£å·ï¼Œå°±å¯ä»¥è°ƒç”¨<code>listen()</code>å‡½æ•°è¿›è¡Œç›‘å¬ã€‚åœ¨TCPçš„çŠ¶æ€å›¾é‡Œé¢ï¼Œæœ‰ä¸€ä¸ª<code>listen</code>çŠ¶æ€ï¼Œå½“è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹åï¼ŒæœåŠ¡ç«¯å°±è¿›å…¥äº†è¿™ä¸ªçŠ¶æ€ã€‚è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å°±å¯ä»¥å‘èµ·è¿æ¥ã€‚æ¥ä¸‹æ¥ï¼ŒæœåŠ¡ç«¯è°ƒç”¨<code>accept()</code>å‡½æ•°ï¼Œæ‹¿å‡ºä¸€ä¸ªå·²ç»å®Œæˆè¿æ¥è¿›è¡Œå¤„ç†ã€‚</p><blockquote><p>åœ¨å†…æ ¸ä¸­ï¼Œä¸ºæ¯ä¸ªsocketç»´æŠ¤ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯å·²ç»å»ºç«‹äº†è¿æ¥çš„é˜Ÿåˆ—ï¼Œè¿™æ—¶å€™è¿æ¥ä¸‰æ¬¡æ¡æ‰‹å·²ç»å®Œæˆï¼Œå¤„äº<code>establish</code>çŠ¶æ€ï¼›ä¸€ä¸ªæ˜¯è¿˜æ²¡æœ‰å®Œå…¨å»ºç«‹è¿æ¥çš„é˜Ÿåˆ—ï¼Œè¿™ä¸ªæ—¶å€™ä¸‰æ¬¡æ¡æ‰‹è¿˜æ²¡å®Œæˆï¼Œå¤„äº<code>syn_rcvd</code>çš„çŠ¶æ€ã€‚</p></blockquote><p>åœ¨æœåŠ¡ç«¯ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡<code>connect</code>å‡½æ•°å‘èµ·è¿æ¥ã€‚å…ˆåœ¨å‚æ•°ä¸­è¦æ˜ç¡®è¿æ¥çš„IPåœ°å€å’Œç«¯å£å·ï¼Œç„¶åå‘èµ·ä¸‰æ¬¡æ¡æ‰‹ã€‚å†…æ ¸ä¼šç»™å®¢æˆ·ç«¯åˆ†é…ä¸€ä¸ªä¸´æ—¶çš„ç«¯å£ã€‚ä¸€æ—¦æ¡æ‰‹æˆåŠŸï¼ŒæœåŠ¡ç«¯çš„<code>accept</code>å°±ä¼šè¿”å›å¦ä¸€ä¸ªsocketã€‚</p><blockquote><p>ç”¨æ¥ç›‘å¬çš„socketå’ŒçœŸæ­£ç”¨æ¥ä¼ æ•°æ®çš„socketæ˜¯ä¸¤ä¸ªï¼Œä¸€ä¸ªå«åš<strong>ç›‘å¬socket</strong>ï¼Œä¸€ä¸ªå«åš<strong>å·²ç»è¿æ¥socket</strong>ã€‚</p><p>å®¢æˆ·ç«¯ï¼š</p><p><code>scoket()</code> -&gt; åˆ›å»º<code>active_socket_fd</code>ï¼ˆ<code>client_socket_fd</code>ï¼‰</p><p><code>bind()</code> -&gt; æŠŠ<code>active_socket_fd</code>ä¸<code>ip, port</code>ç»‘å®šèµ·æ¥ã€‚</p><p><code>connect()</code> -&gt; <code>client_socket_fd</code>ä¸»åŠ¨è¯·æ±‚æœåŠ¡ç«¯çš„<code>listen_socket_fd read()/write()</code> -&gt; è¯»/å†™<code>socket io close()</code> -&gt; å…³é—­<code>socket_fd</code></p><p>æœåŠ¡ç«¯ï¼š</p><p><code>socket()</code> -&gt; åˆ›å»º<code>active_socket_fd</code></p><p><code>bind()</code> -&gt; æŠŠ<code>active_socket_fd</code>ä¸<code>ip, port</code>ç»‘å®šèµ·æ¥</p><p><code>listen()</code> -&gt;  <code>active_socket_fd</code> -&gt; <code>listen_socket_fd</code> ç­‰å¾…å®¢æˆ·ç«¯çš„<code>client_socket_fd</code>æ¥è¯·æ±‚è¿æ¥ã€‚</p><p><code>accept()</code> -&gt; <code>listen_socket_fd</code> -&gt; <code>connect_socket_fd</code> æŠŠç›‘å¬socketè½¬å˜ä¸ºè¿æ¥socketï¼Œç”¨äºå»ºç«‹è¿æ¥é€šé“çš„æ•°æ®è¯»å†™ã€‚</p><p><code>read()/write()</code> -&gt; è¯»/å†™ <code>socket io close()</code> -&gt; å…³é—­<code>socket_fd</code></p><p>ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§çŠ¶æ€çš„socketï¼Ÿ</p><p>ç°åœ¨çš„ç½‘ç»œç¨‹åºä¸­æ˜¯C/Sç»“æ„ï¼Œä¸€èˆ¬æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨å‘æœåŠ¡ç«¯è¯·æ±‚å»ºç«‹è¿æ¥ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»è¦æ¶‰åŠä¸¤ä¸ªçŠ¶æ€ï¼Œä¸€ä¸ªæ˜¯ä¸»åŠ¨ä¸€ä¸ªæ˜¯è¢«åŠ¨çš„ã€‚å› æ­¤ï¼Œå®¢æˆ·ç«¯çš„socketåªç”¨äºä¸»åŠ¨æœåŠ¡ç«¯çš„socketè¯·æ±‚å»ºç«‹è¿æ¥ï¼ŒæœåŠ¡å™¨ç«¯çš„socketä¸€ç›´è¢«åŠ¨çš„ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚è¿æ¥å°±okäº†ã€‚æ‰€ä»¥è¿™å°±è§£ç­”äº†ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ç§çŠ¶æ€çš„socketï¼Œ<strong>åªæœ‰ä¸€ä¸ªæ–¹æ˜¯ä¸»åŠ¨çš„ï¼Œå¦ä¸€æ–¹æ˜¯è¢«åŠ¨çš„æ‰èƒ½å®Œæˆä¸Šè¿°æ“ä½œï¼Œå¦‚æœåŒæ–¹éƒ½æ˜¯ä¸»åŠ¨æˆ–æ˜¯è¢«åŠ¨çš„ï¼Œå°±å®Œæˆä¸äº†ä¸Šé¢çš„è¿‡ç¨‹ã€‚</strong></p></blockquote><p>åœ¨æˆåŠŸå»ºç«‹è¿æ¥ä¹‹åï¼ŒåŒæ–¹å¼€å§‹é€šè¿‡<code>read()</code>å’Œ<code>write()</code>å‡½æ•°æ¥è¯»å†™æ•°æ®ï¼Œå°±åƒæ˜¯å¾€ä¸€ä¸ªæ–‡ä»¶æµé‡Œé¢å†™ä¸œè¥¿ä¸€æ ·ã€‚ä¸‹é¢çš„å›¾å°±æ˜¯åŸºäºTCPçš„socketç¨‹åºå‡½æ•°è°ƒç”¨è¿‡ç¨‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210911133549.png"></p><p><strong>è¯´TCPçš„socketå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æµï¼Œæ˜¯éå¸¸å‡†ç¡®çš„ã€‚å› ä¸ºsocketåœ¨Linuxä¸­æ˜¯ä»¥æ–‡ä»¶çš„å½¢å¼å­˜åœ¨çš„ã€‚</strong>é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å­˜åœ¨æ–‡ä»¶æè¿°ç¬¦ã€‚å†™å…¥å’Œè¯»å‡ºï¼Œä¹Ÿæ˜¯é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ã€‚åœ¨å†…æ ¸ä¸­ï¼Œ<strong>socketæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œé‚£å¯¹åº”çš„å°±æœ‰æ–‡ä»¶æè¿°ç¬¦</strong>ã€‚æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„<code>task_struct</code>ï¼Œé‡Œé¢æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ•°ç»„ã€‚æ¥åˆ—å‡ºè¿™ä¸ªè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚<strong>æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œæ˜¯è¿™ä¸ªæ•°ç»„çš„ä¸‹æ ‡</strong>ã€‚å…¶ä¸­æ•°ç»„çš„å†…å®¹æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå€¼å‘å†…æ ¸ä¸­æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶çš„åˆ—è¡¨ï¼Œæ—¢ç„¶æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå°±ä¼šæœ‰ä¸€ä¸ªinodeï¼Œåªä¸è¿‡Socketå¯¹åº”çš„inodeä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œè€Œä¸æ˜¯åƒçœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿä¿å­˜åœ¨ç¡¬ç›˜ä¸Šã€‚åœ¨è¿™ä¸ªinodeä¸­ï¼ŒæŒ‡å‘Socketåœ¨å†…æ ¸ä¸­çš„Socketç»“æ„ã€‚åœ¨è¿™ä¸ªç»“æ„ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œ<strong>ä¸€ä¸ªæ˜¯å‘é€é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯æ¥æ”¶é˜Ÿåˆ—</strong>ã€‚åœ¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—é‡Œé¢ä¿å­˜çš„æ˜¯ä¸€ä¸ªç¼“å­˜<strong>sk_buff</strong>ã€‚è¿™ä¸ªé‡Œé¢èƒ½çœ‹åˆ°å®Œæ•´çš„åŒ…ç»“æ„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210911135127.png"></p><h3 id="åŸºäºUDPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ"><a href="#åŸºäºUDPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ" class="headerlink" title="åŸºäºUDPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ"></a>åŸºäºUDPåè®®çš„è°ƒç”¨è¿‡ç¨‹åˆ†æ</h3><p>å¯¹äºUDPæ¥è®²ï¼Œè¿‡ç¨‹æœ‰ä¸€äº›ä¸ä¸€æ ·ã€‚<strong>UDPæ˜¯æ²¡æœ‰è¿æ¥çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸‰æ¬¡æ¡æ‰‹</strong>ï¼Œä¹Ÿå°±ä¸éœ€è¦è°ƒç”¨ listen å’Œ connentï¼Œä½†æ˜¯UDPçš„äº¤äº’ä»ç„¶éœ€è¦IPå’Œç«¯å£å·ï¼Œå› è€Œä¹Ÿéœ€è¦<code>bind</code>æ“ä½œã€‚UDPæ˜¯æ²¡æœ‰ç»´æŠ¤è¿æ¥çŠ¶æ€çš„ï¼Œå› è€Œ<strong>ä¸éœ€è¦æ¯é˜Ÿè¿æ¥éƒ½å»ºç«‹ä¸€ç»„Socket</strong>ï¼Œè€Œæ˜¯åªè¦ä¸€ä¸ªSocketå°±èƒ½å¤Ÿå’Œå¤šä¸ªå®¢æˆ·ç«¯é€šè¡Œã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºæ²¡æœ‰è¿æ¥çŠ¶æ€ï¼Œæ¯æ¬¡é€šä¿¡çš„æ—¶å€™ï¼Œéƒ½è°ƒç”¨<code>sendto</code>å’Œ<code>recvfrom</code>ï¼Œéƒ½å¯ä»¥ä¼ å…¥IPåœ°å€å’Œç«¯å£ï¼Œä¸‹å›¾å†…å®¹å°±æ˜¯åŸºäºUDPåè®®çš„Socketå‡½æ•°è°ƒç”¨è¿‡ç¨‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210911171040.png"></p><h2 id="æ›´å¤šçš„è¿æ¥"><a href="#æ›´å¤šçš„è¿æ¥" class="headerlink" title="æ›´å¤šçš„è¿æ¥"></a>æ›´å¤šçš„è¿æ¥</h2><p>åœ¨å®Œæˆä¸Šè¿°çš„è°ƒç”¨è¿‡ç¨‹åˆ†æä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥ç”¨socketå†™å‡ºä¸€ä¸ªç½‘ç»œäº¤äº’çš„ç¨‹åºäº†ã€‚åœ¨æˆ‘ä»¬ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¾€å¾€è¦æœåŠ¡è¦æ¥å…¥å¾ˆå¤šçš„æœåŠ¡ã€‚åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬æœåŠ¡ç«¯é€šè¿‡<code>accept()</code>ç›‘å¬socketè¿æ¥ï¼Œå½“å®¢æˆ·ç«¯çš„socketè¿æ¥åã€‚åŒæ–¹è¿›è¡Œè¿æ¥æœåŠ¡å™¨å¤„ç†é€»è¾‘ç„¶åå°†ç»“æœé€šè¿‡socketå†™å›å®¢æˆ·ç«¯ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒæœåŠ¡ç«¯åªèƒ½å¤„ç†è¿™ä¸€ä¸ªè¿æ¥ï¼Œä¸èƒ½å¤„ç†å…¶ä»–çš„socketè¿æ¥ï¼Œå…¶ä»–çš„socketè¿æ¥åªèƒ½æ’é˜Ÿç­‰å¾…å¤„ç†ï¼Œè¿™æ ·çš„å¤„ç†æ¨¡å¼å¾ˆæ˜æ˜¾æ˜¯ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„æœŸæœ›ã€‚</p><p>åœ¨æˆ‘ä»¬å°è¯•æå‡è¿æ¥æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè®¡ç®—ä¸‹ç†è®ºå€¼ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§è¿æ¥æ•°ã€‚ç³»ç»Ÿä¼šä½¿ç”¨ä¸€ä¸ªå››å…ƒç»„æ¥æ ‡è¯†å”¯ä¸€ä¸€ä¸ªTCPè¿æ¥ã€‚</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm">&#123;æœ¬æœº<span class="hljs-built_in">IP</span>ï¼Œæœ¬æœºç«¯å£PORT : å¯¹ç«¯<span class="hljs-built_in">IP</span>ï¼Œå¯¹ç«¯ç«¯å£PORT&#125;<br></code></pre></td></tr></table></figure><p>æœåŠ¡å™¨é€šå¸¸å›ºå®šåœ¨æŸä¸ªæœ¬åœ°ç«¯å£ä¸Šç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚ã€‚å› æ­¤æœåŠ¡ç«¯TCPè¿æ¥å››å…ƒç»„ä¸­åªæœ‰å¯¹ç«¯IPï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯çš„IPå’Œå¯¹ç«¯çš„ç«¯å£ã€‚å› æ­¤<strong>æœ€å¤§TCPè¿æ¥æ•°=å¯¹ç«¯IP * å¯¹ç«¯ç«¯å£æ•°</strong>ã€‚å¯¹IPv4ï¼Œå®¢æˆ·ç«¯çš„IPæ•°æœ€å¤šä¸º2^32ã€‚å®¢æˆ·ç«¯çš„ç«¯å£æ•°æœ€å¤šä¸º2^16ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯å•æœºæœ€å¤§TCPè¿æ¥æ•°ä¸º2^48ã€‚è¿™åªæ˜¯ç†è®ºå€¼ï¼Œå®é™…ä¸Šå¹¶ä¸ä¼šæœ‰è¿™ä¹ˆå¤šè¿æ¥æ•°ã€‚å…¶ä¸­<strong>æœ€å¤§çš„é™åˆ¶æ˜¯æ–‡ä»¶æ–‡ä»¶æè¿°ç¬¦</strong>ã€‚æˆ‘ä»¬å‰é¢åˆ†æè¿‡socketéƒ½æ˜¯æ–‡ä»¶ï¼Œæ‰€ä»¥é¦–å…ˆè¦é€š<code>ulimit</code>é…ç½®æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡ã€‚å…¶æ¬¡ç³»ç»Ÿå†…å­˜çš„é™åˆ¶ï¼ŒæŒ‰ç…§ä¸Šé¢çš„åˆ†æï¼Œæ¯ä¸ªTCPè¿æ¥éƒ½éœ€è¦<strong>å ç”¨ä¸€å®šçš„å†…å­˜ï¼Œå†…å­˜èµ„æºä¹Ÿæ˜¯æœ‰é™</strong>çš„ã€‚åœ¨æœ‰é™çš„èµ„æºé™åˆ¶ä¸‹ï¼Œè¿æ¥å°½å¯èƒ½å¤šçš„å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬å¯ä»¥ä»ä»¥ä¸‹å››ä¸ªæ–¹å¼å»ä¼˜åŒ–ï¼š</p><ul><li><strong>å¤šè¿›ç¨‹æ–¹å¼</strong>ï¼Œå¦‚æœç›‘å¬åˆ°æœ‰æ–°çš„è¯·æ±‚è¿›æ¥å°±åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åå°†åŸºäºå·²ç»è¿æ¥socketäº¤ç»™è¿™ä¸ªæ–°çš„è¿›ç¨‹æ¥å¤„ç†ã€‚</li></ul><blockquote><p>åœ¨Linuxä¸‹ï¼Œä½¿ç”¨forkå‡½æ•°åˆ›å»ºå­è¿›ç¨‹ã€‚<strong>åœ¨çˆ¶è¿›ç¨‹çš„åŸºç¡€ä¸Šå®Œå…¨æ‹·è´ä¸€ä¸ªå­è¿›ç¨‹</strong>ã€‚åœ¨Linuxå†…æ ¸ä¸­ï¼Œä¼šå¤åˆ¶æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œä¹Ÿä¼šå¤åˆ¶å†…å­˜ç©ºé—´ï¼Œè¿˜ä¼šå¤åˆ¶ä¸€æ¡è®°å½•å½“å‰æ‰§è¡Œåˆ°äº†å“ªä¸€è¡Œç¨‹åºçš„è¿›ç¨‹ã€‚åœ¨å¤åˆ¶å®Œæˆåï¼Œçˆ¶å­è¿›ç¨‹å‡ ä¹ä¸€æ‘¸ä¸€æ ·ï¼Œåªæ˜¯æ ¹æ®forkçš„è¿”å›å€¼æ¥åŒºåˆ†æ˜¯çˆ¶è¿›ç¨‹è¿˜æ˜¯å­è¿›ç¨‹ã€‚å¦‚æœè¿”å›0åˆ™æ˜¯å­è¿›ç¨‹ï¼Œå…¶ä»–æ•´æ•°åˆ™æ˜¯çˆ¶è¿›ç¨‹ã€‚</p></blockquote><ul><li><p><strong>å¤šçº¿ç¨‹æ–¹å¼</strong>ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å°±å®¹æ˜“æƒ³åˆ°ä½¿ç”¨å¤šçº¿ç¨‹çš„æ–¹å¼æå‡æ€§èƒ½ã€‚ç›¸è¾ƒäºè¿›ç¨‹æ¥è¯´ã€‚çº¿ç¨‹è½»é‡çš„å¤šã€‚åœ¨linuxä¸‹ï¼Œé€šè¿‡pthread_createåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿæ˜¯è°ƒç”¨do_forkã€‚ä¸åŒçš„æ˜¯ï¼Œè™½ç„¶æ–°çš„çº¿ç¨‹åœ¨taskåˆ—è¡¨ä¼šæ–°åˆ›å»ºä¸€é¡¹ï¼Œä½†æ˜¯å¾ˆå¤šèµ„æºéƒ½æ˜¯å¯ä»¥å…±äº«ï¼Œæ¯”è¿›ç¨‹æ–¹å¼è½»é‡çš„å¤šã€‚æ–°çš„è¿æ¥å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹çš„æ–¹å¼å¿«é€Ÿå¤„ç†ï¼Œä»è€Œé¿å…ç›‘å¬çº¿ç¨‹è¢«é˜»å¡ã€‚ä½†æ˜¯å¦‚æœæ˜¯ä¸€ä¸ªå°æœºå™¨è¦ç»´æŠ¤1ä¸‡ä¸ªè¿æ¥ï¼Œå°±è¦åˆ›å»º1ä¸‡ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œæ“ä½œç³»ç»Ÿæ˜¯æ— æ³•æ‰¿å—çš„ï¼Œè¿™ä¹Ÿå°±æ˜¯C10Ké—®é¢˜ã€‚</p></li><li><p><strong>IOå¤šè·¯å¤ç”¨ï¼Œä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤å¤šä¸ªsocket</strong>ï¼Œç”±äºsocketæ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼ŒæŸä¸ªçº¿ç¨‹è½®è®­æ‰€æœ‰çš„socketéƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é›†åˆfd_setä¸­ã€‚è°ƒç”¨<code>select</code>å‡½æ•°æ¥ç›‘å¬æ–‡ä»¶æè¿°ç¬¦åœ¨fd_setå¯¹åº”çš„å«è§†éƒ½è®¾ä¸º1ï¼Œæ ‡è¯†socketå¯è¯»æˆ–å¯å†™ï¼Œä»è€Œå¯ä»¥è¿›è¡Œè¯»å†™æ“ä½œï¼Œç„¶åå†è°ƒç”¨selectç»§ç»­è½®è®­ä¸‹å»ã€‚</p></li><li><p><strong>äº‹ä»¶é©±åŠ¨IO</strong>ï¼Œä¸Šé¢selectå‡½æ•°è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼Œå› ä¸ºæ¯æ¬¡socketæ‰€åœ¨çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆä¸­æœ‰socketå‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œéƒ½éœ€è¦é€šè¿‡è½®è¯¢çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯éœ€è¦å°†å…¨éƒ¨çš„é¡¹ç›®éƒ½è¿‡ä¸€éçš„æ–¹å¼æŸ¥çœ‹è¿›åº¦ï¼Œè¿™å¤§å¤§å½±å“äº†ä¸€ä¸ªé¡¹ç›®ç»„èƒ½æ”¯æ’‘çš„æœ€å¤§é¡¹ç›®æ•°é‡ã€‚å› ä¸ºä½¿ç”¨selectï¼Œèƒ½å¤ŸåŒæ—¶æŸ¥è¯¢çš„é¡¹ç›®æ•°é‡ç”±<code>FD_SETSIZE</code>é™åˆ¶ã€‚å¦‚æœæ”¹æˆäº‹ä»¶é€šçŸ¥çš„æ–¹å¼ï¼Œä»åŸæ¥ä¸»åŠ¨å»æŸ¥è¯¢socketçš„çŠ¶æ€åˆ°è¢«åŠ¨é€šçŸ¥socketå¯è¯»æˆ–å¯å†™ï¼Œæ€§èƒ½å°†æå¤§æå‡ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬ç»å¸¸æåˆ°çš„<code>epoll</code>å‡½æ•°ã€‚åœ¨Linuxå†…æ ¸ä¸­çš„å®ç°ä¸æ˜¯é€šè¿‡è½®è®­çš„æ–¹å¼ï¼Œè€Œæ˜¯é€šè¿‡<strong>æ³¨å†Œcallbackå‡½æ•°çš„æ–¹å¼</strong>ï¼Œå½“æŸä¸ªæ–‡ä»¶æè¿°ç¬¦å·å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šä¸»åŠ¨é€šçŸ¥ã€‚</p></li></ul><blockquote><p>äº‹ä»¶é©±åŠ¨IOä½¿å¾—ç›‘å¬Socketæ•°é‡å¢åŠ ï¼Œä½†æ˜¯æ•ˆç‡ä¸ä¼šå¤§å¹…é™ä½ï¼Œèƒ½åŒæ—¶ç›‘å¬çš„Socketçš„æ•°é‡ä¹Ÿéå¸¸å¤šï¼Œä¸Šé™å°±ä¸ºç³»ç»Ÿå®šä¹‰çš„ã€è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶è¡¨è¿°ç¬¦ä¸ªæ•°ã€‚å› è€Œï¼Œ<strong>epollè¢«ç§°ä¸ºè§£å†³C10Ké—®é¢˜çš„åˆ©å™¨ã€‚</strong></p></blockquote><h1 id="IOæ¨¡å‹"><a href="#IOæ¨¡å‹" class="headerlink" title="IOæ¨¡å‹"></a>IOæ¨¡å‹</h1><p>æˆ‘ä»¬æ¢³ç†ç½‘ç»œçš„è¿‡ç¨‹ä¸­å¿…ç„¶ä¼šä»‹ç»ç½‘ç»œæ¨¡å‹ã€‚å› ä¸ºç½‘ç»œé€šä¿¡ä¹Ÿæ˜¯æœ€å¸¸è§çš„è¾“å…¥è¾“å‡ºIOä¹‹ä¸€ã€‚åœ¨è®¡ç®—æœºä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å°†è¾“å…¥è¾“å‡ºè¿‡ç¨‹é«˜åº¦æŠ½è±¡å¯ä»¥æè¿°ä¸ºè¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œå³é€šè¿‡å¤–éƒ¨æ¡ä»¶æˆ–æ•°æ®çš„è¾“å…¥ï¼Œç„¶åç»è¿‡ç³»ç»Ÿçš„é€»è¾‘å¤„ç†ä¹‹åäº§ç”Ÿæ–°çš„ç»“æœå¹¶å°†å…¶è¾“å‡ºã€‚IOæ¨¡å‹æè¿°çš„è®¡ç®—æœºä¸–ç•Œè¾“å…¥å’Œè¾“å‡ºç»è¿‡çš„æŠ½è±¡æ¨¡å‹ã€‚</p><h2 id="äº”ç§IOæ¨¡å‹æ¦‚è¿°"><a href="#äº”ç§IOæ¨¡å‹æ¦‚è¿°" class="headerlink" title="äº”ç§IOæ¨¡å‹æ¦‚è¿°"></a>äº”ç§IOæ¨¡å‹æ¦‚è¿°</h2><p>æˆ‘ä»¬ç†ŸçŸ¥çš„IOæœ‰é˜»å¡ï¼Œéé˜»å¡ï¼ŒåŒæ­¥ï¼Œå¼‚æ­¥è¿™å‡ ç§ç±»å‹ã€‚ä¾æ®è¿™å‡ ç§ç±»å‹æˆ‘ä»¬å¯ä»¥åˆ’åˆ†å‡ºäº”ç§IOæ¨¡å‹ã€‚ä»–ä»¬åˆ†åˆ«ä¸º<code>é˜»å¡IO(BIO)</code>ã€<code>éé˜»å¡IO(NIO)</code>ã€<code>å¤šè·¯å¤ç”¨IO(multiplexing IO)</code>ã€<code>ä¿¡å·é©±åŠ¨IO(signal-driven IO)</code>ã€<code>å¼‚æ­¥IO(AIO)</code>ã€‚æ¯ä¸€ç§IOéƒ½æœ‰ä»–ä»¬çš„ä½¿ç”¨åœºæ™¯å’Œä¼˜åŠ¿ï¼Œä»¥ä¸‹è¿™å¼ å›¾å„ä¸ªIOå’Œé˜»å¡éé˜»å¡ï¼ŒåŒæ­¥å¼‚æ­¥ä¹‹é—´çš„å…³ç³»ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210915224859.png"></p><p>æˆ‘ä»¬ä¸éš¾å‘ç°è¿™äº›IOæ¨¡å‹ä¸­ï¼Œç»å¤§å¤šæ•°éƒ½æ˜¯åŒæ­¥çš„ï¼Œåªæœ‰å¼‚æ­¥æ¨¡å‹æ˜¯å¼‚æ­¥çš„ã€‚åœ¨æ·±å…¥æ¢³ç†æ¯ä¸€ç§IOæ¨¡å‹ä¹‹å‰ï¼Œæˆ‘ä»¬è¦å…ˆæ˜ç¡®æ¨¡å‹ä¸­é˜»å¡å’ŒåŒæ­¥çš„å®šä¹‰ã€‚</p><blockquote><p>I/O æ“ä½œåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ol><li>æ•°æ®å‡†å¤‡ï¼Œå°†æ•°æ®åŠ è½½åˆ°å†…æ ¸ç¼“å­˜ã€‚ï¼ˆæ•°æ®åŠ è½½åˆ°æ“ä½œç³»ç»Ÿï¼‰</li><li>å°†å†…æ ¸ç¼“å­˜ä¸­çš„æ•°æ®æ•°æ®åŠ è½½åˆ°ç”¨æˆ·ç¼“å­˜ï¼ˆä»æ“ä½œç³»ç»Ÿå¤åˆ¶åˆ°åº”ç”¨ä¸­ï¼‰</li></ol></blockquote><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210915005311.png"></p><p>å¼‚æ­¥åŒæ­¥çš„æ¦‚å¿µæè¿°çš„æ˜¯ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çº¿ç¨‹ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼Œè€Œé˜»å¡å’Œéé˜»å¡æè¿°çš„æ˜¯ç”¨æˆ·çº¿ç¨‹è°ƒç”¨å†…æ ¸IOçš„æ“ä½œæ–¹å¼ã€‚åŒæ—¶åªæœ‰åŒæ­¥æ‰æœ‰é˜»å¡å’Œéé˜»å¡ä¹‹åˆ†ã€‚</p><p>é˜»å¡IOå’Œéé˜»å¡IOçš„åŒºåˆ«ï¼š</p><p><strong>ç¬¬ä¸€æ­¥å‘èµ·IOè¯·æ±‚æ˜¯å¦ä¼šè¢«é˜»å¡</strong>ï¼Œå¦‚æœé˜»å¡çŸ¥é“å®Œæˆå°±æ˜¯ä¼ ç»Ÿçš„é˜»å¡IOï¼Œå¦‚æœä¸é˜»å¡é‚£å°±æ˜¯éé˜»å¡IOã€‚</p><p>åŒæ­¥IOå’Œå¼‚æ­¥IOçš„åŒºåˆ«ï¼š</p><p><strong>ç¬¬äºŒæ­¥æ˜¯å¦é˜»å¡</strong>ï¼Œè€Œ<strong>æ“ä½œç³»ç»Ÿå¸®ä½ åšå®ŒIOæ“ä½œå†å°†ç»“æœè¿”å›</strong>ï¼Œé‚£å°±æ˜¯å¼‚æ­¥IOã€‚</p><p>æˆ‘ä»¬è¯´çš„é˜»å¡å’Œéé˜»å¡è¦åˆ†åœºå’ŒèŒƒå›´ï¼Œä»æ ¹æœ¬ä¸Šæ¥è¯´é˜»å¡æ˜¯è¿›ç¨‹â€œè¢«ä¼‘æ¯â€ï¼Œ<strong>CPUå¤„ç†å…¶ä»–è¿›ç¨‹ï¼Œè€Œè¿™é‡Œçš„éé˜»å¡IOå¯ä»¥ç†è§£ä¸ºå°†å¤§çš„æ•´ç‰‡æ—¶é—´é˜»å¡åˆ†æˆNå¤šå°çš„é˜»å¡</strong>ï¼Œè¿›ç¨‹ä¾ç„¶å¯ä»¥è·å¾—CPUæ‰§è¡Œæ—¶é—´ï¼ŒåŒæ—¶CPUä¹Ÿå¯ä»¥å¤„ç†å…¶ä»–è¿›ç¨‹ã€‚å¯¹äºLinuxæ¥è¯´ï¼Œé˜»å¡IOè¿˜æ˜¯è¦æ¯”éé˜»å¡IOå¥½ï¼Œå› ä¸º<strong>CPUä»ç„¶æœ‰å¾ˆå¤§å‡ ç‡å› socketæ²¡æœ‰æ•°æ®è€Œç©ºè½¬</strong>ï¼Œä»æ•´ä½“æœºå™¨æ€§èƒ½å¼€é”€ä¸Šæ¥çœ‹è¿™æ ·çš„æµªè´¹æ›´å¤§ã€‚æ‰€ä»¥å¤šè·¯å¤ç”¨IOä¸­çš„Selector.select() å‡½æ•°è¿˜æ˜¯é˜»å¡çš„ï¼Œå› æ­¤è¿™é‡ŒæŠŠå¤šè·¯å¤ç”¨IOä»ç„¶åˆ’åˆ†ä¸ºé˜»å¡IOã€‚</p><p><strong>é˜»å¡ã€éé˜»å¡ã€å¤šè·¯IOå¤ç”¨ï¼Œéƒ½æ˜¯åŒæ­¥IO</strong>ï¼Œå¼‚æ­¥å¿…å®šæ˜¯éé˜»å¡çš„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨å¼‚æ­¥é˜»å¡å’Œå¼‚æ­¥éé˜»å¡çš„è¯´æ³•ã€‚çœŸæ­£çš„å¼‚æ­¥IOéœ€è¦CPUçš„æ·±å…¥å‚ä¸ã€‚æ¢å¥è¯è¯´ï¼Œåªæœ‰ç”¨æˆ·çº¿ç¨‹åœ¨æ“ä½œIOçš„æ—¶å€™æ ¹æœ¬ä¸ç”¨è€ƒè™‘IOçš„æ‰§è¡Œå…¨éƒ¨éƒ½äº¤ç»™CPUå»å®Œæˆï¼Œè€Œè‡ªå·±åªç­‰å¾…ä¸€ä¸ªå®Œæˆçš„ä¿¡å·çš„æ—¶å€™ï¼Œæ‰æ˜¯çœŸæ­£çš„å¼‚æ­¥IOã€‚æ‰€ä»¥<strong>æ‹‰ä¸€ä¸ªå­çº¿ç¨‹å»è½®è®­æˆ–ä½¿ç”¨selectã€pollã€epolléƒ½ä¸æ˜¯å¼‚æ­¥ã€‚</strong></p><h2 id="é˜»å¡IOæ¨¡å‹"><a href="#é˜»å¡IOæ¨¡å‹" class="headerlink" title="é˜»å¡IOæ¨¡å‹"></a>é˜»å¡IOæ¨¡å‹</h2><p>é˜»å¡å¼IOã€BIOï¼Œä¸€èˆ¬é€šè¿‡åœ¨ while(true) å¾ªç¯ä¸­æœåŠ¡ç«¯ä¼šè°ƒç”¨<code>accept()</code>æ–¹æ³•ç­‰å¾…æ¥æ”¶å®¢æˆ·ç«¯çš„è¿æ¥çš„æ–¹å¼ç›‘å¬è¯·æ±‚ï¼Œè¯·æ±‚ä¸€æ—¦æ¥æ”¶åˆ°ä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œå°±å¯ä»¥å»ºç«‹é€šä¿¡å¥—æ¥å­—ä¸Šè¿›è¡Œè¯»å†™æ“ä½œï¼Œ<strong>æ­¤æ—¶ä¸èƒ½å†æ¥å…¥å…¶ä»–å®¢æˆ·ç«¯çš„æ“ä½œæ‰§è¡Œå®Œæˆ</strong>ï¼Œä¸è¿‡å¯ä»¥é€šè¿‡å¤šçº¿ç¨‹æ¥æ”¯æŒå¤šä¸ªå®¢æˆ·ç«¯çš„è¿æ¥ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210913011718.png"></p><p>æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210914210845.png"></p><h2 id="éé˜»å¡IOæ¨¡å‹"><a href="#éé˜»å¡IOæ¨¡å‹" class="headerlink" title="éé˜»å¡IOæ¨¡å‹"></a>éé˜»å¡IOæ¨¡å‹</h2><p>å’Œé˜»å¡IOç±»æ¯”ï¼Œå†…æ ¸ä¼šç«‹å³è¿”å›ï¼Œ<strong>è¿”å›åè·å¾—è¶³å¤Ÿçš„CPUæ—¶é—´ç»§ç»­åšå…¶ä»–çš„äº‹æƒ…</strong>ã€‚<strong>ç”¨æˆ·è¿›ç¨‹ç¬¬ä¸€é˜¶æ®µä¸æ˜¯é˜»å¡çš„ï¼Œéœ€è¦ä¸æ–­çš„ä¸»åŠ¨å¾ªç¯kernelæ•°æ®æ˜¯å¦å‡†å¤‡å¥½;åŒæ—¶ç¬¬äºŒé˜¶æ®µä¾æ—§æ€»æ˜¯é˜»å¡çš„</strong>ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210914011754.png"></p><p>éé˜»å¡å¼IOçš„æ‰§è¡Œè¿‡ç¨‹æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210914210701.png"></p><h2 id="å¤šè·¯å¤ç”¨IOæ¨¡å‹"><a href="#å¤šè·¯å¤ç”¨IOæ¨¡å‹" class="headerlink" title="å¤šè·¯å¤ç”¨IOæ¨¡å‹"></a>å¤šè·¯å¤ç”¨IOæ¨¡å‹</h2><p>IOå¤šè·¯å¤ç”¨ï¼ˆIO multiplexingï¼‰ï¼Œä¹Ÿç§°äº‹ä»¶é©±åŠ¨IOï¼ˆevent-driven IOï¼‰ï¼Œå°±æ˜¯åœ¨<strong>å•ä¸ªçº¿ç¨‹é‡ŒåŒæ—¶ç›‘æ§å¤šä¸ªå¥—æ¥å­—</strong>ï¼Œé€šè¿‡<code>select</code>æˆ–<code>poll</code>è½®è¯¢æ‰€è´Ÿè´£çš„æ‰€æœ‰socketï¼Œæœ‰æ•°æ®åˆ°è¾¾äº†å°±é€šçŸ¥ç”¨æˆ·çº¿ç¨‹ã€‚<strong>IOå¤ç”¨åŒéé˜»å¡IOæœ¬è´¨ä¸€æ ·ï¼Œä¸è¿‡åˆ©ç”¨äº†æ–°çš„selectç³»ç»Ÿè°ƒç”¨</strong>ã€‚ç”±å†…æ ¸æ¥è´Ÿè´£æœ¬æ¥è¯·æ±‚è¿›ç¨‹åº”è¯¥åšçš„è½®è¯¢æ“ä½œã€‚çœ‹ä¼¼æ¯”æœ¬æ¥çš„è¯·æ±‚è¿›ç¨‹è¯¥åšçš„è½®è¯¢æ“ä½œã€‚çœ‹ä¼¼æ¯”éé˜»å¡IOè¿˜å¤šäº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨å¼€é”€ï¼Œä¸è¿‡<strong>å› ä¸ºå¯ä»¥æ”¯æŒå¤šè·¯IOï¼Œæ‰ç®—æé«˜äº†æ•ˆç‡</strong>ã€‚è¿›ç¨‹å…ˆæ˜¯é˜»å¡åœ¨select/pollä¸Šï¼Œå†æ˜¯<strong>é˜»å¡åœ¨è¯»æ“ä½œçš„ç¬¬äºŒä¸ªé˜¶æ®µä¸Šã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210914210630.png"></p><p>æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210914215214.png"></p><blockquote><p>select/poll çš„å‡ å¤§ç¼ºç‚¹ï¼š</p><ol><li><p>æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦æŠŠfdé›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šæ—¶å¾ˆå¤§ã€‚ï¼ˆ<strong>æ‹·è´å¤§é‡fdå¼€é”€å¤§</strong>ï¼‰ã€‚</p></li><li><p>æ¯æ¬¡è°ƒç”¨selectéƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰fdï¼Œè¿™ä¸ªå¼€é”€åœ¨fdå¾ˆå¤šçš„æ—¶å¾ˆå¤§ã€‚ï¼ˆ<strong>éå†å¤§é‡fdå¼€é”€å¤§</strong>ï¼‰ã€‚</p></li><li><p><strong>selectæ”¯æŒçš„æ–‡ä»¶æè¿°ç¬¦(fd)æ•°é‡å¤ªå°‘</strong>ï¼Œé»˜è®¤1024ã€‚</p></li></ol><p>epollï¼ˆLinux2.5.44å†…æ ¸ä¸­å¼•å…¥ï¼Œ2.6å†…æ ¸æ­£å¼å¼•å…¥ï¼Œå¯è¢«ç”¨äºä»£ç†POSIX select å’Œ pollç³»ç»Ÿè°ƒç”¨ï¼‰ï¼š</p><ol><li><p><strong>å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´å…±äº«ä¸€å—å†…å­˜</strong>ã€‚</p></li><li><p><strong>é€šè¿‡å›è°ƒè§£å†³éå†é—®é¢˜</strong>ã€‚</p></li><li><p><strong>æ²¡æœ‰fdé™åˆ¶ï¼Œå¯ä»¥æ”¯æ’‘10wè¿æ¥</strong>ã€‚</p></li></ol><p><strong>å¯ä»¥è¯´select/pollçš„ç¼ºç‚¹åœ¨epollä¸Šéƒ½è¢«ä¼˜åŒ–æ‰äº†ã€‚</strong></p></blockquote><h2 id="ä¿¡å·é©±åŠ¨IO"><a href="#ä¿¡å·é©±åŠ¨IO" class="headerlink" title="ä¿¡å·é©±åŠ¨IO"></a>ä¿¡å·é©±åŠ¨IO</h2><p>ä¿¡å·é©±åŠ¨IOæ˜¯éé˜»å¡çš„IOç±»å‹ï¼Œæˆ‘ä»¬æ¢³ç†äº†ä»¥ä¸Šçš„ä¸‰ç§IOæ¨¡å‹ï¼Œé™¤äº†éé˜»å¡IOæ¨¡å‹æ˜¯éé˜»å¡IOé™¤å¤–ï¼Œå…¶ä½™çš„éƒ½æ˜¯é˜»å¡IOï¼Œä½†æ˜¯éé˜»å¡IOå¹¶ä¸ä»£è¡¨å¯¹CPUèµ„æºä½¿ç”¨å‹å¥½ï¼Œå°¤å…¶å½“CPUç©ºè½¬æ—¶ç³»ç»Ÿå¼€é”€å¯èƒ½æ›´å¤§ï¼Œä¸Šé¢ä»‹ç»çš„ä¸‰ç§IOç±»å‹åªæœ‰ä½¿ç”¨äº†epollçš„å¤šè·¯å¤ç”¨IOæ¨¡å‹å¯¹ç³»ç»Ÿå¼€é”€æœ€ä¸ºå‹å¥½ã€‚ä¿¡å·é©±åŠ¨IOæ¨¡å‹å’Œä½¿ç”¨epollçš„å¤šè·¯å¤ç”¨IOæ¨¡å‹æ¯”è¾ƒç›¸ä¼¼ï¼Œå…¶ä¸­ä»–ä»¬æœ€å¤§çš„ä¸åŒç‚¹å°±æ˜¯I<strong>Oæ‰§è¡Œçš„æ•°æ®å‡†å¤‡é˜¶æ®µï¼Œä¿¡å·é©±åŠ¨IOä¸ä¼šé˜»å¡ç”¨æˆ·è¿›ç¨‹</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“ç”¨æˆ·è¿›ç¨‹éœ€è¦ç­‰å¾…æ•°æ®çš„æ—¶å€™ï¼Œä¼šå‘å†…æ ¸å‘é€ä¸€ä¸ªä¿¡å·ï¼Œç„¶åç”¨æˆ·è¿›ç¨‹ç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚å½“å†…æ ¸ä¸­æ•°æ®å‡†å¤‡å®Œæˆä¹‹åï¼Œå†…æ ¸å‘è¿›ç¨‹å‘é€ä¸€ä¸ªä¿¡å·ï¼Œç„¶å<strong>ç”¨æˆ·è¿›ç¨‹ä»å†…æ ¸æ€æ‹·è´æ•°æ®åˆ°ç”¨æˆ·æ€</strong>ï¼Œæ•´ä¸ªIOæ“ä½œæµç¨‹ç»“æŸã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨<strong>ç¬¬ä¸€é˜¶æ®µçº¿ç¨‹æ•°æ®å‡†å¤‡é˜¶æ®µåº”ç”¨å¹¶æ²¡æœ‰é˜»å¡ï¼Œè€Œç¬¬äºŒé˜¶æ®µæ•°æ®æ‹·è´é˜¶æ®µåº”ç”¨è¢«é˜»å¡</strong>ï¼Œå› æ­¤ä¿¡å·é©±åŠ¨IOæ˜¯<strong>åŒæ­¥éé˜»å¡</strong>IOã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210915003007.png"></p><h2 id="å¼‚æ­¥IO"><a href="#å¼‚æ­¥IO" class="headerlink" title="å¼‚æ­¥IO"></a>å¼‚æ­¥IO</h2><p>å¼‚æ­¥IOçœŸæ­£å®ç°äº†IOå…¨æµç¨‹çš„éé˜»å¡ï¼Œ<strong>ç”¨æˆ·è¿›ç¨‹å‘å‡ºç³»ç»Ÿè°ƒç”¨åç«‹å³è¿”å›ï¼Œå†…æ ¸ç­‰å¾…æ•°æ®å¤„ç†å®Œæˆï¼Œå†…æ ¸å°†æ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒº</strong>ï¼Œç„¶åå‘é€ä¿¡å·é€šçŸ¥ç”¨æˆ·çº¿ç¨‹IOæ“ä½œæ‰§è¡Œå®Œæ¯•ï¼ˆä¸SIGIOç›¸æ¯”ï¼Œä¸€ä¸ªæ˜¯å‘é€ä¿¡å·å‘Šè¯‰ç”¨æˆ·è¿›ç¨‹æ•°æ®å‡†å¤‡å®Œæ¯•ï¼Œä¸€ä¸ªæ˜¯IOæ‰§è¡Œå®Œæ¯•ï¼‰ã€‚å…¶ä¸­æœ€ä¸ºå…¸å‹çš„æ˜¯windows IOCPæ¨¡å‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210915004059.png"></p><p>ä»¥ä¸Šæ‰€æœ‰çš„ç½‘ç»œæ¨¡å‹çš„æ¢³ç†ä¸æ¨¡å‹ç¤ºæ„å›¾ï¼Œå…¶ä¸­åœ¨Javaä¸­ä¸»è¦ä½¿ç”¨çš„æœ‰BIOã€NIOå’Œå¤šè·¯å¤ç”¨IOã€‚BIOç»“æ„ç®€å•ç›¸è¾ƒäºé™¤AIOä»¥å¤–çš„å…¶ä»–IOæ¨¡å‹åªæœ‰ä¸€æ¬¡ç³»ç»Ÿè°ƒç”¨ï¼Œåœ¨æ•°æ®åº“è¿æ¥ç­‰æ± åŒ–IOèµ„æºä¸­è¿˜æ˜¯å¤šä»¥BIOä¸ºä¸»ã€‚Javaä½¿ç”¨çš„è¿˜æ˜¯ä»¥NIOä¸ºä¸»ï¼Œå…¶ä¸­æˆ‘ä»¬åé¢å³å°†æ¢³ç†çš„Nettyä½¿ç”¨çš„å°±æ˜¯é‡‡ç”¨epollæ¨¡å¼çš„å¤šè·¯å¤ç”¨NIOæ¨¡å‹ã€‚AIO é€‚ç”¨äºè¿æ¥æ•°å¤šä¸”éœ€è¦é•¿æ—¶é—´è¿æ¥çš„åœºæ™¯ï¼Œå†åŠ ä¸ŠAIOç³»ç»Ÿæ”¯æŒç¨‹åº¦æœ‰é™ä¸”åº•å±‚å®ç°å¤æ‚ã€‚NIOä¹‹å‰ä¹Ÿå°è¯•è¿‡AIOï¼Œä½†æ•ˆæœå¹¶ä¸æ˜¯å¾ˆç†æƒ³è€Œæœ€ç»ˆåºŸå¼ƒã€‚</p><blockquote><p>ä¹‹å‰åœ¨ç¾¤é‡Œçœ‹åˆ°æœ‹å‹ä»¬å‘çš„å¾ˆæœ‰æ„æ€çš„Java IOæ¨¡å‹æ¯”å–»æ€»ç»“ï¼š</p><p>ä¾‹å­ï¼šæœ‰ä¸€ä¸ªå…»é¸¡çš„å†œåœºï¼Œé‡Œé¢å…»ç€æ¥è‡ªå„ä¸ªå†œæˆ·ï¼ˆThreadï¼‰çš„é¸¡ï¼ˆSocketï¼‰ï¼Œæ¯å®¶å†œæˆ·éƒ½åœ¨å†œåœºä¸­å»ºç«‹äº†è‡ªå·±çš„é¸¡èˆï¼ˆSocketChannelï¼‰</p><ol><li><p>BIOï¼šBlock IOï¼Œæ¯ä¸ªå†œæˆ·ç›¯ç€è‡ªå·±çš„é¸¡èˆï¼Œä¸€æ—¦æœ‰é¸¡ä¸‹è›‹ï¼Œå°±å»åšæ¡è›‹å¤„ç†ï¼›</p></li><li><p>NIOï¼šNo-BlockIO-å•Selectorï¼Œå†œæˆ·ä»¬èŠ±é’±è¯·äº†ä¸€ä¸ªé¥²å…»å‘˜ï¼ˆSelectorï¼‰ï¼Œå¹¶å‘Šè¯‰é¥²å…»å‘˜ï¼ˆregisterï¼‰å¦‚æœå“ªå®¶çš„é¸¡æœ‰ä»»ä½•æƒ…å†µï¼ˆä¸‹è›‹ï¼‰å‡è¦å‘è¿™å®¶å†œæˆ·æŠ¥å‘Šï¼ˆselectkeysï¼‰;</p></li><li><p>NIOï¼šNo-BlockIO-å¤šSelectorï¼Œå½“å†œåœºä¸­çš„é¸¡èˆ(Selector)é€æ¸å¢å¤šæ—¶ï¼Œä¸€ä¸ªé¥²å…»å‘˜å·¡è§†ï¼ˆè½®è¯¢ï¼‰ä¸€æ¬¡æ‰€éœ€æ—¶é—´å°±ä¼šä¸æ–­åœ°åŠ é•¿ï¼Œè¿™æ ·å†œæˆ·çŸ¥é“è‡ªå·±å®¶çš„é¸¡æœ‰ä¸‹è›‹çš„æƒ…å†µå°±ä¼šå‘ç”Ÿè¾ƒå¤§çš„å»¶è¿Ÿã€‚æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæ²¡é”™ï¼Œå¤šè¯·å‡ ä¸ªé¥²å…»å‘˜ï¼ˆå¤šSelectorï¼‰ï¼Œæ¯ä¸ªé¥²å…»å‘˜åˆ†é…ç®¡ç†é¸¡èˆï¼Œè¿™æ ·å°±å¯ä»¥å‡è½»ä¸€ä¸ªé¥²å…»å‘˜çš„å·¥ä½œé‡ï¼ŒåŒæ—¶å†œæˆ·ä»¬å¯ä»¥æ›´å¿«çš„çŸ¥æ™“è‡ªå·±å®¶çš„é¸¡æ˜¯å¦ä¸‹è›‹äº†ï¼›</p></li><li><p>Epollæ¨¡å¼ï¼šå¦‚æœé‡‡ç”¨Epollæ–¹å¼ï¼Œå†œåœºé—®é¢˜åº”è¯¥å¦‚ä½•æ”¹è¿›å‘¢ï¼Ÿå…¶å®å°±æ˜¯é¥²å…»å‘˜ä¸éœ€è¦å†å·¡è§†é¸¡èˆï¼Œè€Œæ˜¯å¬åˆ°å“ªé—´é¸¡èˆ(Selector)çš„é¸¡æ‰“é¸£äº†ï¼ˆæ´»è·ƒè¿æ¥ï¼‰ï¼Œå°±çŸ¥é“å“ªå®¶å†œæˆ·çš„é¸¡ä¸‹è›‹äº†ï¼›</p></li><li><p>AIOï¼šAsynchronousI/O,é¸¡ä¸‹è›‹åï¼Œä»¥å‰çš„NIOæ–¹å¼è¦æ±‚é¥²å…»å‘˜é€šçŸ¥å†œæˆ·å»å–è›‹ï¼ŒAIOæ¨¡å¼å‡ºç°ä»¥åï¼Œäº‹æƒ…å˜å¾—æ›´åŠ ç®€å•äº†ï¼Œå–è›‹å·¥ä½œç”±é¥²å…»å‘˜è‡ªå·±è´Ÿè´£ï¼Œç„¶åå–å®Œåï¼Œç›´æ¥é€šçŸ¥å†œæˆ·æ¥æ‹¿å³å¯ï¼Œè€Œä¸éœ€è¦å†œæˆ·è‡ªå·±åˆ°é¸¡èˆå»å–è›‹ã€‚</p></li></ol></blockquote><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä»socketç¼–ç¨‹å¼€å§‹ï¼Œä»‹ç»äº†ä»€ä¹ˆsocketï¼Œsocketæ˜¯æˆ‘ä»¬ç½‘ç»œç¼–ç¨‹çš„ä¸€å¥—æ¥å£ï¼Œä½äºä¼ è¾“å±‚å’Œåº”ç”¨å±‚ä¹‹é—´ã€‚socketå°±åƒä»–çš„ä¸­æ–‡æ„æ€â€œæ’åº§â€ä¸€æ ·ï¼Œé€šè¿‡ç¼–å†™é€‚é…è¿™ä¸ªâ€œæ’åº§â€æˆ‘ä»¬çš„ç¨‹åºå°±å¯ä»¥â€œæ’å…¥ç½‘çº¿â€å®ç°ç½‘é€šä¿¡åŠŸèƒ½ã€‚éšåæˆ‘ä»¬å†™äº†å‡ ä¸ªç®€å•çš„socketç¨‹åºDemoï¼Œå¹¶åˆ†æäº†èƒŒåçš„è°ƒç”¨è¿‡ç¨‹ï¼Œå…¶ä¸­socketåˆ†ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯å®¢æˆ·ç«¯ç”¨çš„socketï¼ŒæœåŠ¡ç«¯ç”¨çš„socketServerã€‚SocketServeré€šè¿‡bind()æ–¹æ³•ç»‘å®šåœ¨æŸä¸ªç«¯å£ä¸Šï¼Œå¹¶ä¸”è°ƒç”¨accept()æ–¹æ³•ç­‰å¾…è¿æ¥ã€‚å®¢æˆ·ç«¯Socketæ„é€ æ—¶éœ€è¦ä¼ å…¥ä¸€ä¸ªIPåœ°å€å’Œç«¯å£å·ï¼Œå†è°ƒç”¨connectæ–¹æ³•è¿æ¥æœåŠ¡ç«¯SocketServerï¼Œéšåå¼€å§‹æ•°æ®æ•°æ®ä¼ è¾“ã€‚è¿™é‡Œè¦æ³¨æ„æœåŠ¡ç«¯è´Ÿè´£è¿æ¥çš„socketå’Œæ•°æ®ä¼ è¾“çš„socketæ˜¯ä¸¤ä¸ªsocketã€‚é€šè¿‡åˆ†ææºç æˆ‘ä»¬å‘ç°socketåŸºæœ¬éƒ½æ˜¯åŸºäºTCPçš„ï¼ŒTCPçš„socketæœ¬è´¨å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æµï¼Œæ‰€ä»¥ä¸€ä¸ªæœåŠ¡æœ‰å¤šå°‘ä¸ªè¿æ¥å’Œfdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰çš„é™åˆ¶æœ‰å¾ˆå¤§çš„å…³ç³»ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¢³ç†äº†IOæ¨¡å‹ï¼Œæˆ‘ä»¬å…ˆæ˜¯æ¢³ç†äº†é˜»å¡ä¸éé˜»å¡ï¼ŒåŒæ­¥ä¸å¼‚æ­¥çš„æ¦‚å¿µã€‚éšåæˆ‘ä»¬å¼•å…¥äº†äº”ç§IOæ¨¡å‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯é˜»å¡IOï¼ˆBIOï¼‰ã€éé˜»å¡IOï¼ˆNIOï¼‰ã€å¤šè·¯å¤ç”¨IOã€ä¿¡å·é©±åŠ¨IOå’Œå¼‚æ­¥IOã€‚å…¶ä¸­é™¤äº†å¼‚æ­¥IOå…¶ä»–éƒ½æ˜¯åŒæ­¥IOã€‚é˜»å¡IOå’Œå¤šè·¯å¤ç”¨IOæ˜¯é˜»å¡IOï¼Œå…¶ä»–éƒ½æ˜¯éé˜»å¡IOï¼Œè¿™é‡Œè¦æ³¨æ„çš„æ˜¯å¤šè·¯å¤ç”¨IOæ˜¯é˜»å¡åœ¨selectorä¸Šçš„ï¼Œå¯¹äºåº”ç”¨è¿›ç¨‹æ¥è¯´æ˜¯éé˜»å¡çš„ã€‚æœ€åæˆ‘ä»¬è¯¦ç»†æ¢³ç†äº†è¿™äº”ç§IOæ¨¡å‹ä»¥åŠéƒ¨åˆ†çš„æ—¶åºå›¾ï¼Œæ·±å…¥å¯¹è¿™äº”ä¸ªç½‘ç»œæ¨¡å‹çš„ç†è§£ã€‚ä»¥ä¸Šå°±æ˜¯è¿™ä¸€å°èŠ‚çš„å…¨éƒ¨å†…å®¹äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å¼€å§‹æ¢³ç†Javaç½‘ç»œç¼–ç¨‹çš„â€œæ‰§ç‰›è€³æ¡†æ¶â€Nettyã€‚åŠ æ²¹åŠ æ²¹ï¼Œå†²å†²å†²ã€‚ğŸ˜</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li><p><a href="https://www.cnblogs.com/liangjf/p/9900928.html">ä¸ºä»€ä¹ˆæœ‰ç›‘å¬socketå’Œè¿æ¥socket,ä¸ºä»€ä¹ˆäº§ç”Ÿä¸¤ä¸ªsocket</a></p></li><li><p><a href="https://time.geekbang.org/column/article/9293?cid=100007101">è¶£è°ˆç½‘ç»œåè®®</a></p></li><li><p>java è¿›é˜¶è®­ç»ƒè¥ç¬¬å››è¯¾</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>NIOä¸ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œåŸºç¡€ â€” æ·±å…¥ç†è§£TCPåè®®</title>
    <link href="/2021/09/04/network-basic-2/"/>
    <url>/2021/09/04/network-basic-2/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>å‰é¢ä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†ç½‘ç»œæ¨¡å‹å’Œä¸€äº›ç½‘ç»œåè®®ï¼Œå…¶ä¸­æœ€å¤§å¤´TCPåè®®æˆ‘ä»¬æŒ–äº†ä¸€ä¸ªå‘ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬æ¥å¡«å‘ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¸»è¦åˆ†æˆä¸‰å¤§å—ï¼Œç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å°†ä»‹ç»ï¼ŒTCPçš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ï¼Œé€šè¿‡ç®€å•çš„äº¤äº’ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€æœºä¹‹åå»ºç«‹ä¸€ä¸ªç¨³å®šå¯é çš„è¿æ¥ã€‚æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªç¨³å®šçš„è¿æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ•°æ®åŒ…åœ°ç¨³å®šå‘é€å’Œæ¥æ”¶ã€‚æœ‰äº†ä¸Šé¢ä¸¤ä¸ªä¿éšœä¹‹åï¼Œå¦‚ä½•å……åˆ†åˆ©ç”¨ç½‘ç»œå¸¦å®½ï¼Œæˆäº†æœ€åçš„é—®é¢˜ï¼Œè¿™é‡Œæˆ‘ä»¬ä»‹ç»äº†ä¼ ç»Ÿç®—æ³•å’ŒBBRç®—æ³•ã€‚æ¢³ç†å®Œä»¥ä¸Šè¿™äº›éƒ¨åˆ†ï¼Œæˆ‘ç›¸ä¿¡ä½ å¯¹TCPåè®®ä¼šæœ‰æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œè®©æˆ‘ä»¬å…ˆä»TCPçš„ä»‹ç»å¼€å§‹å§ï½</p><h1 id="åè®®ä»‹ç»"><a href="#åè®®ä»‹ç»" class="headerlink" title="åè®®ä»‹ç»"></a>åè®®ä»‹ç»</h1><p>ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼ŒTransmission Control Protocolï¼‰æ˜¯ä¸ºäº†åœ¨ä¸å¯é çš„äº’è”ç½‘ç»œä¸Šæä¾›å¯é çš„ç«¯åˆ°ç«¯çš„å­—èŠ‚æµè€Œä¸“é—¨è®¾è®¡çš„ä¼ è¾“å±‚åè®®ï¼Œæˆ‘ä»¬å‰é¢æ¯”å–»UDPæ˜¯ä¸€ä¸ªç›¸ä¿¡ç½‘ç»œé“¾è·¯ç¾å¥½çš„å•çº¯å°æœ‹å‹ï¼Œé‚£ä¹ˆTCPå°±æ˜¯è®¤è¯†åˆ°ç½‘ç»œé“¾è·¯çš„é™©æ¶ï¼Œèƒ½ä¿è¯æ•°æ®çš„å‡†ç¡®é€è¾¾å¹¶ä¸”æœ‰å„ç§å„æ ·é—®é¢˜å¤„ç†ç¨³é‡å¯é çš„æˆåŠŸäººå£«å½¢è±¡ã€‚ä»–ä¸UDPåè®®çš„ç®€å•ä¸å¯é ç›¸æ¯”ï¼ŒTCPæä¾›è¾ƒä¸ºå¤æ‚å’Œå¯é çš„è¿æ¥æœåŠ¡ï¼Œå› æ­¤é’ˆå¯¹TCPçš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é’ˆå¯¹æ€§çš„å…³æ³¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼Œä»¥åŠTCPçš„è§£å†³å¤„ç†æ–¹æ¡ˆã€‚</p><ul><li><p><strong>æ•°æ®åŒ…çš„é¡ºåºé—®é¢˜</strong>ï¼ˆé¡ºåºï¼‰</p></li><li><p><strong>ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­çš„ä¸¢åŒ…é—®é¢˜</strong>ï¼ˆä¸¢åŒ…ï¼‰</p></li><li><p><strong>è¿æ¥çš„ç»´æŠ¤é—®é¢˜</strong>ï¼ˆè¿æ¥ç»´æŠ¤ï¼‰</p></li><li><p><strong>æµé‡æ§åˆ¶é—®é¢˜</strong>ï¼ˆæµæ§ï¼‰</p></li><li><p><strong>æ‹¥å¡æ§åˆ¶é—®é¢˜</strong>ï¼ˆæ‹¥å¡æ§åˆ¶ï¼‰</p></li></ul><h1 id="åè®®å¤´è¯¦è§£"><a href="#åè®®å¤´è¯¦è§£" class="headerlink" title="åè®®å¤´è¯¦è§£"></a>åè®®å¤´è¯¦è§£</h1><p>å’ŒUDPä¸€æ ·ï¼Œæˆ‘ä»¬å…ˆçœ‹TCPçš„å¤´éƒ¨ä¿¡æ¯ï¼Œç›¸è¾ƒäºUDPå¤´ä¿¡æ¯çš„ç®€å•ï¼ŒTCPçš„å¤´éƒ¨ä¿¡æ¯åˆ™å¤æ‚å¾—å¤šã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210821154115.png"></p><p>è¿™äº›å¤´éƒ¨ä¿¡æ¯å«ä¹‰åˆ†æå¦‚ä¸‹ï¼š</p><ul><li><p>æºç«¯å£å·ï¼šå‘é€ç½‘ç»œåŒ…çš„ç¨‹åºç«¯å£å·ã€‚</p></li><li><p>ç›®æ ‡ç«¯å£å·ï¼šç½‘ç»œåŒ…æ¥æ”¶æ–¹çš„ç«¯å£å·ã€‚</p></li><li><p>åºå·ï¼š<strong>å‘é€æ–¹å‘Šè¯‰æ¥æ”¶æ–¹è¯¥ç½‘ç»œåŒ…å‘é€çš„æ•°æ®ç›¸å½“äºæ‰€æœ‰å‘é€æ•°æ®çš„ç¬¬å‡ ä¸ªå­—èŠ‚ã€‚</strong></p></li><li><p>ç¡®è®¤åºå·ï¼ˆACKå·ï¼‰ï¼š<strong>æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹æ¥æ”¶æ–¹å·²ç»æ”¶åˆ°äº†æ‰€æœ‰æ•°æ®çš„ç¬¬å‡ ä¸ªå­—èŠ‚ã€‚</strong>å…¶ä¸­ACKæ˜¯acknowleageçš„ç¼©å†™ã€‚</p></li><li><p>é¦–éƒ¨é•¿åº¦ï¼šè¡¨ç¤ºå¤´éƒ¨é•¿åº¦ã€‚</p></li><li><p>ä¿ç•™ï¼šè¯¥å­—æ®µä¸ºä¿ç•™ä½ï¼Œç°åœ¨è¿˜æœªä½¿ç”¨ã€‚</p></li><li><p>æ§åˆ¶ä½ï¼ˆ6ä½ï¼‰ï¼šè¯¥å­—æ®µä¸­çš„æ¯ä¸ªæ¯”ç‰¹ä½åˆ†åˆ«è¡¨ç¤ºä»¥ä¸‹çš„é€šä¿¡æ§åˆ¶å«ä¹‰ã€‚</p></li><li><ul><li>URGï¼šè¡¨ç¤ºä½¿ç”¨ç´§æ€¥æŒ‡é’ˆå­—æ®µæœ‰æ•ˆã€‚</li><li><strong>ACKï¼šè¡¨ç¤ºæ¥æ”¶ç¨‹åºæ•°æ®åºå·å­—æ®µæœ‰æ•ˆï¼Œä¸€èˆ¬è¡¨ç¤ºæ•°æ®å·²ç»è¢«æ¥æ”¶æ–¹æ”¶åˆ°ã€‚</strong></li></ul></li><li><ul><li>PSHï¼šè¡¨ç¤ºé€šè¿‡flushæ“ä½œå‘é€çš„æ•°æ®ã€‚</li><li>RSTï¼š<strong>å¼ºåˆ¶æ–­å¼€è¿æ¥ï¼Œç”¨äºå¼‚å¸¸ä¸­æ–­çš„æƒ…å†µã€‚</strong></li></ul></li><li><ul><li><strong>SYNï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹ç›¸äº’ç¡®è®¤åºå·ï¼Œè¡¨ç¤ºè¿æ¥æ“ä½œã€‚</strong></li><li><strong>FINï¼šè¡¨ç¤ºæ–­å¼€è¿æ¥ã€‚</strong></li></ul></li><li><p>çª—å£ï¼š<strong>æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹çª—å£å¤§å°</strong>ï¼ˆå³<strong>æ— éœ€ç­‰å¾…ç¡®è®¤å¯ä»¥ä¸€èµ·å‘é€çš„æ•°æ®é‡</strong>ï¼‰ã€‚</p></li><li><p>æ ¡éªŒå’Œï¼š<strong>ç”¨æ¥æ£€æŸ¥æ˜¯å¦å‡ºç°é”™è¯¯ã€‚</strong></p></li><li><p>ç´§æ€¥æŒ‡é’ˆï¼š<strong>è¡¨ç¤ºåº”æ€¥å¤„ç†çš„æ•°æ®ä½ç½®ã€‚</strong></p></li><li><p>é€‰é¡¹ï¼šé™¤äº†ä¸Šé¢å›ºå®šçš„å¤´éƒ¨å­—æ®µä»¥å¤–ï¼Œè¿˜å¯ä»¥æ·»åŠ å¯é€‰å­—æ®µï¼Œä½†é™¤äº†è¿æ¥æ“ä½œä¹‹å¤–ï¼Œå¾ˆå°‘ä½¿ç”¨å¯é€‰å­—æ®µã€‚</p></li></ul><h1 id="è¿æ¥çš„å»ºç«‹ä¸æ–­å¼€"><a href="#è¿æ¥çš„å»ºç«‹ä¸æ–­å¼€" class="headerlink" title="è¿æ¥çš„å»ºç«‹ä¸æ–­å¼€"></a>è¿æ¥çš„å»ºç«‹ä¸æ–­å¼€</h1><p>æˆ‘ä»¬å‰é¢æåˆ°<code>IPåè®®</code>æ˜¯ä¸€ä¸ª<strong>æ— çŠ¶æ€ã€æ— è¿æ¥ã€ä¸å¯é </strong>çš„æœåŠ¡ï¼Œé‚£ä¹ˆä½äºç½‘ç»œå±‚çš„TCPåè®®æ˜¯å¦‚ä½•ä¿è¯è¿™ä¸ªè¿æ¥ï¼Œæˆ‘ä»¬å‰é¢æåˆ°äº†çš„è¿™é‡Œçš„è¿æ¥ä¸æ˜¯ç‰©ç†çš„è¿æ¥ï¼Œæ˜¯æºç«¯å’Œç›®æ ‡ç«¯ç»´æŠ¤ä¿æŒçš„çŠ¶æ€ã€‚é€šè¿‡ç»´æŠ¤è¿æ¥çš„çŠ¶æ€ï¼Œæ¥è¡¨ç¤ºé€šä¿¡åŒæ–¹ä¹‹é—´çš„è¿æ¥ã€‚å› æ­¤åœ¨è¿æ¥å»ºç«‹çš„æ—¶å€™TCPè¦è¿›è¡Œç‰¹æ®Šçš„çŠ¶æ€å¤„ç†ï¼Œè¿æ¥å»ºç«‹çš„è¿‡ç¨‹è¦ç»è¿‡ä¸‰æ¬¡é€šä¿¡ç§°ä¸ºä¸‰æ¬¡æ¡æ‰‹ï¼Œè¿æ¥æ–­å¼€çš„æ—¶å€™è¦è¿›è¡ŒåŒæ–¹è¦è¿›è¡Œå››æ¬¡é€šä¿¡ï¼Œå³å››æ¬¡æŒ¥æ‰‹ã€‚</p><h2 id="ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸‰æ¬¡æ¡æ‰‹</h2><p>ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œå°±åƒä¸¤ä¸ªäººæ‰“æ‹›å‘¼ä¸€æ ·ï¼Œåªè¦åŒæ–¹éƒ½ç¡®è®¤æˆ‘è¦å’Œå¯¹æ–¹è¯´è¯ï¼Œå¹¶ä¸”å¯¹æ–¹åœ¨å¬æˆ‘è¯´è¯å°±å¯ä»¥å¼€å§‹æ²Ÿé€šäº†ã€‚å°±å¯ä»¥ç±»æ¯”æˆä¸‹é¢çš„è¿‡ç¨‹ï¼š</p><p>Aï¼šä½ å¥½å•ŠğŸ‘‹ï¼ŒBã€‚</p><p>Bï¼šå—¯ï¼Ÿåœ¨å¬å‘¢ï¼Œä½ ä¹Ÿå¥½å•ŠğŸ‘‹ï¼ŒAã€‚</p><p>Aï¼šBï¼Œä½ å¥½ä½ å¥½ã€‚ğŸ™ˆ</p><p>åŒæ–¹ç¡®è®¤å¯¹æ–¹éƒ½åœ¨å¬è‡ªå·±è¯´è¯ä¹‹åï¼Œä¸¤ä¸ªäººå°±å¯ä»¥å¼€å§‹æ„‰å¿«çš„æ²Ÿé€šäº†ã€‚è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ä¹Ÿå¸¸ç§°ä¸ºâ€œè¯·æ±‚ -&gt; åº”ç­” -&gt; åº”ç­”ä¹‹åº”ç­”â€ã€‚æŠŠè¿™ä¸ªé€»è¾‘ç¿»è¯‘æˆè®¡ç®—æœºä¸­å»ºç«‹ç½‘ç»œçš„è¯­è¨€å°±æ˜¯ä¸‹é¢è¿™ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210821175756.png"></p><p>ä¸€å¼€å§‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¤„äº<code>CLOSED</code>çŠ¶æ€ã€‚å…ˆæ˜¯æœåŠ¡ç«¯ä¸»åŠ¨ç›‘å¬æŸä¸ªç«¯å£ï¼Œå¤„äº<code>LISTEN</code>çŠ¶æ€ã€‚ç„¶åå®¢æˆ·ç«¯ä¸»åŠ¨å‘èµ·è¿æ¥<code>SYN</code>ï¼Œä¹‹åå¤„äº<code>SYN-SENT</code>çŠ¶æ€ï¼ŒæœåŠ¡ç«¯æ”¶åˆ°å‘èµ·çš„è¿æ¥ï¼Œè¿”å›<code>SYN</code>ï¼Œå¹¶ä¸”<code>ACK</code>å®¢æˆ·ç«¯çš„<code>SYN</code>ï¼Œä¹‹åå¤„äº<code>SYN-RCVD</code>çŠ¶æ€ã€‚å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯å‘é€çš„<code>SYN</code>å’Œ<code>ACK</code>ä¹‹åï¼Œå‘é€ACK<code>çš„</code>ACK<code>ï¼Œä¹‹åå¤„äº</code>ESTABLISHED<code>çŠ¶æ€ï¼Œå› ä¸ºå®¢æˆ·ç«¯å·²ç»ä¸€å‘ä¸€æ”¶æˆåŠŸäº†ã€‚æœåŠ¡ç«¯æ”¶åˆ°</code>ACK<code>çš„</code>ACK<code>ä¹‹åï¼Œå¤„äº</code>ESTABLISHED`çŠ¶æ€ï¼Œæ­¤æ—¶æœåŠ¡ç«¯ä¹Ÿä¸€å‘ä¸€æ”¶æˆåŠŸäº†ã€‚åœ¨åç»­çš„çš„è¿æ¥ä¸­å¦‚æœè¿æ¥ç©ºç€ä¹Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬åœ¨ç¨‹åºä¸­å¯ä»¥å¼€å¯keepaliveï¼Œå³æ—¶æ²¡æœ‰æ•°æ®ä¼ è¾“ï¼ŒåŒæ–¹ä¹Ÿä¼šå‘é€æ¢æ´»ç©ºåŒ…æ¥ä¿æŒé€šä¿¡ã€‚</p><blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼ŒTCPé€šè¿‡å°†æ¯ä¸ªæ•°æ®åŒ…ç”Ÿæˆä¸€ä¸ªé€’å¢çš„åºå·ï¼Œæ¥è§£å†³å› ä¸ºç½‘ç»œé€šè·¯å»¶è¿Ÿå¸¦æ¥çš„æ•°æ®åŒ…åˆ°è¾¾çš„é¡ºåºé—®é¢˜ï¼Œ<strong>æ¥æ”¶ç«¯åªè¦æ”¶åˆ°åŒ…åæŒ‰ç…§è¿™ä¸ªåºå·è¿›è¡Œæ’åºï¼Œå³å¯å¾—åˆ°æ•°æ®åŒ…æ­£ç¡®çš„é¡ºåº</strong>ã€‚</p><p>æ¯ä¸ªæ•°æ®åŒ…éƒ½éœ€è¦è¿”å›ä¸€ä¸ªACKåŒ…ç»™æ¥æ”¶ç«¯ï¼Œæ¥ç¡®è®¤æŸä¸ªæ•°æ®åŒ…å·²ç»åˆ°è¾¾ï¼ŒACKå“åº”ä¹Ÿä¼šå¸¦ä¸€ä¸ªå“åº”åºå·è¿™ä¸ªåºå·ä¸º<strong>ç¡®è®¤åŒ…åºå·+æ•°æ®åŒ…é•¿åº¦+1</strong>ï¼Œå¦‚æœå‘é€ç«¯åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°æ¥æ”¶æ–¹å“åº”çš„ACKåŒ…ï¼Œå‘é€æ–¹å°±ä¼šé‡æ–°å‘é€ä¸€ä¸ªã€‚<strong>å› æ­¤é€šè¿‡åºå·å’ŒACKå·ï¼Œå¯ä»¥ç¡®è®¤æ¥æ”¶æ–¹æ˜¯å¦æ”¶åˆ°äº†ç½‘ç»œåŒ…ã€‚</strong></p></blockquote><p>ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ä¸æ˜¯å››æ¬¡ï¼ŸåŒæ–¹åªè¦ä¸€å‘ä¸€æ”¶ï¼ˆSYN+ACKï¼‰æˆåŠŸå°±å¯ä»¥è¿›å…¥åˆ°<code>ESTABLISHED</code>çŠ¶æ€ï¼Œä¸‰æ¬¡äº¤äº’è¶³å¤Ÿè®©åŒæ–¹å»ºç«‹ä¸€å‘ä¸€æ”¶ï¼ˆSYN+ACKï¼‰ï¼Œæ‰€ä»¥å†å¤šæ¬¡çš„â€œæ¡æ‰‹â€å¯ä»¥ä¹ˆï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯æ²¡å¿…è¦æµªè´¹èµ„æºã€‚</p><h2 id="å››æ¬¡æŒ¥æ‰‹"><a href="#å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="å››æ¬¡æŒ¥æ‰‹"></a>å››æ¬¡æŒ¥æ‰‹</h2><p>å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹å…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œç±»æ¯”åˆ°æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­åº”è¯¥æ˜¯ä¸‹é¢è¿™æ ·çš„åœºæ™¯ã€‚</p><p>Aï¼šæˆ‘è¿™è¾¹ç»“æŸäº†ï¼Œå†è§å•¦ğŸ‘‹ã€‚</p><p>Bï¼šå¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ï¼Œæˆ‘è¿™è¾¹è¿˜è¦å¤„ç†ä¸‹ã€‚</p><p>Bï¼šæˆ‘è¿™è¾¹ä¹Ÿå¤„ç†å®Œäº†ï¼Œå†ä¼šğŸ‘‹ã€‚</p><p>Aï¼šå¥½çš„ï¼Œæˆ‘çŸ¥é“äº†ï¼Œå†è§ã€‚</p><p>å››æ¬¡æŒ¥æ‰‹å’Œä¸‰æ¬¡æ¡æ‰‹ä¸ä¸€æ ·ï¼Œæ–­å¼€è¿æ¥æœ‰å››æ¬¡äº¤äº’åœ¨ç»“æŸè¯·æ±‚æ¥æ”¶ç«¯ï¼Œåœ¨ç¬¬ä¸€è½®é€šä¿¡ä¹‹åï¼Œå¹¶ä¸ä¼šç«‹åˆ»å‘é€å…³é—­è¯·æ±‚ï¼Œè€Œæ˜¯æœ‰ä¸€ä¸ª<code>COLSED_WAIT</code>çŠ¶æ€ã€‚éšåå†ä¼šä¸»åŠ¨å‘èµ·ä¸€æ¬¡å…³é—­è¯·æ±‚ã€‚ä¹‹åè¯·æ±‚ç«¯æ”¶åˆ°è¯·æ±‚å<code>TIME_WAIT</code>å®Œæˆä¹‹åï¼Œæ‰ä¼šå…³é—­è¿æ¥ã€‚æ•´ä¸ªé€šä¿¡è¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210822004124.png"></p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸€å¼€å§‹åŒæ–¹éƒ½æ˜¯å¤„äº<code>ESTABLISHED</code>çš„çŠ¶æ€ï¼Œéšåè¯·æ±‚ç«¯å‘èµ·<code>FIN</code>è¯·æ±‚ï¼Œå¹¶éšè¿›å…¥åˆ°<code>FIN_WAIT_1</code>çŠ¶æ€ï¼Œéšåæ¥æ”¶ç«¯æ”¶åˆ°è¯·æ±‚åå›å¤ä¸€ä¸ª<code>ACK</code>å¹¶è¿›å…¥<code>CLOSED_WAIT</code>çŠ¶æ€ï¼Œè¯·æ±‚ç«¯æ”¶åˆ°æ¥æ”¶ç«¯çš„<code>ACK</code>åï¼Œè¿›å…¥åˆ°<code>FIN_WAIT_2</code>çŠ¶æ€ï¼Œç­‰å¾…æ¥æ”¶ç«¯çš„å‘èµ·çš„FINè¯·æ±‚ã€‚åœ¨æ¥æ”¶ç«¯å¤„ç†å®Œä¸€äº›å…³é—­æµç¨‹åï¼Œå‘èµ·æ¥æ”¶ç«¯å‘è¯·æ±‚ç«¯çš„FINè¯·æ±‚ï¼Œéšåè¿›å…¥<code>LAST_ACK</code>çŠ¶æ€ï¼Œå³ç­‰å¾…æœ€åä¸€ä¸ª<code>ACK</code>å“åº”ã€‚è¯·æ±‚ç«¯æ¥æ”¶åˆ°è¿™ä¸ª<code>FIN</code>è¯·æ±‚åï¼Œå‘é€ä¸€ä¸ª<code>ACK</code>å“åº”å¹¶è¿›å…¥åˆ°æ—¶é—´é•¿åº¦ä¸º2ä¸ª<code>MSL</code>çš„<code>TIME_WAIT</code>çŠ¶æ€ï¼Œéšåå…³é—­è¿æ¥ã€‚æ¥æ”¶ç«¯åœ¨æ”¶åˆ°è¯·æ±‚ç«¯çš„æœ€åä¸€ä¸ª<code>ACK</code>å“åº”ä¹‹åä¹Ÿéšå³å…³é—­è¿æ¥ã€‚</p><blockquote><p>å…¶å®ç†è§£ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹æœ‰ä¸ªéšè—çš„ç‚¹ï¼Œæ³¨æ„åˆ°è¿™ä¸ªç‚¹ï¼Œä¹Ÿå°±èƒ½è½»æ¾ç†è§£è¿™ä¸ªå»ºç«‹å’Œå…³é—­è¿æ¥çš„è¿‡ç¨‹äº†ï¼Œè¿™ä¸ªç‚¹å°±æ˜¯ TCPè¿æ¥æ˜¯<strong>å…¨åŒå·¥çš„</strong>ï¼Œå› æ­¤åœ¨å»ºç«‹è¿æ¥é˜¶æ®µï¼Œéœ€è¦<strong>å‘é€æ–¹ä¸€å‘ä¸€æ”¶</strong>ï¼Œç¡®è®¤å‘é€ç«¯åˆ°æ¥æ”¶ç«¯çš„é€šä¿¡æ­£å¸¸ï¼Œä¹Ÿéœ€è¦<strong>æ¥æ”¶ç«¯ä¸€å‘ä¸€æ”¶</strong>ï¼Œç¡®è®¤æ¥æ”¶ç«¯åˆ°å‘é€ç«¯é€šä¿¡æ­£å¸¸ã€‚è€Œåœ¨å››æ¬¡æŒ¥æ‰‹è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºå…³é—­æ¥æ”¶æ–¹ï¼Œä¸­é—´ä¼šæœ‰ä¸€ä¸ª<code>CLOSED_WAIT</code>çŠ¶æ€ï¼Œæ‰€ä»¥è¿™ä¸ªå…³é—­çš„è¿‡ç¨‹å°±åˆ†æˆäº†<strong>å››æ¬¡é€šä¿¡ã€‚</strong></p><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ³¨æ„ç‚¹âš ï¸ï¼šå…³é—­è¯·æ±‚ç«¯æœ‰ä¸€ä¸ª<code>TIME_WAIT</code>çŠ¶æ€ï¼Œ<strong>è¿™ä¸ªçŠ¶æ€æ˜¯å› ä¸ºå¦‚æœæ¥æ”¶ç«¯ç›´æ¥å…³é—­ï¼Œè¿™æ—¶è¯·æ±‚ç«¯çš„ç«¯å£åˆåˆšå¥½è¢«å¦å¤–ä¸€ä¸ªæ–°çš„åº”ç”¨å ç”¨ï¼Œæ–°åº”ç”¨ä¼šæ”¶åˆ°ä¸Šä¸€ä¸ªè¿æ¥æ¥æ”¶ç«¯çš„å‘å‡ºçš„åŒ…ã€‚</strong>è™½ç„¶seqä¼šè¢«é‡ç½®ï¼Œä½†æ˜¯è¿˜æ˜¯ä¿é™©èµ·è§ï¼Œå‘èµ·ç«¯åœ¨å‘é€<code>LAST_ACK</code>ä¹‹åè¿˜ä¼šä¸€ä¸ª<code>2MSL</code>ï¼ˆ<strong>MSLï¼šMax Segment Lifetimeï¼ŒæŠ¥æ–‡æœ€å¤§ç”Ÿå­˜æ—¶é—´</strong>ï¼‰çš„ç­‰å¾…æ—¶é—´ï¼Œç„¶åå…³é—­ï¼Œç­‰å¾…è¿™ä¸ªæ—¶é—´æ˜¯ç¡®ä¿æ‰€æœ‰æ¥æ”¶ç«¯å‘è¿‡æ¥çš„åŒ…éƒ½èƒ½å› ä¸ºè¢«ä¸¢å¼ƒæ‰ã€‚å¦‚æœæ¥æ”¶ç«¯æ²¡æœ‰æ”¶åˆ°<code>LAST_ACK</code>è§¦å‘é‡ä¼ ï¼Œè¿™ä¸ªæ—¶å€™æ¥æ”¶ç«¯å·²ç»å…³é—­äº†ï¼Œæ¥æ”¶ç«¯åˆ™ä¼šè¿”å›ä¸€ä¸ª<code>RST</code>ï¼ˆå¼ºåˆ¶æ–­å¼€è¿æ¥ï¼‰ã€‚å…¶ä¸­<code>2MSL</code>ï¼Œåœ¨<code>RFC793</code>ä¸­è§„å®šMSLçš„æ—¶é—´ä¸º2minï¼Œ<strong>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šé…ç½®ä¸º30sæˆ–è€…1minã€‚</strong>ä¸¤ä¸ªMSLæ˜¯ä¸€ä¸ª<code>MSL</code>ä¸€ä¸ªæ˜¯ç¡®ä¿ä¸»åŠ¨å…³é—­æ–¹çš„æœ€åACKèƒ½å¤Ÿæ¥æ”¶ç«¯ï¼Œä¸€ä¸ª<code>MSL</code>æ˜¯ç¡®ä¿æ¥æ”¶ç«¯é‡å‘çš„<code>LAST_ACK</code>èƒ½è¢«è¯·æ±‚ç«¯æ”¶åˆ°ã€‚</p></blockquote><h1 id="æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£åè®®ï¼‰"><a href="#æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£åè®®ï¼‰" class="headerlink" title="æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£åè®®ï¼‰"></a>æµé‡æ§åˆ¶ï¼ˆæ»‘åŠ¨çª—å£åè®®ï¼‰</h1><p>æˆ‘ä»¬å‰é¢ä»‹ç»äº†TCPä¼ è¾“æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>ä¸ºäº†ä¿è¯é€šä¿¡è¿‡ç¨‹ä¸­ä¸ä¸¢åŒ…</strong>ï¼Œ<strong>å‘é€ç«¯æ¯å‘é€ä¸€ä¸ªåŒ…æ¥æ”¶ç«¯éƒ½ä¼šè¿”å›ä¸€ä¸ªå¯¹åº”çš„ACKåŒ…ï¼Œè¡¨ç¤ºæ¥æ”¶ç«¯æ¥æ”¶åˆ°äº†è¿™ä¸ªæ•°æ®åŒ…</strong>ã€‚å¦‚æœæ¥æ”¶ç«¯å’Œå‘é€ç«¯ä¹‹é—´æ˜¯ç¡®è®¤ä¸€ä¸ªå‘é€ä¸€ä¸ªï¼Œé‚£ä¹ˆæ‰€æœ‰çš„æ•°æ®åŒ…å‘é€æ“ä½œéƒ½æ˜¯ä¸²è¡Œçš„ï¼Œä¼ è¾“æ•ˆç‡å¿…ç„¶å¾ˆä½ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å°†æ‰€æœ‰çš„æ•°æ®åŒ…ï¼Œåˆ†æ‰¹æ¬¡ä¸€æ³¢ä¸€æ³¢å‘å‡ºå»ï¼Œè¿™æ ·ä¼ è¾“æ•ˆç‡å°±æœ‰äº†æå¤§çš„æå‡ã€‚é‚£é—®é¢˜åˆæ¥äº†ï¼Œè¿™ä¸€æ³¢æ˜¯å¤šå°‘æ•°æ®åŒ…å‘¢ï¼Ÿæ•°æ®åŒ…å°‘äº†ä¼ è¾“æ•ˆç‡ä¸Šä¸æ¥ï¼Œæ•°æ®åŒ…å¤šäº†æ¥æ”¶ç«¯å¤„ç†ä¸è¿‡æ¥ï¼Œç½‘ç»œä¹Ÿå®¹æ˜“æ‹¥å¡ã€‚<strong>TCPä¸­é€šè¿‡æ»‘åŠ¨çª—å£åè®®è¿›è¡Œæµé‡æ§åˆ¶ã€‚</strong></p><blockquote><p><strong>æµé‡æ§åˆ¶</strong>è§£å†³çš„æ˜¯<strong>å‘é€ç«¯é€Ÿç‡å’Œæ¥æ”¶ç«¯é€Ÿç‡ä¸åŒ¹é…</strong>çš„é—®é¢˜ï¼Œ<strong>æ‹¥å¡æ§åˆ¶</strong>åº”å¯¹å¤„ç†çš„æ˜¯<strong>ç½‘ç»œæœ¬èº«çš„æ‹¥å¡é—®é¢˜ã€‚</strong></p></blockquote><p>åœ¨TCPå¤´é‡Œé¢ï¼Œæ¥æ”¶ç«¯ä¼šç»™å‘é€ç«¯ä¸€ä¸ªçª—å£å¤§å°ï¼Œå³Advertised windowã€‚è¿™ä¸ªçª—å£çš„å¤§å°å°±æ˜¯å½“å‰å¯ä»¥å‘é€çš„ä¼ è¾“çª—å£å¤§å°ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªå‘é€çš„çª—å£çš„æ¨¡æ‹Ÿç»“æ„ï¼Œå…¶ä¸­åŒ…å«å››ä¸ªéƒ¨åˆ†<code>å‘é€å·²ç»ç¡®è®¤</code>ï¼Œ <code>å‘é€æœªç¡®è®¤</code>ï¼Œ<code>æœªå‘é€å¯å‘é€</code>ï¼Œ<code>æœªå‘é€ä¸å¯å‘é€</code>ã€‚å…¶ä¸­æˆ‘ä»¬æ»‘åŠ¨çª—å£çš„èŒƒå›´å°±æ˜¯æ‰€æœ‰å¤„äº<strong>å‘é€ä¸­</strong>çš„æ•°æ®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210824235013.png"></p><ul><li><p>LastByteAckedï¼šç¬¬ä¸€éƒ¨åˆ†å’Œç¬¬äºŒéƒ¨åˆ†çš„åˆ†ç•Œçº¿ã€‚</p></li><li><p>LastByteSent: ç¬¬äºŒéƒ¨åˆ†å’Œç¬¬ä¸‰éƒ¨åˆ†çš„åˆ†ç•Œçº¿ã€‚</p></li><li><p>LastByteAcked + AdvertisedWindowï¼šç¬¬ä¸‰éƒ¨åˆ†å’Œç¬¬å››éƒ¨åˆ†çš„åˆ†ç•Œçº¿ã€‚</p></li></ul><p>å¯¹äºæ¥æ”¶ç«¯æ¥è¯´ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå¯¹æ¥çš„æ¥æ”¶çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯<code>æ¥æ”¶å·²ç»ç¡®è®¤</code>ï¼Œ<code>ç­‰å¾…æ¥æ”¶æœªç¡®è®¤</code>ï¼Œ<code>ä¸èƒ½æ¥æ”¶</code>ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210825004244.png"></p><ul><li><p>LastByteRead è¡¨ç¤ºåº”ç”¨å±‚è¯»åˆ°çš„æœ€åä¸€ä¸ªä½ç½®ï¼Œè¿™ä¸ªä½ç½®åé¢çš„æ•°æ®éƒ½åœ¨RcvBufferä¸­ã€‚</p></li><li><p>NextByteExcepted è¡¨ç¤ºå½“å‰å·²æ¥æ”¶å·²ç¡®è®¤å’Œç­‰å¾…æ¥æ”¶æœªç¡®è®¤çš„åˆ†ç•Œçº¿ï¼Œè¿™ä¸ªåˆ†ç•Œçº¿ä¹‹å‰çš„æ•°æ®æ˜¯ç¡®è®¤äº†ä¸”åœ¨bufferä¸­çš„æ•°æ®ã€‚ä¹‹åæ˜¯ç­‰å¾…ç¡®è®¤çš„æ•°æ®ã€‚</p></li><li><p>MaxRcvBuffer æ˜¯å½“å‰æ¥æ”¶ç«¯çš„RcvBufferçš„æœ€å¤§ç¼“å­˜ä½ç½®ã€‚</p></li></ul><p>å…¶ä¸­æ»‘åŠ¨çª—å£<code>AdvertisedWindow</code>çš„å¤§å°ä¹Ÿå°±æ˜¯ä¸­é—´ç­‰å¾…æ¥æ”¶ä½†æ˜¯æœªæ¥æ”¶çš„éƒ¨åˆ†ï¼Œå³<code>AdvertisedWindow = MaxRcvBuffer-NextByteExcepted</code>ã€‚å¦‚æœå½“å‰æ¥æ”¶ç«¯çš„MaxRcvBufferåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿå˜åŒ–çš„è¯ï¼Œå‘é€ç«¯æ˜¯å¯ä»¥é€šè¿‡ä¹‹å‰è¿”å›çš„çª—å£å¤§å°æ¥åæ¨å½“å‰çª—å£å¤§å°çš„ã€‚å³<code>availableWindowSize = oldAdvertisedWindow - newLastByteAcked</code>ã€‚</p><h2 id="æµæ§åˆ†æ"><a href="#æµæ§åˆ†æ" class="headerlink" title="æµæ§åˆ†æ"></a>æµæ§åˆ†æ</h2><p>æœ‰äº†ä¸Šé¢çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹åˆ†ææ•°æ®æ”¶å‘è¿‡ç¨‹ä¸­çš„<strong>æµé‡æ§åˆ¶å’Œç¡®è®¤é‡è¯•</strong>ã€‚å…ˆçœ‹æ»‘åŠ¨çª—å£åè®®æ˜¯æ€ä¹ˆè¿›è¡Œæµé‡æ§åˆ¶çš„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210824235013.png"></p><p>åœ¨æ¯æ¬¡ACKçš„å“åº”åŒ…ä¸­çš„TCPå¤´éƒ½ä¼šæºå¸¦ä¸€ä¸ªçª—å£å¤§å°è¿”å›ï¼Œè¿™ä¸ªæ•°å€¼å°±æ˜¯<strong>å½“å‰å¯ä»¥å‘é€çš„æ•°æ®åŒ…çš„ä¸ªæ•°</strong>ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“å‰æˆ‘ä»¬çš„çª—å£å¤§å°æ˜¯8ï¼Œå¹¶ä¸”è¿™æ¬¡æˆ‘ä»¬ä¸€æ¬¡æ€§å‘é€äº†5ä¸ªæ•°æ®åŒ…ã€‚åŒæ—¶å‘é€ç«¯çš„æ¥æ”¶æƒ…å†µå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210824235013.png"></p><p>åœ¨è¿™5ä¸ªæ•°æ®åŒ…ç¡®è®¤ä¹‹åï¼Œæ¥æ”¶ç«¯çš„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½†æ˜¯ä¸éš¾å‘ç°çª—å£å¹¶æ²¡æœ‰è¿›è¡Œæ»‘åŠ¨ã€‚æ˜¯å› ä¸ºæ•°æ®åœ¨bufferè¿˜æ²¡æœ‰è¢«åº”ç”¨å±‚è¯»å–ï¼Œæ­¤æ—¶åœ¨è¿”å›ACKåŒ…ä¸­çª—å£å¤§å°å°±8å‡å°åˆ°3ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210825004833.png"></p><blockquote><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ³¨æ„çš„ç‚¹âš ï¸</p><p>å½“çª—å£å¤§å°ç¼©å°åˆ°0ï¼Œå‘é€æ–¹å°±ä¼šåœæ­¢å‘é€æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å‘é€æ–¹ä¸ä¼šç»™å‘é€æ–¹å‘é€æ•°æ®åŒ…ï¼Œæ¥æ”¶æ–¹ä¹Ÿæ²¡æœ‰å¤šä½™çš„ACKå“åº”å‘Šè¯‰å‘é€æ–¹çª—å£å¤§å°ï¼Œè¿™ä¸ªæ—¶å€™åŒæ–¹å°±é™·å…¥äº†åƒµå±€ï¼Œä¸ºäº†é¿å…è¿™ç§æƒ…å†µçš„å‘ç”Ÿï¼Œå½“çª—å£å¤§å°å˜ä¸º0ä¹‹åï¼Œå‘é€æ–¹ä¼šå®šæ—¶å‘é€çª—å£å¤§å°æ¢æµ‹æ•°æ®åŒ…ã€‚çœ‹æ—¶å€™æœ‰æœºä¼šè°ƒæ•´çª—å£å¤§å°ã€‚ä½†æ˜¯æ¥æ”¶æ–¹ä¸ºäº†é¿å…<strong>ä½èƒ½çª—å£ç»¼åˆç—‡</strong>ï¼Œæ¥æ”¶æ–¹å¯ä»¥åœ¨çª—å£å¾ˆå°çš„æ—¶å€™ä¸æ›´æ–°çª—å£ï¼Œåªæœ‰å½“æ¥æ”¶çª—å£åˆ°è¾¾ä¸€å®šå¤§å°æˆ–è€…åˆ°è¾¾MaxRcvBufferä¸€åŠå¤§å°æ—¶å€™ï¼Œæ‰æ›´æ–°çª—å£æ¥æ”¶æ•°æ®ã€‚</p></blockquote><p>è€Œåœ¨bufferä¸­çš„æ•°æ®è¢«åº”ç”¨å±‚è¯»å–ä¹‹åï¼ŒRcvBufferç©ºé—²å‡ºæ¥åˆå¯ä»¥æ¥æ”¶çš„æ•°æ®ï¼Œæ­¤æ—¶æ¥æ”¶çª—å£æ›´æ–°å¹¶é€šè¿‡ACKåŒ…å‘Šè¯‰å‘é€ç«¯è°ƒæ•´å‘é€çª—å£å¤§å°ï¼Œæ­¤æ—¶çš„çª—å£å¤§å°11ï¼Œæ¥æ”¶ç«¯å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210825011205.png" alt="img"></p><p>åœ¨å‘é€ç«¯æ”¶åˆ°æ›´æ–°çª—å£å¤§å°çš„ACKåŒ…åï¼Œå‘é€ç«¯ä¹Ÿè°ƒæ•´çª—å£å¤§å°ä¸º11ï¼Œå¹¶ç»§ç»­ä¼ è¾“æ•°æ®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210825012436.png"></p><blockquote><p>è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ<strong>æ¥æ”¶æ–¹å…ˆè°ƒæ•´çª—å£å¤§å°ï¼Œå‘é€æ–¹æ”¶åˆ°æ¥æ”¶æ–¹çš„ACKç¡®è®¤ä¹‹åæ‰ä¼šè°ƒæ•´çª—å£å¤§å°ã€‚</strong></p></blockquote><p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/IMG_3450.GIF"></p><h2 id="æ•°æ®åŒ…ç¡®è®¤ä¸ä¸¢åŒ…é‡è¯•"><a href="#æ•°æ®åŒ…ç¡®è®¤ä¸ä¸¢åŒ…é‡è¯•" class="headerlink" title="æ•°æ®åŒ…ç¡®è®¤ä¸ä¸¢åŒ…é‡è¯•"></a>æ•°æ®åŒ…ç¡®è®¤ä¸ä¸¢åŒ…é‡è¯•</h2><p>ä¸Šé¢çš„è¿‡ç¨‹éƒ½æ˜¯ä¸€åˆ‡é¡ºåˆ©çš„æƒ…å†µï¼Œä½†æ˜¯é¢å¯¹ä¸¢åŒ…æ—¶å¸¸å‘ç”Ÿçš„ç½‘ç»œç¯å¢ƒï¼Œé‚£TCPçš„æ»‘åŠ¨çª—å£æ˜¯é€šè¿‡ä»€ä¹ˆæ ·çš„æ•°æ®åŒ…çš„ç¡®è®¤å’Œä¸¢åŒ…é‡è¯•æœºåˆ¶ï¼Œä¿è¯ä¼ è¾“çš„æ•ˆç‡çš„åŒæ—¶åˆä¿è¯äº†ä¼ è¾“çš„å¯é ã€‚</p><h3 id="ç´¯è®¡ç¡®è®¤-ç´¯è®¡åº”ç­”"><a href="#ç´¯è®¡ç¡®è®¤-ç´¯è®¡åº”ç­”" class="headerlink" title="ç´¯è®¡ç¡®è®¤/ç´¯è®¡åº”ç­”"></a>ç´¯è®¡ç¡®è®¤/ç´¯è®¡åº”ç­”</h3><p>ä¸ºäº†ä¿è¯é¡ºåºæ€§ï¼Œæ¯ä¸ªåŒ…éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„åºåˆ—å·ã€‚åœ¨å»ºç«‹è¿æ¥çš„æ—¶å€™ï¼Œå°±ç¡®å®šèµ·å§‹åºåˆ—å·çš„åç§»é‡ï¼Œç„¶åæŒ‰ç…§åºåˆ—å·ä¸€ä¸ªä¸ªå‘é€ï¼Œä¸ºäº†ä¿è¯ä¸ä¸¢åŒ…ï¼Œå¯¹äºå‘é€çš„åŒ…éƒ½è¦è¿›è¡Œåº”ç­”ï¼Œä½†æ˜¯åº”ç­”ACKä¹Ÿä¸æ˜¯ä¸€ä¸ªä¸ªæ¥çš„ï¼Œè€Œæ˜¯<strong>åªè¦åº”ç­”æ‰€æœ‰çš„åŒ…çš„æœ€åä¸€ä¸ªåŒ…ï¼Œå°±è¡¨ç¤ºæ‰€æœ‰çš„åŒ…éƒ½æ”¶åˆ°äº†</strong>ã€‚è¿™ç§åº”ç­”æ¨¡å¼çš„æˆä¸ºç´¯è®¡ç¡®è®¤æˆ–è€…ç´¯è®¡åº”ç­”ï¼ˆcumulative acknowledgmentï¼‰ã€‚è¿™ä¸ªè¿‡ç¨‹ç±»ä¼¼äºä¸‹é¢çš„åœºæ™¯ï¼Œåœ¨æ¥æ”¶ç«¯çš„æ¥æ”¶åˆ°<code>æ•°æ®åŒ…I</code>å’Œ<code>æ•°æ®åŒ…J</code>ååˆ†åˆ«è¿”å›äº†<code>Içš„ACK</code>å’Œ<code>Jçš„ACK</code>ã€‚<code>Içš„ACK</code>åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢åŒ…äº†ï¼Œä½†æ˜¯å‘é€ç«¯æ”¶åˆ°å<code>Jçš„ACK</code>åä¾ç„¶ç¡®è®¤äº†<code>æ•°æ®åŒ…I</code>é€è¾¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/IMG_3457.GIF"></p><h3 id="è¶…æ—¶é‡ä¼ "><a href="#è¶…æ—¶é‡ä¼ " class="headerlink" title="è¶…æ—¶é‡ä¼ "></a>è¶…æ—¶é‡ä¼ </h3><p><strong>å¯¹æ¯ä¸€ä¸ªå‘é€çš„ï¼Œä½†æ˜¯æ²¡æœ‰ACKçš„åŒ…ï¼Œéƒ½è®¾æœ‰ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå¦‚æœè¶…è¿‡ä¸€å®šæ—¶é—´å°±ä¼šè§¦å‘é‡è¯•</strong>ï¼Œä½†æ˜¯è¿™ä¸ªè¶…æ—¶æ—¶é—´ä¸å®œè¿‡é•¿ä¹Ÿä¸å®œè¿‡çŸ­ï¼Œæ—¶é—´å¿…é¡»å¤§äºå¾€è¿”æ—¶é—´RTTï¼Œå¦åˆ™ä¼šå¼•èµ·ä¸å¿…è¦çš„é‡ä¼ ã€‚ä¹Ÿä¸æ˜“è¿‡é•¿ï¼Œå¦åˆ™è®¿é—®æ—¶é—´ä¼šå˜æ…¢ã€‚<strong>è¿™ä¸ªæ—¶é—´éœ€è¦TCPé€šè¿‡é‡‡æ ·RTTæ—¶é—´ï¼Œç„¶åè¿›è¡ŒåŠ æƒå¹³å‡ï¼Œç®—å‡ºä¸€ä¸ªå‡å€¼ï¼Œè€Œä¸”è¿™ä¸ªå€¼è¿˜æ˜¯è¦ä¸æ–­çš„å˜åŒ–ï¼Œå› ä¸ºç½‘ç»œçŠ¶å†µä¸æ–­ä½å˜åŒ–</strong>ã€‚é™¤äº†é‡‡æ ·RTTï¼Œè¿˜è¦é‡‡æ ·RTTçš„æ³¢åŠ¨èŒƒå›´ï¼Œ<strong>è®¡ç®—å‡ºä¸€ä¸ªä¼°å€¼çš„è¶…æ—¶æ—¶é—´</strong>ï¼Œç”±äºé‡ä¼ æ—¶é—´æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œæˆ‘ä»¬ç§°ä¸º<code>è‡ªé€‚åº”é‡ä¼ ç®—æ³•ï¼ˆAdaptive Retransmission Algorithmï¼‰</code>ã€‚TCPçš„é‡ä¼ ç­–ç•¥æ˜¯<strong>è¶…æ—¶é—´é—´éš”åŠ å€ï¼Œæ¯å½“é‡åˆ°ä¸€æ¬¡è¶…æ—¶é‡ä¼ çš„æ—¶å€™ï¼Œéƒ½ä¼šå°†ä¸‹ä¸€æ¬¡è¶…æ—¶æ—¶é—´é—´éš”ä¸ºè®¾ä¸ºå…ˆå‰å€¼çš„ä¸¤å€ã€‚ä¸¤æ¬¡è¶…æ—¶ï¼Œå°±è¯´æ˜ç½‘ç»œç¯å¢ƒå·®ï¼Œä¸å®œé¢‘ç¹åå¤å‘é€ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/IMG_3458.GIF"></p><h3 id="å¿«é€Ÿé‡ä¼ "><a href="#å¿«é€Ÿé‡ä¼ " class="headerlink" title="å¿«é€Ÿé‡ä¼ "></a>å¿«é€Ÿé‡ä¼ </h3><p>å½“æ¥æ”¶æ–¹æ”¶åˆ°ä¸€ä¸ªåºå·å¤§äºä¸‹ä¸€ä¸ªæ‰€æœŸæœ›çš„æŠ¥æ–‡æ®µæ—¶ï¼Œå°±ä¼šç›‘æµ‹æ•°æ®æµä¸­çš„ä¸€ä¸ªé—´éš”ï¼Œäºæ˜¯<strong>å®ƒå°±ä¼šå‘é€å†—ä½™çš„ACKï¼Œå†—ä½™ACKçš„æœŸæœ›æ˜¯æ¥æ”¶é‡ä¼ çš„æŠ¥æ–‡æ®µ</strong>ã€‚è€Œå®¢æˆ·ç«¯åœ¨æ”¶åˆ°<strong>ä¸‰ä¸ªå†—ä½™çš„ACK</strong>åï¼Œå°±ä¼šåœ¨å®šæ—¶å™¨è¿‡æœŸä¹‹å‰ï¼Œé‡ä¼ ä¸¢å¤±çš„æŠ¥æ–‡æ®µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/IMG_3459.GIF"></p><h3 id="Selective-Acknowledegmentï¼ˆSACKï¼‰"><a href="#Selective-Acknowledegmentï¼ˆSACKï¼‰" class="headerlink" title="Selective Acknowledegmentï¼ˆSACKï¼‰"></a>Selective Acknowledegmentï¼ˆSACKï¼‰</h3><p>è¿™ç§æ–¹å¼éœ€è¦æ¥æ”¶æ–¹åœ¨è¿”å›çš„ACKçš„TCPå¤´ä¸­åŠ ä¸€ä¸ªSACKæ•°æ®ï¼Œ<strong>å‘é€æ–¹å¯ä»¥é€šè¿‡è¯»å–SACKï¼ŒçŸ¥é“æ¥æ”¶æ–¹çš„æ•°æ®æ¥æ”¶æƒ…å†µï¼Œå¹¶ä¸”é’ˆå¯¹æ€§çš„é‡ä¼ æ¥æ”¶ç«¯ä¸¢å¤±çš„åŒ…</strong>ã€‚</p><h1 id="æ‹¥å¡æ§åˆ¶"><a href="#æ‹¥å¡æ§åˆ¶" class="headerlink" title="æ‹¥å¡æ§åˆ¶"></a>æ‹¥å¡æ§åˆ¶</h1><p>åœ¨ä¸Šé¢çš„éƒ¨åˆ†æˆ‘ä»¬ä»‹ç»äº†TCPçš„æµé‡æ§åˆ¶ï¼Œé€šè¿‡ä¸€ä¸ªæ•°æ®åŒ…ä¸€ä¸ªACKçš„æ–¹å¼ä¿è¯äº†ä¼ è¾“çš„å¯é æ€§ï¼Œé€šè¿‡å„ç§å„æ ·çš„ç¡®è®¤å’Œé‡ä¼ ç­–ï¼Œæ•°æ®å‘é€ç«¯è¿›è¡Œæµé‡æ§åˆ¶ç¡®ä¿ï¼Œæ¯ä¸ªæ•°æ®åŒ…éƒ½èƒ½å‡†ç¡®åœ°ä¼ è¾“åˆ°æ¥æ”¶ç«¯ã€‚ä½†æ˜¯æˆ‘ä»¬ä¸ä»…ä»…åªæ˜¯æ»¡è¶³äºå¯é çš„ä¼ è¾“ï¼Œæˆ‘ä»¬è¿˜è¦å……åˆ†åˆ©ç”¨ç½‘ç»œæœ€å¤§å¸¦å®½è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œå³åˆ©ç”¨ç½‘ç»œè¿›è¡Œåˆå¥½åˆå¿«çš„è¿›è¡Œä¼ è¾“ã€‚</p><blockquote><p>æµæ§æ§åˆ¶æ˜¯é’ˆå¯¹<strong>å‘é€æ¥æ”¶ç«¯çš„å‘é€æ¥æ”¶ç­–ç•¥</strong>ï¼Œè€Œ<strong>æ‹¥å¡æ§åˆ¶æ˜¯é’ˆå¯¹ç½‘ç»œç¯å¢ƒè¿›è¡Œçš„å‘é€æµé‡è°ƒæ§ç­–ç•¥ã€‚</strong></p></blockquote><p>åœ¨ç†è®ºä¸­ï¼Œæ‹¥å¡æ§åˆ¶ä¸€èˆ¬åˆä¸¤ç§å®ç°æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯<code>ç«¯åˆ°ç«¯çš„æ‹¥å¡æ§åˆ¶</code>å’Œ<code>ç½‘ç»œè¾…åŠ©æ‹¥å¡æ§åˆ¶</code>ã€‚å…¶ä¸­æˆ‘ä»¬TCPä½¿ç”¨çš„æ˜¯ç¬¬ä¸€ç§æ–¹å¼ã€‚</p><ul><li><p><strong>ç«¯åˆ°ç«¯çš„æ‹¥å¡æ§åˆ¶</strong>ï¼š<strong>åœ¨è¿™ç§æ‹¥å¡æ§åˆ¶æ–¹æ³•ä¸­ï¼Œç”±æ•°æ®ç«¯çš„è‡ªå·±åˆ¤æ–­æ˜¯å¦æ‹¥å¡ç„¶åè°ƒæ•´å‘é€é€Ÿç‡</strong>ï¼Œæ¯”å¦‚å‘é€ç«¯çš„æ•°æ®å·²ç»è¶…æ—¶å´è¿˜æ²¡æœ‰æ¥æ”¶åˆ°ACKç¡®è®¤æŠ¥æ–‡ï¼Œæ•°æ®å¾€è¿”å»¶æ—¶è¿‡é«˜ï¼Œæ¥æ”¶ç«¯åˆ°å¯¹åŒä¸€ä¸ªæ•°æ®æ®µæŠ¥æ–‡é‡å¤ç¡®è®¤ç­‰ç°è±¡ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ç½‘ç»œæ‹¥å¡çš„ç°è±¡ã€‚å¦‚æœå‘é€ç«¯ç›‘æµ‹åˆ°è¿™äº›ç°è±¡ï¼Œå°±åº”è¯¥é™ä½æ•°æ®å‘é€çš„é€Ÿç‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™å¯ä»¥æ…¢æ…¢æé«˜é€Ÿç‡ã€‚</p></li><li><p><strong>ç½‘ç»œè¾…åŠ©çš„æ‹¥å¡æ§åˆ¶</strong>ï¼šç”±ç½‘ç»œä¸­çš„è·¯ç”±å™¨æ¥å‘é€å‘Šè¯‰å‘é€æ–¹ï¼Œç½‘ç»œçš„æƒ…å†µï¼Œä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼ï¼š</p></li><li><ul><li> <strong>è·¯ç”±å™¨ç›´æ¥å‘å‘é€ç«¯å‘é€æŠ¥æ–‡</strong>ï¼Œå‘ŠçŸ¥ç½‘ç»œæƒ…å†µã€‚</li><li><strong>è·¯ç”±å™¨æ›´æ”¹æ•°æ®åŒ…ä¸­çš„æŸä¸ªæ ‡è¯†ç¬¦</strong>ï¼Œæ¥æç¤ºç½‘ç»œä¸­çš„æ‹¥å¡æƒ…å†µã€‚é€šå¸¸è¿™ä¸ªæ ‡è¯†ç¬¦å·ä¼šè¢«å¸¦åˆ°æ¥æ”¶ç«¯ï¼Œç„¶åæ¥æ”¶ç«¯å†é€š<strong>è¿‡ACKç¡®è®¤åŒ…è¿”ç»™å‘é€ç«¯</strong>ã€‚</li></ul></li></ul><blockquote><p>ç½‘ç»œè¾…åŠ©æ‹¥å¡æ§åˆ¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•éƒ½æœ‰ä¸å¤ªåˆé€‚çš„åœ°æ–¹ï¼Œç¬¬ä¸€ä¸ªå¦‚æœé€šè¿‡ä¸­é—´è®¾å¤‡å‘å‘é€ç«¯å‘é€åé¦ˆç½‘ç»œæƒ…å†µçš„æ•°æ®åŒ…ï¼Œä¸ä»…ä¼šå¢åŠ ç½‘ç»œç¯å¢ƒçš„å‹åŠ›ï¼ŒåŒæ—¶ä¹Ÿå¢åŠ äº†å‘é€ç«¯çš„æ•°æ®æ¥æ”¶å‹åŠ›ï¼Œé™ä½å‘é€ç«¯ååã€‚ç¬¬äºŒç§æ–¹å¼è™½ç„¶æ²¡æœ‰å¢åŠ æ•°æ®åŒ…çš„æ•°é‡ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ç½‘ç»œæ‹¥å¡çš„åé¦ˆå»¶è¿Ÿä¹Ÿæ›´é«˜ï¼Œå¹¶ä¸”è¿™ç§åé¦ˆçš„å¯è¾¾æ€§ä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ğŸ¤”ï¸</p></blockquote><h2 id="TCPéœ€è¦è§£å†³çš„ä¸‰ä¸ªé—®é¢˜"><a href="#TCPéœ€è¦è§£å†³çš„ä¸‰ä¸ªé—®é¢˜" class="headerlink" title="TCPéœ€è¦è§£å†³çš„ä¸‰ä¸ªé—®é¢˜"></a>TCPéœ€è¦è§£å†³çš„ä¸‰ä¸ªé—®é¢˜</h2><p>TCPé‡‡ç”¨çš„<code>ç«¯åˆ°ç«¯çš„æ‹¥å¡</code>çš„æ‹¥å¡æ§åˆ¶ï¼Œä½†æ˜¯ä»ç†è®ºåˆ°å®è·µè¿˜æœ‰å¾ˆé•¿ä¸€æ®µè·¯è¦èµ°ï¼Œå…¶ä¸­æœ‰ä¸‰ä¸ªé—®é¢˜ä¸å¾—ä¸å›ç­”ã€‚</p><ul><li><p><strong>TCPå¦‚ä½•åˆ¤æ–­å½“å‰ç½‘è·¯ç¯å¢ƒæ˜¯å¦å­˜åœ¨æ‹¥å¡ï¼Ÿ</strong>è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¯ä»¥é€šè¿‡æšä¸¾çš„åŠæ³•ï¼Œæšä¸¾å‡ºä¸¢åŒ…çš„åœºæ™¯ï¼Œç„¶ååˆ†ææ˜¯å¦å­˜åœ¨æ‹¥å¡å³å¯ã€‚æˆ‘ä»¬å¯ä»¥ç®€å•åˆ†æå¾—å‡ºä¸€ä¸‹å‡ ä¸ªåœºæ™¯ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢æµé‡æ§åˆ¶éƒ¨åˆ†é‡ä¼ ç­–ç•¥ä¸­çš„å‡ ä¸ªåœºæ™¯ï¼‰ã€‚</p></li><li><ul><li>è‹¥å‘é€ä¸€æ¡æ•°æ®æ®µåï¼ŒæˆåŠŸæ¥æ”¶åˆ°äº†æ¥æ”¶æ–¹ç¡®è®¤æŠ¥æ–‡ï¼Œåˆ™å¯ä»¥è®¤ä¸ºç½‘ç»œæ˜¯æ²¡æœ‰æ‹¥å¡ã€‚</li><li>è‹¥å‘é€ä¸€æ¡æ•°æ®æ®µåï¼Œ<strong>åœ¨è§„å®šæ—¶é—´å†…æ²¡æœ‰æ”¶åˆ°ç¡®è®¤æŠ¥æ–‡ï¼ˆä¸¢åŒ…æˆ–å»¶è¿Ÿå¤ªå¤§ï¼‰</strong>ï¼Œåˆ™å¯ä»¥è®¤ä¸º<strong>ç½‘ç»œå‡ºç°äº†æ‹¥å¡ã€‚</strong></li></ul></li><li><ul><li>è‹¥è¿ç»­æ”¶åˆ°æ¥æ”¶æ–¹å¯¹<strong>åŒä¸€æ¡æŠ¥æ–‡çš„å¤šæ¬¡å†—ä½™ç¡®è®¤</strong>ï¼Œå³å¯è®¤ä¸ºç½‘ç»œå‡ºç°äº†æ‹¥å¡ï¼ˆè¿™å’Œå¿«é€Ÿé‡ä¼ ç®—æœºåˆ¶æœ‰å…³ï¼‰</li></ul></li><li><p><strong>TCPå¦‚ä½•é™åˆ¶å‘é€ç«¯çš„å‘é€é€Ÿç‡ï¼Ÿ</strong>å‰é¢æˆ‘ä»¬ä»‹ç»äº†æ»‘åŠ¨çª—å£åè®®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶çª—å£çš„å¤§å°æ¥é™åˆ¶å½“å‰çš„å‘é€é€Ÿç‡ï¼Œå…¶ä¸­<code>æ»‘åŠ¨çª—å£RWND</code>é€šè¿‡<strong>è°ƒæ•´çª—å£å¤§å°è°ƒæ•´å‘é€é€Ÿç‡ï¼ŒåŒ¹é…æ¥æ”¶ç«¯çš„æ¥æ”¶å¤„ç†é€Ÿç‡</strong>ã€‚è¿˜æœ‰ä¸€ä¸ª<code>æ‹¥å¡çª—å£CWND</code>ï¼Œé€šè¿‡<strong>è°ƒæ•´è¿™ä¸ªçª—å£çš„å¤§å°ä¹Ÿå¯ä»¥è°ƒæ•´å‘é€é€Ÿç‡ï¼Œæ¥é¿å…ä¸€æ¬¡å‘é€å¤ªå¤šçš„æ•°æ®åŒ…é€ æˆç½‘ç»œæ‹¥å¡</strong>ã€‚<code>LastByteSent - LastByteAcked &lt;= min &#123;cwnd, rwnd&#125;</code> <strong>æ»‘åŠ¨çª—å£å’Œæ‹¥å¡çª—å£å…±åŒæ§åˆ¶å‘é€ç«¯çš„å‘é€é€Ÿç‡ï¼Œå‘é€ç«¯çš„å‘é€é€Ÿç‡å¿…é¡»å°äºæˆ–ç­‰äºmin(cwnd, rwnd)ã€‚</strong></p></li><li><p><strong>TCPé‡‡ç”¨ä»€ä¹ˆæ ·çš„ç®—æ³•æ¥æ§åˆ¶å‘é€é€Ÿç‡ï¼Ÿ</strong>å³å¦‚æœé€šè¿‡æ‹¥å¡åˆ¤æ–­å‘é€æ‹¥å¡åçš„cwndçª—å£å¤§å°è°ƒæ•´ç­–ç•¥ï¼ŒTCPè°ƒæ•´æ‹¥å¡çª—å£çš„ä¸»è¦ç®—æ³•æœ‰<code>æ…¢å¯åŠ¨</code>ã€<code>æ‹¥å¡é¿å…</code>å’Œ<code>å¿«é€Ÿæ¢å¤</code>ã€‚å…¶ä¸­å‰é¢ä¸¤ä¸ªæ˜¯TCPè§„èŒƒå¿…é¡»å®ç°çš„ï¼Œç¬¬ä¸‰ä¸ªåˆ™æ˜¯æ¨èå®ç°ï¼ŒTCPæ ¹æ®æƒ…å†µåœ¨è¿™ä¸‰è€…ä¹‹é—´åˆ‡æ¢ã€‚</p></li></ul><blockquote><p>åœ¨ä»‹ç»æ‹¥å¡æ§åˆ¶ç®—æ³•ä¹‹å‰è¦çŸ¥é“ä¸€äº›åè¯ï¼Œè¿™äº›åè¯æˆ‘ä»¬åœ¨åé¢ä»‹ç»ç®—æ³•è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°</p><p>MSSï¼š<strong>æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦ï¼ŒTCPå‘é€çš„æŠ¥æ–‡æ®µä¸­ï¼ŒåŒ…å«çš„æ•°æ®éƒ¨åˆ†çš„æœ€å¤§å­—èŠ‚æ•°ã€‚</strong></p><p>cwndï¼š<strong>æ‹¥å¡çª—å£</strong>ï¼ŒTCPå‘é€ä½†è¿˜æ²¡å¾—åˆ°ç¡®è®¤çš„æŠ¥æ–‡åºå·éƒ½åœ¨è¿™ä¸ªåŒºé—´ï¼›</p><p>RTTï¼š<strong>å¾€è¿”æ—¶é—´</strong>ï¼Œå‘é€æ–¹å‘é€ä¸€ä¸ªæŠ¥æ–‡ï¼Œåˆ°æ¥æ”¶åˆ°è¿™ä¸ªæŠ¥æ–‡çš„ç¡®è®¤æŠ¥æ–‡æ‰€ç»å†çš„æ—¶é—´ã€‚</p><p>ssthreshï¼š<strong>æ…¢å¯åŠ¨é˜ˆå€¼ï¼Œæ…¢å¯åŠ¨é˜¶æ®µï¼Œè‹¥cwndçš„å¤§å°è¾¾åˆ°è¿™ä¸ªå€¼ï¼Œè½¬æ¢ä¸ºæ‹¥å¡é¿å…æ¨¡å¼ã€‚</strong></p></blockquote><h2 id="æ…¢å¯åŠ¨"><a href="#æ…¢å¯åŠ¨" class="headerlink" title="æ…¢å¯åŠ¨"></a>æ…¢å¯åŠ¨</h2><p>æ…¢å¯åŠ¨æ˜¯å»ºç«‹TCPè¿æ¥åï¼Œé‡‡ç”¨çš„ç¬¬ä¸€ä¸ªè°ƒæ•´å‘é€é€Ÿç‡çš„ç®—æ³•ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µï¼Œ<strong>cwndé€šå¸¸ä¼šè¢«åˆå§‹åŒ–ä¸º1MSS</strong>ï¼Œè¿™ä¸ªå€¼æ¯”è¾ƒå°ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ï¼Œç½‘ç»œä¸€èˆ¬è¿˜æœ‰è¶³å¤Ÿå¯Œä½™ï¼Œè€Œ<strong>æ…¢å¯åŠ¨çš„ç›®çš„å°±æ˜¯å°½å¿«æ‰¾åˆ°ä¸Šé™</strong>ã€‚åœ¨æ…¢å¯åŠ¨é˜¶æ®µï¼Œå‘é€æ–¹æ¯æ¥æ”¶åˆ°ä¸€ä¸ªç¡®è®¤æŠ¥æ–‡ï¼Œå°±ä¼šå°†å°†<strong>cwndçš„å¤§å°ç¿»å€</strong>ï¼Œå³ï¼š</p><ul><li><p>åˆå§‹çš„cwnd=1MSSï¼Œå‘é€ä¸€ä¸ªTCPæœ€å¤§æŠ¥æ–‡æ®µï¼ŒæˆåŠŸç¡®è®¤åï¼Œcwnd=2MSSã€‚</p></li><li><p>æ­¤æ—¶å¯ä»¥å‘é€ä¸¤ä¸ªTCPæœ€å¤§æŠ¥æ–‡æ®µï¼ŒæˆåŠŸç¡®è®¤åï¼Œcwnd=4MSSã€‚</p></li><li><p>æ­¤æ—¶å¯ä»¥å‘é€å››ä¸ªTCPæœ€å¤§æŠ¥æ–‡æ®µï¼ŒæˆåŠŸç¡®è®¤åï¼Œcwnd=8MSSã€‚</p></li><li><p>â€¦</p></li></ul><p>ç”±äºTCPæ˜¯ä¸€æ¬¡æ€§å°†çª—å£å†…çš„æ‰€æœ‰æŠ¥æ–‡å‘å‡ºï¼Œæ‰€ä»¥<strong>æ‰€æœ‰æŠ¥æ–‡åˆ°è¾¾å¹¶è¢«ç¡®è®¤çš„æ—¶é—´ï¼Œè¿‘ä¼¼ç­‰äºä¸€ä¸ªRTT</strong>ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ‹¥å¡çª—å£cwndçš„é•¿åº¦åœ¨æ¯ä¸ªRTTåç¿»å€ï¼Œå‘é€é€Ÿç‡ä¹Ÿæ˜¯å‘ˆæŒ‡æ•°å¢é•¿ã€‚<strong>ä¸è¦è¢«æ…¢å¯åŠ¨è¿™ä¸ªåå­—ç»™éª—äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä¸€ç‚¹ä¹Ÿä¸æ…¢</strong>ğŸ˜‚ã€‚è¿™ä¸ªé˜¶æ®µç»ˆç©¶ä¼šè§¦åˆ°ä¸€ä¸ªå‘é€çš„ä¸Šé™ï¼Œå½“é‡åˆ°ä»¥ä¸‹å‡ ç§æƒ…å†µæ—¶å€™ï¼Œcwnd å°†è¿›è¡Œè°ƒæ•´ä»¥é€‚åº”å½“å‰ç½‘ç»œã€‚</p><ol><li><p>åœ¨æ…¢å¯åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†<strong>æ•°æ®ä¼ è¾“è¶…æ—¶</strong>ï¼Œåˆ™æ­¤æ—¶<strong>TCPå°†ssthreshçš„å€¼è®¾ç½®ä¸º</strong><code>cwnd/2</code> ï¼Œç„¶åå°†<strong>cwndé‡æ–°è®¾ç½®ä¸º1MSS</strong>ï¼Œ<strong>é‡æ–°å¼€å§‹æ…¢å¯åŠ¨</strong>è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç†è§£ä¸ºè¯•æ¢ä¸Šé™ã€‚</p></li><li><p>ç¬¬ä¸€æ­¥è¯•æ¢å‡ºçš„ä¸Šé™ssthreshå°†ç”¨åœ¨æ­¤å¤„ã€‚<strong>è‹¥cwndçš„å€¼å¢åŠ åˆ° &gt;= ssthreshæ—¶</strong>ï¼Œæ­¤æ—¶è‹¥ç»§ç»­ä½¿ç”¨æ…¢å¯åŠ¨çš„ç¿»å€å¢é•¿æ–¹å¼ï¼Œå¿…ç„¶å¾ˆå¿«è¾¾åˆ°é€Ÿç‡ä¸Šé™å‡ºç°ç½‘ç»œæ‹¥å¡ã€‚æ‰€ä»¥ä¹Ÿå°±æ˜¯è¿™ä¸ªæ—¶å€™<strong>æ…¢å¯åŠ¨ç»“æŸï¼Œæ”¹ä¸ºæ‹¥å¡é¿å…æ¨¡å¼ã€‚</strong></p></li><li><p>è‹¥å‘é€æ–¹æ¥æ”¶åˆ°æŸä¸ªæŠ¥æ–‡çš„<strong>ä¸‰æ¬¡å†—ä½™ç¡®è®¤ï¼ˆè§¦å‘äº†å¿«é€Ÿé‡ä¼ æ¡ä»¶ï¼‰</strong>ï¼Œåˆ™<strong>è¿›å…¥åˆ°å¿«é€Ÿæ¢å¤é˜¶æ®µï¼ŒåŒæ—¶ ssthresh = cwnd / 2</strong>ï¼Œæ¯•ç«Ÿå‘ç”Ÿå¿«é€Ÿé‡ä¼ ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯å‘ç”Ÿæ‹¥å¡å¯¼è‡´çš„ä¸¢åŒ…ï¼Œæ­¤æ—¶å¯ä»¥è®¾ç½® <strong>cwd = ssthresh + 3MSS</strong>ã€‚</p></li></ol><p>ä»¥ä¸Šå°±æ˜¯æ…¢å¯åŠ¨ç®—æ³•ï¼ˆæ¨¡å¼ï¼‰çš„ä¸€äº›ç»†èŠ‚å’Œå¤„ç†ç‚¹ã€‚</p><h2 id="æ‹¥å¡é¿å…"><a href="#æ‹¥å¡é¿å…" class="headerlink" title="æ‹¥å¡é¿å…"></a>æ‹¥å¡é¿å…</h2><p>åœ¨æ…¢å¯åŠ¨é˜¶æ®µï¼Œå½“<code>cwnd &gt;= ssthresh</code>æ—¶å€™ï¼Œä¸ºäº†é¿å…å¾ˆå¿«æ¥è¿‘æ‹¥å¡é˜ˆå€¼ï¼Œæ…¢å¯åŠ¨ç»“æŸæ‹¥å¡æ§åˆ¶å¯åŠ¨ã€‚æ‹¥å¡é¿å…é˜¶æ®µæ˜¯ä¸€ä¸ªé€Ÿç‡æ…¢ä¸”çº¿æ€§å¢é•¿çš„è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œ<strong>æ¯ç»å†ä¸€ä¸ªRTTï¼Œcwndçš„å¤§å°å¢åŠ 1MSSã€‚</strong>è¿™ä¸ªçº¿æ€§å¢é•¿ä»€ä¹ˆæ—¶å€™ç»“æŸå‘¢ï¼Ÿåˆ†ä»¥ä¸‹ä¸¤ç§æƒ…å†µã€‚</p><ol><li>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­<strong>å‘ç”Ÿäº†è¶…æ—¶ï¼Œåˆ™è¡¨ç¤ºç½‘ç»œæ‹¥å¡</strong>ï¼Œè¿™ä¸ªæ—¶å€™ssthreshè¢«ä¿®æ”¹æˆ<code>cwnd/2</code>ï¼Œç„¶åcwndè¢«åªä¸º1MSSï¼Œå¹¶ä¸”è¿›å…¥æ…¢å¯åŠ¨é˜¶æ®µã€‚</li><li>è‹¥å‘é€æ–¹æ¥æ”¶åˆ°äº†<strong>æŸä¸ªæŠ¥æ–‡çš„ä¸‰æ¬¡å†—ä½™ç¡®è®¤</strong>ï¼ˆå³è§¦å‘äº†å¿«é€Ÿé‡ä¼ çš„æ¡ä»¶ï¼‰ï¼Œæ­¤æ—¶ä¹Ÿè®¤ä¸ºå‘ç”Ÿäº†æ‹¥å¡ï¼Œåˆ™ssthresh è¢«ä¿®æ”¹ä¸º cwnd/2ï¼Œç„¶åcwndè¢«è®¾ç½®ä¸º<strong>ssthresh + 3MSS</strong>ï¼Œå¹¶è¿›å…¥å¿«é€Ÿæ¢å¤é˜¶æ®µã€‚</li></ol><p>æ‹¥å¡é¿å…é˜¶æ®µæ˜¯åœ¨æ…¢å¼€å§‹ä¹‹åæå‡å‘é€é€Ÿç‡çš„é˜¶æ®µï¼Œè®©å‘é€é€Ÿç‡å°½å¯èƒ½ä¿æŒä¸€ä¸ªè¾ƒé«˜çš„æ°´å¹³ä¸Šã€‚ä¹Ÿå¯ä»¥ç†è§£ä¸ºé¿å…æ‹¥å¡çš„ç¼“æ…¢æç¥å‘é€é€Ÿç‡é˜¶æ®µã€‚</p><h2 id="å¿«é€Ÿæ¢å¤"><a href="#å¿«é€Ÿæ¢å¤" class="headerlink" title="å¿«é€Ÿæ¢å¤"></a>å¿«é€Ÿæ¢å¤</h2><p>å¿«é€Ÿæ¢å¤æ¨¡å¼å’Œä¸Šé¢ä¸¤ç§æ¨¡å¼ä¸å¤ªä¸€æ ·ï¼Œè¿™ç§æ¨¡å¼åœ¨TCPè§„èŒƒä¸­<strong>æ²¡æœ‰è¦æ±‚å¼ºåˆ¶å®ç°</strong>ï¼Œåªæ˜¯ä¸€ç§<strong>æ¨èå®ç°</strong>çš„æ¨¡å¼ã€‚åœ¨å¿«é€Ÿæ¢å¤é˜¶æ®µï¼Œ<strong>æ¯æ¥æ”¶åˆ°ä¸€ä¸ªå†—ä½™çš„ç¡®è®¤æŠ¥æ–‡ï¼Œcwndå°±å¢åŠ ä¸€ä¸ªMSS</strong>ï¼Œå…¶ä½™ä¸å˜ã€‚åœ¨å‘ç”Ÿä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼Œé€€å‡ºå¿«é€Ÿæ¢å¤æ¨¡å¼ã€‚</p><ul><li>åœ¨å¿«é€Ÿæ¢å¤è¿‡ç¨‹ä¸­ï¼Œ<strong>è®¡æ—¶å™¨è¶…æ—¶</strong>ï¼Œè¿™æ—¶å€™ï¼Œssthreshè¢«ä¿®æ”¹ä¸º<code>cwnd/2</code>ï¼Œç„¶åcwndè¢«è®¾ç½®ä¸º1MSSï¼Œå¹¶è¿›å…¥<strong>æ…¢å¯åŠ¨</strong>æ¨¡å¼ã€‚</li><li>è‹¥å‘é€æ–¹æ¥æ”¶åˆ°<strong>ä¸€æ¡æ–°çš„ç¡®è®¤æŠ¥æ–‡</strong>ï¼Œåˆ™cwndè¢«ç½®ä¸ºssthreshï¼Œç„¶åè¿›å…¥åˆ°<strong>æ‹¥å¡é¿å…</strong>æ¨¡å¼ã€‚</li></ul><p>è¿™å‡ ä¸ªç®—æ³•ä¼ è¾“é€Ÿç‡çš„å›¾å¦‚ä¸‹ï¼Œå…¶ä¸­è“è‰²çš„ä¼ ç»Ÿç®—æ³•çš„ç¬¬ä¸€æ®µï¼Œ0åˆ°16ä¸ºæ…¢å¯åŠ¨é˜¶æ®µï¼Œ16åˆ°20è¿™ä¸ªé˜¶æ®µä»¥1MSS/RTTå¢é€Ÿæå‡cwndå¤§å°ï¼Œæ©™è‰²çš„çº¿ä»£è¡¨å¿«é€Ÿæ¢å¤ç®—æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨10è¿™ä¸ªç‚¹å¦‚æœå‡ºç°äº†ä¸¢åŒ…åˆ™ä¼šè¿›å…¥ä¸‹é¢è“è‰²çš„å¿«å¯åŠ¨é˜¶æ®µï¼Œå¦‚æœå‡ºç°çš„æ˜¯å†—ä½™ç¡®è®¤ï¼Œè¿›å…¥çš„æ˜¯å¿«é€Ÿæ¢å¤çš„æ©™è‰²çº¿æ¡ï¼Œè¿™ä¸ªæ—¶å¯å§‹cwnd = (20/2) + 3 = 13ï¼Œå¹¶éšåè¿›å…¥æ‹¥å¡é¿å…é˜¶æ®µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210828185839.png"></p><h2 id="BBRç®—æ³•ä»‹ç»"><a href="#BBRç®—æ³•ä»‹ç»" class="headerlink" title="BBRç®—æ³•ä»‹ç»"></a>BBRç®—æ³•ä»‹ç»</h2><p>ä¸Šé¢çš„ç®—æ³•é€šè¿‡æ¥æ”¶ç«¯ä¸¢åŒ…å’Œå†—ä½™ACKåŒ…æ¥åˆ¤æ–­å½“å‰ç½‘ç»œçš„æ‹¥å¡æƒ…å†µï¼Œç„¶åè°ƒæ•´è‡ªå·±çš„å‘é€é€Ÿç‡ï¼Œå› æ­¤æœ‰äº†æ‹¥å¡æ§åˆ¶ç®—æ³•ï¼Œ<code>æ…¢å¯åŠ¨</code>ã€<code>æ‹¥å¡é¿å…</code>å’Œ<code>å¿«é€Ÿæ¢å¤</code>ç®—æ³•ï¼ˆæ¨¡å¼ï¼‰ã€‚ä½†æ˜¯è¿™æ ·çš„â€œçŸ¥è¿›é€€â€çš„ç®—æ³•ï¼Œåœ¨æŸäº›å»¶è¿Ÿå¾ˆé‡è¦çš„åœºæ™¯ä¸‹å´é™ä½äº†ä¼ è¾“é€Ÿç‡ã€‚TCPåˆ¤æ–­æ‹¥å¡çš„ä¸¤ä¸ªæ¡ä»¶æœ¬èº«ä¹Ÿæ˜¯ä¸å¤Ÿä¸¥è°¨çš„ã€‚</p><ul><li><strong>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯ä¸¢åŒ…ä¸ä¸€å®šå°±ä»£è¡¨ç½‘ç»œé€šé“æ»¡äº†</strong>ï¼Œå¯èƒ½æ•´ä¸ªé€šé“å°±æ˜¯æ¼æ°´çš„ã€‚æœ‰æ—¶å€™å…¬ç½‘ä¸Šå³æ—¶é€Ÿç‡è·‘ä¸æ»¡ï¼Œä¹Ÿä¼šå‘ç”Ÿä¸¢åŒ…çš„åœºæ™¯ï¼Œè¿™å¹¶ä¸ä»£è¡¨å‘ç”Ÿæ‹¥å¡äº†ã€‚</li><li><strong>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯TCPçš„æ‹¥å¡ç®—æ³•è¦ç­‰ä¸­é—´è®¾å¤‡å…¨éƒ¨éƒ½å¡«æ»¡äº†ï¼Œæ‰ä¼šå‘ç”Ÿä¸¢åŒ…</strong>ã€‚è¿™ä¸ªæ—¶å€™é™ä½é€Ÿç‡å·²ç»ä¸ºæ—¶å·²æ™šäº†ã€‚å…¶å®ä¼ è¾“çš„è¿‡ç¨‹ä¸­åªè¦è·‘æ…¢ç½‘ç»œä¼ è¾“çº¿è·¯å°±å¯ä»¥äº†ã€‚</li></ul><p>ä¸ºäº†ä¼˜åŒ–è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œåæ¥æœ‰äº† TCP BBR æ‹¥å¡ç®—æ³•ã€‚å®ƒä¼å›¾æ‰¾åˆ°ä¸€ä¸ª<strong>å¹³è¡¡ç‚¹</strong>ï¼Œé€šè¿‡ä¸æ–­åœ°åŠ å¿«å‘é€é€Ÿåº¦ï¼Œå°†ç®¡é“å¡«æ»¡ï¼Œä½†æ˜¯ä¸è¦å¡«æ»¡ä¸­é—´ä¸­é—´è®¾å¤‡çš„ç¼“å­˜ã€‚è¿™ä¸ªå¹³è¡¡ç‚¹å¯ä»¥å¾ˆå¥½çš„è¾¾åˆ°é«˜å¸¦å®½å’Œä½å»¶è¿Ÿçš„å¹³è¡¡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210828185909.png"></p><blockquote><p>æˆ‘ä»¬è¿™é‡Œåªæ˜¯å…¥é—¨ä»‹ç»BBRç®—æ³•è§£å†³çš„é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥é˜…è¯»BBRç®—æ³•æœ‰å…³è®ºæ–‡ã€‚</p><p><a href="https://queue.acm.org/detail.cfm?id=3022184">https://queue.acm.org/detail.cfm?id=3022184</a> ğŸ˜</p></blockquote><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬è¯¦ç»†æ€»ç»“äº†TCPåè®®çš„ç»†èŠ‚ï¼Œä»TCPçš„åè®®å¤´å¼€å§‹ï¼Œè¯¦ç»†ä»‹ç»äº†äº†åè®®å¤´é‡Œé¢çš„ä¸€äº›æ ‡è¯†ï¼Œé€šè¿‡è¿™äº›æ ‡è¯†çš„ç»´æŠ¤ï¼Œå®ç°TCPçš„è¿æ¥å»ºç«‹ä¸æ–­å¼€ï¼Œæµé‡æ§åˆ¶å’Œæ‹¥å¡æ§åˆ¶ç­‰åŠŸèƒ½ã€‚éšåæˆ‘ä»¬ä»‹ç»äº†TCPå¯é è¿æ¥çš„å»ºç«‹å’Œæ–­å¼€ï¼Œä»¥åŠä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æ¡æ‰‹çš„äº¤äº’ç»†èŠ‚ã€‚åœ¨å»ºç«‹è¿æ¥ä¹‹åæˆ‘ä»¬å¼€å§‹ä¼ è¾“æ•°æ®è¿›è¡Œæµé‡æ§åˆ¶ã€‚TCPä½¿ç”¨æ»‘åŠ¨çª—å£çš„æ¥å£ä½œä¸ºæµæ§çš„åŸºç¡€ã€‚TCPçš„å‘é€æ–¹éƒ½æœ‰ä¸€ä¸ªçª—å£ï¼Œå…¶ä¸­å‘é€æ–¹çš„çª—å£ä¾èµ–æ¥æ”¶æ–¹çª—å£å¤§å°åé¦ˆã€‚ é€šè¿‡è¿™ä¸ªçª—å£å¤§å°çš„çš„è°ƒæ•´ï¼Œå‘é€ç«¯è°ƒæ•´å‘é€ç«¯å‘é€é€Ÿç‡ï¼Œè§£å†³å‘é€ç«¯å‘é€é€Ÿç‡å’Œæ¥æ”¶ç«¯å‘é€é€Ÿç‡ä¸åŒ¹é…çš„é—®é¢˜ã€‚éšåæˆ‘ä»¬ä»‹ç»äº†æ»‘åŠ¨çª—å£çš„ç¡®è®¤å’Œåº”ç­”æœºåˆ¶ï¼Œå…¶ä¸­æœ‰<strong>ç´¯è®¡ç¡®è®¤ã€è¶…æ—¶é‡ä¼ å’Œå¿«é€Ÿé‡ä¼ </strong>ç­‰æœºåˆ¶ï¼Œç¡®ä¿äº†TCPä¼ è¾“çš„å¯é æ€§å’Œæ•°æ®åŒ…çš„é¡ºåºæ€§ã€‚æœ€ååœ¨æœ‰äº†ä»¥ä¸Šçš„åŸºç¡€ï¼Œæˆ‘ä»¬ä»‹ç»äº†é’ˆå¯¹ç½‘ç»œç¯å¢ƒçš„TCPæ‹¥å¡æ§åˆ¶ï¼Œå…¶ä¸­ä»‹ç»äº†ä¼ ç»Ÿç®—æ³•çš„å¿…é¡»å®ç°çš„æ…¢å¯åŠ¨ã€æ‹¥å¡é¿å…å’Œå¯é€‰å®ç°çš„å¿«é€Ÿæ¢å¤ã€‚é€šè¿‡è¿™ä¸¤å°èŠ‚çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªä»¥å¼€å‘ä¸­æ¥è§¦è¾ƒå¤šçš„åè®®ä¸ºæ ¸å¿ƒçš„ç½‘ç»œåŸºç¡€ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å°†è¿›å…¥ç½‘ç»œç¼–ç¨‹çš„å­¦ä¹ ï¼ŒåŠ æ²¹ï½</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li><p><a href="https://www.cnblogs.com/tuyang1129/p/12439862.html">è®¡ç®—æœºç½‘ç»œ-TCPçš„æ‹¥å¡æ§åˆ¶(è¶…è¯¦ç»†)</a></p></li><li><p><a href="https://time.geekbang.org/column/article/8590">æå®¢æ—¶é—´ä¸“æ ã€Šè¶£è°ˆç½‘ç»œåï¼ˆç¬¬å…«è®²ï¼‰ã€‹</a></p></li><li><p><a href="https://time.geekbang.org/column/article/8975">æå®¢æ—¶é—´ä¸“æ ã€Šè¶£è°ˆç½‘ç»œåï¼ˆç¬¬åä¸€è®²ï¼‰ã€‹</a></p></li><li><p><a href="https://time.geekbang.org/column/article/9141">æå®¢æ—¶é—´ä¸“æ ã€Šè¶£è°ˆç½‘ç»œåï¼ˆç¬¬åäºŒè®²ï¼‰ã€‹</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>NIOä¸ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ç½‘ç»œåŸºç¡€ â€” ç½‘ç»œæ¨¡å‹ä¸ç½‘ç»œåè®®</title>
    <link href="/2021/09/04/network-basic-1/"/>
    <url>/2021/09/04/network-basic-1/</url>
    
    <content type="html"><![CDATA[<h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>ä»è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬å¼€å§‹æ¢³ç†ç½‘ç»œç›¸å…³çš„çŸ¥è¯†ç»“æ„ã€‚ç½‘ç»œå¯¹äºç¨‹åºå‘˜éå¸¸é‡è¦ï¼Œå¯ä»¥è¯´ç¦»å¼€äº†ç½‘ç»œè½¯ä»¶ç¨‹åºå°±å¤±å»äº†70%çš„é­”åŠ›ã€‚ä½†æ˜¯ç¨‹åºå‘˜å¯¹äºç½‘ç»œç›¸å…³çš„é¢†åŸŸæ˜¯åˆçˆ±åˆæ¨ï¼Œçˆ±æ˜¯å› ä¸ºç½‘ç»œèµ‹äºˆç¨‹åºæ— é™çš„å¯èƒ½æ€§ï¼Œæ¨æ˜¯å› ä¸ºç½‘ç»œå¯¹è½¯ä»¶å¼€å‘æ¥è¯´å‡ ä¹æ˜¯é€æ˜çš„ï¼Œä¸ç”¨åˆ»æ„çš„å»è°ƒæ•´ç½‘ç»œï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è¿›è¡Œä¸šåŠ¡çš„å¼€å‘ã€‚æŒæ¡ç½‘ç»œç›¸å…³çš„çŸ¥è¯†å¹¶ä¸å®¹æ˜“ï¼Œç½‘ç»œç›¸å…³çš„é¢†åŸŸçš„çŸ¥è¯†å†…å®¹å¤æ‚ä¸”æ¶‰åŠèŒƒå›´å¹¿ã€‚å¯æ˜¯å¦‚æœè¦æˆä¸ºä¸€ä¸ªä¼˜ç§€çš„å¼€å‘å·¥ç¨‹å¸ˆï¼Œè¿›è¡Œç½‘ç»œç›¸å…³çš„å¼€å‘ï¼Œå°±å¿…é¡»å¯¹è¿™ä¸ªéƒ¨åˆ†æœ‰ä¸€ä¸ªæ¸…æ™°çš„ç»“æ„åŒ–çš„è®¤çŸ¥ã€‚è¿™ä¸€å°èŠ‚ï¼Œæˆ‘ä»¬ä¼šä»ç½‘ç»œçš„TCPäº”å±‚æ¨¡å‹å’ŒOSIä¸ƒå±‚ç»“æ„æ¨¡å‹å¼€å§‹æ¢³ç†ä»‹ç»ï¼Œéšåä»‹ç»æ¯ä¸€å±‚å’Œæ¯ä¸€å±‚å…·æœ‰ä»£è¡¨æ€§çš„ç½‘ç»œåè®®ï¼Œæœ€åæˆ‘ä»¬ç®€å•çš„èŠä¸€èŠä¸€ä¸ªæ•°æ®åŒ…æ˜¯æ€ä¹ˆåœ¨ç½‘ç»œä¸Šä¼ è¾“çš„ã€‚</p><h1 id="ç½‘ç»œæ¨¡å‹åŸºç¡€"><a href="#ç½‘ç»œæ¨¡å‹åŸºç¡€" class="headerlink" title="ç½‘ç»œæ¨¡å‹åŸºç¡€"></a>ç½‘ç»œæ¨¡å‹åŸºç¡€</h1><p>è¿™ä¸ªæ¨¡å‹æˆ‘ç›¸ä¿¡å¤§å®¶åœ¨å¤§å­¦éƒ½å­¦è¿‡ï¼ŒåŸºæœ¬ä¸Šç½‘ç»œçš„çŸ¥è¯†éƒ½æ˜¯å›´ç»•ç€è¿™ä¸ªç½‘ç»œç»“æ„å±•å¼€çš„ã€‚å…¶ä¸­æˆ‘ä»¬å­¦ä¹ è¿‡ä¸¤ç§ç½‘ç»œæ¨¡å‹ï¼Œä¸€ç§æ˜¯OSIä¸ƒå±‚æ¨¡å‹ï¼Œå¦å¤–ä¸€ç§æ˜¯TCP/IPäº”å±‚æ¨¡å‹ã€‚å…¶ä¸­OSIä¸ƒå±‚æ¨¡å‹åŒ…æ‹¬<strong>åº”ç”¨å±‚ã€è¡¨ç¤ºå±‚ã€ä¼šè¯å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚</strong>ã€‚è€ŒTCP/IPäº”å±‚æ¨¡å‹åŒ…æ‹¬<strong>åº”ç”¨å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚ã€‚</strong>OSIä¸ƒå±‚æ¨¡å‹æ›´åŠ ä¾§é‡åŠŸèƒ½ï¼Œè€ŒTCP/IPæ›´åŠ ä¾§é‡äºåè®®ã€‚</p><blockquote><p>OSIä¸ƒå±‚å’ŒTCP/IPäº”å±‚çš„åŒºåˆ«ï¼š</p><ol><li><p>TCP/IP æ˜¯ä¸€ä¸ªåè®®ç°‡ï¼›è€ŒOSIæ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œä¸”TCP/IPçš„å¼€å‘æ—¶é—´åœ¨OSIä¹‹å‰ã€‚</p></li><li><p>TCP/IPæ˜¯ç”±ä¸€äº›äº¤äº’æ€§çš„æ¨¡å—åšæˆçš„åˆ†å±‚æ¬¡çš„åè®®ï¼Œå…¶ä¸­æ¯ä¸ªæ¨¡å—æä¾›ç‰¹å®šçš„åŠŸèƒ½ï¼›OSIåˆ™æŒ‡å®šäº†å“ªä¸ªåŠŸèƒ½æ˜¯å±äºå“ªä¸€å±‚çš„ã€‚</p></li><li><p>TCP/IPæ˜¯äº”å±‚ç»“æ„ï¼Œè€ŒOSIæ˜¯ä¸ƒå±‚ç»“æ„ã€‚OSIçš„æœ€ä¸Šé¢çš„ä¸‰å±‚åœ¨TCPä¸­ç”¨åº”ç”¨å±‚è¡¨ç¤ºã€‚</p></li></ol></blockquote><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210813004056.png"></p><p>TCP/IPçš„äº”å±‚åˆ†åˆ«ä¸ºï¼š<strong>åº”ç”¨å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚ã€‚</strong>å‰é¢æˆ‘ä»¬æåˆ°TCP/IPäº”å±‚ç»“æ„æ˜¯ç”±ä¸€äº›äº¤äº’æ€§çš„æ¨¡å—åšæˆçš„åˆ†å±‚æ¬¡çš„åè®®ï¼Œé‚£ä¹ˆä»–ä»¬æ¯ä¸€å±‚æœ‰å“ªäº›åè®®ï¼Ÿä»¥ä¸‹åˆ—ä¸¾äº†æˆ‘ä»¬æ¥è§¦çš„æ¯”è¾ƒå¤šçš„ç½‘ç»œåè®®ã€‚</p><ul><li><p>åº”ç”¨å±‚ï¼š<code>HTTP</code>ã€<code>HTTPS</code>ã€<code>FTP</code>ã€<code>SMTP</code>ã€<code>Telnet</code>â€¦</p></li><li><p>ä¼ è¾“å±‚ï¼š<code>TCP</code>ã€<code>UDP</code></p></li><li><p>ç½‘ç»œå±‚ï¼š<code>IP</code>ã€<code>ICMP</code>â€¦</p></li><li><p>æ•°æ®é“¾è·¯å±‚ï¼š<code>ARP</code>â€¦</p></li><li><p>ç‰©ç†å±‚ï¼šâ€¦</p></li></ul><p>OSIä¸ƒå±‚æ¨¡å‹åˆ†ä¸ºï¼š<strong>åº”ç”¨å±‚ã€è¡¨ç¤ºå±‚ã€ä¼šè¯å±‚ã€ä¼ è¾“å±‚ã€ç½‘ç»œå±‚ã€æ•°æ®é“¾è·¯å±‚å’Œç‰©ç†å±‚</strong>ã€‚OSIæ›´åå‘å“ªä¸ªåŠŸèƒ½å±äºå“ªä¸€å±‚ã€‚é‚£ä¹ˆè¿™äº›ç½‘ç»œåŠŸèƒ½éƒ½åœ¨é‚£å±‚å‘¢ï¼Ÿ</p><ul><li><p>åº”ç”¨å±‚ï¼šæ–‡ä»¶ä¼ è¾“ã€ç”µå­é‚®ä»¶ã€æ–‡ä»¶æœåŠ¡ã€è™šæ‹Ÿç»ˆç«¯ç­‰ã€‚</p></li><li><p>è¡¨ç¤ºå±‚ï¼šæ•°æ®æ ¼å¼åŒ–ã€ä»£ç è½¬æ¢ã€æ•°æ®åŠ å¯†ã€‚</p></li><li><p>ä¼šè¯å±‚ï¼šè§£é™¤æˆ–å»ºç«‹ä¸å…¶ä»–æ¥ç‚¹çš„è”ç³»ã€‚</p></li><li><p>ä¼ è¾“å±‚ï¼šæä¾›ç«¯å¯¹ç«¯çš„æ¥å£ã€‚</p></li><li><p>ç½‘ç»œå±‚ï¼šä¸ºæ•°æ®åŒ…é€‰æ‹©è·¯ç”±ã€‚</p></li><li><p>æ•°æ®é“¾è·¯å±‚ï¼šä¼ è¾“æœ‰åœ°å€å¸§ï¼Œé”™è¯¯æ£€æµ‹çš„åŠŸèƒ½ã€‚</p></li><li><p>ç‰©ç†å±‚ï¼šä»¥äºŒè¿›åˆ¶æ•°æ®å½¢å¼åœ¨ç‰©ç†åª’ä½“ä¸Šä¼ è¾“æ•°æ®ã€‚</p></li></ul><p>å°†è¿™ä¸¤ä¸ªæ¨¡å‹æ€»ç»“æˆå¦‚ä¸‹è¡¨æ ¼ï¼š</p><table><thead><tr><th>OSIæ¨¡å‹</th><th>TCP/IPäº”å±‚æ¨¡å‹</th><th>åŠŸèƒ½</th><th>åè®®</th></tr></thead><tbody><tr><td>åº”ç”¨å±‚</td><td>åº”ç”¨å±‚</td><td>æ–‡ä»¶ä¼ è¾“ã€ç”µå­é‚®ä»¶ç­‰</td><td>HTTPã€FTPã€SMTPã€Telnetç­‰</td></tr><tr><td>è¡¨ç¤ºå±‚</td><td>æ•°æ®æ ¼å¼åŒ–ï¼Œä»£ç è½¬æ¢ï¼Œæ•°æ®åŠ å¯†</td><td>æ— </td><td></td></tr><tr><td>ä¼šè¯å±‚</td><td>å»ºç«‹æˆ–è€…è§£é™¤ä¸å…¶ä»–è¿æ¥ç‚¹çš„è”ç³»</td><td>æ— </td><td></td></tr><tr><td>ä¼ è¾“å±‚</td><td>ä¼ è¾“å±‚</td><td>æä¾›ç«¯å¯¹ç«¯çš„æ¥å£</td><td>UDPã€TCP</td></tr><tr><td>ç½‘ç»œå±‚</td><td>ç½‘ç»œå±‚</td><td>ä¸ºæ•°æ®åŒ…æä¾›è·¯ç”±</td><td>IPã€ICMPç­‰</td></tr><tr><td>æ•°æ®é“¾è·¯å±‚</td><td>æ•°æ®é“¾è·¯å±‚</td><td>ä¼ è¾“æœ‰åœ°å€å¸§ã€é”™è¯¯æ£€æµ‹</td><td>ARPç­‰</td></tr><tr><td>ç‰©ç†å±‚</td><td>ç‰©ç†å±‚</td><td>äºŒè¿›åˆ¶ç‰©ç†ä»‹è´¨ä¼ è¾“æ•°æ®</td><td>ISO2110ã€IEEE802ã€IEEE802.2ç­‰ç½‘ç»œä¼ è¾“åè®®</td></tr></tbody></table><h1 id="ä¸€ä¸ªæ•°æ®åŒ…çš„å¥‡å¹»ä¹‹æ—…"><a href="#ä¸€ä¸ªæ•°æ®åŒ…çš„å¥‡å¹»ä¹‹æ—…" class="headerlink" title="ä¸€ä¸ªæ•°æ®åŒ…çš„å¥‡å¹»ä¹‹æ—…"></a>ä¸€ä¸ªæ•°æ®åŒ…çš„å¥‡å¹»ä¹‹æ—…</h1><p>æˆ‘ä»¬ä¸Šé¢ä»‹ç»äº†ç½‘ç»œæ¨¡å‹ï¼Œä½†æ˜¯è¿™äº›ç½‘ç»œæ¨¡å‹åˆå’Œå®é™…çš„ä¼ è¾“æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªç½‘ç«™ï¼ŒèƒŒåçš„æ•°æ®åˆæ˜¯æ€ä¹ˆè¿›è¡Œä¼ è¾“çš„å‘¢ï¼Ÿæˆ‘åœ¨è¯»ä¹¦çš„æ—¶å€™ä¹Ÿéƒ½çŸ¥é“æœ‰ç½‘ç»œåè®®ï¼Œä½†æ˜¯è®©æˆ‘è¯´ä¸€äº›ä¼ è¾“çš„ç»†èŠ‚ï¼Œæˆ‘å´å¾ˆéš¾ç­”ä¸Šæ¥ï¼Œè¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸ªæ•°æ®åŒ…çš„ä¼ è¾“è¿‡ç¨‹ï¼Œå»ºç«‹èµ·ä¸€ä¸ªæ•°æ®ä¼ è¾“è¿‡ç¨‹çš„åŸºæœ¬è®¤çŸ¥ã€‚</p><h2 id="å°åŒ…ä¸æ‹†åŒ…"><a href="#å°åŒ…ä¸æ‹†åŒ…" class="headerlink" title="å°åŒ…ä¸æ‹†åŒ…"></a>å°åŒ…ä¸æ‹†åŒ…</h2><p>åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å¹¶ä¸æ˜¯ç›´æ¥çš„æ•°æ®ï¼Œè€Œæ˜¯ä¸€ä¸ªä¸ªæ•°æ®åŒ…ã€‚æ¯ä¸ªæ•°æ®åŒ…ç»è¿‡å‘é€ç«¯éƒ½ä¼šè¢«å¸¦ä¸Šä¸€äº›ç‰¹æ®Šä¿¡æ¯ï¼Œè¿™äº›ç‰¹æ®Šä¿¡æ¯åœ¨åˆ°è¾¾ä¸­é—´æˆ–ç›®æ ‡è®¾å¤‡æ˜¯ä¼šè¢«è¯»å–ï¼Œè¿™äº›ç‰¹æ®Šä¿¡æ¯å°±æ˜¯åè®®å¤´ã€‚<strong>æ•°æ®åŒ…åœ¨å‘é€ç«¯æ·»åŠ åè®®å¤´çš„è¿‡ç¨‹å«åšå°åŒ…</strong>ï¼Œ<strong>æ•°æ®åŒ…åœ¨æ¥æ”¶ç«¯è¢«æ‹†åˆ†è¯»å–åˆ†æçš„è¿‡ç¨‹å«åšæ‹†åŒ…</strong>ã€‚å¦‚æœæˆ‘ä»¬ä¼ è¾“çš„åº”ç”¨å±‚ä½¿ç”¨çš„æ˜¯HTTPåè®®ï¼Œä¼ è¾“è¿‡ç¨‹å’Œå°åŒ…æ‹†åŒ…ç¤ºä¾‹å¦‚ä¸‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210830001441.png"></p><h2 id="MACå¤´ä¸IPå¤´"><a href="#MACå¤´ä¸IPå¤´" class="headerlink" title="MACå¤´ä¸IPå¤´"></a>MACå¤´ä¸IPå¤´</h2><p>å¦‚æœæˆ‘ä»¬è¦æŠŠä¸€ä¸ªæ•°æ®åŒ…ä»ä¸€ä¸ªç½‘ç»œè®¾å¤‡å‘é€åˆ°å¦ä¸€ä¸ªç½‘ç»œè®¾å¤‡ï¼ŒIPå¤´å¿…ä¸å¯å°‘ï¼Œä½†æ˜¯ä¸ºäº†åœ¨åˆ°è¾¾ç›®æ ‡å±€åŸŸç½‘åå¿«é€Ÿæ‰¾åˆ°ç›®æ ‡æ¥æ”¶ç«¯ï¼Œæˆ‘ä»¬çš„æ•°æ®åŒ…è¿˜éœ€è¦MACå¤´ï¼ŒIPå¤´å’ŒMACä¹‹é—´çš„å…³ç³»ç±»ä¼¼äºæˆ‘ä»¬ä¿¡å°ä¸Šçš„æ”¶ä»¶åœ°å€å’Œæ”¶ä»¶äººå§“åã€‚æ•°æ®åŒ…æœ‰äº†è¿™ä¸¤ä¸ªåè®®å¤´ï¼Œå°±å¯ä»¥é€šè¿‡ç½‘ç»œä»ä¸€ç«¯ä¼ è¾“åˆ°å¦ä¸€ç«¯ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸¤ä¸ªåè®®å¤´çš„ç»†èŠ‚å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210830232718.png"></p><p>åœ¨MACå¤´é‡Œé¢ï¼Œæ˜¾ç¤º<strong>ç›®æ ‡MACåœ°å€</strong>ï¼Œç„¶åæ˜¯<strong>æºMACåœ°å€</strong>ï¼Œç„¶åæœ‰ä¸€ä¸ªåè®®ç±»å‹ï¼Œç”¨æ¥è¯´æ˜é‡Œé¢çš„IPåè®®ç±»å‹ã€‚IPå¤´é‡Œé¢çš„ç‰ˆæœ¬å·ï¼Œç›®å‰ä¸»æµçš„è¿˜æ˜¯IPv4ã€‚IPå¤´é‡Œé¢è¿˜æœ‰ä¸ª8ä½æ ‡è¯†åè®®ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ä¼ è¾“å±‚åè®®ç±»å‹ï¼Œä¹Ÿå°±æ˜¯TCPï¼Œè¿˜æ˜¯UPDåè®®ã€‚è¿™é‡Œæœ€é‡è¦çš„æ˜¯æºIPåœ°å€å’Œç›®æ ‡IPåœ°å€ã€‚ï¼ˆIPåè®®ä¸‹é¢æœ‰è¯¦ç»†ä»‹ç»ã€‚ï¼‰</p><p>åœ¨æ•°æ®åŒ…åœ¨ç½‘ç»œä¸Š<strong>ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªIPå¤´å’ŒMACå¤´åœ¨æœ‰äº›æ—¶å€™å¹¶ä¸æ˜¯ä¸€å°˜ä¸å˜çš„ï¼Œéšç€ç½‘æ®µçš„åˆ‡æ¢ï¼Œè¿™ä¸ªIPå¤´å’ŒMACå¤´ä¹Ÿä¼šåˆ‡æ¢ã€‚</strong>åœ¨ä»»ä½•ä¸€å°æœºå™¨ä¸Šï¼Œå½“è¦è®¿é—®å¦ä¸€ä¸ªIPåœ°å€çš„æ—¶å€™ï¼Œéƒ½å…ˆè¦åˆ¤æ–­ç›®æ ‡IPåœ°å€å’Œå½“å‰æœºå™¨çš„IPåœ°å€ï¼Œæ˜¯å¦åœ¨åŒä¸€ä¸ªç½‘æ®µã€‚</p><ul><li><strong>å¦‚æœåœ¨åŒä¸€ä¸ªç½‘æ®µ</strong>ï¼Œè¿™å°±å¥½æ¯”åœ¨å…¬å¸ä½ è®¿é—®ä½ æ—è¾¹åŒäº‹ç”µè„‘ä¸€æ ·ï¼Œè¿™é‡Œæ•°æ®åŒ…çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¸ç”¨è¿›è¿‡ç½‘å…³å°±èƒ½è®¿é—®ã€‚åœ¨å°åŒ…è¿‡ç¨‹ä¸­ï¼Œ<strong>ç›´æ¥å°†æºåœ°å€å’Œç›®æ ‡åœ°å€æ”¾å…¥IPå¤´ä¸­ï¼Œç„¶åé€šè¿‡ARPè·å¾—MACåœ°å€ï¼Œå°†æºå¤´MACå’Œç›®çš„MACåœ°å€æ”¾å…¥MACå¤´</strong>ï¼Œç„¶åå‘é€å‡ºå»å°±å¥½äº†ã€‚</li><li><strong>å¦‚æœä¸æ˜¯åŒä¸€ä¸ªç½‘å…³ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦å…ˆæŠŠæ•°æ®åŒ…å‘ç»™ç½‘å…³Gateway</strong>ã€‚ç½‘å…³Gatewayåœ°å€ä¸€å®šæ˜¯å’ŒæºIPåœ°å€æ˜¯åŒä¸€ä¸ªç½‘æ®µçš„ã€‚å¾€å¾€ä¸æ˜¯ç¬¬ä¸€ä¸ªåœ°å€å°±æ˜¯ç¬¬äºŒä¸ªåœ°å€ã€‚</li></ul><blockquote><p>ç½‘å…³æ˜¯ä¸€ä¸ªä¸‰å±‚è½¬å‘è®¾å¤‡ï¼Œå¾€å¾€æ˜¯ä¸€ä¸ª<strong>è·¯ç”±å™¨ã€ä¸‰å±‚äº¤æ¢æœºæˆ–æ˜¯é˜²ç«å¢™ã€‚å®ƒæ˜¯ä¸€ä¸ªç½‘æ®µçš„å…¥å£ä¹Ÿæ˜¯å‡ºå£</strong>ï¼Œå°±å¾ˆç±»ä¼¼ä¸æˆ‘ä»¬ç°å®ç”Ÿæ´»ä¸­çš„æµ·å…³ï¼Œè¿™ä¸ªå‡ºå£<strong>è¿æ¥ç€å¤šä¸ªç½‘æ®µ</strong>ã€‚å¦‚æœä¸€ä¸ª<strong>æ•°æ®åŒ…ä¼ è¾“è¿‡ç¨‹ä¸­è·¨ç½‘æ®µ</strong>ï¼Œç½‘å…³<strong>åŒ¹é…ä¸Š</strong>IPåœ°å€å’ŒMACåœ°å€ä¹‹åï¼Œ<strong>ä¸‰å±‚è®¾å¤‡ä¼šè¯»å–æ•°æ®åŒ…å¹¶æ ¹æ®ç›®æ ‡IPåœ°å€</strong>ï¼ŒåŒ¹é…è½¬å‘çš„ç½‘æ®µï¼ŒåŒ¹é…åˆ°ä¹‹åï¼Œä¸‰å±‚è®¾å¤‡ä¼š<strong>é‡æ–°ç»™æ•°æ®åŒ…æ‰“ä¸Šä¸‹ä¸€ä¸ªç›®æ ‡åœ°å€çš„IPå¤´å’ŒMACå¤´</strong>ç›´åˆ°è·³åˆ°ç›®æ ‡è®¾å¤‡æˆ–åœ¨ç½‘ç»œä¸­è¢«ä¸¢å¼ƒä¸ºæ­¢ã€‚</p></blockquote><h2 id="è·¯ç”±è¿‡ç¨‹åˆ†æ"><a href="#è·¯ç”±è¿‡ç¨‹åˆ†æ" class="headerlink" title="è·¯ç”±è¿‡ç¨‹åˆ†æ"></a>è·¯ç”±è¿‡ç¨‹åˆ†æ</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡åˆ†æåœ¨åŒä¸€ç½‘æ®µå’Œåœ¨ä¸åŒç½‘æ®µåœºæ™¯ä¸‹ï¼Œæ•°æ®åŒ…åœ¨ç½‘ç»œä¸­çš„è·¯ç”±è¿‡ç¨‹æ˜¯æ€æ ·ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ•°æ®åŒ…çš„IPå¤´å’ŒMACå¤´åˆä¼šå‘ç”Ÿå“ªäº›å˜åŒ–ã€‚</p><h3 id="è½¬å‘ç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ"><a href="#è½¬å‘ç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ" class="headerlink" title="è½¬å‘ç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ"></a>è½¬å‘ç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ</h3><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210904143156.png"></p><p>ä¸Šé¢è¿™å¼ å›¾ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°æœåŠ¡å™¨Aè¦è®¿é—®æœåŠ¡å™¨Bï¼Œå…¶ä¸­å·¦è¾¹çš„è·¯ç”±å™¨ä¸ºè·¯ç”±å™¨Aï¼Œå³ä¾§çš„è·¯ç”±å™¨ä¸ºè·¯ç”±å™¨Bã€‚ç›®æ ‡æœåŠ¡å™¨<code>192.168.4.101/24</code>å’ŒæºæœåŠ¡å™¨<code>192.168.1.101/24</code>ä¸åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œå› è€Œéœ€è¦å…ˆæŠŠæ•°æ®åŒ…å‘é€ç»™ç½‘å…³ã€‚å…¶ä¸­ç½‘å…³å·²ç»é…ç½®å¥½äº†ä¸º<code>192.168.1.1/24</code>ï¼ŒåŒæ—¶é€šè¿‡<code>ARP</code>è·å–ç½‘å…³çš„MACåœ°å€ ï¼Œç„¶åå‘é€æ•°æ®åŒ…ã€‚å…¶ä¸­åŒ…ä¸­çš„MACå¤´å’ŒIPå¤´ä¿¡æ¯å¦‚ä¸‹ã€‚</p><blockquote><ul><li><p>æºMACï¼šæœåŠ¡å™¨çš„Açš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.1.1</code>è¿™ä¸ªç½‘å£çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.1.101</code></p></li><li><p>ç›®æ ‡IP: <code>192.168.4.101</code></p></li></ul></blockquote><p>å½“æ•°æ®åŒ…åˆ°è¾¾ç½‘å…³<code>192.168.1.1</code>åï¼Œè·¯ç”±å™¨Aé€šè¿‡æŸ¥è¯¢è·¯ç”±è¡¨å‘ç°ï¼Œå¦‚æœéœ€è¦è®¿é—®<code>192.168.4.101</code>éœ€è¦ä»<code>192.168.56.1</code>è¿™ä¸ªå£å‡ºå»ï¼Œåˆ°è¾¾ä¸‹ä¸€è·³<code>192.168.56.2</code>ã€‚å› æ­¤è·¯ç”±å™¨é€šè¿‡ARPè·å¾—<code>192.168.56.2</code>çš„MACåœ°å€ï¼Œå¹¶å°†åŒ…å‘å‡ºå»ï¼Œå…¶ä¸­åŒ…ä¸­çš„MACå¤´å’ŒIPå¤´ä¿¡æ¯å¦‚ä¸‹ï¼š</p><blockquote><ul><li><p>æºMACï¼š<code>192.168.56.1</code>çš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.56.2</code>çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.1.101</code></p></li><li><p>ç›®æ ‡IP: <code>192.168.4.101</code></p></li></ul></blockquote><p>å½“æ•°æ®åŒ…åˆ°è¾¾<code>192.168.56.2</code>è¿™ä¸ªç½‘å£ï¼Œåæ¥è·¯ç”±Bé€šè¿‡æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œå¦‚æœæƒ³è¦<code>192.168.4.101/24</code>ç›®æ ‡IPï¼Œéœ€è¦ä»<code>192.168.4.1/24</code>è¿™ä¸ªå£å‡ºå»å¹¶ä¸”ç›®æ ‡IPä¹Ÿæ˜¯æˆ‘ä»¬è¦åé—®çš„æœåŠ¡å™¨Bï¼Œå› æ­¤è¿™ä¸€è·³ä¹Ÿæ˜¯æœ€åä¸€è·³ã€‚é€šè¿‡ARPåè®®è·å–<code>192.168.4.1/24</code>çš„MACåœ°å€åæŠŠæ•°æ®åŒ…å‘å‡ºå»ï¼Œå…¶ä¸­åŒ…ä¸­çš„MACå¤´ä¿¡æ¯å’ŒIPå¤´ä¿¡æ¯å¦‚ä¸‹ï¼š</p><blockquote><ul><li><p>æºMACï¼š<code>192.168.4.1/24</code> çš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.4.101/24</code> çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.1.101</code></p></li><li><p>ç›®æ ‡IP: <code>192.168.4.101</code></p></li></ul></blockquote><p>é€šè¿‡è¿™ä¸ªè¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œæ¯åˆ°ä¸€ä¸ªæ–°çš„å±€åŸŸç½‘ï¼Œ<strong>MACåœ°å€éƒ½æ˜¯è¦å˜çš„ï¼Œä½†æ˜¯IPåœ°å€ä¸å˜</strong>ã€‚åœ¨IPå¤´é‡Œé¢ï¼Œä¸ä¼šä¿å­˜ä»»ä½•ç½‘å…³çš„IPåœ°å€ï¼Œ<strong>æ‰€è°“ä¸‹ä¸€è·³ï¼Œæ˜¯è¦å°†ç›®æ ‡IPè½¬æ¢ä¸ºMACåœ°å€æ”¾å…¥MACå¤´ï¼Œç›®æ ‡IPåœ°å€åœ¨æ•´ä¸ªè¿‡ç¨‹è¿‡ç¨‹ä¸­ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</strong>è¿™æ˜¯è½¬å‘ç½‘å…³çš„è·¯ç”±è¿‡ç¨‹ã€‚</p><h3 id="NATç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ"><a href="#NATç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ" class="headerlink" title="NATç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ"></a>NATç½‘å…³è·¯ç”±åœºæ™¯åˆ†æ</h3><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210904143249.png"></p><p>è¿™ä¸ªåœºæ™¯å’Œä¸Šé¢åœºæ™¯æœ‰ä¸€äº›ä¸åŒï¼Œå…¶ä¸­è®¿é—®çš„æºæœåŠ¡å™¨Aå’Œç›®æ ‡çš„æœåŠ¡å™¨Bçš„IPåœ°å€æ˜¯ç›¸åŒçš„ã€‚ä»–ä»¬ä¸¤ä¸ªåœ¨ä¸åŒçš„å±€åŸŸç½‘ä¸­ï¼Œè¿™ä¸ªåœºæ™¯å¾ˆåƒæˆ‘æ—¥å¸¸è®¿é—®å­¦æ ¡é€‰è¯¾ç³»ç»Ÿä¸€æ ·ã€‚æœåŠ¡å™¨Aæ˜¯æˆ‘ä»¬è‡ªå·±ç”µè„‘ï¼Œç°åœ¨æˆ‘ä»¬è¦è®¿é—®å­¦æ ¡çš„é€‰è¯¾ç³»ç»Ÿï¼Œé€‰è¯¾ç³»ç»Ÿéƒ¨ç½²åœ¨æœºæˆ¿çš„å±€åŸŸç½‘ä¸­ï¼Œé€‰è¯¾ç³»ç»ŸæœåŠ¡å™¨Bçš„IPåœ°å€ä¸º<code>192.168.1.101/24</code>ï¼Œç¢°å·§æˆ‘ä»¬å®¿èˆçš„ç”µè„‘åœ¨å®¿èˆè¿™ä¸ªå±€åŸŸç½‘å†…ä¹Ÿæ˜¯<code>192.168.1.101/24</code>è¿™ä¸ªIPåœ°å€ã€‚<strong>å®ƒä¸ºäº†èƒ½å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿˜éœ€è¦ä¸€ä¸ªå¤–ç½‘åœ°å€</strong><code>192.168.56.2/24</code>ã€‚ç°åœ¨æˆ‘ä»¬æœåŠ¡å™¨Aè¦å‘æœåŠ¡å™¨Bå‘é€æ•°æ®åŒ…ï¼Œé¦–å…ˆæœåŠ¡å™¨Aå…ˆä»DNSè§£æè·å–æœåŠ¡å™¨BåŸŸåå¯¹åº”çš„IPåœ°å€å³<code>192.168.56.2/24</code>ã€‚è¿™ä¸ªåœ°å€ä¸æ˜¯å’ŒæœåŠ¡å™¨Aåœ¨ä¸€ä¸ªå±€åŸŸç½‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ•°æ®åŒ…å‘é€ç»™ç½‘å…³ã€‚æ•°æ®åŒ…ä¸­çš„IPåœ°å€å’ŒMACåœ°å€å¦‚ä¸‹ï¼š</p><blockquote><ul><li><p>æºMACï¼šæœåŠ¡å™¨çš„Açš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.1.1</code>è¿™ä¸ªç½‘å£çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.1.101</code></p></li><li><p>ç›®æ ‡IP: <code>192.168.56.2</code></p></li></ul></blockquote><p>æ•°æ®åŒ…åˆ°è¾¾ç½‘å…³<code>192.168.1.1</code>åï¼Œé€šè¿‡æŸ¥è¯¢è·¯ç”±è¡¨ï¼Œåº”è¯¥èµ°<code>192.168.56.1/24</code>è¿™ä¸ªå£å‡ºå»ï¼Œå¹¶ä¸”ç›®æ ‡<code>192.168.56.2</code>å°±æ˜¯ä¸‹ä¸€è·³ã€‚é€šè¿‡ARPè·å–åˆ°<code>192.168.56.2/24</code>çš„MACåœ°å€ï¼Œå¹¶ä¸”å°†æ•°æ®åŒ…å‘é€å‡ºå»ã€‚</p><blockquote><p> è¿™é‡Œéœ€è¦æ³¨æ„âš ï¸ï¼Œè¿™é‡Œæˆ‘ä»¬çš„ç½‘å…³æ˜¯NATç½‘å…³ï¼Œåœ¨å¤–ç½‘ä¸Šä¼ è¾“å¦‚æœä½¿ç”¨<code>192.168.1.101</code>å±€åŸŸç½‘çš„IPåœ°å€ï¼Œæ¥æ”¶ç«¯æ— æ³•çŸ¥é“é€šè¿‡ä¸€ä¸ªå±€åŸŸç½‘çš„IPåœ°å€å®šä½åˆ°å‘é€ç«¯ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çš„æºIPåœ°å€åº”è¯¥æ˜¯NATç½‘å…³çš„åœ°å€ï¼Œ<strong>å›æ¥çš„æ•°æ®åŒ…å‘é€åˆ°è¿™ä¸ªç½‘å…³åªè¦é€šè¿‡ä¸€å®šçš„æ˜ å°„å…³ç³»å°±èƒ½æ‰¾åˆ°å›æ¥çš„æ•°æ®åŒ…ä¸­çš„IPåœ°å€å¯¹åº”çš„æœåŠ¡å™¨ã€‚è¿™ä¹Ÿå°±æ˜¯NATç½‘å…³çš„ç‰¹æ®Šä¹‹å¤„ï¼Œå…¶ä¸­NATçš„å…¨ç§°ä¸ºï¼ˆNetwork Address Translationï¼‰ã€‚</strong></p></blockquote><p>è¿™é‡Œæˆ‘ä»¬çš„æ•°æ®åŒ…çš„å¤´ä¿¡æ¯å¦‚ä¸‹ï¼Œä¸éš¾å‘ç°è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æºIPåœ°å€å’ŒMACåœ°å€å·²ç»å˜æˆäº†NATç½‘å…³Açš„IPåœ°å€å’ŒMACåœ°å€ã€‚</p><blockquote><ul><li><p>æºMACï¼š<code>192.168.56.1/24</code>çš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.56.2/24</code>çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.56.1</code></p></li><li><p>ç›®æ ‡IPï¼š<code>192.168.56.2</code></p></li></ul></blockquote><p>åŒ…åˆ°è¾¾<code>192.168.56.2</code>NATç½‘å…³ä¹‹åï¼Œ<code>192.168.56.2</code>çš„å¤–ç½‘åœ°å€æ˜ å°„çš„æ˜¯å†…ç½‘æœåŠ¡å™¨Bçš„åœ°å€ä¸º<code>192.168.1.101/24</code>ï¼Œé€šè¿‡ARPè·å–æœåŠ¡å™¨Bçš„MACåœ°å€ä¹‹åï¼Œå°†æ•°æ®åŒ…å‘é€ç»™æœåŠ¡å™¨Bï¼Œæ³¨æ„è¿™é‡Œçš„ç½‘å…³æ˜¯NATç½‘å…³ï¼Œæ‰€ä»¥è¿™é‡Œçš„<strong>æºçš„MACåœ°å€ä¼šæ›¿æ¢æˆå±€åŸŸç½‘çš„NATç½‘å…³MACåœ°å€</strong>ï¼Œå…¶ä¸­æ•°æ®åŒ…ä¸­å¤´ä¿¡æ¯å¦‚ä¸‹ï¼š</p><blockquote><ul><li><p>æºMACï¼š<code>192.168.1.1</code> çš„MACåœ°å€ã€‚</p></li><li><p>ç›®æ ‡MACï¼š<code>192.168.1.101 </code>çš„MACåœ°å€ã€‚</p></li><li><p>æºIPï¼š<code>192.168.56.1</code></p></li><li><p>ç›®æ ‡IPï¼š<code>192.168.1.101</code></p></li></ul></blockquote><p>è‡³æ­¤ï¼ŒNATç½‘å…³çš„è·¯ç”±åœºæ™¯è·¯ç”±ç»“æŸäº†ã€‚æˆ‘ä»¬ä»”ç»†è§‚å¯Ÿä¸éš¾å‘ç°ï¼ŒNATç½‘å…³å’Œè½¬å‘ç½‘å…³çš„åŒºåˆ«åœ¨äºNATä¼šåšIPåœ°å€çš„æ˜ å°„è½¬æ¢ï¼Œå¯ä»¥è®©å¤šä¸ªè®¾å¤‡é€šè¿‡ä¸€ä¸ªIPåœ°å€è¿›è¡Œæ•°æ®è®¿é—®ã€‚æå¤§äº†è§£å†³äº†IPv4åœ°å€æ€»é‡ä¸è¶³çš„é—®é¢˜ã€‚ä½†æ˜¯æ­£æ˜¯NATç½‘å…³çš„å­˜åœ¨ï¼Œè¿™å¯¼è‡´å¦‚æœæˆ‘ä»¬æ²¡æœ‰å°†æœåŠ¡åœ°å€æ˜ å°„åˆ°å…¬ç½‘ä¸Šï¼Œæˆ‘ä»¬å°±æ— æ³•é€šè¿‡å¤–ç½‘ç›´æ¥è®¿é—®æˆ‘ä»¬ç§äººæœåŠ¡ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è®¿é—®å¤–ç½‘æœåŠ¡ï¼Œä¸€ä¸ªå±€åŸŸç½‘å†…çš„è®¾å¤‡ä½¿ç”¨çš„éƒ½æ˜¯ä¸€ä¸ªIPåœ°å€ï¼Œå³å‡ºå£NATç½‘å…³åœ°å€ã€‚</p><blockquote><p> è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ³¨æ„çš„ç‚¹ï¼šNATè½¬æ¢çš„æ—¶å€™è¿˜æœ‰ä¸€ä¸ªNAPTåè®®ï¼Œå³<strong>Network Address Port Translation</strong>ï¼Œæ•°æ®åŒ…å‘å‡ºçš„æ—¶å€™ï¼ŒNATè·¯ç”±ä¼šå°†æ•°æ®åŒ…ä¸­çš„<strong>å±€åŸŸç½‘IPå’Œç«¯å£</strong>è½¬æ¢ä¸º<strong>NATçš„å…¬å…±IPå’ŒNATåŠ¨æ€åˆ†é…çš„ç«¯å£</strong>ï¼Œå¹¶ä¸”å»ºç«‹æ˜ å°„å…³ç³»ã€‚ç­‰æ•°æ®åŒ…å›æ¥çš„æ—¶å€™ï¼ŒNATè·¯ç”±ä¼š<strong>ä¾æ®è¿™ä¸ªè½¬æ¢åçš„NATåŠ¨æ€ç«¯å£</strong>è½¬æ¢ä¸ºå±€åŸŸç½‘çš„IPåœ°å€å’Œç«¯å£ã€‚</p><p>æ•°æ®åŒ…å‡ºï¼š <strong>å±€åŸŸç½‘IP:ç«¯å£ ==NAT==&gt; NATå…¬å…±IP:åŠ¨æ€ç«¯å£</strong>ã€‚</p><p>æ•°æ®åŒ…å…¥ï¼š <strong>NATå…¬å…±IP:åŠ¨æ€ç«¯å£ ==NAT ==&gt; å±€åŸŸç½‘IP:ç«¯å£</strong>ã€‚</p></blockquote><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ²¡æœ‰ä»‹ç»çš„ç‚¹ï¼Œå°±æ˜¯æˆ‘ä»¬çš„<code>è·¯ç”±ç­–ç•¥</code>å’Œ<code>è·¯ç”±ç®—æ³•</code>ï¼Œå…¶ä¸­æœ‰æˆ‘ä»¬å¯ä»¥é…ç½®çš„é™æ€è·¯ç”±ç­–ç•¥å’Œåœ¨è·¯ç”±è¿‡ç¨‹ä¸­çš„åŠ¨æ€è·¯ç”±ç®—æ³•ã€‚å¦‚æœæœ‰æ„Ÿå…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥æŸ¥è¯¢æœ‰å…³èµ„æ–™æ·±å…¥ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œå±•å¼€äº†åˆèƒ½è®²ä¸€å¤§å †äº†ã€‚ğŸ˜…ğŸ˜…</p><h1 id="åè®®ï¼Ÿä½ æˆ‘ä¹‹é—´çš„çº¦å®šï¼"><a href="#åè®®ï¼Ÿä½ æˆ‘ä¹‹é—´çš„çº¦å®šï¼" class="headerlink" title="åè®®ï¼Ÿä½ æˆ‘ä¹‹é—´çš„çº¦å®šï¼"></a>åè®®ï¼Ÿä½ æˆ‘ä¹‹é—´çš„çº¦å®šï¼</h1><p>æˆ‘åˆšå¼€å§‹æ¥è§¦åˆ°åè®®çš„æ—¶å€™ï¼Œäº†è§£åˆ°ä»€ä¹ˆTCP/IPåè®®ï¼ŒUDPåè®®å„ç§å„æ ·çš„åè®®éƒ½æœ‰ç§ä¸æ˜è§‰å‰çš„æ„Ÿè§‰ã€‚ä½†æ˜¯éšç€æˆ‘æ·±å…¥çš„å­¦ä¹ ï¼Œç¼–å†™è‡ªå·±çš„RPCçš„ç½‘ç»œåè®®çš„æ—¶å€™ï¼Œå‘ç°åè®®å¹¶æ²¡æœ‰æƒ³è±¡ä¸­çš„é‚£ä¹ˆç¥ç§˜ï¼Œåè®®åªä¸è¿‡æ˜¯æ”¶å‘ç«¯çº¦å®šçš„è§„åˆ™è€Œå·²ï¼Œæ›´åƒæ˜¯æˆ‘ä»¬å†™ä¿¡ä¸­ï¼Œå¤§å®¶çº¦å®šçš„ä¹¦ä¿¡æ ¼å¼ä¸€æ ·ã€‚æ²¡äº†åè®®åŒæ–¹ç½‘ç»œèƒ½é€šä¹ˆï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡æˆ‘ä¸çŸ¥é“ä½ å‘çš„æ˜¯ä»€ä¹ˆä¿¡æ¯äº†ã€‚å› æ­¤æˆ‘ä»¬è¿™çš„åè®®æ˜¯ç½‘ç»œåè®®çš„ç®€ç§°ï¼Œ<strong>ç½‘ç»œé€šä¿¡è®¡ç®—æœºåŒæ–¹å¿…é¡»å…±åŒéµå¾ªçš„ä¸€ç»„çº¦å®š</strong>ï¼Œå¦‚æ€æ ·å»ºç«‹è¿æ¥ã€æ€ä¹ˆæ ·äº’ç›¸è¯†åˆ«ç­‰ã€‚åªæœ‰éµå®ˆäº†è¿™ä¸ªçº¦å®šï¼Œè®¡ç®—æœºä¹‹é—´æ‰èƒ½äº’ç›¸é€šä¿¡äº¤æµã€‚æˆ‘ä»¬å°†ä»æ•°æ®é“¾è·¯å±‚è‡ªä¸‹å‘ä¸Šä¾æ¬¡æ¢³ç†å„ä¸ªå±‚ä»£è¡¨åè®®ã€‚ç‰©ç†å±‚è¿‡äºç‰©ç†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸æ¢³ç†äº†ã€‚</p><h2 id="æ•°æ®é“¾è·¯å±‚"><a href="#æ•°æ®é“¾è·¯å±‚" class="headerlink" title="æ•°æ®é“¾è·¯å±‚"></a>æ•°æ®é“¾è·¯å±‚</h2><p>æ•°æ®é“¾è·¯å±‚ä¹Ÿå«MACå±‚ï¼ŒMACå±‚çš„å…¨ç¨‹æ˜¯<strong>Medium Access Control</strong>ï¼Œå³åª’ä½“è®¿é—®æ§åˆ¶ã€‚<strong>å…¶å®å°±æ˜¯æ§åˆ¶åª’ä½“ä¸Šå‘æ•°æ®çš„æ—¶å€™ï¼Œè°å…ˆå‘ã€è°åå‘çš„é—®é¢˜ã€‚é˜²æ­¢å‘ç”Ÿæ··ä¹±ï¼Œå³å¤šè·¯è®¿é—®</strong>ã€‚ä¸»è¦æœ‰ä»¥ä¸‹ä¸‰ç§åè®®ï¼š<strong>ä¿¡é“åˆ’åˆ†</strong>ã€<strong>è½®æµåè®®</strong>å’Œ<strong>éšæœºæ¥å…¥åè®®</strong>ã€‚</p><h3 id="ARPåè®®"><a href="#ARPåè®®" class="headerlink" title="ARPåè®®"></a>ARPåè®®</h3><p>ARPåè®®æ˜¯ä¸€ä¸ªå·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚çš„åè®®ã€‚ARPåè®®è§£å†³äº†ä»€ä¹ˆæ ·é—®é¢˜å‘¢ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“åœ¨ç½‘ç»œåŒ…ä¼ è¾“éœ€è¦ä¸€ä¸ªIPåœ°å€å’Œä¸€ä¸ªMACï¼Œå¦‚æœIPåœ°å€å¯ä»¥ç±»æ¯”æˆä½ çš„åœ°å€ï¼ŒMACåœ°å€å°±æ˜¯ä½ çš„åå­—ã€‚IPåœ°å€æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥è¯¢DNSæœåŠ¡å™¨è·å¾—ï¼Œé‚£ä¹ˆMACåœ°å€æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªæ—¶å€™å°±éœ€è¦ARPåè®®ã€‚<strong>é€šè¿‡IPåè®®è·å–ç›®æ ‡è®¾å¤‡çš„MACåœ°å€ï¼Œè¿™å°±æ˜¯ARPåè®®çš„å·¥ä½œç›®æ ‡ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210814144601.png"></p><p>é‚£å¦‚æœå¦‚æœé€šè¿‡IPåœ°å€è·å–çš„ç›®æ ‡çš„MACåœ°å€å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œ<strong>åœ¨å±€åŸŸç½‘ä¸­å‘é€ä¸€ä¸ªARPè¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚æ˜¯ä»¥å¹¿æ’­çš„å½¢å¼å‘å‡ºå»çš„ï¼Œå¦‚æœæŸä¸€å°æœºå™¨æ”¶åˆ°ARPè¯·æ±‚ï¼Œå¹¶ä¸”å‘ç°è¦æŸ¥è¯¢çš„IPåœ°å€å’Œè‡ªå·±çš„ä¸€è‡´ï¼Œåˆ™è¿”å›è‡ªå·±çš„MACåœ°å€</strong>ã€‚å‘é€ç«¯æ”¶åˆ°è¿™ä¸ªç›®æ ‡æœºå™¨çš„MACåœ°å€åï¼Œä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¦å‘ARPåŒ…è¯¢é—®MACåœ°å€ï¼Œå‘é€ç«¯ä¼šå°†è¿™ä¸ªåœ°å€ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œæ–¹ä¾¿åç»­çš„ä½¿ç”¨ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210814145303.png"></p><p>å…¶ä¸­ARPåè®®å‘é€çš„æŠ¥æ–‡ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210814145551.png"></p><h2 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h2><p>ç½‘ç»œå±‚æ˜¯OSIæ¨¡å‹ä¸­çš„ç¬¬ä¸‰å±‚ï¼Œä»‹äºä¼ è¾“å±‚å’Œæ•°æ®é“¾è·¯å±‚ä¹‹é—´ï¼Œå®ƒåœ¨æ•°æ®é“¾è·¯å±‚æä¾›çš„ä¸¤ä¸ªç›¸é‚»ç«¯ç‚¹ä¹‹é—´çš„<strong>æ•°æ®å¸§</strong>çš„ä¼ è¾“åŠŸèƒ½ä¸Šï¼Œè¿›ä¸€æ­¥ç®¡ç†ç½‘ç»œä¸­çš„æ•°æ®é€šä¿¡ï¼Œå°†æ•°æ®è®¾æ³•ä»æºç«¯ç»è¿‡è‹¥å¹²ä¸ªä¸­é—´èŠ‚ç‚¹ä¼ è¾“åˆ°ç›®çš„åœ°ç«¯ï¼Œä»è€Œ<strong>å‘ä¼ è¾“å±‚æä¾›åŸºæœ¬çš„ç«¯åˆ°ç«¯çš„æ•°æ®ä¼ è¾“æœåŠ¡</strong>ã€‚æˆ‘ä»¬ç†ŸçŸ¥çš„<code>IP</code>å’Œ<code>ICMP</code>ï¼ˆpingå‘½ä»¤ï¼‰åè®®å°±å·¥ä½œåœ¨è¿™ä¸€å±‚ã€‚</p><h3 id="IPåè®®"><a href="#IPåè®®" class="headerlink" title="IPåè®®"></a>IPåè®®</h3><p>IPåè®®æ˜¯TCP/IPåè®®æ—çš„æ ¸å¿ƒåè®®ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼š</p><ul><li>IPå¤´éƒ¨ä¿¡æ¯ã€‚IPå¤´éƒ¨ä¿¡æ¯å‡ºç°åœ¨æ¯ä¸ªIPæ•°æ®æŠ¥ä¸­ï¼Œç”¨äºæŒ‡å®šIPé€šä¿¡çš„<strong>æºç«¯IPåœ°å€ã€ç›®æ ‡ç«¯IPåœ°å€</strong>ï¼Œä»¥åŠ<strong>æŒ‡å®šéƒ¨åˆ†é€šä¿¡è¡Œä¸º</strong>ã€‚</li><li>IPæ•°æ®æŠ¥çš„è·¯ç”±å’Œè½¬å‘ã€‚IPæ•°æ®æŠ¥çš„è·¯ç”±å’Œè½¬å‘å‘ç”Ÿåœ¨é™¤ç›®æ ‡æœºå™¨ä¹‹å¤–çš„æ‰€æœ‰ä¸»æœºå’Œè·¯ç”±å™¨ä¸Šã€‚ä»–ä»¬å†³å®šæ•°æ®æŠ¥æ˜¯å¦åº”è¯¥è½¬å‘ä»¥åŠå¦‚ä½•è½¬å‘ã€‚</li></ul><blockquote><p>IP åè®®çš„æ ¸å¿ƒå³å®šä¹‰äº†<strong>æ•°æ®åŒ…ä»å“ªæ¥åˆ°å“ªå»ï¼Œä»¥åŠè¿™ä¸ªè¿‡ç¨‹ä¸­åœ¨ç½‘ç»œç»ˆç«¯ä¸Šçš„è½¬å‘è¡Œä¸º</strong>ã€‚</p></blockquote><h5 id="IPåè®®ç‰¹ç‚¹"><a href="#IPåè®®ç‰¹ç‚¹" class="headerlink" title="IPåè®®ç‰¹ç‚¹"></a>IPåè®®ç‰¹ç‚¹</h5><p>IPåè®®æ˜¯TCP/IPåè®®ç°‡çš„åŸºçŸ³ï¼Œå®ƒä¸ºä¸Šå±‚åè®®æä¾›<strong>æ— çŠ¶æ€ã€æ— è¿æ¥ã€ä¸å¯é </strong>çš„æœåŠ¡ã€‚</p><ul><li><p><strong>æ— çŠ¶æ€æ˜¯æŒ‡IPé€šè¡ŒåŒæ–¹ä¸ä¼ è¾“æ•°æ®çš„çŠ¶æ€ä¿¡æ¯ï¼Œå› æ­¤æ‰€æœ‰IPæ•°æ®æŠ¥çš„å‘é€ã€ä¼ è¾“éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰ä¸Šä¸‹æ–‡å…³ç³»</strong>ã€‚è¿™ç§æœåŠ¡æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯æ— æ³•å¤„ç†ä¹±åºå’Œé‡å¤çš„IPæ•°æ®æŠ¥ã€‚é¢å‘è¿æ¥çš„åè®®ï¼Œæ¯”å¦‚TCPåè®®ï¼Œèƒ½å¤Ÿè‡ªå·±å¤„ç†ä¹±åºçš„ã€é‡å¤çš„æŠ¥æ–‡æ®µï¼Œå®ƒé€’äº¤ç»™ä¸Šå±‚åè®®çš„å†…å®¹ç»å¯¹æ˜¯æ­£ç¡®ä¸”æœ‰åºçš„ã€‚</p><p>æ— çŠ¶æ€æœåŠ¡çš„æœ‰ç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼š<strong>ç®€å•ã€é«˜æ•ˆ</strong>ã€‚æˆ‘ä»¬æ— éœ€ä¸ºä¿æŒç»´æŠ¤é€šä¿¡çŠ¶æ€è€Œæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œä¹Ÿæ— éœ€åœ¨æ¯æ¬¡ä¼ è¾“æ—¶éƒ½æºå¸¦çŠ¶æ€ã€‚</p></li><li><p>æ— è¿æ¥æ˜¯æŒ‡IP<strong>é€šä¿¡åŒæ–¹éƒ½ä¸ä¼šé•¿ä¹…çš„ç»´æŒå¯¹æ–¹çš„ä»»ä½•ä¿¡æ¯</strong>ï¼Œè¿™æ ·<strong>ä¸Šå±‚åè®®åœ¨æ¯æ¬¡å‘é€æ•°æ®çš„æ—¶å€™éƒ½å¿…é¡»æŒ‡æ˜å¯¹æ–¹çš„IPåœ°å€ã€‚</strong></p></li><li><p><strong>ä¸å¯é æŒ‡çš„æ˜¯IPåè®®ä¸èƒ½ä¿è¯æ•°æ®åŒ…ä¸€å®šèƒ½å‡†ç¡®çš„åˆ°è¾¾ï¼Œå®ƒåªæ˜¯æ‰¿è¯ºå°½æœ€å¤§åŠªåŠ›</strong>ã€‚å¾ˆå¤šæƒ…å†µéƒ½å¯ä»¥å¯¼è‡´IPæ•°æ®æŠ¥å‘é€å¤±è´¥ï¼Œæ¯”å¦‚ï¼ŒæŸä¸ªè·¯ç”±å™¨å‘ç°æ•°æ®åŒ…åœ¨ç½‘ç»œä¸Šå­˜åœ¨æ—¶é—´å¤ªé•¿ï¼Œå°±ä¼šå°†å®ƒä¸¢å¼ƒï¼Œå¹¶è¿”å›ä¸€ä¸ªICMPé”™è¯¯æ¶ˆæ¯ç»™å‘é€ç«¯ã€‚</p></li></ul><blockquote><p> å› æ­¤IPæœåŠ¡ä¸Šå±‚åè®®å¾€å¾€éœ€è¦è‡ªå·±å®ç°æ•°æ®ç¡®è®¤ï¼Œè¶…æ—¶é‡ä¼ ç­‰æœºåˆ¶ï¼Œä»¥è¾¾åˆ°å®‰å…¨å¯é ä¼ è¾“çš„ç›®çš„ã€‚å…¸å‹å®ç°TCPåè®®ã€‚</p></blockquote><h4 id="IPv4åè®®å¤´"><a href="#IPv4åè®®å¤´" class="headerlink" title="IPv4åè®®å¤´"></a>IPv4åè®®å¤´</h4><p>IPv4çš„åè®®å¤´å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸€èˆ¬é•¿åº¦ä¸º20ä¸ªå­—èŠ‚(å¦‚ä¸‹é¢çš„5å±‚)ï¼Œä¹Ÿæœ‰å¯èƒ½åŒ…å«å˜é•¿éƒ¨åˆ†æ€»é•¿è¶…è¿‡20ä¸ªå­—èŠ‚ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210817010024.png"></p><ul><li><p>4ä½å¤´éƒ¨é•¿åº¦æ ‡è¯†è¿™ä¸ªè¿™ä¸ªIPæŠ¥æ–‡å¤´é•¿åº¦ï¼Œæ ‡è¯†èƒ½<strong>æœ‰å¤šå°‘ä¸ª4ä¸ªå­—èŠ‚ï¼Œå› æ­¤IPæŠ¥æ–‡å¤´æœ€é•¿ 15 * 4 = 60ä¸ªå­—èŠ‚ã€‚</strong></p></li><li><p>8ä½æœåŠ¡ç±»å‹åŒ…æ‹¬ä¸€ä¸ªä¸‰ä½çš„ä¼˜å…ˆæƒå­—æ®µï¼Œ4ä½çš„TOSå­—æ®µå’Œ1ä½ä¿ç•™å­—æ®µï¼ˆå¿…é¡»ç½®0ï¼‰ã€‚4ä½TOSå­—æ®µåˆ†åˆ«ä¸ºï¼š<strong>æœ€å°å»¶æ—¶ï¼Œæœ€å¤§ååé‡ï¼Œæœ€é«˜å¯é æ€§å’Œæœ€å°è´¹ç”¨</strong>ã€‚å…¶ä¸­æœ€å¤šæœ‰ä¸€ä½å¯ä»¥ç½®1ï¼Œåº”ç”¨ç¨‹åºåº”è¯¥æ ¹æ®å®é™…éœ€è¦æ¥è®¾ç½®ã€‚æ¯”å¦‚SSHå’ŒTelnetè¿™æ ·ç™»å½•éœ€è¦æœ€å°å»¶æ—¶æœåŠ¡ï¼Œè€Œä¼ è¾“æ–‡ä»¶çš„ftpåˆ™éœ€è¦æœ€å¤§ååæœåŠ¡ã€‚</p></li><li><p>16ä½æ€»é•¿åº¦æŒ‡çš„æ˜¯æ•´ä¸ªIPæ•°æ®æŠ¥çš„é•¿åº¦ï¼Œä»¥å­—èŠ‚ä¸ºå•ä½ã€‚å› æ­¤IPæ•°æ®æŠ¥æ–‡æœ€é•¿ä¸º65535ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯ç”±äºMTUçš„é™åˆ¶ï¼Œæ•°æ®æŠ¥æ–‡é•¿åº¦è¶…è¿‡MTUé™åˆ¶å°±ä¼šè¿›è¡Œåˆ†ç‰‡ä¼ è¾“ã€‚</p></li></ul><blockquote><p>IPåè®®çš„ MTU æ˜¯ç‰©ç†è®¾å¤‡ä¸Šçš„é™åˆ¶ï¼Œå®ƒé™åˆ¶äº†è·¯å¾„ä¸Šèƒ½å¤Ÿå‘é€æ•°æ®åŒ…å¤§å°çš„ä¸Šé™ã€‚</p></blockquote><ul><li>16ä½æ ‡è¯†å”¯ä¸€æ ‡è¯†ä¸»æœºå‘é€åœ°æ¯ä¸€ä¸ªæ•°æ®æŠ¥ã€‚<strong>å…¶åˆå§‹å€¼ç”±ç³»ç»Ÿéšæœºç”Ÿæˆï¼Œæ¯å‘é€ä¸€ä¸ªæ•°æ®æŠ¥ï¼Œå…¶å€¼å°±åŠ ä¸€ï¼Œè¯¥å€¼åœ¨æ•°æ®æŠ¥åˆ†ç‰‡æ—¶è¢«å¤åˆ¶åˆ°æ¯ä¸ªåˆ†ç‰‡ä¸­ï¼Œå› æ­¤åŒä¸€ä¸ªæ•°æ®æŠ¥ä¸­çš„æ‰€æœ‰åˆ†ç‰‡éƒ½å…·æœ‰ç›¸åŒçš„æ ‡è¯†ã€‚</strong></li><li>3ä½æ ‡è¯†å­—æ®µç¬¬ä¸€ä½ä¿ç•™ã€‚<strong>ç¬¬äºŒè¡¨ç¤ºâ€ç¦æ­¢åˆ†ç‰‡â€**ã€‚å¦‚æœè®¾ç½®äº†è¿™ä¸ªä½ï¼Œ</strong>IPæœåŠ¡å°†ä¸å¯¹æ•°æ®æŠ¥è¿›è¡Œåˆ†ç‰‡<strong>ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœIPæ•°æ®æŠ¥è¶…è¿‡MTUé™åˆ¶ï¼Œ</strong>åç»­çš„æ•°æ®æŠ¥ä¼šè¢«ä¸¢å¼ƒ<strong>å¹¶è¿”å›ä¸€ä¸ªICMPçš„å·®é”™æŠ¥æ–‡ã€‚</strong>ç¬¬ä¸‰ä½è¡¨ç¤ºâ€æ›´å¤šåˆ†ç‰‡â€<strong>ã€‚é™¤äº†æ•°æ®æŠ¥çš„</strong>æœ€åä¸€ä¸ªåˆ†ç‰‡ä»¥å¤–ï¼Œå…¶ä»–åˆ†ç‰‡éƒ½è¦æŠŠå®ƒç½®ä¸º1ã€‚**</li><li>13ä½åˆ†ç‰‡åç§»æ˜¯åˆ†ç‰‡ç›¸å¯¹åŸå§‹IPæ•°æ®æŠ¥å¼€å§‹å¤„çš„åç§»ï¼Œå®é™…çš„åç§»é‡åˆ™æ˜¯å·¦ç§»åŠ¨3ä½(*8)åå¾—åˆ°ï¼Œå› æ­¤é™¤äº†æœ€åä¸€ä¸ªåˆ†ç‰‡ä»¥å¤–ï¼Œæ¯ä¸ªIPåˆ†ç‰‡çš„æ•°æ®éƒ¨åˆ†é•¿åº¦å¿…é¡»æ•°8çš„å€æ•°ã€‚</li><li>8ä½ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰æ˜¯<strong>æ•°æ®æŠ¥åˆ°è¾¾ç›®çš„åœ°ä¹‹å‰å…è®¸ç»è¿‡çš„è·¯ç”±å™¨è·³æ•°ã€‚TTLåœ¨å‘é€æ—¶è¢«è®¾ç½®ï¼ˆå¸¸è§å€¼64ï¼‰</strong>ã€‚æ•°æ®æŠ¥æ–‡åœ¨è½¬å‘è¿‡ç¨‹ä¸­<strong>æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±ï¼Œè¯¥å€¼å°±è¢«è·¯ç”±å™¨å‡1</strong>ï¼Œå½“TTLå‡ä¸º0æ—¶ï¼Œæ•°æ®åŒ…ä¼šè¢«ä¸¢å¼ƒï¼Œå¹¶ä¸”å‘æºå‘é€ä¸€ä¸ªICMPå·®é”™æŠ¥æ–‡ã€‚TTLå¯ä»¥é˜²æ­¢æ•°æ®æŠ¥é™·å…¥è·¯ç”±å¾ªç¯ã€‚</li><li>8ä½åè®®ç”¨æ¥åŒºåˆ†ä¸Šå±‚åè®®ï¼Œå…¶ä¸­ ICMPæ˜¯1ï¼ŒTCPæ˜¯6ï¼ŒUDPæ˜¯17ã€‚</li><li>32ä½æºç«¯åœ°å€å’Œ32ä½ç›®æ ‡ç«¯åœ°å€ ã€‚æˆ‘ä»¬å‰é¢æåˆ°äº†<strong>IPåè®®æ˜¯æ— çŠ¶æ€ï¼Œæ— è¿æ¥çš„</strong>ã€‚å› æ­¤<strong>æ¯æ¬¡å‘é€æ•°æ®éƒ½è¦æºå¸¦ç›®æ ‡ç«¯çš„IPåœ°å€ï¼ŒåŒæ ·ä¸ºäº†èƒ½è®©ç›®æ ‡æ®µç»™æºç«¯å‘å“åº”æ•°æ®åŒ…ï¼ŒIPå¤´ä¸­è¿˜ä¼šå¸¦ä¸€ä¸ªæºç«¯åœ°å€</strong>ã€‚è¿™ä¸¤ä¸ªIPåœ°å€åœ¨æŸä¸ªå±€åŸŸç½‘å†…ä¼ è¾“æ—¶å€™ï¼Œä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚ä½†æ˜¯ç»è¿‡ç½‘å…³çš„æ—¶å€™ï¼ŒNATåè®®ä¼šå°†æºå’Œç›®æ ‡çš„MACåœ°å€å’ŒIPåœ°å€è¿›è¡Œæ›¿æ¢ã€‚</li><li>IPv4æœ€åä¸€ä¸ªé€‰é¡¹æ˜¯ä¸€ä¸ªå¯å˜çš„æœ€å¤šä¸º40ä¸ªå­—èŠ‚çš„å¯é€‰ä¿¡æ¯ã€‚å› ä¸ºå¤´éƒ¨å›ºå®šå äº†20ä¸ªå­—èŠ‚ä¸”IPå¤´æœ€å¤§å¯ä»¥æœ‰60ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸ªå¯é€‰ä¿¡æ¯æœ€å¤š40ä¸ªå­—èŠ‚ã€‚è¿™ä¸ªéƒ¨åˆ†å¯ä»¥è®°å½•ä»¥ä¸‹å‡ ç§ä¿¡æ¯ï¼š<ul><li>è®°å½•è·¯ç”±ï¼Œæ²¿é€”è¿›è¿‡çš„è·¯ç”±ã€‚</li><li>æ—¶é—´æˆ³ï¼Œå¯ç”¨äºè®¡ç®—æ¯ä¸ªè·¯ç”±ä¹‹é—´çš„ä¼ è¾“æ—¶é—´ã€‚</li><li>è·¯ç”±é€‰æ‹©(æ¾æ•£è·¯ç”±é€‰æ‹©ã€ä¸¥æ ¼è·¯ç”±é€‰æ‹©)ï¼ŒæŒ‡å®šè·¯ç”±è¿‡ç¨‹ä¸­å¿…é¡»ç»è¿‡æˆ–å…¨éƒ¨å¿…é¡»ç»è¿‡çš„è·¯ç”±ã€‚</li></ul></li></ul><h4 id="è·¯ç”±ä¸è½¬å‘"><a href="#è·¯ç”±ä¸è½¬å‘" class="headerlink" title="è·¯ç”±ä¸è½¬å‘"></a>è·¯ç”±ä¸è½¬å‘</h4><p>IPåè®®çš„ä¸€ä¸ªæ ¸å¿ƒçš„ä»»åŠ¡æ˜¯æ•°æ®æŠ¥æ–‡çš„è·¯ç”±ï¼Œå³å†³å®šæ•°æ®æŠ¥åˆ°ç›®æ ‡æœºå™¨çš„è·¯å¾„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210817233637.png"></p><p>ç®€å•åˆ†æä¸Šé¢çš„å›¾ä»å·¦ä¸‹è§’çš„IPè¾“å…¥é˜Ÿåˆ—å¼€å§‹ã€‚</p><ul><li><p>å½“IPæ¨¡å—æ¥æ”¶åˆ°æ¥è‡ªæ•°æ®é“¾è·¯å±‚çš„IPæ•°æ®æŠ¥ï¼Œå®ƒ<strong>é¦–å…ˆå¯¹è¯¥æ•°æ®æŠ¥çš„å¤´éƒ¨åšCRCæ ¡éªŒ</strong>ï¼Œç¡®è®¤æ— è¯¯åå°±åˆ†æå¤´éƒ¨çš„å…·ä½“ä¿¡æ¯ã€‚</p></li><li><p>å¦‚æœè¯¥IPæ•°æ®æŠ¥çš„å¤´éƒ¨ä¸­ç›®æ ‡IPåœ°å€æ˜¯æœ¬æœºçš„æŸä¸ªIPåœ°å€ï¼Œæˆ–è€…æ˜¯å¹¿æ’­åœ°å€ï¼Œå³<strong>è¯¥æ•°æ®åŒ…æ˜¯ç»™æœ¬æœºçš„ï¼Œåˆ™IPæ¨¡å—å°±æ ¹æ®æ•°æ®æŠ¥å¤´éƒ¨ä¸­çš„åè®®å­—æ®µæ¥å†³å®šå°†å®ƒæ´¾å‘ç»™æŸä¸ªä¸Šå±‚åº”ç”¨åè®®</strong>ï¼Œ<strong>å¦‚æœä¸æ˜¯</strong>å‘ç°è¿™ä¸ªæ•°æ®æŠ¥ä¸æ˜¯ç»™æœ¬æœºçš„ï¼Œåˆ™ä¹Ÿ<strong>è°ƒç”¨æ•°æ®æŠ¥è½¬å‘å­æ¨¡å—æ¥å¤„ç†</strong>è¯¥æ•°æ®æŠ¥ã€‚</p></li><li><p>æ•°æ®æŠ¥è½¬å‘æ¨¡å—ä¼šæ£€æµ‹ç³»ç»Ÿæ˜¯å¦<strong>å…è®¸è½¬å‘ï¼Œå¦‚æœä¸å…è®¸ï¼Œæ•°æ®æŠ¥å°†ä¼šè¢«ä¸¢å¼ƒã€‚å¦‚æœå…è®¸ï¼Œæ•°æ®è½¬å‘æ¨¡å—å°†ä¼šå¯¹æ•°æ®æŠ¥è¿›è¡Œä¸€äº›æ“ä½œï¼Œç„¶åäº¤ç»™IPæŠ¥æ–‡è¾“å‡ºæ¨¡å—</strong>ã€‚</p></li></ul><blockquote><p>è½¬å‘æ¨¡å—ä¼šåšå¦‚ä¸‹æ“ä½œï¼š</p><ol><li><p>æ£€æŸ¥æ•°æ®æŠ¥æ–‡å¤´éƒ¨çš„TTLå€¼ï¼Œå¦‚æœ<strong>TTLå€¼å·²ç»æ˜¯0ï¼Œåˆ™ä¸¢å¼ƒè¯¥æ•°æ®æŠ¥ã€‚</strong></p></li><li><p>æ£€æŸ¥æ•°æ®å¤´éƒ¨çš„<strong>ä¸¥æ ¼è·¯ç”±é€‰æ‹©</strong>é€‰é¡¹ï¼Œå¦‚æœè¯¥é€‰é¡¹è¢«è®¾ç½®ï¼Œåˆ™æ£€æŸ¥æ•°æ®æŠ¥çš„ç›®æ ‡IPåœ°å€æ˜¯å¦æ˜¯æœ¬æœºçš„æŸä¸ªIPï¼Œå¦‚æœ<strong>ä¸æ˜¯</strong>ï¼Œå‘é€ä¸€ä¸ª<strong>ICMPå·®é”™æŠ¥æ–‡ç»™å‘é€ç«¯ã€‚</strong></p></li><li><p>å¦‚æœæœ‰å¿…è¦ï¼Œåˆ™ç»™æºç«¯å‘é€ä¸€ä¸ªICMPé‡å®šå‘æŠ¥æ–‡ï¼Œä»¥å‘Šè¯‰å®ƒä¸€ä¸ªæ›´åˆç†çš„ä¸‹ä¸€è·³è·¯ç”±ã€‚</p></li><li><p><strong>å°†TTLçš„å€¼å‡1</strong>ã€‚</p></li><li><p><strong>å¤„ç†IPå¤´éƒ¨</strong>é€‰é¡¹</p></li><li><p>å¦‚æœæœ‰å¿…è¦ï¼Œæ‰§è¡Œ<strong>IPåˆ†ç‰‡</strong>æ“ä½œã€‚</p></li></ol></blockquote><ul><li>IPæ•°æ®æŠ¥<strong>åº”è¯¥å‘é€è‡³å“ªä¸ªä¸‹ä¸€è·³è·¯ç”±ï¼ˆæˆ–ç›®æ ‡ä¸»æœºï¼‰</strong>ï¼Œä»¥åŠç»è¿‡å“ªä¸ªç½‘å¡æ¥å‘é€ï¼Œå°±æ˜¯IPè·¯ç”±è¿‡ç¨‹ï¼Œå³å›¾ä¸­â€œè®¡ç®—ä¸‹ä¸€è·³è·¯ç”±æ¨¡å—ã€‚IPæ¨¡å—å®ç°æ•°æ®æŠ¥è·¯ç”±çš„æ ¸å¿ƒæ•°æ®ç»“æ„æ˜¯<strong>IPè·¯ç”±è¡¨</strong>ã€‚è¿™ä¸ªè¡¨æŒ‰ç…§æ•°æ®æŠ¥çš„ç›®æ ‡IPåœ°å€åˆ†ç±»ï¼ŒåŒä¸€ç±»å‹çš„IPæ•°æ®æŠ¥å°†ä¼šè¢«å‘å¾€ç›¸åŒçš„ä¸‹ä¸€è·³è·¯ç”±æˆ–ç›®æ ‡ä¸»æœºã€‚</li><li>IPè¾“å‡ºé˜Ÿåˆ—ä¸­å­˜æ”¾çš„æ˜¯<strong>æ‰€æœ‰ç­‰å¾…å‘é€çš„IPæ•°æ®æŠ¥ã€‚</strong></li><li>å›¾ä¸­çš„è™šçº¿ç®­å¤´æ˜¾ç¤ºäº†è·¯ç”±è¡¨æ›´æ–°çš„è¿‡ç¨‹ï¼Œè¿™ä¸€è¿‡ç¨‹æŒ‡çš„é€šè¿‡è·¯ç”±åè®®æˆ–è€…routeå‘½ä»¤è°ƒæ•´è·¯ç”±è¡¨ï¼Œä½¿ä¹‹æ›´å¿«é€‚åº”æ–°çš„ç½‘ç»œæ‹“æ‰‘ç»“æ„ï¼Œæˆä¸ºIPè·¯ç”±ç­–ç•¥ã€‚</li></ul><blockquote><p>IPçš„è·¯ç”±ç­–ç•¥ï¼š</p><ol><li><p>æŸ¥æ‰¾è·¯ç”±è¡¨ä¸­çš„æ•°æ®æŠ¥çš„<strong>ç›®æ ‡IPåœ°å€å®Œå…¨åŒ¹é…</strong>çš„ä¸»æœºIPåœ°å€ã€‚å¦‚æœæ‰¾åˆ°ï¼Œå°±ä½¿ç”¨è¯¥è·¯ç”±é¡¹ï¼Œæ²¡æ‰¾åˆ°è½¬æ­¥éª¤2ã€‚</p></li><li><p>æŸ¥æ‰¾è·¯ç”±è¡¨ä¸­çš„æ•°æ®æŠ¥<strong>ç›®æ ‡IPåœ°å€å…·æœ‰ç›¸åŒç½‘ç»œID</strong>çš„ç½‘ç»œIPåœ°å€ã€‚å¦‚æœæ‰¾åˆ°ï¼Œå°±ä½¿ç”¨è¯¥è·¯ç”±é¡¹ï¼Œæ²¡æ‰¾åˆ°è½¬æ­¥éª¤3ã€‚</p></li><li><p>é€‰æ‹©<strong>é»˜è®¤è·¯ç”±é¡¹</strong>ï¼Œè¿™é€šå¸¸æ„å‘³ç€æ•°æ®æŠ¥çš„ä¸‹ä¸€è·³æ˜¯ç½‘å…³ã€‚</p></li></ol></blockquote><h3 id="ICMPåè®®"><a href="#ICMPåè®®" class="headerlink" title="ICMPåè®®"></a>ICMPåè®®</h3><p>æˆ‘ä»¬é€šå¸¸åœ¨ç½‘ç»œä¸æ˜¯å¾ˆå¥½çš„æ—¶å€™ï¼Œä¹ æƒ¯ä½¿ç”¨<code>ping</code>å‘½ä»¤å»æ£€æŸ¥ä¸‹ç½‘ç»œçš„æƒ…å†µã€‚è€Œpingå‘½ä»¤åˆ™æ˜¯åŸºäºICMPåè®®å·¥ä½œçš„ã€‚<code>ICMP</code> å…¨ç§° I<strong>nternet Control Message Protocol</strong>ã€‚å³<strong>äº’è”ç½‘æ§åˆ¶æŠ¥æ–‡åè®®</strong>ã€‚è¿™é‡Œé¢çš„å…·ä½“æ€ä¹ˆâ€œæ§åˆ¶â€çš„å‘¢ï¼Ÿç½‘ç»œåŒ…åœ¨å¼‚å¸¸å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸­ä¼ è¾“æ—¶ï¼Œå¸¸å¸¸ä¼šé‡åˆ°å„ç§å„æ ·çš„é—®é¢˜ã€‚å½“é‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸èƒ½ç›´æ¥å¿½è§†é—®é¢˜ã€‚è€Œæ˜¯éœ€è¦å»æ¢æŸ¥é—®é¢˜çš„æƒ…å†µï¼Œç„¶å<strong>æ ¹æ®ç»“æœæ¥è°ƒæ•´ä¼ è¾“ç­–ç•¥</strong>ã€‚I<strong>CMPæŠ¥æ–‡æ˜¯å°è£…åœ¨IPåŒ…é‡Œé¢çš„</strong>ï¼Œå¹¶ä¸”æœ¬èº«è¶³å¤Ÿ<strong>è½»é‡</strong>ä»¥æ–¹ä¾¿æ¢æµ‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210904143454.png"></p><p>ICMPæŠ¥æ–‡æœ‰å¾ˆå¤šç§ç±»å‹ï¼Œä¸åŒçš„ç±»å‹æœ‰ä¸åŒçš„ä»£ç ã€‚<strong>æœ€å¸¸ç”¨çš„ç±»å‹æ˜¯ä¸»åŠ¨è¯·æ±‚ä¸º8ï¼Œä¸»åŠ¨è¯·æ±‚çš„åº”ç­”ä¸º0ã€‚</strong></p><h4 id="æŸ¥è¯¢æŠ¥æ–‡ç±»å‹"><a href="#æŸ¥è¯¢æŠ¥æ–‡ç±»å‹" class="headerlink" title="æŸ¥è¯¢æŠ¥æ–‡ç±»å‹"></a>æŸ¥è¯¢æŠ¥æ–‡ç±»å‹</h4><p>ICMPæŸ¥è¯¢æŠ¥æ–‡ç±»å‹ï¼Œå³<strong>ä¸»åŠ¨æ¢æµ‹ç½‘ç»œçš„æŠ¥æ–‡ç±»å‹</strong>ã€‚æˆ‘ä»¬å¸¸ç”¨çš„pingå‘½ä»¤å°±æ˜¯<strong>æŸ¥è¯¢æŠ¥æ–‡ï¼Œæ˜¯ä¸€ç§ä¸»åŠ¨è¯·æ±‚ï¼Œå¹¶ä¸”è·å¾—ä¸»åŠ¨åº”ç­”çš„ICMPåè®®ã€‚</strong>å› æ­¤pingå‘å‡ºçš„åŒ…ä¹Ÿæ˜¯ç¬¦åˆICMPåè®®æ ¼å¼çš„ï¼Œåªä¸è¿‡å®ƒåœ¨åé¢å¢åŠ äº†è‡ªå·±çš„æ ¼å¼ã€‚</p><p>å¯¹äºping ä¸»åŠ¨è¯·æ±‚ï¼Œè¿›è¡Œç½‘ç»œæŠ“åŒ…ï¼Œç§°ä¸º<code>ICMP ECHO REQUEST</code>ã€‚åŒç†ä¸»åŠ¨è¯·æ±‚çš„å›å¤ï¼Œç§°ä¸º<code>ICMP ECHO REPLY</code>ã€‚æ¯”èµ·åŸç”Ÿçš„ ICMPï¼Œè¿™é‡Œå¤šäº†ä¸¤ä¸ªå­—æ®µï¼Œä¸€ä¸ªæ˜¯æ ‡è¯†ç¬¦å·ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯åºå·ï¼Œåœ¨é€‰é¡¹æ•°æ®ä¸­ï¼Œping è¿˜ä¼š<strong>å­˜æ”¾å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œæ¥è®¡ç®—å¾€è¿”æ—¶é—´ï¼Œè¯´æ˜è·¯ç¨‹çš„é•¿çŸ­ã€‚</strong></p><h4 id="å·®é”™æŠ¥æ–‡ç±»å‹"><a href="#å·®é”™æŠ¥æ–‡ç±»å‹" class="headerlink" title="å·®é”™æŠ¥æ–‡ç±»å‹"></a>å·®é”™æŠ¥æ–‡ç±»å‹</h4><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæˆ‘ä»¬æˆ‘ä»¬æ”¶åˆ°ä¸»åŠ¨è¯·æ±‚å›å¤ï¼Œä½†æ˜¯<strong>å¦‚æœä¸é¡ºåˆ©ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šæ”¶åˆ°å·®é”™æŠ¥æ–‡</strong>ï¼Œ<strong>ä¸åŒçš„å¼‚å¸¸æƒ…å†µä¹Ÿå¯¹åº”ç€ä¸åŒçš„å·®é”™æŠ¥æ–‡ç±»å‹</strong>ã€‚å…¶ä¸­æ¯”è¾ƒå¸¸è§çš„ä¾‹å­ï¼š<strong>ç»ˆç‚¹ä¸å¯è¾¾ä¸º 3ï¼Œ æºæŠ‘åˆ¶ä¸º 4ï¼Œè¶…æ—¶ä¸º 11ï¼Œé‡å®šå‘ä¸º 5</strong>ã€‚</p><ul><li><p>ç»ˆç‚¹ä¸å¯è¾¾ï¼šå°±æ˜¯å­—é¢æ„æ€ï¼Œç›®æ ‡ä¸å¯è¾¾ã€‚</p></li><li><p>æºæŠ‘åˆ¶ï¼šè®©æºç«™æ”¾æ…¢å‘é€é€Ÿåº¦ã€‚</p></li><li><p>æ—¶é—´è¶…æ—¶ï¼šè¶…è¿‡äº†ç½‘ç»œåŒ…çš„ç”Ÿå­˜æ—¶é—´ï¼Œä½†æ˜¯ç½‘ç»œåŒ…è¿˜æ˜¯æ²¡æœ‰è¾¾åˆ°ç›®æ ‡ç«¯ã€‚</p></li><li><p>é‡å®šå‘ï¼šä¸‹æ¬¡å‘ç»™å¦å¤–ä¸€ä¸ªè·¯ç”±ã€‚</p></li></ul><h4 id="Tracerouteï¼šå·®é”™æŠ¥æ–‡ç±»å‹çš„ä½¿ç”¨"><a href="#Tracerouteï¼šå·®é”™æŠ¥æ–‡ç±»å‹çš„ä½¿ç”¨" class="headerlink" title="Tracerouteï¼šå·®é”™æŠ¥æ–‡ç±»å‹çš„ä½¿ç”¨"></a>Tracerouteï¼šå·®é”™æŠ¥æ–‡ç±»å‹çš„ä½¿ç”¨</h4><p>æˆ‘ä¹‹å‰ä¼šç”¨<code>traceroute</code>å‘½ä»¤å»æŸ¥çœ‹ï¼Œæ•°æ®åŒ…ç»è¿‡äº†å“ªäº›è·¯ç”±å™¨ï¼Œç»è¿‡äº†å¤šå°‘è·³ã€‚è€Œ<code>traceroute</code><strong>é€šè¿‡è®¾ç½®ç‰¹æ®Šçš„TTLï¼Œæ¥è¿½è¸ªå»å¾€ç›®çš„åœ°æ²¿é€”ç»è¿‡çš„è·¯ç”±å™¨</strong>ã€‚å½“ä½¿ç”¨tracerouteå‘½ä»¤æŒ‡å‘æŸä¸ªåœ°å€æ—¶ï¼Œå®ƒä¼šå‘é€ä¸€ä¸ªUDPçš„æ•°æ®åŒ…ï¼Œå¹¶ä¸”<strong>å°†TTLè®¾ç½®ä¸º1</strong>ã€‚è¿™æ ·é‡åˆ°ç¬¬ä¸€ä¸ªè·¯ç”±ï¼Œè·¯ç”±å°±ä¼šå‘ç°è¿™ä¸ªæ•°æ®åŒ…â€œ<strong>ç”Ÿå‘½ç»“æŸ</strong>â€äº†ï¼Œå¹¶è¿”å›ä¸€ä¸ª<strong>ICMPçš„å·®é”™æŠ¥æ–‡ç±»å‹æ˜¯æ—¶é—´è¶…æ—¶</strong>ï¼Œè¿™ä¸ªæŠ¥æ–‡é‡Œé¢å°±å¸¦æœ‰äº†è¿™ä¸ªè·¯ç”±å™¨çš„IPåœ°å€ã€‚ç„¶å<strong>æºç«¯å‘é€ç¬¬äºŒä¸ªUDPæ•°æ®åŒ…ï¼Œå¹¶å°†TTLè®¾ç½®ä¸º2</strong>ã€‚è¿™ä¸ªæ—¶å€™é‡åˆ°ç¬¬äºŒä¸ªè·¯ç”±æ—¶å°±ä¼šè¿”å›ä¸€ä¸ªICMPå·®é”™æŠ¥æ–‡ã€‚åŒç†è¿™æ ·å°±å¯ä»¥ä¸€æ­¥æ­¥æ‹¿åˆ°æ²¿é€”ç»è¿‡çš„è·¯ç”±IPã€‚å½“ç„¶ä¹Ÿæœ‰è·¯ç”±å™¨å‹æ ¹å°±ä¸ä¼šè¿”å› ICMPå·®é”™æŠ¥æ–‡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šçœ‹åˆ°è¾“å‡ºâ€œ*<strong>â€äº†ã€‚</strong>traceroute è¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯æ•…æ„ä¸è®¾ç½®ä¸åˆ†ç‰‡ï¼Œä»è€Œæµ‹è¯•ç½‘ç»œè·¯å¾„çš„MTUã€‚</p><h2 id="ä¼ è¾“å±‚"><a href="#ä¼ è¾“å±‚" class="headerlink" title="ä¼ è¾“å±‚"></a>ä¼ è¾“å±‚</h2><p>ä¼ è¾“å±‚ä½äºTCP/IPåè®®æ—ä¸­çš„ç¬¬4å±‚ï¼Œè¿™ä¸€å±‚çš„åè®®ä¸ºåº”ç”¨è¿›ç¨‹æä¾›ç«¯åˆ°ç«¯çš„é€šä¿¡æœåŠ¡ã€‚å®ƒæä¾›é¢å‘è¿æ¥çš„æ•°æ®æµæ”¯æŒã€å¯é è¿æ¥ã€æµé‡æ§åˆ¶å’Œå¤šè·¯é‡ç”¨ç­‰æœåŠ¡ã€‚è¿™ä¸€å±‚ä¸»è¦çš„åè®®æœ‰<code>TCP</code>å’Œ<code>UDP</code>ã€‚</p><h3 id="UDPåè®®"><a href="#UDPåè®®" class="headerlink" title="UDPåè®®"></a>UDPåè®®</h3><p>UDPæ˜¯<code>User Datagram Protocol</code>çš„ç®€ç§°ï¼Œä¸­æ–‡åæ˜¯<strong>ç”¨æˆ·æ•°æ®æŠ¥åè®®</strong>ã€‚UDPæ˜¯ä¸€ç§æ— è¿æ¥ä¼ è¾“å±‚åè®®ï¼Œæä¾›<strong>ç®€å•ä¸å¯é çš„ä¿¡æ¯ä¼ é€æœåŠ¡</strong>ã€‚å®ƒåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å¹¶ä¸ä¼šä¸ç›®æ ‡ç«¯å»ºç«‹ä¸€ä¸ªâ€œè¿æ¥â€ï¼Œåªæ˜¯ç®€å•çš„æŠŠæ•°æ®åŒ…ä¸¢å…¥ç½‘ç»œä¸­ï¼Œç„¶åä»»å…¶è‡ªç”Ÿè‡ªç­ã€‚å¦‚æœæŠŠUDPæ¯”å–»æˆäººçš„è¯ï¼ŒUDPå°±åƒæ˜¯ä¸€ä¸ªç›¸ä¿¡ä¸–ç•Œç¾å¥½çš„å­©å­ã€‚ç›¸ä¿¡ç½‘è·¯é“¾è·¯çš„â€œç¾å¥½â€å³ç›¸ä¿¡å‘å‡ºå³å¯é€è¾¾ï¼Œæ²¡æœ‰ç»éªŒä¹Ÿä¸ä¼šå»å¤„ç†ä¸€äº›æ‹¥å¡ï¼Œä¸¢åŒ…çš„å¼‚å¸¸åœºæ™¯ã€‚</p><blockquote><p>è¿™é‡Œæåˆ°äº†ä¸€ä¸ªâ€œè¿æ¥â€ï¼Œè¿™ä¸ªè¿æ¥æ˜¯æŠ½è±¡çš„ï¼Œå¹¶ä¸æ˜¯çœŸçš„æœ‰ä¸¤ä¸ªé€šä¿¡ç«¯ä¹‹é—´æœ‰ä¸€ä¸ªç±»ä¼¼â€œç½‘çº¿â€ä¸€æ ·çš„ä¸œè¥¿ï¼Œä»–ä»¬åªæ˜¯é é€šä¿¡çš„ä¸¤ç«¯ç»´æŠ¤ä¸€å®šçš„æ•°æ®ç»“æ„ä¿æŒæŸç§çŠ¶æ€ï¼Œæ¥è®°å½•å’Œç»´æŠ¤è¿™æ ·ä¸€ä¸ªâ€œè¿æ¥â€çš„çŠ¶æ€ã€‚</p></blockquote><p>UDPçš„åŒ…å¤´å¦‚ä¸‹ï¼Œé€šè¿‡åŒ…å¤´æˆ‘ä»¬ä¹Ÿä¸éš¾å‘ç°è¿™æ˜¯ä¸ªç®€å•æ²¡æœ‰ä»€ä¹ˆå¤æ‚â€œæƒ³æ³•â€çš„åè®®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210820000409.png"></p><h4 id="UDPçš„ç‰¹ç‚¹ä¸ä½¿ç”¨åœºæ™¯"><a href="#UDPçš„ç‰¹ç‚¹ä¸ä½¿ç”¨åœºæ™¯" class="headerlink" title="UDPçš„ç‰¹ç‚¹ä¸ä½¿ç”¨åœºæ™¯"></a>UDPçš„ç‰¹ç‚¹ä¸ä½¿ç”¨åœºæ™¯</h4><p>é€šè¿‡ä¸Šé¢å¯¹UDPçš„ä»‹ç»æˆ‘ä»¬å¾ˆå®¹æ˜“å°±å¯ä»¥äº†è§£åˆ°UDPçš„ç‰¹ç‚¹ï¼š</p><ul><li><strong>è½»é‡</strong>ã€<strong>ç®€å•</strong>ã€‚</li><li><strong>ä¸èƒ½åº”å¯¹å¤æ‚çš„ç½‘ç»œæƒ…å†µ</strong>ï¼Œæ²¡æœ‰æµé‡æ§åˆ¶ï¼Œæ²¡æœ‰åº”ç­”æœºåˆ¶ï¼Œä¸èƒ½å¤„ç†ä¸¢åŒ…ã€é‡å‘ã€é”™åºç­‰é—®é¢˜ã€‚</li></ul><p>UDPè™½ç„¶ç®€å•ï¼Œä½†æ˜¯ç®€å•ä¹Ÿæœ‰ç®€å•çš„ç”¨æ³•ã€‚åŸºäºè¿™äº›ç‰¹ç‚¹ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åœ¨ä»¥ä¸‹çš„åœºæ™¯ä¸­ï¼š</p><ol><li><p><strong>éœ€è¦èµ„æºå°‘ï¼Œç½‘ç»œæƒ…å†µæ¯”è¾ƒå¥½çš„å†…ç½‘ï¼Œæˆ–è€…å¯¹äºä¸¢åŒ…ä¸æ•æ„Ÿçš„åº”ç”¨</strong>ã€‚DHCPåè®®å°±æ˜¯åŸºäºUDPçš„ï¼ŒDHCPä¸­ä¸€èˆ¬è·å–IPåœ°å€éƒ½æ˜¯å†…ç½‘è¯·æ±‚ï¼Œè€Œä¸”å¯ä»¥é‡å¤å¤šæ¬¡è·å–è¯·æ±‚ã€‚</p></li><li><p><strong>ä¸éœ€è¦ä¸€å¯¹ä¸€å»ºç«‹è¿æ¥ï¼Œè€Œæ˜¯å¯ä»¥è¿›è¡Œå¹¿æ’­çš„åº”ç”¨</strong>ã€‚UDPä¸é¢å‘è¿æ¥çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨æ‰¿è½½å¹¿æ’­æˆ–è€…å¤šæ’­çš„åè®®ã€‚DHCPå°±æ˜¯ä¸€ç§å¹¿æ’­å½¢å¼çš„åè®®ã€‚</p></li><li><p><strong>éœ€è¦å¤„ç†é€Ÿåº¦å¿«ï¼Œå»¶æ—¶ä½ï¼Œå¯ä»¥å®¹å¿å°‘æ•°ä¸¢åŒ…ï¼Œä½†æ˜¯è¦æ±‚å³ä¾¿ç½‘ç»œæ‹¥å¡ä¹Ÿä¸èƒ½é™ä½é€Ÿç‡</strong>ã€‚UDPç®€å•ã€å¤„ç†é€Ÿåº¦å¿«ï¼Œåœ¨ä¾‹å¦‚ç›´æ’­ã€æ¸¸æˆç­‰å®æ—¶æ€§è¦æ±‚æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸­ï¼Œä¸¢äº†ä¸€ä¸¤ä¸ªåŒ…ä¹Ÿæ— å…³ç´§è¦ï¼Œä½†æ˜¯å¦‚æœå»¶æ—¶è¿‡é«˜åˆ™å¾ˆéš¾æ¥å—ï¼Œè¿™ç§åœºæ™¯ä¸­ä¹ŸåŸºæœ¬ä½¿ç”¨UDPè¿›è¡Œä¼ è¾“ã€‚</p></li></ol><blockquote><p>ç®€å•å¹¶ä¸ä»£è¡¨ä½çº§ï¼Œç®€å•åŒæ—¶ä¹Ÿæ„å‘³ç€æ›´é«˜çš„å¯æ‹“å±•æ€§ã€‚</p></blockquote><p>åŒæ—¶å› ä¸ºUDPç®€å•ï¼Œå¯è‡ªå®šä¹‰æ‹“å±•æ€§ä¹Ÿæ›´é«˜ï¼Œå› æ­¤ç°åœ¨ä¹Ÿæœ‰ä¸å°‘åŸºäºUDPç‰¹æ€§æ‹“å±•å‡ºæ¥ä¸Šå±‚åè®®å’Œåº”ç”¨é¢†åŸŸã€‚</p><ol><li><p><strong>QUICï¼ˆå…¨ç§° Quick UDP Internet Connectionsï¼Œå¿«é€ŸUDPäº’è”ç½‘è¿æ¥ï¼‰æ˜¯Google æå‡ºçš„ä¸€ç§åŸºäºUDPæ”¹è¿›çš„é€šä¿¡åè®®</strong>ï¼Œå…¶ç›®çš„æ˜¯é™ä½ç½‘ç»œé€šè¡Œçš„å»¶è¿Ÿï¼Œæä¾›æ›´å¥½çš„ç”¨æˆ·äº’åŠ¨ä½“éªŒã€‚QUICåœ¨åº”ç”¨å±‚ä¸Šï¼Œä¼šè‡ªå·±å®ç°å¿«é€Ÿè¿æ¥ï¼Œå‡å°‘é‡ä¼ æ—¶å»¶ï¼Œè‡ªé€‚åº”æ‹¥å¡æ§åˆ¶ã€‚</p></li><li><p><strong>æµåª’ä½“åè®®</strong>ï¼Œç°åœ¨å¾ˆå¤šç›´æ’­åè®®æ˜¯åŸºäºRTMPçš„ï¼ŒRTMPæ˜¯åŸºäºTCPå®ç°çš„æµåª’ä½“åè®®ï¼Œä½†æ˜¯æµåª’ä½“åè®®è¦æ±‚è¾ƒé«˜çš„å®æ—¶æ€§ï¼Œç°åœ¨å¾ˆå¤šç›´æ’­å¹³å°éƒ½åŸºäºUDPå®ç°äº†è‡ªå·±çš„æµåª’ä½“ä¼ è¾“åè®®ã€‚</p></li><li><p><strong>å®æ—¶æ¸¸æˆé¢†åŸŸ</strong>ï¼ŒåŒç†ï¼Œå¦‚æœæƒ³è¦æ›´é«˜çš„å®æ—¶æ€§ï¼ŒTCPå¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ï¼ŒåŸºäºUDPçš„å®ç°çš„ä¼ è¾“åè®®èƒ½å¸¦æ¥æ›´å¥½çš„å®æ—¶æ€§æ¸¸æˆä½“éªŒã€‚</p></li><li><p><strong>IoT ç‰©è”ç½‘</strong>ï¼Œç‰©è”ç½‘é¢†åŸŸçš„ç»ˆç«¯å¾€å¾€éƒ½æ˜¯åµŒå…¥å¼çš„ç³»ç»Ÿï¼Œå†…å­˜å°æ€§èƒ½å·®ï¼Œå¯èƒ½ç»´æŠ¤ä¸€ä¸ªTCPè¿æ¥å¯¹äºè¿™äº›ç³»ç»Ÿæ¥è¯´éƒ½æ˜¯ä¸€ä¸ªä¸å°çš„å¼€é”€ã€‚è€Œä¸”ç‰©è”ç½‘ä¹Ÿè¦æ±‚è¾ƒé«˜çš„å®æ—¶æ€§ï¼ŒGoogle æ——ä¸‹çš„ Nest å»ºç«‹çš„ Thread Group æ¨å‡ºçš„ Thread ç‰©è”ç½‘é€šè¡Œåè®®å°±æ˜¯åŸºäºUDPçš„ã€‚</p></li><li><p><strong>ç§»åŠ¨é€šä¿¡é¢†åŸŸ</strong>ã€‚åœ¨4Gç½‘ç»œé‡Œï¼Œç§»åŠ¨æµé‡ä¸Šç½‘çš„æ•°æ®é¢å¯¹çš„åè®® GTP-Uæ˜¯åŸºäºUDPçš„ï¼Œå› ä¸ºç§»åŠ¨é€šä¿¡åè®®æœ¬èº«å°±æ¯”è¾ƒå¤æ‚ï¼Œå¦‚æœåŸºäºTCPï¼ŒTCPçš„æœºåˆ¶å°±ä¼šæ˜¾å¾—éå¸¸å¤šä½™ã€‚</p></li></ol><h3 id="TCPåè®®"><a href="#TCPåè®®" class="headerlink" title="TCPåè®®"></a>TCPåè®®</h3><p>å‰é¢æˆ‘ä»¬ä»‹ç»çš„<code>UDP</code>åè®®æ˜¯é¢å‘æ— è¿æ¥ï¼Œä¸å¯é çš„åè®®ã€‚è€Œä¸<code>UDP</code>åè®®åˆšå¥½ç›¸åï¼Œ<code>TCP</code>æ˜¯é¢å‘è¿æ¥ï¼Œæä¾›å¯é çš„ä¼ è¾“å±‚åè®®ã€‚å…¶ä¸­æˆ‘ä»¬ç†ŸçŸ¥çš„<code>HTTP</code>ã€<code>FTP</code>ã€<code>SMTP</code>ã€<code>TELNET</code>å’Œ<code>SSH</code>ç­‰åº”ç”¨å±‚åè®®éƒ½æ˜¯åŸºäº<strong>å¯é çš„TCPåè®®</strong>è¿›è¡Œä¼ è¾“çš„ã€‚åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸­ï¼Œä¿è¯å¯é ä¸”é«˜æ•ˆçš„ä¼ è¾“å¹¶éæ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ã€‚TCPåè®®é€šè¿‡<strong>ä¸‰æ¬¡æ¡æ‰‹å››æ¬¡æŒ¥æ‰‹</strong>æ¥å»ºç«‹ç¨³å®šå¯é çš„è¿æ¥ï¼Œé€šè¿‡<strong>åº”ç­”æœºåˆ¶ã€æ»‘åŠ¨çª—å£å’Œæ‹¥å¡çª—å£</strong>ç­‰æµé‡æ§åˆ¶æ‰‹æ®µæ¥ä¿è¯ä¼ è¾“çš„å¯é æ€§ã€‚æœ€åé€šè¿‡å„ç§<strong>æ‹¥å¡ç®—æ³•</strong>å®ç°å¯¹ç½‘ç»œå¸¦å®½çš„å……åˆ†åˆ©ç”¨ã€‚ç”±äºTCPåè®®æ¶‰åŠå†…å®¹ç¯‡å¹…è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€å°ç»“è¿›è¡Œè¯¦ç»†åˆ†æå’Œè§£è¯»ã€‚ğŸ˜‰</p><blockquote><p> TCPåè®®çš„ç®—æ³•è®¾è®¡èƒ½å¸¦æ¥å¾ˆå¤šæ€æƒ³å±‚é¢çš„å¯ç¤ºã€‚âœŠğŸ¼</p></blockquote><h2 id="åº”ç”¨å±‚"><a href="#åº”ç”¨å±‚" class="headerlink" title="åº”ç”¨å±‚"></a>åº”ç”¨å±‚</h2><p>åœ¨ä¼ è¾“å±‚çš„ä¸Šå±‚åº”ç”¨å±‚æœ‰å¾ˆå¤šçš„åè®®ï¼Œè¿™äº›åè®®åŸºäºTCPçš„å¯é ä¼ è¾“å’ŒUDPçš„ç®€å•ä½å»¶è¿Ÿçš„ç‰¹ç‚¹ï¼Œå¯ä»¥â€œç©å‡ºäº†å¾ˆå¤šèŠ±æ ·â€œï¼Œå…¶ä¸­æœ‰æˆ‘ä»¬ç†Ÿæ‚‰çš„ç”¨äºé‚®ä»¶æ”¶å‘çš„<code>SMTP</code>åè®®ï¼Œæ–‡ä»¶ä¼ è¾“çš„<code>FTP</code>åè®®å’Œç”¨äºæœåŠ¡å™¨çš„<code>SSH</code>ã€<code>TELNET</code>åè®®ç­‰ã€‚å½“ç„¶è¿˜æœ‰æˆ‘ä»¬æœ€ç†Ÿæ‚‰çš„ç”¨äºWEBæœåŠ¡çš„<code>HTTP</code>åè®®ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä¸å¯¹<code>HTTP</code>åè®®çš„ç»†èŠ‚è¿›è¡Œå±•å¼€äº†ï¼Œæ¯•ç«Ÿè¿™ä¸ªåè®®æˆ‘ä»¬æ¯å¤©å¼€å‘è¿‡ç¨‹ä¸­å¤šå¤šå°‘å°‘éƒ½ä¼šç”¨åˆ°ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜æˆ‘ä»¬èŠåˆ°ï¼Œå°±æ˜¯<code>HTTP1</code>å’Œ<code>HTTP2</code>ä¹‹é—´çš„åŒºåˆ«ã€‚è¯´å®è¯<code>HTTP2</code>æˆ‘ä¹Ÿç”¨çš„å°‘ï¼Œæˆ‘ä»¬æ—¥å¸¸å¼€å‘ä¸­çš„è¯·æ±‚ä¹ŸåŸºæœ¬éƒ½æ˜¯<code>HTTP1</code>ã€‚</p><h3 id="HTTP1ä¸HTTP2-ä¹‹é—´çš„åŒºåˆ«"><a href="#HTTP1ä¸HTTP2-ä¹‹é—´çš„åŒºåˆ«" class="headerlink" title="HTTP1ä¸HTTP2 ä¹‹é—´çš„åŒºåˆ«"></a>HTTP1ä¸HTTP2 ä¹‹é—´çš„åŒºåˆ«</h3><p>HTTP/2ï¼ˆè¶…æ–‡æœ¬ä¼ è¾“åè®®ç¬¬2ç‰ˆï¼Œæœ€åˆå‘½ä»¤ä¸ºHTTP2.0ï¼‰ï¼Œæ˜¯HTTPåè®®çš„ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œä½¿ç”¨äºä¸‡ç»´ç½‘ã€‚HTTP/2æ˜¯HTTPåè®®è‡ª1999å¹´HTTP 1.1 å‘å¸ƒåçš„é¦–ä¸ªæ›´æ–°ï¼Œä¸»è¦åŸºäºSPDYåè®®ï¼ˆæ˜¯Googleå¼€å‘çš„åŸºäºTCPçš„åº”ç”¨å±‚åè®®ï¼Œç”¨ä»¥æœ€å°ç½‘ç»œå»¶è¿Ÿï¼Œæå‡ç½‘é€Ÿï¼Œä¼˜åŒ–ç”¨æˆ·ä½¿ç”¨ä½“éªŒï¼‰ã€‚ä¸»è¦åŒºåˆ«é›†ä¸­äºä¸‹é¢å››ä¸ªæ–¹é¢ï¼š</p><ol><li><p><code>HTTP/2</code> é‡‡ç”¨äºŒè¿›åˆ¶æ ¼å¼è€Œéæ–‡æœ¬æ ¼å¼ã€‚</p></li><li><p><code>HTTP/2</code> æ˜¯å®Œå…¨å¤šè·¯å¤ç”¨çš„ï¼Œè€Œéæœ‰åºå¹¶é˜»å¡çš„ï¼Œåªéœ€è¦ä¸€ä¸ªè¿æ¥å³å¯å®ç°å¹¶è¡Œã€‚</p></li><li><p>é€šè¿‡å‹ç¼©åŒ…å¤´ï¼Œ<code>HTTP/2</code>é™ä½äº†å¼€é”€ã€‚</p></li><li><p><code>HTTP/2</code>è®©æœåŠ¡å™¨å¯ä»¥å°†ä¸»åŠ¨çš„â€œæ¨é€â€åˆ°å®¢æˆ·ç«¯ç¼“å­˜ä¸­ã€‚</p></li></ol><h4 id="äºŒè¿›åˆ¶åè®®"><a href="#äºŒè¿›åˆ¶åè®®" class="headerlink" title="äºŒè¿›åˆ¶åè®®"></a>äºŒè¿›åˆ¶åè®®</h4><p>æœ€æ–°çš„<code>HTTP</code>ç‰ˆæœ¬åœ¨åŠŸèƒ½å’Œå±æ€§ï¼ˆä¾‹å¦‚ä»æ–‡æœ¬åè®®è½¬æ¢ä¸ºäºŒè¿›åˆ¶åè®®ï¼‰æ–¹é¢å·²ç»æœ‰äº†é‡å¤§å‘å±•ï¼Œ<code>HTTP1.x</code>ç”¨äºå¤„ç†æ–‡æœ¬å‘½ä»¤å·²å®Œæˆè¯·æ±‚-å“åº”å‘¨æœŸã€‚<code>HTTP/2</code>å°†ä½¿ç”¨äºŒè¿›åˆ¶å‘½ä»¤æ‰§è¡Œç›¸åŒçš„ä»»åŠ¡ï¼Œæ­¤å±æ€§å‡è½»äº†æ¡†æ¶çš„å¤æ‚æ€§ï¼Œå¹¶ç®€åŒ–äº†ç”±äºåŒ…å«æ–‡æœ¬å’Œå¯é€‰ç©ºæ ¼çš„å‘½ä»¤è€Œå¯¼è‡´æ··æ·†çš„å‘½ä»¤å’Œå®ç°ã€‚<strong>ä½¿ç”¨HTTP/2å®ç°çš„æµè§ˆå™¨ä¼šå°†ç›¸åŒçš„æ–‡æœ¬å‘½ä»¤è½¬æ¢ä¸ºäºŒè¿›åˆ¶å‘½ä»¤ï¼Œç„¶åå†é€šè¿‡ç½‘ç»œä¼ è¾“ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210828235701.png"></p><h4 id="è¯·æ±‚å¤šè·¯å¤ç”¨"><a href="#è¯·æ±‚å¤šè·¯å¤ç”¨" class="headerlink" title="è¯·æ±‚å¤šè·¯å¤ç”¨"></a>è¯·æ±‚å¤šè·¯å¤ç”¨</h4><p><code>HTTP/1.x</code>æœ‰ä¸ªé—®é¢˜å«çº¿ç«¯é˜»å¡ï¼ˆhead-of-blockingï¼‰ï¼Œå®ƒæ˜¯æŒ‡ä¸€ä¸ªè¿æ¥ï¼ˆconnectionï¼‰ä¸€æ¬¡åªæäº¤ä¸€ä¸ªè¯·æ±‚çš„æ•ˆç‡æ¯”è¾ƒé«˜ï¼Œå¤šäº†å°±ä¼šå˜æ…¢ã€‚<code>HTTP/1.1</code>è¯•è¿‡ç”¨æµæ°´çº¿ï¼ˆpipeliningï¼‰æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æ•ˆæœå¹¶ä¸ç†æƒ³ï¼ˆæ•°æ®é‡è¾ƒå¤§æˆ–è€…é€Ÿåº¦è¾ƒé«˜çš„å“åº”ï¼Œä¼šé˜»ç¢æ’åœ¨ä»–åé¢çš„è¯·æ±‚ï¼‰ï¼Œæ­¤å¤–ï¼Œç”±äºç½‘ç»œåª’ä»‹ï¼ˆintermediaryï¼‰å’ŒæœåŠ¡å™¨ä¸èƒ½å¾ˆå¥½çš„æ”¯æŒæµæ°´çº¿ï¼Œå¯¼è‡´éƒ¨ç½²èµ·æ¥å›°éš¾é‡é‡ã€‚<strong>è€Œå¤šè·¯ä¼ è¾“ï¼ˆMultiplexingï¼‰èƒ½å¾ˆå¥½çš„è§£å†³è¿™äº›é—®é¢˜ï¼Œå› ä¸ºå®ƒèƒ½åŒæ—¶å¤„ç†å¾ˆå¤šä¸ªæ¶ˆæ¯çš„è¯·æ±‚å’Œå“åº”</strong>ï¼›ç”šè‡³å¯ä»¥åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­å°†ä¸€ä¸ªæ¶ˆæ¯å’Œå¦ä¸€ä¸ªæºæ‚åœ¨ä¸€èµ·ã€‚æ‰€ä»¥å®¢æˆ·ç«¯åªéœ€è¦ä¸€ä¸ªè¿æ¥å°±èƒ½åŠ è½½ä¸€ä¸ªé¡µé¢ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210829005226.png"></p><h4 id="æ ‡å¤´å‹ç¼©"><a href="#æ ‡å¤´å‹ç¼©" class="headerlink" title="æ ‡å¤´å‹ç¼©"></a>æ ‡å¤´å‹ç¼©</h4><p><code>HTTP/2</code>å‹ç¼©å¤§é‡å†—ä½™å¤´å¸§ã€‚å®ƒä½¿ç”¨HPACKè§„èŒƒä½œä¸ºæ ‡å¤´å‹ç¼©çš„ç®€å•å®‰å…¨æ–¹æ³•ã€‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½åœ¨ç»´æŠ¤åœ¨å…ˆå‰çš„å®¢æˆ·ç«¯-æœåŠ¡å™¨è¯·æ±‚ä¸­ä½¿ç”¨çš„æ ‡å¤´åˆ—è¡¨ã€‚<strong>HPACK åœ¨å°†æ¯ä¸ªæ ‡å¤´ä¼ è¾“åˆ°æœåŠ¡å™¨ä¹‹å‰å…ˆå‹ç¼©æ¯ä¸ªæ ‡å¤´çš„å•ç‹¬å€¼ï¼Œç„¶åæœåŠ¡å™¨åœ¨å…ˆå‰ä¼ è¾“çš„æ ‡å¤´å€¼åˆ—è¡¨ä¸­æŸ¥æ‰¾ç¼–ç ä¿¡æ¯ï¼Œä»¥é‡å»ºå®Œæ•´çš„æ ‡å¤´ä¿¡æ¯ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210829005245.png"></p><h4 id="HTTP-2æœåŠ¡å™¨æ¨é€"><a href="#HTTP-2æœåŠ¡å™¨æ¨é€" class="headerlink" title="HTTP/2æœåŠ¡å™¨æ¨é€"></a>HTTP/2æœåŠ¡å™¨æ¨é€</h4><p><strong>æ­¤åŠŸèƒ½ä½¿ç”¨æœåŠ¡å™¨å¯ä»¥å‘å®¢æˆ·ç«¯å‘é€å…¶ä»–æœªç¼“å­˜çš„ä¿¡æ¯ï¼Œä½†è¿™äº›ä¿¡æ¯ä¼šåœ¨ä»¥åçš„è¯·æ±‚ä¸­å¾—åˆ°é¢„æœŸ</strong>ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯è¯·æ±‚èµ„æºXï¼Œå¹¶ä¸”å¯ä»¥ç†è§£èµ„æºYè¢«è¯·æ±‚æ–‡ä»¶å¼•ç”¨ï¼Œåˆ™æœåŠ¡å™¨å¯ä»¥é€‰æ‹©å°†Yä¸Xä¸€èµ·æ¨é€ï¼Œè€Œä¸æ˜¯ç­‰å¾…é€‚å½“çš„å®¢æˆ·ç«¯è¯·æ±‚ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210829005612.png"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬ä»‹ç»äº†å¤§å®¶å¤§å­¦åŸºæœ¬ä¸Šéƒ½è®°è¿‡çš„è®¡ç®—æœºç½‘ç»œæ¨¡å‹ï¼Œå…¶ä¸­åŒ…æ‹¬OSIä¸ƒå±‚æ¨¡å‹ï¼ŒTCP/IPäº”å±‚æ¨¡å‹ï¼Œå…¶ä¸­OSIä¸ƒå±‚æ¨¡å‹æ›´å¤šçš„æ˜¯é’ˆå¯¹<strong>ç‰¹å®šçš„åŠŸèƒ½</strong>æ¥è¿›è¡Œåˆ’åˆ†çš„ï¼Œè€ŒTCP/IPäº”å±‚æ¨¡å‹åˆ™æ›´å¤šçš„é’ˆå¯¹çš„æ˜¯<strong>åè®®åˆ’åˆ†</strong>ï¼Œæˆ‘ä»¬è½¯ä»¶å¼€å‘ä¹Ÿæ›´ä¾§é‡äºTCP/IPçš„äº”å±‚æ¨¡å‹ã€‚å…¶ä¸­æˆ‘ä»¬ä»‹ç»äº†æ¯ä¸€å±‚éƒ½æœ‰å“ªäº›ä»£è¡¨åè®®ï¼Œä¸çŸ¥é“ä½ ç°åœ¨è¿˜èƒ½ä¸èƒ½è®°èµ·æ¥ã€‚åœ¨ç¬¬äºŒä¸ªéƒ¨åˆ†ï¼Œæˆ‘ä»¬ä»‹ç»äº†ä¸€ä¸ªæ•°æ®åŒ…æ˜¯æµè½¬äºæ¨¡å‹çš„æ¯ä¸€å±‚ä¹‹é—´ï¼Œå¹¶ä¸”ä»‹ç»äº†è¿™ä¸ªæ•°æ®åŒ…æ˜¯å¦‚ä½•åœ¨ç½‘ç»œä¸Šè¿›è¡Œä¼ è¾“çš„ã€‚åœ¨æœ€åä¸€ä¸ªå¤§æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬é¡ºç€æ¨¡å‹ä»ä¸‹å¾€ä¸Šä»‹ç»äº†æ¯ä¸€å±‚å…·æœ‰ä»£è¡¨æ€§çš„ç½‘ç»œåè®®ã€‚åœ¨æ•°æ®é“¾è·¯å±‚ï¼Œæˆ‘ä»¬ä»‹ç»äº†ç”¨äºè·å–macåœ°å€çš„ARPåè®®ï¼Œç½‘ç»œå±‚ä»‹ç»äº†æ‰›æŠŠå­IPåè®®å’Œç½‘ç»œæ¢å­ICMPåè®®ï¼Œä¼ è¾“å±‚åˆ™ä»‹ç»äº†å‚»ç™½ç”œçš„UDPåè®®å’Œç»™TCPåè®®æŒ–çš„ä¸€ä¸ªå‘ã€‚æœ€ååº”ç”¨å±‚ï¼Œæˆ‘ä»¬ç®€å•æäº†ä¸‹HTTP/1å’ŒHTTP/2ä¹‹é—´çš„åŒºåˆ«ã€‚é€šè¿‡è¿™ä¸€å°èŠ‚çš„æ¢³ç†ï¼ŒåŸºæœ¬ä¸Šå¯¹ç½‘ç»œä¹Ÿæœ‰äº†ä¸€ä¸ªå¤§ä½“è®¤çŸ¥ã€‚ä¸‹ä¸€èŠ‚æˆ‘ä»¬å°†æ·±å…¥æ¢³ç†TCPåè®®ï¼Œçœ‹çœ‹TCPæ˜¯å¦‚ä½•ä¿è¯æ•°æ®åŒ…åˆå¥½åˆå¿«åœ°åœ¨å¤æ‚çš„ç½‘ç»œç¯å¢ƒä¸­ä¼ è¾“çš„ã€‚</p><h1 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h1><ul><li><p><a href="https://time.geekbang.org/column/article/8094">è¶£è°ˆç½‘ç»œåè®®ï¼ˆä»ç‰©ç†å±‚åˆ°MACå±‚ï¼šå¦‚ä½•åœ¨å®¿èˆé‡Œè‡ªå·±ç»„ç½‘ç©è”æœºæ¸¸æˆï¼Ÿï¼‰</a></p></li><li><p><a href="https://time.geekbang.org/column/article/8445">è¶£è°ˆç½‘ç»œåè®®ï¼ˆICMPä¸pingï¼šæŠ•çŸ³é—®è·¯çš„ä¾¦å¯Ÿå…µï¼‰</a></p></li><li><p><a href="https://blog.csdn.net/qq_41727218/article/details/82461089">IPåè®®è¯¦è§£</a></p></li><li><p><a href="https://book.douban.com/subject/26941639/">ç½‘ç»œæ˜¯æ€ä¹ˆè¿æ¥çš„</a></p></li><li><p><a href="https://haicoder.net/note/http-interview/http-interview-http1-http2.html">HTTP1ä¸HTTP2åŒºåˆ«</a></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>NIOä¸ç½‘ç»œç¼–ç¨‹</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
      <tag>è®¡ç®—æœºç½‘ç»œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM è¿›é˜¶ â€” å³æ—¶ç¼–è¯‘å…¥é—¨</title>
    <link href="/2021/08/02/icebreaker-of-JIT/"/>
    <url>/2021/08/02/icebreaker-of-JIT/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“Javaæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„è¯­è¨€ï¼Œä»–çš„è·¨å¹³å°å’ŒC++çš„æºç è·¨å¹³å°ä¸åŒï¼ŒJavaæ˜¯å­—èŠ‚ç è·¨å¹³å°ï¼Œå³Javaç¼–è¯‘å™¨æŠŠJavaæºä»£ç ç¼–è¯‘æˆ .class çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå°†.classæ–‡ä»¶éƒ¨ç½²åˆ°ä¸åŒçš„JVMå®ä¾‹ä¸Šè§£é‡Šæ‰§è¡Œã€‚è¿™ç§è§£é‡Šæ‰§è¡Œçš„æ–¹å¼æ˜¾ç„¶æ²¡æœ‰ç›´æ¥æœºå™¨ç æ‰§è¡Œæ•ˆç‡æ¥çš„é«˜ã€‚å› æ­¤Javaä¸ºäº†è·å–æ›´é«˜çš„æ‰§è¡Œæ•ˆç‡ï¼Œé€šè¿‡å°†çƒ­ç‚¹ä»£ç ç¼–è¯‘æˆæœºå™¨ç ï¼Œå¹¶å­˜å‚¨èµ·æ¥åå¤æ‰§è¡Œæ¥ä¼˜åŒ–æ‰§è¡Œæ•ˆç‡ï¼Œé‚£å³æ—¶ç¼–è¯‘(JIT)æ˜¯æ€ä¹ˆå·¥ä½œçš„ï¼Œå·¥ä½œæµç¨‹åˆæ˜¯æ€æ ·çš„ï¼Ÿæ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰"><a href="#ä»€ä¹ˆæ˜¯å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰" class="headerlink" title="ä»€ä¹ˆæ˜¯å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰"></a>ä»€ä¹ˆæ˜¯å³æ—¶ç¼–è¯‘ï¼ˆJITï¼‰</h2><p>å°±åƒæˆ‘ä»¬ä¸Šé¢è¯´çš„ï¼ŒJavaæ˜¯å…ˆç”¨Javaç¼–è¯‘å™¨å…ˆå°†Javaä»£ç ç¼–è¯‘æˆ.classæ–‡ä»¶ï¼Œç„¶ååœ¨JVMä¸Š<strong>è§£é‡Šæ‰§è¡Œ.class</strong>æ–‡ä»¶ã€‚è€Œå³æ—¶ç¼–è¯‘æ˜¯ä¸€é¡¹ç”¨äº<strong>æå‡åº”ç”¨ç¨‹åºè¿è¡Œæ•ˆç‡çš„æŠ€æœ¯</strong>ã€‚é€šå¸¸è€Œè¨€ï¼Œä»£ç ä¼šå…ˆè¢«Javaè™šæ‹Ÿæœºè§£é‡Šæ‰§è¡Œï¼Œä¹‹ååå¤æ‰§è¡Œçš„çƒ­ç‚¹ä»£ç ä¼šè¢«å³æ—¶ç¼–è¯‘æˆä¸ºæœºå™¨ç ï¼Œç›´æ¥è¿è¡Œåœ¨åº•å±‚ç¡¬ä»¶ä¹‹ä¸Šã€‚</p><blockquote><p>è§£é‡Šæ‰§è¡Œæ–¹ä¾¿ä½†æ˜¯é€Ÿåº¦æ¯”è¾ƒæ…¢ã€‚æœºå™¨ç æ‰§è¡Œç¼–è¯‘éº»çƒ¦ï¼Œä½†æ˜¯æ‰§è¡Œé€Ÿåº¦å¿«ã€‚é‚£ä¹ˆæ€ä¹ˆè°ƒå’Œè¿™ä¸ªçŸ›ç›¾å‘¢ï¼Ÿè¿™é‡Œçš„æ€æƒ³å’Œå†·çƒ­è¡¨ç±»ä¼¼ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å†·çƒ­ä»£ç æ¥å¤„ç†ï¼Œçƒ­ç‚¹ä»£ç æˆ‘ä»¬ä½¿ç”¨å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æˆæœºå™¨ç ï¼Œéçƒ­ç‚¹ä»£ç è§£é‡Šæ‰§è¡Œå°±å¥½ï¼Œè¿™æ ·æˆ‘ä»¬å°½å¯èƒ½åœ°æé«˜æ‰§è¡Œæ•ˆç‡ã€‚</p></blockquote><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210726155531.png"></p><h2 id="ä»£ç çŠ¶æ€æ”¶é›†â€”Profile"><a href="#ä»£ç çŠ¶æ€æ”¶é›†â€”Profile" class="headerlink" title="ä»£ç çŠ¶æ€æ”¶é›†â€”Profile"></a>ä»£ç çŠ¶æ€æ”¶é›†â€”Profile</h2><p>Javaä¼šæŠŠçƒ­ç‚¹ä»£ç ç¼–è¯‘æˆæœºå™¨ç æ‰§è¡Œï¼Œé‚£ä»€ä¹ˆæ‰ç®—æ˜¯çƒ­ç‚¹ä»£ç å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ç±»æ¯”åˆ°ç”Ÿæ´»ä¸­ï¼Œå¯¹äºä¸€ä¸ªäº’è”ç½‘å…¬å¸æ€æ ·ç¡®å®šæŸäº›ç”¨æˆ·æ‰ç®—æ˜¯é‡ç‚¹ç”¨æˆ·ï¼Ÿä»–ä»¬åˆæ˜¯æ€ä¹ˆåˆ¤æ–­çš„å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œé€šè¿‡åŸ‹ç‚¹çš„æ–¹å¼æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œç„¶åé€šè¿‡åˆ†æè¿™äº›æ”¶é›†æ¥çš„ä¿¡æ¯ç”Ÿæˆç”¨æˆ·ç”»åƒã€‚å…¶å®å¯¹äºä»£ç è¡Œä¸ºåˆ†æçš„æ–¹å¼ä¹Ÿæ˜¯è¿™æ ·çš„ä¸€å¥—é€»è¾‘ã€‚JVMä¼šåœ¨ä»£ç è¿è¡ŒæœŸé—´æ”¶é›†ä¸€äº›æ•°æ®æ¥ååº”ä»£ç çš„æ‰§è¡Œæƒ…å†µï¼Œè¿™é‡Œæ”¶é›†çš„æ•°æ®æˆ‘ä»¬ç§°ä¸ºç¨‹åºçš„ profile ã€‚</p><p>è¿™æ˜¯ä¸€ç§<strong>èƒ½ååº”ç¨‹åºè¿è¡ŒçŠ¶æ€çš„æ•°æ®</strong>ï¼Œå…¶ä¸­æœ€åŸºç¡€çš„åŒ…æ‹¬<strong>æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°</strong>ä»¥åŠ<strong>å¾ªç¯å›è¾¹çš„æ‰§è¡Œæ¬¡æ•°</strong>ã€‚æ­¤å¤–è¿˜åŒ…æ‹¬ï¼Œ<strong>è·³è½¬æ¬¡æ•°å’Œä¸è·³è½¬æ¬¡æ•°</strong>ï¼Œä»¥åŠ<strong>éç§æœ‰ç¤ºä¾‹æ–¹æ³•çš„è°ƒç”¨æŒ‡ä»¤</strong>ã€<strong>å¼ºåˆ¶ç±»å‹è½¬æ¢ checkcast æŒ‡ä»¤</strong>ï¼Œç±»å‹æµ‹è¯• <strong>instanceof æŒ‡ä»¤</strong>å’Œ<strong>å¼•ç”¨ç±»å‹çš„æ•°æ®å­˜å‚¨ aastore æŒ‡ä»¤ç±»å‹</strong>çš„ profileï¼ˆreceiver type profileï¼‰ã€‚è¿™äº›æ•°æ®æ”¶é›†èƒ½æ›´å¥½çš„ä¼˜åŒ–ä»£ç ï¼Œä½†ä¹Ÿä¼šå¸¦æ¥é¢å¤–ç¼–è¯‘æ€§èƒ½å¼€é”€ã€‚</p><blockquote><p>profile æ”¶é›†çš„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š</p><ul><li>æ”¶é›†ç¨‹åºæ•°æ®ï¼Œæ›´å¥½çš„ç¼–è¯‘ä¼˜åŒ–ä»£ç ã€‚</li><li>ç¼–è¯‘æ€§èƒ½ä¸‹é™ï¼ˆfull profiling ç›¸è¾ƒäº no profiling æ€§èƒ½ä¸‹é™ 30%ï¼‰</li></ul></blockquote><p>å¯èƒ½æœ‰äººä¼šè¯´ï¼ŒèŠ±è´¹è¿™ä¹ˆå¤šä»£ä»·æ”¶é›†è¿™äº›profileä¸å€¼å¾—ï¼Œçš„ç¡®å¦‚æœåªæ˜¯ç®€å•çš„ä¼˜åŒ–é‚£çš„ç¡®ä¸å€¼å¾—ã€‚ä½†æ˜¯<strong>å³æ—¶ç¼–è¯‘å™¨å¯ä»¥æ ¹æ®å¤§é‡profileåšå‡ºä»£ç è¡Œä¸ºçš„çŒœæµ‹ï¼Œä»è€Œåšå‡ºæ¯”è¾ƒæ¿€è¿›çš„ä¼˜åŒ–</strong>ï¼Œè¿™å°±å¾ˆåˆ’ç®—äº†ã€‚</p><h2 id="åˆ†å±‚ç¼–è¯‘"><a href="#åˆ†å±‚ç¼–è¯‘" class="headerlink" title="åˆ†å±‚ç¼–è¯‘"></a>åˆ†å±‚ç¼–è¯‘</h2><p>HotSpotè™šæ‹ŸæœºåŒ…å«å¤šä¸ªå³æ—¶ç¼–è¯‘å™¨<code>C1ã€C2å’ŒGraal</code>ï¼Œå…¶ä¸­ï¼ŒGraalæ˜¯ä¸€ä¸ªå®éªŒæ€§è´¨çš„å³æ—¶ç¼–è¯‘å™¨ï¼Œå¯ä»¥é€šè¿‡å‚æ•°<code>-XX:+UnlockExperimentalVMOptions</code> å’Œ <code>-XX:+UseJVMCICompiler</code> å¯ç”¨ï¼Œå¹¶ä¸”æ›¿æ¢C2ï¼Œåœ¨Java 7ä»¥å‰ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®ç¨‹åºï¼Œæˆ‘ä»¬é‡‡ç”¨<strong>ç¼–è¯‘æ•ˆç‡è¾ƒå¿«çš„C1</strong>ï¼Œå¯¹åº”çš„å‚æ•° <code>-client</code>ã€‚å¯¹äºæ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„ï¼Œæˆ–è€…å¯¹å³°å€¼æ€§èƒ½æœ‰è¦æ±‚çš„ç¨‹åºï¼Œæˆ‘ä»¬é‡‡ç”¨ç”Ÿæˆä»£ç æ‰§è¡Œæ•ˆç‡è¾ƒå¿«çš„C2ï¼Œå¯¹åº”å‚æ•°<code>-server</code>ã€‚</p><blockquote><p>C1ç¼–è¯‘é€Ÿåº¦å¿«ï¼ŒC2æ‰§è¡Œé€Ÿåº¦å¿«ã€‚</p></blockquote><p>Java7å¼•å…¥åˆ†å±‚ç¼–è¯‘ï¼ˆå¯¹åº”å‚æ•° -XX:+TieredCompilationï¼‰çš„æ¦‚å¿µï¼Œç»¼åˆäº†C1çš„å¯åŠ¨æ€§èƒ½å’ŒC2çš„å³°å€¼æ€§èƒ½ä¼˜åŠ¿ã€‚åˆ†å±‚ç¼–è¯‘å°†Javaè™šæ‹Ÿæœºçš„æ‰§è¡ŒçŠ¶æ€åˆ†ä¸ºäº†äº”ä¸ªå±‚æ¬¡ã€‚ä»¥ä¸‹ç”¨<code>C1ä»£ç </code>æ¥æŒ‡ä»£C1ç”Ÿæˆçš„æœºå™¨ç ï¼ŒC2ä»£ç æ¥æŒ‡ä»£ç”±C2ç”Ÿæˆçš„æœºå™¨ç ï¼Œè¿™ä»¥ä¸‹çš„äº”ä¸ªå±‚çº§åˆ†åˆ«æ˜¯ï¼š</p><ol><li><strong>è§£é‡Šæ‰§è¡Œã€‚</strong></li><li><strong>æ‰§è¡Œä¸å¸¦ profiling çš„ C1 ä»£ç ã€‚</strong></li><li><strong>æ‰§è¡Œä»…å¸¦æ–¹æ³•è°ƒç”¨æ¬¡æ•°å·²ç»å¾ªç¯å›è¾¹æ‰§è¡Œæ¬¡æ•° profiling çš„ C1 ä»£ç ã€‚</strong></li><li><strong>æ‰§è¡Œå¸¦æœ‰æ‰€æœ‰çš„profilingçš„C1ä»£ç ã€‚</strong></li><li><strong>æ‰§è¡Œ C2 ä»£ç ã€‚</strong></li></ol><p>é€šè¿‡æƒ…å†µä¸‹ï¼ŒC2ä»£ç çš„æ‰§è¡Œæ•ˆç‡è¦æ¯” C1 ä»£ç çš„é«˜å‡º<code>30%</code>ä»¥ä¸Šï¼Œè¿™æ˜¯å› ä¸ºprofiling è¶Šå¤šï¼Œå…¶é¢å¤–çš„æ€§èƒ½å¼€é”€è¶Šå¤§ã€‚JVMä¸­æä¾›å¾ˆå¤šprofileï¼Œå…¶ä¸­ JDK é™„å¸¦çš„ hprofã€‚è¿™äº›profiler å¤§å¤šæ•°é€šè¿‡æ³¨å…¥ï¼ˆinstrumentationï¼‰æˆ–è€… JVWTI äº‹ä»¶æ¥å®ç°çš„ã€‚Java è™šæ‹Ÿæœºä¹Ÿå†…ç½®äº† profilingã€‚åœ¨5ä¸ªå±‚æ¬¡çš„æ‰§è¡ŒçŠ¶æ€ä¸­ï¼Œ1å±‚å’Œ4å±‚ä¸ºç»ˆæ­¢çŠ¶æ€ã€‚å½“ä¸€ä¸ªæ–¹æ³•è¢«ç»ˆæ­¢çŠ¶æ€ç¼–è¯‘è¿‡åï¼Œå¦‚æœç¼–è¯‘åçš„ä»£ç å¹¶æ²¡æœ‰å¤±æ•ˆï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºæ˜¯ä¸ä¼šå†æ¬¡å‘å‡ºè¯¥æ–¹æ³•çš„ç¼–è¯‘è¯·æ±‚ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210726225155.png"></p><p>ä¸Šé¢åˆ—ä¸¾äº†4ä¸ªä¸åŒçš„ç¼–è¯‘è·¯å¾„ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œçƒ­ç‚¹æ–¹æ³•ä¼šè¢«3å±‚çš„C1ç¼–è¯‘ï¼Œç„¶åå†è¢«4å±‚çš„C2ç¼–è¯‘ã€‚å¦‚æœæ–¹æ³•çš„å­—èŠ‚ç æ•°ç›®æ¯”è¾ƒå°‘ï¼Œè€Œä¸”3å±‚çš„profilingæ²¡æœ‰å¯æ”¶é›†æ•°æ®ã€‚é‚£ä¹ˆï¼Œ<strong>Java è™šæ‹Ÿæœºæ–­å®šè¯¥æ–¹æ³•å¯¹äº C1 ä»£ç å’Œ C2 ä»£ç çš„æ‰§è¡Œæ•ˆç‡ç›¸åŒ</strong>ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒJavaè™šæ‹Ÿæœºä¼šåœ¨3å±‚ç¼–è¯‘ä¹‹åï¼Œ<strong>ç›´æ¥é€‰æ‹©ç”¨1å±‚çš„C1ç¼–è¯‘</strong>ã€‚ç”±äºè¿™æ˜¯ä¸€ä¸ªç»ˆæ­¢çŠ¶æ€ï¼Œå› æ­¤ Java è™šæ‹Ÿæœºä¸ä¼šç»§ç»­ç”¨4å±‚çš„C2ç¼–è¯‘ã€‚åœ¨C1å¿™ç¢Œçš„æƒ…å†µä¸‹ï¼ŒJavaè™šæ‹Ÿæœºåœ¨è§£é‡Šæ‰§è¡Œè¿‡ç¨‹ä¸­å¯¹ç¨‹åºè¿›è¡Œprofilingï¼Œè€Œåç›´æ¥ç”±4å±‚çš„C2ç¼–è¯‘ã€‚åœ¨C2å¿™ç¢Œçš„æƒ…å†µä¸‹ï¼Œæ–¹æ³•ä¼šè¢«2å±‚çš„C1ç¼–è¯‘ï¼Œç„¶åå†è¢«3å±‚çš„C1ç¼–è¯‘ï¼Œä»¥å‡å°‘æ–¹æ³•çš„3å±‚çš„æ‰§è¡Œæ—¶é—´ã€‚</p><blockquote><p>çƒ­ç‚¹ä»£ç  ä¸‰å±‚ C1 ç¼–è¯‘ï¼ŒC2 ç¼–è¯‘ã€‚</p><p>å¦‚æœ C1 ç¼–è¯‘å’Œ C2 ç¼–è¯‘æ•ˆç‡ç›¸åŒï¼ŒC1ç¼–è¯‘ã€‚</p><p>å¦‚æœ C1 å¿™ç¢Œï¼Œç›´æ¥ C2ã€‚</p><p>å¦‚æœ C2 å¿™ç¢Œï¼Œ2å±‚C1ç¼–è¯‘ï¼Œ3å±‚C1ç¼–è¯‘ã€‚</p></blockquote><p>Java8 é»˜è®¤å¼€å¯äº†åˆ†å±‚ç¼–è¯‘ã€‚ä¸ç®¡æ˜¯å¼€å¯è¿˜æ˜¯å…³é—­åˆ†å±‚ç¼–è¯‘ï¼Œ<code>-client</code>å’Œ<code>-server</code>ç”¨æ¥é€‰æ‹©å³æ—¶ç¼–è¯‘å™¨æ˜¯æ— æ•ˆçš„ã€‚<strong>å½“å…³é—­åˆ†å±‚ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼ŒJava è™šæ‹Ÿæœºå°†ç›´æ¥é‡‡ç”¨C2ã€‚</strong>å¦‚æœåªæ˜¯å¸Œæœ›ä½¿ç”¨C1è¿›è¡Œç¼–è¯‘ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å¯åŠ¨å‚æ•°<code>-XX:TieredStopAtLevel=1</code>ã€‚</p><blockquote><p>å³æ—¶ç¼–è¯‘çš„è§¦å‘æ—¶æœº</p><p><strong>Java è™šæ‹Ÿæœºæ˜¯æ ¹æ®æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ä»¥åŠå¾ªç¯å›è¾¹çš„æ‰§è¡Œæ¬¡æ•°æ¥è§¦å‘å³æ—¶ç¼–è¯‘çš„</strong>ã€‚ä½†æ˜¯JVMä¸ä¼šå¯¹æ‰§è¡Œæ¬¡æ•°è¿›è¡Œä¸€ä¸ªç²¾å‡†åœ°è®¡æ—¶ï¼Œåªéœ€è¦ä¸€ä¸ªè¶³å¤Ÿå¤§çš„å¤§æ¦‚çš„æ•°å€¼å°±èƒ½æ˜ç¡®åˆ’åˆ†å‡ºçƒ­ç‚¹ä»£ç åŒºåŸŸã€‚</p><p>åœ¨ä¸å¯ç”¨åˆ†å±‚ç¼–è¯‘çš„æƒ…å†µä¸‹ï¼Œå½“æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°å’Œå¾ªç¯å›è¾¹çš„æ¬¡æ•°çš„å’Œï¼Œè¶…è¿‡ç”±å‚æ•°<code>â€”XX:ComoileThreshold</code>æŒ‡å®šçš„é˜ˆå€¼æ—¶ï¼ˆä½¿ç”¨C1æ—¶ï¼Œè¯¥å€¼ä¸º1500ï¼Œä½¿ç”¨C2æ—¶ï¼Œè¯¥å€¼ä¸º10000ï¼‰ï¼Œä¾¿ä¼šè§¦å‘å³æ—¶ç¼–è¯‘ã€‚å½“å¯åŠ¨åˆ†å±‚ç¼–è¯‘æ—¶ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¸ä¼šé‡‡ç”¨ç”±å‚æ•° <code>-XX:ComplileThreshold</code> æŒ‡å®šé˜ˆå€¼å³è¯¥å‚æ•°ä¼šå¤±æ•ˆï¼Œè€Œæ˜¯å¦å¤–ä¸€å¥—é˜ˆå€¼ç³»ç»Ÿï¼Œå…¶ä¸­é˜ˆå€¼å¤§å°æ˜¯åŠ¨æ€è°ƒæ•´çš„ã€‚</p></blockquote><p>æˆ‘ä»¬é€šè¿‡è®¡ç®—æ–¹æ³•çš„<strong>è°ƒç”¨æ¬¡æ•°</strong>ã€<strong>å¾ªç¯å›è¾¹çš„æ‰§è¡Œæ¬¡æ•°</strong>æ¥åˆ¤æ–­ä¸€ä¸ªæ–¹æ³•æ˜¯å¦æ˜¯çƒ­ç‚¹æ–¹æ³•ã€‚åŒæ—¶å³æ—¶ç¼–è¯‘ä¹Ÿæ˜¯æ ¹æ®<strong>è¿™ä¸¤ä¸ªè®¡æ•°å™¨çš„å’Œ</strong>æ¥è§¦å‘çš„ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œé™¤äº†ä»¥æ–¹æ³•ä¸ºå•ä½çš„å³æ—¶ç¼–è¯‘ä¹‹å¤–ï¼ŒJavaè™šæ‹Ÿæœºè¿˜å­˜åœ¨<strong>å¦å¤–ä¸€ç§ä»¥å¾ªç¯ä¸ºå•ä½çš„å³æ—¶ç¼–è¯‘</strong>å«åš<code>On-Stack-Replacementï¼ˆOSRï¼‰</code>ã€‚å¾ªç¯å›è¾¹è®¡æ•°å™¨è§¦å‘çš„å°±æ˜¯è¿™ç§ç±»å‹çš„å³æ—¶ç¼–è¯‘ã€‚OSRå®é™…ä¸Šæ˜¯ä¸€ç§æŠ€æœ¯ï¼Œ**å®ƒæŒ‡çš„æ˜¯åœ¨ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒåŠ¨æ€åœ°æ›¿æ¢æ‰Javaæ–¹æ³•æ ˆæ¡¢ï¼Œä»è€Œä½¿å¾—ç¨‹åºèƒ½å¤Ÿåœ¨éæ–¹æ³•å…¥å£å¤„è¿›è¡Œè§£é‡Šæ‰§è¡Œå’Œç¼–è¯‘åçš„ä»£ç ä¹‹é—´çš„åˆ‡æ¢ã€‚äº‹å®ä¸Šï¼Œå»ä¼˜åŒ–é‡‡ç”¨çš„æŠ€æœ¯ä¹Ÿå¯ä»¥ç§°ä¹‹ä¸ºOSRã€‚<br>**</p><h2 id="åŸºäºProfilingçš„ä¼˜åŒ–"><a href="#åŸºäºProfilingçš„ä¼˜åŒ–" class="headerlink" title="åŸºäºProfilingçš„ä¼˜åŒ–"></a>åŸºäºProfilingçš„ä¼˜åŒ–</h2><p>æˆ‘ä»¬æåˆ°çš„JVMä¼šæ”¶é›†Profileå¯¹ä»£ç è¿›è¡Œåˆ†æä¼˜åŒ–ï¼Œä½†æ˜¯æ”¶é›†profileæœ¬èº«åˆæ¯”è¾ƒè€—è´¹æ€§èƒ½ï¼Œå› æ­¤JVMé€šè¿‡åˆ†å±‚ç¼–è¯‘çš„æ–¹å¼ï¼Œæ¥å¹³è¡¡æ”¶é›†profileå¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—å’Œä»£ç ä¼˜åŒ–åçš„æ€§èƒ½æå‡ã€‚å…¶ä¸­åˆ†æ”¯ profile å’Œç±»å‹ profile çš„æ”¶é›†å°†ç»™åº”ç”¨ç¨‹åºå¸¦æ¥ä¸å°çš„æ€§èƒ½å¼€é”€ï¼Œæ­£æ˜¯è¿™éƒ¨åˆ†é¢å¤–çš„ profilingï¼Œä½¿å¾—3å±‚C1ä»£ç çš„æ€§èƒ½æ¯”2å±‚C1ä»£ç åº•30%ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨è§£é‡Šæ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ”¶é›†åˆ†æ”¯ profile ä»¥åŠç±»å‹ profileã€‚<strong>åªæœ‰åœ¨è§¦å‘C1ç¼–è¯‘åï¼ŒJVM è®¤ä¸ºè¿™éƒ¨åˆ†ä»£ç æœ‰å¯èƒ½è¢«C2ç¼–è¯‘ï¼Œæ‰ä¼šåœ¨è¯¥æ–¹æ³•çš„C1ä»£ç ä¸­profilingã€‚</strong>é‚£ä¹ˆè¿™äº›C2è¿›è¡Œçš„<strong>æ¯”è¾ƒæ¿€è¿›çš„ä¼˜åŒ–</strong>æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ</p><h3 id="åŸºäºåˆ†æ”¯çš„-profile-ä¼˜åŒ–"><a href="#åŸºäºåˆ†æ”¯çš„-profile-ä¼˜åŒ–" class="headerlink" title="åŸºäºåˆ†æ”¯çš„ profile ä¼˜åŒ–"></a>åŸºäºåˆ†æ”¯çš„ profile ä¼˜åŒ–</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä¸‹é¢è¿™æ®µä»£ç ä¸­åŒ…å«ä¸¤ä¸ªæ¡ä»¶åˆ¤æ–­ã€‚ç¬¬ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­å°†æµ‹è¯•æ‰€è¾“å…¥çš„ boolean å€¼ï¼Œå¦‚æœä¸ºtrueï¼Œåˆ™å°†å±€éƒ¨å˜é‡ v è®¾ç½®ä¸ºæ‰€è¾“å…¥çš„ int å€¼ã€‚å¦‚æœä¸º falseï¼Œåˆ™å°†æ‰€è¾“å…¥çš„ int å€¼ç»è¿‡ä¸€ç•ªè¿ç®—åï¼Œå†å­˜å…¥å±€éƒ¨å˜é‡ v ä¸­ã€‚ç¬¬äºŒä¸ªåˆ¤æ–­æµ‹è¯•å±€éƒ¨å˜é‡ v æ˜¯å¦å’Œæ‰€è¾“å…¥çš„ int å€¼ç›¸ç­‰ã€‚å¦‚æœç›¸ç­‰ï¼Œåˆ™è¿”å› 0ã€‚å¦‚æœä¸ç­‰ï¼Œåˆ™å°†å±€éƒ¨å˜é‡ v ç»è¿‡ä¸€ç•ªè¿ç®—ä¹‹åï¼Œå†å°†ä¹‹è¿”å›ã€‚æ˜¾ç„¶ï¼Œå½“æ‰€è¾“å…¥çš„ boolean å€¼ä¸º true çš„æƒ…å†µä¸‹ï¼Œè¿™æ®µä»£ç å°†è¿”å› 0ï¼›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> f, <span class="hljs-keyword">int</span> in)</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> v;<br>  <span class="hljs-keyword">if</span> (f) &#123;<br>    v = in;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    v = (<span class="hljs-keyword">int</span>) Math.sin(in);<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (v == in) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> (<span class="hljs-keyword">int</span>) Math.cos(v);<br>  &#125;<br>&#125;<br><span class="hljs-comment">// ç¼–è¯‘è€Œæˆçš„å­—èŠ‚ç ï¼š</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span>, <span class="hljs-keyword">int</span>)</span></span>;<br>  Code:<br>     <span class="hljs-number">0</span>: iload_0<br>     <span class="hljs-number">1</span>: ifeq          <span class="hljs-number">9</span><br>     <span class="hljs-number">4</span>: iload_1<br>     <span class="hljs-number">5</span>: istore_2<br>     <span class="hljs-number">6</span>: goto          <span class="hljs-number">16</span><br>     <span class="hljs-number">9</span>: iload_1<br>    <span class="hljs-number">10</span>: i2d<br>    <span class="hljs-number">11</span>: invokestatic  java/lang/Math.sin:(D)D<br>    <span class="hljs-number">14</span>: d2i<br>    <span class="hljs-number">15</span>: istore_2<br>    <span class="hljs-number">16</span>: iload_2<br>    <span class="hljs-number">17</span>: iload_1<br>    <span class="hljs-number">18</span>: if_icmpne     <span class="hljs-number">23</span><br>    <span class="hljs-number">21</span>: iconst_0<br>    <span class="hljs-number">22</span>: ireturn<br>    <span class="hljs-number">23</span>: iload_2<br>    <span class="hljs-number">24</span>: i2d<br>    <span class="hljs-number">25</span>: invokestatic java/lang/Math.cos:(D)D<br>    <span class="hljs-number">28</span>: d2i<br>    <span class="hljs-number">29</span>: ireturn<br></code></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„ä»£ç æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç®€å•çš„æµç¨‹å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210730000007.png"></p><p>å‡è®¾åº”ç”¨ç¨‹åºè°ƒç”¨è¯¥æ–¹æ³•ï¼Œæ‰€ä¼ å…¥çš„ boolean å€¼çš†ä¸º trueã€‚é‚£ä¹ˆï¼Œåç§»é‡ä¸º 1 ä»¥åŠåç§»é‡ä¸º 18 çš„æ¡ä»¶è·³è½¬æŒ‡ä»¤æ‰€å¯¹åº”çš„åˆ†æ”¯ profile ä¸­ï¼Œè·³è½¬çš„æ¬¡æ•°éƒ½ä¸º0ã€‚å¹¶ä¸”ä¸¤ä¸ªè¿ç»­çš„ifåˆ¤æ–­éƒ½å¯ä»¥è·³è½¬ true åˆ†æ”¯ã€‚C2å¯ä»¥æ ¹æ®è¿™ä¸¤ä¸ªåˆ†æ”¯ profile åšå‡ºå‡è®¾ï¼ŒC2 ä¾¿ä¸å†ç¼–è¯‘è¿™ä¸¤ä¸ªæ¡ä»¶è·³è½¬è¯­å¥æ‰€å¯¹åº”çš„ flase åˆ†æ”¯ã€‚é‚£ä¹ˆæ¿€è¿›çš„ä¼˜åŒ–å°±å¯ä»¥åšæˆä¸‹é¢è¿™æ ·ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210730001314.png"></p><p>æ€»ç»“ä¸€ä¸‹ï¼Œæ ¹æ®æ¡ä»¶è·³è½¬æŒ‡ä»¤çš„åˆ†æ”¯ profileï¼Œå³æ—¶ç¼–è¯‘å™¨å¯ä»¥å°†ä»æœªæ‰§è¡Œçš„åˆ†æ”¯å‰ªæ‰ï¼Œä»¥å…ç¼–è¯‘è¿™äº›å¾ˆæœ‰å¯èƒ½ä¸ä¼šç”¨åˆ°çš„ä»£ç ï¼Œä»è€ŒèŠ‚çœç¼–è¯‘æ—¶é—´ä»¥åŠéƒ¨ç½²ä»£ç æ‰€è¦æ¶ˆè€—çš„å†…å­˜ç©ºé—´ï¼Œæ­¤å¤–ï¼Œ<strong>â€œå‰ªæâ€å°†ç²¾ç®€ç¨‹åºçš„æ•°æ®æµï¼Œä»è€Œè§¦å‘æ›´å¤šçš„ä¼˜åŒ–ã€‚</strong>åœ¨ç°å®ä¸­ï¼Œåˆ†æ”¯ profile å‡ºç°ä»…è·³è½¬æˆ–è€…ä¸è·³è½¬çš„æƒ…å†µå¹¶ä¸å¤šè§ã€‚å½“ç„¶ï¼Œå³æ—¶ç¼–è¯‘å™¨å¯¹åˆ†æ”¯ profile çš„åˆ©ç”¨ä¹Ÿä¸ä»…é™äºâ€œå‰ªæâ€ã€‚å®ƒè¿˜ä¼šæ ¹æ®åˆ†æ”¯ profileï¼Œè®¡ç®—æ¯ä¸€æ¡ç¨‹åºæ‰§è¡Œè·¯å¾„çš„æ¦‚ç‡ï¼Œä»¥ä¾¿æŸäº›ç¼–è¯‘å™¨çš„ä¼˜åŒ–ä¼˜å…ˆå¤„ç†æ¦‚ç‡è¾ƒé«˜çš„è·¯å¾„ã€‚</p><h3 id="åŸºäºç±»å‹-profile-çš„ä¼˜åŒ–"><a href="#åŸºäºç±»å‹-profile-çš„ä¼˜åŒ–" class="headerlink" title="åŸºäºç±»å‹ profile çš„ä¼˜åŒ–"></a>åŸºäºç±»å‹ profile çš„ä¼˜åŒ–</h3><p>è¿™ä¸€ä¸ªä¾‹å­æ˜¯å…³äºinstanceofä»¥åŠæ–¹æ³•è°ƒç”¨ç±»å‹ profileã€‚ä¸‹é¢è¿™æ®µä»£ç å°†æµ‹è¯•æ‰€ä¼ å…¥çš„å¯¹è±¡æ˜¯å¦ä¸º Exception çš„å®ä¾‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›å®ƒçš„ç³»ç»Ÿçš„å“ˆå¸Œå€¼ï¼›å¦‚æœä¸æ˜¯ï¼Œåˆ™è¿”å›å®ƒçš„å“ˆå¸Œå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object in)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (in <span class="hljs-keyword">instanceof</span> Exception) &#123;<br>    <span class="hljs-keyword">return</span> System.identityHashCode(in);<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">return</span> in.hashCode();<br>  &#125;<br>&#125;<br><span class="hljs-comment">// ç¼–è¯‘è€Œæˆçš„å­—èŠ‚ç ï¼š</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(java.lang.Object)</span></span>;<br>  Code:<br>     <span class="hljs-number">0</span>: aload_0<br>     <span class="hljs-number">1</span>: <span class="hljs-keyword">instanceof</span> java/lang/Exception<br>     <span class="hljs-number">4</span>: ifeq          <span class="hljs-number">12</span><br>     <span class="hljs-number">7</span>: aload_0<br>     <span class="hljs-number">8</span>: invokestatic java/lang/System.identityHashCode:(Ljava/lang/Object;)I<br>    <span class="hljs-number">11</span>: ireturn<br>    <span class="hljs-number">12</span>: aload_0<br>    <span class="hljs-number">13</span>: invokevirtual java/lang/Object.hashCode:()I<br>    <span class="hljs-number">16</span>: ireturn<br></code></pre></td></tr></table></figure><p>å‡è®¾åº”ç”¨ç¨‹åºè°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œæ‰€ä¼ å…¥çš„ Object çš†ä¸º Integer å®ä¾‹ï¼Œé‚£ä¹ˆï¼Œåç§»é‡ä¸º1çš„ instanceof æŒ‡ä»¤çš„ç±»å‹ profile ä»…ä»…åŒ…å« Integerï¼Œåç§»é‡ä¸º4çš„åˆ†æ”¯è·³è½¬è¯­å¥çš„åˆ†æ”¯ profile ä¸­ä¸è·³è½¬çš„æ¬¡æ•°ä¸º0ï¼Œåç§»é‡ä¸º13çš„æ–¹æ³•è°ƒç”¨æŒ‡ä»¤çš„ç±»å‹ profile ä»…åŒ…å« Integerã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210730004950.png"></p><p>åœ¨è™šæ‹Ÿæœºä¸­ï¼Œinstanceof æµ‹è¯•å¹¶ä¸ç®€å•ï¼Œå¦‚æœinstanceofçš„ç›®æ ‡ç±»å‹æ˜¯ final ç±»å‹ï¼Œé‚£ä¹ˆJavaè™šæ‹Ÿæœºä»…éœ€è¦æ¯”è¾ƒæµ‹è¯•å¯¹è±¡çš„åŠ¨æ€ç±»å‹æ˜¯å¦ä¸ºfinalç±»å‹å³å¯ï¼Œä½†æ˜¯å¦‚æœç›®æ ‡å¯¹è±¡ä¸æ˜¯ final ç±»å‹ï¼Œæ¯”å¦‚æˆ‘ä»¬ä¾‹å­ä¸­çš„Exceptionç±»å‹ï¼Œé‚£ä¹ˆ<strong>è™šæ‹Ÿæœºéœ€è¦ä»æµ‹è¯•å¯¹è±¡çš„åŠ¨æ€ç±»å‹å¼€å§‹ï¼Œä¸€æ¬¡æµ‹è¯•è¯¥ç±»ï¼Œè¯¥ç±»çš„çˆ¶ç±»ï¼Œç¥–å…ˆç±»ï¼Œè¯¥ç±»æ‰€æœ‰ç›´æ¥å®ç°æˆ–è€…é—´æ¥å®ç°çš„æ¥å£æ˜¯å¦ä¸ç›®æ ‡ç±»å‹ä¸€è‡´ã€‚</strong>ä¸è¿‡æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œinstanceof æŒ‡ä»¤çš„ç±»å‹ profile ä»…åŒ…å« Integerï¼Œæ ¹æ®è¿™ä¸ªä¿¡æ¯ï¼Œå³æ—¶ç¼–è¯‘å™¨å¯ä»¥å‡è®¾ï¼Œåœ¨æ¥ä¸‹æ¥çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œæ‰€è¾“å…¥çš„ Object å¯¹è±¡ä»ç„¶æ˜¯Integerå®ä¾‹ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œç»§ç»­æ‰§è¡Œä¸€ä¸‹ä»£ç ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Integer</span> ... </span>&#123;<br>    ...<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> Integer.hashCode(value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure><p>æ•´ä½“çš„ä»£ç é€»è¾‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210730010254.png"></p><p>å’Œä¸Šé¢é‚£ä¸ªä¾‹å­ä¸€æ ·ï¼Œæ ¹æ® profile çš„åˆ†æï¼Œå¯ä»¥è¢«æ¿€è¿›çš„ä¼˜åŒ–æˆä»¥ä¸‹å½¢å¼ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210730010312.png"></p><p>å’ŒåŸºäºåˆ†æ”¯ profile ä¼˜åŒ–ä¸€æ ·ï¼ŒåŸºäºç±»å‹ profile çš„ä¼˜åŒ–åŒæ ·ä¹Ÿæ˜¯åšå‡ºå‡è®¾ï¼Œä»è€Œç²¾ç®€æ§åˆ¶æµä»¥åŠæ•°æ®æµï¼Œè¿™ä¸¤è€…æ ¸å¿ƒéƒ½æ˜¯å‡è®¾ã€‚å¯¹äºåˆ†æ”¯ profileï¼Œå³æ—¶ç¼–è¯‘å™¨å‡è®¾çš„æ˜¯ä»…æ‰§è¡ŒæŸä¸€ä¸ªåˆ†æ”¯ï¼Œå¯¹äºç±»å‹ profileï¼Œå³æ—¶ç¼–è¯‘å™¨å‡è®¾å¯¹è±¡çš„åŠ¨æ€ç±»å‹ä»…ä¸ºç±»å‹profileä¸­çš„é‚£å‡ ä¸ªã€‚è¿™ä¸€åˆ‡éƒ½æ˜¯å‡è®¾æˆåŠŸçš„æƒ…å†µï¼Œé‚£ä¹ˆå¦‚æœå‡è®¾å¤±è´¥äº†ï¼Œé‚£ä¹ˆç¨‹åºè¯¥å¦‚ä½•æ‰§è¡Œä¸‹å»ï¼Ÿ</p><h3 id="å»ä¼˜åŒ–"><a href="#å»ä¼˜åŒ–" class="headerlink" title="å»ä¼˜åŒ–"></a>å»ä¼˜åŒ–</h3><p>å‰é¢çš„è¿™äº›ä¼˜åŒ–éƒ½æ˜¯åŸºäºå‡è®¾ï¼Œé‚£ä¹ˆå¦‚æœå‡è®¾ä¸æˆç«‹æ€ä¹ˆåŠï¼ŸJVMç»™çš„è§£å†³æ–¹æ¡ˆä¾¿æ˜¯<strong>å»ä¼˜åŒ–</strong>ï¼Œå³ä»æ‰§è¡Œå³æ—¶ç¼–è¯‘ç”Ÿæˆçš„æœºå™¨ç åˆ‡æ¢å›è§£é‡Šæ‰§è¡Œã€‚åœ¨ç”Ÿæˆçš„æœºå™¨ç ä¸­ï¼Œå³æ—¶ç¼–è¯‘å™¨åœ¨å‡è®¾å¤±è´¥çš„ä½ç½®ä¸Šæ’å…¥ä¸€ä¸ªé™·é˜±ï¼ˆtrapï¼‰ã€‚è¯¥é™·é˜±å®é™…ä¸Šæ˜¯<strong>ä¸€æ¡callæŒ‡ä»¤</strong>ï¼Œè°ƒç”¨è‡³ Java è™šæ‹Ÿæœºé‡Œä¸“é—¨è´Ÿè´£å»ä¼˜åŒ–ã€‚ä¸æ™®é€šçš„callæŒ‡ä»¤ä¸æ˜¯ä¸€æ ·çš„ï¼Œå»ä¼˜åŒ–æ–¹æ³•å°†æ›´æ”¹æ ˆä¸Šçš„è¿”å›åœ°å€ï¼Œå¹¶ä¸å†è¿”å›å³æ—¶ç¼–è¯‘å™¨çš„ç”Ÿæˆçš„æœºå™¨ç ä¸­ã€‚<strong>åœ¨ä¸Šé¢çš„æµç¨‹å›¾ä¸­æœ‰å¾ˆå¤šçº¢è‰²çš„æ–¹æ¡†é—®å·ï¼Œè¿™äº›é—®å·ä»£è¡¨ä¸€ä¸ªä¸ªé™·é˜±è°ƒç”¨ï¼Œå¦‚æœæµç¨‹èµ°åˆ°è¿™é‡Œï¼Œä¾¿å°†å‘ç”Ÿå»ä¼˜åŒ–å¹¶ä¸”åˆ‡æ¢è‡³è§£é‡Šæ‰§è¡Œ</strong>ã€‚å»ä¼˜åŒ–çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å½“å‰æœºå™¨ç çš„æ‰§è¡ŒçŠ¶æ€è½¬æ¢è‡³æŸä¸€è¡Œå­—èŠ‚ç ä¹‹å‰çš„çŠ¶æ€ï¼Œå¹¶ä¸”ä»è¯¥å­—èŠ‚ç å¼€å§‹æ‰§è¡Œã€‚è¿™<strong>éœ€è¦å³æ—¶ç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­è®°å½•å¥½è¿™ä¸¤ç§çŠ¶æ€çš„æ˜ å°„ã€‚å¦‚æœå»ä¼˜åŒ–çš„åŸå› å’Œä¼˜åŒ–æ— å…³åˆ™ä¿ç•™æœºå™¨ç ï¼Œå¦‚æœå»ä¼˜åŒ–çš„åŸå› å’Œprofileæ¿€è¿›åˆ†ææœ‰å…³ï¼Œé‚£å°±ç›´æ¥åˆ é™¤æœºå™¨ç ï¼Œä¾æ®profileé‡æ–°ç”Ÿæˆä¸€ä»½ã€‚</strong></p><h2 id="ä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆIRï¼‰"><a href="#ä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆIRï¼‰" class="headerlink" title="ä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆIRï¼‰"></a>ä¸­é—´è¡¨è¾¾å½¢å¼ï¼ˆIRï¼‰</h2><p>å‰é¢æˆ‘ä»¬ä»‹ç»çš„ä¼˜åŒ–è¿‡ç¨‹éƒ½æ˜¯ä»¥æµç¨‹å›¾çš„æ–¹å¼ï¼Œå±•å¼€å³æ—¶ç¼–è¯‘å™¨é’ˆå¯¹ profile çš„ä¼˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šä¸æ˜¯è¿™æ ·çš„ã€‚åœ¨ç¼–è¯‘åŸç†ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å°†ç¼–è¯‘å™¨åˆ†ä¸ºå‰ç«¯å’Œåç«¯ã€‚å…¶ä¸­ï¼Œå‰ç«¯ä¼šå¯¹æ‰€è¾“å…¥çš„ç¨‹åºè¿›è¡Œæ­¤æ³•åˆ†æã€è¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æï¼Œç„¶åç”Ÿæˆä¸­é—´è¡¨è¾¾å½¢å¼ï¼Œä¹Ÿå°±æ˜¯ IRï¼ˆIntermediate Representationï¼‰ã€‚åæ®µä¼šå¯¹ IR è¿›è¡Œä¼˜åŒ–ï¼Œç„¶åç”Ÿæˆç›®æ ‡ä»£ç ã€‚å¦‚æœä¸è€ƒè™‘è§£é‡Šæ‰§è¡Œçš„è¯ï¼Œä»Javæºä»£ç åˆ°æœ€ç»ˆçš„æœºå™¨ç å®é™…ä¸Šç»è¿‡äº†ä¸¤è½®ç¼–è¯‘ï¼š<strong>æºä»£ç  â€“ Javaç¼–è¯‘å™¨ â€“&gt; Javaå­—èŠ‚ç ï¼ŒJavaå­—èŠ‚ç  â€“å³æ—¶ç¼–è¯‘å™¨ â€“&gt; æœºå™¨ç ã€‚</strong></p><p>å¯¹äºå³æ—¶ç¼–è¯‘å™¨æ¥è¯´ï¼Œæ‰€è¾“å…¥çš„Javaå­—èŠ‚ç å‰¥ç¦»äº†å¾ˆå¤šçš„é«˜çº§Javaè¯­æ³•ï¼Œè€Œä¸”é‡‡ç”¨çš„åŸºäºæ ˆçš„è®¡ç®—æ¨¡å‹éå¸¸å®¹æ˜“å»ºæ¨¡ã€‚å› æ­¤ï¼Œå³æ—¶ç¼–è¯‘å™¨å¹¶ä¸éœ€è¦é‡æ–°è¿›è¡Œè¯æ³•åˆ†æã€è¯­æ³•åˆ†æä»¥åŠè¯­ä¹‰åˆ†æï¼Œè€Œæ˜¯<strong>ç›´æ¥å°†Javaå­—èŠ‚ç ä½œä¸ºä¸€ç§ IR</strong>ã€‚ä¸è¿‡ï¼ŒJava å­—èŠ‚ç æœ¬èº«ä¸é€‚åˆç›´æ¥ä½œä¸ºå¯ä¾›ä¼˜åŒ–çš„IRï¼Œè¿™æ˜¯å› ä¸ºç°ä»£ç¼–è¯‘å™¨ä¸€èˆ¬é‡‡ç”¨çš„é™æ€å•èµ‹å€¼ï¼ˆStatic Single Assignmentï¼Œ SSAï¼‰IRï¼Œè¿™ç§IRç‰¹ç‚¹æ˜¯æ¯ä¸ªå˜é‡åªèƒ½è¢«èµ‹å€¼ä¸€æ¬¡ï¼Œè€Œä¸”åªæœ‰å½“å˜é‡è¢«èµ‹å€¼ä¹‹åæ‰èƒ½ä½¿ç”¨ã€‚å…¶ä¸­ SSA IR å¯¹ä¼˜åŒ–ä¹Ÿèƒ½æä¾›å¾ˆå¤§çš„å¸®åŠ©ï¼š</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sas">ä»¥ä¸‹æ˜¯å‡ ç§å¸¸è§çš„ä¼˜åŒ–ï¼š<br>å¸¸é‡æŠ˜å ï¼š<span class="hljs-meta">x</span> = 3 <span class="hljs-comment">* 4;</span> -&gt; <span class="hljs-meta">x</span> = 12;<br>å¸¸é‡ä¼ æ’­ï¼š<span class="hljs-meta">x</span> = 3ï¼›y = <span class="hljs-meta">x</span>; -&gt; y = 3;<br>å¼ºåº¦å‰Šå¼±ï¼šy = <span class="hljs-meta">x</span> <span class="hljs-comment">* 5;</span> -&gt; y = (<span class="hljs-meta">x</span> &gt;&gt; 2) <span class="hljs-comment">* x;</span><br>æ­»ä»£ç åˆ é™¤ï¼š<span class="hljs-meta">if</span>ï¼ˆ2 &gt; 3) <span class="hljs-meta">x</span> = 1 <span class="hljs-meta">else</span> <span class="hljs-meta">x</span> = 2; -&gt; <span class="hljs-meta">x</span> = 2;<br>...<br></code></pre></td></tr></table></figure><h3 id="Sea-of-Nodes"><a href="#Sea-of-Nodes" class="headerlink" title="Sea-of-Nodes"></a>Sea-of-Nodes</h3><p>HotSpot é‡Œé¢çš„C2é‡‡ç”¨çš„æ˜¯ä¸€ç§åä¸º Sea-of-Nodes çš„ SSA IRã€‚å®ƒæœ€å¤§çš„ç‰¹ç‚¹ï¼Œä¾¿æ˜¯<strong>å»é™¤äº†å˜é‡çš„æ¦‚å¿µã€‚</strong>ç›´æ¥é‡‡ç”¨å˜é‡æ‰€æŒ‡å‘çš„å€¼ï¼Œæ¥è¿›è¡Œè¿ç®—ã€‚åœ¨ä¸Šé¢è¿™æ®µ SSA ä¼ªä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¤šä¸ªå˜é‡å x1ã€x2ã€y1å’Œy2ã€‚è¿™åœ¨ Sea-of-Nodes å°†ä¸å¤å­˜åœ¨ã€‚å–è€Œä»£ä¹‹çš„å¯¹åº”çš„å€¼ã€‚æ¯”å¦‚è¯´ Phi(y1ï¼Œy2) å˜æˆ Phi(0, 1)ï¼Œåè€…æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå€¼ï¼Œè¢«å…¶ä»–IRèŠ‚ç‚¹æ‰€ä¾èµ–ã€‚æ­£å› å¦‚æ­¤ï¼Œå¸¸é‡ä¼ æ’­åœ¨ Sea-of-Nodes ä¸­å˜æˆäº†ä¸€ä¸ªno-opï¼ˆno-opreationï¼‰ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> count)</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>    sum += i;<br>  &#125;<br>  <span class="hljs-keyword">return</span> sum;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç å¯¹åº”çš„IRå›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210801142510.png"></p><p>ä¸Šå›¾ä¸­ï¼ŒB0ã€B1ã€B2è¿™äº›éƒ½æ˜¯ä¸€ä¸ªä¸ªåŸºæœ¬å—ï¼Œå—ä¸å—ä¹‹é—´é€šè¿‡çº¢è‰²å’Œè“è‰²çš„çº¿è¿æ¥ï¼Œå…¶ä¸­<strong>çº¢è‰²ä»£è¡¨æ•°æ®æµï¼Œè“è‰²ä»£è¡¨æ§åˆ¶æµ</strong>ã€‚ä¸Šé¢çš„å›¾ä¸­ 0 ä»£è¡¨ç¨‹åºå…¥å£ï¼Œ21ä»£è¡¨ç¨‹åºå‡ºå£ã€‚è¢«æ§åˆ¶æµè¾¹æ‰€è¿æ¥çš„æ˜¯å›ºå®šèŠ‚ç‚¹ï¼Œå…¶ä»–çš„çš†å±äºæµ®åŠ¨èŠ‚ç‚¹ã€‚<strong>æµ®åŠ¨èŠ‚ç‚¹çš„ä½ç½®å¹¶ä¸å›ºå®šï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨éœ€è¦å¤šæ¬¡è®¡ç®—æµ®åŠ¨èŠ‚ç‚¹çš„å…·ä½“çš„æ’å¸ƒä½ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹æˆ‘ä»¬ç§°ä¹‹ä¸ºèŠ‚ç‚¹è°ƒåº¦ï¼ˆnode schedulingï¼‰ã€‚</strong></p><h3 id="Global-Value-Numbering-ä¼˜åŒ–"><a href="#Global-Value-Numbering-ä¼˜åŒ–" class="headerlink" title="Global Value Numbering ä¼˜åŒ–"></a>Global Value Numbering ä¼˜åŒ–</h3><p>å› ä¸ºSea-of-Nodesdeç‰¹æ€§å¾ˆå®¹æ˜“åšåˆ°çš„ä¼˜åŒ–æŠ€æœ¯â€”Global Value Numberingï¼ˆGVNï¼‰ã€‚GVN æ˜¯ä¸€ç§å‘ç°å¹¶æ¶ˆé™¤ç­‰ä»·è®¡ç®—çš„ä¼˜åŒ–æŠ€æœ¯ï¼Œ<strong>ä¾‹å¦‚å¦‚æœä¸€æ®µç¨‹åºä¸­å‡ºç°äº†å¤šæ¬¡æ“ä½œç›¸åŒçš„ä¹˜æ•°ï¼Œé‚£ä¹ˆå³æ—¶ç¼–è¯‘å™¨å¯ä»¥å°†è¿™äº›ä¹˜æ³•åˆå¹¶ä¸ºä¸€ä¸ªã€‚ä»è€Œé™ä½è¾“å‡ºæœºå™¨ç çš„å¤§å°ã€‚å¦‚æœè¿™äº›ä¹˜æ³•å‡ºç°åœ¨åŒä¸€æ¡æ‰§è¡Œè·¯å¾„ä¸Šï¼Œé‚£ä¹ˆGVNè¿˜å°†å‰©ä¸‹å†—ä½™çš„ä¹˜æ³•æ“ä½œ</strong>ã€‚æ‰€ä»¥å¦‚æœä¸€ä¸ªæµ®åŠ¨èŠ‚ç‚¹æœ¬èº«ä¸å­˜åœ¨å†…å­˜å‰¯ä½œç”¨ï¼ˆå¯èƒ½ä¼šå¼•å‘æºä»£ç ä¸­çš„ä¸å¯èƒ½å‡ºç°çš„æƒ…å†µï¼‰ï¼Œ<strong>é‚£ä¹ˆå³æ—¶ç¼–è¯‘å™¨åªéœ€è¦åˆ¤æ–­æµ®åŠ¨èŠ‚ç‚¹æ˜¯å¦å·²å­˜åœ¨çš„æµ®åŠ¨èŠ‚ç‚¹çš„ç±»å‹ç›¸åŒï¼Œæ‰€è¾“å…¥çš„IRèŠ‚ç‚¹æ˜¯å¦ä¸€è‡´ï¼Œä¾¿å¯ä»¥å°†è¿™ä¸¤ä¸ªæµ®åŠ¨èŠ‚ç‚¹å½’å¹¶ä¸ºä¸€ä¸ªã€‚</strong></p><blockquote><p>æˆ‘ä»¬å¯ä»¥å°† GVN ç†è§£ä¸ºåœ¨ IR å›¾ä¸Šçš„å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ï¼ˆCommon Subexpression Eliminateï¼ŒCSEï¼‰ï¼Œç±»ä¼¼æ¶ˆæ¶ˆä¹ã€‚ã€‚</p></blockquote><h3 id="æ–¹æ³•å†…è”ä¼˜åŒ–"><a href="#æ–¹æ³•å†…è”ä¼˜åŒ–" class="headerlink" title="æ–¹æ³•å†…è”ä¼˜åŒ–"></a>æ–¹æ³•å†…è”ä¼˜åŒ–</h3><p>æ–¹æ³•å†…è”æŒ‡çš„æ˜¯ï¼š<strong>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°æ–¹æ³•è°ƒç”¨æ—¶ï¼Œå°†ç›®æ ‡æ–¹æ³•ä½“çº³å…¥ç¼–è¯‘èŒƒå›´ä¹‹ä¸­ï¼Œå¹¶å–ä»£åŸæ–¹æ³•è°ƒç”¨çš„ä¼˜åŒ–æ‰‹æ®µã€‚</strong>æ–¹æ³•å†…è”ä¸ä»…å¯ä»¥æ¶ˆé™¤è°ƒç”¨æœ¬èº«å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œè¿˜å¯ä»¥è¿›ä¸€æ­¥è§¦å‘æ›´å¤šçš„ä¼˜åŒ–ï¼Œå› æ­¤ï¼Œä»–å¯ä»¥ç®—æ˜¯ç¼–è¯‘ä¼˜åŒ–é‡Œé¢æœ€é‡è¦çš„ä¸€ç¯ã€‚åœ¨C2ä¸­ï¼Œæ–¹æ³•å†…è”æ˜¯åœ¨è§£æå­—èŠ‚ç çš„è¿‡ç¨‹ä¸­å®Œæˆçš„ã€‚æ¯å½“ç¢°åˆ°æ–¹æ³•è°ƒç”¨å­—èŠ‚ç æ—¶å€™ï¼ŒC2å°†å†³å®šæ˜¯å’Œå¦éœ€è¦å†…è”è¯¥æ–¹æ³•è°ƒç”¨ã€‚å¦‚æœéœ€è¦å†…è”ï¼Œåˆ™å¼€å§‹è§£æç›®æ ‡æ–¹æ³•çš„å­—èŠ‚ç ã€‚</p><blockquote><p>å³æ—¶ç¼–è¯‘å™¨é¦–å…ˆè§£æå­—èŠ‚ç ï¼Œå¹¶ç”ŸæˆIRå›¾ï¼Œç„¶ååœ¨è¯¥ IR å›¾ä¸Šè¿›è¡Œä¼˜åŒ–ã€‚æ¯ä¸ªä¼˜åŒ–æ˜¯ç”±ä¸€ä¸ªä¸ªç‹¬ç«‹çš„ä¼˜åŒ–èŠ‚ç‚¹ï¼ˆoptimization phaseï¼‰ä¸²è”èµ·æ¥çš„ã€‚æ¯ä¸ªä¼˜åŒ–é˜¶æ®µä¼šå¯¹ IR å›¾è¿›è¡Œè½¬æ¢ã€‚æœ€åå³æ—¶ç¼–è¯‘å™¨æ ¹æ® IR å›¾çš„èŠ‚ç‚¹ä»¥åŠè°ƒç”¨é¡ºåºç”Ÿæˆæœºå™¨ç ã€‚</p></blockquote><p>å…·ä½“æ–¹æ³•å†…è”çš„è¿‡ç¨‹å¯ä»¥çœ‹ä¸‹é¢æ®µä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">æ–¹æ³•å†…è”çš„è¿‡ç¨‹<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">boolean</span> flag = <span class="hljs-keyword">true</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> value0 = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> value1 = <span class="hljs-number">1</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">foo</span><span class="hljs-params">(<span class="hljs-keyword">int</span> value)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> result = bar(flag);<br>    <span class="hljs-keyword">if</span> (result != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> value;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">bar</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> flag)</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> flag ? value0 : value1;<br>&#125;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­å¯ä»¥è¿™æ®µä»£ç çš„ IR å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210801155649.png"></p><p>åœ¨ç¼–è¯‘ foo æ–¹æ³•æ—¶ï¼Œå…¶å¯¹åº”çš„ IR å›¾ä¸­å°†å‡ºç°å¯¹ bar æ–¹æ³•çš„è°ƒç”¨ï¼Œå³å›¾ä¸Šçš„5å· invoke èŠ‚ç‚¹ã€‚å¦‚æœå†…è”ç®—æ³•åˆ¤å®šåº”å½“å†…è”å¯¹ bar æ–¹æ³•çš„è°ƒç”¨æ—¶ï¼Œé‚£ä¹ˆå³æ—¶ç¼–è¯‘å™¨å°†å¼€å§‹è§£æ bar çš„æ–¹æ³•çš„å­—èŠ‚ç ï¼Œå¹¶ç”Ÿæˆä¸‹é¢çš„IRå›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210801160041.png"></p><p>ç„¶åæˆ‘ä»¬å°†è¿™éƒ¨åˆ†IRå›¾å¤åˆ¶å¸¦å…¥åˆ°åŸæœ¬çš„å›¾ä¸­ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸‹é¢å›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210801160519.png"></p><p>åœ¨å®Œæˆè¿™ä¸€æ­¥æ“ä½œåï¼Œå³æ—¶ç¼–è¯‘å™¨è¿˜éœ€è¦è¿›è¡Œé¢å¤–ä»¥ä¸‹ä¸‰æ­¥æ“ä½œï¼ˆå›¾ä¸å›¾ä¹‹é—´çš„è¿æ¥æ“ä½œï¼‰ï¼š</p><ol><li>è¢«è°ƒç”¨æ–¹æ³•çš„ä¼ å…¥å‚æ•°èŠ‚ç‚¹ï¼Œè¢«æ›¿æ¢æˆè°ƒç”¨è€…æ–¹æ³•è¿›è¡Œæ–¹æ³•è°ƒç”¨æ—¶æ‰€ä¼ å…¥çš„å‚æ•°å¯¹åº”çš„èŠ‚ç‚¹ã€‚åœ¨ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°† bar æ–¹æ³• IR å›¾çš„1å· P(0) èŠ‚ç‚¹æ›¿æ¢ä¸º foo æ–¹æ³• IR å›¾ä¸­çš„3å· LoadFiled èŠ‚ç‚¹ã€‚ï¼ˆ<strong>å¤„ç†å…¥å£</strong>ï¼‰ã€‚</li><li>åœ¨è°ƒç”¨è€…æ–¹æ³•çš„IRå›¾ä¸­ï¼Œæ‰€æœ‰æŒ‡å‘åŸæ–¹æ³•è°ƒç”¨èŠ‚ç‚¹çš„æ•°æ®ä¾èµ–å°†é‡æ–°æŒ‡å‘è¢«è°ƒç”¨æ–¹æ³•çš„è¿”å›èŠ‚ç‚¹ã€‚å¦‚æœè¢«è°ƒç”¨æ–¹æ³•å­˜åœ¨å¤šä¸ªè¿”å›èŠ‚ç‚¹ï¼Œåˆ™ç”Ÿæˆä¸€ä¸ª Phi èŠ‚ç‚¹ï¼Œå°†è¿™äº›è¿”å›å€¼èšåˆèµ·æ¥ï¼Œå¹¶ä½œä¸ºåŸæ–¹æ³•è°ƒç”¨èŠ‚ç‚¹çš„æ›¿æ¢å¯¹è±¡ã€‚ï¼ˆ<strong>å¤„ç†å‡ºå£</strong>ï¼‰ã€‚</li><li>å¦‚æœè¢«è°ƒç”¨æ–¹æ³•å°†æŠ›å‡ºæŸç§ç±»å‹çš„å¼‚å¸¸ï¼Œè€Œè°ƒç”¨è€…æ–¹æ³•æ°å¥½æœ‰è¯¥å¼‚å¸¸ç±»å‹çš„å¤„ç†å™¨ï¼Œå¹¶ä¸”è¯¥ç±»å‹å¼‚å¸¸çš„è·¯å¾„è¦†ç›–è¿™ä¸€æ–¹æ³•è°ƒç”¨ï¼Œé‚£ä¹ˆå³æ—¶ç¼–è¯‘å™¨éœ€è¦å°†è¢«è°ƒç”¨æ–¹æ³•æŠ›å‡ºå¼‚å¸¸çš„è·¯å¾„ï¼Œä¸è°ƒç”¨è€…æ–¹æ³•çš„å¼‚å¸¸å¤„ç†å™¨ç›¸è¿æ¥ã€‚ï¼ˆ<strong>å¤„ç†å¼‚å¸¸</strong>ï¼‰ã€‚</li></ol><p>å†ç»è¿‡ä¼˜åŒ–å¤„ç†åï¼Œæ‰€æœ‰å¸¸é‡è¢«æ¶ˆé™¤åå¯ä»¥å¾—åˆ°ä¸‹é¢çš„ä¼˜åŒ–ç»“æœï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210802005352.png"></p><p>å†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆå»é™¤æ­»ä»£ç ï¼‰ï¼Œå¯ä»¥å¾—åˆ°ä¸‹é¢æç®€IRå›¾ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210801171745.png"></p><p>å‰é¢æˆ‘ä»¬æåˆ°äº†æ–¹æ³•çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šï¼Œå½“ç„¶åœ¨æ–¹æ³•å†…è”çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šæœ‰è¿™æ ·çš„é—®é¢˜ï¼Œå½“ç„¶æ–¹æ³•å†…è”ä¹Ÿæœ‰å„ç§ä¸åŒçš„å»è™šåŒ–çš„ä¼˜åŒ–æ‰‹æ®µã€‚</p><h2 id="é€ƒé€¸åˆ†æ"><a href="#é€ƒé€¸åˆ†æ" class="headerlink" title="é€ƒé€¸åˆ†æ"></a>é€ƒé€¸åˆ†æ</h2><p>é€ƒé€¸åˆ†ææ˜¯ä¸€ç§ç¡®å®šæŒ‡é’ˆåŠ¨æ€èŒƒå›´çš„é™æ€åˆ†æï¼Œä»–å¯ä»¥åˆ†æåœ¨ç¨‹åºçš„å“ªäº›åœ°æ–¹å¯ä»¥è®¿é—®åˆ°æŒ‡é’ˆå¼•ç”¨ï¼Œåœ¨JVMçš„å³æ—¶ç¼–è¯‘çš„è¯­å¢ƒä¸‹ï¼Œé€ƒé€¸åˆ†æå°†åˆ¤æ–­æ–°å»ºçš„å¯¹è±¡æ˜¯å¦å­˜åœ¨é€ƒé€¸ï¼Œ<strong>å³æ—¶ç¼–è¯‘å™¨åˆ¤æ–­å¯¹è±¡æ˜¯å¦é€ƒé€¸çš„ä¾æ®ï¼Œä¸€æ˜¯å¯¹è±¡æ˜¯å¦å­˜å…¥å †ä¸­ï¼ˆé™æ€å­—æ®µæˆ–è€…å †ä¸­å¯¹è±¡çš„å®ä¾‹å­—æ®µï¼‰ï¼ŒäºŒæ˜¯å¯¹è±¡æ˜¯å¦è¢«ä¼ å…¥æœªçŸ¥çš„ä»£ç ä¸­ã€‚</strong>å‰è€…å¾ˆå¥½ç†è§£ï¼šä¸€æ—¦å¯¹è±¡è¢«å­˜å…¥å †ä¸­ï¼Œå…¶ä»–çº¿ç¨‹ä¾¿èƒ½è·å¾—åˆ°è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚å³æ—¶ç¼–è¯‘å™¨ä¹Ÿå› æ­¤æ— æ³•è¿½è¸ªæ‰€æœ‰ä½¿ç”¨è¯¥å¯¹è±¡çš„ä½ç½®ã€‚å¯¹äºåè€…ï¼ŒJVMçš„ç¼–è¯‘å™¨æ˜¯ä»¥æ–¹æ³•ä¸ºå•ä½çš„ï¼Œå¯¹äºæ–¹æ³•ä¸­æœªè¢«å†…è”çš„æ–¹æ³•è°ƒç”¨ï¼Œå³æ—¶ç¼–è¯‘å™¨ä¼šå°†å…¶å½“æˆæœªçŸ¥ä»£ç ï¼Œæ¯•ç«Ÿå®ƒæ— æ³•ç¡®è®¤è¯¥æ–¹æ³•è°ƒç”¨ä¼šä¸ä¼šå°†è°ƒç”¨è€…æˆ–æ‰€ä¼ å…¥çš„å‚æ•°å­˜å‚¨è‡³å †ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºæ–¹æ³•è°ƒç”¨çš„è°ƒç”¨è€…ä»¥åŠå‚æ•°æ˜¯é€ƒé€¸çš„ã€‚é€šå¸¸ï¼Œå³æ—¶ç¼–è¯‘å™¨é‡Œçš„é€ƒé€¸åˆ†ææ˜¯æ”¾åœ¨æ–¹æ³•å†…è”ä¹‹åçš„ï¼Œä»¥ä¾¿æ¶ˆé™¤è¿™äº›â€œæœªçŸ¥ä»£ç â€å…¥å£ã€‚é‚£ä¹ˆåŸºäºé€ƒé€¸åˆ†ææˆ‘ä»¬èƒ½åšå“ªäº›ä¼˜åŒ–å‘¢ï¼Ÿ</p><h3 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“åœ¨é”å¯¹è±¡è¦åœ¨å¤šä¸ªé”ä¹‹é—´å…±äº«ï¼Œè®©å¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªé”å¯¹è±¡è¿›è¡Œç«äº‰è¿™æ‰æœ‰æ„ä¹‰ã€‚é‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¯ä»¥è¯æ˜é”å¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ªé”å¯¹è±¡å¹¶å¯¹å…¶è¿›è¡ŒåŠ é”ï¼Œè¿™æ˜æ˜¾æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å› æ­¤æˆ‘ä»¬åªè¦åˆ¤æ–­æŸä¸ªé”å¯¹è±¡æ˜¯ä¸é€ƒé€¸çš„ï¼Œä¹Ÿå‹æ ¹å°±æ²¡æœ‰é”ç«äº‰ï¼Œé‚£ä¹ˆå…¶åŠ é”æ“ä½œä¹Ÿæ˜¯æ²¡æœ‰æ„ä¹‰çš„äº†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">new</span> Object()) &#123;&#125;<br></code></pre></td></tr></table></figure><h3 id="æ ˆä¸Šåˆ†é…æ ‡é‡æ›¿æ¢"><a href="#æ ˆä¸Šåˆ†é…æ ‡é‡æ›¿æ¢" class="headerlink" title="æ ˆä¸Šåˆ†é…æ ‡é‡æ›¿æ¢"></a>æ ˆä¸Šåˆ†é…æ ‡é‡æ›¿æ¢</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ Java è™šæ‹Ÿæœºä¸­å¯¹è±¡éƒ½æ˜¯åœ¨å †ä¸Šåˆ†é…çš„ï¼Œè€Œå †ä¸Šçš„å†…å®¹å¯¹ä»»ä½•çº¿ç¨‹éƒ½æ˜¯å¯è§çš„ã€‚ä¸æ­¤åŒæ—¶ï¼ŒJavaè™šæ‹Ÿæœºéœ€è¦å¯¹åˆ†é…çš„å†…å­˜ç©ºé—´è¿›è¡Œç®¡ç†ï¼Œå¹¶ä¸”åœ¨å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶å›æ”¶å…¶å†…å­˜ã€‚é‚£æˆ‘ä»¬ç»å¸¸æåˆ°çš„æ ˆä¸Šåˆ†é…åˆæ˜¯æ€ä¹ˆä¸€å›äº‹å‘¢ï¼Ÿ<strong>è¿™é‡Œå¦‚æœæˆ‘ä»¬å¯ä»¥ç”¨é€ƒé€¸åˆ†æè¯æ˜æŸäº›æ–°å»ºçš„å¯¹è±¡ä¸é€ƒé€¸ï¼Œé‚£ä¹ˆJVMå°±å®Œå…¨å¯ä»¥æŠŠè¿™ä¸ªå¯¹è±¡åˆ†é…åˆ°æ ˆä¸Š</strong>ã€‚è€Œä¸”åœ¨æ–¹æ³•ç»“æŸæ—¶ï¼Œé€šè¿‡å¼¹å‡ºå½“å‰æ–¹æ³•æ ˆæ¥è‡ªåŠ¨å›æ”¶æ‰€åˆ†é…çš„å†…å­˜ç©ºé—´ã€‚è¿™æ ·ä¸€æ¥æˆ‘ä»¬ä¾¿æ— é¡»å€ŸåŠ©åƒåœ¾æ”¶é›†å™¨æ¥å¤„ç†è¿™äº›å¯¹è±¡äº†ã€‚é‚£é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬çœŸçš„å¯ä»¥åœ¨æ ˆä¸Šåˆ†é…å¯¹è±¡ä¹ˆï¼Ÿå¯ä»¥ï¼Œä½†æ˜¯éœ€è¦å¤§é‡çš„ä¿®æ”¹å †ä¸Šåˆ†é…å¯¹è±¡çš„ä»£ç é€»è¾‘ï¼Œ<strong>å› æ­¤HotSpot è™šæ‹Ÿæœºå¹¶æ²¡æœ‰é‡‡ç”¨æ ˆä¸Šåˆ†é…ï¼Œè€Œæ˜¯ä½¿ç”¨æ ‡é‡æ›¿æ¢è¿™ä¸€æŠ€æœ¯æ¥å®ç°ã€‚æ‰€è°“çš„æ ‡é‡å°±æ˜¯ä»…èƒ½å­˜å‚¨ä¸€ä¸ªå€¼çš„å˜é‡</strong>ï¼Œæ¯”å¦‚Javaä»£ç ä¸­çš„å±€éƒ¨å˜é‡ï¼Œä¸ä¹‹ç›¸åï¼Œèšåˆé‡åˆ™å¯èƒ½åŒæ—¶å­˜å‚¨å¤šä¸ªå€¼ï¼Œå…¶ä¸­ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ä¾¿æ˜¯ Java å¯¹è±¡ã€‚å› æ­¤<strong>æˆ‘ä»¬æœ‰äº†æ ‡é‡æ›¿æ¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå¯¹ä¸€ä¸ªå¯¹è±¡çš„å­—æ®µè®¿é—®æ‹†åˆ†æˆå¤šä¸ªæ ‡é‡çš„è®¿é—®</strong>ï¼Œè¿™æ ·å°±é—´æ¥å®ç°äº†æ ˆä¸Šåˆ†é…ã€‚</p><blockquote><p>æˆ‘ä»¬è¿˜å¯ä»¥é’ˆå¯¹å±€éƒ¨ä»£ç è¿›è¡Œé€ƒé€¸åˆ†æï¼Œè¿›è¡Œä¸€äº›ä»£ç ä¼˜åŒ–çš„æ“ä½œã€‚</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†å…¥é—¨äº†å³æ—¶ç¼–è¯‘ï¼Œå³æ—¶ç¼–è¯‘æ˜¯é€šè¿‡å°†éƒ¨åˆ†çƒ­ç‚¹ä»£ç è¿›è¡Œä¼˜åŒ–ç¼–è¯‘æˆæœºå™¨ç çš„æŠ€æœ¯ï¼Œå¯ä»¥æå¤§çš„æå‡çƒ­ç‚¹ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚å³æ—¶ç¼–è¯‘å™¨æ˜¯é€šè¿‡æ”¶é›† profile çš„æ–¹å¼å¯¹ä»£ç è¿›è¡Œåˆ†æï¼Œç„¶åé€šè¿‡åˆ†å±‚ç¼–è¯‘å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ç¼–è¯‘ã€‚åœ¨profileçš„ä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦ä»‹ç»äº†ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯åŸºäºæµç¨‹åˆ†æ”¯çš„profileä¼˜åŒ–ï¼Œå¦å¤–ä¸€ç§æ˜¯åŸºäºç±»å‹çš„profileä¼˜åŒ–ï¼Œå½“ç„¶è¿™ç§ä¼˜åŒ–éƒ½æ˜¯æ¯”è¾ƒæ¿€è¿›çš„ï¼Œæ˜¯é€šè¿‡ç»Ÿè®¡çŒœæµ‹è¿›è¡Œçš„ä¼˜åŒ–ï¼Œä¸€æ—¦çŒœé”™äº†ã€‚JVMä¼šè¿›è¡Œå»ä¼˜åŒ–æ“ä½œå¹¶åˆ‡å›åˆ°è§£é‡Šæ‰§è¡Œã€‚å‰é¢ä»‹ç»çš„çŸ¥è¯†ç‚¹åªæ˜¯æˆ‘ä»¬æŠ½è±¡æ€»ç»“å‡ºæ¥çš„ï¼ŒJVMçœŸæ­£çš„ä¼˜åŒ–æ“ä½œæ˜¯é€šè¿‡ IR å®ç°çš„ï¼Œå³ä»£ç çš„ä¸­é—´è¡¨è¾¾å½¢å¼ã€‚æˆ‘ä»¬è¿™é‡Œä»‹ç»äº† Sea-of-Nodesï¼Œè¿™æ˜¯ä¸€ç§IRï¼Œæ˜¯C2ç¼–è¯‘ä½¿ç”¨çš„IRï¼ŒSea-of-Nodes ä¸­åŒ…å«äº†å¾ˆå¤šçš„å—å’Œå°†ä»–ä»¬è¿æ¥èµ·æ¥çš„æ•°æ®æµå’Œæ§åˆ¶æµï¼Œå¹¶ä¸”å»é™¤äº†å˜é‡çš„æ¦‚å¿µï¼Œæœ‰äº†Sea-of-Nodesæˆ‘ä»¬å°±ä¼šæœ‰æ›´å¤šçš„ä¼˜åŒ–æƒ³è±¡ç©ºé—´äº†ã€‚å› ä¸ºæˆ‘ä»¬çš„Sea-of-Nodesæ˜¯ç”±å¾ˆå¤šä»£ç å—æ„æˆçš„ï¼Œæˆ‘ä»¬å¯ä»¥æ¶ˆé™¤åŠŸèƒ½ç±»ä¼¼çš„ä»£ç ï¼Œè¿™å°±æ˜¯ Global Value Numbering ä¼˜åŒ–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡æŠŠæ–¹æ³•åµŒå¥—ç¼–è¯‘åœ¨ä¸€èµ·ä»è€Œå¯ä»¥è§¦å‘æ›´å¤šçš„ä¼˜åŒ–æ“ä½œã€‚æœ€åæˆ‘ä»¬ä»‹ç»äº†é€ƒé€¸åˆ†æï¼Œé€ƒé€¸åˆ†æç®€å•æ¥è¯´å°±æ˜¯åˆ†æä¸€ä¸ªå¯¹è±¡çš„è®¿é—®èŒƒå›´ã€‚é€šè¿‡é€ƒé€¸åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œé”æ¶ˆé™¤å’Œé€šè¿‡æ ‡é‡æ›¿æ¢å®ç°æ ˆä¸Šåˆ†é…ã€‚</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li><a href="https://time.geekbang.org/column/article/14061">https://time.geekbang.org/column/article/14061</a></li><li><a href="https://time.geekbang.org/column/article/14070">https://time.geekbang.org/column/article/14070</a></li><li><a href="https://zhengyudi.github.io/2018/03/20/graal-intro/">https://zhengyudi.github.io/2018/03/20/graal-intro/</a></li><li><a href="https://www.zhihu.com/question/45910849">https://www.zhihu.com/question/45910849</a></li><li><a href="https://zh.wikipedia.org/wiki/%E9%80%83%E9%80%B8%E5%88%86%E6%9E%90">https://zh.wikipedia.org/wiki/é€ƒé€¸åˆ†æ</a> </li><li><a href="https://tech.meituan.com/2020/10/22/java-jit-practice-in-meituan.html">https://tech.meituan.com/2020/10/22/java-jit-practice-in-meituan.html</a> </li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM GCç¯‡ â€” æ—¥å¿—è§£è¯»ä¸GCè°ƒä¼˜</title>
    <link href="/2021/07/25/gclog-and-optimize/"/>
    <url>/2021/07/25/gclog-and-optimize/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢ä¸€å°èŠ‚æˆ‘ä»¬ç®€å•æ·±å…¥çš„æ¢³ç†äº†åƒåœ¾æ”¶é›†å™¨ï¼Œæ¢³ç†ç†è§£äº†å„ä¸ªåƒåœ¾æ”¶é›†å™¨çš„åŸç†å’Œå›æ”¶æµç¨‹ã€‚å…¶ä¸­ä¸»è¦çš„åƒåœ¾æ”¶é›†å™¨å¯ä»¥åˆ†ä¸ºâ€œç»å…¸åƒåœ¾æ”¶é›†å™¨â€å’Œâ€œä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨â€ï¼Œå…¶ä¸­ç»å…¸åƒåœ¾æ”¶é›†å™¨æ˜¯ä»¥Parallelã€CMSã€G1ä¸ºé¦–åœ¨ç”Ÿäº§ç¯å¢ƒç»è¿‡åƒä¸‡æ¬¡å†ç»ƒçš„åƒåœ¾æ”¶é›†å™¨ã€‚ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ä»¬åˆ™æ˜¯æœ€æ–°è¿˜å¤„äºå®éªŒçŠ¶æ€çš„ shenandoah å’Œ ZGCï¼Œè¿™ä¸€ä»£çš„è®¾è®¡ç›®æ ‡æ˜¯åœ¨è¶…å¤§å †ä¸‹ä¾æ—§èƒ½èƒ½å®ç°é«˜ååä½å»¶è¿Ÿçš„åƒåœ¾æ”¶é›†ã€‚ä½†æ˜¯å°±ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„ä¾æ—§æ˜¯ç»å…¸åƒåœ¾æ”¶é›†å™¨ï¼Œå› æ­¤åœ¨GCç¯å¢ƒï¼Œæˆ‘ä»¬ä¾æ—§è¦å¯¹GCè¿›è¡Œè°ƒä¼˜ä»¥å……åˆ†åˆ©ç”¨ç‰©ç†æœºçš„æ€§èƒ½ã€‚GCè°ƒä¼˜è¿™ä¸ªè¯æˆ‘ä»¬å¬è¿‡å¾ˆå¤šæ¬¡ï¼Œä½†æ˜¯çœŸæ­£æ“ä½œèµ·æ¥å¯èƒ½ä¼šåƒä¸çŸ¥æ‰€æªæ— ä»ä¸‹æ‰‹ã€‚ä½†æ˜¯æœ‹å‹ä¸è¦å®³æ€•ï¼Œæœ‰äº†å‰é¢çš„åŸºç¡€é“ºå«å†åŠ ä¸Šä¸€äº›ç›‘æ§æŒ‡æ ‡ï¼Œç»è¿‡è¿™ä¸€å°èŠ‚ï¼Œä½ ä¸€å®šä¼šå¯¹GCè°ƒä¼˜æœ‰ä¸ªå…¨é¢çš„è®¤è¯†ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¼šå…ˆä»GCè°ƒä¼˜åˆ†æå¼€å§‹ï¼Œä»‹ç»è°ƒä¼˜çš„åŸºæœ¬æµç¨‹ã€GCçš„ä¸€äº›é™åˆ¶ï¼Œéšåæˆ‘ä»¬è¿›è¡Œä¸€æ®µè°ƒä¼˜çš„ç¤ºä¾‹ï¼Œåœ¨ç¤ºä¾‹ä¸­æˆ‘ä»¬å¦‚ä½•è¿›è¡Œæ—¥å¿—åˆ†æä¸GCè°ƒä¼˜ã€‚æœ€åæˆ‘ä»¬ä¼šæ¢³ç†ä¸€ä¸ªç®€å•çš„äº§ç”Ÿåƒåœ¾çš„ç¨‹åºï¼Œå¹¶åˆ†æåœ¨ä¸åŒçš„åƒåœ¾æ”¶é›†å™¨ä¸‹çš„GCæ—¥å¿—åˆ†æè°ƒä¼˜ã€‚</p><h2 id="æ—¥å¿—è§£è¯»"><a href="#æ—¥å¿—è§£è¯»" class="headerlink" title="æ—¥å¿—è§£è¯»"></a>æ—¥å¿—è§£è¯»</h2><p>ä¸Šä¸€èŠ‚æˆ‘ä»¬ä»‹ç»äº†å„ç§åƒåœ¾æ”¶é›†å™¨ã€‚å¦‚æœå®šä½GCé—®é¢˜å’ŒGCè°ƒä¼˜æˆ‘ä»¬ç¦»ä¸å¼€å¯¹GCæ—¥å¿—çš„åˆ†æã€‚åœ¨è¿™ä¸ªéƒ¨åˆ†æˆ‘ä»¬å°†åˆ†æè¿™äº›GCçš„æ—¥å¿—ï¼Œæ¥åˆ†GCæ—¥å¿—ä¸­éšè—çš„GCåƒåœ¾æ”¶é›†ä¿¡æ¯ã€‚</p><h3 id="Serial-GC-æ—¥å¿—è§£è¯»"><a href="#Serial-GC-æ—¥å¿—è§£è¯»" class="headerlink" title="Serial GC æ—¥å¿—è§£è¯»"></a>Serial GC æ—¥å¿—è§£è¯»</h3><p>æˆ‘ä»¬ä¸ºäº†èƒ½å¤Ÿæ‰“å¼€GCæ—¥å¿—è®°å½•å¹¶æŒ‡å®šåƒåœ¾æ”¶é›†å™¨ä¸ºSerialï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„JVMå¯åŠ¨å‚æ•°ï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseSerialGC -Xms512m -Xmx512m -Xloggc:gc.log </span><br><span class="hljs-deletion">-XX:+PrintGCDetails -XX:+PrintGCDateStamps</span><br></code></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸Šé¢çš„JVMå¯åŠ¨å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æ—¥å¿—è¾“å‡ºï¼ˆp.s. å·²ç»æ‰‹å·¥æŠ˜å éƒ¨åˆ†æ—¥å¿—ï¼‰</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Java</span> <span class="hljs-variable">HotSpot</span><span class="hljs-punctuation">(</span><span class="hljs-variable">TM</span><span class="hljs-punctuation">)</span> <span class="hljs-number">64</span><span class="hljs-operator">-</span><span class="hljs-variable">Bit</span> <span class="hljs-variable">Server</span> <span class="hljs-variable">VM</span> <span class="hljs-punctuation">(</span><span class="hljs-number">25.231</span><span class="hljs-operator">-</span><span class="hljs-variable">b11</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">for</span> <span class="hljs-variable">bsd</span><span class="hljs-operator">-</span><span class="hljs-variable">amd64</span> <span class="hljs-variable">JRE</span> <span class="hljs-punctuation">(</span><span class="hljs-number">1.8</span><span class="hljs-number">.0</span><span class="hljs-type">_</span><span class="hljs-number">231</span><span class="hljs-operator">-</span><span class="hljs-variable">b11</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-variable">built</span> <span class="hljs-variable">on</span> <span class="hljs-variable">Oct</span>  <span class="hljs-number">5</span> <span class="hljs-number">2019</span> <span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">15</span><span class="hljs-operator">:</span><span class="hljs-number">25</span> <span class="hljs-variable">by</span> <span class="hljs-string">&quot;java_re&quot;</span> <span class="hljs-variable">with</span> <span class="hljs-variable">gcc</span> <span class="hljs-number">4.2</span><span class="hljs-number">.1</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Based</span> <span class="hljs-variable">on</span> <span class="hljs-variable">Apple</span> <span class="hljs-variable">Inc</span><span class="hljs-operator">.</span> <span class="hljs-variable">build</span> <span class="hljs-number">5658</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">LLVM</span> <span class="hljs-variable">build</span> <span class="hljs-number">2336.11</span><span class="hljs-number">.00</span><span class="hljs-punctuation">)</span><br><span class="hljs-variable">Memory</span><span class="hljs-operator">:</span> <span class="hljs-number">4</span><span class="hljs-variable">k</span> <span class="hljs-variable">page</span><span class="hljs-operator">,</span> <span class="hljs-variable">physical</span> <span class="hljs-number">16777216</span><span class="hljs-variable">k</span><span class="hljs-punctuation">(</span><span class="hljs-number">794016</span><span class="hljs-variable">k</span> <span class="hljs-variable">free</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-operator">/</span><span class="hljs-variable">proc</span><span class="hljs-operator">/</span><span class="hljs-variable">meminfo</span><span class="hljs-operator">:</span><br><br><span class="hljs-variable">CommandLine</span> <span class="hljs-variable">flags</span><span class="hljs-operator">:</span> <br>        <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:</span><span class="hljs-variable">InitialHeapSize</span><span class="hljs-operator">=</span><span class="hljs-number">536870912</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:</span><span class="hljs-variable">MaxHeapSize</span><span class="hljs-operator">=</span><span class="hljs-number">536870912</span> <br>    <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGC</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCDateStamps</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCDetails</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCTimeStamps</span> <br>    <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseCompressedClassPointers</span> <br>    <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseCompressedOops</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseSerialGC</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.329</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.177</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.329</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.177</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17472</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0219962</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">45575</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0221202</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.369</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.217</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.369</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.217</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17471</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0271936</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">185351</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">89018</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0272786</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.412</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.260</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.412</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.260</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">157247</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17471</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0224308</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">228794</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">134099</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0225212</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-operator">......</span><br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.931</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.779</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.931</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.779</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">157243</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">157243</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000170</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.931</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.779</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">332621</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">341869</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0488050</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">489864</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">341869</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0489122</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.997</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.845</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.997</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.845</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000171</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.997</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.845</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">341869</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">340659</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0437236</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">481645</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">340659</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0438227</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.058</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.906</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.058</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.906</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000175</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.058</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.906</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">340659</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">342260</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0457178</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">480435</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">342260</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0458305</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.122</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.970</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.122</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.970</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000197</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.122</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.970</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">342260</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">332184</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0497748</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">482036</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">332184</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0498987</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.190</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.038</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.190</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.038</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000187</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.190</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.038</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">332184</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349062</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0294194</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">471960</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">353796</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0295288</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.241</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.089</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">14.241</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.089</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">349062</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349274</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0397096</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">506055</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">351244</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0398051</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">def</span> <span class="hljs-variable">new</span> <span class="hljs-variable">generation</span>   <span class="hljs-variable">total</span> <span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">8337</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007aaaa0000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007aaaa0000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">5</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007a08244f0</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007a8880000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">17472</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a8880000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007a8880000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007a9990000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">17472</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>   <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a9990000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007a9990000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007aaaa0000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">tenured</span> <span class="hljs-variable">generation</span>   <span class="hljs-variable">total</span> <span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">349274</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007aaaa0000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br>   <span class="hljs-variable">the</span> <span class="hljs-variable">space</span> <span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span>  <span class="hljs-number">99</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007aaaa0000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007bffb6998</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007bffb6a00</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">2571</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4486</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">276</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">386</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­æˆ‘ä»¬ä¸éš¾çœ‹å‡ºï¼Œè¾“å‡ºçš„æ—¥å¿—ä¿¡æ¯ä¸€çœ¼çœ‹ä¸Šå»ç®€å•å¯ä»¥åˆ†ä¸ºä¸‰å¤§å—ï¼Œç¬¬ä¸€ä¸ªéƒ¨åˆ†æ˜¯<strong>JVMç‰ˆæœ¬ä¿¡æ¯å’Œä¸€äº›æ‰§è¡Œæœºå™¨çš„å†…å­˜æƒ…å†µ</strong>ï¼Œç¬¬äºŒä¸ªéƒ¨åˆ†<strong>æ—¥å¿—å—æ˜¯JVMçš„æ‰§è¡Œå‚æ•°å’Œæ—¥å¿—ä¿¡æ¯</strong>ã€‚æœ€åä¸€ä¸ªå—æ˜¯<strong>ç¨‹åºç»“æŸæ—¶å †ç©ºé—´å’Œå…ƒæ•°æ®åŒºçš„å†…å­˜ä½¿ç”¨æƒ…å†µ</strong>ã€‚æ¥æˆ‘ä»¬å…ˆçœ‹å¹´è½»ä»£çš„GCæ—¥å¿—ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬GCæ—¥å¿—ä¸­çš„ç¬¬äºŒæ¬¡GCäº‹ä»¶ã€‚</p><h4 id="MinorGC-æ—¥å¿—åˆ†æ"><a href="#MinorGC-æ—¥å¿—åˆ†æ" class="headerlink" title="MinorGC æ—¥å¿—åˆ†æ"></a>MinorGC æ—¥å¿—åˆ†æ</h4><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">11</span>T<span class="hljs-number">18</span>:<span class="hljs-number">30</span>:<span class="hljs-number">13</span>.<span class="hljs-number">369</span>-<span class="hljs-number">0800</span>: <br>        <span class="hljs-attribute">0</span>.<span class="hljs-number">217</span>:<span class="hljs-meta"> [GC (Allocation Failure) 2021-07-11T18:30:13.369-0800: </span><br><span class="hljs-meta">        0.217: [DefNew: 157248K-&gt;17471K(157248K), 0.0271936 secs] 185351K-&gt;89018K(506816K), 0.0272786 secs] </span><br><span class="hljs-meta">                 [Times: user=0.01 sys=0.01, real=0.03 secs] </span><br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯ä¸­å¯ä»¥è§£è¯»å‡ºå¦‚ä¸‹çš„ä¿¡æ¯ï¼š</p><ol><li><code>2021-07-11T18:30:13.369-0800</code> GCäº‹ä»¶å¼€å§‹çš„æ—¶é—´ç‚¹ï¼Œå…¶ä¸­<code>-0800</code>è¡¨ç¤ºå½“å‰æ—¶åŒºä¸ºä¸œå…«åŒºï¼Œè¿™åªæ˜¯ä¸€ä¸ªæ ‡è¯†ï¼Œæ–¹ä¾¿æˆ‘ä»¬ç›´è§‚åˆ¤æ–­GCå‘ç”Ÿçš„æ—¶é—´ç‚¹ã€‚åé¢çš„<code>0.217</code> æ˜¯GCäº‹ä»¶ç›¸è¾ƒäºJVMå¯åŠ¨äº‹ä»¶çš„é—´éš”ï¼Œå•ä½æ˜¯ç§’ã€‚</li><li><code>GC</code>ç”¨æ¥åŒºåˆ† MinorGC è¿˜æ˜¯ FullGC çš„æ ‡å¿—ã€‚<code>GC</code>è¡¨æ˜è¿™æ˜¯ä¸€æ¬¡å°å‹GCï¼ˆMinor GCï¼‰ï¼Œå³å¹´è½»ä»£GCã€‚<code>Allocation Failure</code> è¡¨ç¤ºè§¦å‘GCçš„åŸå› ã€‚æœ¬æ¬¡GCäº‹ä»¶ï¼Œæ˜¯ç”±äºå¯¹è±¡åˆ†é…å¤±è´¥ï¼Œå³å¹´è½»ä»£ä¸­æ²¡æœ‰ç©ºé—´ç”¨æ¥å­˜æ”¾æ–°ç”Ÿæˆçš„å¯¹è±¡å¼•èµ·çš„ã€‚</li><li><code>DefNew</code> è¡¨ç¤ºåƒåœ¾æ”¶é›†å™¨çš„åç§°ã€‚è¿™ä¸ªåå­—è¡¨ç¤ºï¼šå¹´è½»ä»£ä½¿ç”¨å•çº¿ç¨‹ã€æ ‡è®°-å¤åˆ¶ã€STWåƒåœ¾æ”¶é›†å™¨ã€‚<code>157248K-&gt;17471K</code>è¡¨ç¤ºåœ¨åƒåœ¾æ”¶é›†ä¹‹å‰å’Œåªä¹‹åçš„å¹´è½»ä»£ä½¿ç”¨é‡ã€‚<code>(157248K)</code>è¡¨ç¤ºå¹´è½»ä»£çš„æ€»ç©ºé—´å¤§å°ã€‚è¿›ä¸€æ­¥åˆ†æå¯çŸ¥ï¼šGCä¹‹åå¹´è½»ä»£ä½¿ç”¨ç‡ä¸º11%ã€‚</li><li><code>185351K-&gt;89018K(506816K)</code>è¡¨ç¤ºåœ¨åƒåœ¾æ”¶é›†ä¹‹å‰å’Œä¹‹åæ•´ä¸ªå †å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚<code>(506816K)</code>åˆ™è¡¨ç¤ºå †å†…å­˜å¯ä»¥ç”¨ç©ºé—´æ€»å¤§å°ã€‚è¿›ä¸€æ­¥åˆ†æå¯çŸ¥ï¼šGCä¹‹åå †å†…å­˜ä½¿ç”¨é‡ä¸º17.5%</li><li><code>0.0272786 secs</code> GCäº‹ä»¶æŒç»­çš„æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚</li><li><code>[Times: user=0.01 sys=0.01, real=0.03 secs]</code> æ­¤æ¬¡GCæ—¶é—´çš„æŒç»­æ—¶é—´ï¼Œé€šè¿‡ä¸‰ä¸ªéƒ¨åˆ†è¡¡é‡ï¼š<code>user</code>éƒ¨åˆ†è¡¨ç¤ºæ‰€æœ‰GCçº¿ç¨‹æ¶ˆè€—çš„CPUæ—¶é—´ï¼›<code>sys</code>éƒ¨åˆ†è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨å’Œç³»ç»Ÿç­‰å¾…äº‹ä»¶æ¶ˆè€—çš„æ—¶é—´ã€‚<code>real</code>åˆ™è¡¨ç¤ºåº”ç”¨ç¨‹åºæš‚åœçš„æ—¶é—´ã€‚å› ä¸ºä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼ˆSerial Garbage Collectorï¼‰åªä½¿ç”¨å•ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œ <code>real ~= user + system</code>, 0.03ç§’ä¹Ÿå°±æ˜¯30æ¯«ç§’ã€‚</li></ol><p>å°±ç»éªŒè€Œè°ˆï¼Œè¿™ä¸ªæš‚åœæ—¶é—´å¯¹å¤§éƒ¨åˆ†ç³»ç»Ÿæ¥è¯´å¯ä»¥æ¥å—ï¼Œä½†æ˜¯å¯¹äºæŸäº›å»¶è¿Ÿæ•æ„Ÿçš„ç³»ç»Ÿæ¥è¯´å°±æ˜¯å¤§é—®é¢˜äº†ï¼Œå°±æ¯”å¦‚ä½ æ‰“ç½‘ç»œæ¸¸æˆï¼Œè¿™30msçš„æš‚åœé€ æˆçš„å»¶è¿Ÿå°±ä¼šè®©ä½ å¾ˆéš¾æ¥å—ã€‚</p><p>é€šè¿‡è¿™æ ·çš„è§£è¯»æˆ‘ä»¬å¯ä»¥åˆ†æJVMåœ¨GCæ—¶é—´ä¸­çš„å†…å­˜ä½¿ç”¨ä»¥åŠå˜åŒ–æƒ…å†µã€‚åœ¨æ­¤æ¬¡åƒåœ¾æ”¶é›†ä¹‹å‰ï¼Œå¯¹å†…å­˜æ€»çš„ä½¿ç”¨é‡ä¸º<code>185351K</code>ï¼Œè€Œå¹´è½»ä»£çš„ç©ºé—´ä½¿ç”¨é‡ä¸º<code>157248K</code>ï¼Œä¸éš¾ç®—å‡ºè€å¹´ä»£å·²ç»å ç”¨äº†<code>28103K</code>ã€‚å½“ç„¶è¿™äº›æ•°å­—ä¸­è¿˜è•´å«æ›´é‡è¦çš„ä¿¡æ¯ï¼šGCå‰åå¯¹æ¯”å¹´è½»ä»£ä½¿ç”¨é‡ä»<code>157248K-&gt;17471K</code>å‡å°‘äº†<code>139777K</code>ï¼Œè€Œæ€»å †ç©ºé—´å¤§å°<code>185351K-&gt;89018K</code>åªä¸‹é™äº†<code>96333K</code>çš„å†…å­˜ç©ºé—´ã€‚å…¶ä¸­æœ‰<code>43444K(139777K-96333K)</code> å¯¹è±¡ä»å¹´è½»ä»£æå‡åˆ°è€å¹´ä»£ã€‚</p><blockquote><p>é€šè¿‡è¿™ä¹ˆåˆ†æä¸‹æ¥ï¼Œä¸éš¾çœ‹å‡ºï¼Œæˆ‘ä»¬å…³æ³¨çš„ä¸»è¦ä¸¤ä¸ªæ•°æ®ï¼š<strong>GCæš‚åœæ—¶é—´</strong>ï¼Œ<strong>ä»¥åŠGCä¹‹åçš„å†…å­˜ä½¿ç”¨é‡/ä½¿ç”¨ç‡</strong>ã€‚</p></blockquote><h4 id="FullGC-æ—¥å¿—åˆ†æ"><a href="#FullGC-æ—¥å¿—åˆ†æ" class="headerlink" title="FullGC æ—¥å¿—åˆ†æ"></a>FullGC æ—¥å¿—åˆ†æ</h4><p>å‰é¢åˆ†æå®ŒæˆMinorGCçš„æ—¥å¿—ï¼Œæˆ‘ä»¬å¯¹GCæ—¥å¿—çš„æ ¼å¼ä¹Ÿå¤§è‡´æœ‰ä¸€ä¸ªæ¦‚å¿µäº†ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·çœ‹çœ‹åˆ†æFullGCçš„æ—¥å¿—ã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.840</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.688</span><span class="hljs-operator">:</span> <br>        <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.840</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.688</span><span class="hljs-operator">:</span> <br>        <span class="hljs-punctuation">[</span><span class="hljs-variable">DefNew</span><span class="hljs-operator">:</span> <span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">139776</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">157248</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000196</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">11</span><span class="hljs-variable">T18</span><span class="hljs-operator">:</span><span class="hljs-number">30</span><span class="hljs-operator">:</span><span class="hljs-number">13.840</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.688</span><span class="hljs-operator">:</span> <br>        <span class="hljs-punctuation">[</span><span class="hljs-variable">Tenured</span><span class="hljs-operator">:</span> <span class="hljs-number">309538</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">298877</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349568</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0407769</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-number">449314</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">298877</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">506816</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <br>    <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0409461</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯å¯ä»¥è§£è¯»å‡ºè¿™äº›ä¿¡æ¯ï¼š</p><ol><li><code>2021-07-11T18:30:13.840-0800</code> GCäº‹ä»¶çš„å¼€å§‹æ—¶é—´ã€‚</li><li><code>[DefNew: 139776K-&gt;139776K(157248K), 0.0000196 secs]</code> å‰é¢å·²ç»è§£è¯»è¿‡è¿™æ®µæ—¥å¿—äº†ï¼Œå› ä¸ºå†…å­˜åˆ†é…å¤±è´¥ï¼Œå‘ç”Ÿäº†ä¸€æ¬¡å¹´è½»ä»£GCã€‚æ­¤æ¬¡GCåŒæ ·ä½¿ç”¨äº† DefNew æ”¶é›†å™¨ã€‚æ³¨æ„ï¼šæ­¤æ¬¡åƒåœ¾æ”¶é›†å™¨æ¶ˆè€—äº†<code>0.0000196 secs</code>ï¼Œå¹¶ä¸”å¹´è½»ä»£ç©ºé—´å¹¶æ²¡æœ‰å‡å°‘ï¼ŒåŸºæœ¬ä¸Šå¯ä»¥ç¡®è®¤è¿™æ¬¡GCäº‹ä»¶æ²¡æ€ä¹ˆå¤„ç†å¹´è½»ä»£ã€‚</li><li><code>Tenured</code> ç”¨äºæ¸…ç†è€å¹´ä»£ç©ºé—´çš„åƒåœ¾æ”¶é›†å™¨åç§°ã€‚<code>Tenured</code>è¡¨æ˜ä½¿ç”¨çš„æ˜¯å•çº¿ç¨‹çš„STWåƒåœ¾æ”¶é›†å™¨ï¼Œä½¿ç”¨çš„ç®—æ³•<code>æ ‡è®°-æ¸…ç†-æ•´ç†ï¼ˆmark-sweep-compactï¼‰</code>ã€‚<code>309538K-&gt;298877K</code>è¡¨ç¤ºGCå‰åçš„å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠè€å¹´ä»£çš„å¤§å°ã€‚<code>0.0407769 secs</code> æ˜¯æ¸…ç†è€å¹´ä»£æ‰€èŠ±çš„æ—¶é—´ã€‚</li><li><code>449314K-&gt;298877K(506816K)</code> åœ¨GCå‰åæ•´ä¸ªå †å†…å­˜éƒ¨åˆ†çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠå¯ç”¨å †ç©ºé—´å¤§å°ã€‚</li><li><code>[Metaspace: 2565K-&gt;2565K(1056768K)], 0.0409461 secs]</code> Metaspace ç©ºé—´çš„å˜åŒ–æƒ…å†µã€‚å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ¬¡GCè¿‡ç¨‹ä¸­ Metaspace ä¹Ÿæ²¡æœ‰å˜åŒ–ã€‚</li><li><code>[Times: user=0.04 sys=0.00, real=0.04 secs]</code> GCäº‹ä»¶çš„æŒç»­äº‹ä»¶ï¼Œåˆ†åˆ«ä¸º<code>user</code>ï¼Œ<code>sys</code>ï¼Œ<code>real</code>ä¸‰ä¸ªéƒ¨åˆ†ã€‚å› ä¸ºä¸²è¡Œåƒåœ¾æ”¶é›†å™¨åªä½¿ç”¨å•ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥<code>user + sys = real</code>ã€‚è¿™40ms çš„æš‚åœæŒºå°¸ï¼Œæ¯”å‰é¢å¹´è½»ä»£çš„æš‚åœå¢å¤§äº†ä¸å°‘ï¼Œè¿™ä¸ªæ—¶é—´å’Œä»€ä¹ˆæœ‰å…³ç³»å‘¢ï¼ŸGCæ—¶é—´ï¼Œä¸GCåå­˜æ´»çš„å¯¹è±¡æ€»æ•°é‡å…³ç³»æœ€å¤§ã€‚</li></ol><p>è¿›ä¸€æ­¥åˆ†æè¿™äº›æ•°æ®ï¼ŒGCä¹‹åè€å¹´ä»£çš„ä½¿ç”¨ç‡ä¸ºï¼š298877K/349568Kï½=85.5%ï¼Œè¿™ä¸ªæ¯”ä¾‹å·²ç»å¾ˆå¤§äº†ï¼Œè¿™æ¬¡è€å¹´ä»£GCä»…ä»…åªå›æ”¶äº†10661Kï¼Œè€å¹´ä»£è§¦å‘FullGCä½†æ˜¯è€å¹´ä»£ä»…å‘ç”Ÿå°‘é‡å¯¹è±¡çš„å›æ”¶ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆå¤§ã€‚åŒæ—¶æˆ‘ä»¬å‘ç°å’Œå¹´è½»ä»£GCç›¸æ¯”ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„æ˜¯è¿™æ¬¡GCäº‹ä»¶è¿˜æ¸…ç†äº†è€å¹´ä»£å’ŒMetaspaceã€‚</p><blockquote><p>FullGC, æˆ‘ä»¬ä¸»è¦å…³æ³¨GCä¹‹åå†…å­˜ä½¿ç”¨é‡æ˜¯å¦ä¸‹é™ï¼Œå…¶æ¬¡å…³æ³¨æš‚åœæ—¶é—´ã€‚ç®€å•ä¼°ç®—ï¼ŒGCåè€å¹´ä»£ä½¿ç”¨é‡çº¦ä¸º350MBï¼ŒGCè€—æ—¶40mså·¦å³ï¼Œå¦‚æœæˆ‘ä»¬æŠŠå†…å­˜æ‰©å¤§10å€ï¼ŒGCåçš„è€å¹´ä»£ä¹Ÿæ‰©å¤§10å€ï¼Œé‚£ä¹ˆè€—æ—¶å°†ä¼šè¾¾åˆ°400msç”šè‡³æ›´é«˜ï¼Œå°±ä¼šæ˜æ˜¾å½±å“åˆ°ç³»ç»Ÿçš„ååäº†ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´ä¸²è¡Œæ€§èƒ½å¼±çš„åŸå› ã€‚æœåŠ¡ç«¯ä¸€èˆ¬ä¸ä¼šä½¿ç”¨Serial GCã€‚</p></blockquote><h3 id="Parallel-GC-æ—¥å¿—è§£è¯»"><a href="#Parallel-GC-æ—¥å¿—è§£è¯»" class="headerlink" title="Parallel GC æ—¥å¿—è§£è¯»"></a>Parallel GC æ—¥å¿—è§£è¯»</h3><p>å¹¶è¡Œçš„åƒåœ¾æ”¶é›†å™¨å¯¹å¹´è½»ä»£ä½¿ç”¨<code>æ ‡è®°-å¤åˆ¶(mark-copy)</code>ç®—æ³•ï¼Œå¯¹è€å¹´ä»£ä½¿ç”¨<code>æ ‡è®°-æ¸…é™¤-æ•´ç†(mark-sweep-compact)</code>ç®—æ³•ã€‚å¹´è½»ä»£å’Œè€å¹´ä»£çš„åƒåœ¾å›æ”¶æ—¶éƒ½ä¼šè§¦å‘STWäº‹ä»¶ï¼Œæš‚åœæ‰€æœ‰çš„åº”ç”¨çº¿ç¨‹ï¼Œå†æ‰§è¡Œåƒåœ¾æ”¶é›†ï¼Œåœ¨æ‰§è¡Œ<code>æ ‡è®°</code>å’Œ<code>å¤åˆ¶/æ•´ç†</code>é˜¶æ®µæ—¶éƒ½ä½¿ç”¨å¤šä¸ªçº¿ç¨‹ã€‚å› æ­¤å¾—åâ€Parallelâ€ã€‚é€šè¿‡å¤šä¸ªGCçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„æ–¹å¼ï¼Œèƒ½ä½¿JVMåœ¨å¤šCPUå¹³å°ä¸Šçš„GCæ—¶é—´å¤§å¹…å‡å°‘ã€‚é€šè¿‡å‘½ä»¤è¡Œå‚æ•°<code>-XX:ParallelGCThread=N</code>å¯ä»¥æŒ‡å®šGCçº¿ç¨‹çš„æ•°é‡ï¼Œå…¶<strong>é»˜è®¤æ˜¯CPUå†…æ ¸æ•°é‡ã€‚</strong>ä¸‹é¢ä¸‰ç»„å‘½ä»¤æ˜¯ç­‰ä»·çš„éƒ½å¯ä»¥ç”¨æ¥æŒ‡å®š ParallelGC</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseParallelGC</span><br><span class="hljs-deletion">-XX:+UseParallelOldGC</span><br><span class="hljs-deletion">-XX:+UseParallelGC -XX:+UseParallelOldGC</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å¯åŠ¨JVMï¼ŒæŒ‡å®šParallelGCå¹¶æŒ‡å®šè¾“å‡ºgcæ—¥å¿—ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseParallelGC -Xmx512m -Xms512m -Xloggc:gc.log </span><br><span class="hljs-deletion">-XX:+PrintGCDetails -XX:+PrintGCDateStamps</span><br></code></pre></td></tr></table></figure><p>è¡Œåƒåœ¾æ”¶é›†å™¨ä¼šé€‚ç”¨äºå¤šæ ¸æœåŠ¡å™¨ï¼Œå…¶ä¸»è¦ç›®æ ‡æ˜¯å¢åŠ ç³»ç»Ÿååé‡ï¼ˆä¹Ÿå°±æ˜¯é™ä½GCæ€»ä½“æ¶ˆè€—çš„æ—¶é—´ï¼‰ã€‚ä¸ºäº†è¾¾æˆè¿™ä¸ªç›®æ ‡ï¼Œä¼šå°½é‡ä½¿ç”¨å°½å¯èƒ½å¤šçš„CPUèµ„æºï¼š</p><ul><li><strong>åœ¨GCäº‹ä»¶æ‰§è¡ŒæœŸé—´ï¼Œæ‰€æœ‰CPUå†…æ ¸éƒ½åœ¨å¹¶è¡Œåœ°æ¸…ç†åƒåœ¾ï¼Œæ‰€ä»¥æš‚åœæ—¶é—´ç›¸å¯¹æ¥è¯´æ›´çŸ­ã€‚</strong></li><li><strong>åœ¨ä¸¤æ¬¡GCäº‹ä»¶ä¸­é—´çš„é—´éš™æœŸï¼Œä¸ä¼šå¯åŠ¨GCçº¿ç¨‹ï¼Œæ‰€ä»¥è¿™æ®µäº‹ä»¶å†…ä¸ä¼šæ¶ˆè€—ä»»ä½•ç³»ç»Ÿèµ„æºã€‚</strong></li></ul><p>å¦ä¸€æ–¹é¢ï¼Œå› ä¸ºå¹¶è¡ŒGCçš„æ‰€æœ‰é˜¶æ®µéƒ½æ˜¯ä¸èƒ½ä¸­æ–­ï¼Œæ‰€ä»¥å¹¶è¡ŒGCå¾ˆå¯èƒ½ä¼šå‡ºç°é•¿æ—¶é—´çš„å¡é¡¿ã€‚å› ä¸ºGCæœŸé—´åº”ç”¨çº¿ç¨‹æ˜¯è¢«æš‚åœçš„ã€‚å¦‚æœå•æ¬¡æš‚åœæ—¶é—´æ¯”è¾ƒé•¿å¯¹å»¶è¿Ÿè¦æ±‚å¾ˆé«˜ï¼Œåº”è¯¥é€‰æ‹©å…¶ä»–çš„åƒåœ¾æ”¶é›†å™¨ã€‚ä¸‹é¢æ˜¯ä¸€æ®µå¹¶è¡ŒGCçš„æ—¥å¿—ã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-variable">Java</span> <span class="hljs-variable">HotSpot</span><span class="hljs-punctuation">(</span><span class="hljs-variable">TM</span><span class="hljs-punctuation">)</span> <span class="hljs-number">64</span><span class="hljs-operator">-</span><span class="hljs-variable">Bit</span> <span class="hljs-variable">Server</span> <span class="hljs-variable">VM</span> <span class="hljs-punctuation">(</span><span class="hljs-number">25.231</span><span class="hljs-operator">-</span><span class="hljs-variable">b11</span><span class="hljs-punctuation">)</span> <span class="hljs-variable">for</span> <span class="hljs-variable">bsd</span><span class="hljs-operator">-</span><span class="hljs-variable">amd64</span> <span class="hljs-variable">JRE</span> <span class="hljs-punctuation">(</span><span class="hljs-number">1.8</span><span class="hljs-number">.0</span><span class="hljs-type">_</span><span class="hljs-number">231</span><span class="hljs-operator">-</span><span class="hljs-variable">b11</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-variable">built</span> <span class="hljs-variable">on</span> <span class="hljs-variable">Oct</span>  <span class="hljs-number">5</span> <span class="hljs-number">2019</span> <span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">15</span><span class="hljs-operator">:</span><span class="hljs-number">25</span> <span class="hljs-variable">by</span> <span class="hljs-string">&quot;java_re&quot;</span> <span class="hljs-variable">with</span> <span class="hljs-variable">gcc</span> <span class="hljs-number">4.2</span><span class="hljs-number">.1</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Based</span> <span class="hljs-variable">on</span> <span class="hljs-variable">Apple</span> <span class="hljs-variable">Inc</span><span class="hljs-operator">.</span> <span class="hljs-variable">build</span> <span class="hljs-number">5658</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">LLVM</span> <span class="hljs-variable">build</span> <span class="hljs-number">2336.11</span><span class="hljs-number">.00</span><span class="hljs-punctuation">)</span><br><span class="hljs-variable">Memory</span><span class="hljs-operator">:</span> <span class="hljs-number">4</span><span class="hljs-variable">k</span> <span class="hljs-variable">page</span><span class="hljs-operator">,</span> <span class="hljs-variable">physical</span> <span class="hljs-number">16777216</span><span class="hljs-variable">k</span><span class="hljs-punctuation">(</span><span class="hljs-number">589368</span><span class="hljs-variable">k</span> <span class="hljs-variable">free</span><span class="hljs-punctuation">)</span><br><br><span class="hljs-operator">/</span><span class="hljs-variable">proc</span><span class="hljs-operator">/</span><span class="hljs-variable">meminfo</span><span class="hljs-operator">:</span><br><br><span class="hljs-variable">CommandLine</span> <span class="hljs-variable">flags</span><span class="hljs-operator">:</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:</span><span class="hljs-variable">InitialHeapSize</span><span class="hljs-operator">=</span><span class="hljs-number">536870912</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:</span><span class="hljs-variable">MaxHeapSize</span><span class="hljs-operator">=</span><span class="hljs-number">536870912</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGC</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCDateStamps</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCDetails</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">PrintGCTimeStamps</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseCompressedClassPointers</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseCompressedOops</span> <span class="hljs-operator">-</span><span class="hljs-variable">XX</span><span class="hljs-operator">:+</span><span class="hljs-variable">UseParallelGC</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.646</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.126</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">131584</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21502</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">131584</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">47819</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0115940</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.676</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.156</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">153086</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21497</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">179403</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">91591</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0159088</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.707</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.188</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">153081</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21500</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">223175</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">131269</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0127081</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.736</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.216</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">153084</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21503</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">262853</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">177469</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0151634</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.766</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.247</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">152950</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21488</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">308916</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">218539</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0144377</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.797</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.277</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">152645</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21497</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">80384</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">349697</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">259325</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">430080</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0132490</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.818</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.298</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">79609</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">36259</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">317437</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">280306</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0053558</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.833</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.313</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">95139</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">47999</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">339186</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">298252</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0076742</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.848</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.329</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">106879</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">57817</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">357132</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">316937</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0094228</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.866</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.347</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">116697</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">40221</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">375817</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">335350</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0127900</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.05</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.879</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.360</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">40221</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">295129</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">240839</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">335350</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">240839</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0331005</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.922</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.402</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58315</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21801</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">299155</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">262641</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0018162</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-operator">......</span><br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.041</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.521</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58880</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">22595</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349642</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349114</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408522</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">371709</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0395122</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.24</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.086</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.567</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58714</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">26618</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349114</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349513</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407828</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">376131</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0603584</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.20</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.152</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.632</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58880</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21695</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349513</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349492</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408393</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">371188</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0389743</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.20</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.198</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.678</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58739</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">20467</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349492</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349172</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408231</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">369639</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0382426</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.22</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.242</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.723</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58634</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15899</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349172</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349690</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407806</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">365590</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0375539</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.22</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.288</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.768</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58880</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17101</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349690</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349416</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408570</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">366517</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0399298</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.20</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.335</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.816</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58765</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15555</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349416</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349180</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408182</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">364736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0380655</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.381</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.861</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58681</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">18582</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349180</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349211</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407862</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">367794</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0398334</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.23</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.429</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.909</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58773</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">16686</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349211</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407985</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">365727</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0384315</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.20</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.474</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">4.955</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58872</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17929</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349040</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349562</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407913</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">367492</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0397868</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.22</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.522</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">5.002</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58877</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">15917</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349562</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349348</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">408440</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">365266</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0391023</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.22</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.571</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">5.051</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br><span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58597</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17423</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349348</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349274</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407945</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">366698</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0379030</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-variable">Heap</span><br> <span class="hljs-variable">PSYoungGen</span>      <span class="hljs-variable">total</span> <span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">19718</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b5580000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">eden</span> <span class="hljs-variable">space</span> <span class="hljs-number">58880</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">33</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b5580000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b68c1a00</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b8f00000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">from</span> <span class="hljs-variable">space</span> <span class="hljs-number">57856</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b8f00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b8f00000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bc780000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">to</span>   <span class="hljs-variable">space</span> <span class="hljs-number">57856</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bc780000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007bc780000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007c0000000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">ParOldGen</span>       <span class="hljs-variable">total</span> <span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">used</span> <span class="hljs-number">349274</span><span class="hljs-built_in">K</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a0000000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007b5580000</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span><span class="hljs-variable">x00000007b5580000</span><span class="hljs-punctuation">)</span><br>  <span class="hljs-variable">object</span> <span class="hljs-variable">space</span> <span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-number">99</span><span class="hljs-operator">%</span> <span class="hljs-variable">used</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007a0000000</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b5516a00</span><span class="hljs-operator">,</span><span class="hljs-number">0</span><span class="hljs-variable">x00000007b5580000</span><span class="hljs-punctuation">)</span><br> <span class="hljs-variable">Metaspace</span>       <span class="hljs-variable">used</span> <span class="hljs-number">2571</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">4486</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">4864</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><br>  <span class="hljs-variable">class</span> <span class="hljs-variable">space</span>    <span class="hljs-variable">used</span> <span class="hljs-number">276</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">capacity</span> <span class="hljs-number">386</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">committed</span> <span class="hljs-number">512</span><span class="hljs-built_in">K</span><span class="hljs-operator">,</span> <span class="hljs-variable">reserved</span> <span class="hljs-number">1048576</span><span class="hljs-built_in">K</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ°ParallelGC çš„GCæ—¥å¿—å’ŒSerial GC çš„æ—¥å¿—å¤§ä½“ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œä¸‹é¢æ˜¯MinorGC çš„æ—¥å¿—åˆ†æã€‚</p><h4 id="MinorGC-æ—¥å¿—åˆ†æ-1"><a href="#MinorGC-æ—¥å¿—åˆ†æ-1" class="headerlink" title="MinorGC æ—¥å¿—åˆ†æ"></a>MinorGC æ—¥å¿—åˆ†æ</h4><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">11.676</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.156</span><span class="hljs-operator">:</span> <br>        <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>        <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">153086</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">21497</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">153088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">179403</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">91591</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">502784</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0159088</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br></code></pre></td></tr></table></figure><p>æ—¥å¿—è§£è¯»å¦‚ä¸‹ï¼š</p><ol><li><code>2021-07-14T00:42:11.676-0800: 0.156</code> GCäº‹ä»¶å¼€å§‹äº‹ä»¶ã€‚</li><li><code>GC</code>ç”¨æ¥åŒºåˆ†MinorGCè¿˜æ˜¯FullGCçš„æ ‡å¿—ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ¬¡å°å‹GCï¼ˆMinorGCï¼‰ã€‚</li><li><code>PSYoungGen</code> åƒåœ¾æ”¶é›†å™¨åç§°ã€‚è¿™ä¸ªåå­—è¡¨ç¤ºçš„æ˜¯åœ¨å¹´è½»ä»£ä¸­ä½¿ç”¨ï¼šå¹¶è¡ŒGCçš„<code>æ ‡è®°-å¤åˆ¶(mark-copy)</code>ï¼Œå…¨çº¿æš‚åœ(STW)åƒåœ¾æ”¶é›†å™¨ã€‚<code>153086K-&gt;21497K(153088K)</code> åˆ™æ˜¯GCå‰åå¹´è½»ä»£çš„ä½¿ç”¨é‡ï¼Œä»¥åŠå¹´è½»ä»£çš„æ€»å¤§å°ï¼Œç®€å•è®¡ç®—å¯ä»¥å¾—å‡ºGCåå¹´è½»ä»£çš„ä½¿ç”¨ç‡<code>21497K/153088Kï½=14%</code>ã€‚</li><li><code>179403K-&gt;91591K(502784K)</code> åˆ™æ˜¯GCå‰åå †ç©ºé—´çš„ä½¿ç”¨é‡ï¼Œå·²ç»å¯ç”¨å †çš„æ€»å¤§å°ï¼ŒGCåå †ç©ºé—´çš„ä½¿ç”¨ç‡ä¸º<code>91591K/502784Kï½=18.2%</code>ï¼Œç”±äºè¿™ä¸ªGCäº‹ä»¶å‘ç”Ÿåœ¨JVMåˆšå¯åŠ¨ï¼Œåˆ›å»ºçš„å¯¹è±¡å¹¶ä¸å¤šã€‚è¿™ä¸ªä½¿ç”¨é‡è¿˜ç®—æ˜¯å¥åº·çš„ã€‚</li><li><code>[Times: user=0.03 sys=0.07, real=0.02 secs]</code> GCäº‹ä»¶çš„æŒç»­äº‹ä»¶ï¼Œé€šè¿‡ä¸‰ä¸ªéƒ¨åˆ†è¡¡é‡ï¼š<code>user</code>è¡¨ç¤ºGCçº¿ç¨‹æ‰€æ¶ˆè€—çš„æ€»CPUæ—¶é—´ï¼Œ<code>sys</code>è¡¨ç¤ºæ“ä½œç³»ç»Ÿè°ƒç”¨å’Œç³»ç»Ÿç­‰å¾…äº‹ä»¶æ‰€æ¶ˆè€—çš„äº‹ä»¶ã€‚<code>real</code>åˆ™è¡¨ç¤ºåº”ç”¨ç¨‹åºå®é™…æ¶ˆè€—çš„æ—¶é—´ã€‚å› ä¸ºä¸æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„æ“ä½œçš„è¿‡ç¨‹éƒ½èƒ½å…¨éƒ¨å¹¶è¡Œï¼Œæ‰€æœ‰åœ¨ParallelGCä¸­ï¼Œ<code>realï½=(user+ system)/GCçº¿ç¨‹æ•°</code>ã€‚</li></ol><p>é€šè¿‡è¿™éƒ¨åˆ†æ—¥å¿—æˆ‘ä»¬å¯ä»¥ç®€å•è®¡ç®—å‡ºï¼šåœ¨GCä¹‹å‰ï¼Œå †å†…å­˜æ€»ä½¿ç”¨é‡ä¸º<code>179403K</code>ï¼Œå…¶ä¸­å¹´è½»ä»£ä¸º<code>153086K</code>ï¼Œé‚£ä¹ˆè€å¹´ä»£çš„ä½¿ç”¨é‡ä¸º<code>179403K-153086K=26319K</code>è¿™å¹¶ä¸å¤šï¼Œä½†æ˜¯è¿™æ˜¯JVMçš„ç¬¬äºŒæ¬¡GCæ—¶é—´ï¼Œæœ‰ä¸€éƒ¨åˆ†å¯¹è±¡å·²ç»åœ¨ç¬¬ä¸€æ¬¡GCå®Œæˆåç›´æ¥è¢«æ™‹å‡è¿›äº†è€å¹´ä»£ã€‚åœ¨è¿™æ¬¡GCå®Œæˆåå¹´è½»ä»£å‡å°‘äº†<code>153086K-21497K=131589K</code>ï¼Œæ€»å †å‡å°‘äº†<code>179403K-91591K=87812K</code>ï¼Œå…¶ä¸­æœ‰<code>131589K-87812K=43777K</code>è¢«æå‡åˆ°äº†è€å¹´ä»£ã€‚è€å¹´ä»£çš„æ€»å¤§å°ä¸º<code>502784K-153088K=349696K</code>ï¼Œå½“å‰è€å¹´ä»£ä½¿ç”¨ç‡ä¸º<code>(91591K-21497K)/349696K~=20%</code>ã€‚</p><blockquote><p>å¹´è½»ä»£GCï¼Œæˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸šåŠ¡æš‚åœæ—¶é—´ï¼Œä»¥åŠGCåå†…å­˜çš„ä½¿ç”¨ç‡æ˜¯å¦æ­£å¸¸ï¼Œ<strong>ä½†ä¸ç”¨ç‰¹åˆ«å…³æ³¨GCå‰çš„ä½¿ç”¨é‡ï¼Œè€Œä¸”åªè¦ä¸šåŠ¡åœ¨è¿è¡Œï¼Œå¹´è½»ä»£çš„å¯¹è±¡åˆ†é…å°±å°‘ä¸äº†ï¼Œå›æ”¶é‡ä¹Ÿä¸ä¼šå°‘ã€‚</strong></p></blockquote><h4 id="FullGC-æ—¥å¿—åˆ†æ-1"><a href="#FullGC-æ—¥å¿—åˆ†æ-1" class="headerlink" title="FullGC æ—¥å¿—åˆ†æ"></a>FullGC æ—¥å¿—åˆ†æ</h4><p>å‰é¢ä»‹ç»äº†å¹¶è¡ŒGCçš„å¹´è½»ä»£çš„GCæ—¥å¿—ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹è€å¹´ä»£çš„GCæ—¥å¿—ã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">14</span><span class="hljs-variable">T00</span><span class="hljs-operator">:</span><span class="hljs-number">42</span><span class="hljs-operator">:</span><span class="hljs-number">16.571</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">5.051</span><span class="hljs-operator">:</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">58597</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">17423</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">116736</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">349348</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">349274</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">349696</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">407945</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">366698</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">466432</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <br>      <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2565</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0379030</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>      <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.00</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„æ—¥å¿—ä¸­æˆ‘ä»¬å¯ä»¥åˆ†æå‡ºä»¥ä¸‹çš„ä¸€äº›ä¿¡æ¯ï¼š</p><ol><li><code>2021-07-14T00:42:16.571-0800:</code> GCäº‹ä»¶å¼€å§‹äº‹ä»¶ã€‚</li><li><code>Full GC</code> ä¸€æ¬¡fullGCçš„æ ‡è¯†ï¼ŒFullGC è¡¨æ˜æœ¬æ¬¡GCäº‹ä»¶æ¸…ç†è€å¹´ä»£å’Œå¹´è½»ä»£ï¼Œ<code>Ergonomics</code> æ˜¯è§¦å‘GCçš„åŸå› ï¼Œè¡¨ç¤ºJVMå†…éƒ¨ç¯å¢ƒè®¤ä¸ºæ­¤æ—¶å¯ä»¥è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†ã€‚</li><li><code>[PSYoungGen: 58597K-&gt;17423K(116736K)]</code> å’Œä¸Šé¢çš„ç¤ºä¾‹ä¸€æ ·ï¼Œæ¸…ç†å¹´è½»ä»£çš„åƒåœ¾æ”¶é›†æ°”æ˜¯åä¸ºâ€œPSYoungGenâ€çš„STWæ”¶é›†å™¨ï¼Œé‡‡ç”¨<code>æ ‡è®°-å¤åˆ¶(mark-copy)</code>ç®—æ³•ã€‚å¹´è½»ä»£ä½¿ç”¨é‡ä»<code>58597K</code>å˜ä¸º<code>17423K</code>ï¼Œè¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯å¹´è½»ä»£åœ¨fullGCä¹‹åå¹¶æ²¡æœ‰è¢«æ¸…ç©ºï¼Œè€Œæ˜¯ä¿ç•™äº†éƒ¨åˆ†çš„å¯¹è±¡ã€‚å› ä¸ºè¿™æ¡GCæ—¥å¿—æ˜¯JVMæ‰§è¡ŒåæœŸçš„æ—¥å¿—ï¼Œå…¶ä¸­è€å¹´ä»£å·²ç»è¢«å¡çš„å¾ˆæ»¡ï¼Œä¸èƒ½æ”¯æŒè¿™ä¹ˆå¤šå¯¹è±¡æ™‹å‡ã€‚</li><li><code>ParOldGen</code>ç”¨äºæ¸…ç†è€å¹´ä»£ç©ºé—´çš„åƒåœ¾æ”¶é›†å™¨ç±»å‹ã€‚è¿™é‡Œçš„ä½¿ç”¨çš„æ˜¯ ParOldGen çš„åƒåœ¾æ”¶é›†å™¨ï¼Œè¿™æ˜¯ä¸€æ¬¾å¹¶è¡ŒSTWåƒåœ¾æ”¶é›†å™¨ï¼Œç®—æ³•ä¸º<code>æ ‡è®°-æ¸…é™¤-æ•´ç†(mark-sweep-compact)</code>ã€‚ç®€å•è®¡ç®—ä¸‹ï¼ŒGCä¹‹å‰è€å¹´ä»£çš„ä½¿ç”¨ç‡ä¸º <code>349348K/349696Kï½=99.9%</code>ï¼ŒGCä¹‹åçš„è€å¹´ä»£ä½¿ç”¨ç‡ä¸º<code>349274K/349696Kï½=99.8%</code>ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼ŒfullGCå¹¶æ²¡æœ‰å›æ”¶å¤šå°‘çš„å†…å­˜ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µJVMåœ¨ä¸æ–­çš„è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œç³»ç»Ÿå·²ç»å¤„äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚</li><li><code>407945K-&gt;366698K(466432K)</code> åœ¨åƒåœ¾æ”¶é›†ä¹‹å‰å’Œä¹‹åçš„å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µï¼Œä»¥åŠå¯ç”¨å †å†…å®¹æ€»å®¹é‡ã€‚ç®€å•åˆ†æå¯ä»¥çŸ¥é“ï¼ŒGCä¹‹å‰å †å†…å­˜çš„ä½¿ç”¨ç‡ä¸ºï¼š<code>407945K/466432Kï½=87.5%</code>ï¼ŒGCä¹‹åçš„å †å†…å­˜ä¸ºï¼š<code>366698K/466432Kï½=78.6%</code></li><li><code>[Metaspace: 2565K-&gt;2565K(1056768K)]</code>å‰é¢æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†å…³äºMetaspace ç©ºé—´ç±»ä¼¼çš„ä¿¡æ¯ï¼Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨GCäº‹ä»¶ä¸­Metaspace é‡Œé¢æ²¡æœ‰å›æ”¶ä»»ä½•å¯¹è±¡ã€‚</li><li><code>0.0379030 secs</code> GCäº‹ä»¶çš„æŒç»­æ—¶é—´ï¼Œä»¥ç§’ä¸ºå•ä½ã€‚å…¶ä¸­<code>[Times: user=0.21 sys=0.00, real=0.03 secs]</code>è¿™ä¹Ÿæ˜¯GCçš„æŒç»­æ—¶é—´ï¼Œ<code>user + sys &gt; real</code>è¿™æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œçš„ç»“æœã€‚åŒæ—¶è¿™é‡Œçº¦ç­‰äºæ˜¯7å€ï¼Œè€Œæˆ‘çš„æœºå™¨æ˜¯4æ ¸8çº¿ç¨‹çš„ï¼Œ<strong>å› ä¸ºæ€»æœ‰ä¸€å®šæ¯”ä¾‹æ˜¯ä¸èƒ½å¹¶è¡Œæ‰§è¡Œçš„ã€‚</strong></li></ol><blockquote><p>FullGC æ—¶æˆ‘ä»¬<strong>æ›´å…³æ³¨è€å¹´ä»£çš„ä½¿ç”¨é‡æœ‰æ²¡æœ‰ä¸‹é™ï¼Œä»¥åŠä¸‹é™äº†å¤šå°‘</strong>ã€‚å¦‚æœFullGCä¹‹åå†…å­˜ä¸æ€ä¹ˆä¸‹é™ï¼Œä½¿ç”¨ç‡è¿˜æ˜¯å¾ˆé«˜ï¼Œé‚£å°±è¯´æ˜ç³»ç»Ÿæœ‰é—®é¢˜äº†ï¼ˆå°±åƒæˆ‘ä»¬çš„æµ‹è¯•çš„ç³»ç»Ÿä¸€æ ·ï¼‰ã€‚</p></blockquote><h3 id="CMS-æ—¥å¿—è§£è¯»"><a href="#CMS-æ—¥å¿—è§£è¯»" class="headerlink" title="CMS æ—¥å¿—è§£è¯»"></a>CMS æ—¥å¿—è§£è¯»</h3><p>CMSä¹Ÿå¯ä»¥ç§°ä¸º<code>å¹¶å‘æ ‡è®°æ¸…é™¤åƒåœ¾æ”¶é›†å™¨</code>ã€‚å…¶è®¾è®¡ç›®çš„æ˜¯é¿å…è€å¹´ä»£GCæ—¶å‡ºç°é•¿æ—¶é—´çš„å¡é¡¿ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒCMS ä½¿ç”¨çš„å¹¶å‘çº¿ç¨‹ç­‰äºCPUå†…æ ¸æ•°çš„<code>1/4</code>ã€‚å¦‚æœCPUèµ„æºå—é™ï¼ŒCMSçš„ååé‡ä¼šæ¯”ParallelGCï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„é€‰é¡¹æŒ‡å®šCMSåƒåœ¾æ”¶é›†å™¨ï¼Œå¹¶å°†æ—¥å¿—è¾“å‡ºåˆ°gc.log</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseConcMarkSweepGC -Xms512m -Xmx512m -Xloggc:gc.log </span><br><span class="hljs-deletion">-XX:+PrintGCDetails -XX:+PrintGCDateStamps</span><br></code></pre></td></tr></table></figure><p>å’Œå‰é¢åˆ†æçš„ä¸²è¡ŒGCå’Œå¹¶è¡ŒGCä¸€æ ·ï¼Œæˆ‘ä»¬å°†ç¨‹åºå¯åŠ¨èµ·æ¥ï¼Œçœ‹çœ‹CMSçš„GCæ—¥å¿—å’Œå‰é¢çš„æ—¥å¿—æœ‰ä»€ä¹ˆä¸ä¸€æ ·ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs dns">Java HotSpot(TM) <span class="hljs-number">64</span>-Bit Server VM (<span class="hljs-number">25</span>.<span class="hljs-number">231</span>-b11) for bsd-amd64 JRE (<span class="hljs-number">1.8.0_231</span>-b11), built on Oct  <span class="hljs-number">5 2019 03</span>:<span class="hljs-number">15</span>:<span class="hljs-number">25</span> by &quot;java_re&quot; with gcc <span class="hljs-number">4</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span> (Based on Apple Inc. build <span class="hljs-number">5658</span>) (LLVM build <span class="hljs-number">2336.11.00</span>)<br>Memory: <span class="hljs-number">4</span>k page, physical <span class="hljs-number">16777216</span>k(<span class="hljs-number">395052</span>k free)<br><br>/proc/meminfo:<br><br>CommandLine flags: -XX:InitialHeapSize=<span class="hljs-number">536870912</span> -XX:MaxHeapSize=<span class="hljs-number">536870912</span> -XX:MaxNewSize=<span class="hljs-number">178958336</span> -XX:MaxTenuringThreshold=<span class="hljs-number">6</span> -XX:NewSize=<span class="hljs-number">178958336</span> -XX:OldPLABSize=<span class="hljs-number">16</span> -XX:OldSize=<span class="hljs-number">357912576</span> -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:+UseParNewGC <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">885-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">177</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">885-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">177</span>: [ParNew: <span class="hljs-number">139776</span>K-&gt;<span class="hljs-number">17471</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0140477</span> secs] <span class="hljs-number">139776</span>K-&gt;<span class="hljs-number">46305</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0142076</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">03</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">06</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">919-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">211</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">920-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">212</span>: [ParNew: <span class="hljs-number">157247</span>K-&gt;<span class="hljs-number">17466</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0156764</span> secs] <span class="hljs-number">186081</span>K-&gt;<span class="hljs-number">88855</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0157774</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">04</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">06</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">953-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">245</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">953-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">245</span>: [ParNew: <span class="hljs-number">156977</span>K-&gt;<span class="hljs-number">17471</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0246946</span> secs] <span class="hljs-number">228367</span>K-&gt;<span class="hljs-number">132415</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0247922</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">17</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">995-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">287</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">995-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">287</span>: [ParNew: <span class="hljs-number">157247</span>K-&gt;<span class="hljs-number">17470</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0201253</span> secs] <span class="hljs-number">272191</span>K-&gt;<span class="hljs-number">170226</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0202300</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">14</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">031-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">323</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">031-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">323</span>: [ParNew: <span class="hljs-number">157246</span>K-&gt;<span class="hljs-number">17472</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0231496</span> secs] <span class="hljs-number">310002</span>K-&gt;<span class="hljs-number">211673</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0232433</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">15</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">02</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">054-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">346</span>: [GC (CMS Initial Mark) [<span class="hljs-number">1</span> CMS-initial-mark: <span class="hljs-number">194201</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">211961</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0002540</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">054-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">346</span>: [CMS-concurrent-mark-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">056-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">348</span>: [CMS-concurrent-mark: <span class="hljs-number">0.002/0</span>.<span class="hljs-number">002</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">056-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">348</span>: [CMS-concurrent-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">057-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">349</span>: [CMS-concurrent-preclean: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">057-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">349</span>: [CMS-concurrent-abortable-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">071-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">363</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">071-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">363</span>: [ParNew: <span class="hljs-number">157248</span>K-&gt;<span class="hljs-number">17470</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0241859</span> secs] <span class="hljs-number">351449</span>K-&gt;<span class="hljs-number">252404</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0242841</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">15</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.110-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">402</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.110-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">402</span>: [ParNew: <span class="hljs-number">157246</span>K-&gt;<span class="hljs-number">17469</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0263702</span> secs] <span class="hljs-number">392180</span>K-&gt;<span class="hljs-number">298543</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0264666</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">16</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.151-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">443</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.151-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">443</span>: [ParNew: <span class="hljs-number">157245</span>K-&gt;<span class="hljs-number">17471</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0225189</span> secs] <span class="hljs-number">438319</span>K-&gt;<span class="hljs-number">339365</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0226134</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">14</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.187-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">479</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.187-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">479</span>: [ParNew: <span class="hljs-number">157247</span>K-&gt;<span class="hljs-number">157247</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0000202</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04.187-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">479</span>: [CMS20<span class="hljs-number">21-07-15T01</span>:<span class="hljs-number">04:04.187</span>-<span class="hljs-number">0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">479</span>: [CMS-concurrent-abortable-preclean: <span class="hljs-number">0.004/0</span>.<span class="hljs-number">130</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">53</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">04</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">13</span> secs] <br> (concurrent mode failure): <span class="hljs-number">321893</span>K-&gt;<span class="hljs-number">251462</span>K(<span class="hljs-number">349568</span>K), <span class="hljs-number">0.0517382</span> secs] <span class="hljs-number">479141</span>K-&gt;<span class="hljs-number">251462</span>K(<span class="hljs-number">506816</span>K), [Metaspace: <span class="hljs-number">2565</span>K-&gt;<span class="hljs-number">2565</span>K(<span class="hljs-number">1056768</span>K)], <span class="hljs-number">0.0518718</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">05</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">01</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">05</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">256-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">548</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">256-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">548</span>: [ParNew: <span class="hljs-number">139630</span>K-&gt;<span class="hljs-number">17468</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0062663</span> secs] <span class="hljs-number">391093</span>K-&gt;<span class="hljs-number">300508</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0063611</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">05</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">262-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">554</span>: [GC (CMS Initial Mark) [<span class="hljs-number">1</span> CMS-initial-mark: <span class="hljs-number">283040</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">303587</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0001363</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">262-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">554</span>: [CMS-concurrent-mark-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">263-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">555</span>: [CMS-concurrent-mark: <span class="hljs-number">0.001/0</span>.<span class="hljs-number">001</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">263-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">555</span>: [CMS-concurrent-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">264-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">556</span>: [CMS-concurrent-preclean: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">264-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">556</span>: [CMS-concurrent-abortable-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">277-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">569</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">277-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">569</span>: [ParNew: <span class="hljs-number">157244</span>K-&gt;<span class="hljs-number">17471</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0094558</span> secs] <span class="hljs-number">440284</span>K-&gt;<span class="hljs-number">344562</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0095346</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">07</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">287-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">579</span>: [CMS-concurrent-abortable-preclean: <span class="hljs-number">0.001/0</span>.<span class="hljs-number">024</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">09</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">02</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">287-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">579</span>: [GC (CMS Final Remark) [YG occupancy: <span class="hljs-number">27558</span> K (<span class="hljs-number">157248</span> K)]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">288-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">579</span>: [Rescan (parallel) , <span class="hljs-number">0.0002901</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">288-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">580</span>: [weak refs processing, <span class="hljs-number">0.0000103</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">288-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">580</span>: [class unloading, <span class="hljs-number">0.0001973</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">288-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">580</span>: [scrub symbol table, <span class="hljs-number">0.0002563</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">288-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">580</span>: [scrub string table, <span class="hljs-number">0.0001485</span> secs][<span class="hljs-number">1</span> CMS-remark: <span class="hljs-number">327091</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">354649</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0009506</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">289-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">580</span>: [CMS-concurrent-sweep-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">289-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">581</span>: [CMS-concurrent-sweep: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">289-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">581</span>: [CMS-concurrent-reset-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">04</span>.<span class="hljs-number">289-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">581</span>: [CMS-concurrent-reset: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br>......<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">774-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">066</span>: [GC (CMS Initial Mark) [<span class="hljs-number">1</span> CMS-initial-mark: <span class="hljs-number">349310</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">372830</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0002245</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">774-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">066</span>: [CMS-concurrent-mark-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">775-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">067</span>: [CMS-concurrent-mark: <span class="hljs-number">0.001/0</span>.<span class="hljs-number">001</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">775-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">067</span>: [CMS-concurrent-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [CMS-concurrent-preclean: <span class="hljs-number">0.001/0</span>.<span class="hljs-number">001</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [CMS-concurrent-abortable-preclean-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [CMS-concurrent-abortable-preclean: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [GC (CMS Final Remark) [YG occupancy: <span class="hljs-number">42054</span> K (<span class="hljs-number">157248</span> K)]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [Rescan (parallel) , <span class="hljs-number">0.0003608</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [weak refs processing, <span class="hljs-number">0.0000184</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [class unloading, <span class="hljs-number">0.0002228</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">778-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">070</span>: [scrub symbol table, <span class="hljs-number">0.0003110</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">778-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">070</span>: [scrub string table, <span class="hljs-number">0.0002060</span> secs][<span class="hljs-number">1</span> CMS-remark: <span class="hljs-number">349310</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">391364</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0012004</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">778-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">070</span>: [CMS-concurrent-sweep-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">779-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">071</span>: [CMS-concurrent-sweep: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">779-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">071</span>: [CMS-concurrent-reset-start]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">779-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">071</span>: [CMS-concurrent-reset: <span class="hljs-number">0.000/0</span>.<span class="hljs-number">000</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">794-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">086</span>: [GC (Allocation Failure) <span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">794-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">086</span>: [ParNew: <span class="hljs-number">157145</span>K-&gt;<span class="hljs-number">157145</span>K(<span class="hljs-number">157248</span>K), <span class="hljs-number">0.0000216</span> secs]<span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">794-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">086</span>: [CMS: <span class="hljs-number">349018</span>K-&gt;<span class="hljs-number">349462</span>K(<span class="hljs-number">349568</span>K), <span class="hljs-number">0.0484635</span> secs] <span class="hljs-number">506163</span>K-&gt;<span class="hljs-number">363671</span>K(<span class="hljs-number">506816</span>K), [Metaspace: <span class="hljs-number">2565</span>K-&gt;<span class="hljs-number">2565</span>K(<span class="hljs-number">1056768</span>K)], <span class="hljs-number">0.0485969</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">05</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">05</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">843-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">135</span>: [GC (CMS Initial Mark) [<span class="hljs-number">1</span> CMS-initial-mark: <span class="hljs-number">349462</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">363959</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0001943</span> secs] [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">843-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">135</span>: [CMS-concurrent-mark-start]<br>Heap<br> par new generation   total <span class="hljs-number">157248</span>K, used <span class="hljs-number">19849</span>K [<span class="hljs-number">0</span>x000000<span class="hljs-number">07a0000000</span>, <span class="hljs-number">0</span>x00000007aaaa0000, <span class="hljs-number">0</span>x00000007aaaa0000)<br>  eden space <span class="hljs-number">139776</span>K,  <span class="hljs-number">14</span>% used [<span class="hljs-number">0</span>x000000<span class="hljs-number">07a0000000</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07a13627d0</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07a8880000</span>)<br>  from space <span class="hljs-number">17472</span>K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0</span>x000000<span class="hljs-number">07a9990000</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07a9990000</span>, <span class="hljs-number">0</span>x00000007aaaa0000)<br>  to   space <span class="hljs-number">17472</span>K,   <span class="hljs-number">0</span>% used [<span class="hljs-number">0</span>x000000<span class="hljs-number">07a8880000</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07a8880000</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07a9990000</span>)<br> concurrent mark-sweep generation total <span class="hljs-number">349568</span>K, used <span class="hljs-number">349462</span>K [<span class="hljs-number">0</span>x00000007aaaa0000, <span class="hljs-number">0</span>x000000<span class="hljs-number">07c0000000</span>, <span class="hljs-number">0</span>x000000<span class="hljs-number">07c0000000</span>)<br> Metaspace       used <span class="hljs-number">2571</span>K, capacity <span class="hljs-number">4486</span>K, committed <span class="hljs-number">4864</span>K, reserved <span class="hljs-number">1056768</span>K<br>  class space    used <span class="hljs-number">276</span>K, capacity <span class="hljs-number">386</span>K, committed <span class="hljs-number">512</span>K, reserved <span class="hljs-number">1048576</span>K<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯CMSçš„ä¸€éƒ¨åˆ†GCæ—¥å¿—ï¼Œç›¸æ¯”äºä¸²è¡ŒGC/å¹¶è¡ŒGCæ¥è¯´ï¼ŒCMS çš„æ—¥å¿—ä¿¡æ¯å¤æ‚äº†å¾ˆå¤šï¼Œè¿™ä¸€æ–¹é¢æ˜¯å› ä¸ºCMSæ‹¥æœ‰æ›´åŠ ç²¾ç»†çš„GCæ­¥éª¤ï¼Œå¦ä¸€æ–¹é¢GCæ—¥å¿—å¾ˆè¯¦ç»†å°±æ„å‘³ç€æš´éœ²å‡ºæ¥çš„é—®é¢˜ä¹Ÿæ›´åŠ å…¨é¢ç»†è‡´ã€‚</p><h4 id="MinorGC-æ—¥å¿—åˆ†æ-2"><a href="#MinorGC-æ—¥å¿—åˆ†æ-2" class="headerlink" title="MinorGC æ—¥å¿—åˆ†æ"></a>MinorGC æ—¥å¿—åˆ†æ</h4><p>å…¶ä¸­GCè¯¦æƒ…çš„å‰é¢å‡ è¡Œæ˜¯å¹´è½»ä»£MinorGCæ—¶é—´ã€‚</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs"><span class="hljs-attribute">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">15</span>T<span class="hljs-number">01</span>:<span class="hljs-number">04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">885</span>-<span class="hljs-number">0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">177</span>: <br>[GC (Allocation Failure) <br><span class="hljs-attribute">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">15</span>T<span class="hljs-number">01</span>:<span class="hljs-number">04</span>:<span class="hljs-number">03</span>.<span class="hljs-number">885</span>-<span class="hljs-number">0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">177</span>: <br>        [ParNew: 139776K-&gt;17471K(157248K), 0.0140477 secs] <br>            <span class="hljs-attribute">139776K</span>-&gt;<span class="hljs-number">46305</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0</span>.<span class="hljs-number">0142076</span> secs] <br>    [Times: user=0.03 sys=0.06, real=0.01 secs] <br></code></pre></td></tr></table></figure><ol><li><code>2021-07-15T01:04:03.885-0800: 0.177:</code> GCäº‹ä»¶å¼€å§‹çš„äº‹ä»¶ã€‚</li><li><code>GC (Allocation Failure)</code> ç”¨æ¥åŒºåˆ†MinorGCè¿˜æ˜¯FullGCçš„æ ‡å¿—ã€‚<code>GC</code> è¡¨æ˜è¿™æ˜¯ä¸€æ¬¡<code>å°å‹GC</code>ï¼›<code>Allocation Failure</code>è¡¨ç¤ºè§¦å‘GCçš„åŸå› ã€‚æœ¬æ¬¡GCäº‹ä»¶ï¼Œæ˜¯ç”±å¹´è½»ä»£å¯ç”¨ç©ºé—´ä¸è¶³ï¼Œæ–°å¯¹è±¡çš„å†…å­˜åˆ†é…å¤±è´¥å¼•èµ·çš„ã€‚</li><li><code>[ParNew: 139776K-&gt;17471K(157248K), 0.0140477 secs]</code> å…¶ä¸­<code>ParNew</code>æ˜¯åƒåœ¾æ”¶é›†å™¨çš„åç§°ï¼Œå¯¹åº”çš„å°±æ˜¯å‰é¢æ‰“å°çš„<code>-XX:+UseParNewGC</code>è¿™ä¸ªå‘½ä»¤è¡Œæ ‡å¿—ã€‚è¡¨ç¤ºå¹´è½»ä»£ä¸­ä½¿ç”¨çš„ï¼š<code>å¹¶è¡Œçš„æ ‡è®°-å¤åˆ¶(mark-copy)</code>åƒåœ¾æ”¶é›†å™¨ï¼Œä¸“é—¨è®¾è®¡äº†ç”¨æ¥é…åˆCMS çš„åƒåœ¾æ”¶é›†å™¨ï¼Œå› ä¸ºCMSåªè´Ÿè´£å›æ”¶è€å¹´ä»£ã€‚åé¢çš„æ•°å­—è¡¨ç¤ºGCå‰åçš„å¹´è½»ä»£ä½¿ç”¨é‡å˜åŒ–ï¼Œä»¥åŠå¹´è½»ä»£çš„æ€»å¤§å°ã€‚<code>0.0140477 secs</code>æ˜¯æ¶ˆè€—çš„æ—¶é—´ã€‚</li><li><code>139776K-&gt;46305K(506816K), 0.0142076 secs</code> è¡¨ç¤ºGCå‰åå †å†…å­˜çš„ä½¿ç”¨é‡å˜åŒ–ï¼Œä»¥åŠå †ç©ºé—´çš„å†…å­˜å¤§å°ã€‚æ¶ˆè€—æ—¶é—´æ˜¯<code>0.0142076 secs</code>ï¼Œå’Œå‰é¢çš„ ParNew éƒ¨åˆ†çš„æ—¶é—´åŸºæœ¬ä¸Šä¸€æ ·ã€‚</li><li><code>[Times: user=0.03 sys=0.06, real=0.01 secs]</code> GCäº‹ä»¶çš„æŒç»­äº‹ä»¶ï¼Œ<code>user</code>æ˜¯GCçº¿ç¨‹æ‰€æ¶ˆè€—çš„æ€»CPUæ—¶é—´ï¼š<code>sys</code> æ˜¯æ“ä½œç³»ç»Ÿè°ƒç”¨å’Œç³»ç»Ÿç­‰å¾…äº‹ä»¶æ¶ˆè€—çš„äº‹ä»¶ï¼›åº”ç”¨ç¨‹åºå®é™…æš‚åœæ—¶é—´<code>real ï½= (user + sys)/GCçº¿ç¨‹æ•°</code>ã€‚</li></ol><p>é€šè¿‡è¿›ä¸€æ­¥è®¡ç®—æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œåœ¨GCä¹‹å‰ï¼Œå¹´è½»ä»£æ˜¯ä½¿ç”¨é‡ä¸º <code>139776K/157248K ï½= 88.9%</code>ã€‚å †å†…å­˜çš„ä½¿ç”¨ç‡ä¸º<code>139776K/506816K ï½= 27.6%</code>ï¼Œç®€å•ä¼°ç®—ä¸‹è€å¹´ä»£çš„ä½¿ç”¨é‡ï¼Œåœ¨ParNew GC å¼€å§‹å‰ï¼Œå¹´è½»ä»£å’Œæ•´å †ä½¿ç”¨é‡ç›¸åŒå› æ­¤ï¼Œè€å¹´ä»£åœ¨GCä¹‹å‰çš„ä½¿ç”¨é‡ä¸º0ã€‚è€ŒGCåè€å¹´ä»£çš„ä½¿ç”¨ç‡ä¸º<code>(46305-17471)/506816K~=5.6%</code>ã€‚</p><h4 id="FullGC-æ—¥å¿—åˆ†æ-2"><a href="#FullGC-æ—¥å¿—åˆ†æ-2" class="headerlink" title="FullGC æ—¥å¿—åˆ†æ"></a>FullGC æ—¥å¿—åˆ†æ</h4><p>CMS çš„æ—¥å¿—é£æ ¼å’Œä¹‹å‰çš„é›†ä¸­æ—¥å¿—çš„é£æ ¼ä¸ä¸€æ ·ï¼ŒCMSçš„æ—¥å¿—åŒ…å«äº†CMSæ‰§è¡Œçš„å¤šä¸ªé˜¶æ®µçš„å†…å­˜ä½¿ç”¨ä¿¡æ¯ï¼ŒåŒæ—¶ä¹ŸåŒ…å«äº†æ›´å¤šæ›´è¯¦ç»†çš„GCä¿¡æ¯ï¼Œä¸‹é¢å°±æ˜¯ä¸€æ¡å®Œæ•´çš„GCæ—¥å¿—ä¿¡æ¯ã€‚</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs subunit">2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.774<span class="hljs-string">-0800</span>: 5.066: <br>        [GC (CMS Initial Mark) <br>    [1 CMS-initial-mark: 349310K(349568K)] 372830K(506816K), 0.0002245 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.774<span class="hljs-string">-0800</span>: 5.066: [CMS-concurrent-mark-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.775<span class="hljs-string">-0800</span>: 5.067: <br>        [CMS-concurrent-mark: 0.001/0.001 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.775<span class="hljs-string">-0800</span>: 5.067: [CMS-concurrent-preclean-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: <br>        [CMS-concurrent-preclean: 0.001/0.001 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: [CMS-concurrent-abortable-preclean-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: <br>        [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: [GC (CMS Final Remark) [YG occupancy: 42054 K (157248 K)]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: [Rescan (parallel) , 0.0003608 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: [weak refs processing, 0.0000184 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.777<span class="hljs-string">-0800</span>: 5.069: [class unloading, 0.0002228 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.778<span class="hljs-string">-0800</span>: 5.070: [scrub symbol table, 0.0003110 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.778<span class="hljs-string">-0800</span>: 5.070: [scrub string table, 0.0002060 secs]<br>    [1 CMS-remark: 349310K(349568K)] 391364K(506816K), 0.0012004 secs] <br>    [Times: user=0.01 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.778<span class="hljs-string">-0800</span>: 5.070: [CMS-concurrent-sweep-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.779<span class="hljs-string">-0800</span>: 5.071: <br>        [CMS-concurrent-sweep: 0.000/0.000 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.779<span class="hljs-string">-0800</span>: 5.071: [CMS-concurrent-reset-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-15</span>T01:04:08.779<span class="hljs-string">-0800</span>: 5.071: <br>        [CMS-concurrent-reset: 0.000/0.000 secs] <br>    [Times: user=0.00 sys=0.00, real=0.00 secs] <br></code></pre></td></tr></table></figure><p>åœ¨å®é™…çš„è¿è¡Œé˜¶æ®µï¼ŒCMSåœ¨è¿›è¡Œè€å¹´ä»£çš„å¹¶å‘åƒåœ¾å›æ”¶æ—¶ï¼Œå¯èƒ½ä¼´éšå¤šæ¬¡å¹´è½»ä»£çš„MinorGCï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒFullGCçš„æ—¥å¿—ä¸­å¯èƒ½æºæ‚å¤šæ¬¡MinorGCäº‹ä»¶ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¯¦ç»†åˆ†æCMSæ—¥å¿—çš„æ¯ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœåˆå¿˜è®°çš„å°ä¼™ä¼´å¯ä»¥å»åƒåœ¾æ”¶é›†å™¨ï¼ˆä¸Šï¼‰å¤ä¹ ä¸‹CMSçš„åƒåœ¾æ”¶é›†è¿‡ç¨‹ã€‚</p><h5 id="é˜¶æ®µ1ï¼šInitial-Markï¼ˆåˆå§‹æ ‡è®°ï¼‰"><a href="#é˜¶æ®µ1ï¼šInitial-Markï¼ˆåˆå§‹æ ‡è®°ï¼‰" class="headerlink" title="é˜¶æ®µ1ï¼šInitial Markï¼ˆåˆå§‹æ ‡è®°ï¼‰"></a>é˜¶æ®µ1ï¼šInitial Markï¼ˆåˆå§‹æ ‡è®°ï¼‰</h5><p>å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¸ªé˜¶æ®µä¼´éšç€STWæš‚åœã€‚åˆå§‹æ ‡è®°çš„ç›®æ ‡æ˜¯æ ‡è®°æ‰€æœ‰çš„æ ¹å¯¹è±¡ï¼ŒåŒ…æ‹¬<code>GC ROOT</code>ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ï¼Œä»¥åŠè¢«å¹´è½»ä»£ä¸­æ‰€æœ‰å­˜æ´»å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚åé¢è¿™éƒ¨åˆ†ä¹Ÿéå¸¸é‡è¦ï¼Œå› ä¸ºè€å¹´ä»£æ˜¯ç‹¬ç«‹è¿›è¡Œå›æ”¶çš„ã€‚å…ˆçœ‹è¿™ä¸ªé˜¶æ®µçš„æ—¥å¿—ä¿¡æ¯ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.774-0800: 5.066: <br>        [GC (CMS Initial Mark) <br>    [1 CMS-initial-mark: 349310K(349568K)] 372830K(506816K), 0.0002245 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs] <br></code></pre></td></tr></table></figure><blockquote><ol><li><code>2021-07-15T01:04:08.774-0800: 5.066:</code> GCå¼€å§‹äº‹ä»¶ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±ä¸é‡å¤ã€‚</li><li><code>CMS Initial Mark</code>è¿™ä¸ªé˜¶æ®µçš„åç§°ä¸º â€œ<code>Initial Mark</code>â€ï¼Œä¼šæ ‡è®°æ‰€æœ‰çš„<code>GC ROOT</code>ã€‚</li><li><code>[1 CMS-initial-mark: 349310K(349568K)]</code> è¿™ä¸ªéƒ¨åˆ†æ•°å­—è¡¨ç¤ºè€å¹´ä»£çš„ä½¿ç”¨é‡ï¼Œä»¥åŠè€å¹´ä»£çš„ç©ºé—´å¤§å°ã€‚</li><li><code>372830K(506816K), 0.0002245 secs</code> è¿™ä¸ªæ˜¯å½“å‰å †å†…å­˜çš„ä½¿ç”¨é‡ï¼Œä»¥åŠå¯ç”¨å †çš„å¤§å°ï¼Œæ¶ˆè€—çš„æ—¶é—´ï¼Œå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ—¶é—´éå¸¸çŸ­ï¼Œåªæœ‰<code>0.02</code>æ¯«ç§’ï¼Œå› ä¸ºè¦æ ‡è®°çš„Rootæ•°é‡éå¸¸å°‘ã€‚</li><li><code>[Times: user=0.00 sys=0.00, real=0.00 secs]</code> åˆå§‹æ ‡è®°æ—¶é—´æš‚åœçš„æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è€—è´¹æ—¶é—´éå¸¸çŸ­ï¼ŒåŸºæœ¬å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚</li></ol></blockquote><h5 id="é˜¶æ®µ2ï¼šConcurrent-Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰"><a href="#é˜¶æ®µ2ï¼šConcurrent-Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰" class="headerlink" title="é˜¶æ®µ2ï¼šConcurrent Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰"></a>é˜¶æ®µ2ï¼šConcurrent Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰</h5><p>åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µï¼ŒCMS ä»å‰ä¸€æ®µ â€œInital Markâ€æ‰¾åˆ°ROOTå¼€å§‹ç®—èµ·ï¼Œéå†è€å¹´ä»£å¹¶æ ‡è®°æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µçš„GCæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.774-0800: 5.066: [CMS-concurrent-mark-start]<br>2021-07-15T01:04:08.775-0800: 5.067: <br>        [CMS-concurrent-mark: 0.001/0.001 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs] <br></code></pre></td></tr></table></figure><blockquote><ol><li><code>CMS-concurrent-mark-start</code> -æŒ‡æ˜äº†æ˜¯CMSåƒåœ¾æ”¶é›†å™¨æ‰€å¤„çš„é˜¶æ®µä¸ºå¹¶å‘æ ‡è®°â€Concurrent Markâ€ã€‚</li><li><code>0.001/0.001 secs</code> æ­¤é˜¶æ®µçš„æŒç»­æ—¶é—´ï¼Œåˆ†åˆ«æ˜¯GCçº¿ç¨‹æ¶ˆè€—çš„æ—¶é—´å’Œå®é™…æ¶ˆè€—çš„æ—¶é—´ã€‚</li><li><code>[Times: user=0.00 sys=0.00, real=0.00 secs]</code> æ‰§è¡Œå®ç°å¯¹å¹¶å‘é˜¶æ®µæ¥è¯´å¹¶æ²¡æœ‰å¤šå°‘æ„ä¹‰ï¼Œå› ä¸ºæ˜¯ä»å¹¶å‘æ ‡è®°å¼€å§‹æ—¶åˆ»è®¡ç®—çš„ï¼Œè€Œè¿™æ®µæ—¶é—´åº”ç”¨çº¿ç¨‹ä¹Ÿåœ¨æ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªæ—¶é—´åªæ˜¯ä¸€ä¸ªå¤§æ¦‚çš„å€¼ã€‚</li></ol></blockquote><h5 id="é˜¶æ®µ3ï¼šConcurrent-Precleanï¼ˆå¹¶å‘é¢„æ¸…ç†ï¼‰"><a href="#é˜¶æ®µ3ï¼šConcurrent-Precleanï¼ˆå¹¶å‘é¢„æ¸…ç†ï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šConcurrent Precleanï¼ˆå¹¶å‘é¢„æ¸…ç†ï¼‰"></a>é˜¶æ®µ3ï¼šConcurrent Precleanï¼ˆå¹¶å‘é¢„æ¸…ç†ï¼‰</h5><p>æ­¤é˜¶æ®µåŒæ ·æ˜¯ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„ï¼Œä¸éœ€è¦åœæ­¢åº”ç”¨çº¿ç¨‹ã€‚è¿™é˜¶æ®µçš„å¹¶å‘æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.775-0800: 5.067: [CMS-concurrent-preclean-start]<br>2021-07-15T01:04:08.777-0800: 5.069: <br>        [CMS-concurrent-preclean: 0.001/0.001 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs]<br></code></pre></td></tr></table></figure><p>ç®€å•è§£è¯»ï¼š</p><blockquote><ol><li><code>CMS-concurrent-preclean</code> è¡¨æ˜è¿™æ˜¯å¹¶å‘æ¸…ç†é˜¶æ®µçš„æ—¥å¿—ï¼Œè¿™ä¸ªé˜¶æ®µä¼šç»Ÿè®¡å‰é¢çš„å¹¶å‘æ ‡é˜¶æ®µæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†æ”¹å˜çš„å¯¹è±¡ã€‚</li><li><code>0.001/0.001 secs</code> æ­¤é˜¶æ®µçš„æŒç»­æ—¶é—´ï¼Œåˆ†åˆ«æ˜¯GCçº¿ç¨‹è¿è¡Œæ—¶é—´å’Œå®é™…å ç”¨çš„æ—¶é—´ã€‚<code>Times</code>éƒ¨åˆ†å’Œå‰é¢çš„ä¸€æ ·è¿™é‡Œå°±ä¸é‡å¤ä»‹ç»äº†ã€‚</li></ol></blockquote><h5 id="é˜¶æ®µ4ï¼šConcurrent-Abortable-Precleanï¼ˆå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼‰"><a href="#é˜¶æ®µ4ï¼šConcurrent-Abortable-Precleanï¼ˆå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼‰" class="headerlink" title="é˜¶æ®µ4ï¼šConcurrent Abortable Precleanï¼ˆå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼‰"></a>é˜¶æ®µ4ï¼šConcurrent Abortable Precleanï¼ˆå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼‰</h5><p>æ­¤é˜¶æ®µä¹Ÿä¸åœæ­¢åº”ç”¨çº¿ç¨‹ï¼Œå°è¯•åœ¨å°±è§¦å‘STWçš„Final Remark é˜¶æ®µå¼€å§‹ä¹‹å‰ï¼Œå°½å¯èƒ½åœ°å¤šå¹²ä¸€äº›æ´»ã€‚æœ¬é˜¶æ®µçš„å…·ä½“æ—¶é—´å–å†³äºå¤šç§å› ç´ ï¼Œå› ä¸ºå®ƒå¾ªç¯åšåŒæ ·çš„äº‹æƒ…ï¼Œç›´åˆ°æ»¡è¶³æŸä¸€ä¸ªé€€å‡ºæ¡ä»¶ï¼ˆå¦‚è¿­ä»£æ¬¡æ•°ï¼Œæœ‰ç”¨å·¥ä½œé‡ï¼Œæ¶ˆè€—çš„ç³»ç»Ÿæ—¶é—´ç­‰ç­‰ï¼‰ã€‚ä»¥ä¸‹æ˜¯GCæ—¥å¿—ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.777-0800: 5.069: [CMS-concurrent-abortable-preclean-start]<br>2021-07-15T01:04:08.777-0800: 5.069: <br>        [CMS-concurrent-abortable-preclean: 0.000/0.000 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs] <br></code></pre></td></tr></table></figure><p>è§£è¯»å¦‚ä¸‹ï¼š</p><blockquote><ol><li><code>CMS-concurrent-abortable-preclean</code> è¡¨æ˜æ­¤é˜¶æ®µçš„åç§°ï¼šConcurrent-Abortable-Precleanã€‚</li><li><code>0.000/0.000 secs</code> æ­¤é˜¶æ®µGCçº¿ç¨‹çš„è¿è¡Œæ—¶é—´å’Œå®é™…å ç”¨æ—¶é—´ï¼Œæœ¬è´¨ä¸Šæ¥è¯´ï¼ŒGCçº¿ç¨‹è¯•å›¾åœ¨æ‰§è¡ŒSTWæš‚åœä¹‹å‰ç­‰å¾…å°½å¯èƒ½é•¿çš„æ—¶é—´ï¼Œé»˜è®¤æ¡ä»¶ä¸‹ï¼Œæ­¤é˜¶æ®µå¯ä»¥æŒç»­æœ€é•¿5ç§’é’Ÿçš„æ—¶é—´ã€‚</li></ol></blockquote><p>æ­¤é˜¶æ®µå®Œæˆçš„å·¥ä½œå¯èƒ½å¯¹STWåœé¡¿æ—¶é—´æœ‰è¾ƒå¤§çš„å½±å“ï¼Œå¹¶ä¸”æœ‰è®¸å¤šçš„é‡è¦é…ç½®é€‰é¡¹å’Œå¤±è´¥æ¨¡å¼ã€‚</p><h5 id="é˜¶æ®µ5ï¼šFinal-Remarkï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰"><a href="#é˜¶æ®µ5ï¼šFinal-Remarkï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰" class="headerlink" title="é˜¶æ®µ5ï¼šFinal Remarkï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰"></a>é˜¶æ®µ5ï¼šFinal Remarkï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰</h5><p>æœ€ç»ˆæ ‡è®°æ˜¯æ­¤æ¬¡GCäº‹ä»¶ä¸­çš„ç¬¬äºŒæ¬¡ï¼ˆä¹Ÿæ˜¯æœ€åä¸€æ¬¡ï¼‰STWåœé¡¿ã€‚æœ¬é˜¶æ®µçš„ç›®æ ‡æ˜¯å®Œæˆè€å¹´ä»£çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„æ ‡è®°ã€‚å› ä¸ºä¹‹å‰çš„é¢„æ¸…ç†é˜¶æ®µæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œæœ‰å¯èƒ½GCçº¿ç¨‹è·Ÿä¸ä¸Šåº”ç”¨çº¿ç¨‹çš„ä¿®æ”¹é€Ÿåº¦ï¼Œæ‰€ä»¥éœ€è¦ä¸€æ¬¡STWæš‚åœæ¥å¤„ç†å„ç§å¤æ‚çš„æƒ…å†µã€‚é€šå¸¸CMSä¼šå°è¯•åœ¨å¹´è½»ä»£å°½å¯èƒ½ç©ºçš„æƒ…å†µä¸‹æ‰§è¡Œfinal remarké˜¶æ®µï¼Œä»¥é¿å…è¿ç»­è§¦å‘å¤šæ¬¡STWæ—¶é—´ã€‚ä»¥ä¸‹æ˜¯è¿™ä¸ªéƒ¨åˆ†çš„æ—¥å¿—ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [GC (CMS Final Remark) [YG occupancy: <span class="hljs-number">42054</span> K (<span class="hljs-number">157248</span> K)]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [Rescan (parallel) , <span class="hljs-number">0.0003608</span> secs]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [weak refs processing, <span class="hljs-number">0.0000184</span> secs]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">777-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">069</span>: [class unloading, <span class="hljs-number">0.0002228</span> secs]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">778-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">070</span>: [scrub symbol table, <span class="hljs-number">0.0003110</span> secs]<br><span class="hljs-number">2021</span>-<span class="hljs-number">07-15T01:04</span>:<span class="hljs-number">08</span>.<span class="hljs-number">778-0800</span>: <span class="hljs-number">5</span>.<span class="hljs-number">070</span>: [scrub string table, <span class="hljs-number">0.0002060</span> secs]<br>    [<span class="hljs-number">1</span> CMS-remark: <span class="hljs-number">349310</span>K(<span class="hljs-number">349568</span>K)] <span class="hljs-number">391364</span>K(<span class="hljs-number">506816</span>K), <span class="hljs-number">0.0012004</span> secs] <br>    [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">01</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br></code></pre></td></tr></table></figure><blockquote><ol><li><code>CMS Final Remark</code> è¿™æ˜¯æ­¤é˜¶æ®µçš„åç§°ï¼Œæœ€ç»ˆæ ‡è®°é˜¶æ®µã€‚ä¼šæ ‡è®°è€å¹´ä»£ä¸­æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ï¼ŒåŒ…æ‹¬æ­¤å‰çš„å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­åˆ›å»º/ä¿®æ”¹çš„å¼•ç”¨ã€‚</li><li><code>YG occupancy: 42054 K (157248 K)</code> å½“å‰å¹´è½»ä»£çš„ä½¿ç”¨é‡å’Œæ€»å®¹é‡ã€‚</li><li><code>[Rescan (parallel) , 0.0003608 secs]</code> åœ¨ç¨‹åºæš‚åœåè¿›è¡Œé‡æ–°æ‰«æï¼ˆRescanï¼‰ï¼Œä»¥å®Œæˆå­˜æ´»å¯¹è±¡çš„æ ‡è®°ï¼Œè¿™éƒ¨åˆ†æ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œæ¶ˆè€—çš„æ—¶é—´ä¸º<code>0.0003608 secs</code>ã€‚</li><li><code>[weak refs processing, 0.0000184 secs]</code>è¿™æ˜¯ç¬¬ä¸€ä¸ªå­é˜¶æ®µï¼šå¤„ç†å¼±å¼•ç”¨çš„æŒç»­æ—¶é—´ã€‚</li><li><code>class unloading, 0.0002228 secs</code> ç¬¬äºŒä¸ªå­é˜¶æ®µï¼šå¸è½½ä¸ä½¿ç”¨çš„ç±»ï¼Œä»¥åŠæŒç»­æ—¶é—´ã€‚</li><li><code>scrub symbol table, 0.0003110 secs</code> ç¬¬ä¸‰ä¸ªå­é˜¶æ®µï¼šæ¸…ç†ç¬¦å·è¡¨ï¼Œå³æŒæœ‰classçº§åˆ«metadata çš„ç¬¦å·è¡¨ï¼ˆsymbol tablesï¼‰ã€‚</li><li><code>scrub string table, 0.0002060 secs</code>ç¬¬å››ä¸ªå­é˜¶æ®µï¼šæ¸…ç†å†…è”çš„å­—ç¬¦ä¸²å¯¹åº”çš„String tablesã€‚</li><li><code>CMS-remark: 349310K(349568K)</code> æ­¤é˜¶æ®µå®Œæˆåè€å¹´ä»£çš„ä½¿ç”¨é‡å’Œæ€»å®¹é‡ã€‚</li><li><code>391364K(506816K), 0.0012004 secs</code> æ­¤é˜¶æ®µå®Œæˆåï¼Œæ•´ä¸ªå†…å­˜å †çš„ä½¿ç”¨é‡å’Œæ€»å®¹é‡ã€‚</li><li><code>[Times: user=0.01 sys=0.00, real=0.00 secs]</code> GCäº‹ä»¶çš„æŒç»­æ—¶é—´ã€‚</li></ol></blockquote><p>åœ¨è¿™5ä¸ªé˜¶æ®µå®Œæˆåï¼Œè€å¹´ä»£ä¸­çš„æ‰€æœ‰å¯¹è±¡éƒ½è¢«æ ‡è®°ä¸Šï¼Œæ¥ä¸‹æ¥JVMä¼šå°†æ‰€æœ‰ä¸ä½¿ç”¨çš„å¯¹è¥¿é‚£ä¸ªæ¸…é™¤ï¼Œä»¥å›æ”¶è€å¹´ä»£ç©ºé—´ã€‚</p><h5 id="é˜¶æ®µ6ï¼šConcurrent-Sweepï¼ˆå¹¶å‘æ¸…é™¤ï¼‰"><a href="#é˜¶æ®µ6ï¼šConcurrent-Sweepï¼ˆå¹¶å‘æ¸…é™¤ï¼‰" class="headerlink" title="é˜¶æ®µ6ï¼šConcurrent Sweepï¼ˆå¹¶å‘æ¸…é™¤ï¼‰"></a>é˜¶æ®µ6ï¼šConcurrent Sweepï¼ˆå¹¶å‘æ¸…é™¤ï¼‰</h5><p>è¿™ä¸ªé˜¶æ®µä¸åº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œä¸éœ€è¦STWåœé¡¿ï¼Œç›®çš„æ˜¯åˆ é™¤ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¹¶å›æ”¶ä»–ä»¬å ç”¨çš„ç©ºé—´ã€‚ä»¥ä¸‹æ˜¯è¿™éƒ¨åˆ†çš„GCæ—¥å¿—ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.778-0800: 5.070: [CMS-concurrent-sweep-start]<br>2021-07-15T01:04:08.779-0800: 5.071: <br>        [CMS-concurrent-sweep: 0.000/0.000 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs]<br></code></pre></td></tr></table></figure><p>ç®€å•è§£è¯»ï¼š</p><blockquote><ol><li><code>CMS-concurrent-sweep</code> è¿™æ˜¯è¿™ä¸ªé˜¶æ®µçš„åå­—â€œconcurrent-sweepâ€ï¼Œå¹¶å‘æ¸…é™¤è€å¹´ä»£ä¸­æ‰€æœ‰æœªè¢«æ ‡è®°çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œä»¥é‡Šæ”¾å†…å­˜ç©ºé—´ã€‚</li><li><code>0.000/0.000 secs</code> æ­¤é˜¶æ®µçš„æŒç»­æ—¶é—´å’Œå®é™…å ç”¨çš„æ—¶é—´ï¼Œè¿™æ˜¯ä¸€ä¸ªå››èˆäº”å…¥çš„å€¼ï¼Œåªç²¾ç¡®åˆ°å°æ•°ç‚¹å3ä½ã€‚</li></ol></blockquote><h5 id="é˜¶æ®µ7ï¼šConcurrent-Resetï¼ˆå¹¶å‘é‡ç½®ï¼‰"><a href="#é˜¶æ®µ7ï¼šConcurrent-Resetï¼ˆå¹¶å‘é‡ç½®ï¼‰" class="headerlink" title="é˜¶æ®µ7ï¼šConcurrent Resetï¼ˆå¹¶å‘é‡ç½®ï¼‰"></a>é˜¶æ®µ7ï¼šConcurrent Resetï¼ˆå¹¶å‘é‡ç½®ï¼‰</h5><p>æ­¤é˜¶æ®µä¸åº”ç”¨ç¨‹åºçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œé‡ç½®CMSç®—æ³•ç›¸å…³çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œä¸‹ä¸€æ¬¡è§¦å‘GCæ—¶å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚è¿™ä¸ªé˜¶æ®µçš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">2021-07-15T01:04:08.779-0800: 5.071: [CMS-concurrent-reset-start]<br>2021-07-15T01:04:08.779-0800: 5.071: <br>        [CMS-concurrent-reset: 0.000/0.000 secs] <br>    [Times: <span class="hljs-attribute">user</span>=0.00 <span class="hljs-attribute">sys</span>=0.00, <span class="hljs-attribute">real</span>=0.00 secs]<br></code></pre></td></tr></table></figure><p>ç®€å•è§£è¯»å¦‚ä¸‹ï¼š</p><blockquote><ol><li><code>CMS-concurrent-reset</code> æ­¤é˜¶æ®µçš„åç§°ï¼Œâ€œConcurrent Resetâ€ï¼Œé‡ç½®CMSç®—æ³•çš„å†…éƒ¨æ•°æ®ç»“æ„ï¼Œä¸ºä»¥ä¸‹æ­¤GCå¾ªç¯åšå‡†å¤‡ã€‚</li><li><code>0.000/0.000 secs</code> æ­¤é˜¶æ®µçš„æŒç»­æ—¶é—´å’Œå®é™…å ç”¨æ—¶é—´ã€‚</li></ol></blockquote><p>æ€»ä¹‹ï¼ŒCMSåƒåœ¾æ”¶é›†å™¨åœ¨å‡å°‘åœé¡¿æ—¶é—´ä¸Šåšå‡ºäº†å¾ˆå¤šç»™åŠ›çš„å·¥ä½œï¼Œå¾ˆå¤§ä¸€éƒ¨åˆ†GCçº¿ç¨‹ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘è¿è¡Œçš„ï¼Œä¸éœ€è¦æš‚åœåº”ç”¨çº¿ç¨‹ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹æ¯æ¬¡æš‚åœçš„æ—¶é—´è¾ƒå°‘ã€‚å½“ç„¶ï¼ŒCMSä¹Ÿæœ‰ä¸€äº›ç¼ºç‚¹ï¼Œå…¶ä¸­æœ€å¤§çš„é—®é¢˜å°±æ˜¯è€å¹´ä»£çš„å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œåœ¨æŸä¸ªæƒ…å†µä¸‹GCä¼šæœ‰ä¸å¯é¢„æµ‹çš„æš‚åœæ—¶é—´ï¼Œç‰¹åˆ«æ˜¯å †å†…å­˜æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ã€‚CMS çš„åŸç†ä¸è§£æå¯ä»¥çœ‹æˆ‘ä»¬å¤ä¹ æˆ‘ä»¬å‰é¢çš„åƒåœ¾æ”¶é›†å™¨(ä¸Š)ã€‚</p><h3 id="G1-æ—¥å¿—è§£è¯»"><a href="#G1-æ—¥å¿—è§£è¯»" class="headerlink" title="G1 æ—¥å¿—è§£è¯»"></a>G1 æ—¥å¿—è§£è¯»</h3><p>å¦‚æœå¯¹äºG1çš„åƒåœ¾æ”¶é›†å™¨çš„æ”¶é›†è¿‡ç¨‹å’ŒåŸç†ä¸ç†Ÿæ‚‰çš„åŒå­¦ä¹Ÿå¯ä»¥å¤ä¹ æˆ‘ä»¬å‰é¢æ€»ç»“çš„åƒåœ¾æ”¶é›†å™¨(ä¸Š)ã€‚ä½¿ç”¨å¦‚ä¸‹JVMå‚æ•°å¯åŠ¨ã€‚</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">-XX:+UseG1GC -Xloggc:gc.<span class="hljs-built_in">log</span> -XX:+PrintGCDetails -XX:+PrintGCDateStamps<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨GCåƒåœ¾æ”¶é›†å™¨æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æ—¥å¿—ï¼š</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><code class="hljs tcl">ava HotSpot(TM) <span class="hljs-number">64</span>-Bit Server VM (<span class="hljs-number">25.231</span>-b11) <span class="hljs-keyword">for</span> bsd-amd64 JRE (<span class="hljs-number">1.8</span><span class="hljs-number">.0</span>_231-b11), built on Oct  <span class="hljs-number">5</span> <span class="hljs-number">2019</span> <span class="hljs-number">03</span>:<span class="hljs-number">15</span>:<span class="hljs-number">25</span> by <span class="hljs-string">&quot;java_re&quot;</span> with gcc <span class="hljs-number">4.2</span><span class="hljs-number">.1</span> (Based on Apple Inc. build <span class="hljs-number">5658</span>) (LLVM build <span class="hljs-number">2336.11</span><span class="hljs-number">.00</span>)<br>Memory: <span class="hljs-number">4</span>k page, physical <span class="hljs-number">16777216</span>k(<span class="hljs-number">588376</span>k free)<br><br>/<span class="hljs-keyword">proc</span>/meminfo:<br><br>CommandLine<span class="hljs-title"> flags:</span> -XX:InitialHeapSize=536870912 -XX:MaxHeapSize=536870912 -XX:+PrintGC -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseG1GC <br>2021-07-21T00:45:17.323-0800: 0.077: [GC<span class="hljs-title"> pause</span> (G1<span class="hljs-title"> Evacuation</span> Pause) (young), 0.0035596<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Parallel<span class="hljs-title"> Time:</span> 2.8<span class="hljs-title"> ms,</span> GC<span class="hljs-title"> Workers:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Start (ms):<span class="hljs-title"> Min:</span> 77.4,<span class="hljs-title"> Avg:</span> 77.5,<span class="hljs-title"> Max:</span> 77.5,<span class="hljs-title"> Diff:</span> 0.1]<br>      [Ext<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.1,<span class="hljs-title"> Avg:</span> 0.2,<span class="hljs-title"> Max:</span> 0.8,<span class="hljs-title"> Diff:</span> 0.7,<span class="hljs-title"> Sum:</span> 1.8]<br>      [Update<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>         [Processed<span class="hljs-title"> Buffers:</span> Min: 0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0,<span class="hljs-title"> Diff:</span> 0,<span class="hljs-title"> Sum:</span> 0]<br>      [Scan<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Code<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Object<span class="hljs-title"> Copy</span> (ms):<span class="hljs-title"> Min:</span> 1.5,<span class="hljs-title"> Avg:</span> 1.7,<span class="hljs-title"> Max:</span> 1.8,<span class="hljs-title"> Diff:</span> 0.3,<span class="hljs-title"> Sum:</span> 13.5]<br>      [Termination (ms):<span class="hljs-title"> Min:</span> 0.3,<span class="hljs-title"> Avg:</span> 0.7,<span class="hljs-title"> Max:</span> 0.8,<span class="hljs-title"> Diff:</span> 0.4,<span class="hljs-title"> Sum:</span> 5.3]<br>         [Termination<span class="hljs-title"> Attempts:</span> Min: 1,<span class="hljs-title"> Avg:</span> 4.4,<span class="hljs-title"> Max:</span> 7,<span class="hljs-title"> Diff:</span> 6,<span class="hljs-title"> Sum:</span> 35]<br>      [GC<span class="hljs-title"> Worker</span> Other (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [GC<span class="hljs-title"> Worker</span> Total (ms):<span class="hljs-title"> Min:</span> 2.5,<span class="hljs-title"> Avg:</span> 2.6,<span class="hljs-title"> Max:</span> 2.7,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 20.8]<br>      [GC<span class="hljs-title"> Worker</span> End (ms):<span class="hljs-title"> Min:</span> 80.0,<span class="hljs-title"> Avg:</span> 80.0,<span class="hljs-title"> Max:</span> 80.2,<span class="hljs-title"> Diff:</span> 0.2]<br>   [Code<span class="hljs-title"> Root</span> Fixup: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Code<span class="hljs-title"> Root</span> Purge: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Clear<span class="hljs-title"> CT:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Other: 0.6<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Choose<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Proc:</span> 0.2<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Enq:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Redirty<span class="hljs-title"> Cards:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Register:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Reclaim:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Free<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Eden: 25.0M(25.0M)-&gt;0.0B(27.0M)<span class="hljs-title"> Survivors:</span> 0.0B-&gt;4096.0K<span class="hljs-title"> Heap:</span> 28.6M(512.0M)-&gt;8908.2K(512.0M)]<br> [Times:<span class="hljs-title"> user=0.01</span> sys=0.01,<span class="hljs-title"> real=0.00</span> secs] <br>......<br>2021-07-21T00:45:17.538-0800: 0.292: [GC<span class="hljs-title"> pause</span> (G1<span class="hljs-title"> Humongous</span> Allocation) (young) (initial-mark), 0.0044054<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Parallel<span class="hljs-title"> Time:</span> 4.0<span class="hljs-title"> ms,</span> GC<span class="hljs-title"> Workers:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Start (ms):<span class="hljs-title"> Min:</span> 292.0,<span class="hljs-title"> Avg:</span> 292.1,<span class="hljs-title"> Max:</span> 292.1,<span class="hljs-title"> Diff:</span> 0.1]<br>      [Ext<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 0.6]<br>      [Update<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.2]<br>         [Processed<span class="hljs-title"> Buffers:</span> Min: 1,<span class="hljs-title"> Avg:</span> 1.2,<span class="hljs-title"> Max:</span> 2,<span class="hljs-title"> Diff:</span> 1,<span class="hljs-title"> Sum:</span> 10]<br>      [Scan<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Code<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Object<span class="hljs-title"> Copy</span> (ms):<span class="hljs-title"> Min:</span> 3.6,<span class="hljs-title"> Avg:</span> 3.7,<span class="hljs-title"> Max:</span> 3.7,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 29.2]<br>      [Termination (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 0.6]<br>         [Termination<span class="hljs-title"> Attempts:</span> Min: 1,<span class="hljs-title"> Avg:</span> 1.0,<span class="hljs-title"> Max:</span> 1,<span class="hljs-title"> Diff:</span> 0,<span class="hljs-title"> Sum:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Other (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [GC<span class="hljs-title"> Worker</span> Total (ms):<span class="hljs-title"> Min:</span> 3.8,<span class="hljs-title"> Avg:</span> 3.8,<span class="hljs-title"> Max:</span> 3.9,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 30.8]<br>      [GC<span class="hljs-title"> Worker</span> End (ms):<span class="hljs-title"> Min:</span> 295.9,<span class="hljs-title"> Avg:</span> 295.9,<span class="hljs-title"> Max:</span> 296.0,<span class="hljs-title"> Diff:</span> 0.1]<br>   [Code<span class="hljs-title"> Root</span> Fixup: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Code<span class="hljs-title"> Root</span> Purge: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Clear<span class="hljs-title"> CT:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Other: 0.3<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Choose<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Proc:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Enq:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Redirty<span class="hljs-title"> Cards:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Register:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Reclaim:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Free<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Eden: 2048.0K(71.0M)-&gt;0.0B(116.0M)<span class="hljs-title"> Survivors:</span> 33.0M-&gt;1024.0K<span class="hljs-title"> Heap:</span> 307.5M(512.0M)-&gt;305.7M(512.0M)]<br> [Times:<span class="hljs-title"> user=0.02</span> sys=0.00,<span class="hljs-title"> real=0.01</span> secs] <br>2021-07-21T00:45:17.542-0800: 0.296: [GC<span class="hljs-title"> concurrent-root-region-scan-start]</span><br><span class="hljs-title">2021-07-21T00:45:17.542-0800:</span> 0.296: [GC<span class="hljs-title"> concurrent-root-region-scan-end,</span> 0.0000326<span class="hljs-title"> secs]</span><br><span class="hljs-title">2021-07-21T00:45:17.542-0800:</span> 0.296: [GC<span class="hljs-title"> concurrent-mark-start]</span><br><span class="hljs-title">2021-07-21T00:45:17.544-0800:</span> 0.298: [GC<span class="hljs-title"> concurrent-mark-end,</span> 0.0019507<span class="hljs-title"> secs]</span><br><span class="hljs-title">2021-07-21T00:45:17.544-0800:</span> 0.299: [GC<span class="hljs-title"> remark</span> 2021-07-21T00:45:17.544-0800: 0.299: [Finalize<span class="hljs-title"> Marking,</span> 0.0002050<span class="hljs-title"> secs]</span> 2021-07-21T00:45:17.544-0800: 0.299: [GC<span class="hljs-title"> ref-proc,</span> 0.0000344<span class="hljs-title"> secs]</span> 2021-07-21T00:45:17.544-0800: 0.299: [Unloading, 0.0003887<span class="hljs-title"> secs],</span> 0.0010297<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span> [Times:<span class="hljs-title"> user=0.00</span> sys=0.00,<span class="hljs-title"> real=0.00</span> secs] <br>2021-07-21T00:45:17.545-0800: 0.300: [GC<span class="hljs-title"> cleanup</span> 319M-&gt;319M(512M), 0.0007032<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span> [Times:<span class="hljs-title"> user=0.01</span> sys=0.00,<span class="hljs-title"> real=0.00</span> secs] <br>2021-07-21T00:45:17.569-0800: 0.323: [GC<span class="hljs-title"> pause</span> (G1<span class="hljs-title"> Evacuation</span> Pause) (young) (to-space<span class="hljs-title"> exhausted),</span> 0.0032034<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Parallel<span class="hljs-title"> Time:</span> 2.3<span class="hljs-title"> ms,</span> GC<span class="hljs-title"> Workers:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Start (ms):<span class="hljs-title"> Min:</span> 323.3,<span class="hljs-title"> Avg:</span> 323.4,<span class="hljs-title"> Max:</span> 323.4,<span class="hljs-title"> Diff:</span> 0.2]<br>      [Ext<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 0.7]<br>      [Update<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.1,<span class="hljs-title"> Avg:</span> 0.2,<span class="hljs-title"> Max:</span> 0.3,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 1.4]<br>         [Processed<span class="hljs-title"> Buffers:</span> Min: 0,<span class="hljs-title"> Avg:</span> 2.4,<span class="hljs-title"> Max:</span> 3,<span class="hljs-title"> Diff:</span> 3,<span class="hljs-title"> Sum:</span> 19]<br>      [Scan<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [Code<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Object<span class="hljs-title"> Copy</span> (ms):<span class="hljs-title"> Min:</span> 1.6,<span class="hljs-title"> Avg:</span> 1.8,<span class="hljs-title"> Max:</span> 1.8,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 14.3]<br>      [Termination (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.1,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 0.2]<br>         [Termination<span class="hljs-title"> Attempts:</span> Min: 1,<span class="hljs-title"> Avg:</span> 1.0,<span class="hljs-title"> Max:</span> 1,<span class="hljs-title"> Diff:</span> 0,<span class="hljs-title"> Sum:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Other (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [GC<span class="hljs-title"> Worker</span> Total (ms):<span class="hljs-title"> Min:</span> 2.0,<span class="hljs-title"> Avg:</span> 2.1,<span class="hljs-title"> Max:</span> 2.2,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 16.9]<br>      [GC<span class="hljs-title"> Worker</span> End (ms):<span class="hljs-title"> Min:</span> 325.5,<span class="hljs-title"> Avg:</span> 325.5,<span class="hljs-title"> Max:</span> 325.5,<span class="hljs-title"> Diff:</span> 0.0]<br>   [Code<span class="hljs-title"> Root</span> Fixup: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Code<span class="hljs-title"> Root</span> Purge: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Clear<span class="hljs-title"> CT:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Other: 0.8<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Evacuation<span class="hljs-title"> Failure:</span> 0.5<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Choose<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Proc:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Enq:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Redirty<span class="hljs-title"> Cards:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Register:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Reclaim:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Free<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Eden: 116.0M(116.0M)-&gt;0.0B(10.0M)<span class="hljs-title"> Survivors:</span> 1024.0K-&gt;15.0M<span class="hljs-title"> Heap:</span> 455.3M(512.0M)-&gt;412.4M(512.0M)]<br> [Times:<span class="hljs-title"> user=0.01</span> sys=0.01,<span class="hljs-title"> real=0.01</span> secs] <br>2021-07-21T00:45:17.574-0800: 0.328: [GC<span class="hljs-title"> pause</span> (G1<span class="hljs-title"> Evacuation</span> Pause) (mixed), 0.0028130<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Parallel<span class="hljs-title"> Time:</span> 2.4<span class="hljs-title"> ms,</span> GC<span class="hljs-title"> Workers:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Start (ms):<span class="hljs-title"> Min:</span> 328.6,<span class="hljs-title"> Avg:</span> 328.6,<span class="hljs-title"> Max:</span> 328.7,<span class="hljs-title"> Diff:</span> 0.1]<br>      [Ext<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.1,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 0.6]<br>      [Update<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.1,<span class="hljs-title"> Avg:</span> 0.2,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 1.3]<br>         [Processed<span class="hljs-title"> Buffers:</span> Min: 0,<span class="hljs-title"> Avg:</span> 2.2,<span class="hljs-title"> Max:</span> 3,<span class="hljs-title"> Diff:</span> 3,<span class="hljs-title"> Sum:</span> 18]<br>      [Scan<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [Code<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Object<span class="hljs-title"> Copy</span> (ms):<span class="hljs-title"> Min:</span> 1.9,<span class="hljs-title"> Avg:</span> 1.9,<span class="hljs-title"> Max:</span> 2.0,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 15.5]<br>      [Termination (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 0.7]<br>         [Termination<span class="hljs-title"> Attempts:</span> Min: 1,<span class="hljs-title"> Avg:</span> 1.0,<span class="hljs-title"> Max:</span> 1,<span class="hljs-title"> Diff:</span> 0,<span class="hljs-title"> Sum:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Other (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.1]<br>      [GC<span class="hljs-title"> Worker</span> Total (ms):<span class="hljs-title"> Min:</span> 2.2,<span class="hljs-title"> Avg:</span> 2.3,<span class="hljs-title"> Max:</span> 2.3,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 18.3]<br>      [GC<span class="hljs-title"> Worker</span> End (ms):<span class="hljs-title"> Min:</span> 330.9,<span class="hljs-title"> Avg:</span> 330.9,<span class="hljs-title"> Max:</span> 331.0,<span class="hljs-title"> Diff:</span> 0.1]<br>   [Code<span class="hljs-title"> Root</span> Fixup: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Code<span class="hljs-title"> Root</span> Purge: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Clear<span class="hljs-title"> CT:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Other: 0.3<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Choose<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Proc:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Enq:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Redirty<span class="hljs-title"> Cards:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Register:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Reclaim:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Free<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Eden: 10.0M(10.0M)-&gt;0.0B(21.0M)<span class="hljs-title"> Survivors:</span> 15.0M-&gt;4096.0K<span class="hljs-title"> Heap:</span> 425.6M(512.0M)-&gt;365.1M(512.0M)]<br> [Times:<span class="hljs-title"> user=0.01</span> sys=0.00,<span class="hljs-title"> real=0.00</span> secs] <br>......<br>021-07-21T00:45:22.278-0800: 5.032: [GC<span class="hljs-title"> pause</span> (G1<span class="hljs-title"> Evacuation</span> Pause) (young), 0.0006462<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Parallel<span class="hljs-title"> Time:</span> 0.3<span class="hljs-title"> ms,</span> GC<span class="hljs-title"> Workers:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Start (ms):<span class="hljs-title"> Min:</span> 5032.5,<span class="hljs-title"> Avg:</span> 5032.6,<span class="hljs-title"> Max:</span> 5032.6,<span class="hljs-title"> Diff:</span> 0.0]<br>      [Ext<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.1,<span class="hljs-title"> Avg:</span> 0.1,<span class="hljs-title"> Max:</span> 0.1,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.7]<br>      [Update<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.1,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 0.2]<br>         [Processed<span class="hljs-title"> Buffers:</span> Min: 0,<span class="hljs-title"> Avg:</span> 0.9,<span class="hljs-title"> Max:</span> 1,<span class="hljs-title"> Diff:</span> 1,<span class="hljs-title"> Sum:</span> 7]<br>      [Scan<span class="hljs-title"> RS</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Code<span class="hljs-title"> Root</span> Scanning (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Object<span class="hljs-title"> Copy</span> (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [Termination (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.2,<span class="hljs-title"> Max:</span> 0.2,<span class="hljs-title"> Diff:</span> 0.2,<span class="hljs-title"> Sum:</span> 1.3]<br>         [Termination<span class="hljs-title"> Attempts:</span> Min: 1,<span class="hljs-title"> Avg:</span> 1.0,<span class="hljs-title"> Max:</span> 1,<span class="hljs-title"> Diff:</span> 0,<span class="hljs-title"> Sum:</span> 8]<br>      [GC<span class="hljs-title"> Worker</span> Other (ms):<span class="hljs-title"> Min:</span> 0.0,<span class="hljs-title"> Avg:</span> 0.0,<span class="hljs-title"> Max:</span> 0.0,<span class="hljs-title"> Diff:</span> 0.0,<span class="hljs-title"> Sum:</span> 0.0]<br>      [GC<span class="hljs-title"> Worker</span> Total (ms):<span class="hljs-title"> Min:</span> 0.2,<span class="hljs-title"> Avg:</span> 0.3,<span class="hljs-title"> Max:</span> 0.3,<span class="hljs-title"> Diff:</span> 0.1,<span class="hljs-title"> Sum:</span> 2.3]<br>      [GC<span class="hljs-title"> Worker</span> End (ms):<span class="hljs-title"> Min:</span> 5032.8,<span class="hljs-title"> Avg:</span> 5032.8,<span class="hljs-title"> Max:</span> 5032.9,<span class="hljs-title"> Diff:</span> 0.1]<br>   [Code<span class="hljs-title"> Root</span> Fixup: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Code<span class="hljs-title"> Root</span> Purge: 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Clear<span class="hljs-title"> CT:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Other: 0.2<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Choose<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Proc:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Ref<span class="hljs-title"> Enq:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Redirty<span class="hljs-title"> Cards:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Register:</span> 0.1<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Humongous<span class="hljs-title"> Reclaim:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>      [Free<span class="hljs-title"> CSet:</span> 0.0<span class="hljs-title"> ms]</span><br><span class="hljs-title"></span>   [Eden: 0.0B(25.0M)-&gt;0.0B(25.0M)<span class="hljs-title"> Survivors:</span> 0.0B-&gt;0.0B<span class="hljs-title"> Heap:</span> 405.6M(512.0M)-&gt;405.6M(512.0M)]<br> [Times:<span class="hljs-title"> user=0.00</span> sys=0.00,<span class="hljs-title"> real=0.00</span> secs] <br>2021-07-21T00:45:22.279-0800: 5.033: [Full<span class="hljs-title"> GC</span> (Allocation<span class="hljs-title"> Failure)</span>  405M-&gt;378M(512M), 0.0339622<span class="hljs-title"> secs]</span><br><span class="hljs-title"></span>   [Eden: 0.0B(25.0M)-&gt;0.0B(25.0M)<span class="hljs-title"> Survivors:</span> 0.0B-&gt;0.0B<span class="hljs-title"> Heap:</span> 405.6M(512.0M)-&gt;378.8M(512.0M)], [Metaspace: 2565K-&gt;2565K(1056768K)]<br> [Times:<span class="hljs-title"> user=0.03</span> sys=0.00,<span class="hljs-title"> real=0.04</span> secs] <br>2021-07-21T00:45:22.313-0800: 5.067: [GC<span class="hljs-title"> concurrent-mark-abort]</span><br><span class="hljs-title">Heap</span><br><span class="hljs-title"></span> garbage-first<span class="hljs-title"> heap</span> <span class="hljs-title">  total</span> 524288K,<span class="hljs-title"> used</span> 387912K [0x00000007a0000000, 0x00000007a0101000, 0x00000007c0000000)<br><span class="hljs-title">  region</span> size 1024K, 1<span class="hljs-title"> young</span> (1024K), 0<span class="hljs-title"> survivors</span> (0K)<br><span class="hljs-title"> Metaspace</span> <span class="hljs-title">      used</span> 2571K,<span class="hljs-title"> capacity</span> 4486K,<span class="hljs-title"> committed</span> 4864K,<span class="hljs-title"> reserved</span> 1056768K<br><span class="hljs-title">  class</span> space<span class="hljs-title">    used</span> 276K,<span class="hljs-title"> capacity</span> 386K,<span class="hljs-title"> committed</span> 512K,<span class="hljs-title"> reserved</span> 1048576K<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šæ˜¯ä¸€éƒ¨åˆ†G1çš„GCæ—¥å¿—ä¿¡æ¯ï¼Œå®é™…ä¸Šæˆ‘ä»¬ç¨‹åºè¿è¡Œäº†å‡ ç§’ä¸­å´ç”Ÿæˆäº†1MBå¤šçš„æ—¥å¿—æ•°æ®ï¼Œç”±æ­¤å¯è§G1è¾“å‡ºçš„æ—¥å¿—çœŸçš„å¾ˆå¤šã€‚å…¶ä¸­æˆ‘ä»¬ä¸»è¦èƒ½çœ‹åˆ°ä»¥ä¸‹å‡ ç§GCç±»å‹ã€‚</p><h4 id="Evacuation-Pauseï¼šyoungï¼ˆçº¯å¹´è½»ä»£æ¨¡å¼è½¬ç§»æš‚åœï¼‰"><a href="#Evacuation-Pauseï¼šyoungï¼ˆçº¯å¹´è½»ä»£æ¨¡å¼è½¬ç§»æš‚åœï¼‰" class="headerlink" title="Evacuation Pauseï¼šyoungï¼ˆçº¯å¹´è½»ä»£æ¨¡å¼è½¬ç§»æš‚åœï¼‰"></a>Evacuation Pauseï¼šyoungï¼ˆçº¯å¹´è½»ä»£æ¨¡å¼è½¬ç§»æš‚åœï¼‰</h4><p>å½“å¹´è½»ä»£ç©ºé—´ç”¨æ»¡åï¼Œåº”ç”¨çº¿ç¨‹ä¼šè¢«æš‚åœï¼Œå¹´è½»ä»£å†…å­˜å—ä¸­çš„å­˜æ´»å¯¹è±¡è¢«æ‹·è´åˆ°å­˜æ´»åŒºã€‚å¦‚æœè¿˜æ²¡æœ‰å­˜æ´»åŒºï¼Œåˆ™ä»»æ„é€‰æ‹©ä¸€éƒ¨åˆ†ç©ºé—²å†…å­˜å—ä½œä¸ºå­˜æ´»åŒºã€‚æ‹·è´çš„è¿‡ç¨‹è¢«ç§°ä¸ºè½¬ç§»ï¼ˆEvacuationï¼‰ï¼Œè¿™å’Œå‰é¢ä»‹ç»çš„å…¶ä»–å¹´è½»ä»£æ”¶é›†å™¨æ˜¯ä¸€æ ·çš„å·¥ä½œåŸç†ã€‚ç”±äºæ—¥å¿—è®°å½•éå¸¸å¤šï¼Œæ‰€ä»¥å¹¶è¡Œé˜¶æ®µå’Œâ€œå…¶ä»–â€é˜¶æ®µçš„æ—¥å¿—å°†æ‹†åˆ†å¤šä¸ªéƒ¨åˆ†è§£æã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">2021-07-21T00:45:17.323-0800: 0.077:</span> [<span class="hljs-string">GC</span> <span class="hljs-string">pause</span> <span class="hljs-string">(G1</span> <span class="hljs-string">Evacuation</span> <span class="hljs-string">Pause)</span> <span class="hljs-string">(young)</span>, <span class="hljs-number">0.0035596</span> <span class="hljs-string">secs</span>]<br>   [<span class="hljs-attr">Parallel Time:</span> <span class="hljs-number">2.8</span> <span class="hljs-string">ms</span>, <span class="hljs-attr">GC Workers:</span> <span class="hljs-number">8</span>]<br>      <span class="hljs-string">...GC</span> <span class="hljs-string">work</span> <span class="hljs-string">thread</span><br>   [<span class="hljs-attr">Code Root Fixup:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Code Root Purge:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Clear CT:</span> <span class="hljs-number">0.1</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Other:</span> <span class="hljs-number">0.6</span> <span class="hljs-string">ms</span>]<br>        <span class="hljs-string">...other</span> <span class="hljs-string">job</span><br>   [<span class="hljs-attr">Eden:</span> <span class="hljs-number">25.</span><span class="hljs-string">0M(25.0M)-&gt;0.0B(27.0M)</span> <span class="hljs-attr">Survivors:</span> <span class="hljs-number">0.</span><span class="hljs-string">0B-&gt;4096.0K</span> <span class="hljs-attr">Heap:</span> <span class="hljs-number">28.</span><span class="hljs-string">6M(512.0M)-&gt;8908.2K(512.0M)</span>]<br> [<span class="hljs-attr">Times:</span> <span class="hljs-string">user=0.01</span> <span class="hljs-string">sys=0.01</span>, <span class="hljs-string">real=0.00</span> <span class="hljs-string">secs</span>] <br></code></pre></td></tr></table></figure><blockquote><p>æ—¥å¿—åˆ†æå¦‚ä¸‹ï¼š</p><ol><li><code>[GC pause (G1 Evacuation Pause) (young), 0.0035596 secs]</code> G1è½¬ç§»æš‚åœï¼Œçº¯å¹´è½»ä»£æ¨¡å¼ï¼šåªæ¸…ç†å¹´è½»ç©ºé—´ã€‚è¿™æ¬¡æš‚åœåœ¨JVMå¯åŠ¨ä¹‹å77mså¼€å§‹ï¼ŒæŒç»­çš„ç³»ç»Ÿæ—¶é—´ä¸ºï¼š<code>0.0035596 secs</code>ï¼Œä¹Ÿå°±æ˜¯<code>3.5ms</code>ã€‚</li><li><code>[Parallel Time: 2.8 ms, GC Workers: 8]</code> è¡¨æ˜åé¢çš„æ´»åŠ¨ç”±8ä¸ªWorker çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¶ˆè€—æ—¶é—´ä¸º<code>2.8ms</code>ï¼ˆreal timeï¼‰ï¼›<code>worker</code>æ˜¯ä¸€ç§æ¨¡å¼ï¼Œç±»ä¼¼äºä¸€ä¸ªè€æ¿æŒ‡æŒ¥å¤šä¸ªå·¥äººå¹²æ´»ï¼Œç±»ä¼¼ä¸Nettyçš„ BossGroup å’Œ WorkerGroupã€‚</li><li><code>[Code Root Fixup: 0.0 ms]</code> é‡Šæ”¾ç”¨äºç®¡ç†å¹¶è¡Œæ´»åŠ¨çš„å†…éƒ¨æ•°æ®ï¼Œä¸€èˆ¬éƒ½æ¥è¿‘äºé›¶ã€‚è¿™ä¸ªè¿‡ç¨‹æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ã€‚</li><li><code>[Code Root Purge: 0.0 ms]</code> æ¸…ç†å…¶ä»–éƒ¨åˆ†æ•°æ®ï¼Œä¹Ÿæ˜¯éå¸¸å¿«çš„ï¼Œå¦‚éå¿…è¦åŸºæœ¬ä¸Šç­‰äºé›¶ï¼Œä¹Ÿæ˜¯ä¸²è¡Œçš„æ‰§è¡Œçš„è¿‡ç¨‹ã€‚</li><li><code>[Other: 0.6 ms]</code> å…¶ä»–æ´»åŠ¨æ¶ˆè€—çš„æ—¶é—´ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å¹¶è¡Œçš„ã€‚</li><li><code>[Eden: 25.0M(25.0M)-&gt;0.0B(27.0M)</code> æš‚åœä¹‹å‰å’Œæš‚åœä¹‹åï¼ŒEdenåŒºçš„ä½¿ç”¨é‡/æ€»å®¹é‡ã€‚</li><li><code>Survivors: 0.0B-&gt;4096.0K</code> GCæš‚åœå‰åï¼Œå­˜æ´»åŒºçš„ä½¿ç”¨é‡ã€‚<code>Heap: 28.6M(512.0M)-&gt;8908.2K(512.0M)]</code> æš‚åœå‰åæ•´ä¸ªå †å†…å­˜çš„ä½¿ç”¨é‡å’Œæ€»å®¹é‡ã€‚</li><li><code>[Times: user=0.01 sys=0.01, real=0.00 secs]</code> GCäº‹ä»¶çš„æŒç»­äº‹ä»¶ã€‚</li></ol><p>ç³»ç»Ÿäº‹ä»¶ï¼ˆwall clock time/elapsed timeï¼‰ï¼Œæ˜¯æŒ‡ä¸€æ®µç¨‹åºä»è¿è¡Œåˆ°ç»ˆæ­¢ï¼Œç³»ç»Ÿæ—¶é’Ÿèµ°è¿‡çš„æ—¶é—´ï¼Œä¸€èˆ¬ç³»ç»Ÿæ—¶é—´æ¯”CPUæ—¶é—´ç•¥å¾®é•¿ä¸€ç‚¹ã€‚</p></blockquote><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">[Parallel Time: <span class="hljs-number">2.3</span> ms, GC Workers: <span class="hljs-number">8</span>]<br>[GC Worker Start (ms): Min: <span class="hljs-number">323.3</span>, Avg: <span class="hljs-number">323.4</span>, Max: <span class="hljs-number">323.4</span>, Diff: <span class="hljs-number">0.2</span>]<br>[Ext Root Scanning (ms): Min: <span class="hljs-number">0.0</span>, Avg: <span class="hljs-number">0.1</span>, Max: <span class="hljs-number">0.2</span>, Diff: <span class="hljs-number">0.2</span>, Sum: <span class="hljs-number">0.7</span>]<br>[Update RS (ms): Min: <span class="hljs-number">0.1</span>, Avg: <span class="hljs-number">0.2</span>, Max: <span class="hljs-number">0.3</span>, Diff: <span class="hljs-number">0.2</span>, Sum: <span class="hljs-number">1.4</span>]<br>[Processed Buffers: Min: <span class="hljs-number">0</span>, Avg: <span class="hljs-number">2.4</span>, Max: <span class="hljs-number">3</span>, Diff: <span class="hljs-number">3</span>, Sum: <span class="hljs-number">19</span>]<br>[Scan RS (ms): Min: <span class="hljs-number">0.0</span>, Avg: <span class="hljs-number">0.0</span>, Max: <span class="hljs-number">0.0</span>, Diff: <span class="hljs-number">0.0</span>, Sum: <span class="hljs-number">0.1</span>]<br>[Code Root Scanning (ms): Min: <span class="hljs-number">0.0</span>, Avg: <span class="hljs-number">0.0</span>, Max: <span class="hljs-number">0.0</span>, Diff: <span class="hljs-number">0.0</span>, Sum: <span class="hljs-number">0.0</span>]<br>[Object Copy (ms): Min: <span class="hljs-number">1.6</span>, Avg: <span class="hljs-number">1.8</span>, Max: <span class="hljs-number">1.8</span>, Diff: <span class="hljs-number">0.2</span>, Sum: <span class="hljs-number">14.3</span>]<br>[Termination (ms): Min: <span class="hljs-number">0.0</span>, Avg: <span class="hljs-number">0.0</span>, Max: <span class="hljs-number">0.1</span>, Diff: <span class="hljs-number">0.1</span>, Sum: <span class="hljs-number">0.2</span>]<br>[Termination Attempts: Min: <span class="hljs-number">1</span>, Avg: <span class="hljs-number">1.0</span>, Max: <span class="hljs-number">1</span>, Diff: <span class="hljs-number">0</span>, Sum: <span class="hljs-number">8</span>]<br>[GC Worker Other (ms): Min: <span class="hljs-number">0.0</span>, Avg: <span class="hljs-number">0.0</span>, Max: <span class="hljs-number">0.0</span>, Diff: <span class="hljs-number">0.0</span>, Sum: <span class="hljs-number">0.1</span>]<br>[GC Worker Total (ms): Min: <span class="hljs-number">2.0</span>, Avg: <span class="hljs-number">2.1</span>, Max: <span class="hljs-number">2.2</span>, Diff: <span class="hljs-number">0.2</span>, Sum: <span class="hljs-number">16.9</span>]<br>[GC Worker End (ms): Min: <span class="hljs-number">325.5</span>, Avg: <span class="hljs-number">325.5</span>, Max: <span class="hljs-number">325.5</span>, Diff: <span class="hljs-number">0.0</span>]<br></code></pre></td></tr></table></figure><blockquote><p>ä¸Šé¢è¿™æ®µæ—¥å¿—æ˜¯çœç•¥çš„å·¥ä½œçº¿ç¨‹çš„æ—¥å¿—ä¿¡æ¯ï¼Œç®€å•çš„è§£è¯»å¦‚ä¸‹ï¼š</p><ol><li><code>[Parallel Time: 2.3 ms, GC Workers: 8]</code> å‰é¢ä»‹ç»è¿‡ï¼Œè¿™è¡¨æ˜ä¸‹åˆ—æ´»åŠ¨ç”±8ä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œï¼Œæ¶ˆè€—çš„æ—¶é—´ä¸º2.3ms(real time)ã€‚</li><li><code>GC Worker Start(ms)</code> GCçš„workerçº¿ç¨‹å¼€å§‹å¯åŠ¨æ—¶ï¼Œç›¸å½“äº pause å¼€å§‹æ—¶é—´çš„æ¯«ç§’é—´éš”ï¼Œå¦‚æœ<code>Min</code>å’Œ<code>Max</code>å·®åˆ«å¾ˆå¤§ï¼Œåˆ™è¡¨æ˜æœ¬æœºå…¶ä»–è¿›ç¨‹æ‰€ä½¿ç”¨çš„çº¿ç¨‹æ•°é‡è¿‡å¤šï¼ŒæŒ¤å äº†GCçš„å¯ç”¨CPUæ—¶é—´ã€‚</li><li><code>Ext Root Scanning(ms)</code> ç”¨äº†å¤šé•¿æ—¶é—´æ¥æ‰«æå †å¤–å†…å­˜(non-heap) çš„GC ROOTï¼Œå¦‚classloaderï¼ŒJNIå¼•ç”¨ï¼ŒJVMç³»ç»ŸROOTç­‰ã€‚åé¢æ˜¾ç¤ºäº†è¿è¡Œæ—¶é—´ï¼Œâ€œSumâ€æŒ‡çš„æ˜¯CPUæ—¶é—´ã€‚</li><li><code>Update RS</code>ï¼Œ<code>Processed Buffers</code>ï¼Œ<code>Scan RS</code>è¿™ä¸‰éƒ¨åˆ†ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œ<code>RS</code>æ˜¯<code>Remember Set</code>çš„ç¼©å†™ã€‚</li><li><code>Code Root Scanning(ms)</code> æ‰«æå®é™…ä»£ç ä¸­çš„ root ç”¨äº†å¤šé•¿æ—¶é—´ï¼šä¾‹å¦‚çº¿ç¨‹æ ˆä¸­çš„å±€éƒ¨å˜é‡ã€‚</li><li><code>Object Copy(ms)</code> ç”¨äº†å¤šé•¿æ—¶é—´æ¥æ‹·è´å›æ”¶é›†ä¸­çš„å­˜æ´»å¯¹è±¡ã€‚</li><li><code>Tremination(ms)</code> GC çš„workerçº¿ç¨‹ç”¨äº†å¤šé•¿æ—¶é—´æ¥ç¡®ä¿è‡ªèº«å¯ä»¥å®‰å…¨åœ°åœæ­¢ï¼Œè¿™æ®µæ—¶é—´å†…ä»€ä¹ˆéƒ½ä¸åšï¼Œå®ŒæˆåGCçº¿ç¨‹å°±ç»ˆæ­¢äº†ï¼Œæ‰€ä»¥å«ç»ˆæ­¢ç­‰å¾…ã€‚</li><li><code>Termination Attempts</code> GCçš„ woker çº¿ç¨‹å°è¯•å¤šå°‘æ¬¡ try å’Œ teminateã€‚å¦‚æœ worker å‘ç°è¿˜æœ‰ä¸€äº›ä»»åŠ¡æ²¡æœ‰å¤„ç†å®Œï¼Œåˆ™è¿™ä¸€æ¬¡å°è¯•å°±æ˜¯å¤±è´¥çš„ï¼Œæš‚æ—¶è¿˜ä¸èƒ½ç»ˆæ­¢ã€‚</li><li><code>GC Worker Other (ms)</code> å…¶ä»–çš„ä¸€äº›å°ä»»åŠ¡ï¼Œå› ä¸ºæ—¶é—´å¾ˆçŸ­ï¼Œåœ¨GCæ—¥å¿—å°†ä»–ä»¬å½’ç»“åœ¨ä¸€èµ·ã€‚</li><li><code>GC Worker Total (ms)</code> GCçš„workerçº¿ç¨‹å·¥ä½œæ€»è®¡ã€‚</li><li><code>GC Worker End (ms)</code> GCçš„workerçº¿ç¨‹å®Œæˆä½œä¸šçš„æ—¶åˆ»ï¼Œç›¸å¯¹äºæ­¤æ¬¡GCæš‚åœå¼€å§‹æ—¶é—´çš„æ¯«ç§’æ•°ã€‚é€šå¸¸æ¥è¯´è¿™éƒ¨åˆ†æ•°å­—åº”è¯¥å¤§è‡´ç›¸ç­‰ï¼Œå¦åˆ™å°±è¯´æ˜æœ‰å¤ªå¤šçš„çº¿ç¨‹è¢«æŒ‚èµ·ã€‚</li></ol></blockquote><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨è½¬ç§»æš‚åœæœŸé—´è¿˜æœ‰ä¸€äº›çç¢çš„å°ä»»åŠ¡ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs json">[Other: <span class="hljs-number">0.6</span> ms]<br>  [Choose CSet: <span class="hljs-number">0.0</span> ms]<br>  [Ref Proc: <span class="hljs-number">0.2</span> ms]<br>  [Ref Enq: <span class="hljs-number">0.0</span> ms]<br>  [Redirty Cards: <span class="hljs-number">0.1</span> ms]<br>  [Humongous Register: <span class="hljs-number">0.0</span> ms]<br>  [Humongous Reclaim: <span class="hljs-number">0.0</span> ms]<br>  [Free CSet: <span class="hljs-number">0.0</span> ms]<br></code></pre></td></tr></table></figure><blockquote><p>å…¶ä»–çç¢ä»»åŠ¡ï¼Œè¿™é‡Œåªä»‹ç»å…¶ä¸­ä¸€éƒ¨åˆ†ï¼š</p><ol><li><code>[Other: 0.6 ms]</code> å…¶ä»–æ´»åŠ¨æ¶ˆè€—çš„æ—¶é—´ï¼Œå…¶ä¸­å¾ˆå¤šæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚</li><li><code>[Choose CSet: 0.0 ms]</code> é€‰æ‹©CSetæ¶ˆè€—çš„æ—¶é—´ï¼ŒCSet æ˜¯Colletion Set çš„ç¼©å†™ã€‚</li><li><code>[Ref Proc: 0.2 ms]</code> å¤„ç†éå¼ºå¼•ç”¨ï¼ˆnon-strongï¼‰çš„æ—¶é—´ï¼šè¿›è¡Œæ¸…ç†æˆ–è€…å†³å®šæ˜¯å¦éœ€è¦æ¸…ç†ã€‚</li><li><code>[Ref Enq: 0.0 ms]</code> ç”¨æ¥å°†å‰©ä¸‹çš„ non-strong å¼•ç”¨æ’åºåˆ°åˆé€‚çš„ <code>ReferenceQueue</code> ä¸­ã€‚</li><li><code>[Humongous Register: 0.0 ms]</code>ï¼Œ<code>[Humongous Reclaim: 0.0 ms]</code> å¤§å¯¹è±¡ç›¸å…³éƒ¨åˆ†ã€‚</li><li><code>[Free CSet: 0.0 ms]</code> å°†å›æ”¶é›†ä¸­è¢«é‡Šæ”¾çš„å°å †å½’è¿˜æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œä»¥ä¾¿ç»™ä»–ä»¬èƒ½ç”¨æ¥åˆ†é…æ–°å¯¹è±¡ã€‚</li></ol></blockquote><h4 id="Concurrent-Markingï¼ˆå¹¶å‘æ ‡è®°ï¼‰"><a href="#Concurrent-Markingï¼ˆå¹¶å‘æ ‡è®°ï¼‰" class="headerlink" title="Concurrent Markingï¼ˆå¹¶å‘æ ‡è®°ï¼‰"></a>Concurrent Markingï¼ˆå¹¶å‘æ ‡è®°ï¼‰</h4><p>å½“å †å†…å­˜çš„æ€»ä½“ä½¿ç”¨è¾¾åˆ°ä¸€å®šçš„æ•°å€¼æ—¶ï¼Œå°±ä¼šè§¦å‘å¹¶å‘æ ‡è®°ã€‚è¿™ä¸ªé»˜è®¤æ¯”ä¾‹<code>æ˜¯45%</code>ï¼Œä½†ä¹Ÿå¯ä»¥é€šè¿‡JVMå‚æ•°<code>InitialtingHeapOccupancyPercent</code> æ¥è®¾ç½®ã€‚å’ŒCMSä¸€æ ·ï¼ŒG1çš„å¹¶å‘æ ‡è®°ä¹Ÿæ˜¯ç”±å¤šä¸ªé˜¶æ®µç»„æˆï¼Œå…¶ä¸­ä¸€äº›é˜¶æ®µæ˜¯å®Œæˆå¹¶å‘çš„ï¼Œè¿˜æœ‰ä¸€äº›é˜¶æ®µåˆ™ä¼šæš‚åœåº”ç”¨çº¿ç¨‹ã€‚å¦‚ä¸‹æ˜¯å¹¶å‘æ ‡è®°çš„æ—¥å¿—ä¿¡æ¯ï¼š</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs subunit">2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.538<span class="hljs-string">-0800</span>: 0.292: [GC pause (G1 Humongous Allocation) (young) (initial-mark), 0.0044054 secs]<br>   ...<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: [GC concurrent-root-region-scan-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: [GC concurrent-root-region-scan-end, 0.0000326 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: [GC concurrent-mark-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.298: [GC concurrent-mark-end, 0.0019507 secs]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.299: [GC remark 2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.299: [Finalize Marking, 0.0002050 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.299: [GC ref-proc, 0.0000344 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.299: [Unloading, 0.0003887 secs], 0.0010297 secs]<br> [Times: user=0.00 sys=0.00, real=0.00 secs] <br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.545<span class="hljs-string">-0800</span>: 0.300: [GC cleanup 319M-&gt;319M(512M), 0.0007032 secs]<br> [Times: user=0.01 sys=0.00, real=0.00 secs] <br></code></pre></td></tr></table></figure><h5 id="é˜¶æ®µ1ï¼šInitial-Markï¼ˆåˆå§‹æ ‡è®°ï¼‰-1"><a href="#é˜¶æ®µ1ï¼šInitial-Markï¼ˆåˆå§‹æ ‡è®°ï¼‰-1" class="headerlink" title="é˜¶æ®µ1ï¼šInitial Markï¼ˆåˆå§‹æ ‡è®°ï¼‰"></a>é˜¶æ®µ1ï¼šInitial Markï¼ˆåˆå§‹æ ‡è®°ï¼‰</h5><p>ä»¥ä¸‹æ˜¯è¿™æ¬¡GCäº‹ä»¶çš„å¼€å§‹ï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°è¿™æ˜¯å› ä¸ºå¤§å¯¹è±¡çš„åˆ†é…å¯¼è‡´çš„GCã€‚åˆå§‹æ ‡è®°æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">2021</span>-<span class="hljs-number">07-21T00:45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">538-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">292</span>: <br>        [GC pause (G1 Humongous Allocation) (young) (initial-mark), <span class="hljs-number">0.0044054</span> secs]<br></code></pre></td></tr></table></figure><h5 id="é˜¶æ®µ2ï¼šRoot-Region-Scanï¼ˆRootåŒºæ‰«æï¼‰"><a href="#é˜¶æ®µ2ï¼šRoot-Region-Scanï¼ˆRootåŒºæ‰«æï¼‰" class="headerlink" title="é˜¶æ®µ2ï¼šRoot Region Scanï¼ˆRootåŒºæ‰«æï¼‰"></a>é˜¶æ®µ2ï¼šRoot Region Scanï¼ˆRootåŒºæ‰«æï¼‰</h5><p>æ­¤é˜¶æ®µä»Rootå¼€å§‹æ ‡è®°æ‰«æå¯è¾¾å¯¹è±¡ã€‚ä»¥ä¸‹æ˜¯å¯¹åº”çš„æ—¥å¿—ä¿¡æ¯ã€‚</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: <br>        [GC concurrent-root-region-scan-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: <br>        [GC concurrent-root-region-scan-end, 0.0000326 secs]<br></code></pre></td></tr></table></figure><h5 id="é˜¶æ®µ3ï¼šConcurrent-Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰"><a href="#é˜¶æ®µ3ï¼šConcurrent-Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šConcurrent Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰"></a>é˜¶æ®µ3ï¼šConcurrent Markï¼ˆå¹¶å‘æ ‡è®°ï¼‰</h5><p>ä»¥ä¸‹æ˜¯å¹¶å‘æ ‡è®°é˜¶æ®µçš„æ—¥å¿—è¾“å‡ºã€‚</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs subunit">2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.542<span class="hljs-string">-0800</span>: 0.296: <br>        [GC concurrent-mark-start]<br>2021<span class="hljs-string">-07</span><span class="hljs-string">-21</span>T00:45:17.544<span class="hljs-string">-0800</span>: 0.298: <br>        [GC concurrent-mark-end, 0.0019507 secs]<br></code></pre></td></tr></table></figure><h5 id="é˜¶æ®µ4ï¼šFinal-markï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰"><a href="#é˜¶æ®µ4ï¼šFinal-markï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰" class="headerlink" title="é˜¶æ®µ4ï¼šFinal markï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰"></a>é˜¶æ®µ4ï¼šFinal markï¼ˆæœ€ç»ˆæ ‡è®°ï¼‰</h5><p>å¯¹åº”çš„æ—¥å¿—ä¿¡æ¯ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">2021</span>-<span class="hljs-number">07-21T00:45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">544-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">299</span>: <br>    [GC remark <br>    <span class="hljs-number">2021</span>-<span class="hljs-number">07-21T00:45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">544-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">299</span>: <br>    [Finalize Marking, <span class="hljs-number">0.0002050</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-21T00:45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">544-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">299</span>: <br>    [GC ref-proc, <span class="hljs-number">0.0000344</span> secs] <br><span class="hljs-number">2021</span>-<span class="hljs-number">07-21T00:45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">544-0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">299</span>: <br>    [Unloading, <span class="hljs-number">0.0003887</span> secs], <span class="hljs-number">0.0010297</span> secs]<br> [Times: user=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> sys=<span class="hljs-number">0</span>.<span class="hljs-number">00</span>, real=<span class="hljs-number">0</span>.<span class="hljs-number">00</span> secs] <br></code></pre></td></tr></table></figure><h5 id="é˜¶æ®µ5ï¼šCleanupï¼ˆæ¸…ç†ï¼‰"><a href="#é˜¶æ®µ5ï¼šCleanupï¼ˆæ¸…ç†ï¼‰" class="headerlink" title="é˜¶æ®µ5ï¼šCleanupï¼ˆæ¸…ç†ï¼‰"></a>é˜¶æ®µ5ï¼šCleanupï¼ˆæ¸…ç†ï¼‰</h5><p>æœ€åè¿™ä¸ªæ¸…ç†é˜¶æ®µä¸ºå³å°†åˆ°æ¥çš„è½¬ç§»é˜¶æ®µä½œå‡†å¤‡ï¼Œç»Ÿè®¡å°å †å—ä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œå¹¶å°†å°å †å—è¿›è¡Œæ’åºï¼Œä»¥æé«˜GCæ•ˆç‡ã€‚è¿™ä¸ªé˜¶æ®µä¹Ÿä¸ºä¸‹ä¸€æ¬¡æ ‡è®°æ‰§è¡Œå¿…éœ€çš„æ‰€æœ‰æ•´ç†å·¥ä½œ(house-keeping activites)ï¼šç»´æŠ¤å¹¶å‘æ ‡è®°çš„å†…éƒ¨çŠ¶æ€ã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰åŒ…æ‹¬å­˜æ´»å¯¹è±¡çš„å°å †å—åœ¨æ­¤é˜¶æ®µéƒ½è¢«å›æ”¶äº†ã€‚æœ‰ä¸€éƒ¨åˆ†ä»»åŠ¡æ˜¯å¹¶å‘çš„ï¼Œä¾‹å¦‚ç©ºå †åŒºçš„å›æ”¶ï¼Œè¿˜æœ‰å¤§éƒ¨åˆ†çš„å­˜æ´»ç‡è®¡ç®—ï¼Œæ­¤é˜¶æ®µä¹Ÿéœ€è¦ä¸€ä¸ªçŸ­æš‚çš„STWï¼Œæ‰èƒ½ä¸å—åº”ç”¨çº¿ç¨‹çš„å½±å“å¹¶å®Œæˆä½œä¸šï¼Œå¯¹åº”æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">21</span>T<span class="hljs-number">00</span>:<span class="hljs-number">45</span>:<span class="hljs-number">17</span>.<span class="hljs-number">545</span>-<span class="hljs-number">0800</span>: <span class="hljs-number">0</span>.<span class="hljs-number">300</span>:<span class="hljs-meta"> [GC cleanup 319M-&gt;319M(512M), 0.0007032 secs]</span><br></code></pre></td></tr></table></figure><h4 id="Evacuation-Pause-mixed-è½¬ç§»æš‚åœï¼šæ··åˆæ¨¡å¼"><a href="#Evacuation-Pause-mixed-è½¬ç§»æš‚åœï¼šæ··åˆæ¨¡å¼" class="headerlink" title="Evacuation Pause(mixed)(è½¬ç§»æš‚åœï¼šæ··åˆæ¨¡å¼)"></a>Evacuation Pause(mixed)(è½¬ç§»æš‚åœï¼šæ··åˆæ¨¡å¼)</h4><p>å¹¶å‘æ ‡è®°å®Œæˆä¹‹åï¼ŒG1å°†æ‰§è¡Œä¸€æ¬¡æ··åˆæ”¶é›†ï¼ˆmixed collectionï¼‰ï¼Œä¸åªæ¸…ç†å¹´è½»ä»£ï¼Œè¿˜å°†ä¸€éƒ¨åˆ†è€å¹´ä»£åŒºåŸŸä¹ŸåŠ å…¥åˆ°collection setä¸­ã€‚æ··åˆæ¨¡å¼çš„è½¬ç§»æš‚åœï¼ˆEvacuation pauseï¼‰ä¸ä¸€å®šç´§è·Ÿå¹¶å‘æ ‡è®°é˜¶æ®µã€‚åœ¨å¹¶å‘æ ‡è®°ä¸æ··åˆè½¬ç§»æš‚åœä¹‹é—´ï¼Œå¾ˆå¯èƒ½ä¼šå­˜åœ¨å¤šæ¬¡ young æ¨¡å¼çš„è½¬ç§»æš‚åœã€‚</p><blockquote><p><code>æ··åˆæ¨¡å¼</code> å°±æ˜¯æŒ‡è¿™æ¬¡GCäº‹ä»¶æ··åˆç€å¤„ç†å¹´è½»ä»£å’Œè€å¹´ä»£çš„regionã€‚è¿™ä¹Ÿæ˜¯G1ç­‰å¢é‡åƒåœ¾æ”¶é›†å™¨çš„ç‰¹è‰²ã€‚è€ŒZGCç­‰æœ€æ–°çš„åƒåœ¾æ”¶é›†å™¨åˆ™ä¸ä½¿ç”¨åˆ†ä»£ç®—æ³•ã€‚</p></blockquote><p>æ··åˆæ¨¡å¼ä¸‹çš„æ—¥å¿—ï¼Œå’Œçº¯å¹´è½»ä»£æ¨¡å¼ç›¸æ¯”ï¼Œè¿˜æ˜¯æœ‰ä¸€äº›åŒºåˆ«çš„ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">2021-07-21T00:45:17.574-0800: 0.328:</span> <br>    [<span class="hljs-string">GC</span> <span class="hljs-string">pause</span> <span class="hljs-string">(G1</span> <span class="hljs-string">Evacuation</span> <span class="hljs-string">Pause)</span> <span class="hljs-string">(mixed)</span>, <span class="hljs-number">0.0028130</span> <span class="hljs-string">secs</span>]<br>   [<span class="hljs-attr">Parallel Time:</span> <span class="hljs-number">2.4</span> <span class="hljs-string">ms</span>, <span class="hljs-attr">GC Workers:</span> <span class="hljs-number">8</span>]<br>        <span class="hljs-string">......</span><br>      [<span class="hljs-string">Update</span> <span class="hljs-string">RS</span> <span class="hljs-string">(ms):</span> <span class="hljs-attr">Min:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Avg:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Max:</span> <span class="hljs-number">0.1</span>, <span class="hljs-attr">Diff:</span> <span class="hljs-number">0.1</span>, <span class="hljs-attr">Sum:</span> <span class="hljs-number">0.2</span>]<br>         [<span class="hljs-attr">Processed Buffers: Min:</span> <span class="hljs-number">0</span>, <span class="hljs-attr">Avg:</span> <span class="hljs-number">0.9</span>, <span class="hljs-attr">Max:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Diff:</span> <span class="hljs-number">1</span>, <span class="hljs-attr">Sum:</span> <span class="hljs-number">7</span>]<br>      [<span class="hljs-string">Scan</span> <span class="hljs-string">RS</span> <span class="hljs-string">(ms):</span> <span class="hljs-attr">Min:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Avg:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Max:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Diff:</span> <span class="hljs-number">0.0</span>, <span class="hljs-attr">Sum:</span> <span class="hljs-number">0.0</span>]<br>      <span class="hljs-string">......</span><br>   [<span class="hljs-attr">Code Root Fixup:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Code Root Purge:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Clear CT:</span> <span class="hljs-number">0.1</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Other:</span> <span class="hljs-number">0.3</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Choose CSet:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Ref Proc:</span> <span class="hljs-number">0.1</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Ref Enq:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Redirty Cards:</span> <span class="hljs-number">0.1</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Humongous Register:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Humongous Reclaim:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>      [<span class="hljs-attr">Free CSet:</span> <span class="hljs-number">0.0</span> <span class="hljs-string">ms</span>]<br>   [<span class="hljs-attr">Eden:</span> <span class="hljs-number">10.</span><span class="hljs-string">0M(10.0M)-&gt;0.0B(21.0M)</span> <br>        <span class="hljs-attr">Survivors:</span> <span class="hljs-number">15.</span><span class="hljs-string">0M-&gt;4096.0K</span> <br>      <span class="hljs-attr">Heap:</span> <span class="hljs-number">425.</span><span class="hljs-string">6M(512.0M)-&gt;365.1M(512.0M)</span>]<br> [<span class="hljs-attr">Times:</span> <span class="hljs-string">user=0.01</span> <span class="hljs-string">sys=0.00</span>, <span class="hljs-string">real=0.00</span> <span class="hljs-string">secs</span>] <br></code></pre></td></tr></table></figure><blockquote><p>ç®€å•è§£è¯»å¦‚ä¸‹ï¼ˆéƒ¨åˆ†æ¦‚å¿µå’Œåç§°ï¼Œå¯ä»¥å‚è€ƒå‰é¢çš„G1çš„æ—¥å¿—åˆ†æï¼‰ï¼š</p><ol><li><code>Update RS (ms)</code> å› ä¸º Remember Sets æ˜¯å¹¶å‘å¤„ç†çš„ï¼Œå¿…é¡»ç¡®ä¿åœ¨å®é™…çš„åƒåœ¾æ”¶é›†ä¹‹å‰ï¼Œç¼“å†²åŒºä¸­çš„card çš„å¾—åˆ°å¤„ç†ï¼Œå¦‚æœcardæ•°é‡å¾ˆå¤šï¼Œåˆ™GCå¹¶å‘çº¿ç¨‹çš„è´Ÿè½½å¯èƒ½å°±ä¼šå¾ˆé«˜ã€‚å¯èƒ½çš„åŸå› æ˜¯ä¿®æ”¹çš„å­—æ®µè¿‡å¤šï¼Œæˆ–CPUèµ„æºå—é™ã€‚</li><li><code>Processed Buffers</code> å„ä¸ªworker çº¿ç¨‹å¤„ç†äº†å¤šä¸ªæœ¬åœ°ç¼“å†²åŒºï¼ˆlocal bufferï¼‰ã€‚</li><li><code>Scan RS (ms)</code> ç”¨äº†å¤šé•¿æ—¶é—´æ‰«ææ¥è‡ªRSetçš„å¼•ç”¨ã€‚</li><li><code>[Clear CT: 0.1 ms]</code> æ¸…ç† card table ä¸­çš„ cards çš„æ—¶é—´ã€‚æ¸…ç†å·¥ä½œåªæ˜¯ç®€å•åœ°åˆ é™¤â€œè„â€çŠ¶æ€ï¼Œæ­¤çŠ¶æ€ç”¨æ¥æ ‡è¯†ä¸€ä¸ªå­—æ®µæ˜¯å¦è¢«æ›´æ–°ï¼Œä¾›Remebered Sets ä½¿ç”¨ã€‚</li><li><code>[Redirty Cards: 0.1 ms]</code> å°† card table ä¸­é€‚å½“çš„ä½ç½®æ ‡è®°ä¸º dirty æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚</li></ol></blockquote><h4 id="Full-GCï¼ˆAllocation-Failureï¼‰"><a href="#Full-GCï¼ˆAllocation-Failureï¼‰" class="headerlink" title="Full GCï¼ˆAllocation Failureï¼‰"></a>Full GCï¼ˆAllocation Failureï¼‰</h4><p>G1 æ˜¯ä¸€æ¬¾è‡ªé€‚åº”çš„å¢é‡åƒåœ¾æ”¶é›†å™¨ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåªæœ‰åœ¨å†…å­˜ä¸¥é‡ä¸è¶³çš„æƒ…å†µä¸‹æ‰ä¼šå‘ç”Ÿ FullGCï¼Œä»¥ä¸‹å³æ˜¯è¿™éƒ¨åˆ†çš„æ—¥å¿—è¾“å‡ºç»“æœã€‚</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-number">2021</span>-<span class="hljs-number">07</span>-<span class="hljs-number">21</span>T00:<span class="hljs-number">45</span>:<span class="hljs-number">22.279</span>-<span class="hljs-number">0800</span>: <span class="hljs-number">5.033</span>: <br>        [F<span class="hljs-function"><span class="hljs-title">ull</span> GC (Allocation Failure)  405M-&gt;</span><span class="hljs-number">378</span>M(<span class="hljs-number">512</span>M), <span class="hljs-number">0.0339622</span> secs]<br>    [E<span class="hljs-function"><span class="hljs-title">den</span>: 0.0B(25.0M)-&gt;</span><span class="hljs-number">0.0</span>B(<span class="hljs-number">25.0</span>M) <br>        S<span class="hljs-function"><span class="hljs-title">urvivors</span>: 0.0B-&gt;</span><span class="hljs-number">0.0</span>B H<span class="hljs-function"><span class="hljs-title">eap</span>: 405.6M(512.0M)-&gt;</span><span class="hljs-number">378.8</span>M(<span class="hljs-number">512.0</span>M)], <br>      [M<span class="hljs-function"><span class="hljs-title">etaspace</span>: 2565K-&gt;</span><span class="hljs-number">2565</span>K(<span class="hljs-number">1056768</span>K)]<br>[Times: user=<span class="hljs-number">0.03</span> sys=<span class="hljs-number">0.00</span>, <span class="hljs-keyword">real</span>=<span class="hljs-number">0.04</span> secs] <br></code></pre></td></tr></table></figure><h2 id="GCè°ƒä¼˜"><a href="#GCè°ƒä¼˜" class="headerlink" title="GCè°ƒä¼˜"></a>GCè°ƒä¼˜</h2><p>æˆ‘ä»¬çš„GCæœ‰å¾ˆå¤šçš„é»˜è®¤å‚æ•°ï¼ŒåŸºæœ¬èƒ½æ»¡è¶³æˆ‘ä»¬å¤§å¤šæ•°çš„åœºæ™¯ä¸‹çš„æ€§èƒ½éœ€æ±‚ã€‚ä½†æ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹æˆ‘ä»¬çš„ç¡¬ä»¶æ¡ä»¶å¹¶ä¸æ˜¯é‚£ä¹ˆå……è¶³ï¼Œæˆ–è€…è¯´æ˜¯åœ¨ä¸€äº›é»˜è®¤çš„åœºæ™¯ä¸‹JVMä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„ä¸ªåˆ«æ€§èƒ½ç‚¹éœ€æ±‚ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡è§‚å¯Ÿåˆ†æGCæ—¥å¿—è°ƒæ•´GCå‚æ•°çš„æ–¹å¼ï¼Œè®©JVMåœ¨ç‰¹å®šçš„åœºæ™¯è¡¨ç°å‡ºæœ€ä¼˜çš„æ€§èƒ½è¡¨ç°ã€‚é‚£ä¹ˆGCè°ƒä¼˜æˆ‘ä»¬è¯¥æ€ä¹ˆå¼€å§‹å‘¢ï¼Ÿ</p><blockquote><p>æˆ‘åˆšæ¥è§¦GCè°ƒä¼˜çš„æ—¶å€™ï¼Œæˆ‘å¯¹GCè°ƒä¼˜æ— ä»ä¸‹æ‰‹ï¼Œé¢å¯¹é‚£ä¹ˆå¤šå‚æ•°ï¼Œæ€ä¹ˆæ‰ç®—æ˜¯è°ƒä¼˜äº†å‘¢ï¼Ÿæ¢ä¸€ä¸ªåƒåœ¾æ”¶é›†å™¨ï¼Œå †ç©ºé—´æ”¹å¤§ä¸€ç‚¹ï¼Ÿä¸€è„¸æ‡µã€‚ã€‚</p></blockquote><h3 id="è°ƒä¼˜çš„åŸºæœ¬æµç¨‹"><a href="#è°ƒä¼˜çš„åŸºæœ¬æµç¨‹" class="headerlink" title="è°ƒä¼˜çš„åŸºæœ¬æµç¨‹"></a>è°ƒä¼˜çš„åŸºæœ¬æµç¨‹</h3><p>åˆšæ¥è§¦è°ƒä¼˜çš„æ–°æ‰‹é¢å¯¹200å¤šä¸ªGCå‚æ•°åŸºæœ¬ä¸Šéƒ½ä¼šä¸€è„¸æ‡µé€¼ï¼Œç„¶åéšä¾¿è°ƒå‡ ä¸ªå‚æ•°è¯•è¯•ç»“æœæˆ–è€…æ”¹å‡ è¡Œä»£ç è¯•è¯•ï¼Œä½†æ˜¯è¿™æ ·çš„æ“ä½œåŸºæœ¬ä¸Šæ˜¯å¾’åŠ³çš„ã€‚<strong>GCè°ƒä¼˜å’Œå…¶ä»–çš„å…¶ä»–çš„æ€§èƒ½è°ƒä¼˜å…¶å®æ˜¯åŒæ ·çš„é“ç†</strong>ï¼Œåªè¦æŒ‰ç…§ä¸€ä¸‹çš„æ­¥éª¤æ“ä½œï¼ŒåŸºæœ¬èƒ½ä¿è¯æˆ‘ä»¬è°ƒä¼˜çš„å¤§æ–¹å‘ä¸ä¼šé”™ã€‚</p><ol><li><strong>åˆ—å‡ºæ€§èƒ½è°ƒä¼˜æŒ‡æ ‡ï¼ˆState your performance goalsï¼‰</strong></li><li><strong>æ‰§è¡Œæµ‹è¯•ï¼ˆRun testsï¼‰</strong></li><li><strong>æ£€æŸ¥ç»“æœï¼ˆMeasure the resultsï¼‰</strong></li><li><strong>ä¸ç›®æ ‡è¿›è¡Œå¯¹æ¯”ï¼ˆCompare the results with goalsï¼‰</strong></li><li><strong>å¦‚æœè¾¾ä¸åˆ°æŒ‡æ ‡ï¼Œä¿®æ”¹é…ç½®å‚æ•°ï¼Œç„¶åç»§ç»­æµ‹è¯•ï¼ˆgo back to running testsï¼‰</strong></li></ol><h3 id="æ ¸å¿ƒæ¦‚å¿µ"><a href="#æ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µ"></a>æ ¸å¿ƒæ¦‚å¿µ</h3><p>ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬éœ€è¦åšçš„äº‹æƒ…æ˜¯ï¼šåˆ¶å®šæ˜ç¡®çš„GCæ€§èƒ½æŒ‡æ ‡ã€‚å¯¹æ‰€æœ‰çš„æ€§èƒ½ç›‘æ§å’Œç®¡ç†æ¥çœ‹ï¼Œæœ‰ä¸‰ä¸ªçº¬åº¦æ˜¯é€šç”¨çš„ï¼š</p><ul><li><strong>Latencyï¼ˆå»¶è¿Ÿï¼‰</strong></li><li><strong>Throughputï¼ˆååé‡ï¼‰</strong></li><li><strong>Capacityï¼ˆç³»ç»Ÿå®¹é‡ï¼‰</strong></li></ul><h4 id="Latencyï¼ˆå»¶è¿Ÿï¼‰"><a href="#Latencyï¼ˆå»¶è¿Ÿï¼‰" class="headerlink" title="Latencyï¼ˆå»¶è¿Ÿï¼‰"></a>Latencyï¼ˆå»¶è¿Ÿï¼‰</h4><p>GCçš„å»¶è¿Ÿç‡æŒ‡æ ‡ç”±ä¸€èˆ¬çš„å»¶è¿Ÿéœ€æ±‚å†³å®šã€‚å»¶è¿ŸæŒ‡æ ‡çš„æè¿°ä¸€èˆ¬å¦‚ä¸‹ï¼š</p><ul><li>æ‰€æœ‰çš„äº¤æ˜“å¿…é¡»åœ¨10ç§’å†…å¾—åˆ°å“åº”ã€‚</li><li>90%çš„è®¢å•ä»˜æ¬¾æ“ä½œå¿…é¡»åœ¨3ç§’å†…å¤„ç†å®Œæˆã€‚</li><li>æ¨èå•†å“å¿…é¡»åœ¨ 100ms å†…å±•ç¤ºåˆ°ç”¨æˆ·é¢å‰ã€‚</li></ul><p>é¢å¯¹è¿™ç±»æ€§èƒ½æŒ‡æ ‡æ—¶ï¼Œéœ€è¦ä¿è¯åœ¨äº¤æ˜“è¿‡ç¨‹ä¸­ï¼Œ<strong>GCæš‚åœæ—¶é—´ä¸èƒ½å ç”¨å¤ªå¤šçš„æ—¶é—´</strong>ï¼Œå¦åˆ™æ»¡è¶³ä¸äº†æŒ‡æ ‡ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨GCè¿‡ç¨‹ä¸­æ˜¯å¿…å®šä¼šè¿›è¡ŒSTWçš„ï¼Œé‚£ä¹ˆè¿™é‡Œçš„â€œä¸èƒ½å ç”¨å¤ªå¤šâ€çš„æ„æ€æ˜¯éœ€è¦è§†å…·ä½“æƒ…å†µè€Œå®šï¼Œè¿˜è¦è€ƒè™‘å…¶ä»–çš„å› ç´ ï¼Œæ¯”å¦‚å¤–éƒ¨æ•°æ®æºçš„äº¤äº’æ—¶é—´ï¼ˆround-tripsï¼‰ï¼Œé”ç«äº‰ï¼ˆlock contentionï¼‰ï¼Œä»¥åŠå…¶ä»–çš„å®‰å…¨ç‚¹ç­‰ã€‚</p><blockquote><p>åœ¨CMSä¹‹å‰çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸéƒ½æ˜¯éœ€è¦å…¨ç¨‹æš‚åœåº”ç”¨çº¿ç¨‹çš„ï¼Œå› æ­¤ä¹‹å‰GCçš„å»¶è¿Ÿï¼Œåœ¨GCæš‚åœæœŸé—´å°±æ˜¯ä¸€ä¸ªå‡ ä¹æ²¡æœ‰ä¼˜åŒ–çš„ç©ºé—´çš„ç¡¬ä¼¤ã€‚</p></blockquote><p>å‡è®¾æ€§èƒ½éœ€æ±‚ä¸ºï¼š<code>90%</code> çš„äº¤æ˜“è¦åœ¨<code>1000ms</code> ä»¥å†…å®Œæˆï¼Œæ¯æ¬¡äº¤æ˜“æœ€é•¿ä¸èƒ½è¶…è¿‡<code>10s</code>ã€‚æ ¹æ®ç»éªŒï¼Œå‡è®¾GCæš‚åœæ—¶é—´æ¯”ä¾‹ä¸èƒ½è¶…è¿‡10%ï¼Œä¹Ÿå°±æ˜¯90%çš„GCæš‚åœå¿…é¡»åœ¨<code>100ms</code>å†…ç»“æŸï¼Œä¹Ÿä¸èƒ½è¶…è¿‡<code>1000ms</code>çš„GCæš‚åœã€‚ä¸ºäº†ç®€å•æœŸé—´ï¼Œæˆ‘ä»¬å¿½ç•¥åœ¨åŒä¸€æ¬¡äº¤æ˜“è¿‡ç¨‹ä¸­å‘ç”Ÿå¤šæ¬¡çš„GCçš„åœé¡¿å¯èƒ½æ€§ã€‚ä¸‹é¢æ˜¯ä¸€æ®µGCæ—¥å¿—ç‰‡æ®µã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2015</span>â€<span class="hljs-number">06</span>â€<span class="hljs-number">04</span><span class="hljs-variable">T13</span><span class="hljs-operator">:</span><span class="hljs-number">34</span><span class="hljs-operator">:</span><span class="hljs-number">16.974</span>â€<span class="hljs-number">0200</span><span class="hljs-operator">:</span> <span class="hljs-number">2.578</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">93677</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">70109</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">254976</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">499597</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">511230</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">761856</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">593275</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">581339</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1016832</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2936</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">2936</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">,</span> <span class="hljs-number">0.0713174</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™æ®µæ—¥å¿—è¡¨ç¤ºä¸€æ¬¡Parallel GCæš‚åœï¼Œå‘ç”Ÿåœ¨<code>2015â€06â€04T13:34:16.974â€0200</code> ï¼Œå¯¹åº”ç€JVMå¯åŠ¨åçš„ç¬¬<code>2.578</code>ç§’ã€‚æœ¬æ¬¡åº”ç”¨çº¿ç¨‹æš‚åœäº†<code>0.0713174</code>ç§’ã€‚è¿™æ¬¡æ˜¯ä¸€æ¬¡ FullGC æš‚åœï¼ŒèŠ±è´¹çš„æ€»æ—¶é—´<code>210ms</code>ï¼Œä½†å› ä¸ºæ˜¯å¤šæ ¸CPUæœºå™¨ï¼Œæ‰€æœ‰æœ€åé‡è¦çš„æ•°å­—æ˜¯åº”ç”¨çº¿ç¨‹è¢«æš‚åœçš„æ€»æ—¶é—´<code>real</code>ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å¹¶è¡ŒGCï¼Œæ‰€ä»¥æš‚åœçš„æ€»æ—¶é—´æ˜¯<code>70ms</code>ï¼Œè¿™é‡Œæˆ‘ä»¬çš„æ€§èƒ½è¦æ˜¯90%çš„GCæš‚åœå¿…é¡»åœ¨100mså†…ç»“æŸï¼Œè¿™é‡Œçš„æš‚åœæ—¶é—´æ˜¯70msï¼Œæ»¡è¶³è¦æ±‚ã€‚</p><h4 id="Throughputï¼ˆååé‡ï¼‰"><a href="#Throughputï¼ˆååé‡ï¼‰" class="headerlink" title="Throughputï¼ˆååé‡ï¼‰"></a>Throughputï¼ˆååé‡ï¼‰</h4><p>ååé‡å’Œå»¶è¿ŸæŒ‡æ ‡æœ‰å¾ˆå¤§åŒºåˆ«ã€‚å½“ç„¶ä¸¤è€…éƒ½æ˜¯æ ¹æ®ä¸€èˆ¬ååé‡éœ€æ±‚è€Œå¾—å‡ºçš„ã€‚ä¸€èˆ¬ååé‡éœ€æ±‚ï¼ˆGeneric requirements for throughputï¼‰ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><ul><li>è§£å†³æ–¹æ¡ˆå¿…é¡»æ¯å¤©å¤„ç†100ä¸‡ä¸ªè®¢å•ã€‚</li><li>è§£å†³æ–¹æ¡ˆå¿…é¡»æ”¯æŒ1000ä¸ªç™»å½•ç”¨æˆ·ï¼ŒåŒæ—¶åœ¨5ï½10ç§’å†…æ‰§è¡ŒæŸä¸ªæ“ä½œï¼šAã€Bæˆ–Cã€‚</li><li>æ¯å‘¨å¯¹æ‰€æœ‰å®¢æˆ·è¿›è¡Œç»Ÿè®¡ï¼Œæ—¶é—´ä¸è¶…è¿‡6å°æ—¶ï¼Œæ—¶é—´çª—å£ä¸ºæ¯å‘¨æ—¥æ™š12ç‚¹åˆ°æ¬¡æ—¥6ç‚¹ä¹‹é—´ã€‚</li></ul><p>å¯ä»¥çœ‹å‡ºï¼Œ<strong>ååé‡éœ€æ±‚ä¸æ˜¯é’ˆå¯¹å•ä¸ªæ“ä½œçš„ï¼Œè€Œæ˜¯ç»™å®šçš„æ—¶é—´å†…ï¼Œç³»ç»Ÿå¿…é¡»å®Œæˆå¤šå°‘ä¸ªæ“ä½œ</strong>ã€‚å’Œå»¶è¿Ÿéœ€æ±‚ç±»ä¼¼ï¼ŒGCè°ƒä¼˜ä¹Ÿéœ€è¦å»å®šGCè¡Œä¸ºæ‰€æ¶ˆè€—çš„æ€»æ—¶é—´ã€‚æ¯ä¸ªç³»ç»Ÿèƒ½æ¥å—çš„æ—¶é—´ä¸åŒï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒGCå ç”¨çš„æ€»æ—¶é—´æ¯”ä¸èƒ½è¶…è¿‡ <code>10%</code>ã€‚</p><p>å‡è®¾é€‰åœ¨éœ€æ±‚ä¸ºï¼šæ¯åˆ†é’Ÿå¤„ç† 1000 ç¬”äº¤æ˜“ã€‚åŒæ—¶ï¼Œæ¯åˆ†é’ŸGCæš‚åœçš„æ€»æ—¶é—´ä¸èƒ½è¶…è¿‡6ç§’ï¼ˆå³10%ï¼‰ã€‚æœ‰äº†æ­£å¼çš„éœ€æ±‚ï¼Œé€šè¿‡åˆ†æGCæ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸‹é¢è¿™äº›ä¿¡æ¯ã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2015</span>â€<span class="hljs-number">06</span>â€<span class="hljs-number">04</span><span class="hljs-variable">T13</span><span class="hljs-operator">:</span><span class="hljs-number">34</span><span class="hljs-operator">:</span><span class="hljs-number">16.974</span>â€<span class="hljs-number">0200</span><span class="hljs-operator">:</span> <span class="hljs-number">2.578</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">93677</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">70109</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">254976</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">499597</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">511230</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">761856</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">593275</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">581339</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1016832</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2936</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">2936</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-operator">,</span> <span class="hljs-number">0.0713174</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>æ­¤æ—¶æˆ‘ä»¬å¯¹<code>ç”¨æˆ·è€—æ—¶ï¼ˆuserï¼‰</code>å’Œ<code>ç³»ç»Ÿè€—æ—¶ï¼ˆsysï¼‰</code>æ„Ÿå…´è¶£è€Œä¸å…³å¿ƒ<code>å®é™…è€—æ—¶ï¼ˆrealï¼‰</code>ã€‚è¿™é‡Œæˆ‘ä»¬å…³å¿ƒçš„æ—¶é—´ä¸º<code>0.23s</code>ï¼ˆuser + sys = 0.21s + 0.02sï¼‰ï¼Œè¿™æ®µæ—¶é—´å†…ï¼ŒGCæš‚åœä¼šå ç”¨CPUèµ„æºã€‚é‡è¦çš„æ˜¯<strong>ç³»ç»Ÿè¿è¡Œåœ¨å¤šæ ¸å¿ƒçš„æœºå™¨ä¸Šï¼Œè½¬æ¢åˆ°å®é™…çš„åœé¡¿æ—¶é—´ï¼ˆstop-the-worldï¼‰</strong>ä¸º<code>0.07131474ç§’</code>ã€‚æå–å‡ºè¿™äº›æœ‰ç”¨çš„ä¿¡æ¯ä¹‹åï¼Œå‰©ä¸‹çš„å°±æ˜¯è¦ç»Ÿè®¡æ¯åˆ†é’Ÿå†…GCæš‚åœçš„æ€»æ—¶é—´ã€‚çœ‹çœ‹æ˜¯å¦æ»¡è¶³éœ€æ±‚ã€‚æ¯åˆ†é’Ÿå†…æš‚åœæ—¶é—´ä¸è¶…è¿‡<code>6000æ¯«ç§’</code>ï¼ˆ<code>6ç§’</code>ï¼‰ã€‚</p><blockquote><p>å…¶å®å¯¹ä¸ååé‡çš„ä¼˜åŒ–è¿˜æ˜¯å›´ç»•ç€GCååé‡å…¬ç¤ºæ¥çš„ï¼Œå³ï¼š<strong>ååé‡ = è¿è¡Œåº”ç”¨ä»£ç æ—¶é—´/(è¿è¡Œåº”ç”¨ä»£ç æ—¶é—´+ è¿è¡Œåƒåœ¾æ”¶é›†æ—¶é—´)**ã€‚å…¶å®æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªè¦ç¼©çŸ­å•ä½æ—¶é—´å†…åƒåœ¾æ”¶é›†æ—¶é—´æš‚åœæ—¶é—´å°±èƒ½å¢åŠ ååé‡ï¼Œå› æ­¤åœ¨è°ƒä¼˜ååé‡æˆ‘ä»¬è¿˜æ˜¯éœ€è¦å…³å¿ƒ</strong>å•ä½æ—¶é—´å†…æš‚åœçš„æ€»æ—¶é•¿**ã€‚</p><p>å…³äº GCTime ä¸­çš„ userã€sysã€realã€‚è¿™ä¸ªé—®é¢˜ä¹‹å‰å›°æ‰°äº†æˆ‘å¾ˆä¹…å¾ˆä¹…ï¼Œä»–ä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆä¼š user + sys = realï¼Ÿ</p><p>æˆ‘ä¹‹å‰æ˜¯çŸ¥é“userã€sysã€real åˆ†åˆ«ä»£è¡¨ ç”¨æˆ·è€—æ—¶ã€ç³»ç»Ÿè€—æ—¶ã€å®é™…è€—æ—¶ã€‚ä½†æ˜¯ä»–ä»¬ä¹‹é—´çš„å…³ç³»çœ‹çš„ä¸æ˜¯å¾ˆæ˜ç™½ã€‚éš¾é“å•æ¬¡GCçš„ç”¨æˆ·è€—æ—¶è¿˜èƒ½æ¯”å®é™…è€—æ—¶è¿˜è¦ä¹…ï¼Ÿè¿™æ¬¡æ¢³ç†æˆ‘åˆå»é‡æ–°æ‰¾äº†èµ„æ–™ç†è§£è¿™å‡ ä¸ªæ—¶é—´èƒŒåçš„æ„æ€ã€‚</p><ul><li><strong>user</strong> è¿›ç¨‹æ‰§è¡Œç”¨æˆ·æ€ä»£ç ï¼ˆæ ¸å¿ƒä¹‹å¤–ï¼‰æ‰€æœ‰çš„æ—¶é—´ã€‚è¿™æ˜¯æ‰§è¡Œæ­¤è¿›ç¨‹æ­¤çº¿ç¨‹æ‰€ä½¿ç”¨çš„å®é™…CPUæ—¶é—´ã€‚å…¶ä»–è¿›ç¨‹å’Œæ­¤é˜»å¡çº¿ç¨‹çš„æ—¶é—´å¹¶ä¸åŒ…æ‹¬åœ¨å†…ã€‚åœ¨æ˜¯åƒåœ¾æ”¶é›†çš„æƒ…å†µä¸‹ï¼Œè¡¨ç¤ºGCçº¿ç¨‹æ‰§è¡Œæ‰€ä½¿ç”¨çš„CPUæ€»æ—¶é—´ã€‚</li><li><strong>sys</strong> è¿›ç¨‹åœ¨å†…æ ¸æ€æ¶ˆè€—çš„ CPU æ—¶é—´ï¼Œå³åœ¨å†…æ ¸æ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–è€…ç­‰å¾…ç³»ç»Ÿäº‹ä»¶æ‰€ä½¿ç”¨çš„ CPU æ—¶é—´ã€‚</li><li><strong>real</strong> ç¨‹åºä»å¼€å§‹åˆ°ç»“æŸæ‰€ç”¨çš„æ—¶é’Ÿæ—¶é—´ã€‚è¿™ä¸ªæ—¶é—´åŒ…æ‹¬å…¶ä»–è¿›ç¨‹ä½¿ç”¨çš„æ—¶é—´ç‰‡å’Œè¿›ç¨‹é˜»å¡çš„æ—¶é—´ï¼ˆæ¯”å¦‚ç­‰å¾…I/Oå®Œæˆï¼‰ã€‚</li></ul><p>user + sys æ—¶é—´å‘Šè¯‰æˆ‘ä»¬ï¼Œç¨‹åºå®é™…æ‰§è¡Œä½¿ç”¨çš„CPUæ—¶é—´ï¼Œè¿™é‡Œæ˜¯æŒ‡<strong>æ‰€æœ‰çš„CPU</strong>ï¼Œå› æ­¤<strong>æœ‰å¤šä¸ªçº¿ç¨‹çš„è¯ï¼Œè¿™ä¸ªæ—¶é—´ä¼šè¶…è¿‡ real æ‰€è¡¨ç¤ºçš„æ—¶é’Ÿæ—¶é—´</strong>ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦å‚è€ƒ<code>real</code>æ—¶é—´æ¥è¿›è¡Œä¼˜åŒ–ï¼Œå¦‚æœæˆ‘ä»¬æƒ³é€šè¿‡<strong>å¢åŠ çº¿ç¨‹æˆ–è€…å¢åŠ CPUæ•°é‡æ¥å‡å°‘GCåœé¡¿æ—¶é—´</strong>ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ<code>user</code>å’Œ<code>sys</code>ã€‚</p></blockquote><h4 id="Capacityï¼ˆç³»ç»Ÿå®¹é‡ï¼‰"><a href="#Capacityï¼ˆç³»ç»Ÿå®¹é‡ï¼‰" class="headerlink" title="Capacityï¼ˆç³»ç»Ÿå®¹é‡ï¼‰"></a>Capacityï¼ˆç³»ç»Ÿå®¹é‡ï¼‰</h4><p>ç³»ç»Ÿå®¹é‡ï¼ˆCapacityï¼‰éœ€æ±‚ï¼Œæ˜¯è¾¾æˆååé‡å’Œå»¶è¿ŸæŒ‡æ ‡çš„æƒ…å†µä¸‹ï¼Œå¯¹ç¡¬ä»¶ç¯å¢ƒçš„é¢å¤–çº¦æŸã€‚è¿™ç±»éœ€æ±‚å¤§å¤šæ•°éƒ½æ˜¯æºäºè®¡ç®—èµ„æºæˆ–è€…é¢„ç®—æ–¹é¢çš„åŸå› ã€‚ä¾‹å¦‚ï¼š</p><ul><li>ç³»ç»Ÿå¿…é¡»èƒ½éƒ¨ç½²åˆ°å°äº512MBå†…å­˜çš„Androidè®¾å¤‡ä¸Šã€‚</li><li>ç³»ç»Ÿå¿…é¡»éƒ¨ç½²åœ¨é…ç½®ä¸è¶…è¿‡4æ ¸8GBçš„ECSä¸Šã€‚</li><li>æ¯ä¸ªæœˆäº‘ECSçš„è´¦å•ä¸è¶…è¿‡10000å…ƒã€‚</li></ul><p>å› æ­¤ï¼Œåœ¨æ»¡è¶³å»¶è¿Ÿå’Œååé‡éœ€æ±‚çš„åŸºç¡€ä¸Š<strong>å¿…é¡»è€ƒè™‘ç³»ç»Ÿå®¹é‡</strong>ã€‚å¦‚æœæœ‰æ— é™çš„è®¡ç®—èµ„æºå¯ä»¥æŒ¥éœï¼Œé‚£ä¹ˆä»»ä½•å»¶è¿Ÿå’Œååé‡çš„æŒ‡æ ‡éƒ½å¯ä»¥æ»¡è¶³ï¼Œä½†æ˜¯<strong>ç°å®æ˜¯é¢„ç®—å’Œå…¶ä»–çº¦æŸé™åˆ¶äº†å¯ç”¨çš„èµ„æºã€‚</strong></p><blockquote><p><strong>æ²¡æœ‰èµ„æºçš„é™åˆ¶ä¹Ÿå°±æ²¡æœ‰è°ƒä¼˜ã€‚</strong></p></blockquote><h3 id="é’ˆå¯¹æŒ‡æ ‡çš„ç®€å•è°ƒä¼˜ç¤ºä¾‹"><a href="#é’ˆå¯¹æŒ‡æ ‡çš„ç®€å•è°ƒä¼˜ç¤ºä¾‹" class="headerlink" title="é’ˆå¯¹æŒ‡æ ‡çš„ç®€å•è°ƒä¼˜ç¤ºä¾‹"></a>é’ˆå¯¹æŒ‡æ ‡çš„ç®€å•è°ƒä¼˜ç¤ºä¾‹</h3><p>ä»‹ç»å®Œä¸Šé¢çš„ä¸‰ä¸ªæŒ‡æ ‡ï¼Œæˆ‘ä»¬å¯¹ä¸‹é¢çš„ç¨‹åºè¿›è¡Œå®é™…åˆ†ææ“ä½œä»¥è¾¾æˆGCæŒ‡æ ‡ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//imports skipped for brevity </span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span> &#123;</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ScheduledExecutorService executorService = Executors.newScheduledThreadPool(<span class="hljs-number">2</span>); <br>    <span class="hljs-keyword">private</span> Deque&lt;<span class="hljs-keyword">byte</span>[]&gt; <span class="hljs-built_in">deque</span>; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> objectSize; <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> queueSize; <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Producer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> objectSize, <span class="hljs-keyword">int</span> ttl)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.<span class="hljs-built_in">deque</span> = <span class="hljs-keyword">new</span> ArrayDeque&lt;<span class="hljs-keyword">byte</span>[]&gt;();<br>        <span class="hljs-keyword">this</span>.objectSize = objectSize;<br>        <span class="hljs-keyword">this</span>.queueSize = ttl * <span class="hljs-number">1000</span>; <br>    &#125;<br>    <br>    @Override <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) &#123; <br>            <span class="hljs-built_in">deque</span>.add(<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[objectSize]);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">deque</span>.<span class="hljs-built_in">size</span>() &gt; queueSize) &#123; <br>                <span class="hljs-built_in">deque</span>.poll();<br>            &#125; <br>        &#125; <br>    &#125;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span>[] args)</span> throws InterruptedException </span>&#123; <br>        executorService.scheduleAtFixedRate( <span class="hljs-keyword">new</span> Producer(<span class="hljs-number">200</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> / <span class="hljs-number">1000</span>, <span class="hljs-number">5</span>), <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, TimeUnit.MILLISECONDS ); <br>        executorService.scheduleAtFixedRate( <span class="hljs-keyword">new</span> Producer(<span class="hljs-number">50</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> / <span class="hljs-number">1000</span>, <span class="hljs-number">120</span>), <span class="hljs-number">0</span>, <span class="hljs-number">100</span>, TimeUnit.MILLISECONDS); <br>        TimeUnit.MINUTES.sleep(<span class="hljs-number">10</span>); executorService.shutdownNow(); <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ¯100msæäº¤ä¸¤ä¸ªä½œä¸šï¼ˆjobï¼‰ï¼Œæ¯ä¸ªä½œä¸šéƒ½æ¨¡æ‹Ÿç‰¹å®šçš„ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºå¯¹è±¡ï¼Œç„¶ååœ¨ç‰¹å®šçš„æ—¶é—´é‡Šæ”¾ï¼Œæ¥ç€å°±ä¸ç®¡äº†ï¼Œç”±GCæ¥è‡ªåŠ¨å›æ”¶å ç”¨çš„å†…å­˜ã€‚æˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„JVMå‚æ•°æ‰“å¼€GCæ—¥å¿—ä¿¡æ¯ï¼Œå¹¶é€šè¿‡åŠ ä¸ŠJVMå‚æ•°<code>-Xloggc</code> æ¥æŒ‡å®šGCæ—¥å¿—çš„å­˜å‚¨ä½ç½®ã€‚</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">-XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -Xloggc:gc.<span class="hljs-built_in">log</span><br></code></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„ä¸€äº›æ—¥å¿—è¾“å‡ºä¿¡æ¯ï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">12.320</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.284</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">65442</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">10721</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">76288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">65442</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">63175</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">251392</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0429520</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.08</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">12.518</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.482</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">76078</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">10710</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">141824</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">128531</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">128246</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">316928</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0607000</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">12.579</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">0.542</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">10710</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">141824</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">117535</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">128105</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">275968</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">128246</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">128105</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">417792</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2729</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2729</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0303548</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.10</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">13.114</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">1.077</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">131072</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">10748</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">141824</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">259177</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">259140</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">417792</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.1061217</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.06</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.11</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.11</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-operator">...</span><br></code></pre></td></tr></table></figure><p>åŸºäºæ—¥å¿—ä¸­çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‰ä¸ªä¼˜åŒ–ç›®æ ‡æ¥æå‡æ€§èƒ½ï¼š</p><ol><li>ç¡®ä¿æœ€åæƒ…å†µä¸‹ï¼ŒGCæš‚åœæ—¶é—´ä¸è¶…è¿‡é¢„å®šé˜ˆå€¼ã€‚</li><li>ç¡®ä¿çº¿ç¨‹æš‚åœçš„æ€»æ—¶é—´ä¸è¶…è¿‡é¢„å®šé˜ˆå€¼ã€‚</li><li>åœ¨ç¡®ä¿è¾¾åˆ°å»¶è¿Ÿå’Œååé‡çš„æŒ‡æ ‡ä¸‹ï¼Œé™ä½ç¡¬ä»¶é…ç½®ä»¥åŠæˆæœ¬ã€‚</li></ol><p>ä¸ºæ­¤æˆ‘ä»¬ä½¿ç”¨ä¸‰ç§ä¸åŒé…ç½®ï¼Œå°†ä»£ç è¿è¡Œ10åˆ†é’Ÿï¼Œå¾—åˆ°äº†ä¸‰ç§ä¸åŒçš„ç»“æœï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å †å†…å­˜å¤§å°ï¼ˆHeapï¼‰</th><th>GCç®—æ³•ï¼ˆGC Algorithmï¼‰</th><th>æœ‰æ•ˆæ—¶é—´æ¯”ï¼ˆUseful workï¼‰</th><th>æœ€é•¿æš‚åœæ—¶é—´ï¼ˆLongest pauseï¼‰</th></tr></thead><tbody><tr><td>-Xmx12g</td><td>-XX:+UseConcMarkSweepGC</td><td>89.8%</td><td>560ms</td></tr><tr><td>-Xmx12g</td><td>-XX:+UseParallelGC</td><td>91.5%</td><td>1104ms</td></tr><tr><td>-Xmx8g</td><td>-XX:UseConcMarkSweepGC</td><td>66.3%</td><td>1610ms</td></tr></tbody></table><p>ä½¿ç”¨ä¸åŒçš„GCç®—æ³•å’Œä¸åŒçš„å†…å­˜é…ç½®ï¼Œè¿è¡Œç›¸åŒçš„ä»£ç ï¼Œä»¥æµ‹é‡GCæš‚åœæ—¶é—´ä¸å»¶è¿Ÿã€ååé‡çš„å…³ç³»ã€‚</p><blockquote><p>âš ï¸ä¸ºäº†å°½å¯èƒ½ç®€å•ï¼Œç¤ºä¾‹ä¸­åªæ”¹å˜äº†å¾ˆå°‘çš„è¾“å…¥å‚æ•°ï¼Œæ­¤å®éªŒä¹Ÿç­æœ‰åœ¨ä¸åŒçš„CPUæ•°é‡æˆ–è€…ä¸åŒçš„å †å¸ƒå±€ä¸‹è¿›è¡Œæµ‹è¯•</p></blockquote><h4 id="è°ƒä¼˜å»¶è¿ŸæŒ‡æ ‡ï¼ˆTuning-for-Latancyï¼‰"><a href="#è°ƒä¼˜å»¶è¿ŸæŒ‡æ ‡ï¼ˆTuning-for-Latancyï¼‰" class="headerlink" title="è°ƒä¼˜å»¶è¿ŸæŒ‡æ ‡ï¼ˆTuning for Latancyï¼‰"></a>è°ƒä¼˜å»¶è¿ŸæŒ‡æ ‡ï¼ˆTuning for Latancyï¼‰</h4><p>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªéœ€æ±‚ï¼Œæ¯æ¬¡ä½œä¸šå¿…é¡»åœ¨ 1000ms å†…å¤„ç†å®Œæˆã€‚æˆ‘ä»¬çŸ¥é“ï¼Œå®é™…çš„ä½œä¸šå¤„ç†åªéœ€è¦100msï¼Œç®€åŒ–åï¼Œä¸¤è€…ç›¸å‡æˆ‘ä»¬å°±å¯ä»¥ç®—å‡ºå¯¹GCæš‚åœçš„å»¶è¿Ÿè¦æ±‚ã€‚ç°åœ¨éœ€æ±‚å˜æˆï¼šGCæš‚åœæ—¶é—´ä¸èƒ½è¶…è¿‡900msã€‚è¿™ä¸ªé—®é¢˜å°±å¾ˆå®¹æ˜“æ‰¾åˆ°ç­”æ¡ˆï¼Œåªè¦åˆ†æGCæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶æ‰¾å‡ºGCæš‚åœä¸­æœ€å¤§çš„é‚£ä¸ªæš‚åœæ—¶é—´å³å¯ã€‚</p><table><thead><tr><th>å †å†…å­˜å¤§å°ï¼ˆHeapï¼‰</th><th>GCç®—æ³•ï¼ˆGC Algorithmï¼‰</th><th>æœ‰æ•ˆæ—¶é—´æ¯”ï¼ˆUseful workï¼‰</th><th>æœ€é•¿æš‚åœæ—¶é—´ï¼ˆLongest pauseï¼‰</th></tr></thead><tbody><tr><td>-Xmx12g</td><td>-XX:+UseConcMarkSweepGC</td><td>89.8%</td><td>560ms</td></tr><tr><td>-Xmx12g</td><td>-XX:+UseParallelGC</td><td>91.5%</td><td>1104ms</td></tr><tr><td>-Xmx8g</td><td>-XX:UseConcMarkSweepGC</td><td>66.3%</td><td>1610ms</td></tr></tbody></table><p>ä»ä¸Šè¡¨ä¸­ï¼Œå…¶ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ‰ä¸€ä¸ªé…ç½®è¾¾åˆ°äº†è¦æ±‚ï¼Œå½“å †å†…å­˜å¤§å°ä¸º<code>-Xmx12g -XX:+UseConcMarkSweepGC</code>æ˜¯æœ€å¤§çš„æš‚åœæ—¶é—´ä¸º560msï¼Œæ»¡è¶³æœ€å¤§æš‚åœæ—¶é—´å°äº900msçš„ç›®æ ‡ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–çš„å…³äºååé‡å’Œç³»ç»Ÿå®¹é‡çš„è¦æ±‚çš„è¯ï¼Œç›®æ ‡è¾¾æˆè°ƒä¼˜ç»“æŸã€‚å…¶è¿è¡Œé…ç½®å‚æ•°ä¸ºï¼š</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmx12g -XX:+UseConcMarkSweepGC</span><br></code></pre></td></tr></table></figure><h4 id="ååé‡è°ƒä¼˜ï¼ˆTuning-for-Throughoutï¼‰"><a href="#ååé‡è°ƒä¼˜ï¼ˆTuning-for-Throughoutï¼‰" class="headerlink" title="ååé‡è°ƒä¼˜ï¼ˆTuning for Throughoutï¼‰"></a>ååé‡è°ƒä¼˜ï¼ˆTuning for Throughoutï¼‰</h4><p>å‡å®šååé‡æŒ‡æ ‡ä¸ºï¼šæ¯å°æ—¶å®Œæˆ1300ä¸‡æ¬¡æ“ä½œå¤„ç†ã€‚åŒæ ·æ˜¯ä¸Šé¢çš„é…ç½®ï¼Œå…¶ä¸­æœ‰ä¸€ç§é…ç½®æ»¡è¶³äº†éœ€æ±‚ï¼š</p><table><thead><tr><th>å †å†…å­˜å¤§å°ï¼ˆHeapï¼‰</th><th>GCç®—æ³•ï¼ˆGC Algorithmï¼‰</th><th>æœ‰æ•ˆæ—¶é—´æ¯”ï¼ˆUseful workï¼‰</th><th>æœ€é•¿æš‚åœæ—¶é—´ï¼ˆLongest pauseï¼‰</th></tr></thead><tbody><tr><td>-Xmx12g</td><td>-XX:+UseConcMarkSweepGC</td><td>89.8%</td><td>560ms</td></tr><tr><td>-Xmx12g</td><td>-XX:+UseParallelGC</td><td><strong>91.5%</strong></td><td>1104ms</td></tr><tr><td>-Xmx8g</td><td>-XX:UseConcMarkSweepGC</td><td>66.3%</td><td>1610ms</td></tr></tbody></table><p>ä»ä¸Šé¢çš„è¡¨æ ¼çš„æ•°æ®ä¸éš¾å¾—å‡ºï¼Œè¿™é‡Œ<code>-Xmx12g -XX:+UseParallelGC</code>æ˜¯å”¯ä¸€æœ‰æ•ˆçš„è§£ã€‚è¿™é‡Œçš„GCå ç”¨çš„8.5%çš„æ—¶é—´ï¼Œå‰©ä¸‹91.5%éƒ½æ˜¯æœ‰æ•ˆçš„è®¡ç®—æ—¶é—´ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å¿½ç•¥ç¤ºä¾‹ä¸­çš„å…¶ä»–å®‰å…¨ç‚¹ã€‚ç°åœ¨éœ€è¦è€ƒè™‘ï¼š</p><ol><li>æ¯ä¸ªCPUæ ¸å¿ƒå¤„ç†ä¸€æ¬¡ä½œä¸šéœ€è¦è€—æ—¶<code>100ms</code>ã€‚</li><li>å› æ­¤ï¼Œä¸€åˆ†é’Ÿå†…æ¯ä¸ªæ ¸å¿ƒå¯ä»¥æ‰§è¡Œ60000æ¬¡æ“ä½œï¼ˆæ¯ä¸ªjobå®Œæˆ100æ¬¡æ“ä½œï¼‰ã€‚</li><li>ä¸€å°æ—¶å†…ï¼Œä¸€ä¸ªæ ¸å¿ƒå¯ä»¥æ‰§è¡Œ360ä¸‡æ¬¡ã€‚</li><li>æœ‰å››ä¸ªCPUå†…æ ¸ï¼Œåˆ™æ¯å°æ—¶å¯ä»¥æ‰§è¡Œï¼š4 * 3.6M = 1440ä¸‡æ¬¡æ“ä½œã€‚</li></ol><p>ç†è®ºä¸Šï¼Œé€šè¿‡ç®€å•çš„è®¡ç®—å°±å¯ä»¥å¾—å‡ºç»“è®ºï¼Œæ¯å°æ—¶å¯ä»¥æ‰§è¡Œçš„æ“ä½œæ•°ä¸ºï¼š<code>14.4M * 91.5% = 13176000</code>æ¬¡ï¼Œæ»¡è¶³éœ€æ±‚ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼Œå‡è‹¥è¿˜è¦æ»¡è¶³å»¶è¿ŸæŒ‡æ ‡ï¼Œé‚£å°±æœ‰é—®é¢˜äº†ï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼ŒGCæš‚åœæ—¶é—´ä¸º<code>1104ms</code>ï¼Œæœ€å¤§å»¶è¿Ÿæ—¶é—´æ˜¯å‰ä¸€ç§é…ç½®çš„ä¸¤å€ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmx12g -XX:+UseParallelGC</span><br></code></pre></td></tr></table></figure><h4 id="è°ƒä¼˜ç³»ç»Ÿå®¹é‡ï¼ˆTuning-for-Capacityï¼‰"><a href="#è°ƒä¼˜ç³»ç»Ÿå®¹é‡ï¼ˆTuning-for-Capacityï¼‰" class="headerlink" title="è°ƒä¼˜ç³»ç»Ÿå®¹é‡ï¼ˆTuning for Capacityï¼‰"></a>è°ƒä¼˜ç³»ç»Ÿå®¹é‡ï¼ˆTuning for Capacityï¼‰</h4><p>å‡è®¾éœ€è¦å°†è½¯ä»¶éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šï¼Œé…ç½®ä¸º<code>4æ ¸10G</code>ã€‚è¿™æ ·çš„è¯ï¼Œç³»ç»Ÿå®¹é‡çš„è¦æ±‚å°±å˜æˆï¼Œæœ€å¤§çš„å †å†…å­˜ç©ºé—´ä¸èƒ½è¶…è¿‡<code>8G</code>ã€‚æœ‰äº†è¿™ä¸ªéœ€æ±‚ï¼Œæˆ‘ä»¬çš„ä¸‰å¥—é…ç½®åªæœ‰æœ€åä¸€ä¸ªæ»¡è¶³æ¡ä»¶ã€‚</p><table><thead><tr><th>å †å†…å­˜å¤§å°ï¼ˆHeapï¼‰</th><th>GCç®—æ³•ï¼ˆGC Algorithmï¼‰</th><th>æœ‰æ•ˆæ—¶é—´æ¯”ï¼ˆUseful workï¼‰</th><th>æœ€é•¿æš‚åœæ—¶é—´ï¼ˆLongest pauseï¼‰</th></tr></thead><tbody><tr><td>-Xmx12g</td><td>-XX:+UseConcMarkSweepGC</td><td>89.8%</td><td>560ms</td></tr><tr><td>-Xmx12g</td><td>-XX:+UseParallelGC</td><td>91.5%</td><td>1104ms</td></tr><tr><td><strong>-Xmx8g</strong></td><td>-XX:UseConcMarkSweepGC</td><td>66.3%</td><td>1610ms</td></tr></tbody></table><p>å› æ­¤åœ¨è¿™ä¸ªéœ€æ±‚ä¸‹çš„è¿è¡Œé…ç½®</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-Xmx8g -XX:+UseConcMarkSweepGC</span><br></code></pre></td></tr></table></figure><h3 id="æ—¥å¿—åˆ†æå·¥å…·"><a href="#æ—¥å¿—åˆ†æå·¥å…·" class="headerlink" title="æ—¥å¿—åˆ†æå·¥å…·"></a>æ—¥å¿—åˆ†æå·¥å…·</h3><p>ä¹‹å‰æˆ‘ä»¬æ¢³ç†è¿‡ä¸€äº›ç›‘æ§è¯Šæ–­å·¥å…·ï¼Œå…¶ä¸­æœ‰å¾ˆå¤šå·¥å…·éƒ½å¯ä»¥å¾ˆå¥½çš„ç›‘æ§GCï¼Œå…¶ä¸­å‘½ä»¤è¡Œå·¥å…· <code>jstat -gc</code>ï¼Œ<code>jvisulvm</code>ï¼Œ<code>jmc</code>éƒ½æ˜¯å¯ä»¥å¾ˆæœ‰æ•ˆçš„ç›‘æ§å †ç©ºé—´ä½¿ç”¨ä»¥åŠGCå·¥ä½œæƒ…å†µã€‚è¿™é‡Œå°±è¯¦ç»†ä»‹ç»äº†ï¼Œå¦‚æœæœ‰ä¸å¤ªè®°å¾—äº†çš„æœ‹å‹ï¼Œå¯ä»¥å›å»çœ‹çœ‹ğŸ˜ã€‚å…¶ä¸­æœ€ä¸»è¦ç”¨äºåˆ†æGCçš„GCä¿¡æ¯è¿˜æ˜¯GCæ—¥å¿—ï¼Œæ—¥å¿—ä¸­åŒ…å«äº†GCæœ€å…¨é¢çš„æè¿°ï¼Œå°±æ˜¯GCäº‹å®ä¸Šçš„æ ‡å‡†ï¼Œå¯ä»¥ä½œä¸ºGCæ€§èƒ½è¯„ä¼°çš„æœ€çœŸå®æ•°æ®æ¥æºã€‚GCæ—¥å¿—ä¸€èˆ¬è¾“å‡ºåˆ°æ–‡ä»¶ä¹‹ä¸­ï¼Œæ˜¯çº¯textæ ¼å¼çš„ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ‰“å°åˆ°æ§åˆ¶å°ã€‚æœ‰å¤šä¸ªå¯ä»¥æ§åˆ¶GCæ—¥å¿—çš„JVMå‚æ•°ï¼Œä¾‹å¦‚å¯ä»¥æ‰“å°æ¯æ¬¡GCçš„æŒç»­æ—¶é—´ï¼Œä»¥åŠç¨‹åºæš‚åœæ—¶é—´ï¼ˆ<code>-XX:+PrintGCApplicationStoppedTime</code>ï¼‰ï¼Œè¿˜æœ‰GCæ¸…ç†äº†å¤šå°‘å¼•ç”¨ç±»å‹ï¼ˆ<code>-XX:+PrintReferenceGC</code>ï¼‰ã€‚</p><p>å…¶ä¸­æœ€åŸºç¡€çš„è¦æ‰“å°å‡ºGCæ—¥å¿—ï¼Œéœ€è¦åœ¨å¯åŠ¨å‚æ•°ä¸­æŒ‡å®šä»¥ä¸‹å‚æ•°ï¼ˆå°†æ‰€æœ‰GCäº‹ä»¶æ‰“å°åˆ°æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œè¾“å‡ºæ¯æ¬¡GCçš„æ—¥æœŸå’Œæ—¶é—´æˆ³ã€‚ä¸åŒGCç®—æ³•è¾“å‡ºçš„å†…å®¹ç•¥æœ‰ä¸åŒï¼‰ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">â€XX:+PrintGCTimeStamps â€XX:+PrintGCDateStamps â€XX:+PrintGCDetails â€Xloggc:<span class="hljs-tag">&lt;<span class="hljs-name">filename</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯ä¸€æ®µGCçš„æ—¥å¿—ä¿¡æ¯ï¼Œå…¶ä¸­è®°å½•äº†5æ¬¡GCä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬äº†1æ¬¡youngGCï¼Œè¿˜åŒ…æ‹¬äº†4æ¬¡FullGCã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">30.892</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">18.775</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">920064</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">189402</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1143808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2723073</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2722965</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">3912704</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.3732643</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.52</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.37</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.37</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">31.266</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">19.148</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">189402</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1143808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2533562</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">1984964</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2796544</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2722965</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">1984964</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">3940352</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2764</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2764</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.1733963</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">1.04</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.17</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">34.496</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">22.378</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">954368</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1143808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">1984964</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2171912</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2796544</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">2939332</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2171912</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">3940352</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2777</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2777</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.2171111</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">1.14</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.22</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">38.196</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">26.078</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">954368</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1143808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2171912</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2361421</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2796544</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">3126280</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2361421</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">3940352</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2780</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2780</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.2804937</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">1.44</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.28</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2021</span><span class="hljs-operator">-</span><span class="hljs-number">07</span><span class="hljs-operator">-</span><span class="hljs-number">04</span><span class="hljs-variable">T17</span><span class="hljs-operator">:</span><span class="hljs-number">03</span><span class="hljs-operator">:</span><span class="hljs-number">41.895</span><span class="hljs-operator">-</span><span class="hljs-number">0800</span><span class="hljs-operator">:</span> <span class="hljs-number">29.777</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">954368</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1143808</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">2361421</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2550111</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">2796544</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">3315789</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2550111</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">3940352</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">2782</span><span class="hljs-built_in">K</span><span class="hljs-operator">-&gt;</span><span class="hljs-number">2782</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.2061000</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">1.25</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.21</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„æ—¥å¿—ä¿¡æ¯ä¸­è®°å½•äº†å¦‚ä¸‹çš„ä¿¡æ¯ï¼š</p><ul><li>è¿™ä¸€æ®µæ—¥å¿—æˆªå–è‡ªJVMåå¯åŠ¨çš„18ç§’åˆ°30ç§’çš„åŒºé—´ã€‚</li><li>youngåŒºåŸŸçš„ç©ºé—´å¤§å°æ˜¯ 1143808K å³ 1117MBï¼Œè€å¹´ä»£ç©ºé—´ 2796544K å³ 2731MBï¼Œè¿™ä¸ªå †ç©ºé—´å¤§å°3940352K å³ 3848MBï¼ŒMetaspaceç©ºé—´å¤§å°1032MBã€‚</li><li>åœ¨è¿™ä¸€æ®µGCæ—¥å¿—ä¸­ï¼Œåº”ç”¨æ€»å…±è¿è¡Œäº† 11.0002sï¼ŒæœŸé—´å‘ç”Ÿäº†4æ¬¡GCï¼ˆä¸ç®—æœ€åä¸€æ¬¡GCï¼‰å…¶ä¸­3æ¬¡FullGCå’Œä¸€æ¬¡YoungGCï¼Œå…¶ä¸­GCæ€»æš‚åœæ—¶é—´ä¸º1.25sï¼Œå æ€»è¿è¡Œæ—¶é—´çš„ï½=8.8%ã€‚</li><li>åœ¨ç¬¬ä¸€æ¬¡youngGCä¹‹åï¼Œåç»­çš„GCå…¨éƒ¨ä¸ºFullGCï¼Œå¹¶ä¸”åœ¨æ¯æ¬¡FullGCï¼Œæ•´ä¸ªå †ç©ºé—´çš„å ç”¨ä¾æ—§å‘ˆç°ä¸Šå‡è¶‹åŠ¿ï¼Œå¯ä»¥çœ‹å‡ºå†…å­˜ç©ºé—´å¹¶ä¸èƒ½åŠæ—¶çš„é‡Šæ”¾ã€‚</li></ul><p>é€šè¿‡å¯¹è¿™äº›æ—¥å¿—çš„ç®€å•åˆ†æï¼Œæˆ‘ä»¬åŸºæœ¬å¯ä»¥å¾—å‡ºï¼Œç›®å‰JVMçš„GCæ˜¯ç—…æ€çš„ï¼ŒJVMé¢‘ç¹åœ°è¿›è¡ŒFullGCï¼Œå¹¶ä¸”FullGCåï¼Œå †å†…å­˜ä»ç„¶å‘ˆä¸Šå‡çš„è¶‹åŠ¿ã€‚å¯ä»¥é¢„è§çš„æ˜¯å½“å¢é•¿çš„å†…å­˜ç©ºé—´è¶…è¿‡å †ç©ºé—´å¤§å°ï¼Œåº”ç”¨å°†ä¼šå‡ºç°OOMæˆ–æŒç»­GCæ— æ³•æ­£å¸¸å·¥ä½œçš„æƒ…å†µã€‚</p><p>å½“ç„¶æˆ‘ä»¬è¿˜å¯ä»¥ä»GCæ—¥å¿—ä¸­å¾—åˆ°æ›´å¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚åœ¨æŸä¸ªæ—¶é—´æ®µå†…å†…å­˜çš„åˆ†é…é€Ÿç‡å’Œåƒåœ¾æ”¶é›†é€Ÿç‡ï¼Œåœ¨æ¯æ¬¡åƒåœ¾youngGCåå¯¹è±¡çš„æ™‹å‡é€Ÿç‡ç­‰ç­‰ã€‚ä½†æ˜¯å¦‚æœä¸€èˆ¬ç³»ç»Ÿä¼šäº§ç”Ÿå¤§é‡çš„GCæ—¥å¿—ï¼Œçº¯é äººå·¥å¾ˆéš¾è¿›è¡Œå®Œå…¨åœ°é˜…è¯»å’Œåˆ†æã€‚</p><p>è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±è¦åˆç†çš„åˆ©ç”¨æˆ‘ä»¬çš„GCæ—¥å¿—åˆ†æå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬å……åˆ†åˆ†æè¯Šæ–­GCï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦ä»‹ç»ä¸¤ä¸ªå·¥å…·åœ¨GCè°ƒä¼˜è¿‡ç¨‹ä¸­çš„ä½¿ç”¨ï¼Œä¸€ä¸ªæ˜¯GCViewerï¼Œå¦å¤–ä¸€ä¸ªæ˜¯ GCEasyã€‚</p><h4 id="GCViewer"><a href="#GCViewer" class="headerlink" title="GCViewer"></a>GCViewer</h4><p>GCViewer æ˜¯ä¸€ä¸ªå¼€æºå·¥å…·çš„GCæ—¥å¿—åˆ†æå·¥å…·ã€‚é¡¹ç›®åœ¨ GitHub ä¸»é¡µå„é¡¹æŒ‡æ ‡è¿›è¡Œäº†å®Œæ•´çš„æè¿°ã€‚ä¸‹é¢æˆ‘ä»¬ä»‹ç»ä¸€äº›å¸¸ç”¨æŒ‡æ ‡ã€‚ç¬¬ä¸€æ­¥è·å–GCæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶ä¸”ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰“å¼€ GCViewerï¼Œå¹¶ä¸”å¾—åˆ°ä¸‹é¢çš„ç•Œé¢ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>gcviewer<span class="hljs-number">-1</span>.<span class="hljs-number">36</span>.<span class="hljs-keyword">jar </span>gc.log<br></code></pre></td></tr></table></figure><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210707002631.png"></p><p>å¦‚æœä¸æƒ³æ‰“å¼€ç•Œé¢ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°†GCæ•°æ®å¯¼å‡ºåˆ° summary.cvs å’Œ chart.png ä¸­</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">java -jar gcviewer-<span class="hljs-number">1.36</span><span class="hljs-selector-class">.jar</span> gc<span class="hljs-selector-class">.log</span> <span class="hljs-selector-tag">summary</span><span class="hljs-selector-class">.csv</span> chart.png<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¸€èµ·æ¥ç®€å•çœ‹ä¸‹åˆ†æä¸‹GCViewerè¾“å‡ºçš„æ•°æ®ï¼Œæˆ‘ä»¬å…ˆä»å·¦ä¾§çš„ç¬¬ä¸€ä¸ªtabé¡µå›¾è¡¨ï¼ˆChartï¼‰å¼€å§‹ã€‚GCViewerä½¿ç”¨æŠ˜çº¿å‘æˆ‘ä»¬å±•ç¤ºäº†å†…å­˜ç©ºé—´ä»¥åŠåƒåœ¾æ”¶é›†å™¨çš„å·¥ä½œæƒ…å†µã€‚å…¶ä¸­é»‘è‰²çš„çº¿ä»£è¡¨çš„æ˜¯<code>FullGC</code>ï¼Œæ·±ç´«è‰²çš„çº¿è¡¨ç¤ºå †ç©ºé—´çš„ä½¿ç”¨ï¼Œç»¿è‰²çš„çº¿è¡¨ç¤º<code>GCæ—¶é—´</code>ã€‚å›¾ä¸­ä¸¤ç§é¢œè‰²å¯¹åº”çš„åŒºåŸŸï¼Œå…¶ä¸­é»„è‰²çš„ä»£è¡¨å¹´è½»ä»£ï¼Œç´«è‰²ä»£è¡¨è€å¹´ä»£ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210707004548.png"></p><p>ç¬¬äºŒä¸ªtabé¡µé¢æ˜¯äº‹ä»¶è¯¦æƒ…ï¼ˆEvent detailsï¼‰å…¶ä¸­è®°å½•äº†GCæš‚åœäº‹ä»¶ï¼ˆGC pausesï¼‰ã€FullGCæš‚åœäº‹ä»¶ï¼ˆFull gc pausesï¼‰å’Œå¹¶å‘GCå…¶ä¸­åœ¨GCæš‚åœäº‹ä»¶ä¸­ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è¿™äº›GCäº‹ä»¶çš„<code>åç§°ï¼ˆnameï¼‰</code>ã€<code>æ¬¡æ•°ï¼ˆnï¼‰</code>ã€<code>æœ€å°å€¼ï¼ˆminï¼‰</code>ã€<code>æœ€å¤§å€¼ï¼ˆmaxï¼‰</code>ã€<code>å¹³å‡å€¼ï¼ˆavgï¼‰</code>ã€<code>æ ‡å‡†å·®ï¼ˆstddevï¼‰</code>ã€<code>æ€»æ—¶é—´ï¼ˆsum(s)ï¼‰</code>ã€<code>åˆ†é¡¹æ€»æ—¶é—´å æ¯”ï¼ˆsum(%)ï¼‰</code>ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°GCæš‚åœï¼ˆGC pausesï¼‰è®°å½•çš„æ˜¯YoungGCçš„æš‚åœæ—¶é—´ï¼Œè€ŒFullGCæš‚åœï¼ˆFull GC pausesï¼‰è®°å½•äº†ä¸¤ç±»æš‚åœï¼Œä¸€ç±»æ˜¯åˆ†é…å¤±è´¥çš„FullGCï¼ˆAllocation Failureï¼‰ï¼Œå¦ä¸€ç±»æ˜¯è‡ªé€‚åº”ï¼ˆErgonomicsï¼‰äº§ç”Ÿçš„FullGCã€‚å…¶ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ç»å¤§å¤šæ•°å¤§éƒ¨åˆ†çš„FullGCæ˜¯ç”±è‡ªé€‚åº”è°ƒæ•´å¸¦æ¥çš„FullGCã€‚æˆ‘ä»¬æµ‹è¯•çš„æ˜¯ ParallelGC ï¼ŒGCæ—¶ä¼šå…¨ç¨‹æš‚åœåº”ç”¨çº¿ç¨‹ï¼Œå› æ­¤æ²¡æœ‰å¹¶å‘GCçš„æ•°æ®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210707234907.png"><br>æœ€åä¸€ä¸ªtab è¯­æ³•åˆ†æç¨‹åºï¼ˆParserï¼‰è¿™ä¸ªéƒ¨åˆ†æ˜¯ä¸€ä¸ªç±»ä¼¼æ—¥å¿—è¾“å‡ºçš„çª—å£ï¼Œä½†è¾“å‡ºçš„ä¿¡æ¯æ˜¯GCViewerç‰ˆæœ¬ï¼ŒJVMç‰ˆæœ¬ï¼Œå†…å­˜å¤§å°ï¼Œæ‰§è¡Œå‚æ•°ç­‰ä¿¡æ¯ã€‚å³ä¾§æˆ‘ä»¬æœ‰åŒæ ·ä¹Ÿæœ‰ä¸‰ä¸ªtabé¡µï¼Œè¿™é‡Œè¯¦ç»†çš„æ”¶é›†è®°å½•äº†JVMè¿™æ®µæ—¶é—´å†…çš„å †ç©ºé—´ä¿¡æ¯ï¼Œå’ŒGCæš‚åœä¿¡æ¯ã€‚ç¬¬ä¸€ä¸ªtabé¡µæ˜¯ä¸€ä¸ªæ±‡æ€»ï¼ˆsummary)ä¿¡æ¯ï¼Œå…¶ä¸­å †ç©ºé—´çš„ä½¿ç”¨æƒ…å†µï¼Œæ€»æš‚åœæ—¶é—´ï¼Œæ€»æš‚åœæ¬¡æ•°ã€ååé‡ç­‰å¸¸ç”¨çš„ç»Ÿè®¡æ•°æ®ä¸€ç›®äº†ç„¶ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708000947.png"></p><p>ç¬¬äºŒä¸ªtabé¡µæ˜¯å†…å­˜æœ‰å…³ä¿¡æ¯ï¼ˆMemoryï¼‰ï¼Œè¿™é‡ŒåŒ…æ‹¬å„ä¸ªåˆ†ä»£å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€GCåçš„å†…å­˜é‡Šæ”¾ä¿¡æ¯å’Œå¯¹è¥¿é‚£ä¸ªçš„æ™‹å‡é€Ÿç‡çš„ä¿¡æ¯ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æœ‰æ•ˆçš„åˆ†æå †ç©ºé—´ä¸­å¯¹è±¡çš„å­˜æ´»ä¸å›æ”¶æƒ…å†µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210725173205.png"></p><p>æœ€åä¸€ä¸ªtabé¡µæ˜¯æš‚åœæœ‰å…³ä¿¡æ¯ï¼ˆpauseï¼‰ä»æ€»æš‚åœã€FullGCæš‚åœã€GCæš‚åœè¿™ä¸‰ä¸ªçº¬åº¦ç»Ÿè®¡äº†GCçš„æœ€å¤§ã€æœ€å°å’Œå¹³å‡æš‚åœæ—¶é—´ã€GCé—´éš”æ—¶é—´çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®å¯ä»¥å¸®åŠ©æˆ‘ä»¬å…¨é¢åˆ†æGCçš„æš‚åœæƒ…å†µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708001650.png"></p><p>ä»¥ä¸Šå°±æ˜¯GCViewerå¯¹ä¸€æ¬¡GCæ—¥å¿—çš„åˆ†æç»“æœï¼ŒGCVieweré€šè¿‡GCæ—¥å¿—å¯¹GCçš„å†…å­˜å’Œæš‚åœè¿›è¡Œäº†å……åˆ†çš„åˆ†æï¼Œæ•°æ®åˆ†æåœ°éå¸¸å…¨é¢ã€‚ä½†å¦‚æœè¦è¯´ç¼ºç‚¹çš„è¯ï¼ŒGCViewerçš„UIè®¾è®¡è¿˜æœ‰å¾ˆå¤§çš„æå‡ç©ºé—´ã€‚</p><h4 id="GCEasy"><a href="#GCEasy" class="headerlink" title="GCEasy"></a>GCEasy</h4><p>GCEasyåœ¨å‰é¢çš„æ–‡ç« ä¸­æˆ‘ä»¬åšè¿‡ç®€å•çš„ä»‹ç»ï¼Œä»Šå¤©ä»‹ç»GCçš„åˆ†æç»“æœã€‚é€šè¿‡GCEasyè¾“å‡ºçš„å›¾è¡¨æ•°æ®ï¼Œå¸®åŠ©å¤§å®¶å¿«é€Ÿæœ‰æ•ˆçš„åˆ†æGCæ—¥å¿—ã€‚ç¬¬ä¸€ä¸ªå›¾è¡¨æ˜¯JVMçš„å†…å­˜æ¦‚è§ˆå›¾ï¼Œå·¦ä¾§æ˜¯å›¾è¡¨åŒ…æ‹¬åˆ†é…å†…å­˜é‡ï¼Œå’Œå†…å­˜æœ€å¤§å€¼ï¼Œå³ä¾§æ˜¯æ•°æ®çš„æŸ±çŠ¶å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708231952.png"></p><p>ç¬¬äºŒä¸ªå›¾è¡¨æ˜¯å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆKey Performance Indicatorsï¼‰ï¼Œå…¶ä¸­ä¸»è¦è®°å½•çš„æŒ‡æ ‡æ˜¯ååé‡å’ŒGCæš‚åœçš„å›¾è¡¨æ•°æ®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708232336.png"></p><p>ç¬¬ä¸‰å¼ å›¾æ˜¯äº¤äº’å›¾è¡¨ï¼ˆInteractive Graphsï¼‰ï¼Œå…¶ä¸­<code>Heap after GC</code>è¡¨ç¤ºGCåçš„å †ç©ºé—´å¤§å°ï¼Œ<code>Heap before GC</code>è¡¨ç¤ºGCå‰çš„å †ç©ºé—´å¤§å°ï¼Œ</p><p><code>GC Duration</code>æ˜¯GCçš„æŒç»­æ—¶é—´ï¼Œ<code>Reclaimed Bytes</code>è¡¨ç¤ºGCåå›æ”¶çš„å­—èŠ‚å¤§å°ï¼Œ<code>Young Gen</code>è¡¨ç¤ºyoungåŒºçš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒç†<code>Old Gen</code>è¡¨ç¤ºè€å¹´ä»£çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ<code>Meta Space</code> è¡¨ç¤ºMetaåŒºçš„å†…å­˜ä½¿ç”¨æƒ…å†µæœ€åä¸€ä¸ª<code>A &amp; P</code>è¡¨ç¤ºå¯¹è±¡ä»æ–°ç”Ÿä»£æ™‹å‡åˆ°è€å¹´ä»£çš„æ™‹å‡é€Ÿç‡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708232943.png"></p><p>ç¬¬å››å¼ å›¾è¡¨æ˜¯GCçš„ç»Ÿè®¡æ•°æ®ï¼ˆGC Statisticsï¼‰ï¼ŒæŒ‰ç…§å„ä¸ªä¸åŒçš„çº¬åº¦ç»Ÿè®¡GCçš„æ•°æ®ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»å„ä¸ªè§’åº¦è¯¦ç»†çš„åˆ†æGCã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708234008.png"></p><p>æœ€åçš„ä¸¤å¼ å›¾æ˜¯å¯¹è±¡ç»Ÿè®¡ï¼ˆObject Statsï¼‰å’Œ GCäº§ç”ŸåŸå› ï¼ˆGC Causesï¼‰åˆ†æï¼Œå…¶ä¸­å¯¹è±¡ç»Ÿè®¡è®¡ç®—äº†å¯¹è±¡åˆ›å»ºæ•°é‡å’Œå¯¹è±¡æ™‹å‡çš„æ•°æ®ã€‚è€ŒGCäº§ç”ŸåŸå› åˆ†æé€ æˆGCçš„åŸå› ä»¥åŠç›¸å…³çš„ä¸€äº›GCäº§ç”Ÿæ—¶çš„ä¸€äº›æ•°æ®ç»Ÿè®¡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210708234450.png"><img src="https://gitee.com/realDaiwei/img/raw/master/20210708234435.png"></p><p>ä»¥ä¸Šå°±æ˜¯GCEasyå¯¹â€œæ™®é€šâ€ç”¨æˆ·ä¸Šä¼ çš„GCæ—¥å¿—è¿›è¡Œåˆ†æçš„ç»“æœï¼Œå¦‚æœæƒ³è¦è·å¾—æ›´å¤šçš„æ•°æ®å¯ä»¥è¿›è¡Œå……å€¼ï¼Œä½†æ˜¯è¿™ä¹ˆå¤šçº¬åº¦å’Œè¿™ä¹ˆæ•°æ®åˆ†æè¶³ä»¥è®©æˆ‘ä»¬å®ŒæˆGCé—®é¢˜å®šä½å’ŒGCè°ƒä¼˜ç›®æ ‡è¾¾æˆåˆ¤å®šã€‚ç›¸è¾ƒäºGCViewerï¼ŒGCEasyçš„å›¾è¡¨æ›´åŠ ä¸°å¯Œï¼Œç»“æœå±•ç¤ºæ›´åŠ ç›´è§‚ï¼Œå¹¶ä¸”ä¸ç”¨é¢å¤–ä¸‹è½½è½¯ä»¶ã€‚å¦‚æœé‡åˆ°æ­¤ç±»éœ€æ±‚ï¼Œæˆ‘æ›´å€¾å‘ä½¿ç”¨GCEasyğŸ™ˆã€‚</p><h3 id="GCè°ƒä¼˜å®æˆ˜"><a href="#GCè°ƒä¼˜å®æˆ˜" class="headerlink" title="GCè°ƒä¼˜å®æˆ˜"></a>GCè°ƒä¼˜å®æˆ˜</h3><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»å¯¼è‡´æ€§èƒ½é—®é¢˜çš„å…¸å‹æƒ…å†µï¼Œè¿™äº›ç¤ºä¾‹éƒ½æ˜¯æ¥è‡ªäºç”Ÿäº§ç¯å¢ƒï¼Œä¸ºæ¼”ç¤ºåšäº†ä¸€å®šé•¿åº¦çš„ç²¾ç®€ã€‚</p><blockquote><p><code>Allocation Rate</code> ç¿»è¯‘è¿‡æ¥å°±æ˜¯<code>åˆ†é…é€Ÿç‡</code>ï¼Œè€Œä¸æ˜¯åˆ†é…ç‡ï¼›å› ä¸ºä¸æ˜¯ç™¾åˆ†æ¯”ï¼Œè€Œæ˜¯å•ä½æ—¶é—´å†…åˆ†é…çš„é‡ã€‚</p><p><code>Promotion Rate</code> ç¿»è¯‘ä¸º <code>ææˆé€Ÿç‡</code>ï¼Œå³ä»æ–°ç”Ÿä»£æå‡åˆ°è€å¹´ä»£çš„é€Ÿç‡ã€‚</p></blockquote><h4 id="é«˜åˆ†é…é€Ÿç‡ï¼ˆHigh-Allocation-Rateï¼‰"><a href="#é«˜åˆ†é…é€Ÿç‡ï¼ˆHigh-Allocation-Rateï¼‰" class="headerlink" title="é«˜åˆ†é…é€Ÿç‡ï¼ˆHigh Allocation Rateï¼‰"></a>é«˜åˆ†é…é€Ÿç‡ï¼ˆHigh Allocation Rateï¼‰</h4><p>åˆ†é…é€Ÿç‡ï¼ˆ<code>Allocation rate</code>ï¼‰è¡¨ç¤ºå•ä½æ—¶é—´å†…åˆ†é…çš„å†…å­˜é‡ã€‚é€šå¸¸ä½¿ç”¨<code>MB/sec</code>ä½œä¸ºå•ä½ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>PB/year</code> ç­‰ã€‚åˆ†é…ç‡è¿‡é«˜å°±ä¼šä¸¥é‡å½±å“ç¨‹åºçš„æ€§èƒ½ï¼Œåœ¨JVMä¸­ä¼šå¯¼è‡´å·¨å¤§çš„GCå¼€é”€ã€‚</p><h5 id="å¦‚ä½•æµ‹é‡åˆ†é…é€Ÿç‡"><a href="#å¦‚ä½•æµ‹é‡åˆ†é…é€Ÿç‡" class="headerlink" title="å¦‚ä½•æµ‹é‡åˆ†é…é€Ÿç‡"></a>å¦‚ä½•æµ‹é‡åˆ†é…é€Ÿç‡</h5><p>åœ¨æµ‹è¯•åˆ†é…é€Ÿç‡ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®JVMå‚æ•°ï¼š<code>-XX:+PrintGCDetails -XX:+PrintGCTimeStamps</code>ï¼Œé€šè¿‡GCæ—¥å¿—æ¥è®¡ç®—åˆ†é…é€Ÿç‡ï¼ŒGCæ—¥å¿—å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">0.291</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">33280</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">5088</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">38400</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">33280</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">24360</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">125952</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0365286</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>      <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.11</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">0.446</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">38368</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">5120</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">71680</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">57640</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">46240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">159232</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0456796</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>      <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.15</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.02</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.04</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">0.829</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>            <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">71680</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">5120</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">71680</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">112800</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">81912</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">159232</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0861795</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>      <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.23</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.03</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.09</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>è®¡ç®—<code>ä¸Šä¸€æ¬¡åƒåœ¾æ”¶é›†ä¹‹å</code>ï¼Œä¸<code>ä¸‹ä¸€æ¬¡GCå¼€å§‹ä¹‹å‰</code>çš„å¹´è½»ä»£ä½¿ç”¨é‡ï¼Œä¸¤è€…çš„å·®å€¼é™¤ä»¥æ—¶é—´ï¼Œå°±æ˜¯åˆ†é…é€Ÿç‡ã€‚ç—›æ®´ä¸Šé¢çš„æ—¥å¿—ï¼Œå¯ä»¥è®¡ç®—å‡ºä»¥ä¸‹çš„ä¿¡æ¯ï¼š</p><ul><li>JVMå¯åŠ¨ä¹‹å<code>291ms</code>ï¼Œå…±åˆ›å»ºäº†<code>33280KB</code>çš„å¯¹è±¡ã€‚ç¬¬ä¸€æ¬¡ Minor GCï¼ˆå°å‹GCï¼‰å®Œæˆåï¼Œå¹´è½»ä»£ä¸­è¿˜æœ‰<code>5088KB</code>çš„å¯¹è±¡å­˜æ´»ã€‚</li><li>åœ¨å¯åŠ¨ä¹‹å<code>446ms</code>ï¼Œå¹´è½»ä»£çš„ä½¿ç”¨é‡å¢åŠ åˆ°<code>38368KB</code>ï¼Œè§¦å‘ç¬¬äºŒæ¬¡GCï¼Œè§¦å‘ç¬¬äºŒæ¬¡GCï¼Œå®Œæˆåå¹´è½»ä»£çš„ä½¿ç”¨é‡å‡å°‘åˆ°<code>5129KB</code>ã€‚</li><li>åœ¨å¯åŠ¨ä¹‹å<code>829ms</code>ï¼Œå¹´è½»ä»£çš„ä½¿ç”¨é‡ä¸º<code>71680KB</code>ï¼ŒGCåå˜ä¸º<code>5120KB</code>ã€‚</li></ul><p>é€šè¿‡ä½¿ç”¨å¹´è½»ä»£çš„ä½¿ç”¨é‡æˆ‘ä»¬å¯ä»¥è®¡ç®—åˆ†é…é€Ÿç‡ï¼ˆAllocation druing/ timeï¼‰ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>Event</th><th>TIme</th><th>Young before</th><th>Young after</th><th>Allocation during</th><th>Allocation rate</th></tr></thead><tbody><tr><td>1st GC</td><td>291ms</td><td>33280KB</td><td>5088KB</td><td>33280KB</td><td>144MB/sec</td></tr><tr><td>2nd GC</td><td>446ms</td><td>38368KB</td><td>5120KB</td><td>33280KB</td><td>215MB/sec</td></tr><tr><td>3rd GC</td><td>829ms</td><td>71680KB</td><td>5120KB</td><td>66560KB</td><td>173MB/sec</td></tr><tr><td>Total</td><td>829ms</td><td>N/A</td><td>N/A</td><td>133120KB</td><td>161MB/sec</td></tr></tbody></table><p>é€šè¿‡è¿™äº›ä¿¡æ¯å¯ä»¥çŸ¥é“ï¼Œåœ¨æµ‹é‡æœŸé—´ï¼Œè¯¥ç¨‹åºçš„å†…å­˜åˆ†é…é€Ÿç‡ä¸º<code>161MB/sec</code>ã€‚</p><h5 id="åˆ†é…é€Ÿç‡çš„æ„ä¹‰"><a href="#åˆ†é…é€Ÿç‡çš„æ„ä¹‰" class="headerlink" title="åˆ†é…é€Ÿç‡çš„æ„ä¹‰"></a>åˆ†é…é€Ÿç‡çš„æ„ä¹‰</h5><p>åˆ†é…é€Ÿç‡çš„çš„å˜åŒ–ï¼Œä¼šå¢åŠ æˆ–é™ä½GCæš‚åœçš„é¢‘ç‡ï¼Œä»è€Œå½±å“ååé‡ã€‚ä½†åªæœ‰å¹´è½»ä»£çš„<code>minor GC</code>å—åˆ†é…é€Ÿç‡çš„å½±å“ï¼Œè€å¹´ä»£GCçš„é¢‘ç‡å’ŒæŒç»­æ—¶é—´ä¸å—<code>åˆ†é…é€Ÿç‡ï¼ˆallocation rateï¼‰</code>çš„ç›´æ¥å½±å“ï¼Œè€Œæ”¶åˆ°<code>æå‡é€Ÿç‡ï¼ˆpromotion rateï¼‰</code>çš„å½±å“ã€‚</p><p>ç°åœ¨æˆ‘ä»¬åªå…³å¿ƒ Minor GCçš„æš‚åœï¼ŒæŸ¥çœ‹å¹´è½»ä»£çš„3ä¸ªå†…å­˜æ± ã€‚å› ä¸ºå¯¹è±¡åœ¨EdenåŒºåˆ†é…ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹ Eden åŒºçš„å¤§å°å’Œåˆ†é…é€Ÿç‡çš„å…³ç³»ï¼Œçœ‹çœ‹å¢åŠ  Eden åŒºçš„å®¹é‡ï¼Œèƒ½ä¸èƒ½å‡å°‘Minor GC æš‚åœæ¬¡æ•°ï¼Œä»è€Œä½¿ç¨‹åºèƒ½å¤Ÿç»´æŒæ›´é«˜çš„åˆ†é…é€Ÿç‡ã€‚è¿›è¿‡æˆ‘ä»¬çš„å®éªŒï¼Œé€šè¿‡å‚æ•° <code>-XX:NewSize</code>ã€<code>-XX:MaxNewSize</code>ä»¥åŠ<code>-XX:SurvivorRatio</code> è®¾ç½®ä¸åŒçš„Edenç©ºé—´ï¼Œè¿è¡ŒåŒä¸€ç¨‹åºæ—¶ï¼Œå¯ä»¥å‘ç°ï¼š</p><ul><li>Eden ç©ºé—´ä¸º<code>100MB</code> æ—¶ï¼Œåˆ†é…é€Ÿç‡ä½äº<code>100MB/sec</code>ã€‚</li><li>å°† Eden åŒºå¢åŠ ä¸º<code>1G</code>ï¼Œåˆ†é…é€Ÿç‡ä¹Ÿéšä¹‹å¢é•¿ï¼Œå¤§çº¦ç­‰äº<code>200MB/sec</code>ã€‚</li></ul><p>ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ<strong>å› ä¸ºå‡å°‘GCæš‚åœï¼Œå°±ç­‰ä»·äºå‡å°‘äº†ä»»åŠ¡çº¿çš„æš‚åœï¼Œå°±å¯ä»¥æ›´å¤šçš„å·¥ä½œäº†</strong>ï¼Œä¹Ÿå°±å¯ä»¥åˆ›å»ºæ›´å¤šçš„å¯¹è±¡ï¼Œæ‰€ä»¥å¯¹åŒä¸€åº”ç”¨æ¥è¯´ï¼Œåˆ†é…é€Ÿç‡è¶Šé«˜è¶Šå¥½ã€‚é€šè¿‡è¿™ä¸ªç»“è®ºæˆ‘ä»¬å¯ä»¥å¾—å‡º<strong>â€œ**</strong>EdenåŒºè¶Šå¤§è¶Šå¥½**<strong>â€</strong>è¿™ä¸ªç»“è®ºå‰ï¼Œæˆ‘ä»¬æ³¨æ„åˆ°ï¼Œåˆ†é…é€Ÿç‡å¯èƒ½ä¼šä¹Ÿå¯èƒ½ä¸ä¼šå½±å“ç¨‹åºçš„å®é™…ååé‡ã€‚ååé‡å’Œåˆ†é…é€Ÿç‡æœ‰ä¸€å®šå…³ç³»ï¼Œå› ä¸ºåˆ†é…é€Ÿç‡ä¼šå½±å“MinorGCæš‚åœï¼Œä½†å¯¹äºæ€»ä½“ååé‡çš„å½±å“ï¼Œè¿˜è¦è€ƒè™‘<code>MajorGC</code>æš‚åœï¼Œè€Œä¸”ååé‡çš„å•ä½ä¸æ˜¯<code>MB/s</code>ï¼Œè€Œæ˜¯ç³»ç»Ÿæ‰€å¤„ç†çš„ä¸šåŠ¡é‡ã€‚</p><h5 id="é«˜åˆ†é…ç‡å¯¹JVMçš„å½±å“åŠè§£å†³æ–¹æ¡ˆ"><a href="#é«˜åˆ†é…ç‡å¯¹JVMçš„å½±å“åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="é«˜åˆ†é…ç‡å¯¹JVMçš„å½±å“åŠè§£å†³æ–¹æ¡ˆ"></a>é«˜åˆ†é…ç‡å¯¹JVMçš„å½±å“åŠè§£å†³æ–¹æ¡ˆ</h5><p>é¦–å…ˆï¼Œæˆ‘ä»¬åº”è¯¥æ£€æŸ¥ç¨‹åºçš„ååé‡æ˜¯å¦é™ä½ï¼Œå¦‚æœåˆ›å»ºäº†è¿‡å¤šçš„ä¸´æ—¶å¯¹è±¡ï¼ŒminorGCçš„æ¬¡æ•°å°†ä¼šå¢åŠ ã€‚å¦‚æœå¹¶å‘è¾ƒå¤§ï¼Œåˆ™GCå¯èƒ½ä¼šä¸¥é‡å½±å“ååé‡ã€‚é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼ŒMinorGCä¼šéå¸¸é¢‘ç¹ï¼ŒGCæ—¥å¿—å°†ä¼šåƒä¸‹é¢è¿™æ ·ï¼ŒJVMçš„å¯åŠ¨å‚æ•°ä¸º<code>-XX+PringGCDetails -XX:PringGCTimeStamps -Xmx32m</code>ã€‚</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2.808</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003076</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.819</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003079</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.830</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0002968</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.842</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003374</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.853</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0004672</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.864</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003371</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.875</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003214</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.886</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003374</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.896</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9760</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">32</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10240</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0003588</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶minGC çš„é¢‘ç‡å¤ªé«˜äº†ï¼Œè¿™è¯´æ˜åˆ›å»ºäº†å¤§é‡çš„å¯¹è±¡ã€‚å¦å¤–å¹´è½»åœ¨GCä¹‹åçš„ä½¿ç”¨é‡åˆå¾ˆä½ï¼Œä¹Ÿæ²¡æœ‰FullGCå‘ç”Ÿï¼Œç§ç§è¿¹è±¡è¡¨æ˜ï¼ŒGCå¯¹ååé‡é€ æˆäº†ä¸¥é‡çš„å½±å“ã€‚é‚£ä¹ˆæˆ‘ä»¬è¦å¦‚ä½•å¤„ç†è¿™äº›é—®é¢˜å‘¢ï¼Ÿå…¶å®åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ<strong>åªè¦å¢åŠ å¹´è½»ä»£çš„å¤§å°ï¼Œå³å¯é™ä½åˆ†é…é€Ÿç‡è¿‡é«˜æ‰€é€ æˆçš„å½±å“</strong>ï¼Œå¢åŠ å¹´è½»ä»£å¹¶ä¸ä¼šé™ä½åˆ†é…é€Ÿç‡ï¼Œä½†æ˜¯ä¼šå‡å°‘GCçš„é¢‘ç‡ï¼Œå¦‚æœæ¯æ¬¡GCå‰©ä½™çš„å¯¹è±¡å¾ˆå°‘ï¼ŒGCçš„æŒç»­æ—¶é—´ä¹Ÿä¸ä¼šæ˜æ˜¾çš„å¢é•¿ã€‚å¢åŠ å¹´è½»ä»£æ˜¯å¼€æºçš„æ–¹å¼è§£å†³ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥èŠ‚æµã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­<strong>å°½é‡ä½¿ç”¨åŸºç¡€ç±»å‹ä»£æ›¿åŒ…è£…ç±»å‹ï¼Œä»è€Œå‡å°‘å¯¹è±¡çš„åˆ›å»ºã€‚</strong></p><h4 id="è¿‡æ—©æå‡ï¼ˆPremature-Promotionï¼‰"><a href="#è¿‡æ—©æå‡ï¼ˆPremature-Promotionï¼‰" class="headerlink" title="è¿‡æ—©æå‡ï¼ˆPremature Promotionï¼‰"></a>è¿‡æ—©æå‡ï¼ˆPremature Promotionï¼‰</h4><p><code>æå‡é€Ÿç‡ï¼ˆpromotion rateï¼‰</code>ï¼Œç”¨äº<strong>è¡¡é‡å•ä½æ—¶é—´å†…ä»å¹´è½»ä»£æå‡åˆ°è€å¹´ä»£çš„æ•°æ®é‡</strong>ï¼Œä¸€èˆ¬ç”¨<code>MB/sec</code>ä½œä¸ºå•ä½å’Œåˆ†é…é€Ÿç‡ç±»ä¼¼ã€‚JVMä¼šå°†é•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡ä»å¹´è½»ä»£æå‡åˆ°è€å¹´ä»£ã€‚æ ¹æ®åˆ†ä»£å‡è®¾ï¼Œå¯èƒ½å­˜åœ¨ä¸€ç§æƒ…å†µï¼Œè€å¹´ä»£ä¸­ä¸ä»…æœ‰å­˜æ´»æ—¶é—´é•¿çš„å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½å­˜åœ¨å­˜æ´»æ—¶é—´çŸ­çš„å¯¹è±¡ã€‚å› æ­¤<strong>è¿‡æ—©æå‡å³å¯¹è±¡å­˜æ´»æ—¶é—´è¿˜ä¸å¤Ÿé•¿çš„æ—¶å€™å°±è¢«æå‡åˆ°è€å¹´ä»£ã€‚</strong>majorGC ä¸æ˜¯ä¸ºé¢‘ç¹å›æ”¶è€Œè®¾è®¡çš„ï¼Œä½† majorGCç°åœ¨ä¹Ÿè¦æ¸…ç†è¿™äº›ç”Ÿå‘½çŸ­æš‚çš„å¯¹è±¡ï¼Œå°±ä¼šå¯¼è‡´GCæš‚åœæ—¶é—´è¿‡é•¿ï¼Œè¿™ä¼š<strong>ä¸¥é‡å½±å“ç³»ç»Ÿçš„ååé‡**</strong>ã€‚**</p><h5 id="å¦‚ä½•æµ‹é‡æå‡é€Ÿç‡"><a href="#å¦‚ä½•æµ‹é‡æå‡é€Ÿç‡" class="headerlink" title="å¦‚ä½•æµ‹é‡æå‡é€Ÿç‡"></a>å¦‚ä½•æµ‹é‡æå‡é€Ÿç‡</h5><p>å¯ä»¥æŒ‡å®šJVMå‚æ•°<code>-XX:+PrintGCTimeStamps</code>ï¼Œé€šè¿‡GCæ—¥å¿—æ¥æµ‹é‡æå‡é€Ÿç‡ï¼ŒJVMè®°å½•çš„GCæš‚åœä¿¡æ¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2.176</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>                                <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>                <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">10020</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">9042</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">19236</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">9042</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0036840</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.394</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>                                <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>                <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9042</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">8064</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">18258</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">8064</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0032855</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.611</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>                                <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>                                <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">8064</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">7085</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">17280</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">7085</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0031675</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.817</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>                                <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">0</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>                <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">7085</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">6107</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">16301</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">6107</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0030652</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„æ—¥å¿—å¯ä»¥å¾—çŸ¥ï¼šGCä¹‹å‰å’Œä¹‹åçš„å¹´è½»ä»£ä½¿ç”¨é‡ä»¥åŠå †å†…å­˜ä½¿ç”¨é‡ã€‚è¿™æ ·å°±å¯ä»¥é€šè¿‡å·®å€¼ç®—å‡ºè€å¹´ä»£çš„ä½¿ç”¨é‡ï¼ŒGCæ—¥å¿—ä¸­çš„ä¿¡æ¯å¯ä»¥è¡¨è¿°ä¸ºï¼š</p><table><thead><tr><th>Event</th><th>TIme</th><th>Young descreased</th><th>Total descreased</th><th>Promoted</th><th>Promotion rate</th></tr></thead><tbody><tr><td>äº‹ä»¶</td><td>è€—æ—¶</td><td>å¹´è½»å‡å°‘</td><td>æ•´ä¸ªå †å†…å­˜å‡å°‘</td><td>æå‡é‡</td><td>æå‡é€Ÿç‡</td></tr><tr><td>1st GC</td><td>291ms</td><td>28192K</td><td>8920K</td><td>19272K</td><td>66.2MB/sec</td></tr><tr><td>2nd GC</td><td>446ms</td><td>33248K</td><td>11400K</td><td>21848K</td><td>140.95MB/sec</td></tr><tr><td>3rd GC</td><td>829ms</td><td>66560K</td><td>30888K</td><td>35672K</td><td>93.14MB/sec</td></tr><tr><td>Total</td><td>829ms</td><td></td><td></td><td>76792K</td><td>92.63MB/sec</td></tr></tbody></table><p>ä¹ä¸€çœ‹ä¼¼ä¹ä¸æ˜¯è¿‡æ—©æå‡çš„é—®é¢˜ã€‚äº‹å®ä¸Šï¼Œåœ¨æ¯æ¬¡GCä¹‹åè€å¹´ä»£çš„ä½¿ç”¨ç‡ä¼¼ä¹åœ¨å‡å°‘ã€‚ä½†åè¿‡æ¥æƒ³ï¼Œè¦æ˜¯æ²¡æœ‰å¯¹è±¡æå‡æˆ–æå‡ç‡å¾ˆå°ï¼Œä¹Ÿå°±ä¸ä¼šçœ‹åˆ°é‚£ä¹ˆå¤šçš„FullGCäº†ã€‚ç®€å•è§£é‡Šä¸€ä¸‹è¿™é‡Œçš„GCè¡Œä¸ºï¼šæœ‰<strong>å¾ˆå¤šå¯¹è±¡æå‡åˆ°è€å¹´ä»£ï¼ŒåŒæ—¶è€å¹´ä»£ä¸­ä¹Ÿæœ‰å¾ˆå¤šå¯¹è±¡è¢«å›æ”¶äº†ï¼Œè¿™å°±æ˜¯é€ æˆäº†è€å¹´ä»£ä½¿ç”¨é‡å‡å°‘çš„å‡æ€§ï¼Œä½†äº‹å®æ˜¯å¤§é‡çš„å¯¹è±¡ä¸æ–­åœ°è¢«æå‡åˆ°è€å¹´ä»£ï¼Œå¹¶è§¦å‘ fullGCã€‚</strong></p><h5 id="æå‡é€Ÿç‡çš„æ„ä¹‰"><a href="#æå‡é€Ÿç‡çš„æ„ä¹‰" class="headerlink" title="æå‡é€Ÿç‡çš„æ„ä¹‰"></a>æå‡é€Ÿç‡çš„æ„ä¹‰</h5><p>å’Œåˆ†é…é€Ÿç‡ä¸€æ ·ï¼Œæå‡é€Ÿç‡ä¹Ÿä¼šå½±å“GCæš‚åœçš„é¢‘ç‡ã€‚ä½†æ˜¯åˆ†é…é€Ÿç‡ä¸»è¦å½±å“ MinorGCï¼Œè€Œæå‡é€Ÿç‡åˆ™ç›´æ¥å½±å“ Major GCçš„é¢‘ç‡ã€‚æœ‰å¤§é‡çš„å¯¹è±¡æå‡ï¼Œè‡ªç„¶å¾ˆå¿«å°†è€å¹´ä»£å¡æ»¡ï¼Œè€å¹´ä»£å¡«å……çš„è¶Šå¿«ï¼Œåˆ™Major GCäº‹ä»¶çš„é¢‘ç‡ä¹Ÿå°±è¶Šé«˜ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210723234555.png"></p><p>æ­¤å‰æˆ‘ä»¬ä»‹ç»è¿‡ï¼ŒfullGC é€šå¸¸éœ€è¦æ›´å¤šçš„æ—¶é—´ï¼Œå› ä¸ºéœ€è¦å¤„ç†æ›´å¤šçš„å¯¹è±¡ï¼Œè¿˜éœ€è¦æ‰§è¡Œç¢ç‰‡æ•´ç†ç­‰é¢å¤–çš„å¤æ‚è¿‡ç¨‹ã€‚é€šå¸¸è¿‡æ—©æå‡çš„ç—‡çŠ¶è¡¨ç°ä¸ºä»¥ä¸‹çš„å½¢å¼ï¼š</p><ul><li><strong>çŸ­æ—¶é—´å†…é¢‘ç¹åœ°æ‰§è¡ŒFullGCã€‚</strong></li><li><strong>æ¯æ¬¡FullGCåè€å¹´ä»£çš„ä½¿ç”¨ç‡éƒ½éå¸¸ä½ï¼Œéƒ½åœ¨10%ï½20%æˆ–ä»¥ä¸‹ã€‚</strong></li><li><strong>æå‡é€Ÿç‡æ¥è¿‘äºåˆ†é…é€Ÿç‡ã€‚</strong></li></ul><h5 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h5><p>ç®€å•æ¥è¯´ï¼Œè¦è§£å†³è¿™ç±»é—®é¢˜ï¼Œéœ€è¦è®©å¹´è½»ä»£å­˜æ”¾å¾—ä¸‹æš‚å­˜çš„æ•°æ®ã€‚æœ‰ä¸¤ç§ç®€å•çš„æ–¹æ³•ï¼š</p><ul><li><strong>å¢åŠ å¹´è½»ä»£çš„å¤§å°ã€‚</strong>è®¾ç½®JVMå¯åŠ¨å‚æ•°ï¼Œç±»ä¼¼è¿™æ ·ï¼š<code>-Xmx64m -XX:NewSize=32m</code>ï¼Œç¨‹åºåœ¨æ‰§è¡Œæ—¶ï¼ŒFull GC çš„æ¬¡æ•°è‡ªç„¶ä¼šå‡å°‘å¾ˆå¤šï¼Œåªä¼š minorGC çš„æŒç»­æ—¶é—´äº§ç”Ÿå½±å“ï¼š</li></ul><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2.251</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>                    <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">28672</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">3872</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">28672</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">37126</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">12358</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">61440</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0008543</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br><span class="hljs-number">2.776</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Allocation</span> <span class="hljs-built_in">Failure</span><span class="hljs-punctuation">)</span> <br>                    <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">28448</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">4096</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">28672</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">36934</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">16974</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">61440</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0033022</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><ul><li><strong>å‡å°‘æ¯æ¬¡æ‰¹å¤„ç†çš„æ•°é‡</strong>ã€‚ä¹Ÿèƒ½å¾—åˆ°ç±»ä¼¼çš„ç»“æœï¼Œè‡³äºé€‰ç”¨é‚£ä¸ªæ–¹æ¡ˆï¼Œè¦æ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸šåŠ¡é€»è¾‘ä¸å…è®¸å‡å°‘æ‰¹å¤„ç†çš„æ•°é‡ï¼Œé‚£å°±åªèƒ½å¢åŠ å †å†…å­˜ï¼Œæˆ–è€…é‡æ–°æŒ‡å®šå¹´è½»ä»£çš„å¤§å°ã€‚</li></ul><p>å¦‚æœéƒ½ä¸å¯è¡Œï¼Œå°±åªèƒ½ä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ã€‚ä½†æ€»ä½“ç›®æ ‡ä¾ç„¶æ˜¯ä¸€è‡´çš„ï¼Œè®©ä¸´æ—¶æ•°æ®èƒ½å¤Ÿåœ¨å¹´è½»ä»£å­˜æ”¾çš„ä¸‹ã€‚</p><blockquote><p>èƒ½åœ¨å¹´è½»ä»£å°±å°½é‡ä¸è¦æå‡åˆ°è€å¹´ä»£ï¼Œä»è€Œé¿å…è¿‡æ—©æå‡ã€‚</p></blockquote><h4 id="Weakï¼ŒSoft-åŠ-Phantom-å¼•ç”¨"><a href="#Weakï¼ŒSoft-åŠ-Phantom-å¼•ç”¨" class="headerlink" title="Weakï¼ŒSoft åŠ Phantom å¼•ç”¨"></a>Weakï¼ŒSoft åŠ Phantom å¼•ç”¨</h4><p>å¦ä¸€ç±»å½±å“GCçš„é—®é¢˜æ˜¯ç¨‹åºä¸­ä¸­çš„<code>non-strongå¼•ç”¨</code>ã€‚è™½ç„¶è¿™ç±»å¼•ç”¨åœ¨å¾ˆå¤šæƒ…å†µä¸‹å¯ä»¥é¿å…å‡ºç°<code>OutOfMemoryError</code>ï¼Œä½†è¿‡é‡ä½¿ç”¨ä¹Ÿä¼šå¯¹GCé€ æˆä¸¥é‡çš„å½±å“ï¼Œåè€Œé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚</p><h5 id="å¼±å¼•ç”¨çš„ç¼ºç‚¹"><a href="#å¼±å¼•ç”¨çš„ç¼ºç‚¹" class="headerlink" title="å¼±å¼•ç”¨çš„ç¼ºç‚¹"></a>å¼±å¼•ç”¨çš„ç¼ºç‚¹</h5><p>é¦–å…ˆï¼Œ<code>å¼±å¼•ç”¨(weak reference)</code> æ˜¯å¯ä»¥è¢«GCå¼ºåˆ¶å›æ”¶çš„ã€‚å½“åƒåœ¾æ”¶é›†å™¨å‘ç°ä¸€ä¸ªå¼±å¯è¾¾å¯¹è±¡(weakly reachable å³æŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨åªå‰©ä¸‹å¼±å¼•ç”¨) æ—¶ï¼Œå°±ä¼šå°†å…¶ç½®å…¥ç›¸åº”çš„<code>ReferenceQueue</code>ä¸­ï¼Œå˜æˆå¯ç»ˆç»“çš„å¯¹è¥¿é‚£ä¸ªï¼Œä¹‹åå¯èƒ½éå†è¿™ä¸ª reference queueï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ¸…ç†ã€‚å…¸å‹çš„ç¤ºä¾‹æ˜¯æ¸…é™¤ç¼“å­˜ä¸­ä¸å†å¼•ç”¨çš„KEYã€‚å½“ç„¶ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†è¯¥å¯¹è±¡èµ‹å€¼ç»™æ–°çš„å¼ºå¼•ç”¨ï¼Œåœ¨æœ€åç»ˆç»“å’Œå›æ”¶å‰ï¼ŒGCä¼šåœ¨æ­¤ç¡®è®¤è¯¥å¯¹è±¡æ˜¯å¦å¯ä»¥å®‰å…¨å›æ”¶ã€‚å› æ­¤ï¼Œå¼±å¼•ç”¨å¯¹è±¡çš„å›æ”¶è¿‡ç¨‹æ˜¯æ¨ªè·¨å¤šä¸ªGCå‘¨æœŸçš„ã€‚å®é™…ä¸Š<strong>å¼±å¼•ç”¨ä½¿ç”¨çš„å¾ˆå¤šï¼Œå¤§éƒ¨åˆ†ç¼“å­˜æ¡†æ¶(caching solution) éƒ½æ˜¯åŸºäºå¼±å¼•ç”¨å®ç°çš„</strong>ï¼Œæ‰€ä»¥è™½ç„¶ä¸šåŠ¡ä»£ç ä¸­æ²¡æœ‰ç›´æ¥ä½¿ç”¨å¼±å¼•ç”¨ï¼Œä½†æ˜¯ç¨‹åºä¸­ä¾ç„¶å¤§é‡å­˜åœ¨ã€‚å…¶æ¬¡ï¼Œ<code>è½¯å¼•ç”¨</code>(soft reference)<strong>æ¯”å¼±å¼•ç”¨æ›´éš¾è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ï¼Œå›æ”¶è½¯å¼•ç”¨æ²¡æœ‰ç¡®åˆ‡çš„æ—¶é—´ç‚¹ï¼Œç”±JVMè‡ªå·±å†³å®šï¼Œä¸€èˆ¬åªä¼šåœ¨å³å°†è€—å°½å¯ç”¨å†…å­˜æ—¶ï¼Œæ‰ä¼šå›æ”¶è½¯å¼•ç”¨ï¼Œä»¥ä½œæœ€åæ‰‹æ®µ</strong>ã€‚è¿™æ„å‘³ç€ï¼Œå¯èƒ½ä¼šæœ‰æ›´é¢‘ç¹çš„ fullGCï¼Œæš‚åœæ—¶é—´ä¹Ÿæ¯”é¢„æœŸæ›´é•¿ï¼Œå› ä¸ºè€å¹´ä»£ä¸­çš„å­˜æ´»å¯¹è±¡ä¼šå¾ˆå¤šã€‚æœ€åï¼Œ<strong>ä½¿ç”¨è™šå¼•ç”¨ï¼ˆphantom referenceï¼‰æ—¶ï¼Œå¿…é¡»æ‰‹åŠ¨è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œä»¥æ ‡è¯†è¿™äº›å¯¹è±¡æ˜¯å¦å¯ä»¥å®‰å…¨åœ°å›æ”¶</strong>ï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥å¾ˆæ­£å¸¸ï¼Œä½†å®é™…ä¸Šå¹¶ä¸æ˜¯ã€‚javadoc ä¸­å†™åˆ°ï¼š</p><blockquote><p>In order to ensure that a reclaimable object remains so, the referent of a phantom reference may not be </p><p>retrieved: The get method of a phantom reference always returns null. (ä¸ºäº†é˜²æ­¢å¯å›æ”¶å¯¹è±¡çš„æ®‹ç•™ï¼Œè™šå¼•ç”¨å¯¹è±¡ä¸åº”è¯¥è¢«è·å–<code>phantom reference</code> çš„ <code>get</code> æ–¹æ³•è¿”å›å€¼æ°¸è¿œæ˜¯<code>null</code>)ã€‚</p></blockquote><p>ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œå¾ˆå¤šå¼€å‘è¿™æ›´å®¹æ˜“å¿½ç•¥ä¸‹é¢ä¸€æ®µå†…å®¹ï¼ˆè¿™æ‰æ˜¯é‡ç‚¹ï¼‰ï¼š</p><blockquote><p>Unlike soft and weak references, phantom references are not automatically cleared by the garbage collector as they are enqueued. An object that is reachable via phantom references will remain so until all such references are cleared or themselves become unreachable.(ä¸è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨ä¸åŒï¼Œè™šå¼•ç”¨ä¸ä¼šè¢«è¢«GCè‡ªåŠ¨æ¸…é™¤ï¼Œå› ä¸ºä»–ä»¬è¢«å­˜æ”¾åœ¨é˜Ÿåˆ—ä¸­ï¼Œé€šè¿‡è™šå¼•ç”¨å¯è¾¾å¯¹è±¡ä¼šç»§ç»­å­˜åœ¨å†…ä»ä¸­ï¼Œç›´åˆ°è°ƒæ­¤å¼•ç”¨çš„ clear æ–¹æ³•ï¼Œæˆ–è€…å¼•ç”¨è‡ªèº«å˜ä¸ºä¸å¯è¾¾)ã€‚</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>æˆ‘ä»¬å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ clear() æ¥æ¸…é™¤è™šå¼•ç”¨ï¼Œå¦åˆ™å¯èƒ½é€ æˆOutOfMemeoryError è€Œå¯¼è‡´JVMæŒ‚æ‰</strong>ï¼Œä½¿ç”¨è™šå¼•ç”¨çš„ç†ç”±æ˜¯ï¼Œå¯¹äºç”¨ç¼–ç¨‹æ‰‹æ®µæ¥è·Ÿè¸ªæŸä¸ªå¯¹è±¡ä½•æ—¶å˜ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œè¿™æ˜¯å”¯ä¸€çš„å¸¸è§„æ‰‹æ®µã€‚<strong>å’Œè½¯å¼•ç”¨/å¼±å¼•ç”¨ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬ä¸èƒ½å¤æ´»è™šå¯è¾¾ï¼ˆphantom-reachableï¼‰å¯¹è±¡</strong>ã€‚</p><h5 id="ä½¿ç”¨éå¼ºå¼•ç”¨çš„å½±å“"><a href="#ä½¿ç”¨éå¼ºå¼•ç”¨çš„å½±å“" class="headerlink" title="ä½¿ç”¨éå¼ºå¼•ç”¨çš„å½±å“"></a>ä½¿ç”¨éå¼ºå¼•ç”¨çš„å½±å“</h5><p>å»ºè®®ä½¿ç”¨JVMå‚æ•° <code>-XX:+PrintReferenceGC</code> æ¥çœ‹çœ‹å„ç§å¼•ç”¨å¯¹GCçš„å½±å“ï¼Œå¦‚æœå°†æ­¤å‚æ•°ç”¨äºå¯åŠ¨ï¼Œå°†ä¼šçœ‹åˆ°ï¼š</p><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-number">2.173</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>        <span class="hljs-number">2.234</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">SoftReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000151</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.234</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">WeakReference</span><span class="hljs-operator">,</span> <span class="hljs-number">2648</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0001714</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.234</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">FinalReference</span><span class="hljs-operator">,</span> <span class="hljs-number">1</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000037</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.234</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PhantomReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000039</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.234</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">JNI</span> <span class="hljs-variable">Weak</span> <span class="hljs-variable">Reference</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000027</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">8676</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12115</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">12115</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">21331</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">20792</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3725</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">3725</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0766685</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.49</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.08</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <br><span class="hljs-number">2.250</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>        <span class="hljs-number">2.307</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">SoftReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000173</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.307</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">WeakReference</span><span class="hljs-operator">,</span> <span class="hljs-number">2298</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0001535</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.307</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">FinalReference</span><span class="hljs-operator">,</span> <span class="hljs-number">3</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000043</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.307</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PhantomReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000042</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.307</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">JNI</span> <span class="hljs-variable">Weak</span> <span class="hljs-variable">Reference</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000029</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9215</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">8747</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12115</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">12115</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">21331</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">20863</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3725</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">3725</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0734832</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.52</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.07</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <br><span class="hljs-number">2.323</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-built_in">Full</span> <span class="hljs-variable">GC</span> <span class="hljs-punctuation">(</span><span class="hljs-variable">Ergonomics</span><span class="hljs-punctuation">)</span> <br>        <span class="hljs-number">2.383</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">SoftReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000161</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.383</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">WeakReference</span><span class="hljs-operator">,</span> <span class="hljs-number">1981</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0001292</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.383</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">FinalReference</span><span class="hljs-operator">,</span> <span class="hljs-number">16</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000049</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.383</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">PhantomReference</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0</span> <span class="hljs-variable">refs</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000040</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>    <span class="hljs-number">2.383</span><span class="hljs-operator">:</span> <span class="hljs-punctuation">[</span><span class="hljs-variable">JNI</span> <span class="hljs-variable">Weak</span> <span class="hljs-variable">Reference</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0000027</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">PSYoungGen</span><span class="hljs-operator">:</span> <span class="hljs-number">9216</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">8809</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">10752</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">ParOldGen</span><span class="hljs-operator">:</span> <span class="hljs-number">12115</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">12115</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">12288</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span> <span class="hljs-number">21331</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">20925</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">23040</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-operator">,</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-variable">Metaspace</span><span class="hljs-operator">:</span> <span class="hljs-number">3725</span><span class="hljs-built_in">K</span>â€<span class="hljs-operator">&gt;</span><span class="hljs-number">3725</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">(</span><span class="hljs-number">1056768</span><span class="hljs-built_in">K</span><span class="hljs-punctuation">)</span><span class="hljs-punctuation">]</span><span class="hljs-operator">,</span> <span class="hljs-number">0.0738414</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span> <br>   <span class="hljs-punctuation">[</span><span class="hljs-built_in">Times</span><span class="hljs-operator">:</span> <span class="hljs-variable">user</span><span class="hljs-operator">=</span><span class="hljs-number">0.52</span> <span class="hljs-variable">sys</span><span class="hljs-operator">=</span><span class="hljs-number">0.01</span><span class="hljs-operator">,</span> <span class="hljs-variable">real</span><span class="hljs-operator">=</span><span class="hljs-number">0.08</span> <span class="hljs-variable">secs</span><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure><p>åªæœ‰ç¡®è®¤äº†GCå¯¹åº”çš„ååé‡å’Œå»¶è¿Ÿé€ æˆå½±å“ä¹‹åï¼Œæ‰åº”è¯¥èŠ±å¿ƒæ€æ¥åˆ†æè¿™äº›ä¿¡æ¯ï¼Œå®¡æŸ¥è¿™éƒ¨åˆ†æ—¥å¿—ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œæ¯æ¬¡GCæ¸…ç†çš„å¼•ç”¨æ•°æ®éƒ½æ˜¯å¾ˆå°‘çš„ï¼Œå‘éƒ¨åˆ†æƒ…å†µä¸‹ä¸º<code>0</code>ï¼Œå¦‚æœGCèŠ±äº†è¾ƒå¤šçš„æ—¶é—´æ¥æ¸…ç†è¿™ç±»å¼•ç”¨ï¼Œæˆ–è€…æ¸…ç†äº†å¾ˆå¤šçš„æ­¤ç±»å¼•ç”¨ï¼Œå°±éœ€è¦è¿›ä¸€æ­¥è§‚å¯Ÿåˆ†æäº†ã€‚</p><h5 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h5><p>å¦‚æœç¨‹åºç¡®å®ç¢°åˆ°äº†<code>mis-</code>, <code>ab-</code> é—®é¢˜æˆ–è€…æ»¥ç”¨ weekï¼Œsoftï¼Œphantomå¼•ç”¨ï¼Œä¸€èˆ¬éƒ½è¦ä¿®æ”¹ç¨‹åºçš„å®ç°é€»è¾‘ã€‚æ¯ä¸ªç³»ç»Ÿä¸ä¸€æ ·ï¼Œå› æ­¤å¾ˆéš¾æä¾›é€šç”¨çš„çŸ¥é“å»ºè®®ï¼Œä½†æ˜¯æœ‰ä¸€äº›é€šç”¨çš„åŠæ³•ï¼š</p><ul><li><code>å¼±å¼•ç”¨(week reference)</code> å¦‚æœæŸä¸ªå†…å­˜æ± çš„ä½¿ç”¨é‡å¢å¤§ï¼Œé€ æˆäº†æ€§èƒ½é—®é¢˜ï¼Œé‚£ä¹ˆå¢åŠ å†…å­˜æ± çš„å¤§å°ï¼ˆå¯èƒ½ä¹Ÿè¦å¢åŠ å †å†…å­˜çš„æœ€å¤§å®¹é‡ï¼‰ã€‚å¦‚ç¤ºä¾‹ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå¢åŠ å †å†…å­˜å¤§å°ï¼Œä»¥åŠå¹´è½»ä»£çš„å¤§å°ï¼Œå¯ä»¥å‡è½»ç—‡çŠ¶ã€‚</li><li><code>è½¯å¼•ç”¨(soft reference)</code> å¦‚æœç¡®å®šé—®é¢˜çš„æ ¹æºæ˜¯è½¯å¼•ç”¨ï¼Œå”¯ä¸€çš„è§£å†³åŠæ³•æ˜¯ä¿®æ”¹ç¨‹åºæºç ï¼Œæ”¹å˜å†…éƒ¨å®ç°é€»è¾‘ã€‚</li><li><code>è™šå¼•ç”¨(Phantom reference)</code> è¯·ç¡®ä¿åœ¨ç¨‹åºä¸­è°ƒç”¨äº†è™šå¼•ç”¨çš„<code>clear</code>æ–¹æ³•ã€‚ç¼–ç¨‹ä¸­å¾ˆå®¹æ˜“å¿½ç•¥æŸäº›è™šå¼•ç”¨ï¼Œæˆ–è€…æ¸…ç†çš„é€Ÿåº¦è·Ÿä¸ä¸Šç”Ÿäº§çš„é€Ÿåº¦ï¼Œåˆæˆ–è€…æ¸…æ¥šå¼•ç”¨é˜Ÿåˆ—çš„çº¿ç¨‹æŒ‚äº†ï¼Œå°±ä¼šå¯¹GCé€ æˆå¾ˆå¤§å‹åŠ›ï¼Œæœ€ç»ˆå¼•èµ·<code>OutOfMemeoryError</code>ã€‚</li></ul><h4 id="å·¨æ— éœ¸å¯¹è±¡çš„åˆ†é…-Humongous-Allocation"><a href="#å·¨æ— éœ¸å¯¹è±¡çš„åˆ†é…-Humongous-Allocation" class="headerlink" title="å·¨æ— éœ¸å¯¹è±¡çš„åˆ†é…(Humongous Allocation)"></a>å·¨æ— éœ¸å¯¹è±¡çš„åˆ†é…(Humongous Allocation)</h4><p>å¦‚æœä½¿ç”¨G1åƒåœ¾æ”¶é›†ç®—æ³•ï¼›ä¼šäº§ç”Ÿä¸€ç§å·¨æ— éœ¸å¯¹è±¡å¼•èµ·çš„GCæ€§èƒ½é—®é¢˜ã€‚</p><blockquote><p>è¯´æ˜ åœ¨G1ä¸­ï¼Œå·¨æ— éœ¸å¯¹è±¡æ˜¯æŒ‡æ‰€å ç©ºé—´è¶…è¿‡ä¸€ä¸ªå°å †åŒº(region) <code>50%</code> çš„å¯¹è±¡ã€‚</p></blockquote><p>é¢‘ç¹åˆ›å»ºå·¨æ— éœ¸å¯¹è±¡ï¼Œæ— ç–‘ä¼šé€ æˆGCçš„æ€§èƒ½é—®é¢˜ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹G1çš„å¤„ç†æ–¹å¼ï¼š</p><ul><li>å¦‚æœ region ä¸­å«æœ‰å·¨æ— éœ¸å¯¹è±¡ï¼Œåˆ™å·¨æ— éœ¸å¯¹è±¡åé¢çš„ç©ºé—´å°†ä¸ä¼šè¿›è¡Œåˆ†é…ã€‚å¦‚æœæ‰€æœ‰å·¨æ— éœ¸å¯¹è±¡éƒ½è¶…è¿‡æŸä¸ªæ¯”ä¾‹ï¼Œåˆ™æœªä½¿ç”¨ç©ºé—´å°±ä¼šå¼•å‘å†…å­˜ç¢ç‰‡é—®é¢˜ã€‚</li><li>G1 æ²¡æœ‰å¯¹å·¨æ— éœ¸å¯¹è±¡è¿›è¡Œä¼˜åŒ–ã€‚è¿™åœ¨JDK8ä»¥å‰æ˜¯ä¸€ä¸ªç‰¹åˆ«æ£˜æ‰‹çš„é—®é¢˜â€”â€”åœ¨Java1.8u4.0ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå·¨æ— éœ¸å¯¹è±¡æ‰€åœ¨regionçš„å›æ”¶åªèƒ½åœ¨fullGCä¸­è¿›è¡Œã€‚æœ€æ–°ç‰ˆæœ¬çš„Hotspot JVMï¼Œåœ¨marking é˜¶æ®µä¹‹åçš„ cleanup é˜¶æ®µä¸­é‡Šæ”¾å·¨æ— éœ¸åŒºé—´ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜åœ¨æ–°ç‰ˆæœ¬JVMä¸­çš„å½±å“å·²å¤§å¤§é™ä½ã€‚</li></ul><p>å¦‚æœå­˜åœ¨å·¨æ— éœ¸å¯¹è±¡åˆ†é…é—®é¢˜ä¼šè¾“å‡ºå¦‚ä¸‹æ—¥å¿—ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">0.106:</span> [<span class="hljs-string">G1Ergonomics</span> <span class="hljs-string">(Concurrent</span> <span class="hljs-string">Cycles)</span> <br>                <span class="hljs-string">request</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">cycle</span> <span class="hljs-string">initiation</span>, <br>        <span class="hljs-attr">reason:</span> <span class="hljs-string">occupancy</span> <span class="hljs-string">higher</span> <span class="hljs-string">than</span> <span class="hljs-string">threshold</span>, <br>        <span class="hljs-attr">occupancy:</span> <span class="hljs-number">60817408</span> <span class="hljs-string">bytes</span>, <span class="hljs-attr">allocation request:</span> <span class="hljs-number">1048592</span> <span class="hljs-string">bytes</span>, <br>        <span class="hljs-attr">threshold:</span> <span class="hljs-number">60397965</span> <span class="hljs-string">bytes</span> <span class="hljs-string">(45.00</span> <span class="hljs-string">%)</span>, <span class="hljs-attr">source:</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">humongous</span> <span class="hljs-string">allocation</span>] <br><span class="hljs-attr">0.106:</span> [<span class="hljs-string">G1Ergonomics</span> <span class="hljs-string">(Concurrent</span> <span class="hljs-string">Cycles)</span> <span class="hljs-string">request</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">cycle</span> <span class="hljs-string">initiation</span>, <br>                <span class="hljs-attr">reason:</span> <span class="hljs-string">requested</span> <span class="hljs-string">by</span> <span class="hljs-string">GC</span> <span class="hljs-string">cause</span>, <span class="hljs-attr">GC cause:</span> <span class="hljs-string">G1</span> <span class="hljs-string">Humongous</span> <span class="hljs-string">Allocation</span>] <br><span class="hljs-attr">0.106:</span> [<span class="hljs-string">G1Ergonomics</span> <span class="hljs-string">(Concurrent</span> <span class="hljs-string">Cycles)</span> <span class="hljs-string">initiate</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">cycle</span>, <br>                <span class="hljs-attr">reason:</span> <span class="hljs-string">concurrent</span> <span class="hljs-string">cycle</span> <span class="hljs-string">initiation</span> <span class="hljs-string">requested</span>] <br><span class="hljs-attr">0.106:</span> [<span class="hljs-string">GC</span> <span class="hljs-string">pause</span> <span class="hljs-string">(G1</span> <span class="hljs-string">Humongous</span> <span class="hljs-string">Allocation)</span> <span class="hljs-string">(young)</span> <span class="hljs-string">(initialâ€mark)</span> <br><span class="hljs-attr">0.106:</span> [<span class="hljs-string">G1Ergonomics</span> <span class="hljs-string">(CSet</span> <span class="hljs-string">Construction)</span> <span class="hljs-string">start</span> <span class="hljs-string">choosing</span> <span class="hljs-string">CSet</span>, <br>                <span class="hljs-attr">_pending_cards:</span> <span class="hljs-number">0</span>, <span class="hljs-attr">predicted base time:</span> <span class="hljs-number">10.00</span> <span class="hljs-string">ms</span>, <br>        <span class="hljs-attr">remaining time:</span> <span class="hljs-number">190.00</span> <span class="hljs-string">ms</span>, <span class="hljs-attr">target pause time:</span> <span class="hljs-number">200.00</span> <span class="hljs-string">ms</span>]<br></code></pre></td></tr></table></figure><p>è¿™æ ·çš„æ—¥å¿—è¡¨æ˜ç¨‹åºä¸­ç¡®å®åˆ›å»ºäº†å·¨æ— éœ¸å¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°<code>G1 Humongous Allocation</code> æ˜¯GCæš‚åœçš„åŸå› ã€‚å†çœ‹å‰é¢ä¸€ç‚¹çš„<code>allocation request: 1048592 bytes</code>ï¼Œå¯ä»¥å‘ç°ç¨‹åºè¯•å›¾åˆ†é…ä¸€ä¸ª<code>1048592</code> å­—èŠ‚çš„å¯¹è±¡ï¼Œè¿™è¦æ¯”å·¨æ— éœ¸åŒºåŸŸ(<code>2MB</code>)çš„50%å¤šå‡º16å­—èŠ‚ã€‚ç¬¬ä¸€ä¸­è§£å†³æ–¹å¼æ˜¯ä¿®æ”¹ region sizeï¼Œä»¥ä½¿å¾—å¤§å¤šæ•°çš„å¯¹è±¡å¤§å°ä¸è¶…è¿‡<code>50%</code>ï¼Œä¹Ÿå°±ä¸è¿›è¡Œå·¨æ— éœ¸å¯¹è±¡åŒºåŸŸçš„åˆ†é…ã€‚ region çš„é»˜è®¤å¤§å°åœ¨å¯åŠ¨æ—¶æ ¹æ®å †å†…å­˜çš„å¤§å°ç®—å‡ºã€‚ä½†ä¹Ÿå¯ä»¥æŒ‡å®šå‚æ•°æ¥è¦†ç›–é»˜è®¤è®¾ç½®ï¼Œ<code>-XX:G1HeapRegionSize=XX</code>ã€‚æŒ‡å®šregion sizeå¿…é¡»åœ¨<code>1ï½32MB</code>ä¹‹é—´ï¼Œè¿˜å¿…é¡»æ˜¯2çš„å¹‚å¤§å°ï¼Œæ‰€ä»¥region size åªèƒ½æ˜¯ï¼š<code>1m</code>ï¼Œ<code>2m</code>ï¼Œ<code>4m</code>ï¼Œ<code>8m</code>ï¼Œ<code>16m</code>ï¼Œ<code>32m</code>ã€‚ è¿™ç§æ–¹å¼ä¹Ÿæœ‰å‰¯ä½œç”¨ï¼Œ<strong>å¢åŠ region çš„å¤§å°ä¹Ÿå°±å˜ç›¸å‡å°‘äº†region çš„æ•°é‡ï¼Œæ‰€ä»¥éœ€è¦è°¨æ…ä½¿ç”¨</strong>ã€‚æ›´å¥½çš„æ–¹å¼æ˜¯ï¼Œ<strong>å¦‚æœå¯ä»¥çš„è¯åœ¨ç¨‹åºä¸­é™åˆ¶å¯¹è±¡å¤§å°</strong>ã€‚é¿å…å¤§å¯¹è±¡é—®é¢˜çš„å‡ºç°ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬æ€»ç»“æ¢³ç†äº†JVMç›®å‰ä¸»è¦ä½¿ç”¨ä¸­çš„GCçš„æ—¥å¿—åˆ†æè§£è¯»å’ŒGCè°ƒä¼˜ï¼Œå…¶ä¸­æˆ‘ä»¬åˆ†æäº†SerialGCã€ParallelGCã€CMS å’Œ G1çš„æ—¥å¿—ï¼Œé€šè¿‡è¿™æ®µæ—¥å¿—ä¿¡æ¯çš„è§£è¯»ä¸ºåé¢çš„GCè°ƒä¼˜æ‰“ä¸‹åŸºç¡€ã€‚ç¬¬äºŒä¸ªéƒ¨åˆ†æˆ‘ä»¬ä»‹ç»äº†GCè°ƒä¼˜ã€‚GCè°ƒä¼˜åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š<code>åˆ—å‡ºæ€§èƒ½è°ƒä¼˜æŒ‡æ ‡</code>ã€<code>æ‰§è¡Œæµ‹è¯•</code>ã€<code>æ£€æŸ¥ç»“æœ</code>ã€<code>ä¸ç›®æ ‡è¿›è¡Œå¯¹æ¯”</code>ã€<code>å¦‚æœè¾¾ä¸åˆ°æŒ‡æ ‡ï¼Œä¿®æ”¹æŒ‡æ ‡ï¼Œè°ƒæ•´å‚æ•°ç»§ç»­æµ‹è¯•</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»äº†å‡ ä¸ªæ ¸å¿ƒå‚æ•°æ¦‚å¿µï¼š<code>Latency</code>ã€<code>Throughput</code>ã€<code>Capacity</code>ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é’ˆå¯¹è¿™å‡ ä¸ªå‚æ•°è¿›è¡Œè°ƒä¼˜ã€‚å½“ç„¶æ‰‹åŠ¨äººå·¥çš„å»åˆ†æä¸€è¡Œè¡ŒGCæ—¥å¿—ï¼Œæ•ˆç‡å¿…ç„¶å¾ˆä½ä¹Ÿå¾ˆå®¹æ˜“æ¼æ‰ä¸€äº›å‚æ•°ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¯è§†åŒ–GCå·¥å…·â€”â€”GCViewer å’Œ GCEasyã€‚æœ€åæˆ‘ä»¬åˆ†æäº†çº¿ä¸Šçš„å‡ ç§å¸¸è§çš„GCé—®é¢˜çš„æ—¥å¿—åˆ†æå’Œè§£å†³æ–¹æ¡ˆã€‚</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>Java åƒåœ¾æ”¶é›†å¿…å¤‡æ‰‹å†Œ ï¼ˆgithubé¡¹ç›®åœ°å€ï¼š<a href="https://github.com/cncounter/gc-handbook%EF%BC%89">https://github.com/cncounter/gc-handbookï¼‰</a></li><li>GC æ—¥å¿—çš„è§£è¯»ä¸åˆ†æï¼ˆä¸Šã€ä¸­ã€ä¸‹ï¼‰</li><li><a href="https://cloud.tencent.com/developer/article/1491229">å¦‚ä½•é€‰æ‹©åˆé€‚çš„ GC æ—¶é—´ â€”â€” USER, SYS, REALï¼Ÿ</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM GCç¯‡ â€” åƒåœ¾æ”¶é›†å™¨ï¼ˆä¸‹ï¼‰</title>
    <link href="/2021/06/27/garbage-collector-2/"/>
    <url>/2021/06/27/garbage-collector-2/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢ä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ¢³ç†äº†ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨ã€‚ä»å•çº¿ç¨‹çš„Serialä¸²è¡Œåƒåœ¾æ”¶é›†å™¨å¼€å§‹ï¼ŒèŠåˆ°äº†CMSæœ€ååˆ°G1ï¼Œå¹¶ç€é‡çš„åˆ†æäº†CMSå’ŒG1å¹¶å‘åƒåœ¾æ”¶é›†æµç¨‹å’Œéƒ¨åˆ†å®ç°åŸç†ã€‚è¿™äº›åƒåœ¾æ”¶é›†å™¨ç»è¿‡æ•°åƒå°æœåŠ¡å™¨çš„éªŒè¯æ·¬ç‚¼ï¼Œå·²ç»å˜å¾—ç›¸å½“çš„æˆç†Ÿå¯é ï¼Œä½†æ˜¯çœŸçš„å°±æ˜¯å®Œç¾çš„åƒåœ¾æ”¶é›†å™¨å—ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ç›¸è¾ƒäºâ€œç»å…¸â€åƒåœ¾æ”¶é›†å™¨çš„å…¨æ–°ä¸€ä»£åƒåœ¾æ”¶é›†å™¨ Shenandoah å’Œ ZGCã€‚è¿™ç§åƒåœ¾æ”¶é›†å™¨èƒ½å¤Ÿå®ç°è¶…å¤§å †çš„å®¹é‡ä¸‹ï¼Œè½»æ¾å®ç°åƒåœ¾æ”¶é›†åœé¡¿ä¸è¶…è¿‡10msçš„ç›®æ ‡ï¼Œä½†æ˜¯ç›®å‰è¿˜å¤„äºå®éªŒçŠ¶æ€ï¼Œå®˜æ–¹å‘½åä¸ºâ€œä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨â€ï¼ˆLow-Latency Garbage Collector æˆ–è€… Low-Pause-Time Garbage Collectorï¼‰ã€‚</p><h2 id="ä¸å¯èƒ½çš„ä¸‰è§’"><a href="#ä¸å¯èƒ½çš„ä¸‰è§’" class="headerlink" title="ä¸å¯èƒ½çš„ä¸‰è§’"></a>ä¸å¯èƒ½çš„ä¸‰è§’</h2><p>æˆ‘ä»¬ä¸€è·¯èµ°è¿‡æ¥ä¹Ÿçœ‹è¿‡å¾ˆå¤šçš„åƒåœ¾æ”¶é›†å™¨ï¼Œæˆ‘ä»¬çš„åƒåœ¾æ”¶é›†å™¨ä¹Ÿåœ¨ä¸æ–­çš„è¿›åŒ–ï¼Œå¹¶å‘åœé¡¿æ—¶é—´ç¨³å®šæ€§å„æ–¹é¢éƒ½å˜å¾—è¶Šæ¥è¶Šå¥½ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€ç›´æ²¡æœ‰å›ç­”ä¸€ä¸ªé—®é¢˜ï¼Œä»€ä¹ˆçš„åƒåœ¾æ”¶é›†æ‰æ˜¯ä¸€ä¸ªå®Œç¾çš„åƒåœ¾æ”¶é›†å™¨å‘¢ï¼Ÿå…¶å®è¡¡é‡ä¸€ä¸ªåƒåœ¾æ”¶é›†å™¨æˆ‘ä»¬ä¸€èˆ¬æœ‰ä¸‰ä¸ªé‡è¦çš„æŒ‡æ ‡ï¼š<code>å†…å­˜å ç”¨ï¼ˆfootprintï¼‰</code>ã€<code>ååé‡ï¼ˆThroughputï¼‰</code>å’Œ<code>å»¶è¿Ÿï¼ˆLatencyï¼‰</code>ã€‚è¿™ä¸‰è€…æ„æˆäº†ä¸€ä¸ª<strong>â€œä¸å¯èƒ½ä¸‰è§’â€</strong>ã€‚è¿™ä¸‰ä¸ªå…¨éƒ¨å…·å¤‡å“è¶Šè¡¨ç°çš„â€œå®Œç¾â€æ”¶é›†å™¨æ˜¯å‡ ä¹ä¸å¯èƒ½çš„ï¼Œåªè¦ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨èƒ½è¾¾åˆ°å…¶ä¸­çš„ä¸¤é¡¹ï¼Œå®ƒå°±æ˜¯ä¸€æ¬¾ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><p>åœ¨å†…å­˜å ç”¨ã€ååé‡å’Œå»¶è¿Ÿè¿™ä¸‰é¡¹æŒ‡æ ‡ä¸­ï¼Œå»¶è¿Ÿçš„é‡è¦æ€§æ—¥ç›Šå‡¸æ˜¾å‡ºæ¥ï¼Œå…¶ä¸­GCå‘å±•è¿‡ç¨‹ä¸­çš„åæ¥è€…CMSå’ŒG1ä¹Ÿæ˜¯å¾€è¿™æ–¹å‘å‘å±•çš„äº§ç‰©ã€‚å› ä¸ºéšç€è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•ã€æ€§èƒ½æå‡ï¼Œæˆ‘ä»¬è¶Šæ¥è¶Šèƒ½å®¹å¿æ”¶é›†å™¨å¤šå ç”¨ä¸€äº›å†…å­˜ã€‚ç¡¬ä»¶æ€§èƒ½æå‡ï¼Œå¯¹ç³»ç»Ÿå¤„ç†çš„èƒ½åŠ›ä¹Ÿæœ‰ç›´æ¥çš„æå‡ä¹Ÿå°±æ˜¯ååé‡ä¼šæå‡ã€‚ä½†æ˜¯å»¶è¿Ÿä¸æ˜¯è¿™æ ·çš„ï¼Œéšç€å†…å­˜çš„æ‰©å¤§ï¼Œå»¶è¿Ÿçš„æ—¶é—´æ²¡æœ‰å‡å°‘åè€Œä¼šå¸¦æ¥è´Ÿé¢çš„æ”¶ç›Šï¼Œç”±æ­¤ä¸éš¾çœ‹å‡ºå»¶è¿Ÿæˆä¸ºåƒåœ¾æ”¶é›†å™¨çš„ä¸»è¦ä¼˜åŒ–ç›®æ ‡ã€‚</p><p>Serial ä¸²è¡ŒGC å’Œ Parallel å¹¶è¡ŒGCåœ¨è¿›è¡Œåƒåœ¾å›æ”¶çš„æ—¶å€™éƒ½å¿…é¡»å…¨ç¨‹éœ€è¦STWï¼ŒCMSå’ŒG1å¯¹äºåˆå§‹æ ‡è®°å’Œæœ€ç»ˆæ ‡è®°é˜¶æ®µéœ€è¦STWã€‚G1è™½ç„¶å¯ä»¥æŒ‰ç…§æ›´å°çš„ç²’åº¦è¿›è¡Œå›æ”¶ï¼Œä»è€ŒæŠ‘åˆ¶å¤åˆ¶è½¬ç§»é˜¶æ®µçš„é•¿æ—¶é—´åœé¡¿ï¼Œä½†è¿˜æ˜¯éœ€è¦æš‚åœã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210627220309.png"></p><h2 id="Shenandoah"><a href="#Shenandoah" class="headerlink" title="Shenandoah"></a>Shenandoah</h2><p><strong>Shenandoah æ˜¯ä¸€æ¬¾è¶…ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ˆUltra-Low-pause-TIme Garbage Collectorï¼‰ï¼Œå…¶è®¾è®¡ç›®æ ‡æ˜¯ç®¡ç†å¤§å‹çš„å¤šæ ¸æœåŠ¡å™¨ä¸Šè¶…å¤§å‹å †å†…å­˜ï¼ŒGCçº¿ç¨‹ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œä½¿å¾—æš‚åœæ—¶é—´éå¸¸çŸ­æš‚ã€‚</strong>Shenandoah æ˜¯ç”±RedHatå…¬å¸ç‹¬ç«‹å‘å±•çš„æ–°å‹åƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨2014å¹´ RedHat æŠŠShenandoahè´¡çŒ®ç»™äº†OpenJDKï¼Œå¹¶ä¸”æ¨åŠ¨å®ƒæˆä¸º OpenJDK 12çš„é‡è¦ç‰¹æ€§ã€‚ä½†æ˜¯è¿™æ¬¾åƒåœ¾æ”¶é›†å™¨ï¼Œä¹Ÿæ˜¯<strong>æœ€å­¤ç‹¬çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨</strong>ã€‚ç”±äºShenandoah ä¸æ˜¯ç”±Oracleå…¬å¸é¢†å¯¼å¼€å‘çš„HotSpotåƒåœ¾æ”¶é›†å™¨ï¼Œ<strong>ä¸å¯é¿å…çš„å—åˆ°ä¸€äº›æ¥è‡ªå®˜æ–¹çš„æ’æŒ¤</strong>ã€‚Oracle æ˜ç¡®æ‹’ç»åœ¨OracleJDK 12ä¸­æ”¯æŒShenandoahæ”¶é›†å™¨ï¼Œå› æ­¤Shenandoahæ˜¯ä¸€æ¬¾åªæœ‰åœ¨ OpenJDKä¸­æ‰åŒ…å«è€ŒOracleJDKä¸­åè€Œä¸å­˜åœ¨çš„åƒåœ¾æ”¶é›†å™¨ã€‚</p><h3 id="å¯¹G1çš„è‡´æ•¬"><a href="#å¯¹G1çš„è‡´æ•¬" class="headerlink" title="å¯¹G1çš„è‡´æ•¬"></a>å¯¹G1çš„è‡´æ•¬</h3><p>ç›¸æ¯”äºæœ‰â€œæ­£å®—è¡€ç»Ÿâ€çš„ZGCè€Œè¨€ï¼ŒShenandoahæ›´åƒæ˜¯G1çš„ç»§æ‰¿è€…ï¼Œå®ƒä»¬éƒ½æœ‰ç€ç›¸ä¼¼çš„å†…å­˜å¸ƒå±€ï¼Œåœ¨åˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°çš„å¤„ç†æ€è·¯éƒ½æ˜¯é«˜åº¦çš„ç›¸åŒä¸€è‡´ï¼Œç”šè‡³è¿˜æœ‰ä¸€äº›å…±äº«ä»£ç ã€‚å®ƒç»§æ‰¿äº†G1çš„ä¼˜ç‚¹ï¼Œåè¿‡æ¥ä¹Ÿä¿ƒè¿›G1æ‰“ç£¨æ”¹è¿›å’Œbugä¿®å¤ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“G1å½“åƒåœ¾æ”¶é›†é€Ÿåº¦å°äºåˆ†é…é€Ÿåº¦å¹¶ä¸”å‰©ä½™å †ç©ºé—´ä¸è¶³æ—¶ã€‚G1ä¼šåƒCMSä¸€æ ·ï¼Œå¹¶å‘å¤±è´¥å¹¶è¿›è¡Œä¸²è¡Œçš„FullGCæ¥é‡Šæ”¾ç©ºé—´ã€‚è€ŒShenandoahåˆ™ä¿ƒæˆäº† Parallel Full GC for G1ã€‚</p><blockquote><p>Shenandoahç»§æ‰¿äº†G1ç‹¬ç‰¹çš„è®¾è®¡æ€è·¯ï¼Œåœ¨G1åŸæ¥çš„é“è·¯ä¸Šåˆè¿›è¡Œäº†æ‹“å±•åˆ›æ–°ï¼ŒåŒæ—¶åè¿‡æ¥åˆæ¨åŠ¨äº†G1çš„æ‰“ç£¨å’Œbugä¿®å¤ï¼Œåœ¨æˆ‘çœ‹æ¥Shenandoah ç†åº”æˆä¸º G1 çš„ç»§æ‰¿äººï¼Œä½†æ˜¯å› ä¸ºâ€œè¡€ç»Ÿä¸çº¯â€è€Œé­åˆ°æ’æŒ¤ï¼Œå±å®æœ‰äº›æ— å¥ˆã€‚</p></blockquote><h3 id="Shenandoah-çš„åˆ›æ–°"><a href="#Shenandoah-çš„åˆ›æ–°" class="headerlink" title="Shenandoah çš„åˆ›æ–°"></a>Shenandoah çš„åˆ›æ–°</h3><p>Shenandoah ä» G1 ä¸Šç»§æ‰¿æ¥å¾ˆæœ‰ä¼˜ç§€çš„ç‰¹ç‚¹ï¼Œä½†æ˜¯è‡ªèº«ä¹Ÿæœ‰åˆ›æ–°å‘å±•çš„ç‚¹ã€‚ä¸»è¦é›†ä¸­ä½†ä¸ä»…é™äºä¸‹é¢ä¸‰ç‚¹<strong>ï¼š</strong></p><ul><li><strong>æ”¯æŒå¹¶å‘æ•´ç†</strong>ã€‚å‰é¢æˆ‘ä»¬æ¢³ç†G1çš„åƒåœ¾æ”¶é›†æµç¨‹ï¼Œå…¶ä¸­æœ‰åˆå§‹æ ‡è®°ï¼ˆInit Markï¼‰ã€æœ€ç»ˆæ ‡è®°ï¼ˆFinal Markï¼‰å’Œæœ€åçš„å¤åˆ¶è½¬ç§»æš‚åœï¼ˆEvacuation Pauseï¼‰é˜¶æ®µéœ€è¦ STWï¼Œå…¶ä»–é˜¶æ®µéƒ½å¯ä»¥å¹¶å‘æ‰§è¡Œã€‚Shenandoah å®ç°äº†å¹¶å‘çš„å†…å­˜ç©ºé—´æ•´ç†ï¼Œå…·ä½“ç»†èŠ‚æˆ‘ä»¬åœ¨åé¢è¿›è¡Œè¯¦ç»†æ¢³ç†ã€‚</li><li><strong>ä¸ä½¿ç”¨åˆ†ä»£æ”¶é›†</strong>ã€‚ä¸ä¼šæœ‰ä¸“é—¨çš„æ–°ç”Ÿä»£çš„Regionæˆ–è€å¹´ä»£Regionã€‚åœ¨å‰é¢çš„å°èŠ‚ä¸­æˆ‘ä»¬æåˆ°äº†<strong>æ¯æ¬¡åƒåœ¾æ”¶é›†ä¼šç»Ÿè®¡æ¯ä¸ªRegionçš„å›æ”¶æˆæœ¬</strong>ï¼Œè®¡ç®—å‡ºå¹³å‡å€¼ï¼Œæ ‡å‡†å·®ç­‰ï¼Œå¹¶é€šè¿‡æœ€æ–°çš„æ•°æ®å°½å¤§åœ°å½±å“Regionçš„å›æ”¶æ”¶ç›Šã€‚è®©ç»Ÿè®¡å‡ºæ¥çš„ç»“æœæ›´åŠ ååº”å½“å‰çš„Regionçš„å›æ”¶æ”¶ç›Šã€‚æ•´ä¸ªå †å†…å­˜æœ‰ä¸€ä¸ªå®Œå–„çš„å›æ”¶è¯„ä¼°ï¼Œå› æ­¤GCå¯ä»¥åœ¨ä¸ä¾èµ–åˆ†ä»£ç†è®ºçš„å‰æä¸‹ï¼Œå®ç°åƒåœ¾å›æ”¶æ”¶ç›Šçš„æœ€å¤§åŒ–ã€‚</li><li><strong>ä½¿ç”¨â€œè¿æ¥çŸ©é˜µâ€ä»£æ›¿è·¨Regionå¼•ç”¨è®°å¿†é›†</strong>ã€‚ä¸ºäº†ç»´æŠ¤å„ä¸ªè·¨Regionä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼ŒG1è€—è´¹äº†å¤§é‡çš„å†…å­˜å’Œè®¡ç®—èµ„æºå»ç»´æŠ¤è®°å¿†é›†ï¼Œè€Œåœ¨Shenandoahä¸­ï¼Œä½¿ç”¨åä¸º<strong>â€œé“¾æ¥çŸ©é˜µâ€</strong>çš„æ•°æ®ç»“æ„æ¥è®°å½•è·¨Regioné—´çš„å¼•ç”¨å…³ç³»ã€‚é™ä½äº†è·¨Regioné—´å¼•ç”¨è®°å½•æ¶ˆè€—ã€‚â€œé“¾æ¥çŸ©é˜µâ€å¯ä»¥ç†è§£ä¸ºä¸€å¼ äºŒç»´è¡¨æ ¼ã€‚å¦‚æœRegion N æœ‰å¯¹è±¡æŒ‡å‘ Region Mï¼Œå°±åœ¨è¡¨æ ¼çš„Nè¡ŒMåˆ—æ‰“ä¸Šä¸€ä¸ªæ ‡è®°ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä¾‹å­ï¼š<strong>Region9æŒ‡å‘Region6ï¼ŒRegion7æŒ‡å‘Region4ï¼ŒRegion5æŒ‡å‘Region3ï¼ŒRegion3åˆæŒ‡å‘Region1ã€‚</strong>é€šè¿‡ä¸€ä¸ªé“¾æ¥çŸ©é˜µæ¥ä»£æ›¿å„ä¸ªRegionè‡ªå¸¦çš„RSetæ¥ç»´æŠ¤Regioné—´çš„å¼•ç”¨å…³ç³»ï¼Œæå¤§çš„å‡å°‘äº†å†…å­˜æ¶ˆè€—ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210617233319.png"></p><p>å¾—ç›Šäºè¿™äº›åˆ›æ–°çš„è®¾è®¡ï¼ŒShenandoah ç›¸è¾ƒäºG1å¯¹ç³»ç»Ÿçš„èµ„æºå ç”¨æ›´å°ã€‚å› æ­¤åœ¨ç³»ç»Ÿè´Ÿè½½å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒShenandoah çš„å»¶è¿Ÿç›¸è¾ƒäºå…¶ä»–åƒåœ¾æ”¶é›†å™¨ä¹Ÿèƒ½ä¿æŒåœ¨æåº¦ç¨³å®šçš„æ°´å¹³ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210627013808.png"></p><h3 id="åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ"><a href="#åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ" class="headerlink" title="åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ"></a>åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ</h3><p>Shenandoah æ˜¯å¹¶å‘çš„åƒåœ¾æ”¶é›†å™¨ï¼Œå®ƒçš„åƒåœ¾æ”¶é›†å‘¨æœŸä¸CMSã€G1ç±»ä¼¼ï¼Œä½†æ˜¯ Shenandoah åˆ›æ–°çš„æ”¯æŒå¹¶å‘æ•´ç†ï¼Œè¿›ä¸€æ­¥æé«˜äº†åƒåœ¾æ”¶é›†çš„å¹¶å‘åº¦ã€‚ä»¥ä¸‹æ˜¯Shenandoahçš„ä¸€ä¸ªå·¥ä½œå‘¨æœŸçš„9ä¸ªæ­¥éª¤ï¼š</p><ul><li><strong>åˆå§‹æ ‡è®°é˜¶æ®µï¼ˆInit Markï¼‰</strong>ï¼šä¸G1ä¸€æ ·ï¼Œä¸ºå †å’Œåº”ç”¨ç¨‹åºå‡†å¤‡å¹¶å‘æ ‡è®°ï¼Œç„¶åæ‰«ææ ¹å¯¹è±¡é›†ã€‚è¿™æ˜¯GCå‘¨æœŸçš„ç¬¬ä¸€æ¬¡æš‚åœï¼ŒæŒç»­æ—¶é—´å–å†³ä¸æ ¹å¯¹è±¡é›†çš„å¤§å°ã€‚å› ä¸ºæ ¹å¯¹è±¡é›†å¾ˆå°ï¼Œæ‰€ä»¥é€Ÿåº¦å¾ˆå¿«ï¼Œæš‚åœæ—¶é—´éå¸¸çŸ­ã€‚</li><li><strong>å¹¶å‘æ ‡è®°é˜¶æ®µï¼ˆConcurrent Markï¼‰</strong>ï¼šä¸G1ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°éå†å †ï¼Œå¹¶è·Ÿè¸ªå¯è¾¾çš„å¯¹è±¡ï¼Œè¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼ŒæŒç»­æ—¶é—´å–å†³äºå­˜æ´»å¯¹è±¡æ•°æ®ä»¥åŠå †ä¸­å¯¹è±¡å›¾çš„ç»“æ„ã€‚ç”±äºè¿™ä¸ªé˜¶æ®µå¹¶æ²¡æœ‰åƒåœ¾æ”¶é›†ï¼Œä¸”åº”ç”¨ç¨‹åºå¯ä»¥åœ¨æ­¤é˜¶æ®µè‡ªç”±åˆ†é…æ–°æ•°æ®ï¼Œå› æ­¤å¹¶å‘æ ‡è®°é˜¶æ®µå †å ç”¨ç‡ä¼šä¸Šå‡ã€‚</li><li><strong>æœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal Markï¼‰</strong>ï¼šä¸G1ä¸€æ ·ï¼Œå¤„ç†å‰©ä½™çš„ SATB æ‰«æï¼Œå¹¶åœ¨è¿™ä¸ªé˜¶æ®µç»Ÿè®¡å‡ºå›æ”¶ä»·å€¼é«˜çš„Regionï¼Œå°†è¿™äº›Regionæ„æˆä¸€ç»„å›æ”¶é›†ï¼ˆCollection Setï¼‰ã€‚è¿™ä¸ªé˜¶æ®µä¹Ÿä¼šæœ‰å°é˜¶æ®µçš„æš‚åœã€‚</li><li><strong>å¹¶å‘æ¸…ç†é˜¶æ®µï¼ˆConcurrent Cleanupï¼‰</strong>ï¼šè¿™ä¸ªé˜¶æ®µç”¨äºæ¸…ç†é‚£äº›æ•´ä¸ªåŒºåŸŸè¿ä¸€ä¸ªå­˜æ´»å¯¹è±¡éƒ½æ²¡æ‰¾åˆ°çš„åŒºåŸŸã€‚</li><li><strong>å¹¶å‘è½¬ç§»é˜¶æ®µï¼ˆConcurrent Evacuationï¼‰</strong>ï¼šè¿™ä¸ªé˜¶æ®µæ˜¯ Shenandoah ä¸ä¹‹å‰ HotSpot ä¸­å…¶ä»–æ”¶é›†å™¨çš„æ ¸å¿ƒå·®å¼‚ã€‚åœ¨è¿™ä¸ªé˜¶æ®µShenandoahè¦æŠŠå›æ”¶é›†ä¸­çš„å­˜æ´»å¯¹è±¡å…ˆå¤åˆ¶åˆ°ä¸€ä»½å…¶ä»–æœªè¢«ä½¿ç”¨çš„Regionä¹‹ä¸­ã€‚<strong>è¿™ä¸ªè¿‡ç¨‹åœ¨G1 ä¸­æ˜¯ä¼šè¿›è¡Œæš‚åœæ‰§è¡Œçš„ï¼Œä½†æ˜¯åœ¨Shenandoahä¸­è¿™ä¸ªè¿‡ç¨‹æ˜¯å¹¶å‘è¿›è¡Œçš„ã€‚</strong>åœ¨ç§»åŠ¨å¯¹è±¡çš„è¿‡ç¨‹ä¸­å¼•ç”¨åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ­¤æ—¶åˆä¸èƒ½å½±å“å¯¹è±¡çš„æ­£å¸¸è®¿é—®ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„é—®é¢˜äº†ã€‚è¿™é‡Œæ˜¯é€šè¿‡<strong>è¯»å±éšœå’Œâ€œBrooks Pointersâ€çš„è½¬å‘æŒ‡é’ˆ</strong>æ¥è§£å†³çš„ï¼Œåé¢æˆ‘ä»¬ä¼šè¯¦ç»†ä»‹ç»ã€‚è¿™ä¸ªé˜¶æ®µçš„æŒç»­æ—¶é—´å–å†³äºè¦å¤åˆ¶çš„é›†åˆå¤§å°ã€‚</li><li><strong>åˆå§‹å¼•ç”¨æ›´æ–°é˜¶æ®µï¼ˆInit Update Referenceï¼‰</strong>ï¼šå¹¶å‘å›æ”¶é˜¶æ®µå¤åˆ¶å¯¹è±¡ç»“æŸåï¼Œè¿˜<strong>éœ€è¦æŠŠå †ä¸­æ‰€æœ‰æŒ‡å‘æ—§å¯¹è±¡çš„å¼•ç”¨ä¿®æ­£åˆ°å¤åˆ¶åçš„æ–°åœ°å€ï¼Œè¿™ä¸ªæ“ä½œç§°ä¸ºå¼•ç”¨æ›´æ–°</strong>ã€‚å¼•ç”¨æ›´æ–°çš„åˆå§‹åŒ–é˜¶æ®µå®é™…ä¸Šå¹¶æœªåšä»€ä¹ˆå…·ä½“çš„å¤„ç†ï¼Œè®¾ç«‹è¿™ä¸ªé˜¶æ®µåªæ˜¯ä¸ºäº†å»ºç«‹ä¸€ä¸ªçº¿ç¨‹é›†åˆç‚¹ï¼Œç¡®ä¿æ‰€æœ‰å¹¶å‘å›æ”¶é˜¶æ®µä¸­è¿›è¡Œçš„æ”¶é›†å™¨çº¿ç¨‹éƒ½å·²å®Œæˆåˆ†é…ç»™ä»–ä»¬çš„å¯¹è±¡ç§»åŠ¨ä»»åŠ¡è€Œå·²ã€‚åˆå§‹å¼•ç”¨æ›´æ–°æ—¶é—´å¾ˆçŸ­ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªéå¸¸çŸ­æš‚çš„åœé¡¿ã€‚</li><li><strong>å¹¶å‘å¼•ç”¨æ›´æ–°ï¼ˆConcurrent Update Referencesï¼‰</strong>ï¼š çœŸæ­£å¼€å§‹è¿›è¡Œå¼•ç”¨æ›´æ–°æ“ä½œï¼Œè¿˜è¦ä¿®æ­£å­˜åœ¨GC Rootsä¸­çš„å¼•ç”¨ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯ä¸åº”ç”¨çº¿ç¨‹ä¸€èµ·å¹¶å‘æ‰§è¡Œçš„ï¼Œæ—¶é—´çš„é•¿çŸ­å–å†³äºå†…å­˜ä¸­æ¶‰åŠçš„å¼•ç”¨æ•°é‡çš„å¤šå°‘ã€‚å¹¶å‘å¼•ç”¨æ›´æ–°ä¸å¹¶å‘æ ‡è®°ä¸åŒï¼Œå®ƒä¸å†éœ€è¦æ²¿ç€å¯¹è±¡å›¾æ¥æœç´¢ï¼Œåªéœ€è¦æŒ‰ç…§å†…å­˜ç‰©ç†åœ°å€çš„é¡ºåºï¼Œçº¿æ€§åœ°æœç´¢å‡ºå¼•ç”¨ç±»å‹ï¼ŒæŠŠæ—§å€¼æ”¹æˆæ–°å€¼è€Œå·²ã€‚</li><li><strong>æœ€ç»ˆå¼•ç”¨æ›´æ–°ï¼ˆFinal Update Referenceï¼‰</strong>ï¼šè§£å†³äº†å †ä¸­çš„å¼•ç”¨æ›´æ–°ä¹‹åï¼Œè¿˜è¦ä¿®æ­£å­˜åœ¨ä¸GC Rootsä¸­çš„å¼•ç”¨ã€‚è¿™ä¸ªé˜¶æ®µæ˜¯ Shenandoah çš„æœ€åä¸€æ¬¡åœé¡¿ï¼Œåœé¡¿æ—¶é—´åªä¸ GC Roots çš„æ•°é‡ç›¸å…³ã€‚</li><li><strong>å¹¶å‘æ¸…ç†ï¼ˆConcurrent Cleanupï¼‰</strong>ï¼šç»è¿‡å¹¶å‘å›æ”¶å’Œå¼•ç”¨æ›´æ–°ä¹‹åï¼Œæ•´ä¸ªå›æ”¶å‘¨é›†ä¸­æ‰€æœ‰çš„Regionå·²æ— å­˜æ´»å¯¹è±¡ï¼Œè¿™äº› Region éƒ½å˜æˆäº† Immediate Garbage Regionsäº†ï¼Œæœ€ååœ¨è°ƒç”¨ä¸€æ¬¡å¹¶å‘æ¸…ç†è¿‡ç¨‹ï¼Œä¾›åé¢åˆ†é…æ–°çš„å¯¹è±¡ä½¿ç”¨ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210620002550.png"></p><p>ä»¥ä¸Šæ˜¯Shenandoahåƒåœ¾æ”¶é›†çš„è¯¦ç»†çš„9ä¸ªæ­¥éª¤ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥ç®€åŒ–ä¸º4ä¸ªæ­¥éª¤ï¼š<strong>åˆå§‹æ ‡è®°ï¼Œå¹¶å‘æ ‡è®°ã€æœ€ç»ˆæ ‡è®°ã€å¹¶å‘æ•´ç†</strong>ã€‚è€Œåœ¨å¹¶å‘æ•´ç†ä¸­ï¼Œå¹¶å‘å¼•ç”¨æ›´æ–°åˆå¯ä»¥åˆ†ä¸º4ä¸ªæ­¥éª¤ï¼Œ<strong>å¹¶å‘è½¬ç§»ã€åˆå§‹å¼•ç”¨æ›´æ–°ã€å¹¶å‘å¼•ç”¨æ›´æ–°ã€æœ€ç»ˆå¼•ç”¨æ›´æ–°</strong>ã€‚Shenandoah ä¸€ä¸ªåƒåœ¾å›æ”¶å‘¨æœŸä¸­ä¼šæœ‰4æ¬¡STWï¼Œè™½ç„¶åœ¨STWæ¬¡æ•°ä¸Šæ¯”G1è¿˜è¦å¤šï¼Œä½†æ˜¯<strong>æ•´ä½“æš‚åœæ—¶é—´ä¹Ÿæ¯”G1çŸ­ã€‚</strong></p><blockquote><p>G1ä¸€æ¬¡åƒåœ¾å›æ”¶å‘¨æœŸï¼Œå¹³å‡ç®—ä¸‹æ¥ä¼šæœ‰2æ¬¡åŠSTWã€‚å…¶ä¸­åˆå§‹æ ‡è®°å’Œæœ€ç»ˆæ ‡è®°é˜¶æ®µéƒ½ä¼šå„æœ‰ä¸€æ¬¡STWï¼Œå…¶ä¸­åœ¨æœ€ååƒåœ¾å›æ”¶é˜¶æ®µï¼Œå¦‚æœå‘ç”Ÿè½¬ç§»æš‚åœï¼ˆEvacuation pauseï¼‰å°†ä¼šäº§ç”Ÿä¸€æ¬¡STWï¼Œå› æ­¤æˆ‘è®¤ä¸ºG1çš„å†ä¸€æ¬¡åƒåœ¾å›æ”¶çš„æš‚åœæ—¶é—´ä¸º2æ¬¡åŠã€‚</p></blockquote><p>ä¸‹é¢çš„è¡¨æ ¼æ˜¯ RedHat å®˜æ–¹åœ¨2016å¹´æ‰€å‘è¡¨åœ¨ Shenandoah å®ç°è®ºæ–‡ä¸­ç»™å‡ºçš„å®æµ‹æ•°æ®ï¼Œæµ‹è¯•å†…å®¹æ˜¯ElasticSearch å¯¹ 200G çš„ç»´åŸºç™¾ç§‘æ•°æ®è¿›è¡Œç´¢å¼•ã€‚è¿™ä¸ªæ—¶å€™çš„Shenandoahï¼Œè¿˜æ²¡æœ‰å‘å±•åˆ°å®Œå…¨ä½“ï¼Œä½†æ˜¯ä»æ•°æ®æ¥çœ‹ï¼Œæš‚åœæ—¶é—´å·²ç»æœ‰äº†è´¨çš„é£è·ƒã€‚</p><table><thead><tr><th>æ”¶é›†å™¨</th><th>è¿è¡Œæ—¶é—´</th><th>æ€»åœé¡¿</th><th>æœ€å¤§åœé¡¿</th><th>å¹³å‡åœé¡¿</th></tr></thead><tbody><tr><td>Shenandoah</td><td>387.602s</td><td>320ms</td><td>89.79ms</td><td>53.01ms</td></tr><tr><td>G1</td><td>312.052s</td><td>11.7s</td><td>1.24s</td><td>450.12ms</td></tr><tr><td>CMS</td><td>285.264s</td><td>12.78s</td><td>4.39s</td><td>852.26ms</td></tr><tr><td>Parallel Scavenge</td><td>260.092s</td><td>6.59s</td><td>3.04s</td><td>823.75ms</td></tr></tbody></table><h3 id="Shenandoahå¹¶å‘æ•´ç†å®ç°â€”è½¬å‘æŒ‡é’ˆï¼ˆBrooks-Pointerï¼‰"><a href="#Shenandoahå¹¶å‘æ•´ç†å®ç°â€”è½¬å‘æŒ‡é’ˆï¼ˆBrooks-Pointerï¼‰" class="headerlink" title="Shenandoahå¹¶å‘æ•´ç†å®ç°â€”è½¬å‘æŒ‡é’ˆï¼ˆBrooks Pointerï¼‰"></a>Shenandoahå¹¶å‘æ•´ç†å®ç°â€”è½¬å‘æŒ‡é’ˆï¼ˆBrooks Pointerï¼‰</h3><p>å‰é¢æˆ‘ä»¬æåˆ° Shenandoah ç›¸è¾ƒäº G1 æœ€å¤§çš„å˜åŒ–ä¹‹ä¸€å°±æ˜¯æ”¯æŒå¹¶å‘æ•´ç†ï¼Œåœ¨G1ä¸­æ˜¯é€šè¿‡å¤åˆ¶ç®—æ³•è½¬ç§»æš‚åœï¼ˆEvacuation pauseï¼‰ï¼Œè¿™ä¸ªå¤åˆ¶è¿‡ç¨‹éœ€STWï¼Œå¹¶ä¸”è¿™æ˜¯G1åƒåœ¾å›æ”¶ä¸­æœ€é•¿çš„ä¸€æ¬¡æš‚åœã€‚è€Œ shenandoah é€šè¿‡ä¸¤æ¬¡çŸ­æš‚çš„æš‚åœæ›¿ä»£ä¸€æ¬¡é•¿æ—¶é—´æš‚åœï¼Œæ¥å®ç°å¤åˆ¶è½¬ç§»çš„å¹¶å‘æ‰§è¡Œã€‚å…¶ä¸­<strong>æœ€æ ¸å¿ƒçš„æ¦‚å¿µâ€”â€”Brooks Pointer</strong>ã€‚â€œBrooksâ€æ˜¯ä¸€ä¸ªäººçš„åå­—ã€‚1984å¹´ï¼ŒRodney A. Brooks åœ¨è®ºæ–‡ã€ŠTrading Data Space for Reduced Time and Code Space in Real-Time Garbage</p><p> Collection on Stock Hardwareã€‹ä¸­æå‡ºä½¿ç”¨è½¬å‘æŒ‡é’ˆï¼ˆForwarding Pointerï¼Œä¹Ÿå¸¸è¢«ç§°ä¸º Indirection Pointerï¼‰æ¥å®ç°å¯¹è±¡ç§»åŠ¨ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘çš„ä¸€ç§è§£å†³æ–¹æ¡ˆã€‚</p><p>Brooksæå‡ºçš„è½¬å‘æŒ‡é’ˆå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯åœ¨<strong>åŸæœ‰å¯¹è±¡å¸ƒå±€å‰é¢ç»Ÿä¸€å¢åŠ ä¸€ä¸ªæ–°çš„å¼•ç”¨å­—æ®µï¼Œåœ¨æ­£å¸¸ä¸å¤„äºå¹¶å‘ç§»åŠ¨çš„æƒ…å†µä¸‹ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘è‡ªå·±ï¼Œåœ¨å¹¶å‘ç§»åŠ¨åæŒ‡é’ˆæŒ‡å‘ç§»åŠ¨åçš„å¯¹è±¡ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210620151116.png"></p><p>ä»ç»“æ„ä¸Šæ¥çœ‹ï¼Œ Brooks æå‡ºçš„è½¬å‘ä¹‹å‰ä¸æŸäº›æ—©æœŸ Java è™šæ‹Ÿæœºä½¿ç”¨è¿‡çš„å¥æŸ„å®šä½æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä¸¤è€…éƒ½æ˜¯ä¸€ç§é—´æ¥æ€§çš„å¯¹è±¡è®¿é—®æ–¹å¼ï¼Œå·®åˆ«æ˜¯å¥æŸ„é€šå¸¸æ˜¯ç»Ÿä¸€å­˜å‚¨åœ¨ä¸“é—¨çš„å¥æŸ„æ± ä¸­ï¼Œè€Œè½¬å‘æŒ‡é’ˆæ˜¯åˆ†æ•£åœ¨æ¯ä¸ªå¯¹è±¡å¤´å‰é¢ã€‚å†ä½¿ç”¨äº†è½¬å‘æŒ‡é’ˆä¹‹åï¼Œèƒ½å®ç°å¹¶å‘çš„è¿›è¡Œå¯¹è±¡å¤åˆ¶è½¬ç§»ï¼Œä½†æ˜¯å¸¦æ¥çš„é—®é¢˜ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œåœ¨æ¯æ¬¡è®¿é—®å¯¹è±¡æ—¶ï¼Œéƒ½ä¼šå¸¦æ¥ä¸€æ¬¡é¢å¤–çš„è½¬å‘å¼€é”€ï¼Œè™½ç„¶è¿™ä¸ªå¼€é”€å·²ç»è¢«ä¼˜åŒ–åˆ°ä¸€æ¡æ±‡ç¼–å‘½ä»¤çš„ç¨‹åº¦ï¼Œä½†æ˜¯<strong>å¯¹è±¡å®šä½å‘½ä»¤è¢«é¢‘ç¹ä½¿ç”¨åˆ°ï¼Œè¿™ä»ç„¶æ˜¯ä¸€ç¬”ä¸èƒ½å¿½è§†çš„æ€§èƒ½å¼€é”€ã€‚</strong></p><blockquote><p>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³ã€‚</p></blockquote><p>è¿™æ ·çš„è®¾è®¡è™½ç„¶å¥½ï¼Œä½†æ˜¯ä¼šå¸¦æ¥ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜å³<strong>å¤šç”¨æˆ·çº¿ç¨‹å¹¶å‘æ“ä½œå’ŒGCçº¿ç¨‹ä¹‹é—´çš„å¹¶å‘ç«äº‰é—®é¢˜ã€‚</strong>å¦‚æœæ˜¯åº”ç”¨çº¿ç¨‹å¹¶å‘è¯»æ“ä½œçš„åœºæ™¯ï¼Œé—®é¢˜éƒ½ä¸æ˜¯å¾ˆå¤§ï¼Œå› ä¸ºBrooks Poniterï¼Œéƒ½å¯ä»¥æŒ‡å‘æ–°çš„å¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœæ˜¯å†™å…¥çº¿ç¨‹æ“ä½œå’ŒGCçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿä¸å¦¨æƒ³è±¡ä¸€ä¸‹è¿™ä¸‰ä¸ªäº‹ä»¶åŒæ—¶å‘ç”Ÿï¼š</p><ol><li>GCçº¿ç¨‹å¤åˆ¶äº†æ–°çš„å¯¹è±¡å‰¯æœ¬ã€‚</li><li>åº”ç”¨çº¿ç¨‹æ›´æ–°å¯¹è±¡æŸä¸ªå­—æ®µã€‚</li><li>GCçº¿ç¨‹æ›´æ–°è½¬å‘æŒ‡é’ˆçš„å¼•ç”¨å€¼ä¸ºæ–°å¯¹è±¡å‰¯æœ¬ã€‚</li></ol><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210620152740.png"></p><p>å¦‚æœä¸åšä»»ä½•ä¿æŠ¤æªæ–½ï¼ŒæŒ‰ç…§äº‹ä»¶1ï¼Œäº‹ä»¶2ï¼Œäº‹ä»¶3é¡ºåºå‘ç”Ÿï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°åº”ç”¨çº¿ç¨‹å°†æ›´æ–°å†™å…¥åˆ°å¤åˆ¶å‰çš„æ—§å¯¹è±¡ä¸­ï¼Œä¸”æ–°å¯¹è±¡ä¸­è¿˜ä¸å«åº”ç”¨çº¿ç¨‹çš„æ›´æ–°ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸æ­£ç¡®çš„ã€‚è¿™ä¸ªé—®é¢˜æˆ‘ä»¬åªè¦ä¿è¯GCçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸è¢«åº”ç”¨çº¿ç¨‹ç©¿æ’æ‰§è¡Œå°±å¯ä»¥è§£å†³ï¼Œå³äº‹ä»¶æŒ‰ç…§1ã€3ã€2æˆ–è€… 2ã€1ã€3çš„é¡ºåºæ‰§è¡Œã€‚ äº†è§£è¿‡å¹¶å‘ç¼–ç¨‹çš„åŒå­¦è‚¯å®šèƒ½å¾ˆè‡ªç„¶çš„æƒ³åˆ°è§£å†³åŠæ³•ï¼šGCçº¿ç¨‹å’Œåº”ç”¨çº¿ç¨‹åŠ é”è®¿é—®ã€‚å®é™…ä¸Š <strong>Shenandoah ä¹Ÿæ˜¯é€šè¿‡CASçš„æ–¹å¼æ¥å®ç°è¿™é‡Œçš„å¹¶å‘æ§åˆ¶ã€‚</strong></p><p>Shenandoah è¿˜æœ‰è¦è§£å†³çš„é—®é¢˜â€”â€”<code>è¯»å±éšœ</code>çš„æ€§èƒ½é—®é¢˜ï¼Œå‰é¢çš„æˆ‘ä»¬æåˆ°å†™å±éšœï¼Œå…¶ä»–åƒåœ¾æ”¶é›†å™¨ç”¨å†™å±éšœæ¥ç»´æŠ¤å¡è¡¨ï¼Œäº¦æˆ–è€…ç”¨æ¥å®ç°å¹¶å‘æ ‡è®°ï¼Œå†™å±éšœå·²ç»ç§¯ç´¯äº†ä¸€éƒ¨åˆ†çš„å¤„ç†ä»»åŠ¡äº†ã€‚ä¸€éƒ¨åˆ†è¯»å±éšœåœ¨Shenandoahä¸­ä¼šè¢«ç»§ç»­ä½¿ç”¨ï¼ŒåŒæ—¶ Shenandoah è¿˜éœ€è¦å¾€è¯»å†™å±éšœä¸­åŠ å…¥é¢å¤–çš„è½¬å‘å¤„ç†ï¼Œå°¤å…¶æ˜¯ä½¿ç”¨è¯»å±éšœçš„ä»£ä»·ä¼šæ¯”å†™å±éšœå¤§å¾—å¤šï¼Œå› ä¸ºè¯»å±éšœä¼šè¢«æ›´åŠ é¢‘ç¹çš„ä½¿ç”¨ï¼Œå› æ­¤è¯»å±éšœçš„ä½¿ç”¨ä¹Ÿéœ€è¦æ›´åŠ çš„å°å¿ƒï¼Œä¸å…è®¸ä»»ä½•çš„é‡é‡çº§æ“ä½œã€‚<strong>Shenandoah æ˜¯ç›®å‰ç¬¬ä¸€ä¸ªä½¿ç”¨åˆ°è¯»å±éšœçš„æ”¶é›†å™¨ã€‚</strong>å®ƒçš„å¼€å‘è€…ä¹Ÿæ„è¯†åˆ°äº†æ•°é‡åºå¤§çš„è¯»å±éšœå¸¦æ¥æ€§èƒ½å¼€é”€ä¼šæ˜¯ Shenandoah è¢«è¯Ÿç—…çš„å…³é”®ç‚¹ä¹‹ä¸€ã€‚æ‰€ä»¥è®¡åˆ’åœ¨ JDK 13 ä¸­å°†Shenandoahçš„å†…å­˜å±éšœæ¨¡å‹æ”¹è¿›ä¸º<strong>åŸºäºå¼•ç”¨è®¿é—®å±éšœï¼ˆLoad Reference Barrierï¼‰çš„å®ç°</strong>ï¼Œæ‰€è°“â€œå¼•ç”¨è®¿é—®å±éšœâ€æ˜¯å€¼å†…å­˜å±éšœæŒ‡æ‹¦æˆªå¯¹è±¡ç±»å‹ä¸ºå¼•ç”¨ç±»å‹çš„è¯»å†™æ“ä½œï¼Œè€Œä¸å»å¤„ç†åŸç”Ÿæ•°æ®ç±»å‹å’Œå…¶ä»–éå¼•ç”¨å­—æ®µçš„è¯»å†™ï¼Œè¿™èƒ½çœå»å¤§é‡çš„æˆæœ¬ã€‚</p><blockquote><p>å¯ä»¥æŠŠ<code>è¯»å±éšœ</code>ï§¤è§£ä¸ºä¸€æ®µä»£ç ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªæŒ‡ä»¤, åé¢æŒ‚ç€å¯¹åº”çš„å¤„ï§¤å‡½æ•°ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ä¸­ï¼Œä¸¤ï¨ˆloadæ“ä½œå¯¹åº”çš„ä»£ç éƒ½æ’å…¥ï¦ºè¯»å±éšœï¼Œä½†ZGCåœ¨ç¬¬ä¸€ä¸ªè¯»å±éšœè§¦å‘ä¹‹åï¼Œï¥§ä½†å°†açš„å€¼ï¤æ–°ä¸ºæœ€æ–°çš„ï¼Œé€šè¿‡ self healing æœºåˆ¶ä½¿å¾— obj.x çš„æŒ‡é’ˆä¹Ÿä¼šè¢«ä¿®æ­£ï¼Œç¬¬äºŒä¸ªè¯»å±éšœå†è§¦å‘æ—¶å°±ç›´æ¥è¿›å…¥FastPathï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰ï§½ä¹ˆæ€§èƒ½æŸè€—ï¦ºï¼› è€ŒShenandoah åˆ™ï¥§ä¼šä¿®æ­£obj.xçš„å€¼ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªè¯»å±éšœåˆè¦è¿›ï¨ˆä¸€æ¬¡SlowPathã€‚ </p></blockquote><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Object a = obj.x<span class="hljs-comment">;</span><br>Object b = obj.x<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h3 id="å¯å‘å¼å‚æ•°"><a href="#å¯å‘å¼å‚æ•°" class="headerlink" title="å¯å‘å¼å‚æ•°"></a>å¯å‘å¼å‚æ•°</h3><p>å¯å‘å¼å‚æ•°å‘ŠçŸ¥ Shenandoah GCä½•æ—¶å¼€å§‹GCå¤„ï§¤ï¼Œä»¥åŠç¡®å®šè¦å½’é›†çš„å †å—ã€‚å¯ä»¥ä½¿ç”¨<code>-XX:ShenandoahGCHeuristics=</code> æ¥é€‰æ‹©ï¥§åŒçš„å¯å‘æ¨¡å¼ï¼Œæœ‰äº›å¯å‘æ¨¡å¼å¯ä»¥é…ç½®ä¸€äº›å‚æ•°ï¼Œå¸® åŠ©æˆ‘ä»¬ï¤å¥½åœ°ä½¿ç”¨GCã€‚å¯ç”¨çš„å¯å‘æ¨¡å¼å¦‚ä¸‹: </p><ul><li>è‡ªé€‚åº”æ¨¡å¼ï¼ˆ<strong>adaptive</strong>ï¼‰æ­¤ä¸ºé»˜è®¤å‚æ•°ï¼Œé€šè¿‡è§‚å¯Ÿä¹‹å‰çš„ä¸€äº›GCå‘¨æœŸï¼Œä»¥ï¥¥åœ¨å †è€—å°½ä¹‹å‰å°è¯•å¯åŠ¨ä¸‹ä¸€ä¸ªGCå‘¨æœŸã€‚</li></ul><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-symbol">XX:</span>ShenandoahInitFreeThreshold=<span class="hljs-comment"># :è§¦å‘â€œå­¦ä¹ â€é›†åˆçš„åˆå§‹é˜ˆå€¼</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahMinFreeThreshold=<span class="hljs-comment"># :å¯å‘å¼æ— æ¡ä»¶è§¦å‘GCçš„å¯ç”¨ç©ºé—´é˜ˆå€¼</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahAllocSpikeFactor=<span class="hljs-comment"># :è¦ä¿ï§å¤šå°‘å †æ¥åº”å¯¹å†…å­˜åˆ†é…å³°å€¼</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahGarbageThreshold=<span class="hljs-comment"># :è®¾ç½®åœ¨å°†åŒºåŸŸæ ‡è®°ä¸ºæ”¶é›†ä¹‹å‰éœ€è¦åŒ…å«çš„åƒåœ¾ç™¾åˆ†æ¯”</span></span><br></code></pre></td></tr></table></figure><ul><li>é™æ€æ¨¡å¼ï¼ˆ<strong>static</strong>ï¼‰ æ ¹æ®å †ä½¿ç”¨ç‡å’Œå†…å­˜åˆ†é…å‹ï¦Šå†³å®šæ˜¯å¦å¯åŠ¨GCå‘¨æœŸã€‚</li></ul><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-symbol">XX:</span>ShenandoahFreeThreshold=<span class="hljs-comment"># : è®¾ç½®ç©ºé—²å †ç™¾åˆ†æ¯”é˜ˆå€¼ï¼›</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahAllocationThreshold=<span class="hljs-comment"># : è®¾ç½®å†…å­˜åˆ†é…ï¥¾ç™¾åˆ†æ¯”é˜ˆå€¼ï¼›</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahGarbageThreshold=<span class="hljs-comment"># : è®¾ç½®å°å †å—æ ‡è®°ä¸ºå¯å›æ”¶çš„ç™¾åˆ†æ¯”é˜ˆå€¼</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahFreeThreshold=<span class="hljs-comment"># :è®¾ç½®å¯åŠ¨GCå‘¨æœŸæ—¶çš„å¯ç”¨å †ç™¾åˆ†æ¯”é˜ˆå€¼ï¼›</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahAllocationThreshold=<span class="hljs-comment"># :è®¾ç½®ä»ä¸Šä¸€ä¸ªGCå‘¨æœŸåˆ°æ–°çš„GCå‘¨æœŸå¼€å§‹ä¹‹å‰çš„å†…å­˜åˆ†é…ç™¾åˆ†æ¯”é˜ˆå€¼ï¼›</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahGarbageThreshold=<span class="hljs-comment"># :è®¾ç½®åœ¨å°†åŒºåŸŸæ ‡è®°ä¸ºæ”¶é›†ä¹‹å‰éœ€è¦åŒ…å«çš„åƒåœ¾ç™¾åˆ†æ¯”é˜ˆå€¼ï¼›</span></span><br></code></pre></td></tr></table></figure><ul><li>ç´§å‡‘æ¨¡å¼ï¼ˆ<strong>compact</strong>ï¼‰ åªè¦æœ‰å†…å­˜åˆ†é…ï¼Œå°±ä¼šè¿ç»­è¿ï¨ˆGCå›æ”¶ï¼Œå¹¶åœ¨ä¸Šä¸€ä¸ªå‘¨æœŸç»“æŸåç«‹å³å¼€å§‹ä¸‹ä¸€ä¸ªå‘¨æœŸã€‚æ­¤æ¨¡å¼é€šå¸¸ä¼šæœ‰å åï¥¾å¼€é”€ï¼Œä½†èƒ½æä¾›æœ€è¿…é€Ÿçš„å†…å­˜ç©ºé—´å›æ”¶ã€‚</li></ul><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-symbol">XX:</span>ConcGCThreads=<span class="hljs-comment"># :è®¾ç½®å¹¶å‘GCçº¿ç¨‹æ•°ï¼Œå¯ä»¥å‡å°‘å¹¶å‘GCçº¿ç¨‹çš„æ•°ï¥¾ï¼Œä»¥ï¥¥ä¸ºåº”ç”¨ç¨‹åºè¿ï¨ˆ ï§å‡ºï¤å¤šç©ºé—´</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>ShenandoahAllocationThreshold=<span class="hljs-comment"># :è®¾ç½®ä»ä¸Šä¸€ä¸ªGCå‘¨æœŸåˆ°æ–°çš„GCå‘¨æœŸå¼€å§‹ä¹‹å‰çš„å†… å­˜åˆ†é…ç™¾åˆ†æ¯”</span></span><br></code></pre></td></tr></table></figure><ul><li>è¢«åŠ¨æ¨¡å¼ï¼ˆ<strong>passive</strong>ï¼‰ å†…å­˜ä¸€æ—¦ç”¨å®Œï¼Œåˆ™å‘ç”ŸSTWï¼Œç”¨äºç³»ç»Ÿè¯Šæ–­å’ŒåŠŸèƒ½æµ‹è¯•ã€‚ </li><li>ç§¯ææ¨¡å¼ï¼ˆ<strong>aggressive</strong>ï¼‰å®ƒå°†å°½å¿«åœ¨ä¸Šä¸€ä¸ªGCå‘¨æœŸå®Œæˆæ—¶å¯åŠ¨æ–°çš„GCå‘¨æœŸï¼ˆç±»ä¼¼äºâ€œç´§å‡‘å‹â€ï¼‰ï¼Œ å¹¶ä¸”å°†å…¨éƒ¨çš„å­˜æ´»å¯¹è±¡å½’é›†åˆ°ä¸€ å—ï¼Œè¿™ä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œä½†æ˜¯å¯ä»¥è¢«ç”¨æ¥æµ‹è¯•GCæœ¬èº«ã€‚æœ‰æ—¶å€™å¯å‘å¼æ¨¡å¼ä¼šåœ¨åˆ¤æ–­åæŠŠï¤æ–°å¼•ç”¨é˜¶æ®µå’Œå¹¶å‘æ ‡è®°é˜¶æ®µåˆå¹¶ã€‚å¯ä»¥é€šè¿‡<code>-XX:ShenandoahUpdateRefsEarly=[on|off]</code>å¼ºåˆ¶å¯ç”¨å’Œç¦ç”¨è¿™ä¸ªç‰¹æ€§ã€‚ åŒæ—¶é’ˆå¯¹äºå†…å­˜åˆ†é…å¤±è´¥æ—¶çš„ç­–ï¥¶ï¼Œå¯ä»¥é€šè¿‡è°ƒèŠ‚ ShenandoahPacing å’Œ ShenandoahDegeneratedGC å‚æ•°ï¼Œå¯¹çº¿ç¨‹è¿›ï¨ˆä¸€å®šçš„è°ƒèŠ‚æ§åˆ¶ã€‚å¦‚æœè¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæœ€åçš„æƒ… å†µä¸‹å¯èƒ½ä¼šäº§ç”ŸFull GCï¼Œä»¥ä½¿å¾—ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„å†…å­˜ï¥§è‡³äºå‘ç”ŸOOMã€‚ ï¤å¤šæœ‰å…³å¦‚ä½•é…ç½®ã€è°ƒè¯• Shenandoah çš„å‚æ•°ä¿¡æ¯ï¼Œè¯·å‚é˜…Shenandoahå®˜æ–¹wikié¡µé¢ã€‚ å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ° Shenandoah æ˜¯åƒåœ¾æ”¶é›†å™¨ä¸­çš„â€å­¤å„¿â€œï¼Œåªæœ‰OpenJDK ä¸­æ‰åŒ…å«å®ƒï¼Œä¸‹å›¾æ˜¯å„ç‰ˆæœ¬JDKå¯¹Shenandoahçš„é›†æˆæƒ…å†µï¼š</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210620165241.png"></p><p>è¿™å¼ å›¾å±•ç¤ºï¦ºShenandoah GCç›®å‰åœ¨å„ä¸ªJDKç‰ˆæœ¬ä¸Šçš„è¿›å±•æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°OpenJDK12å’Œ13ä¸Šéƒ½å¯ä»¥ç”¨ã€‚ åœ¨Red Hat Enterprise Linuxã€Fedoraç³»ç»Ÿä¸­åˆ™å¯ä»¥åœ¨JDK8å’ŒJDK11ç‰ˆæœ¬ä¸Šä½¿ç”¨ï¼ˆè‚¯å®šçš„ï¼Œè¿™ä¸¤ä¸ªLinuxå‘ï¨ˆ ç‰ˆéƒ½æ˜¯Red Hatçš„ï¼Œè°è®©è¿™ä¸ªGCä¹Ÿæ˜¯Red Hatå¼€å‘ç»´æŠ¤çš„å‘¢ï¼‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼ŒOpenJDK 12+å‘å¸ƒç‰ˆæœ¬é€šå¸¸åŒ…æ‹¬Shenandoahï¼› Fedora 24+ä¸­OpenJDK 8+å‘å¸ƒç‰ˆæœ¬åŒ…æ‹¬Shenandoahï¼› RHEL 7.4+ä¸­OpenJDK 8+å‘å¸ƒç‰ˆæœ¬ä¸­åŒ…æ‹¬Shenandoahä½œä¸ºæŠ€æœ¯é¢„è§ˆç‰ˆï¼› åŸºäºRHEL/Fedoraçš„å‘ï¨ˆç‰ˆæˆ–å…¶ä»–ä½¿ç”¨å®ƒä»¬åŒ…è£…çš„å‘ï¨ˆç‰ˆä¹Ÿå¯èƒ½å¯ç”¨ï¦ºShenandoahï¼ˆCentOSã€ Oracle Linuxã€Amazon Linuxä¸­ä¹Ÿå¸¦ï¦ºShenandoahï¼‰ã€‚</p><h2 id="ZGC"><a href="#ZGC" class="headerlink" title="ZGC"></a>ZGC</h2><p>æˆ‘ä»¬å‰é¢æ¢³ç†äº† Shenandoah æœ‰å…³çŸ¥è¯†ç‚¹ï¼ŒShenandoah æ˜¯ä¸€æ¬¾åœ¨ä»»ä½•å †å¤§å°ä¸‹éƒ½éå¸¸ä¼˜ç§€çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ã€‚ä½†æ˜¯ç”±äºè¿™æ¬¾åƒåœ¾æ”¶é›†å™¨ä¸æ˜¯ç”±HotSpotä¸»å¯¼è®¾è®¡çš„ï¼ŒShenandoah ä¸å…ä¸€ç›´å—åˆ°å®˜æ–¹çš„æ’æŒ¤ã€‚ç›´è‡³ç›®å‰ä¸ºæ­¢ï¼ŒShenandoah æ˜¯å”¯ä¸€ä¸€æ¬¾ä»…å­˜åœ¨ OpenJDK çš„åƒåœ¾æ”¶é›†å™¨ã€‚Shenandoah å·²ç»å¦‚æ­¤çš„ä¼˜ç§€äº†ï¼Œé‚£æœ‰ç€â€œæ­£å®—è¡€ç»Ÿâ€çš„ZGCæœ‰ä»€ä¹ˆç§˜å¯†æ­¦å™¨å‘¢ï¼ŸZGCï¼ˆZ Garbage collectorï¼‰æ˜¯ä¸€æ¬¾åœ¨2011å¹´åŠ å…¥çš„å…·æœ‰å®ç°æ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼Œç”±Oracleå…¬å¸ä¸»æŒç ”å‘ã€‚å¹¶ä¸”Oracleäº2018å¹´å°†ZGCæäº¤ç»™ OpenJDKï¼Œæ¨åŠ¨å…¶è¿›å…¥OpenJDK 11çš„å‘å¸ƒæ¸…å•ä¸­ã€‚ZGCå’ŒShenandoahçš„ç›®æ ‡é«˜åº¦ç›¸ä¼¼ï¼Œ<strong>éƒ½å¸Œæœ›åœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤§çš„å‰æä¸‹ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨10msä»¥å†…çš„ä½å»¶è¿Ÿã€‚</strong>ä½†æ˜¯ä»–ä»¬çš„å®ç°æ–¹å¼å´æœ‰å¾ˆå¤§çš„å·®åˆ«ã€‚RedHatå¼€å‘çš„Shenandoahåƒæ˜¯G1çš„ç»§æ‰¿è€…çš„è¯ï¼Œé‚£Oracleå¼€å‘çš„ZGCåˆ™æ›´åƒæ˜¯ Azul Systemå¼€å‘çš„PGCï¼ˆpauseless GCï¼‰å’Œ C4ï¼ˆConcurrent Continuously Compacting Collectorï¼‰çš„åŒèƒå…„å¼Ÿã€‚</p><h3 id="ZGCçš„å†…å­˜å¸ƒå±€"><a href="#ZGCçš„å†…å­˜å¸ƒå±€" class="headerlink" title="ZGCçš„å†…å­˜å¸ƒå±€"></a>ZGCçš„å†…å­˜å¸ƒå±€</h3><p>ZGCçš„å†…å­˜åˆ†å¸ƒå’ŒShenandoahã€G1çš„ä¸€è‡´ï¼Œéƒ½æ˜¯é‡‡ç”¨åŸºäº Region çš„å†…å­˜å¸ƒå±€ï¼ŒZGCä¸ä»–ä»¬ç¨å¾®æœ‰äº›ä¸åŒçš„æ˜¯åœ¨ä¸€äº›å®˜æ–¹èµ„æ–™ä¸­ï¼ŒZGCçš„Regionè¢«ç§°ä¸ºPageæˆ–ZPageã€‚ZGCçš„Regionæœ‰ä¸€ä¸ªå¾ˆä¸ä¸€æ ·çš„ç‰¹ç‚¹ï¼Œå®ƒå…·æœ‰åŠ¨æ€æ€§â€”åŠ¨æ€çš„åˆ›å»ºå’Œé”€æ¯ï¼Œä»¥åŠä»¥åŠåŠ¨æ€çš„åŒºåŸŸå®¹é‡å¤§å°ã€‚åœ¨x86çš„å¹³å°æ¶æ„ä¸‹ï¼Œ<strong>ZGCçš„Regionå¯ä»¥å…·æœ‰å¤§ã€ä¸­ã€å°ä¸‰ç§ç±»å‹å®¹é‡</strong>ï¼š</p><ul><li>å°å‹Regionï¼ˆSmall Regionï¼‰ï¼šå®¹é‡å›ºå®šä¸º<code>2MB</code>ï¼Œç”¨äºæ”¾ç½®<strong>å°äº256KB</strong>çš„å°å¯¹è±¡ã€‚</li><li>ä¸­å‹Regionï¼ˆMedium Regionï¼‰ï¼šå®¹é‡å›ºå®šä¸º<code>32MB</code>ï¼Œç”¨äºæ”¾ç½®<strong>å¤§äºç­‰äº256KBä½†å°äº4MB</strong>çš„å¯¹è±¡ã€‚</li><li>å¤§å‹Regionï¼ˆLarge Regionï¼‰ï¼šå®¹é‡<code>ä¸å›ºå®š</code>ï¼Œå¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†å¿…é¡»ä¸º<strong>2MBçš„æ•´æ•°å€</strong>ï¼Œç”¨äºæ”¾ç½® 4MB æˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ï¼Œæ¯ä¸ªå¤§å‹ Region ä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§è±¡ï¼Œä»–çš„<strong>å®é™…å®¹é‡å¯èƒ½å°äºä¸­å‹Region</strong>ï¼Œæœ€å°å®¹é‡å¯ä½è‡³4MBã€‚å¤§å‹Regionåœ¨ZGCçš„å®ç°ä¸­æ˜¯ä¸ä¼šè¢«é‡åˆ†é…ï¼ˆé‡åˆ†é…æ˜¯ZGCçš„ä¸€ä¸ªå¤„ç†åŠ¨ä½œï¼Œç”¨äºæ”¶é›†å™¨å¹¶å‘å¤åˆ¶é˜¶æ®µï¼Œåé¢ä¼šä»‹ç»åˆ°ï¼‰ï¼Œå› ä¸ºå¤åˆ¶ä¸€ä¸ªå¤§å¯¹è±¡çš„ä»£ä»·éå¸¸é«˜æ˜‚ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210622000726.png"></p><h3 id="ZGCå¹¶å‘æ•´ç†å®ç°â€”æŸ“è‰²æŒ‡é’ˆï¼ˆColored-Pointerï¼‰"><a href="#ZGCå¹¶å‘æ•´ç†å®ç°â€”æŸ“è‰²æŒ‡é’ˆï¼ˆColored-Pointerï¼‰" class="headerlink" title="ZGCå¹¶å‘æ•´ç†å®ç°â€”æŸ“è‰²æŒ‡é’ˆï¼ˆColored Pointerï¼‰"></a>ZGCå¹¶å‘æ•´ç†å®ç°â€”æŸ“è‰²æŒ‡é’ˆï¼ˆColored Pointerï¼‰</h3><p>æ–°ä¸€ä»£ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼Œç›¸è¾ƒäºä»¥G1ä¸ºä»£è¡¨çš„åç»å…¸åƒåœ¾æ”¶é›†å™¨çš„æœ€å¤§çš„ä¸åŒå°±æ˜¯å®ç°äº†å¹¶å‘æ•´ç†ã€‚å‰é¢æˆ‘ä»¬ä»‹ç»<strong>Shenandoahæ˜¯é€šè¿‡è½¬å‘æŒ‡é’ˆï¼ˆBrooks Pointerï¼‰å’Œè¯»å±éšœ</strong>æ¥å®ç°ã€‚è¿™ä¸ªå®ç°æ–¹æ¡ˆè™½ç„¶èƒ½è§£å†³å¹¶å‘å¤åˆ¶é—®é¢˜ï¼Œä½†æ•´ä½“ä¸Šè¿˜æ˜¯ä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½å’Œå†…å­˜ä¸Šçš„å°ç‘•ç–µï¼Œä¸æ˜¯é‚£ä¹ˆå®Œç¾ã€‚ä¸åŒäºShenandoah çš„è§£å†³æ–¹æ¡ˆï¼ŒZGCé€‰æ‹©äº†å¦å¤–ä¸€æ¡å¤æ‚ç²¾å·§çš„è§£å†³æ–¹æ¡ˆâ€”<strong>æŸ“è‰²æŒ‡é’ˆæŠ€æœ¯</strong>ï¼ˆColor Pointerï¼Œå…¶ä»–ç±»ä¼¼çš„æŠ€æœ¯ä¸­å¯èƒ½ç§°å®ƒä¸ºTag Pointeræˆ–Version Pointerï¼‰ã€‚</p><p> å‰é¢æåˆ°ï¼Œè®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³ã€‚shenandoah æ˜¯é€šè¿‡å¢åŠ ä¸€ä¸ª Brooks Pointerä½œä¸ºä¸­é—´å±‚å®ç°è½¬å‘ï¼Œè€ŒZGCå°±æ˜¯é€šè¿‡æŸ“è‰²æŒ‡é’ˆä½œä¸ºä¸­é—´å±‚ã€‚ é‚£è¿™ä¸ªå¯¹è±¡æ˜¯å¦ç§»åŠ¨çš„ä¿¡æ¯ï¼Œå³åˆæ˜¯å“ªä¸ªæŒ‡é’ˆè¢«æŸ“è‰²äº†å‘¢ï¼Ÿåœ¨JVMä¸­ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨å¯¹è±¡å¤´ä¸Šå¢åŠ é¢å¤–å­˜å‚¨ä¸€äº›å¯¹è±¡ä¿¡æ¯ï¼Œå…¶ä¸­å¯¹è±¡çš„hashCodeã€åˆ†ä»£å¹´é¾„ã€é”è®°å½•ç­‰å°±æ˜¯è¿™æ ·å­˜å‚¨çš„ã€‚è¿™ç§åœ¨èƒ½å¤Ÿè®¿é—®åˆ°å¯¹è±¡çš„åœºæ™¯ä¸‹è®¿é—®é¢å¤–ä¿¡æ¯æ˜¯å¾ˆè‡ªç„¶æµç•…çš„ã€‚ä½†æ˜¯åœ¨è¿™ä¸ªåœºæ™¯ï¼Œå®ƒæ˜æ˜¾æ˜¯ä¸é€‚ç”¨çš„ã€‚æ­¤æ—¶æˆ‘ä»¬åœ¨è®¿é—®å¯¹è±¡çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜æœªè·å–åˆ°å¯¹è±¡åˆæ€ä¹ˆèƒ½è®¿é—®åˆ°å¯¹è±¡å¤´ä¸­çš„ä¿¡æ¯å‘¢ï¼Ÿè¿™ä¸ªä¿¡æ¯<strong>ZGCæ”¾åœ¨äº†æŒ‡å‘å¯¹è±¡çš„å¼•ç”¨æŒ‡é’ˆä¸Šã€‚</strong></p><blockquote><p>åœ¨64ä½ç³»ç»Ÿä¸­ï¼Œç†è®ºä¸Šå¯ä»¥è®¿é—®çš„å†…å­˜é«˜è¾¾16EBå­—èŠ‚ï¼ˆ2çš„64æ¬¡å¹‚ï¼‰ï¼Œå®é™…ä¸ŠåŸºäºéœ€æ±‚ã€æ€§èƒ½ã€æˆæœ¬çš„è€ƒè™‘å®é™…ä¸Šä¹Ÿç”¨ä¸äº†è¿™ä¹ˆå¤šï¼Œåœ¨AMD64æ¶æ„ä¸­ï¼Œåªæ”¯æŒåˆ°äº†52ä½4PBçš„åœ°å€æ€»çº¿å’Œ48ä½ï¼ˆ256TBï¼‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ç›®å‰64ä½çš„ç¡¬ä»¶æœ€å¤§åªèƒ½æ”¯æŒåˆ°256TBã€‚æ­¤å¤–æ“ä½œç³»ç»Ÿä¸€ä¾§è¿˜ä¼šåŠ ä¸Šè‡ªå·±çš„çº¦æŸï¼Œ64ä½çš„Linuxåˆ™åˆ†åˆ«æ”¯æŒ47ä½ï¼ˆ128TBï¼‰çš„è™šæ‹Ÿå†…å­˜åœ°å€å’Œ46ä½ï¼ˆ64TBï¼‰ç‰©ç†å†…å­˜åœ°å€ã€‚è€Œwindowsåªæ”¯æŒ44ä½ï¼ˆ16TBï¼‰ç‰©ç†å†…å­˜åœ°å€ã€‚</p></blockquote><p>å°½ç®¡Linuxä¸‹64ä½æŒ‡é’ˆçš„é«˜18ä½ä¸èƒ½ç”¨æ¥å¯»å€ï¼Œä½†æ˜¯å‰©ä½™çš„46ä½æŒ‡é’ˆæ‰€èƒ½æ”¯æŒçš„64TBçš„å†…å­˜åœ¨ä»Šå¤©ä»ç„¶èƒ½å……åˆ†æ»¡è¶³å¤§å‹æœåŠ¡å™¨çš„éœ€è¦ï¼Œå› æ­¤ï¼ŒZGCçš„æŸ“è‰²æŒ‡é’ˆç›¯ä¸Šè¿™46ä½å¯»å€åœ°å€ï¼Œæˆªå–æœ€é«˜çš„4ä½æ¥å­˜å‚¨4ä¸ªæ ‡è¯†ä¿¡æ¯ã€‚é€šè¿‡è¿™4ä¸ªæ ‡è®°ï¼Œåˆ¤æ–­å¯¹è±¡å½“å‰çŠ¶æ€ï¼Œè¿›è€Œè¿›è¡Œä¸‹ä¸€æ­¥å¯»å€ã€‚ä½†<strong>è¿™4ä½çš„å ç”¨ä¹Ÿè¿›ä¸€æ­¥å‹ç¼©äº†åœ°å€ç©ºé—´ï¼Œè®©åŸæœ¬çš„46ä½ç©ºé—´å˜æˆäº†44ä½ï¼Œå³ZGCæœ€å¤§å¯ç®¡ç†çš„å†…å­˜ç©ºé—´å‡å°‘åˆ°4TBã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210625010703.png"></p><p>è™½ç„¶æŸ“è‰²æŒ‡é’ˆæœ‰4TBçš„å†…å­˜é™åˆ¶ï¼Œä¸èƒ½æ”¯æŒ32ä½å¹³å°ï¼Œä¸èƒ½æ”¯æŒå‹ç¼©æŒ‡é’ˆç­‰çº¦æŸï¼Œä½†å®ƒå¸¦æ¥çš„æ”¶ç›Šå´æ˜¯éå¸¸å¯è§‚çš„ã€‚å…¶ä¸­æŸ“è‰²åŒ…æ‹¬ä¸‹é¢çš„ä¸‰å¤§ä¸»è¦ä¼˜åŠ¿ï¼š</p><ul><li><strong>æŸ“è‰²æŒ‡é’ˆå¯ä»¥ä½¿å¾—ä¸€æ—¦æŸä¸ªRegionçš„å­˜æ´»å¯¹è±¡è¢«ç§»èµ°ä¹‹åï¼Œè¿™ä¸ªRegionç«‹å³å°±èƒ½è¢«é‡Šæ”¾é‡ç”¨ï¼Œè€Œä¸ç”¨ç­‰å¾…æ•´ä¸ªå †ä¸­çš„æ‰€æœ‰æŒ‡å‘è¯¥Regionçš„å¼•ç”¨éƒ½è¢«ä¿®æ­£ä¹‹åæ‰èƒ½è¢«æ¸…ç†ã€‚</strong>è¿™ä¸€ç‚¹ç›¸æ¯”èµ·Shenandoahæ˜¯ä¸€ä¸ªé¢‡å¤§çš„ä¼˜åŠ¿ã€‚ä½¿å¾—åªè¦ç†è®ºä¸Šè¿˜æœ‰ä¸€ä¸ªç©ºé—²çš„Regionï¼ŒZGCå°±èƒ½å®Œæˆæ”¶é›†ï¼Œè€ŒShenandoahéœ€è¦ç­‰å¾…æ‰€æœ‰çš„å¼•ç”¨æ›´æ–°å®Œæˆæ‰èƒ½é‡Šæ”¾å›æ”¶é›†ä¸­çš„Regionï¼Œè¿™æ„å‘³ç€å¦‚æœå †ä¸­å‡ ä¹æ‰€æœ‰çš„å¯¹è±¡éƒ½å­˜æ´»ï¼Œé‚£ä¹ˆéœ€è¦1:1çš„ç©ºé—²Regionå®Œæˆå¯¹è±¡çš„å¤åˆ¶ã€‚ç›¸è¾ƒäºè¿™ä¸€ç‚¹ZGCæœ‰ç»å¯¹çš„ä¼˜åŠ¿ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™æ ·çš„æ•ˆæœï¼Œè¿™å…¨éƒ¨å½’åŠŸäºZGCâ€œè‡ªæ„ˆâ€çš„ç‰¹æ€§ã€‚</li><li><strong>æŸ“è‰²æŒ‡é’ˆå¯ä»¥å¤§å¹…åº¦å‡å°‘åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­å†…å­˜å±éšœçš„ä½¿ç”¨æ•°é‡</strong>ï¼Œè®¾ç½®å†…å­˜å±éšœï¼Œå°¤å…¶æ˜¯å†™å±éšœçš„ç›®çš„æ˜¯ä¸ºäº†è®°å½•å¯¹è±¡å¼•ç”¨çš„å˜åŠ¨æƒ…å†µï¼Œå¦‚æœå°†è¿™äº›ä¿¡æ¯ç›´æ¥ç»´æŠ¤åœ¨æŒ‡é’ˆä¸­ï¼Œåˆ™å¯ä»¥çœä¸‹ä¸€äº›ä¸“é—¨çš„è®°å½•æ“ä½œï¼ŒZGCæ²¡æœ‰ä½¿ç”¨ä»»ä½•çš„è¯»å±éšœï¼Œåªä½¿ç”¨äº†éƒ¨åˆ†çš„å†™å±éšœã€‚æ²¡æœ‰äº†è¯»å±éšœï¼ŒZGCçš„ååé‡è‡ªç„¶ä¹Ÿæ›´é«˜ä¸€äº›ã€‚</li><li><strong>æŸ“è‰²æŒ‡é’ˆå¯ä»¥ä½œä¸ºä¸€ç§æ‰©å±•æ•°æ®ç»“æ„ç”¨æ¥è®°å½•æ›´å¤šçš„ä¿¡æ¯ï¼Œä»¥ä¾¿æ—¥åæé«˜æ€§èƒ½</strong>ã€‚ä½†æ˜¯åŒæ—¶æˆ‘ä»¬ä¹Ÿéœ€è¦å ç”¨æ›´å¤šå¯»å€ä½ç½®ã€‚Linuxä¸‹å¯»å€çš„æŒ‡é’ˆçš„å‰18ä½æ˜¯æ²¡æœ‰ä½¿ç”¨çš„ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæ‰©å±•åˆ©ç”¨ï¼Œä¸ä»…å¯ä»¥æ‰©å±•ZGCå¯ç®¡ç†çš„æœ€å¤§å †4TBä¸Šé™ï¼Œè¿˜å¯ä»¥æ‰©å±•æ›´å¤šçš„åŠŸèƒ½æé«˜åƒåœ¾å›æ”¶æ•ˆç‡ã€‚</li></ul><h3 id="åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ-1"><a href="#åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ-1" class="headerlink" title="åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ"></a>åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸ</h3><p>ä¸Šé¢æˆ‘ä»¬ç®€å•ä»‹ç»äº†ZGC çš„å†…å­˜å¸ƒå±€å’ŒæŸ“è‰²æŒ‡é’ˆæŠ€æœ¯ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ZGCçš„åƒåœ¾å›æ”¶å·¥ä½œå‘¨æœŸã€‚ZGCçš„å·¥ä½œå‘¨æœŸå¤§è‡´å¯ä»¥åˆ†ä¸º4ä¸ªå¤§é˜¶æ®µï¼Œå¹¶ä¸”è¿™ä¸ª4ä¸ªé˜¶æ®µå…¨éƒ¨éƒ½æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ï¼Œä»…æ˜¯ä¸¤ä¸ªé˜¶æ®µä¸­é—´ä¼šå­˜åœ¨çŸ­æš‚çš„åœé¡¿å°é˜¶æ®µã€‚ä»¥ä¸‹ZGCçš„å›æ”¶é˜¶æ®µï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210626231527.png"></p><ul><li><strong>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰</strong>ï¼šä¸G1ã€Shenandoah ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°æ˜¯éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œå‰åä¹Ÿè¦ç»è¿‡ç±»ä¼¼äºG1ã€shenandoah çš„åˆå§‹æ ‡è®°ã€æœ€ç»ˆæ ‡è®°çš„çŸ­æš‚åœé¡¿ï¼Œè€Œä¸”è¿™äº›åœé¡¿é˜¶æ®µæ‰€åšçš„äº‹æƒ…åœ¨ç›®æ ‡ä¸Šä¹Ÿæ˜¯ç›¸ç±»ä¼¼çš„ã€‚ä¸åŒçš„æ˜¯ï¼ŒZGCçš„æ ‡è®°æ˜¯åœ¨æŒ‡é’ˆä¸Šè€Œä¸æ˜¯åœ¨å¯¹è±¡ä¸Šè¿›è¡Œï¼Œæ ‡è®°é˜¶æ®µä¼šæ›´æ–°æŸ“è‰²æŒ‡é’ˆä¸­çš„<code>Marked0</code>ã€<code>Marked1</code>ã€‚</li><li><strong>å¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆConcurrent Prepare for Relocateï¼‰</strong>ï¼šè¿™ä¸ªé˜¶æ®µéœ€è¦æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº› Regionï¼Œå°†è¿™äº› Region ç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰ã€‚é‡åˆ†é…é›†ä¸G1æ”¶é›†å™¨çš„å›æ”¶é›†ï¼ˆCollection Setï¼‰è¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼ŒZGC åˆ’åˆ†Regionçš„ç›®çš„å¹¶ä¸æ˜¯åƒG1é‚£æ ·åšæ”¶ç›Šä¼˜å…ˆçš„å¢é‡å›æ”¶ã€‚ç›¸åZGCæ¯æ¬¡å›æ”¶éƒ½ä¼šæ‰«ææ‰€æœ‰çš„Regionï¼Œç”¨æ›´å¤§èŒƒå›´çš„æ‰«ææˆæœ¬æ¢å–G1ä¸­è®°å¿†é›†çš„ç»´æŠ¤æˆæœ¬ã€‚ZGCçš„é‡åˆ†é…é›†åªæ˜¯å†³å®šäº†é‡Œé¢çš„å­˜æ´»å¯¹è±¡ä¼šè¢«é‡æ–°å¤åˆ¶åˆ°å…¶ä»–çš„Regionä¸­ï¼Œé‡Œé¢çš„ Region ä¼šè¢«é‡Šæ”¾ï¼Œè€Œå¹¶ä¸èƒ½è¯´å›æ”¶è¡Œä¸ºå°±åªæ˜¯é’ˆå¯¹è¿™ä¸ªé›†åˆä¸­çš„Regionè¿›è¡Œçš„ã€‚å› ä¸ºæ ‡è®°çš„è¿‡ç¨‹æ˜¯é’ˆå¯¹å…¨å †çš„ã€‚</li><li><strong>å¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰</strong>ï¼šé‡åˆ†é…æ˜¯ZGCæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„Regionä¸Šï¼Œå¹¶é‡åˆ†é…é›†ä¸­çš„æŸä¸ªRegionç»´æŠ¤ä¸€å¼ è½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§å¯¹è±¡åˆ°æ–°å¯¹è±¡çš„è½¬å‘å…³ç³»ã€‚å¾—ç›ŠäºæŸ“è‰²æŒ‡é’ˆçš„æ”¯æŒï¼Œ<strong>ZGCæ”¶é›†å™¨èƒ½ä»…ä»å¼•ç”¨ä¸Šå°±æ˜ç¡®å¾—çŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¤„äºé‡åˆ†é…é›†åˆä¸­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ­¤æ—¶å¹¶å‘è®¿é—®ä½äºé‡åˆ†é…é›†ä¸­çš„å¯¹è±¡ï¼Œè¿™æ¬¡è®¿é—®å°†ä¼šè¢«é‡åˆ°çš„å†…å­˜å±éšœæˆªè·ï¼Œç„¶åç«‹å³æ ¹æ®Regionä¸Šçš„è½¬å‘è®°å½•å°†è®¿é—®è½¬å‘åˆ°æ–°å¤åˆ¶çš„å¯¹è±¡ä¸Šï¼Œå¹¶ä¸”åŒæ—¶ä¿®æ­£æ›´æ–°è¯¥å¼•ç”¨çš„å€¼ä½¿å…¶ç›´æ¥æŒ‡å‘æ–°å¯¹è±¡ã€‚</strong>ZGCå°†è¿™ç§è¡Œä¸ºç§°ä¸ºæŒ‡é’ˆçš„â€œ<code>è‡ªæ„ˆ</code>â€ï¼ˆSelf-Healingï¼‰èƒ½åŠ›ã€‚</li></ul><blockquote><p>è¿™ç§è‡ªæ„ˆèƒ½åŠ›ç›¸è¾ƒäºShenandoahçš„Brooks Pointerï¼Œåªæœ‰ç¬¬ä¸€æ¬¡ä¼šå’ŒBrookséœ€è¦è¿›è¡Œä¸€æ¬¡è½¬å‘ï¼Œè€Œåç»­çš„è®¿é—®éƒ½æ˜¯ç›´æ¥è®¿é—®ã€‚</p></blockquote><ul><li><strong>å¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰</strong>ï¼šé‡æ˜ å°„æ‰€åšçš„å°±æ˜¯ä¿®æ­£å †ä¸­æ‰§è¡Œé‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹ä»ç›®æ ‡è§’åº¦çœ‹æ˜¯ä¸Shenandoah å¹¶å‘å¼•ç”¨æ›´æ–°é˜¶æ®µä¸€æ ·çš„ï¼Œä½†æ˜¯ZGCçš„å¹¶å‘é‡æ˜ å°„å¹¶ä¸æ˜¯ä¸€ä¸ªâ€œè¿«åˆ‡â€è¦å»å®Œæˆçš„ä»»åŠ¡ã€‚å› ä¸ºZGCçš„å¼•ç”¨æ˜¯å¯ä»¥â€œè‡ªæ„ˆâ€çš„ï¼Œæœ€å¤šåªæ˜¯å¤šä½¿ç”¨ä¸€æ¬¡è½¬å‘æ“ä½œã€‚<strong>é‡æ˜ å°„çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ä¸å˜æ…¢ï¼Œå½“ç„¶è¿˜æœ‰æ¸…ç†è½¬å‘è¡¨è¿™æ ·çš„é™„å¸¦çš„æ”¶ç›Š</strong>ã€‚å› æ­¤<strong>å¹¶å‘é‡æ˜ å°„æ”¾åœ¨äº†ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å·¥ä½œå‘¨æœŸä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µå¤„ç†</strong>ã€‚è¿™æ ·å°±å‡å°‘äº†ä¸€æ¬¡éå†å¯¹è±¡å›¾çš„å¼€é”€ã€‚</li></ul><p>å¾—ç›Šäºè¿™äº›ä¼˜ç§€çš„è®¾è®¡ï¼ŒZGCçš„æ€§èƒ½ç›¸è¾ƒäºä¸Šä¸€ä»£Parallel ã€G1ä¹Ÿæ˜¯å¼‚å¸¸çš„å‡ºä¼—ï¼Œè¡¨ç°ç”¨â€œ<strong>ä»¤äººéœ‡æƒŠï¼Œé©å‘½æ€§çš„ZGC</strong>â€æ¥æè¿°æ¯«ä¸ä¸ºè¿‡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210626231827.png"></p><h3 id="å‚æ•°ä»‹ç»"><a href="#å‚æ•°ä»‹ç»" class="headerlink" title="å‚æ•°ä»‹ç»"></a>å‚æ•°ä»‹ç»</h3><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>-XX:+UnlockExperimentalVMOptions -XX:+UseZGC</code> å‚æ•°å¯ä»¥ç”¨æ¥å¯ç”¨ï¼ŒZGCä¸€äº›å¸¸ç”¨å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li><code>-XX:ZCollectionInterval</code> :å›ºå®šæ—¶é—´é—´éš”è¿›ï¨ˆgcï¼Œé»˜è®¤å€¼ä¸º0ã€‚</li><li><code>-XX:ZAllocationSpikeTolerance</code> :å†…å­˜åˆ†é…é€Ÿç‡é¢„ä¼°çš„ä¸€ä¸ªä¿®æ­£å› å­ï¼Œé»˜è®¤å€¼ä¸º2ï¼Œä¸€èˆ¬ï¥§éœ€è¦ï¤æ”¹ã€‚</li><li><code>-XX:ZProactive</code> :æ˜¯å¦å¯ç”¨ä¸»åŠ¨å›æ”¶ç­–ï¥¶ï¼Œé»˜è®¤å€¼ä¸ºtrueï¼Œå»ºè®®å¼€å¯ã€‚</li><li><code>-XX:ZUncommit</code> :å°†ï¥§å†ä½¿ç”¨çš„å†…å­˜è¿˜ç»™OSï¼ŒJDK13ä»¥åå¯ä»¥ä½¿ç”¨ï¼› JVMä¼šè®©å†…å­˜ï¥§ä¼šé™åˆ° Xms ä»¥ä¸‹ï¼Œæ‰€ä»¥å¦‚æœXmxå’ŒXmsé…ç½®ä¸€æ ·è¿™ä¸ªå‚æ•°å°±ä¼šå¤±æ•ˆã€‚</li><li><code>-XX:+UseLargePages -XX:ZPath</code> :ä½¿ç”¨å¤§å†…å­˜é¡µã€‚ Large Pagesåœ¨Linuxç§°ä¸ºHuge Pagesï¼Œé…ç½® zgcä½¿ç”¨Huge Pageså¯ä»¥è·å¾—ï¤å¥½çš„æ€§èƒ½ï¼ˆååï¥¾ã€å»¶è¿Ÿã€å¯åŠ¨æ—¶é—´ï¼‰ã€‚ é…ç½®Huge Pagesæ—¶ï¼Œä¸€èˆ¬é…åˆZPathä½¿ç”¨ã€‚é…ç½®æ–¹æ³•å¯ä»¥è§:<a href="https://wiki.openjdk.java.net/display/zgc/Main">https://wiki.openjdk.java.net/display/zgc/Main</a></li><li><code>-XX:UseNUMA</code> :å¯ç”¨NUMAæ”¯æŒã€æŒ‚è½½å¾ˆå¤šCPUï¼Œæ¯ä¸ªCPUæŒ‡å®šä¸€éƒ¨åˆ†å†…å­˜æ¡çš„ç³»ç»Ÿã€‘ã€‚ ZGCé»˜è®¤å¼€å¯NUMAæ”¯æŒï¼Œæ„å‘³ç€åœ¨åˆ†é…å †å†…å­˜æ—¶ï¼Œä¼šå°½ï¥¾ä½¿ç”¨NUMA-localçš„å†…å­˜ã€‚å¼€å¯å’Œå…³é—­å¯ä»¥ä½¿ç”¨ <code>-XX:+UseNUMA</code> æˆ–è€… <code>-XX:-UseNUMA</code> ã€‚ </li><li><code>-XX:ZFragmentationLimit</code>:æ ¹æ®å½“å‰regionå·²å¤§äºZFragmentationLimitï¼Œè¶…è¿‡åˆ™å›æ”¶ï¼Œé»˜è®¤ä¸º25ã€‚</li><li><code>-XX:ZStatisticsInterval</code> :è®¾ç½®æ‰“å°ZStatç»Ÿè®¡æ•°æ®(cpuã€å†…å­˜ç­‰log)çš„é—´éš”ã€‚ </li></ul><p>æ­¤å¤–è¿˜æœ‰å‰é¢æè¿‡çš„å¹¶å‘çº¿ç¨‹æ•°å‚æ•° <code>-XX:ConcGCThreads=n</code> ï¼Œè¿™ä¸ªå‚æ•°å¯¹äºå¹¶å‘æ‰§ï¨ˆçš„GC ç­–ï¥¶éƒ½å¾ˆé‡è¦ï¼Œéœ€è¦æ ¹æ®CPUæ ¸å¿ƒæ•°è€ƒè™‘ï¼Œé…ç½®å¤ªå¤šå¯¼è‡´çº¿ç¨‹åˆ‡æ¢æ¶ˆè€—å¤ªå¤§ï¼Œé…ç½®å¤ªå°‘å¯¼è‡´å›æ”¶åƒåœ¾é€Ÿåº¦è·Ÿï¥§ä¸Šç³»ç»Ÿä½¿ç”¨çš„é€Ÿåº¦ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€èŠ‚æˆ‘ä»¬æ¢³ç†äº†å…¨æ–°ä¸€ä»£â€œä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨â€åƒåœ¾å¤„ç†å™¨ï¼Œå³Shenandoahå’ŒZGCï¼ŒShenandoahç”±RedHatä¸»æŒå¼€å‘ï¼Œç«‹é¡¹æ—¶é—´æ—©äºZGCã€‚æ•´ä½“è®¾è®¡ä¸Šå’ŒG1ç±»ä¼¼ï¼Œåœ¨G1çš„åŸºç¡€ä¸Šåˆ›æ–°çš„æŠ›å¼ƒäº†åˆ†ä»£æ•´ç†ï¼Œä½¿ç”¨â€œé“¾æ¥çŸ©é˜µâ€ä»£æ›¿RSetå¹¶æ”¯æŒå¹¶æ•´ç†ï¼Œæå¤§çš„ç¼©çŸ­äº†shenandoah çš„STWæ—¶é—´ã€‚Shenandoahçš„åƒåœ¾å›æ”¶æµç¨‹æ•´ä½“ä¸Šå’ŒG1ç±»ä¼¼ï¼Œåœ¨æœ€åçš„æ•´ç†é˜¶æ®µG1é€šè¿‡STWå¯¹è±¡å¤åˆ¶è½¬ç§»æ¥è¿›è¡Œå †ç©ºé—´æ•´ç†ï¼Œè€ŒShenandoah è¿™æ˜¯é€šè¿‡è¿™ä¸ªè¿‡ç¨‹æ‹†åˆ†æˆå¤åˆ¶ã€å¹¶å‘å¼•ç”¨æ›´æ–°ï¼Œæœ€ç»ˆå¼•ç”¨æ›´æ–°å’Œæ¸…ç†è¿™å‡ ä¸ªé˜¶æ®µï¼Œå®ç°å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¹¶å‘æ‰§è¡Œã€‚åªæœ‰åœ¨å¤åˆ¶ã€æœ€ç»ˆå¼•ç”¨æ›´æ–°æ—¶å€™éœ€è¦è¿›è¡ŒçŸ­æš‚çš„STWã€‚è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³ã€‚åŒæ ·ï¼ŒShenandoahé€šè¿‡å¢åŠ ä¸€ä¸ªBrooks Pointerå’Œè¯»å±éšœæ¥è§£å†³å¹¶å‘æ•´ç†è¿‡ç¨‹ä¸­çš„å¯¹è±¡å®šä½é—®é¢˜ã€‚æ­£å› ä¸ºå¹¶å‘æ•´ç†çš„å¼•å…¥ï¼ŒShenadoah çš„æš‚åœæ—¶é—´ç›¸è¾ƒäºä¼ ç»Ÿçš„åƒåœ¾æ”¶é›†å™¨æœ‰äº†è´¨çš„é£è·ƒã€‚</p><p>Shenandoah ç”±äºä¸æ˜¯Oracleå®˜æ–¹å¼€å‘çš„åƒåœ¾æ”¶é›†å™¨ï¼Œéš¾å…å—åˆ°ä¸€äº›æ¥è‡ªå®˜æ–¹çš„æ’æŒ¤ã€‚â€œæ ¹æ­£è‹—çº¢â€çš„ZGCä¹Ÿæœ‰éå¸¸äº®çœ¼çš„è¡¨ç°ï¼Œä»æŠ€æœ¯è§’åº¦æ¥çœ‹ZGCé‡‡ç”¨äº†ä¸€æ¡å®Œå…¨ä¸åŒçš„è·¯çº¿ï¼ŒZGCä½¿ç”¨æŸ“è‰²æŒ‡é’ˆæ¥å·§å¦™çš„å®ç°è¿™ä¸ªä¸­é—´å±‚ã€‚ZGCé€šè¿‡åœ¨å¼•ç”¨ä¸Šåšæ–‡ç« ï¼Œå®ƒå ç”¨å¼•ç”¨åœ°å€çš„4ä¸ªé«˜ä½æ¥è®°å½•æ˜¯å¦è¢«æ ‡è®°ï¼Œæ˜¯å¦é‡æ˜ å°„ç­‰ä¿¡æ¯ã€‚ä½†æ˜¯è¿™æ ·çš„å ç”¨åŒæ—¶ä¹Ÿç»™ZGCå¸¦æ¥äº†è¯¸å¦‚æœ€å¤§ç®¡ç†4TBï¼Œä¸èƒ½å¼€å¯å‹ç¼©æŒ‡é’ˆç­‰é™åˆ¶ã€‚æœ€ç»ˆå®éªŒæ•°æ®è¯æ˜è¿™äº›â€œä»£ä»·â€æ¢æ¥çš„æå‡æ˜¯å®Œå…¨å€¼å¾—çš„ã€‚ZGCçš„åƒåœ¾å›æ”¶å·¥ä½œå‘¨æœŸå’ŒG1ã€shenandoahæ˜¯ç›¸ä¼¼çš„ï¼Œä¸åŒçš„ç‚¹ä¹Ÿæ˜¯åœ¨æœ€åå¹¶å‘æ•´ç†ä¸Šï¼Œå¾—ç›ŠäºæŸ“è‰²æŒ‡é’ˆçš„ä¼˜ç§€è®¾è®¡ï¼ŒZGCèƒ½åœ¨å¹¶å‘æ•´ç†é‡æ˜ å°„çš„è¿‡ç¨‹ä¸­å¯ä»¥æ›´å¿«çš„é‡Šæ”¾Regionï¼Œæé«˜ç©ºé—´åˆ©ç”¨ç‡ï¼Œå¹¶ä¸”æŒ‡é’ˆè¿˜å…·æœ‰è‡ªæ„ˆåŠŸèƒ½ï¼Œè¿™ç›¸è¾ƒäºShenandoahæ¯æ¬¡è®¿é—®æ¬¡æ¬¡è½¬å‘åˆæœ‰äº†æå¤§çš„æ€§èƒ½æå‡ã€‚è€Œå»¶è¿Ÿä¸ŠZGCä¹Ÿæ˜¯æŠŠä¼ ç»Ÿåƒåœ¾æ”¶é›†å™¨ç§’çš„ä¸€å¡Œç³Šæ¶‚ã€‚</p><p>è¿™ä¸€è·¯è¿‡æ¥æˆ‘ä»¬çœ‹äº†è¿™ä¹ˆå¤šåƒåœ¾æ”¶é›†å™¨ï¼Œæˆ‘ç›¸ä¿¡ä½ ä¹Ÿå»ºç«‹ä»¥å¯¹åƒåœ¾æ”¶é›†å™¨å…¨é¢çš„è®¤çŸ¥ä½“ç³»ã€‚æ¯ä¸ªåƒåœ¾æ”¶é›†å™¨éƒ½å¾ˆä¼˜ç§€ï¼Œå¦‚æœæŠŠJavaæ¯”ä½œä¸€ä¸ªå¥³ç‹ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†å™¨å°±æ˜¯å¥¹çš„æƒåˆ©çš„çš‡å† ï¼Œè€ŒZGCåˆ™æ˜¯çš‡å† ä¸Šæœ€äº®çœ¼çš„é‚£ä¸€é¢—å®çŸ³ã€‚æˆ‘ä»¬åƒåœ¾æ”¶é›†å™¨çš„æ¢³ç†å°±æš‚æ—¶å‘Šä¸€æ®µè½äº†ï¼Œé€šè¿‡è¿™ä¸¤å°èŠ‚ä¸¤ä¸‡å­—çš„æ€»ç»“æˆ‘å¾ˆåº†å¹¸ï¼Œæˆ‘èƒ½å¦‚æ­¤ç»†è‡´å…¨é¢çš„è®¤è¯†Javaåƒåœ¾æ”¶é›†å™¨ã€‚ç»§ç»­å‰è¿›ï¼ŒåŠ æ²¹ï¼</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰</li><li>ZGC å’Œ Shenandoah ä»‹ç»</li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM GCç¯‡ â€” åƒåœ¾æ”¶é›†å™¨ï¼ˆä¸Šï¼‰</title>
    <link href="/2021/06/11/garbage-collector-1/"/>
    <url>/2021/06/11/garbage-collector-1/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>å‰é¢ä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†ä»‹ç»äº†GCçš„ä¸€èˆ¬æ€§åŸç†å’Œåƒåœ¾å›æ”¶ç®—æ³•ï¼Œé€šè¿‡å¯¹å‰é¢çŸ¥è¯†çš„å­¦ä¹ ï¼Œæˆ‘ä»¬åŸºæœ¬æŒæ¡äº†åƒåœ¾æ”¶é›†çš„ä¸€èˆ¬ç†è®ºçŸ¥è¯†ã€‚ä½†æ˜¯ç†è®ºç»ˆç©¶çŸ¥è¯†åœ¨ä¹‹ä¸Šï¼Œè·ç¦»çœŸæ­£çš„å®è·µè¿˜æœ‰ä¸€å®šçš„å·®è·ã€‚å‰é¢æˆ‘ä»¬æåˆ°äº†ç¬¬ä¸€ä¸ªå¸¦æœ‰å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†çš„ç¼–ç¨‹è¯­è¨€å¹¶ä¸æ˜¯ Java è€Œæ˜¯1960å¹´è¯ç”Ÿçš„Lispã€‚å½“ç„¶è¿™ä¸€å°èŠ‚ä¸­æˆ‘ä»¬å¹¶ä¸ä¼šæ¢³ç† Lisp å®ç°çš„åƒåœ¾æ”¶é›†å™¨ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¼šå…ˆä»ç»å…¸åƒåœ¾æ”¶é›†å™¨å…¥æ‰‹ï¼Œæ¢³ç†å„ä¸ªåƒåœ¾æ”¶é›†å™¨çš„ç‰¹æ€§ã€ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨åœºæ™¯ã€‚å½“ç„¶éšç€åƒåœ¾æ”¶é›†å™¨çš„æ•ˆç‡çš„ä¸æ–­æå‡å…¶å®ç°çš„å¤æ‚åº¦ä¹Ÿåœ¨ä¸æ–­æå‡ã€‚æˆ‘ä»¬ä¼šä¸»è¦çš„ç¯‡å¹…å»ä»‹ç»CMSå’ŒG1åŸç†åŠéƒ¨åˆ†å®ç°ç»†èŠ‚ï¼Œå‡åå¯¹åƒåœ¾æ”¶é›†å™¨çš„ç†è§£ã€‚ä»Šå¤©æ˜¯å…­ä¸€å„¿ç«¥èŠ‚ï¼Œå„ä½æœ‹å‹åå¥½æ¥ï¼Œæˆ‘ä»¬çš„æ¢³ç†å¼€å§‹äº†ã€‚ğŸ˜‚</p><h2 id="ç»å…¸åƒåœ¾æ”¶é›†å™¨æ¦‚è¿°"><a href="#ç»å…¸åƒåœ¾æ”¶é›†å™¨æ¦‚è¿°" class="headerlink" title="ç»å…¸åƒåœ¾æ”¶é›†å™¨æ¦‚è¿°"></a>ç»å…¸åƒåœ¾æ”¶é›†å™¨æ¦‚è¿°</h2><p>è¿™é‡Œçš„æåˆ°çš„â€œç»å…¸â€å¹¶éå‡ºäºæƒ…æ€€ï¼Œåªæ˜¯ä»–ä»¬çš„ç¡®æŒºç»å…¸ï¼Œæ˜¯å‡ºäºè®¨è®ºèŒƒå›´çš„é™å®šã€‚æˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„æ˜¯åœ¨ JDK 7 Update 4 ä¹‹åï¼ˆè¿™ä¸ªç‰ˆæœ¬ä¸­æ­£å¼æä¾›äº†å•†ç”¨çš„ G1 æ”¶é›†å™¨ï¼Œæ­¤å‰ G1 ä»å¤„äºå®éªŒçŠ¶æ€ï¼‰ã€JDK 11 æ­£å¼å‘å¸ƒä¹‹å‰ï¼ŒOracleJDK ä¸­æä¾›çš„ HotSpot è™šæ‹Ÿæœºæ‰€åŒ…å«çš„å…¨éƒ¨å¯ç”¨çš„åƒåœ¾æ”¶é›†å™¨ã€‚ä½¿ç”¨â€œç»å…¸â€æ¥æè¿°æ˜¯ä¸ºäº†åŒºåˆ†å¼€ç›®å‰å‡ æ¬¾æ­£å¤„äºå®éªŒçŠ¶æ€ï¼Œä½†æ‰§è¡Œæ•ˆæœå´å…·æœ‰é©å‘½æ€§æ”¹è¿›çš„é«˜æ€§èƒ½ä½å»¶è¿Ÿçš„åƒåœ¾å›æ”¶å™¨ã€‚è¿™äº›ç»å…¸çš„åƒåœ¾å›æ”¶å™¨è™½ç„¶å·²ç»ä¸ç®—æ˜¯æœ€å…ˆè¿›çš„æŠ€æœ¯ï¼Œä½†æ˜¯è¿™äº›ç»å…¸çš„åƒåœ¾å›æ”¶å™¨éƒ½åœ¨ç”Ÿäº§ç¯å¢ƒç»è¿‡åƒé”¤ç™¾ç‚¼ï¼Œè¶³å¤Ÿæˆç†Ÿï¼ŒåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºç°åœ¨åˆ°æœªæ¥å‡ å¹´å†…å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šæ”¾å¿ƒä½¿ç”¨çš„åƒåœ¾æ”¶é›†å™¨ï¼Œå› æ­¤æŒæ¡ä»–ä»¬çš„ç‰¹ç‚¹å’Œé…ç½®ç»†èŠ‚å¾ˆé‡è¦ã€‚ä¸‹å›¾æ˜¯å„ä¸ªç»å…¸åƒåœ¾æ”¶é›†å™¨ä¹‹é—´çš„å…³ç³»ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210602003646.png"></p><p>ä¸Šé¢è¿™å¼ å›¾å±•ç°äº†ä¸ƒç§ä½œç”¨äºä¸åŒåˆ†ä»£çš„åƒåœ¾å›æ”¶å™¨ï¼Œå›¾ä¸­åƒåœ¾æ”¶é›†å™¨æ‰€å¤„çš„ä½ç½®åˆ™è¡¨ç¤ºä»–ä»¬å·¥ä½œçš„åŒºåŸŸå³å¹´è½»ä»£æˆ–è€å¹´ä»£ã€‚å…¶ä¸­ä¸Šé¢<code>Young Generation</code>è¡¨ç¤ºå¹´è½»ä»£ï¼Œä¸‹é¢çš„<code>Old Generation</code>åˆ™ä»£è¡¨è€å¹´ä»£ã€‚å¦‚æœä¸¤ä¸ªåƒåœ¾å›æ”¶å™¨ä¹‹é—´å­˜åœ¨è¿çº¿ï¼Œåˆ™è¯´æ˜ä»–ä»¬ä¸¤ä¸ªå¯ä»¥æ­é…ä½¿ç”¨ã€‚</p><blockquote><p>âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå…³ç³»å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œç”±äºç»´æŠ¤å’Œå…¼å®¹æ€§æµ‹è¯•çš„æˆæœ¬ï¼Œåœ¨JDK8æ—¶å°† Serial+CMSã€ParNew+Serial Oldè¿™ä¸¤ä¸ªç»„åˆå£°æ˜ä¸ºåºŸå¼ƒï¼ˆJEP173ï¼‰ï¼Œå¹¶åœ¨ JDK 9 ä¸­å®Œå…¨å–æ¶ˆäº†è¿™äº›ç»„åˆçš„æ”¯æŒï¼ˆJEP214ï¼‰ã€‚</p></blockquote><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå›´ç»•ç€è¿™äº›åƒåœ¾å›æ”¶å™¨çš„ç›®æ ‡ã€ç‰¹æ€§ã€åŸç†å’Œä½¿ç”¨åœºæ™¯æ¥äº†è§£ä¸åˆ†æï¼Œå¹¶ä¸”ä¼šç€é‡åˆ†æä¸€äº›CMSå’ŒG1çš„å®ç°ç»†èŠ‚ã€‚è¿™é‡Œéœ€è¦éœ€è¦å…ˆæ˜ç¡®ä¸€ä¸ªè§‚ç‚¹ï¼Œ<strong>ç›®å‰åœ¨ JVM ä¸­æ²¡æœ‰ä¸€ä¸ªåœ¨ä»»ä½•ä¸€ä¸ªåœºæ™¯éƒ½è¡¨ç°çš„å¾ˆå®Œç¾çš„ä¸‡èƒ½åƒåœ¾å›æ”¶å™¨</strong>ï¼Œå¦‚æœè¿™æ ·çš„åƒåœ¾å›æ”¶å™¨å­˜åœ¨çš„è¯ï¼Œä¹Ÿå°±ä¸ä¼šå‡ºç° HotSpot ä¸­è¿™ä¹ˆå¤šåƒåœ¾å›æ”¶å™¨å¹¶å­˜çš„æƒ…å†µäº†ã€‚ </p><h2 id="Serialæ”¶é›†å™¨ï¼ˆSerial-SerialOldï¼‰"><a href="#Serialæ”¶é›†å™¨ï¼ˆSerial-SerialOldï¼‰" class="headerlink" title="Serialæ”¶é›†å™¨ï¼ˆSerial + SerialOldï¼‰"></a>Serialæ”¶é›†å™¨ï¼ˆSerial + SerialOldï¼‰</h2><p>Serial æ”¶é›†å™¨æ˜¯æœ€åŸºç¡€ã€ä¹Ÿæ˜¯å†å²æœ€æ‚ ä¹…çš„åƒåœ¾æ”¶é›†å™¨ã€‚<strong>æ›¾ç»ï¼ˆJDK1.3.1ä¹‹å‰ï¼‰æ˜¯HotSpotæ”¶é›†å™¨çš„å”¯ä¸€é€‰æ‹©</strong>ã€‚ä»è¿™ä¸ªåå­—ä¹Ÿä¸éš¾çŒœåˆ°ï¼Œè¿™ä¸ªåƒåœ¾æ”¶é›†å™¨æ˜¯ä¸€ä¸ª<code>å•çº¿ç¨‹å·¥ä½œ</code>çš„åƒåœ¾æ”¶é›†å™¨ã€‚â€œå•çº¿ç¨‹â€å¹¶ä¸ä»…ä»…æ„å‘³ç€ä»–åªä¼šæ˜¯ä¼šç”¨ä¸€ä¸ªå¤„ç†å™¨æˆ–æ˜¯ä¸€ä¸ªæ”¶é›†çº¿ç¨‹å»å®Œæˆåƒåœ¾æ”¶é›†ï¼Œå®ƒæ›´æ˜¯è¦å¼ºè°ƒ<strong>å®ƒåœ¨è¿›è¡Œåƒåœ¾å›æ”¶çš„æ—¶å€™ï¼Œå¿…é¡»æš‚åœå…¶ä»–çš„å·¥ä½œçº¿ç¨‹ï¼ˆSTWï¼‰</strong>ç›´åˆ°å®ƒå·¥ä½œç»“æŸã€‚Serialåƒåœ¾æ”¶é›†å™¨åœ¨å¹´è½»ä»£å·¥ä½œä½¿ç”¨çš„<code>æ ‡è®°å¤åˆ¶ç®—æ³•ï¼ˆmark-copyï¼‰</code>ï¼Œåœ¨å·¥ä½œåœ¨è€å¹´ä»£çš„æ˜¯ SerialOld åƒåœ¾æ”¶é›†å™¨ä½¿ç”¨<code>æ ‡è®°æ¸…é™¤æ•´ç†ç®—æ³•ï¼ˆmark-sweep-compactï¼‰</code>ï¼Œå®ƒçš„ç‰¹æ€§å’ŒSerialä¸€è‡´éƒ½æ˜¯<code>å•çº¿ç¨‹</code>åƒåœ¾æ”¶é›†å™¨ã€‚ä½†æ˜¯è¿™æ ·çœ‹ä¼¼è½åçš„åƒåœ¾æ”¶é›†å™¨å¹¶æ²¡æœ‰è¢«åºŸå¼ƒã€‚å•çº¿ç¨‹çœŸçš„å°±æ²¡æœ‰ä¼˜ç‚¹å—ï¼Ÿå®é™…ä¸Š Serial ä¾æ—§æ˜¯HotSpotè™šæ‹Ÿæœºè¿è¡Œåœ¨å®¢æˆ·ç«¯æ¨¡å¼ä¸‹çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ã€‚å•çº¿ç¨‹åƒåœ¾æ”¶é›†å™¨è™½ç„¶å’Œå¤šçº¿ç¨‹åƒåœ¾æ”¶é›†å™¨ç›¸æ¯”æ˜¾å¾—ä½æ•ˆï¼Œä½†æ˜¯ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥çœ‹æ„å‘³ç€<strong>ç®€å•å¯é </strong>ï¼Œå¯¹äºå†…å­˜æœ‰é™çš„ç¯å¢ƒæ¥è¯´<strong>å®ƒåˆæ˜¯å†…å­˜æ¶ˆè€—æœ€å°‘</strong>çš„ã€‚ å¯¹äºåªæœ‰å•æ ¸çš„ç¯å¢ƒæ´»ç€CPUæ ¸å¿ƒæ•°å°‘çš„ç¯å¢ƒæ¥è¯´ï¼Œå‡å°‘ä¸Šä¸‹æ–‡çš„åˆ‡æ¢å®ƒåˆæ˜¯é«˜æ•ˆçš„ã€‚å› æ­¤å¯¹äº<strong>å†…å­˜å°ã€CPUæ ¸å¿ƒæ•°å°‘ã€ä¸ä¼šé¢‘ç¹å‘ç”Ÿåƒåœ¾æ”¶é›†çš„ç¯å¢ƒï¼ŒSerialæ”¶é›†å™¨ä¼šæ˜¯ä¸€ä¸ªå¥½çš„é€‰æ‹©ã€‚</strong>ä½¿ç”¨ä¸‹é¢çš„JVMå‚æ•°å³å¯ä½¿ç”¨ Serial åƒåœ¾æ”¶é›†å™¨ã€‚</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-XX:+UseSerialGC</span><br></code></pre></td></tr></table></figure><h2 id="Parallelæ”¶é›†å™¨ï¼ˆParallel-Scavenge-Parallel-Oldï¼‰"><a href="#Parallelæ”¶é›†å™¨ï¼ˆParallel-Scavenge-Parallel-Oldï¼‰" class="headerlink" title="Parallelæ”¶é›†å™¨ï¼ˆParallel Scavenge + Parallel Oldï¼‰"></a>Parallelæ”¶é›†å™¨ï¼ˆParallel Scavenge + Parallel Oldï¼‰</h2><p>Parallel æ”¶é›†å™¨ä¹Ÿå«åš<code>å¹¶è¡Œæ”¶é›†å™¨</code>ï¼Œä»–èƒ½<strong>å¹¶è¡Œçš„è¿›è¡Œåƒåœ¾æ”¶é›†</strong>ã€‚<code>Parallel Scavenge</code>æ˜¯ Parallel åœ¨æ–°ç”Ÿä»£è¿è¡Œçš„åƒåœ¾æ”¶é›†å™¨ï¼Œé‡‡ç”¨çš„åŒæ ·ä¹Ÿæ˜¯<code>æ ‡è®°å¤åˆ¶ç®—æ³•ï¼ˆmark-copyï¼‰</code>ï¼Œåœ¨è€å¹´ä»£ä½¿ç”¨çš„æ˜¯ Parallel Old æ”¶é›†å™¨ï¼Œä½¿ç”¨çš„ä¹Ÿæ˜¯<code>æ ‡è®°æ¸…é™¤æ•´ç†ç®—æ³•ï¼ˆmark-sweep-compactï¼‰</code>ã€‚<code>Parallel</code>å’Œ<code>Serial</code>ä¸€æ ·è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶ï¼Œ<strong>Parallel åœ¨æ–°ç”Ÿä»£å’Œè€å¹´ä»£éƒ½ä¼šè§¦å‘STWï¼Œä½†æ˜¯ Parallel æ˜¯é‡‡ç”¨å¹¶è¡Œæ ‡è®°ï¼Œå¹¶è¡Œåƒåœ¾æ”¶é›†ï¼Œå› æ­¤STWæ—¶é—´å’Œåƒåœ¾æ”¶é›†æ—¶é—´ä¼šç›¸è¾ƒäºSerialçŸ­å¾ˆå¤šï¼Œåƒåœ¾æ”¶é›†é€Ÿé€’å¤§å¹…åº¦æé«˜</strong>ã€‚åé¢æˆ‘ä»¬ä¼šä»‹ç» CMS åƒåœ¾æ”¶é›†å™¨ï¼ŒCMS æ–°ç”Ÿä»£ä½¿ç”¨çš„æ˜¯ ParNew è¿™ä¹Ÿæ˜¯ä¸€æ¬¾å¹¶è¡Œçš„åƒåœ¾æ”¶é›†å™¨ï¼Œé‚£ä»–ä»¬åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼ŸParallel ä¾§é‡çš„æ›´å¤šæ˜¯å¯æ§åˆ¶<code>ååé‡ï¼ˆThroughputï¼‰</code>ï¼Œè€Œ<strong>CMSä¾§é‡æ›´çŸ­çš„STWæ—¶é—´</strong>ã€‚Parallelä¹Ÿæ˜¯<code>JDK8çš„é»˜è®¤åƒåœ¾å›æ”¶å™¨</code></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210603011802.png"></p><p>Parallel é€‚ç”¨å¤šæ ¸å¿ƒå¤„ç†å¤„ç†å™¨ï¼Œä¸»è¦ç›®çš„æ˜¯å¢åŠ ååé‡ã€‚å› ä¸ºå¯¹ç³»ç»Ÿèµ„æºçš„æœ‰æ•ˆä½¿ç”¨èƒ½è¾¾åˆ°æ›´é«˜çš„ååé‡ã€‚åœ¨GCæœŸé—´<strong>æ‰€æœ‰çš„CPUå†…æ ¸éƒ½åœ¨å¹¶è¡Œæ¸…ç†åƒåœ¾</strong>ï¼Œæ‰€ä»¥æ€»æš‚åœæ—¶é—´æ›´çŸ­ï¼›åœ¨ä¸¤æ¬¡GCå‘¨æœŸçš„é—´éš”æœŸï¼Œæ²¡æœ‰GCçº¿ç¨‹åœ¨è¿è¡Œï¼Œä¸ä¼šæ¶ˆè€—ä»»ä½•ç³»ç»Ÿèµ„æºã€‚ä½¿ç”¨ä¸‹é¢çš„JVMå‚æ•°å³å¯ä»¥å¼€å¯ParallelGCã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">-XX:+UseParallelGC<br>-XX:+UseParallelOldGC<br>-XX:+UseParallelGC -XX:+UseParallelOldGC<br></code></pre></td></tr></table></figure><p><code>Parallel Scavenge</code>æä¾›äº†ä¸¤ä¸ªå‚æ•°ç”¨äºç²¾å‡†æ§åˆ¶ååé‡ï¼Œåˆ†åˆ«æ˜¯æ§åˆ¶æœ€å¤§åƒåœ¾æ”¶é›†æ—¶é—´çš„<code>-XX:MaxGCPauseMillis</code> å‚æ•°ï¼Œä»¥åŠç›´æ¥è®¾ç½®ååé‡å¤§å°çš„ <code>-XX:GCTimeRatio</code>ã€‚å…¶ä¸­<code>-XX:MaxGCPauseMillis</code> è®¾ç½®ä¸€ä¸ªå¤§äº0çš„æ¯«ç§’æ•°ï¼Œåƒåœ¾æ”¶é›†å™¨å°½é‡æŠŠåƒåœ¾æ”¶é›†æ—¶é—´æ§åˆ¶åœ¨è¿™ä¸ªæ¯«ç§’æ•°å†…ï¼Œå¦‚æœè®¾ç½®è¿‡å°é‚£ä¹ˆæ”¶é›†å™¨çš„ååé‡å°†ä¸‹é™ã€‚<code>-XX:GCTimeRatio</code> è¿™ä¸ªå‚æ•°è®¾ç½®ä¸€ä¸ªå¤§äº0å°äº100çš„æ•´æ•°ï¼Œ<strong>ä¹Ÿå°±æ˜¯åƒåœ¾æ”¶é›†æ—¶é—´å æ€»æ—¶é—´çš„æ¯”ç‡ã€‚è¿™ä¸ªå‚æ•°è®¾ç½®ä¸ºNï¼Œé‚£ä¹ˆç”¨æˆ·ä»£ç æ‰§è¡Œæ—¶é—´ä¸æ€»æ‰§è¡Œæ—¶é—´ä¹‹æ¯”ä¸º</strong><code>N:N+1</code>ã€‚ä¾‹å¦‚ <code>â€”XX:GCTimeRatio=19</code>ï¼Œé‚£ä¹ˆåƒåœ¾æ”¶é›†æ—¶é—´å ç”¨æ€»æ—¶é—´çš„æ¯”ä¾‹ä¸º<code>5%(1/(1+ 19))</code>ã€‚é»˜è®¤å€¼ä¸º99ï¼Œå³1%åƒåœ¾å›æ”¶æ—¶é—´å ç”¨ã€‚Parallelåƒåœ¾æ”¶é›†å™¨æ˜¯ä¸€æ¬¾é«˜ååçš„åƒåœ¾æ”¶é›†å™¨ï¼Œé‚£å®ƒæœ‰ä»€ä¹ˆç¼ºç‚¹å—ï¼ŸParallelåƒåœ¾æ”¶é›†å™¨å·¥ä½œæœŸé—´å¿…é¡»æš‚åœå…¶ä»–çš„å·¥ä½œçº¿ç¨‹ï¼ˆSTWï¼‰ï¼Œå¤šä¸ªåƒåœ¾å›æ”¶å·¥ä½œçº¿ç¨‹åŒæ—¶å·¥ä½œï¼Œè™½ç„¶åƒåœ¾æ¸…ç†æ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯å’Œå…¶ä»–è¿½æ±‚çŸ­æš‚STWçš„åƒåœ¾æ”¶é›†å™¨ï¼ˆCMSã€G1ã€ZGCã€Shenandoahï¼‰ç›¸æ¯”è¿˜æ˜¯åé•¿ã€‚å¹¶ä¸”Parallelæ”¶é›†å™¨çš„æ¸…ç†é€Ÿåº¦ä¼šéšç€å †çš„å¢å¤§è€Œå˜æ…¢ã€‚</p><blockquote><p>ä»€ä¹ˆæ˜¯å¹¶è¡Œå’Œä»€ä¹ˆåˆæ˜¯å¹¶å‘ï¼Œä»–ä»¬ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><p>å¹¶è¡Œæ˜¯æŒ‡åˆ©ç”¨å¤šä¸ªå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¿ƒå¤„ç†å™¨åŒæ—¶å¤„ç†å¤šä¸ªä¸åŒçš„ä»»åŠ¡ã€‚</p><p>å¹¶å‘æ˜¯æŒ‡ä¸€ä¸ªå¤„ç†å™¨çº¿ç¨‹åœ¨å¤šä¸ªä¸åŒçš„ä»»åŠ¡ä¹‹é—´æ¥å›åˆ‡æ¢æ¥å®ç°â€œåŒæ—¶æ‰§è¡Œâ€ã€‚</p></blockquote><h2 id="CMSï¼ˆParNew-CMSï¼‰"><a href="#CMSï¼ˆParNew-CMSï¼‰" class="headerlink" title="CMSï¼ˆParNew + CMSï¼‰"></a>CMSï¼ˆParNew + CMSï¼‰</h2><p>CMS GCçš„å®˜æ–¹åç§°ä¸ºâ€œ<strong>Mostly Concurrent Mark and Sweep Garbage Collector</strong>â€ï¼ˆæœ€å¤§å¹¶å‘æ ‡è®°æ¸…ç†åƒåœ¾æ”¶é›†å™¨ï¼‰ã€‚å…¶ä¸­å¯¹å¹´è½»ä»£ä½¿ç”¨çš„æ˜¯å¹¶è¡Œçš„STWæ–¹å¼çš„æ ‡è®°å¤åˆ¶ç®—æ³•ï¼ˆmark-copyï¼‰ï¼Œå¯¹è€å¹´ä»£ä½¿ç”¨çš„æ˜¯å¹¶å‘æ ‡è®°æ¸…é™¤ç®—æ³•ï¼ˆæ ‡è®°-æ¸…é™¤ï¼‰ã€‚å…¶ä¸­CMSçš„æ ¸å¿ƒæ˜¯æ”¾åœ¨è€å¹´ä»£ï¼Œè€Œå¹´è½»ä»£ä½¿ç”¨çš„ ParNew åƒåœ¾æ”¶é›†å™¨ã€‚<strong>ParNew æ”¶é›†å™¨å®è´¨ä¸Šå°±æ˜¯ Serial æ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬</strong>ï¼Œé™¤äº†ä½¿ç”¨å¤šæ¡çº¿ç¨‹è¿›è¡Œåƒåœ¾æ”¶é›†ä¹‹å¤–ï¼Œå…¶ä½™çš„è¡Œä¸ºåŒ…æ‹¬ Serial åƒåœ¾æ”¶é›†å™¨çš„æ‰€æœ‰çš„æ§åˆ¶å‚æ•°ã€æ”¶é›†ç®—æ³•ã€STWã€å¯¹è±¡åˆ†é…è§„åˆ™ã€å›æ”¶ç­–ç•¥ç­‰éƒ½å’ŒSerialæ”¶é›†å™¨å®Œå…¨ä¸€è‡´ã€‚è™½ç„¶ParNewåœ¨ä¸å°‘è¿è¡Œåœ¨æœåŠ¡ç«¯HotSpotåœ¨æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†å™¨çš„é¦–é€‰ã€‚å…¶ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„é‡è¦çš„åŸå› å°±æ˜¯ï¼Œ<strong>ParNew æ˜¯å”¯ä¸€ä¸€ä¸ªé™¤äº†Serial ä¹‹å¤–èƒ½å’ŒCMSæ­é…å·¥ä½œçš„åƒåœ¾æ”¶é›†å™¨</strong>ã€‚ä½¿ç”¨ä¸‹é¢çš„JVMå‚æ•°å³å¯å¯ç”¨CMSï¼š</p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">+XX:+UseConcMarkSweepGC <span class="hljs-meta">#åŒæ—¶æ–°ç”Ÿä»£ä½¿ç”¨ParNewåƒåœ¾æ”¶é›†å™¨ã€‚</span><br></code></pre></td></tr></table></figure><p>CMSçš„è®¾è®¡ç›®æ ‡<strong>æ˜¯ä¸ºäº†é¿å…åœ¨è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶å‡ºç°é•¿æ—¶é—´å¡é¡¿</strong>ã€‚</p><blockquote><p>ä¹‹å‰æˆ‘è€ƒè™‘è¿‡ä¸€ä¸ªé—®é¢˜ï¼ŒCMS å‡å°‘çš„æ˜¯è€å¹´ä»£çš„å¡é¡¿ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‡å°‘æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†çš„å¡é¡¿ã€‚è€å¹´ä»£çš„GCæ¬¡æ•°è¿œè¿œå°‘äºæ–°ç”Ÿä»£ï¼Œä¸ºäº†å‡å°‘è€å¹´ä»£è®¾è®¡çš„CMSæ˜¯å¦æœ‰æ„ä¹‰ï¼Ÿ</p><p>å½“ç„¶æ˜¯æœ‰æ„ä¹‰çš„ã€‚å› ä¸ºæ–°ç”Ÿä»£ä½¿ç”¨çš„æ ‡è®°å¤åˆ¶ç®—æ³•å¹¶ä¸”å­˜æ´»å¯¹è±¡å°‘ï¼Œåœ¨æ ‡è®°å’Œå¤åˆ¶é˜¶æ®µçš„è€—æ—¶éƒ½éå¸¸çš„çŸ­ï¼Œè¿™ä¸ªæ—¶é—´åŸºæœ¬ä¸Šå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä½†æ˜¯åœ¨ä¹‹å‰çš„ç®—æ³•ä¸­ï¼Œè€å¹´ä»£ä½¿ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤æ•´ç†ç®—æ³•ï¼Œå¹¶ä¸”å­˜æ´»å¯¹è±¡å¾ˆå¤šã€‚è¿™æ ·ä¼šæœ‰å¤§é‡çš„æ—¶é—´æµªè´¹åœ¨æ•´ç†ä¸Šã€‚æ‰€ä»¥è¿™ä¸ªé˜¶æ®µçš„STWæ—¶é—´æ˜¯å¾ˆé•¿çš„ã€‚</p></blockquote><p>é¿å…è€å¹´ä»£æ”¶é›†å™¨é•¿æ—¶é—´çš„å¡é¡¿ï¼Œé€šè¿‡ä¸¤ç§æ‰‹æ®µæ¥è¾¾æˆæ­¤ç›®æ ‡ã€‚</p><ul><li><strong>ä¸å¯¹è€å¹´ä»£è¿›è¡Œæ•´ç†ï¼Œè€Œæ˜¯ä½¿ç”¨ç©ºé—²åˆ—è¡¨ï¼ˆfree-listï¼‰æ¥ç®¡ç†å†…å­˜ç©ºé—´çš„å›æ”¶ã€‚</strong></li><li><strong>åœ¨æ ‡è®°æ¸…ç†é˜¶æ®µçš„å¤§éƒ¨åˆ†å·¥ä½œå’Œå¹¶å‘çº¿ç¨‹ä¸€èµ·å®Œæˆã€‚</strong></li></ul><p>åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µå¹¶æ²¡æœ‰æ˜æ˜¾çš„åº”ç”¨çº¿ç¨‹æš‚åœï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„çš„æ˜¯å®ƒä»ç„¶å’Œåº”ç”¨çº¿ç¨‹äº‰æŠ¢ CPU æ—¶é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<strong>CMSä½¿ç”¨çš„æ˜¯å¹¶å‘çº¿ç¨‹æ•°ç­‰äº (CPU æ ¸å¿ƒæ•° + 3)/4ã€‚</strong></p><blockquote><p>è¿™ä¸¤ä¸ªæ‰‹æ®µå¾ˆå¥½ç†è§£ã€‚ä¸å¯¹è€å¹´ä»£è¿›è¡Œæ•´ç†ï¼Œä¹Ÿå°±é¿å…äº†è€å¹´ä»£æ•´ç†å¸¦æ¥çš„é•¿æ—¶é—´STWã€‚å¯¹äºä¹‹å‰åƒåœ¾æ”¶é›†å™¨ä¸ç®¡æ˜¯ Serial è¿˜æ˜¯ Parallelï¼Œåœ¨æ ‡è®°é˜¶æ®µæˆ–è€…æ¸…ç†æ•´ç†é˜¶æ®µéƒ½ä¼šè¿›è¡ŒSTWï¼ŒCMS é‡‡ç”¨çš„æ‰‹æ®µæ˜¯é€šè¿‡ä¸€èµ·å¹¶å‘æ‰§è¡Œæ¥æ¶ˆé™¤è¿™ä¸ªé˜¶æ®µçš„ STWã€‚åœ¨è§£å†³é—®é¢˜çš„æ€è·¯ä¸Šå¯ä»¥è¯´æ˜¯å¾ˆåˆ‡ä¸­è¦ç‚¹äº†ã€‚</p></blockquote><p>å¦‚æœæœåŠ¡å™¨æ˜¯å¤šæ ¸CPUï¼Œå¹¶ä¸”ä¸»è¦è°ƒä¼˜ç›®æ ‡æ˜¯é™ä½ GC åœé¡¿å¯¼è‡´çš„ç³»ç»Ÿå»¶è¿Ÿï¼Œé‚£ä¹ˆä½¿ç”¨ CMSæ˜¯ä¸€ä¸ªå¾ˆæ˜çŸ¥çš„é€‰æ‹©ã€‚é€šè¿‡å‡å°‘æ¯ä¸€æ¬¡GCåœé¡¿çš„æ—¶é—´ï¼Œèƒ½å¾ˆå¤§ç¨‹åº¦ä¸Šæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚ä½†æ˜¯<strong>å¦‚æœCPUèµ„æºä¸æ˜¯å¾ˆå……è¶³æˆ–æ˜¯å—é™åˆ¶çš„æƒ…å†µä¸‹ï¼ŒCMSçš„ååé‡ä¼šå‡ºç°æ¯”è¾ƒæ˜æ˜¾çš„é—®é¢˜</strong>ã€‚å¯¹äºç»å¤§éƒ¨åˆ†ç³»ç»Ÿï¼ŒCMS å’Œ Parallel çš„ååå’Œå»¶è¿Ÿçš„å·®åˆ«å¹¶ä¸å¤§ã€‚</p><h3 id="CMS-åƒåœ¾æ”¶é›†é˜¶æ®µè¿‡ç¨‹"><a href="#CMS-åƒåœ¾æ”¶é›†é˜¶æ®µè¿‡ç¨‹" class="headerlink" title="CMS åƒåœ¾æ”¶é›†é˜¶æ®µè¿‡ç¨‹"></a>CMS åƒåœ¾æ”¶é›†é˜¶æ®µè¿‡ç¨‹</h3><p>ä¸Šé¢æåˆ°é€šè¿‡ä¸¤ä¸ªä¸»è¦çš„æ‰‹æ®µæ¥è¾¾æˆåƒåœ¾æ”¶é›†æ—¶çš„é•¿æ—¶é—´å¡é¡¿çš„ç›®æ ‡ã€‚ä½†æ˜¯æˆ‘ä»¬å‰é¢æåˆ°å¦‚æœè€å¹´ä»£åªæ ‡è®°æ¸…ç†ä¸æ•´ç†è¿™æ ·ä¼šäº§ç”Ÿå¾ˆå¤šä¸å¯ç”¨çš„ç¢ç‰‡ç©ºé—´ã€‚æˆ‘ä»¬å‰é¢è¿˜æåˆ°å¹¶å‘æ¸…ç†çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…å¼•ç”¨çš„å˜åŒ–ï¼Œå…¶ä»–å·¥ä½œçº¿ç¨‹éƒ½éœ€è¦è¿›å…¥å®‰å…¨ç‚¹ç­‰å¾…ç›´è‡³åƒåœ¾æ”¶é›†ç»“æŸã€‚é‚£ CMS æ˜¯æ€æ ·å·§å¦™åœ°å¤„ç†è¿™äº›çŸ›ç›¾ç‚¹å‘¢ï¼Ÿæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ CMS GC çš„å‡ ä¸ªé˜¶æ®µã€‚</p><h4 id="é˜¶æ®µ1ï¼šåˆå§‹æ ‡è®°é˜¶æ®µï¼ˆinital-markï¼‰ï¼ˆSTWï¼‰"><a href="#é˜¶æ®µ1ï¼šåˆå§‹æ ‡è®°é˜¶æ®µï¼ˆinital-markï¼‰ï¼ˆSTWï¼‰" class="headerlink" title="é˜¶æ®µ1ï¼šåˆå§‹æ ‡è®°é˜¶æ®µï¼ˆinital markï¼‰ï¼ˆSTWï¼‰"></a>é˜¶æ®µ1ï¼šåˆå§‹æ ‡è®°é˜¶æ®µï¼ˆinital markï¼‰ï¼ˆSTWï¼‰</h4><p>è¿™ä¸ªé˜¶æ®µ<strong>ä¼´éšSTWæš‚åœ</strong>ã€‚åˆå§‹æ ‡è®°çš„ç›®æ ‡æ˜¯æ ‡è®°æ‰€æœ‰çš„æ ¹å¯¹è±¡ï¼ŒåŒ…æ‹¬æ ¹å¯¹è±¡ç›´æ¥å¼•ç”¨çš„å¯¹è±¡ï¼Œä»¥åŠè¢«æ–°ç”Ÿä»£ä¸­æ‰€æœ‰å­˜æ´»å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡ï¼ˆè€å¹´ä»£å•ç‹¬å›æ”¶ï¼‰ã€‚</p><blockquote><p>æˆ‘ä»¬å‰é¢æåˆ°å¯¹æ–°ç”Ÿä»£è¿›è¡Œåƒåœ¾æ”¶é›†æ ‡è®°é˜¶æ®µï¼Œä¼šæŠŠè„å¡ä¸­çš„å¯¹è±¡ï¼ˆè€å¹´ä»£æŒ‡å‘æ–°ç”Ÿä»£å¼•ç”¨çš„å¯¹è±¡ï¼‰åŠ å…¥GC Rootsï¼Œè¿™é‡Œä¹Ÿæ˜¯ç±»ä¼¼çš„å¤„ç†æ–¹å‘ï¼Œåªä¸è¿‡æ–¹å‘åè¿‡æ¥äº†ï¼ŒæŠŠæ–°ç”Ÿä»£ä¸­æŒ‡å‘è€å¹´ä»£çš„å¯¹è±¡åŠ å…¥GC Rootsã€‚</p></blockquote><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210605163034.png"></p><h4 id="é˜¶æ®µ2ï¼šå¹¶å‘æ ‡è®°ï¼ˆConcurrent-Markï¼‰"><a href="#é˜¶æ®µ2ï¼šå¹¶å‘æ ‡è®°ï¼ˆConcurrent-Markï¼‰" class="headerlink" title="é˜¶æ®µ2ï¼šå¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰"></a>é˜¶æ®µ2ï¼šå¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰</h4><p>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒCMS GCéå†è€å¹´ä»£ï¼Œæ ‡è®°æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ï¼Œä»å‰ä¸€é˜¶æ®µçš„â€œInitial Markâ€æ‰¾åˆ°çš„æ ¹å¯¹è±¡å¼€å§‹ç®—èµ·ã€‚â€œå¹¶å‘æ ‡è®°é˜¶æ®µï¼Œå°±æ˜¯ä¸åº”ç”¨ç¨‹åºåŒæ—¶è¿è¡Œï¼Œä¸ç”¨æš‚åœçš„é˜¶æ®µï¼ˆè¿™ä¸ªé˜¶æ®µæ²¡æœ‰STWï¼‰ã€‚âš ï¸è¯·æ³¨æ„å¹¶éæ‰€æœ‰çš„è€å¹´ä»£ä¸­å­˜æ´»çš„å¯¹è±¡éƒ½åœ¨æ­¤é˜¶æ®µè¢«æ ‡è®°ï¼Œå› ä¸ºåœ¨<strong>æ ‡è®°è¿‡ç¨‹ä¸­å¯¹è±¡çš„å¼•ç”¨å…³ç³»è¿˜åœ¨å‘ç”Ÿè¿™å˜åŒ–ã€‚</strong></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210605164135.png"></p><p>åœ¨ä¸Šé¢çš„å›¾ä¸­ï¼Œ<code>å½“å‰å¤„ç†å¯¹è±¡</code>çš„ä¸€ä¸ªå¼•ç”¨è¢«åº”ç”¨ç¨‹åºç»™æ–­å¼€äº†ï¼Œå³è¿™ä¸ªå¯¹è±¡çš„åº”ç”¨å…³ç³»å‘ç”Ÿäº†å˜åŒ–ã€‚é‚£æˆ‘ä»¬è¦æ€ä¹ˆå¤„ç†è¿™ç§å˜åŒ–çš„å¼•ç”¨å…³ç³»å‘¢ï¼Ÿå…ˆ<code>æ ‡è®°è„å¡</code>ã€‚</p><h4 id="é˜¶æ®µ3ï¼šå¹¶å‘é¢„å¤„ç†ï¼ˆConcurrent-Precleanï¼‰"><a href="#é˜¶æ®µ3ï¼šå¹¶å‘é¢„å¤„ç†ï¼ˆConcurrent-Precleanï¼‰" class="headerlink" title="é˜¶æ®µ3ï¼šå¹¶å‘é¢„å¤„ç†ï¼ˆConcurrent Precleanï¼‰"></a>é˜¶æ®µ3ï¼šå¹¶å‘é¢„å¤„ç†ï¼ˆConcurrent Precleanï¼‰</h4><p>åœ¨è¿™ä¸ªé˜¶æ®µä¸éœ€è¦STWåœé¡¿ï¼Œå› ä¸ºå‰é¢ä¸€ä¸ªé˜¶æ®µ<code>å¹¶å‘æ ‡è®°</code>ä¸ç¨‹åºä¸€èµ·è¿è¡Œï¼Œå¯èƒ½æœ‰ä¸€äº›å¯¹è±¡çš„å¼•ç”¨å…³ç³»å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚å¦‚æœåœ¨å¹¶å‘æ ‡è®°ä¸­å¼•ç”¨å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆJVM å°†é€šè¿‡ Card çš„æ–¹å¼å°†å‘ç”Ÿæ”¹å˜çš„åŒºåŸŸæ ‡è®°ä¸ºâ€œè„â€å¡ï¼Œè¿™æ˜¯è€å¹´ä»£æ¸…ç†è¿‡ç¨‹ä¸­çš„<code>å¡ç‰‡æ ‡è®°</code>ï¼Œå¹¶å‘æ ‡è®°åœ¨å‰é¢ä¸€å°èŠ‚æœ‰è¯¦ç»†çš„ä»‹ç»ã€‚ <strong>è¿™ä¸ªé˜¶æ®µè¿˜ä¼šå¤„ç†åœ¨æ‰§è¡Œå¹¶å‘æ ‡è®°é˜¶æ®µæ–°è¿›å…¥è€å¹´ä»£çš„å¯¹è±¡ï¼ˆæ–°æ™‹å‡çš„å¯¹è±¡ï¼‰ã€‚</strong></p><blockquote><p>è¿™é‡Œçš„è„å¡å’Œæˆ‘ä»¬å‰é¢åœ¨ä¸€èˆ¬åŸç†å’Œåƒåœ¾æ”¶é›†ä¸­è®²åˆ°çš„è„å¡æœ‰ä¸€äº›ä¸ä¸€æ ·ï¼Œå‰é¢<code>å¹´è½»ä»£æ ‡è®°é˜¶æ®µ</code>æåˆ°çš„è„å¡ï¼Œæ˜¯ä¸ºäº†é¿å…æ¯æ¬¡æ–°ç”Ÿä»£æ ‡è®°çš„æ—¶å€™é¿å…æ‰«ææ•´ä¸ªè€å¹´ä»£ï¼Œè€Œæ˜¯é€šè¿‡æ¯æ¬¡å¤åˆ¶ä¹‹åä¿®æ”¹åœ°å€æ—¶ï¼Œé¡ºå¸¦æ ‡è®°å‡ºè€å¹´ä»£å¯¹æ–°ç”Ÿä»£æœ‰å¼•ç”¨çš„å¯¹è±¡æ‰€åœ¨çš„â€œå¡â€ä¸ºè„å¡ã€‚ä¸‹æ¬¡æ–°ç”Ÿä»£GCæ—¶ï¼Œå°†è„å¡ä¸­çš„å¯¹è±¡åŠ å…¥ GC Rootså³å¯ã€‚</p><p>è¿™é‡Œçš„<code>CMSä¸­çš„è„å¡</code>æ˜¯æŒ‡åœ¨CMS å¹¶å‘æ ‡è®°çš„è¿‡ç¨‹ä¸­å¼•ç”¨å‘ç”Ÿå˜åŒ–å¡ï¼Œåœ¨åç»­åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­è¿›è¡Œç‰¹åˆ«å¤„ç†ã€‚</p><p><code>å…±åŒç‚¹</code>éƒ½æ˜¯éƒ½æ˜¯JVMè€å¹´ä»£çš„å¡ç‰‡æ ‡è®°æŠ€æœ¯ï¼Œæ ‡è®°æŸä¸ªå†…å­˜å—ï¼Œä¸ºåç»­åƒåœ¾æ”¶é›†æ“ä½œæä¾›æ ‡è¯†ã€‚</p></blockquote><p>â€‹        <img src="https://gitee.com/realDaiwei/img/raw/master/20210605173345.png">                                       </p><p>åœ¨é¢„æ¸…ç†é˜¶æ®µï¼Œè¿™äº›<strong>è„å¯¹è±¡ä¼šè¢«ç»Ÿè®¡å‡ºæ¥ï¼Œä»–ä»¬æ‰€å¼•ç”¨çš„å¯¹è±¡ä¹Ÿä¼šè¢«æ ‡è®°</strong>ï¼Œæ­¤é˜¶æ®µå®Œæˆåï¼Œç”¨ä»¥æ ‡è®°çš„ card ä¹Ÿä¼šè¢«æ¸…ç©ºã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210605231002.png"></p><p>è¿™ä¸ªé˜¶æ®µè¿˜ä¼šè¿›è¡Œä¸€äº›å¿…è¦çš„ç»†èŠ‚å¤„ç†ï¼Œè¿˜ä¼šä¸º<code>Final Remark</code>åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚</p><h4 id="é˜¶æ®µ4ï¼šå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼ˆConcurrent-Abortable-Precleanï¼‰"><a href="#é˜¶æ®µ4ï¼šå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼ˆConcurrent-Abortable-Precleanï¼‰" class="headerlink" title="é˜¶æ®µ4ï¼šå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼ˆConcurrent Abortable Precleanï¼‰"></a>é˜¶æ®µ4ï¼šå¯å–æ¶ˆçš„å¹¶å‘é¢„æ¸…ç†ï¼ˆConcurrent Abortable Precleanï¼‰</h4><p>è¿™ä¸ªé˜¶æ®µä¹Ÿä¸ä¼šSTWï¼Œè¿™ä¸ªé˜¶æ®µåœ¨ STWçš„Final Remark ä¹‹å‰å°½å¯èƒ½åœ°å¤šåšä¸€äº›å·¥ä½œã€‚è¿™ä¸ªé˜¶æ®µå¯æ˜¾è‘—å½±å“STWåœé¡¿æŒç»­æ—¶é—´ã€‚</p><h4 id="é˜¶æ®µ5ï¼šæœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal-Remarkï¼‰ï¼ˆSTWï¼‰"><a href="#é˜¶æ®µ5ï¼šæœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal-Remarkï¼‰ï¼ˆSTWï¼‰" class="headerlink" title="é˜¶æ®µ5ï¼šæœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal Remarkï¼‰ï¼ˆSTWï¼‰"></a>é˜¶æ®µ5ï¼šæœ€ç»ˆæ ‡è®°é˜¶æ®µï¼ˆFinal Remarkï¼‰ï¼ˆ<strong>STW</strong>ï¼‰</h4><p>æœ€ç»ˆæ ‡è®°é˜¶æ®µæ˜¯æœ¬æ¬¡GCæ—¶é—´ä¸­çš„ç¬¬äºŒæ¬¡ï¼ˆä¹Ÿæ˜¯æœ€åä¸€æ¬¡ï¼‰<strong>STWåœé¡¿</strong>ã€‚æœ¬é˜¶æ®µçš„ç›®æ ‡æ˜¯å®Œæˆè€å¹´ä»£ä¸­æ‰€æœ‰å­˜æ´»å¯¹è±¡çš„æ ‡è®°ã€‚å› ä¸ºä¹‹å‰çš„é¢„æ¸…ç†é˜¶æ®µæ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼Œæœ‰å¯èƒ½GCçº¿ç¨‹è·Ÿä¸ä¸Šåº”ç”¨ç¨‹åºçš„ä¿®æ”¹é€Ÿåº¦ã€‚æ‰€ä»¥éœ€è¦ä¸€æ¬¡STWæš‚åœæ¥è¯´å¤„ç†å„ç§å¤æ‚çš„æƒ…å†µã€‚é€šå¸¸ CMS ä¼šå°è¯•åœ¨å¹´è½»ä»£å°½å¯èƒ½ç©ºçš„æƒ…å†µä¸‹æ‰§è¡Œ Final Remarkï¼Œä»¥å…è¿ç»­è§¦å‘å¤šæ¬¡ STWäº‹ä»¶ã€‚åœ¨ä»¥ä¸Š5ä¸ªé˜¶æ®µå®Œæˆä¹‹åï¼Œè€å¹´ä»£ä¸­çš„æ‰€æœ‰å­˜æ´»å¯¹è±¡éƒ½è¢«æ ‡è®°äº†ï¼Œç„¶åGCå°†æ¸…é™¤æ‰€æœ‰ä¸ä½¿ç”¨çš„å¯¹è±¡æ¥å›æ”¶è€å¹´ä»£ç©ºé—´ã€‚ </p><h4 id="é˜¶æ®µ6ï¼šå¹¶å‘æ¸…é™¤ï¼ˆConcurrent-Sweepï¼‰"><a href="#é˜¶æ®µ6ï¼šå¹¶å‘æ¸…é™¤ï¼ˆConcurrent-Sweepï¼‰" class="headerlink" title="é˜¶æ®µ6ï¼šå¹¶å‘æ¸…é™¤ï¼ˆConcurrent Sweepï¼‰"></a>é˜¶æ®µ6ï¼šå¹¶å‘æ¸…é™¤ï¼ˆConcurrent Sweepï¼‰</h4><p>è¿™ä¸ªé˜¶æ®µä¸éœ€è¦ STWåœé¡¿ï¼ŒJVMåœ¨æ­¤é˜¶æ®µæ¸…ç†ä¸å†ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¹¶å›æ”¶ä»–ä»¬å ç”¨çš„å†…å­˜ç©ºé—´ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210605235328.png"></p><h4 id="é˜¶æ®µ7ï¼šå¹¶å‘é‡ç½®ï¼ˆConcurrent-Resetï¼‰"><a href="#é˜¶æ®µ7ï¼šå¹¶å‘é‡ç½®ï¼ˆConcurrent-Resetï¼‰" class="headerlink" title="é˜¶æ®µ7ï¼šå¹¶å‘é‡ç½®ï¼ˆConcurrent Resetï¼‰"></a>é˜¶æ®µ7ï¼šå¹¶å‘é‡ç½®ï¼ˆConcurrent Resetï¼‰</h4><p>è¿™ä¸ªé˜¶æ®µä¸åº”ç”¨ç¨‹åºå¹¶å‘æ‰§è¡Œï¼Œé‡ç½® CMS ç®—æ³•ç›¸å…³å†…ç½®æ•°æ®ï¼Œå¹¶ä¸ºä¸‹æ¬¡GCå¾ªç¯åšå¥½å‡†å¤‡ã€‚</p><h3 id="æ±‡æ€»å››é˜¶æ®µ"><a href="#æ±‡æ€»å››é˜¶æ®µ" class="headerlink" title="æ±‡æ€»å››é˜¶æ®µ"></a>æ±‡æ€»å››é˜¶æ®µ</h3><p>æœ‰çš„ä¹¦ä¸Šæˆ‘çœ‹ä»‹ç» CMS çš„åƒåœ¾å›æ”¶æ­¥éª¤åªæœ‰5æ­¥ç”šè‡³æ˜¯4æ­¥ï¼Œä¹¦ä¸­æ¢³ç†å‡ºæ¥çš„4æ­¥åˆ†åˆ«ä¸ºï¼š</p><ul><li>åˆå§‹æ ‡è®°ï¼šä»…ä»…æ ‡è¯† GC Root èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ã€‚ï¼ˆSTWï¼‰</li><li>å¹¶å‘æ ‡è®°ï¼šç”±åˆå§‹æ ‡è®°çš„å…³è”å¯¹è±¡éå†æ ‡è®°æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ã€‚</li><li>é‡æ–°æ ‡è®°ï¼šä¿®æ­£å› ä¸ºåº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œå¯¼è‡´çš„éƒ¨åˆ†æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„å¯¹è±¡çš„æ ‡è®°ã€‚ï¼ˆSTWï¼‰</li><li>å¹¶å‘æ¸…ç†ï¼šæ¸…ç†åˆ é™¤æ ‡è®°é˜¶æ®µåˆ¤æ–­å·²ç»â€œæ­»äº¡â€çš„å¯¹è±¡ã€‚</li><li>ï¼ˆå¹¶å‘é‡ç½®ï¼šé‡ç½®å†…éƒ¨è®¾ç½®ï¼‰ã€‚</li></ul><p>å…¶å®è¿™ä¸Šé¢çš„4ï¼ˆ5ï¼‰ä¸ªé˜¶æ®µå’Œæˆ‘ä»¬å‰é¢æ¢³ç†çš„ä¸ƒä¸ªæ­¥éª¤æ˜¯å·®ä¸å¤šçš„ï¼Œåªæ˜¯7ä¸ªé˜¶æ®µå¤šäº†2ä¸ªå¹¶å‘é¢„å¤„ç†çš„è¿‡ç¨‹ï¼Œè¿™ä¸¤ä¸ªæµç¨‹éƒ½æ²¡æœ‰è¿›è¡Œæœ¬è´¨ä¸Šçš„æ ‡è®°æˆ–è€…æ¸…ç†ï¼Œè¦ä¹ˆæ˜¯å¤„ç†è„å¡ï¼Œè¦ä¹ˆæ˜¯ä¸ºæœ€ç»ˆæ ‡è®°åšé“ºå«ã€‚è¿˜æœ‰æœ€åä¸€ä¸ªä¹¦ä¸­æ˜¯æ²¡æœ‰çš„æåˆ°çš„å¹¶å‘é‡ç½®é˜¶æ®µï¼Œè¿™3ä¸ªé˜¶æ®µéƒ½æ²¡æœ‰åšæœ¬è´¨ä¸Šçš„æ ‡è®°æˆ–æ¸…ç†ã€‚æ‰€ä»¥ä»7ä¸ªé˜¶æ®µç¼©å‡åˆ°4ä¸ªä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ã€‚CMS æ•´ä¸ªè¿‡ç¨‹ä¸­ä¹Ÿæ˜¯éœ€è¦STWçš„åªä¸è¿‡STWçš„æ—¶é—´å¾ˆçŸ­ã€‚å¤§å¤šæ•°æ—¶é—´éƒ½æ˜¯éƒ½åœ¨å¹¶å‘çš„è¿›è¡Œåƒåœ¾å›æ”¶ã€‚</p><h3 id="CMS-çš„ç¼ºç‚¹"><a href="#CMS-çš„ç¼ºç‚¹" class="headerlink" title="CMS çš„ç¼ºç‚¹"></a>CMS çš„ç¼ºç‚¹</h3><p>CMSæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„åƒåœ¾æ”¶é›†å™¨ï¼Œä½†æ˜¯çš„ä¼˜ç‚¹ä¹Ÿå¾ˆæ˜æ˜¾å¹¶å‘æ”¶é›†ã€ä½åœé¡¿ã€‚åœ¨ä¸€äº›å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿç§°ä¹‹ä¸ºâ€œå¹¶å‘ä½åœé¡¿æ”¶é›†å™¨â€ï¼ŒCMSæ˜¯HotSpotè™šæ‹Ÿæœºè¿½æ±‚ä½åœé¡¿çš„ä¸€æ¬¡æˆåŠŸå°è¯•ï¼Œä½†æ˜¯å®ƒè¿˜è¿œè¿œè¾¾ä¸åˆ°æˆåŠŸçš„ç¨‹åº¦ï¼Œè‡³å°‘å®ƒæœ‰ä¸‹é¢ä¸‰ä¸ªç¼ºç‚¹ï¼š</p><ol><li>å¯¹å¤„ç†å™¨èµ„æºéå¸¸æ•æ„Ÿã€‚é¢å‘å¹¶å‘è®¾è®¡çš„ç¨‹åºå¯¹å¤„ç†å™¨éƒ½å¾ˆæ•æ„Ÿã€‚</li><li>æ— æ³•å¤„ç†<code>â€œæµ®åŠ¨åƒåœ¾â€ï¼ˆfloating garbageï¼‰</code>ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°â€œConcurrent Mode failedâ€å¹¶å‘å¤±è´¥è¿›è€Œå¯¼è‡´ä¸€æ¬¡å®Œæ•´STWçš„Serail FullGCã€‚</li></ol><blockquote><p>æµ®åŠ¨åƒåœ¾æŒ‡çš„æ˜¯åœ¨ CMS å¹¶å‘æ ‡è®°å’Œæ¸…ç†æœŸé—´ï¼Œç”±äºåº”ç”¨ç¨‹åºå¹¶æ²¡æœ‰åœæ­¢è¿è¡Œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šæœ‰åƒåœ¾ä¸æ–­çš„äº§ç”Ÿï¼Œä½†è¿™ä¸€éƒ¨åˆ†åƒåœ¾æ˜¯å‡ºç°åœ¨æ ‡è®°è¿‡ç¨‹ä¸­ä¹‹åçš„ï¼Œå› æ­¤ CMS åœ¨å½“è½®åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­æ²¡æ³•å¤„ç†å®ƒä»¬ï¼Œæ‰€ä»¥è¿™äº›åƒåœ¾åªæœ‰åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†æ—¶æ‰èƒ½å¤„ç†ã€‚è¿™ä¸€éƒ¨åˆ†åƒåœ¾å°±æˆä¸ºâ€œæµ®åŠ¨åƒåœ¾â€ï¼ˆfloating garbageï¼‰å› æ­¤ CMS ä¸èƒ½ç­‰åˆ°è€å¹´ä»£è¢«å¡«æ»¡äº†æ‰è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œå¿…é¡»ä¸ºå¯èƒ½äº§ç”Ÿçš„æµ®åŠ¨åƒåœ¾é¢„ç•™ä¸€äº›ç©ºé—´ã€‚å¦‚æœæµ®åŠ¨åƒåœ¾å †æ»¡äº†é¢„ç•™çš„ç©ºé—´é‚£å°±ä¼šå‡ºç°å¹¶å‘å¤±è´¥çš„é—®é¢˜äº†ã€‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‚æ•°è®¾ç½®å½“å·²ç»ä½¿ç”¨çš„ç©ºé—´è¾¾åˆ°å¤šå°‘æ—¶è§¦å‘ CMSã€‚ä½ å¯ä»¥æ€è€ƒè¿™ä¸ªå‚æ•°è®¾ç½®ä¸å½“ä¼šé€ æˆä»€ä¹ˆåæœğŸ˜ã€‚</p></blockquote><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-symbol">XX:</span>CMSInitiatingOccupancyFraction=<span class="hljs-number">70</span> <span class="hljs-comment">#æ€»ä½¿ç”¨ç©ºé—´è¾¾åˆ°70%è§¦å‘CMS</span></span><br></code></pre></td></tr></table></figure><ol><li>å†…å­˜ç¢ç‰‡ï¼Œå› ä¸ºCMSé‡‡ç”¨çš„æ˜¯æ ‡è®°æ¸…é™¤ç®—æ³•ã€‚å†…å­˜ç¢ç‰‡ä¸å¯é¿å…ã€‚å†…å­˜ç¢ç‰‡è¿‡å¤šæ˜¯å°†ç»™å¤§å¯¹è±¡çš„åˆ†é…å¸¦æ¥éº»çƒ¦ã€‚æ—¶å¸¸ä¼šä¼šä¸ºäº†ç»™å¤§å¯¹è±¡åˆ†é…ç©ºé—´ä½†ç”±äºå†…å­˜ç¢ç‰‡è€Œä¸å¾—ä¸è¿›è¡Œä¸€æ¬¡ FullGCã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ CMS æä¾›äº†ä¸¤ä¸ªJVM å‚æ•°ï¼Œä½†æ˜¯åœ¨ JDK9å¼€å§‹åºŸå¼ƒã€‚</li></ol><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby"><span class="hljs-symbol">XX:</span>UseCMSCompactAtFullCollection <span class="hljs-comment">#é»˜è®¤å¼€å¯ï¼Œåœ¨CMSä¸å¾—ä¸FullGCçš„æ—¶å€™å¼€å¯å†…å­˜åˆå¹¶æ•´ç†ã€‚</span></span><br><span class="ruby">-<span class="hljs-symbol">XX:</span>CMSFullGCsBeforeCompaction=n <span class="hljs-comment">#næ¬¡FullGCä¹‹åï¼Œä¸‹æ¬¡FullGCå‰è¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ï¼Œé»˜è®¤å€¼0ï¼Œæ¯æ¬¡è¿›å…¥FullGCéƒ½ä¼šè¿›è¡Œå†…å­˜ç¢ç‰‡æ•´ç†ã€‚</span></span><br></code></pre></td></tr></table></figure><h2 id="Garbage-Firstï¼ˆG1ï¼‰"><a href="#Garbage-Firstï¼ˆG1ï¼‰" class="headerlink" title="Garbage Firstï¼ˆG1ï¼‰"></a>Garbage Firstï¼ˆG1ï¼‰</h2><p>Garbage First ç®€ç§°ï¼ˆG1ï¼‰æ”¶é›†å™¨æ˜¯åƒåœ¾æ”¶é›†æŠ€æœ¯å‘å±•å†å²ä¸Šçš„é‡Œç¨‹ç¢‘çš„æˆæœï¼Œå®ƒå¼€åˆ›äº†æ”¶é›†å™¨é¢å‘å±€éƒ¨æ”¶é›†çš„æ€è·¯å’Œ<strong>åŸºäºRegionçš„å†…å­˜å¸ƒå±€å½¢å¼</strong>ã€‚G1æ˜¯ä¸€æ¬¾é¢å‘æœåŠ¡ç«¯çš„åƒåœ¾æ”¶é›†å™¨ï¼ŒHotSpot å¼€å‘å›¢é˜Ÿæœ€åˆèµ‹äºˆå®ƒçš„æœŸæœ›æ˜¯ä»£æ›¿ CMS åƒåœ¾æ”¶é›†å™¨ã€‚<strong>åœ¨JDK9ä¸­G1å·²ç»ä»£æ›¿ Parallel æ”¶é›†å™¨æˆä¸ºJDKçš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨</strong>ã€‚G1æ—¢ç„¶ä½œä¸ºCMSçš„æŒ‘æˆ˜è€…ï¼ŒG1å¯¹åƒåœ¾æ”¶é›†åšå‡ºäº†å“ªäº›é©å‘½æ€§çš„å˜é©ï¼ŒG1åˆæ˜¯å¦èƒ½å¾ˆå¥½çš„è§£å†³CMSä¸­å­˜åœ¨çš„é—®é¢˜å‘¢ï¼Ÿ</p><h3 id="åæ¥è€…çš„ç‹¬é—¨ç§˜ç±"><a href="#åæ¥è€…çš„ç‹¬é—¨ç§˜ç±" class="headerlink" title="åæ¥è€…çš„ç‹¬é—¨ç§˜ç±"></a>åæ¥è€…çš„ç‹¬é—¨ç§˜ç±</h3><p>åœ¨å‰é¢æ¢³ç†CMSçš„ç¼ºç‚¹ä¸­ï¼Œæˆ‘ä»¬å‘ç°æ— æ³•å¤„ç†<code>æµ®åŠ¨åƒåœ¾</code>å’Œ<code>å†…å­˜ç¢ç‰‡</code>æ˜¯CMSçš„ç¡¬ä¼¤ã€‚è¿™äº›é—®é¢˜G1ä¹Ÿè¦é¢å¯¹ï¼Œä½†æ˜¯G1é‡‡ç”¨äº†ä¸€ç§éå¸¸å·§å¦™çš„æ–¹å¼å»è§£å†³ã€‚æµ®åŠ¨åƒåœ¾ï¼Œè¿™æ˜¯ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘è¿è¡Œçš„åƒåœ¾æ”¶é›†å™¨çš„é€šç—…ï¼Œè¿™ä¸ªé—®é¢˜çš„æ ¹æœ¬çŸ›ç›¾æ˜¯<strong>åƒåœ¾æ”¶é›†çº¿ç¨‹åœ¨ä¸æ–­è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œä¸æ­¤åŒæ—¶åº”ç”¨çº¿ç¨‹åˆåœ¨ä¸æ–­äº§ç”Ÿåƒåœ¾ï¼Œæ˜¯åƒåœ¾ç”Ÿäº§ä¸åƒåœ¾å›æ”¶ä¹‹é—´çš„ä¸å¹³è¡¡ã€‚</strong>è¿™æ˜¯ä¸€ä¸ªä¸å¯è°ƒå’Œçš„çŸ›ç›¾ã€‚å¦‚æœæˆ‘ä»¬ç”¨å‘å±•çš„çœ¼å…‰çœ‹é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¦‚æœæµ®åŠ¨<code>åƒåœ¾çš„äº§ç”Ÿé€Ÿåº¦&gt;åƒåœ¾æ”¶é›†çš„é€Ÿåº¦</code>ï¼Œé‚£ä¹ˆå†å¤§çš„ç©ºé—´éƒ½ä¼šè¢«è¿«è§¦å‘ä¸€æ¬¡FullGCï¼Œå¦‚æœ<code>åƒåœ¾äº§ç”Ÿçš„é€Ÿåº¦&lt;åƒåœ¾æ”¶é›†é€Ÿåº¦</code>ï¼Œäº§ç”Ÿæµ®åŠ¨åƒåœ¾å¯¹æ•´ä¸ªåƒåœ¾æ”¶é›†ä¹Ÿä¸ä¼šäº§ç”Ÿå¤ªå¤§çš„å½±å“ã€‚</p><blockquote><p>è¿™å°±åƒä½ å¦ˆåœ¨æ‰“æ‰«æˆ¿é—´è€Œä½ åˆåœ¨ä¸€æ—åˆ¶é€ åƒåœ¾ï¼Œè¿™ä¸ªæ—¶å€™ä½ å¦ˆé™¤äº†æŠŠä½ èƒ–æä¸€é¡¿æ‹¿ä½ æ¯«æ— åŠæ³•ã€‚è°è®©è¿™åƒåœ¾æ”¶é›†çº¿ç¨‹ä¸åº”ç”¨çº¿ç¨‹ä¹‹é—´æ˜¯è¦å¹¶å‘çš„å…³ç³»å‘¢ã€‚è§£å†³çš„åŠæ³•ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ä½ å¦ˆæ‰“æ‰«å«ç”Ÿçš„é€Ÿåº¦å¤§äºä½ ç”Ÿäº§åƒåœ¾çš„é€Ÿåº¦ï¼Œä½ å¦ˆå°±èƒ½æŠŠåƒåœ¾æ‰“æ‰«å®Œå¹¶æŠŠä½ èƒ–æä¸€é¡¿ã€‚å› æ­¤åªè¦<code>å†…å­˜åˆ†é…é€Ÿç‡ &lt; åƒåœ¾æ”¶é›†é€Ÿç‡</code>é‚£ä¹ˆä¸€åˆ‡éƒ½å¾ˆå®Œç¾ï¼Œæµ®åŠ¨åƒåœ¾éšä»–å»å§ï¼Œã€‚</p></blockquote><p>é‚£ä¹ˆ<code>å†…å­˜ç¢ç‰‡çš„é—®é¢˜</code>ï¼ŒG1æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ<code>â€œåŒ–æ•´ä¸ºé›¶â€</code>ï¼Œè¿™ä¸ªæ€è·¯å¾ˆç‰¹åˆ«ï¼Œè·³å‡ºåŸæœ‰çš„æ€ç»´æŸç¼šã€‚G1çš„å†…å­˜ç»“æ„å’Œä¼ ç»Ÿçš„å†…å­˜ç»“æ„éå¸¸çš„ä¸åŒï¼Œæ¯ä¸ªå†…å­˜å—è¿˜æ˜¯æœ‰EdenåŒºï¼ŒSurvivoråŒºå’ŒOldçš„åŒºçš„åˆ’åˆ†ã€‚ä½†ä¸å†åˆ†æˆå¹´è½»ä»£å’Œè€å¹´ä»£ï¼Œè€Œæ˜¯åˆ’åˆ†ä¸ºå¤šä¸ªï¼ˆé€šå¸¸æ˜¯2048ä¸ªï¼‰å¯ä»¥å­˜æ”¾å¯¹è±¡çš„<code>å°å—å†…å­˜åŒºåŸŸï¼ˆsmaller heap regionsï¼‰</code>ã€‚æ¯ä¸€ä¸ªå°å—ï¼Œå¯èƒ½ä¸€ä¼šè¢«å®šä½ä¸ºEdenã€Survivoræˆ–OldåŒºï¼Œæ‰€æœ‰çš„EdenåŒºæ‹¼åœ¨ä¸€èµ·å°±æ˜¯å¹´è½»ä»£ï¼Œæ‰€æœ‰çš„OldåŒºæ‹¼åœ¨ä¸€èµ·å°±æ˜¯è€å¹´ä»£ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210606162329.png"></p><p>é™¤äº†è¿™äº›é—®é¢˜ä¸Šï¼Œåˆ›æ–°æ€§çš„è§£å†³æ€è·¯ï¼ŒG1è¿˜æœ‰ä¸€ä¸ªå°ç›®æ ‡ï¼Œ<strong>å¸Œæœ›èƒ½åšå‡ºä¸€æ¬¾èƒ½å¤Ÿå»ºç«‹èµ·â€œåœé¡¿æ—¶é—´æ¨¡å‹â€ï¼ˆPause Prediction Modelï¼‰çš„æ”¶é›†å™¨</strong>ï¼Œåœé¡¿æ—¶é—´æ¨¡å‹çš„æ„æ€æ˜¯èƒ½å¤Ÿ<strong>æ”¯æŒæŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†å™¨ä¸Šçš„æ—¶é—´å¤§æ¦‚ä¸ä¼šè¶…è¿‡Næ¯«ç§’çš„è¿™æ ·çš„ç›®æ ‡ã€‚</strong></p><p>æœ‰äº†ä¸Šé¢çš„æ€è·¯çš„è½¬å˜å¯¹äºG1çš„è®¤çŸ¥æ˜¯å¦æœ‰è½¬å˜å‘¢ï¼Ÿé¢å¯¹æµ®åŠ¨åƒåœ¾çš„é—®é¢˜ï¼ŒG1æ²¡æœ‰ç›´é¢çš„å»è§£å†³è€Œæ˜¯é€šè¿‡æé«˜åƒåœ¾å›æ”¶é€Ÿç‡çš„æ–¹å¼å³<code>åƒåœ¾å›æ”¶é€Ÿç‡&gt;å†…å­˜åˆ†é…é€Ÿç‡</code> çš„æ–¹å¼æ¥å¤„ç†ã€‚é¢å¯¹å‰é¢CMSé‡åˆ°çš„å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œ<strong>G1å°†æ•´ä¸ªå†…å­˜â€œæ‰“ç¢æˆå—â€ç„¶åé€šè¿‡æ•´ä½“å¤åˆ¶çš„æ–¹å¼ç›´æ¥é¿å…äº†å†…å­˜ç¢ç‰‡çš„äº§ç”Ÿ</strong>ã€‚è¿™ä¸ªè§£å†³çš„æ–¹å¼æ˜¯ä¸æ˜¯å¾ˆå·§å¦™ã€‚é€šè¿‡ä¸Šè¿°çš„è§£å†³æ–¹æ¡ˆï¼Œå†æ¥çœ‹G1çš„å°ç›®æ ‡ã€‚å¸Œæœ›èƒ½åšå‡ºä¸€æ¬¾èƒ½å¤Ÿå»ºç«‹èµ·â€œåœé¡¿æ—¶é—´æ¨¡å‹â€ï¼ˆPause Prediction Modelï¼‰çš„æ”¶é›†å™¨ï¼Œæ˜¯ä¸æ˜¯å°±æœ‰äº†æ€è·¯å‘¢ï¼Ÿ</p><p><strong>åªè¦æ¯æ¬¡åƒåœ¾æ”¶é›†çš„å‘¨æœŸåªè¦æ”¶é›†çš„åƒåœ¾çš„é€Ÿç‡&gt;å†…å­˜åˆ†é…é€Ÿç‡æ˜¯ä¸æ˜¯å°±å¯ä»¥äº†å‘¢ï¼Ÿæ˜¯çš„ï¼æ¯ä¸ªå†…å­˜å—åˆæ˜¯ç‹¬ç«‹çš„ã€‚è¿™æ ·æ¯æ¬¡GCå‘¨æœŸç›®æ ‡å°±å¾ˆæ˜ç¡®äº†ï¼Œåªè¦æ”¶é›†å…¨éƒ¨çš„æ–°ç”Ÿä»£å’Œéƒ¨åˆ†è€å¹´ä»£çš„å†…å­˜å—ï¼Œå¹¶ä¸”ä¿è¯æ¯æ¬¡GCå‘¨æœŸåƒåœ¾æ”¶é›†é€Ÿç‡ &gt; å†…å­˜åˆ†é…é€Ÿç‡ã€‚</strong>æ¯æ¬¡GCå‘¨æœŸä¸ç”¨å®Œæˆæ‰€æœ‰å†…å­˜å—çš„åƒåœ¾æ”¶é›†å·¥ä½œï¼Œåœé¡¿æ—¶é—´æ¨¡å‹ä¹Ÿå¯ä»¥åŸºäºG1å»ºç«‹èµ·æ¥ï¼Œè¿™åŒæ—¶ä¹Ÿå‘¼åº”äº†è¿™æ¬¾åƒåœ¾æ”¶é›†å™¨çš„åå­— Garbage Firstã€‚è¿™ç§è®¾è®¡æ€è·¯ä»å·¥ç¨‹å®ç°ä¸Šæ¥çœ‹æ˜¯ä» G1 ä¸Šå¼€å§‹å…´èµ·ï¼Œæ‰€ä»¥è¯´ G1 æ˜¯æ”¶é›†å™¨å‘å±•çš„ä¸€ä¸ªé‡Œç¨‹ç¢‘ã€‚</p><h3 id="G1-é‡åˆ°çš„å›°éš¾åŠè§£å†³æ–¹æ¡ˆ"><a href="#G1-é‡åˆ°çš„å›°éš¾åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="G1 é‡åˆ°çš„å›°éš¾åŠè§£å†³æ–¹æ¡ˆ"></a>G1 é‡åˆ°çš„å›°éš¾åŠè§£å†³æ–¹æ¡ˆ</h3><p>è™½ç„¶G1æå‡ºäº†å‰é¢çš„å¾ˆå¤šè§£å†³ CMS é‡åˆ°é—®é¢˜çš„ç†è®ºï¼Œä½†æ˜¯ç†è®ºåˆ°å®ç°ä¹‹é—´è¿˜éš”ç€å¾ˆé•¿ä¸€æ®µè·¯ã€‚G1ä»ç†è®ºèµ°çº¿å®è·µè‡³å°‘æœ‰ä¸€ä¸‹ä¸‰ä¸ªå…³é”®ç»†èŠ‚é—®é¢˜éœ€è¦å¦¥å–„è§£å†³ã€‚</p><ul><li><strong>è·¨ Region ä¹‹é—´çš„å¼•ç”¨é—®é¢˜ã€‚</strong>æ ¹æ®å‰é¢çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä½¿ç”¨è®°å¿†é›†Remember Setï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„Card Tableï¼‰ï¼Œé€šè¿‡è®°å¿†é›†çš„æ–¹å¼ï¼Œå¯ä»¥é¿å…å…¨å †ä½œä¸º GC Roots è¿›è¡Œæ‰«æã€‚åœ¨ä¹‹å‰çš„æŠ€æœ¯ä¸­ï¼Œä¸ç®¡æ–°ç”Ÿä»£åƒåœ¾æ”¶é›†æ—¶ç”¨åˆ°è¿˜æ˜¯CMSå¹¶å‘æ ‡è®°æ ‡è®°å¼•ç”¨å˜åŠ¨æ—¶ç”¨åˆ°è®°å¿†é›†ï¼Œéƒ½æ˜¯ç®€å•è€å¹´ä»£çš„æ ‡è®°ã€‚ä½†æ˜¯G1åœ¨è®°å¿†é›†ä¸­çš„è¿ç”¨åˆ™å¤æ‚çš„å¤šï¼Œæ¯ä¸€ä¸ªRegionéƒ½éœ€è¦ç»´æŠ¤ç€è‡ªå·±çš„è®°å¿†é›†ã€‚é‡Œé¢è®°å½•ç€<strong>åˆ«çš„RegionæŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆï¼Œå¹¶æ ‡è®°ç€è¿™äº›æŒ‡é’ˆåœ¨å“ªäº›èŒƒå›´å¡é¡µä¹‹å†…ã€‚</strong>Remeber Set æœ¬è´¨çš„é›†åˆæ˜¯ä¸€ç§ Hash è¡¨ï¼ŒKey æ˜¯åˆ«çš„Regionçš„èµ·å§‹åœ°å€ï¼ŒValueæ˜¯ä¸€ä¸ªé›†åˆï¼Œé‡Œé¢å­˜å‚¨çš„å…ƒç´ å¡è¡¨çš„ç´¢å¼•å·ï¼Œè¿™ç§ç»“æ„ä¸åŒäºå¡è¡¨ï¼Œå¡è¡¨è®°å½•çš„æ˜¯â€œæˆ‘æŒ‡å‘è°â€ï¼Œè€Œè¿™ç§ç»“æ„è®°å½•çš„æ›´å¤šçš„æ˜¯â€œè°æŒ‡å‘æˆ‘â€ã€‚è¿™ç§ç»“æ„æ¯”å¡è¡¨å®ç°èµ·æ¥æ›´åŠ çš„å¤æ‚ï¼ŒåŒæ—¶Regionçš„æ•°é‡åˆæ¯”ä¼ ç»Ÿæ”¶é›†å™¨åˆ†ä»£æ•°é‡å¤šå¾—å¤šï¼Œ<strong>å› æ­¤G1æ”¶é›†å™¨ç›¸æ¯”å…¶ä»–çš„ä¼ ç»Ÿåƒåœ¾æ”¶é›†å™¨æœ‰ç€æ›´é«˜çš„å†…å­˜å ç”¨è´Ÿæ‹…</strong>ï¼Œæ›´å…·ç»éªŒè¿™ä¸ª<strong>é¢å¤–å¼€é”€å¤§è‡´ç›¸å½“äºå †å®¹é‡çš„10%ï½20%ã€‚</strong></li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210606230603.png"></p><ul><li><strong>å¹¶å‘æ ‡è®°é˜¶æ®µå¦‚ä½•ä¿è¯æ”¶é›†çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹äº’ä¸å¹²æ‰°çš„è¿è¡Œã€‚</strong>è¿™é‡Œè¦è§£å†³çš„ä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯å¹¶å‘çš„è¿›è¡Œæ ‡è®°ï¼Œç”¨æˆ·çº¿ç¨‹æ”¹å˜å¯¹è±¡å¼•ç”¨å…³ç³»æ—¶ï¼Œå¿…é¡»ä¿è¯å…¶ä¸èƒ½æ‰“ç ´åŸæœ¬çš„å¯¹è±¡å›¾ç»“æ„ï¼Œå¯¼è‡´æ ‡è®°ç»“æœå‡ºç°é—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸‰è‰²æ ‡è®°æ³•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸‰è‰²æ ‡è®°æ³•åœ¨å‰é¢ä¸€å°èŠ‚ã€ŠJVM GCç¯‡ â€” ä¸€èˆ¬åŸç†ä¸åƒåœ¾æ”¶é›†ç®—æ³•ã€‹ä¸­æœ‰è¯¦ç»†ä»‹ç»ã€‚æ­¤å¤–<strong>åƒåœ¾æ”¶é›†å¯¹åº”ç”¨çº¿ç¨‹çš„å½±å“è¿˜ä½“ç°åœ¨å›æ”¶è¿‡ç¨‹ä¸­å¯¹è±¡çš„åˆ†é…ä¸Š</strong>ï¼Œç¨‹åºè¦ç»§ç»­è¿è¡Œå°±è¦åœ¨åƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­åˆ›å»ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´ã€‚G1ä¸ºæ¯ä¸ªRegionè®¾è®¡äº†<strong>ä¸¤ä¸ªåä¸ºTAMSï¼ˆTop at Mark Startï¼‰çš„æŒ‡é’ˆï¼ŒæŠŠä¸€éƒ¨åˆ†ç©ºé—´åˆ’åˆ†å‡ºæ¥ç”¨äºå¹¶å‘å›æ”¶è¿‡ç¨‹ä¸­æ–°çš„å¯¹è±¡åˆ†é…</strong>ã€‚G1åœ¨è¿™ä¸ªåœ°å€ä¸Šçš„å¯¹è±¡æ˜¯éšå¼æ ‡è®°è¿‡çš„ï¼Œå³é»˜è®¤å®ƒä»¬æ˜¯â€œå­˜æ´»â€çš„ï¼Œä¸çº³å…¥å›æ”¶èŒƒå›´ã€‚åœ¨G1ä¸­ä¹Ÿæœ‰ CMS ä¸­â€œConcurrent Mode failedâ€çš„ç±»ä¼¼åœºæ™¯ï¼Œå¦‚æœ<strong>åƒåœ¾å›æ”¶é€Ÿåº¦èµ¶ä¸ä¸Šå†…å­˜åˆ†é…é€Ÿåº¦ï¼ŒG1ä¹Ÿä¼šè¢«è¿«è¿›è¡Œ<code>FullGC</code>ï¼Œä»è€Œå¯¼è‡´è¾ƒé•¿æ—¶é—´çš„STWã€‚</strong></li><li><strong>å¦‚ä½•å»ºç«‹å¯é çš„åœé¡¿é¢„æµ‹æ¨¡å‹ã€‚</strong>è§£å†³äº†ä¸Šé¢çš„ä¸¤ä¸ªé—®é¢˜è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ€ä¹ˆå»ºç«‹å¯é çš„åœé¡¿é¢„æµ‹æ¨¡å‹ï¼Ÿè¿™æ˜¯G1è®¾è®¡çš„å°ç›®æ ‡ï¼Œç”¨æˆ·é€šè¿‡<code>-XX:MaxGCPauseMillis</code> å‚æ•°æŒ‡å®šåœé¡¿æ—¶é—´åªæ„å‘³ç€åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰çš„æœŸæœ›ï¼Œä½†æ˜¯G1æ˜¯æ€ä¹ˆåœ¨åƒåœ¾æ”¶é›†æ—¶ï¼Œæ»¡è¶³ç”¨æˆ·çš„æœŸæœ›å€¼çš„å‘¢ï¼ŸG1 ä½¿ç”¨çš„åœé¡¿é¢„æµ‹æ¨¡å‹æ˜¯ä»¥<code>è¡°å‡å‡å€¼ï¼ˆDecaying Averageï¼‰</code>ï¼Œä¸ºç†è®ºåŸºç¡€æ¥å®ç°çš„ã€‚åœ¨åƒåœ¾æ”¶é›†çš„è¿‡ç¨‹ä¸­ï¼ŒG1æ”¶é›†å™¨ä¼šè®°å½•æ¯ä¸ª Region çš„å›æ”¶è€—æ—¶ã€æ¯ä¸ª Region è®°å¿†é›†é‡Œé¢çš„è„å¡æ•°é‡ç­‰å„ä¸ª<strong>å¯æµ‹é‡çš„æ­¥éª¤èŠ±è´¹çš„æˆæœ¬ï¼Œå¹¶ä¸”åˆ†æå¾—å‡ºå¹³å‡å€¼ã€æ ‡å‡†åå·®ã€ç½®ä¿¡åº¦ç­‰ç»Ÿè®¡ä¿¡æ¯</strong>ã€‚è¿™é‡Œå¼ºè°ƒçš„â€œ<code>è¡°å‡å¹³å‡å€¼</code>â€æ˜¯æŒ‡çš„<strong>å®ƒä¼šæ¯”æ™®é€šçš„å¹³å‡å€¼æ›´å®¹æ˜“æ”¶åˆ°æ–°æ•°æ®çš„å½±å“</strong>ï¼Œå¹³å‡å€¼ä»£è¡¨æ•´ä½“å¹³å‡çŠ¶æ€ï¼Œä½†æ˜¯å¹³å‡å€¼æ›´å‡†ç¡®åœ°ä»£è¡¨äº†â€œæœ€è¿‘çš„â€å¹³å‡çŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œ<strong>Regionçš„ç»Ÿè®¡çŠ¶æ€è¶Šæ–°è¶Šèƒ½å†³å®šå…¶å›æ”¶çš„ä»·å€¼</strong>ã€‚ç„¶åé€šè¿‡è¿™äº›ä¿¡æ¯è¿›è¡Œåˆ†æï¼Œå®Œæˆåœ¨<strong>ä¸è¶…è¿‡æœŸæœ›åœé¡¿æ—¶é—´çš„çº¦æŸä¸‹è¾¾åˆ°æ”¶é›†æ”¶ç›Šçš„æœ€å¤§åŒ–ã€‚</strong></li></ul><h3 id="G1-çš„æ”¶é›†æµç¨‹"><a href="#G1-çš„æ”¶é›†æµç¨‹" class="headerlink" title="G1 çš„æ”¶é›†æµç¨‹"></a>G1 çš„æ”¶é›†æµç¨‹</h3><p>å¦‚æœä¸è€ƒè™‘åº”ç”¨çº¿ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­çš„åŠ¨ä½œï¼ˆç”¨å†™å±éšœç»´æŠ¤è®°å¿†é›†æ“ä½œï¼‰ï¼ŒG1 çš„åƒåœ¾å›æ”¶è¿‡ç¨‹å¯ä»¥åˆ†ä¸ºä¸‹é¢å››ä¸ªæ­¥éª¤ï¼š</p><ul><li><strong>åˆå§‹åŒ–æ ‡è®°ï¼ˆInital Markingï¼‰</strong>ï¼šä»…ä»…æ˜¯æ ‡è®°ä¸‹<strong>GC Rootsèƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡</strong>ï¼Œå¹¶ä¸”<strong>ä¿®æ”¹</strong><code>TAMS</code><strong>æŒ‡é’ˆ</strong>çš„ä½ç½®çš„å€¼ï¼Œè®©ä¸‹ä¸€ä¸ªé˜¶æ®µç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿è¡Œçš„æ—¶å€™ï¼Œèƒ½æ­£ç¡®åœ°åœ¨<strong>å¯ç”¨çš„Regionä¸­åˆ†é…å¯¹è±¡</strong>ï¼Œè¿™ä¸ªé˜¶æ®µéœ€è¦æš‚åœçº¿ç¨‹ï¼Œä½†è€—æ—¶å¾ˆçŸ­ï¼Œè€Œä¸”æ˜¯å€Ÿç”¨è¿›è¡Œçš„ Minor GC çš„æ—¶å€™åŒæ­¥å®Œæˆçš„ï¼Œæ‰€ä»¥ G1 æ”¶é›†å™¨åœ¨è¿™ä¸ªé˜¶æ®µå®é™…å¹¶æ²¡æœ‰é¢å¤–çš„åœé¡¿ã€‚</li></ul><blockquote><p>â€œå€Ÿç”¨è¿›è¡Œçš„ Minor GC çš„æ—¶å€™åŒæ­¥å®Œæˆçš„â€ è¿™é‡Œæ˜¯Mixedæ¨¡å¼çš„GC å³æ”¶é›†<strong>å¹´è½»ä»£å’Œéƒ¨åˆ†è€å¹´ä»£</strong>ï¼Œä¸€æ¬¡Minor GCä¹‹åï¼Œè€å¹´ä»£å æ®å †å†…å­˜çš„ç™¾å æ¯”è¶…è¿‡InitiatingHeapOccupancyPercentï¼ˆé»˜è®¤45%ï¼‰æ—¶ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡ MixedGC</p></blockquote><ul><li><strong>å¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰</strong>ï¼šä»GC Rootå¼€å§‹å¯¹å †ä¸­çš„å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œ<strong>é€’å½’æ‰«ææ•´ä¸ªå †é‡Œé¢çš„å¯¹è±¡å›¾ï¼Œæ‰¾å‡ºè¦å›æ”¶çš„å¯¹è±¡</strong>ã€‚è¿™ä¸ªé˜¶æ®µæ—¶é—´æ¯”è¾ƒé•¿çš„ï¼Œå¯ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚å½“æ‰«æå®Œæˆè¿˜è¦å¹¶å‘æ—¶çš„å¼•ç”¨å˜åŒ–ï¼Œä¸ºæœ€ç»ˆçš„æœ€ç»ˆæ ‡è®°é˜¶æ®µå¤„ç†SATBæ‰“ä¸‹åŸºç¡€ã€‚</li><li><strong>æœ€ç»ˆæ ‡è®°ï¼ˆfinal Markingï¼‰ï¼š</strong>å¯¹åº”ç”¨çº¿ç¨‹åšä¸€ä¸ªçŸ­æš‚çš„æš‚åœï¼Œç”¨äº<strong>å¤„ç†å¹¶å‘é˜¶æ®µç»“æŸåä»ç„¶é—ç•™ä¸‹çš„å°‘é‡çš„SATB</strong>ã€‚</li><li><strong>ç­›é€‰å›æ”¶ï¼ˆLiving Data Counting and Evacuationï¼‰ï¼š</strong>è´Ÿè´£æ›´æ–°Regionçš„ç»Ÿè®¡æ•°æ®ï¼Œå¯¹å„ä¸ªRegion çš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œ<strong>æ ¹æ®ç”¨æˆ·æœŸæœ›çš„åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’</strong>ï¼Œå¯ä»¥é€‰æ‹©ä»»æ„å¤šä¸ªRegionæ„æˆå›æ”¶é›†ï¼Œç„¶å<strong>æŠŠå›æ”¶é›†ä¸­å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°ç©ºçš„ Region ä¸­ï¼Œå†æ¸…ç©ºæ•´ä¸ªæ—§Regionç©ºé—´</strong>ã€‚å› ä¸ºåœ¨å¤åˆ¶å¯¹è±¡è¿‡ç¨‹ä¸­è®¾è®¡çš„å­˜æ´»å¯¹è±¡çš„ç§»åŠ¨ï¼Œæ‰€ä»¥å¿…é¡»è¦æš‚åœåº”ç”¨çº¿ç¨‹ï¼ŒåŒæ—¶ç”±å¤šä¸ªæ”¶é›†å™¨çº¿ç¨‹å¹¶è¡Œå®Œæˆå¤åˆ¶è¿‡ç¨‹ã€‚è¿™ä¸ªæš‚åœçš„è¿‡ç¨‹å«åš<strong>è½¬ç§»æš‚åœï¼ˆEvacuation Pauseï¼‰</strong></li></ul><blockquote><p>å†™å±éšœï¼Œè¿™é‡Œçš„å†™å±éšœå’Œå¤šçº¿ç¨‹Java å†…å­˜æ¨¡å‹ä¸­çš„å†…å­˜æ¨¡å‹ä¸ä¸€æ ·ï¼Œè¿™é‡Œçš„å†™å±éšœåªæ˜¯åœ¨å­—èŠ‚ç å±‚é¢ï¼Œåœ¨æ‰§è¡ŒæŸä¸ªå†™æ“ä½œæ—¶å€™ä¸€ä¸ª<strong>ç±»ä¼¼AOPçš„ç»“æ„</strong>ï¼Œå¯ä»¥å°†ä¸€äº›æ“ä½œæ’å…¥åœ¨å†™å…¥å‰åã€‚</p></blockquote><h3 id="ä¸€ä¸ªç»†èŠ‚-â€”-å•ä¸ªRegionåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…çš„å¹¶å‘ç­–ç•¥"><a href="#ä¸€ä¸ªç»†èŠ‚-â€”-å•ä¸ªRegionåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…çš„å¹¶å‘ç­–ç•¥" class="headerlink" title="ä¸€ä¸ªç»†èŠ‚ â€” å•ä¸ªRegionåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…çš„å¹¶å‘ç­–ç•¥"></a>ä¸€ä¸ªç»†èŠ‚ â€” å•ä¸ªRegionåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…çš„å¹¶å‘ç­–ç•¥</h3><p>æˆ‘ä»¬å‰é¢ä¹Ÿæ¢³ç†äº†ä¸€éG1çš„åƒåœ¾æ”¶é›†è¿‡ç¨‹ï¼Œå¤§ä½“ä¸Šæœ‰ä¸€ä¸ªæ¸…æ™°æ˜äº†çš„è®¤è¯†ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªç»†èŠ‚æˆ‘å§‹ç»ˆä¸æ˜ç™½å°±æ˜¯åœ¨â€œG1 é‡åˆ°çš„é—®é¢˜ä¸­çš„ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå¹¶å‘æ ‡è®°é˜¶æ®µå¦‚ä½•ä¿è¯æ”¶é›†çº¿ç¨‹å’Œç”¨æˆ·çº¿ç¨‹äº’ä¸å¹²æ‰°çš„è¿è¡Œã€‚â€ï¼Œé‡Œé¢æåˆ°äº† <code>G1ä¸ºæ¯ä¸ªRegionè®¾è®¡äº†ä¸¤ä¸ªåä¸ºTAMSï¼ˆTop at Mark Startï¼‰çš„æŒ‡é’ˆï¼ŒæŠŠä¸€éƒ¨åˆ†ç©ºé—´åˆ’åˆ†å‡ºæ¥ç”¨äºå¹¶å‘å›æ”¶è¿‡ç¨‹ä¸­æ–°çš„å¯¹è±¡åˆ†é…ã€‚</code> <code>TAMS</code>æŒ‡é’ˆåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªTAMS æŒ‡é’ˆæ‰èƒ½åˆ’å‡ºä¸€å—ç©ºé—´å‘¢ï¼Ÿéš¾é“ä¸æ˜¯ä¸€ä¸ªå°±å¯ä»¥åˆ’åˆ†ä¸¤ç‰‡åŒºåŸŸä¸€ç‰‡åƒåœ¾å›æ”¶ä¸€ç‰‡åˆ†é…å¯¹è±¡ç©ºé—´å°±å¯ä»¥äº†å—ï¼Ÿè¿™ä¸ªé—®é¢˜çš„æœ¬è´¨é—®é¢˜å°±æ˜¯<strong>å•ä¸ªRegionåœ¨å¹¶å‘æ ‡è®°é˜¶æ®µåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…ä¹‹é—´çš„å¹¶å‘ç­–ç•¥æ˜¯æ€æ ·çš„ï¼Ÿ</strong>ä¸ºäº†è®©å¹¶å‘çš„çº¿ç¨‹æ“ä½œRegionä¸­çš„åŒºå—ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–çš„æ•°æ®ç»“æ„ååŠ©ï¼Œä¸¤ä¸ª<code>bitmap</code>å’Œä¸¤ä¸ªæŒ‡é’ˆï¼ˆ<code>TAMSæŒ‡é’ˆ</code>ï¼‰ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¸¤ä¸ªbitMapå’Œä»–ä»¬åœ¨å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­çš„ä¸€äº›è¡Œä¸ºåŠ¨ä½œï¼š</p><blockquote><p>bitMap åœ¨ G1 ä¸­æ˜¯ç”¨æ¥æ ‡è®°åƒåœ¾ä½ç½®çš„ï¼Œåƒåœ¾ä¸ä¼šç›´æ¥åœ¨ region ä¸­è¢«æ ‡è®°å‡ºæ¥ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªbitMapæ¥æ ‡è®°å¾…å›æ”¶å¯¹è±¡ä½ç½®ã€‚</p></blockquote><ul><li>è¿™ä¸¤ä¸ª<code>bitMap</code>åˆ†åˆ«æ˜¯ <code>previousBitMap</code>ï¼Œ<code>nextBitMap</code><strong>ã€‚</strong></li><li><code>previousBitMap</code>æ˜¯<strong>ä¸Šä¸€è½®</strong><code>concurrent marking</code>é˜¶æ®µå®Œæˆæ ‡è®°åçš„<strong>æ²¡æœ‰è¢«å›æ”¶</strong>çš„åƒåœ¾ä½ç½®ã€‚</li><li><code>nextBitMap</code>æ˜¯å½“å‰æ­£åœ¨è¿›è¡Œçš„<code>concurrent marking</code>é˜¶æ®µçš„bitmapã€‚</li><li>å½“<code>concurrent marking</code>æ ‡è®°å®Œæˆåï¼Œä¸¤ä¸ª<code>bitmap</code>ä¼šäº¤æ¢è§’è‰²ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210610001206.png"></p><p>bitmap ä¸Šé¢çš„æ•°ç»„ç»“æ„ï¼ˆ<code>RoaringBitMap</code>å’Œ<code>redis</code>ä¸­çš„<code>BitMap</code>éƒ½æ˜¯è¿™æ ·çš„ç»“æ„ï¼‰ï¼Œå…¶ä¸­<strong>ç™½è‰²çš„åŒºåŸŸæ˜¯å­˜æ´»å¯¹è±¡ï¼Œç°è‰²çš„æ˜¯å¾…å›æ”¶çš„åƒåœ¾å¯¹è±¡</strong>ã€‚é™¤äº†bitmapæˆ‘ä»¬è¿˜éœ€è¦ä¸¤ä¸ª<code>TAMS</code>ï¼ˆTop at Mark Startï¼‰æŒ‡é’ˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹åœ¨åƒåœ¾å›æ”¶å„ä¸ªé˜¶æ®µï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆæ˜¯æ€ä¹ˆé…åˆåˆ’åˆ†çº¿ç¨‹è¿›è¡Œå†…å­˜æ¥åˆ†é…å’Œåƒåœ¾å›æ”¶ã€‚</p><ul><li><strong>åˆå§‹æ ‡è®°é˜¶æ®µ</strong>ï¼Œä»ä¸‹é¢çš„å›¾ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œåˆå§‹æ ‡è®°é˜¶æ®µ<code>PrevTAMS</code>æŒ‡é’ˆå’Œ<code>Bottom</code>æŒ‡é’ˆï¼ˆ<strong>regionçš„åˆå§‹ä½ç½®</strong>ï¼‰ä½ç½®ä¸€è‡´ï¼ŒåŒæ—¶ç¬¬äºŒä¸ª<code>NextTAMS</code>çš„æŒ‡é’ˆå’ŒTopæŒ‡é’ˆä½ç½®ä¸€è‡´ï¼Œå…¶ä¸­<strong>topæŒ‡é’ˆæ˜¯å·²åˆ†é…çš„å†…å­˜å’Œæœªåˆ†é…å†…å­˜çš„åˆ‡åˆ†ç‚¹ã€‚</strong>åŒæ—¶åˆå§‹åŒ–<code>NextBitMap</code>ï¼Œç”±äºè¿™æ˜¯ä¸€å—å¹²å‡€çš„Regionï¼Œå› æ­¤PrevBitMapæ˜¯ç©ºçš„ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210610003231.png"></p><ul><li><strong>å¹¶å‘æ ‡è®°å’Œæœ€ç»ˆé˜¶æ®µ</strong>ï¼Œä¸‹é¢çš„å›¾æ˜¯æ ‡è®°å®ŒæˆåRegionä¸­çš„æƒ…å†µï¼Œå…¶ä¸­GCçº¿ç¨‹åœ¨<code>PrevTAMS</code>å’Œ<code>NextTAMS</code><strong>ä¹‹é—´è¿›è¡Œå¹¶å‘æ ‡è®°</strong>ï¼Œè€Œ<strong>æ–°å¯¹è±¡çš„å†…å­˜åˆ†é…åœ¨<code>NextTAMS</code>å’Œ<code>TOP</code>ä¹‹é—´è¿›</strong>è¡Œï¼Œç”±äºæ˜¯åˆšåˆ†é…çš„å¯¹è±¡GCé»˜è®¤è¿™é‡Œçš„å¯¹è±¡éƒ½æ˜¯å­˜æ´»çŠ¶æ€ã€‚è¿™æ ·å°±å·§å¦™çš„è§£å†³äº†åƒåœ¾æ”¶é›†å’Œå¯¹è±¡å†…å­˜åˆ†é…çš„å¹¶å‘é—®é¢˜ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210610003425.png"></p><ul><li><strong>æ¸…ç†é˜¶æ®µ</strong>ï¼Œæœ€ç»ˆæ¸…ç†é˜¶æ®µï¼Œæˆ‘ä»¬å°†<code>NextBitMap</code>èµ‹å€¼ç»™<code>PrevBitMap</code>ã€‚å¦‚æœ<strong>ä¸è¿›è¡Œæš‚åœè½¬ç§»å¹¶å‘æ¸…ç†åƒåœ¾å¯¹è±¡</strong>å³å¯å¹¶<strong>ç»§ç»­ä½¿ç”¨</strong>è¿™ä¸ªRegionã€‚å¦‚æœè¿›è¡Œ<strong>å¯¹è±¡è½¬ç§»</strong>ï¼Œé‚£ä¹ˆå°†<strong>æŠŠå­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ä¸€ä¸ªæ–°çš„Region</strong>ä¸­å¹¶<strong>æ¸…ç©º</strong>å½“å‰Regionã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210610004607.png"></p><ul><li><strong>ä¸‹ä¸€è½®åˆå§‹æ ‡è®°</strong>ï¼ŒåŒæ ·çš„æˆ‘ä»¬åˆå§‹åŒ–æ–°çš„<code>NextBitMap</code>ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ“ä½œå°±æ˜¯<strong>æŠŠ<code>NextTAMS</code>æŒ‡å‘<code>TOP</code>çš„ä½ç½®</strong>ï¼Œå‘Šè¯‰GCæœ¬è½®æ ‡è®°çš„å·¥ä½œç©ºé—´èŒƒå›´ã€‚ç„¶åæ¥ä¸‹æ¥<code>TAMS</code>å’Œ<code>bitMap</code>å°±æŒ‰ç…§ä¸Šé¢çš„æ ‡è®°å’Œæ¸…ç†é˜¶æ®µä¸æ–­å¾ªç¯ä¸‹å»ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210611012152.png"></p><p>æ¥ä¸‹æ¥Regionçš„ä¸­çš„TAMSæŒ‡é’ˆå’ŒbitMapçš„æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210610005825.png"></p><p>å¦‚æœæœ‰é™æ€å›¾è¿˜æ˜¯æœ‰ç‚¹æ‡µï¼Œæ•´ä¸ªæµç¨‹çš„åŠ¨å›¾å¦‚ä¸‹ ğŸ˜‰</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/17093e8bc74d2cb5.gif"></p><blockquote><p>è¿™ä¸ªé—®é¢˜æˆ‘ä¹Ÿæ˜¯çœ‹ä¹¦æ—¶å€™çœ‹æ‡µäº†ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªTAMSå‘¢ï¼Ÿå°±åƒå½»åº•ææ¸…æ¥šè¿™ä¸ªæµç¨‹ï¼Œç„¶ååœ¨ç½‘ä¸Šå‘ç°äº†ã€Š<a href="https://www.cnblogs.com/thisiswhy/p/12388638.html">é¢è¯•å®˜é—®æˆ‘G1å›æ”¶å™¨æ€ä¹ˆçŸ¥é“ä½ æ˜¯ä»€ä¹ˆæ—¶å€™çš„åƒåœ¾ï¼Ÿ</a>ã€‹è¿™ç¯‡æ–‡ç« ï¼Œè¿™ç¯‡æ–‡ç« å†™çš„éå¸¸æœ‰æ„æ€ï¼Œå¼ºçƒˆå»ºè®®çœ‹ä¸€éåŸæ–‡ã€‚</p></blockquote><h3 id="G1-ä¸­å¸¸ç”¨çš„å‚æ•°"><a href="#G1-ä¸­å¸¸ç”¨çš„å‚æ•°" class="headerlink" title="G1 ä¸­å¸¸ç”¨çš„å‚æ•°"></a>G1 ä¸­å¸¸ç”¨çš„å‚æ•°</h3><ul><li><code>-XX:+UseG1GC</code> ï¼šå¯ç”¨G1 GCï¼ŒJDK7å’ŒJDK8è¦æ±‚å¿…é¡»æ˜¾ç¤ºç”³è¯·å¯åŠ¨G1 GCï¼›</li><li><code>-XX:G1NewSizePercent</code> ï¼šåˆå§‹å¹´è½»ä»£å æ•´ä¸ªJava Heapçš„å¤§å°ï¼Œé»˜è®¤å€¼ä¸º5%ï¼›</li><li><code>-XX:G1MaxNewSizePercent</code> ï¼šæœ€å¤§å¹´è½»ä»£å æ•´ä¸ªJava Heapçš„å¤§å°ï¼Œé»˜è®¤å€¼ä¸º60%ï¼›</li><li><code>-XX:G1HeapRegionSize</code> ï¼šè®¾ç½®æ¯ä¸ªRegionçš„å¤§å°ï¼Œå•ä½MBï¼Œéœ€è¦ä¸º1ï¼Œ2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ32ä¸­çš„æŸä¸ªå€¼ï¼Œé»˜è®¤æ˜¯å †å†…å­˜çš„1/2000ã€‚å¦‚æœè¿™ä¸ªå€¼è®¾ç½®æ¯”è¾ƒå¤§ï¼Œé‚£ä¹ˆå¤§å¯¹è±¡å°±å¯ä»¥è¿›å…¥Regionäº†ã€‚</li><li><code>-XX:ConcGCThreads</code> ï¼šä¸Javaåº”ç”¨ä¸€èµ·æ‰§è¡Œçš„GCçº¿ç¨‹æ•°é‡ï¼Œé»˜è®¤æ˜¯<strong>Javaçº¿ç¨‹çš„1/4</strong>ï¼Œå‡å°‘è¿™ä¸ªå‚æ•°çš„æ•°å€¼å¯èƒ½ä¼šæå‡å¹¶è¡Œå›æ”¶çš„æ•ˆç‡ï¼Œæé«˜ç³»ç»Ÿå†…éƒ¨ååé‡ã€‚å¦‚æœè¿™ä¸ªæ•°å€¼è¿‡ä½ï¼Œå‚ä¸å›æ”¶åƒåœ¾çš„çº¿ç¨‹ä¸è¶³ï¼Œä¹Ÿä¼šå¯¼è‡´å¹¶è¡Œå›æ”¶æœºåˆ¶è€—æ—¶åŠ é•¿ã€‚</li><li><code>-XX:+InitiatingHeapOccupancyPercent</code> ï¼ˆç®€ç§°IHOPï¼‰ï¼šG1å†…éƒ¨å¹¶è¡Œå›æ”¶å¾ªç¯å¯åŠ¨çš„é˜ˆå€¼ï¼Œé»˜è®¤ä¸ºJava Heapçš„45%ã€‚è¿™ä¸ªå¯ä»¥ç†è§£ä¸ºè€å¹´ä»£ä½¿ç”¨å¤§äºç­‰äº45%çš„æ—¶å€™ï¼ŒJVMä¼šå¯åŠ¨åƒåœ¾å›æ”¶ã€‚è¿™ä¸ªå€¼éå¸¸é‡è¦ï¼Œå®ƒå†³å®šäº†åœ¨ä»€ä¹ˆæ—¶é—´å¯åŠ¨è€å¹´ä»£çš„å¹¶è¡Œå›æ”¶ã€‚</li><li><code>-XX:G1HeapWastePercent</code> ï¼šG1åœæ­¢å›æ”¶çš„æœ€å°å†…å­˜å¤§å°ï¼Œé»˜è®¤æ˜¯å †å¤§å°çš„5%ã€‚GCä¼šæ”¶é›†æ‰€æœ‰çš„Regionä¸­çš„å¯¹è±¡ï¼Œä½†æ˜¯å¦‚æœä¸‹é™åˆ°äº†5%ï¼Œå°±ä¼šåœä¸‹æ¥ä¸å†æ”¶é›†äº†ã€‚å°±æ˜¯è¯´ï¼Œä¸å¿…æ¯æ¬¡å›æ”¶å°±æŠŠæ‰€æœ‰çš„åƒåœ¾éƒ½å¤„ç†å®Œï¼Œå¯ä»¥é—ç•™å°‘é‡çš„ä¸‹æ¬¡å¤„ç†ï¼Œè¿™æ ·ä¹Ÿé™ä½äº†å•æ¬¡æ¶ˆè€—çš„æ—¶é—´ã€‚</li><li><code>-XX:G1MixedGCCountTarget</code> ï¼šè®¾ç½®å¹¶è¡Œå¾ªç¯ä¹‹åéœ€è¦æœ‰å¤šå°‘ä¸ªæ··åˆGCå¯åŠ¨ï¼Œé»˜è®¤å€¼æ˜¯8ä¸ªã€‚è€å¹´ä»£Regionsçš„å›æ”¶æ—¶é—´é€šå¸¸æ¯”å¹´è½»ä»£çš„æ”¶é›†æ—¶é—´è¦é•¿ä¸€äº›ã€‚æ‰€ä»¥å¦‚æœæ··åˆæ”¶é›†å™¨æ¯”è¾ƒå¤šï¼Œå¯ä»¥å…è®¸G1å»¶é•¿è€å¹´ä»£çš„æ”¶é›†æ—¶é—´ã€‚</li><li><code>-XX:+G1PrintRegionLivenessInfo</code> ï¼šè¿™ä¸ªå‚æ•°éœ€è¦å’Œ <code>-XX:+UnlockDiagnosticVMOptions</code> é…åˆå¯åŠ¨ï¼Œæ‰“å°JVMçš„è°ƒè¯•ä¿¡æ¯ï¼Œæ¯ä¸ªRegioné‡Œçš„å¯¹è±¡å­˜æ´»ä¿¡æ¯ã€‚</li><li><code>-XX:G1ReservePercent</code> ï¼šG1ä¸ºäº†ä¿ç•™ä¸€äº›ç©ºé—´ç”¨äºå¹´ä»£ä¹‹é—´çš„æå‡ï¼Œé»˜è®¤å€¼æ˜¯å †ç©ºé—´çš„10%ã€‚å› ä¸ºå¤§é‡æ‰§è¡Œå›æ”¶çš„åœ°æ–¹åœ¨å¹´è½»ä»£ï¼ˆå­˜æ´»æ—¶é—´è¾ƒçŸ­ï¼‰ï¼Œæ‰€ä»¥å¦‚æœä½ çš„åº”ç”¨é‡Œé¢æœ‰æ¯”è¾ƒå¤§çš„å †å†…å­˜ç©ºé—´ã€æ¯”è¾ƒå¤šçš„å¤§å¯¹è±¡å­˜æ´»ï¼Œè¿™é‡Œéœ€è¦ä¿ç•™ä¸€äº›å†…å­˜ã€‚</li><li><code>-XX:+G1SummarizeRSetStats</code> ï¼šè¿™ä¹Ÿæ˜¯ä¸€ä¸ªVMçš„è°ƒè¯•ä¿¡æ¯ã€‚å¦‚æœå¯ç”¨ï¼Œä¼šåœ¨VMé€€å‡ºçš„æ—¶å€™æ‰“å°å‡ºRSetsçš„è¯¦ç»†æ€»ç»“ä¿¡æ¯ã€‚å¦‚æœå¯ç”¨ <code>-XX:G1SummaryRSetStatsPeriod</code> å‚æ•°ï¼Œå°±ä¼šé˜¶æ®µæ€§åœ°æ‰“å°RSetsä¿¡æ¯ã€‚</li><li><code>-XX:+G1TraceConcRefinement</code> ï¼šè¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªVMçš„è°ƒè¯•ä¿¡æ¯ï¼Œå¦‚æœå¯ç”¨ï¼Œå¹¶è¡Œå›æ”¶é˜¶æ®µçš„æ—¥å¿—å°±ä¼šè¢«è¯¦ç»†æ‰“å°å‡ºæ¥ã€‚</li><li><code>-XX:+GCTimeRatio</code> ï¼šå¤§å®¶çŸ¥é“ï¼ŒGCçš„æœ‰äº›é˜¶æ®µæ˜¯éœ€è¦Stop-the-Worldï¼Œå³åœæ­¢åº”ç”¨çº¿ç¨‹çš„ã€‚è¿™ä¸ªå‚æ•°å°±æ˜¯è®¡ç®—èŠ±åœ¨Javaåº”ç”¨çº¿ç¨‹ä¸Šå’ŒèŠ±åœ¨GCçº¿ç¨‹ä¸Šçš„æ—¶é—´æ¯”ç‡ï¼Œé»˜è®¤æ˜¯9ï¼Œè·Ÿæ–°ç”Ÿä»£å†…å­˜çš„åˆ†é…æ¯”ä¾‹ä¸€è‡´ã€‚è¿™ä¸ªå‚æ•°ä¸»è¦çš„ç›®çš„æ˜¯è®©ç”¨æˆ·å¯ä»¥æ§åˆ¶èŠ±åœ¨åº”ç”¨ä¸Šçš„æ—¶é—´ï¼ŒåŒæ ·çš„ï¼ŒG1åº”ç”¨çº¿ç¨‹å’ŒGCèŠ±è´¹æ—¶é—´æ¯”ä¾‹çš„è®¡ç®—å…¬å¼ä¸º<code>1/(1+GCTimeRatio)</code>ã€‚è¿™æ ·å¦‚æœå‚æ•°è®¾ç½®ä¸º9ï¼Œåˆ™æœ€å¤š10%çš„æ—¶é—´ä¼šèŠ±åœ¨GCå·¥ä½œä¸Šé¢ã€‚Parallel GCçš„é»˜è®¤å€¼æ˜¯99ï¼Œè¡¨ç¤º1%çš„æ—¶é—´è¢«ç”¨åœ¨GCä¸Šé¢ï¼Œè¿™æ˜¯å› ä¸ºParallel GCè´¯ç©¿æ•´ä¸ªGCï¼Œè€ŒG1åˆ™æ ¹æ®Regionæ¥è¿›è¡Œåˆ’åˆ†ï¼Œä¸éœ€è¦å…¨å±€æ€§æ‰«ææ•´ä¸ªå†…å­˜å †ã€‚</li></ul><blockquote><p>ğŸ¤”æ€è€ƒï¼Œä¸ºä»€ä¹ˆG1ä¼šå…è®¸æœ€å¤š10%çš„æ—¶é—´ä¼šèŠ±åœ¨GCå·¥ä½œä¸Šé¢ï¼Ÿè¿™ä¸ªå€¼è¿˜ä¼šå½±å“å †ç©ºé—´çš„å¤§å°ï¼Œå½“è¶…è¿‡é¢„æœŸçš„æ—¶é—´ç”¨åœ¨GCä¸Šæ—¶å€™ï¼ŒGCä¼šé€šè¿‡é€‚å½“æ‰©å¤§å †ç©ºé—´çš„æ–¹å¼æ¥é™ä½GCæ—¶é—´å æ¯”ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒG1ç›¸æ¯”ä¹‹å‰çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåœ¨å †æ‰©å¤§çš„ç­–ç•¥ä¸Šå¹¶æ²¡æœ‰é‚£ä¹ˆæ¿€è¿›çš„ã€‚è¿™å¯èƒ½ä¹Ÿå¾—ç›ŠäºG1å†…å­˜RegionåŒ–çš„è®¾è®¡å’Œå¯é çš„æš‚åœé¢„æµ‹æ¨¡å‹ã€‚</p></blockquote><ul><li><code>-XX:+UseStringDeduplication</code> ï¼šæ‰‹åŠ¨å¼€å¯Java Stringå¯¹è±¡çš„å»é‡å·¥ä½œï¼Œè¿™ä¸ªæ˜¯JDK8u20ç‰ˆæœ¬ä¹‹åæ–°å¢çš„å‚æ•°ï¼Œä¸»è¦ç”¨äºç›¸åŒStringé¿å…é‡å¤ç”³è¯·å†…å­˜ï¼ŒèŠ‚çº¦Regionçš„ä½¿ç”¨ã€‚</li><li><code>-XX:MaxGCPauseMills</code> ï¼šé¢„æœŸG1æ¯æ¬¡æ‰§è¡ŒGCæ“ä½œçš„æš‚åœæ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼æ˜¯200æ¯«ç§’ï¼Œ G1ä¼šå°½é‡ä¿è¯æ§åˆ¶åœ¨è¿™ä¸ªèŒƒå›´å†…ã€‚ </li></ul><p>è¿™é‡Œé¢æœ€é‡è¦çš„å‚æ•°ï¼Œå°±æ˜¯ï¼š </p><ol><li><code> -XX:+UseG1GC</code> ï¼šå¯ç”¨G1 GCï¼› </li><li><code>-XX:+InitiatingHeapOccupancyPercent</code> ï¼šå†³å®šä»€ä¹ˆæƒ…å†µä¸‹å‘ç”ŸG1 GCï¼› </li><li><code>-XX:MaxGCPauseMills</code> ï¼šæœŸæœ›æ¯æ¬¡GCæš‚å®šçš„æ—¶é—´ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¾ç½®ä¸º50ï¼Œåˆ™G1 GCä¼šé€šè¿‡è°ƒèŠ‚æ¯æ¬¡GCçš„æ“ä½œæ—¶é—´ï¼Œå°½é‡è®©æ¯æ¬¡ç³»ç»Ÿçš„GCåœé¡¿éƒ½åœ¨50ä¸Šä¸‹æµ®åŠ¨ã€‚å¦‚æœæŸæ¬¡GCæ—¶é—´è¶…è¿‡50msï¼Œ æ¯”å¦‚è¯´100msï¼Œé‚£ä¹ˆç³»ç»Ÿä¼šè‡ªåŠ¨åœ¨åé¢åŠ¨æ€è°ƒæ•´GCè¡Œä¸ºï¼Œå›´ç»•50æ¯«ç§’æµ®åŠ¨ã€‚</li></ol><h2 id="GCé€‰æ‹©ç»éªŒ"><a href="#GCé€‰æ‹©ç»éªŒ" class="headerlink" title="GCé€‰æ‹©ç»éªŒ"></a>GCé€‰æ‹©ç»éªŒ</h2><table><thead><tr><th>æ”¶é›†å™¨</th><th>ä¸²è¡Œã€å¹¶è¡Œæˆ–å¹¶å‘</th><th>æ–°ç”Ÿä»£/è€å¹´ä»£</th><th>ç®—æ³•</th><th>ç›®æ ‡</th><th>é€‚ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>Serial</td><td>ä¸²è¡Œ</td><td>æ–°ç”Ÿä»£</td><td>å¤åˆ¶ç®—æ³•</td><td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td><td>å•æœºCPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼</td></tr><tr><td>Serial Old</td><td>ä¸²è¡Œ</td><td>è€å¹´ä»£</td><td>æ ‡è®°-æ•´ç†</td><td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td><td>å•CPUç¯å¢ƒä¸‹çš„Clientæ¨¡å¼ã€CMSçš„åé¢„å¤‡æ–¹æ¡ˆ</td></tr><tr><td>ParNew</td><td>å¹¶è¡Œ</td><td>æ–°ç”Ÿä»£</td><td>å¤åˆ¶ç®—æ³•</td><td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td><td>å¤šCPUç¯å¢ƒä¸‹åœ¨Serveræ¨¡å¼ä¸‹é…ç½®CMSä½¿ç”¨</td></tr><tr><td>Parallel Scavenge</td><td>å¹¶è¡Œ</td><td>æ–°ç”Ÿä»£</td><td>å¤åˆ¶ç®—æ³•</td><td>ååé‡ä¼˜å…ˆ</td><td>åœ¨åå°è®¡ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’ä»»åŠ¡</td></tr><tr><td>Parallel Old</td><td>å¹¶è¡Œ</td><td>è€å¹´ä»£</td><td>æ ‡è®°-æ•´ç†</td><td>ååé‡ä¼˜å…ˆ</td><td>åœ¨åå°è®¡ç®—è€Œä¸éœ€è¦å¤ªå¤šäº¤äº’ä»»åŠ¡</td></tr><tr><td>CMS</td><td>å¹¶å‘</td><td>è€å¹´ä»£</td><td>æ ‡è®°-æ¸…é™¤</td><td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td><td>é›†ä¸­åœ¨äº’è”ç½‘æˆ–è€…B/Sç³»ç»ŸæœåŠ¡ç«¯ä¸Šçš„Javaåº”ç”¨</td></tr><tr><td>G1</td><td>å¹¶å‘</td><td>both</td><td>æ ‡è®°-æ¸…é™¤+å¤åˆ¶ç®—æ³•</td><td>å“åº”é€Ÿåº¦ä¼˜å…ˆ</td><td>é¢å‘æœåŠ¡ç«¯åº”ç”¨ï¼Œå°†æ¥æ›¿æ¢CMS</td></tr></tbody></table><p>ç»¼åˆçš„çœ‹ä¸‹æ¥ï¼ŒG1æ˜¯HotSpot JVM ä¸­æœ€å…ˆè¿›çš„<strong>å‡†äº§å“çº§ï¼ˆproduction-readyï¼‰</strong>åƒåœ¾æ”¶é›†å™¨ï¼Œå¹¶ä¸”HotSpot å·¥ç¨‹å¸ˆçš„ä¸»è¦ç²¾åŠ›éƒ½æ”¾åœ¨ä¸æ–­æ”¹è¿› G1 ä¸Šï¼Œåœ¨æ›´æ–°çš„JDKç‰ˆæœ¬ä¸­ï¼Œå°†ä¼šå¸¦æ¥æ›´åŠ å¼ºå¤§çš„åŠŸèƒ½å’Œä¼˜åŒ–ã€‚ä½œä¸ºCMSçš„æ›¿ä»£è€…ï¼ŒG1å¼¥è¡¥äº†CMSä¸­å„ç§ä¸è¶³ï¼ŒåŒ…æ‹¬æš‚åœæ—¶é—´å¯é¢„æµ‹ï¼Œå¹¶å½»åº•è§£å†³äº†å †å†…å­˜çš„ç¢ç‰‡åŒ–é—®é¢˜ã€‚<strong>å¯¹äºå•ä¸šåŠ¡å»¶è¿Ÿéå¸¸æ•æ„Ÿçš„ç³»ç»Ÿæ¥è¯´ï¼Œå¦‚æœCPUèµ„æºä¸å—é™åˆ¶ï¼ŒG1 æ˜¯HotSpot ä¸­æœ€å¥½çš„é€‰æ‹©</strong>ã€‚å½“ç„¶è¿™äº›ä¼˜åŒ–å’Œå»¶è¿Ÿä¹Ÿæ˜¯è¦ä»˜å‡ºä»£ä»·çš„ã€‚ç”±äºG1é¢å¤–çš„å†™å±éšœå’Œå®ˆæŠ¤çº¿ç¨‹ï¼ŒG1è¿è¡Œä¹Ÿä¼šæ¶ˆè€—æ¯”å…¶ä»–åƒåœ¾æ”¶é›†å™¨å¤šå¾—å¤šçš„CPUå’Œå†…å­˜èµ„æºã€‚å› æ­¤åœ¨<strong>å°å†…å­˜ï¼ŒCPUèµ„æºæ¯”è¾ƒå®½è£•ï¼Œä¸”æœåŠ¡å“åº”é€Ÿåº¦ä¼˜å…ˆ</strong>çš„åº”ç”¨ä¸Šï¼ŒCMSæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ </p><blockquote><p>G1 é€‚åˆå¤§å†…å­˜ï¼Œéœ€è¦è¾ƒä½å»¶è¿Ÿçš„åœºæ™¯ã€‚</p></blockquote><p>å…·ä½“åœºæ™¯é€‚åˆä»€ä¹ˆæ ·çš„åƒåœ¾æ”¶é›†å™¨ï¼Œåªæœ‰å°è¯•äº†æ‰çŸ¥é“ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ä»€ä¹ˆæ—¶å€™éƒ½èƒ½æœ‰è¯•çš„æœºä¼šï¼Œå› æ­¤æˆ‘ä»¬ä¸€èˆ¬æŒ‡å¯¼åŸåˆ™ï¼š</p><ul><li><strong>ç³»ç»Ÿç³»ç»Ÿååé‡ä¼˜å…ˆï¼ŒCPUèµ„æºèƒ½æœ€å¤§ç¨‹åº¦å¤„ç†ä¸šåŠ¡ï¼Œé€‰æ‹©ParallelGCã€‚</strong></li><li><strong>å¦‚æœç³»ç»Ÿä½å»¶è¿Ÿä¼˜å…ˆï¼Œæ¯æ¬¡GCæ—¶é—´å°½å¯èƒ½çŸ­ï¼Œä½†é…ç½®èµ„æºæœ‰é™ï¼Œé€‰æ‹©CMS GCã€‚</strong></li><li><strong>å¦‚æœç³»ç»Ÿå†…å­˜å¤§ï¼ŒåŒæ—¶è¿½æ±‚æ•´ä½“GCæ—¶é—´å¯æ§ï¼Œé€‰æ‹©G1ã€‚</strong></li></ul><p>å¯¹äºå†…å­˜å¤§å°çš„è€ƒé‡ï¼š</p><ul><li>4Gä»¥ä¸Šç®—æ¯”è¾ƒå¤§çš„ï¼ŒG1 æ€§ä»·æ¯”æ›´é«˜ã€‚</li><li>8Gä»¥ä¸Šï¼Œéå¸¸æ¨èG1ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åƒåœ¾æ”¶é›†å™¨ä¸Šç¯‡æˆ‘å†™äº†å°ä¸¤å‘¨ç»ˆäºæ˜¯æ•´ç†å®Œäº†ã€‚åœ¨æ¢³ç†ä¹‹å‰æˆ‘å¯¹CMSå’ŒG1å†…å¿ƒéƒ½æ˜¯å¾ˆæ•¬ç•çš„ï¼Œå› ä¸ºä¹‹å‰å¯¹ä»–ä»¬çš„åŸç†å’Œå®ç°çš„ç†è§£éƒ½æ˜¯ä¸€çŸ¥åŠè§£æ¨¡æ£±ä¸¤å¯çš„ã€‚åœ¨è¿™æ¬¡æ¢³ç†çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¹ŸèŠ±äº†å¾ˆå¤§çš„ç¯‡å¹…åœ¨ä»‹ç»è¯´æ˜CMSå’ŒG1çš„åŸç†ï¼Œæˆ‘æŸ¥äº†å¾ˆå¤šçš„èµ„æ–™å­¦ä¹ CMSå’ŒG1çš„åŸç†ä»¥åŠéƒ¨åˆ†å®ç°ç»†èŠ‚ï¼Œæ”¶è·éå¸¸å¤šã€‚å›åˆ°æ€»ç»“ä¸Šï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬ä»‹ç»äº†ç»å…¸çš„åƒåœ¾æ”¶é›†å™¨ï¼Œæˆ‘ä»¬å…ˆä»åŸºç¡€çš„ Serialï¼ˆSerial + Serial Oldï¼‰ä¸²è¡Œåƒåœ¾æ”¶é›†å™¨ï¼ŒParallelï¼ˆParallel Scavenge + Parallel Oldï¼‰å¹¶è¡Œåƒåœ¾æ”¶é›†å™¨å¼€å§‹ï¼Œä»‹ç»äº†ä»–ä»¬ç‰¹æ€§ã€ä¼˜ç¼ºç‚¹å’Œé€‚ç”¨çš„åœºæ™¯ã€‚å¼€èƒƒèœç»“æŸåï¼Œæˆ‘ä»¬å¼€å§‹æ¢³ç†CMSï¼Œå¯¹CMSçš„å›æ”¶è¿‡ç¨‹è¿›è¡Œäº†è¯¦ç»†çš„åˆ†æï¼Œä»–ä»¬åˆ†åˆ«æ˜¯åˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€å¹¶å‘é¢„å¤„ç†ã€å¯å–æ¶ˆçš„å¹¶å‘é¢„å¤„ç†ã€æœ€ç»ˆæ ‡è®°ã€å¹¶å‘æ¸…é™¤ã€å¹¶å‘é‡ç½®è¿™7ä¸ªæ­¥éª¤ï¼Œæ€»ç»“ç®€åŒ–ä¸‹æ¥4ä¸ªé˜¶æ®µåˆ†åˆ«æ˜¯åˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€æœ€ç»ˆæ ‡è®°ã€å¹¶å‘æ¸…ç†ã€‚æ·±å…¥ç†è§£CMSåƒåœ¾æ”¶é›†å™¨çš„å›æ”¶æµç¨‹ä¸ºG1çš„å›æ”¶æµç¨‹çš„æ¢³ç†æ‰“ä¸‹é“ºå«ã€‚æˆ‘ä»¬è¿˜ä»‹ç»äº†CMSçš„å‡ ä¸ªç¼ºç‚¹ï¼Œåˆ†åˆ«æ˜¯å¹¶å‘å¤„ç†å¯¹èµ„æºæ•æ„Ÿã€ä¼šäº§ç”Ÿæµ®åŠ¨åƒåœ¾ã€æ ‡è®°-æ¸…é™¤ç®—æ³•ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚æœ€åä¸€é“å¤§èœä»‹ç»äº†æˆ‘ä»¬çš„G1åƒåœ¾æ”¶é›†å™¨ï¼Œä»CMSçš„ç—›ç‚¹å…¥æ‰‹ï¼Œåˆ†ææ¢³ç†G1ä¸­çš„è§£å†³æ–¹æ¡ˆå’ŒG1çš„è®¾è®¡å°ç›®æ ‡â€”å»ºç«‹å¯é é¢„æµ‹æš‚åœæ¨¡å‹ã€‚éšåæˆ‘ä»¬é¡ºç€CMSçš„åƒåœ¾å›æ”¶æµç¨‹ï¼Œè¿‡äº†ä¸€éG1çš„åƒåœ¾æ”¶é›†æµç¨‹ï¼Œä¸éš¾å‘ç°ä¸¤è€…è®¾è®¡ä¸€è„‰ç›¸æ‰¿å¤§åŒå°å¼‚ã€‚ä½†æ˜¯æ¢³ç†äº†è¿™ä¹ˆå¤šâ€œå¤§â€çš„çŸ¥è¯†ç‚¹ï¼Œæ²¡æœ‰ç»†èŠ‚æ€»æ„Ÿè§‰å°‘äº†äº›ä»€ä¹ˆï¼Œéšåæˆ‘ä»¬æ¢³ç†äº†ä¸€ä¸ªç»†èŠ‚ï¼šå•ä¸ªRegionåƒåœ¾æ”¶é›†ä¸å†…å­˜åˆ†é…çš„å¹¶å‘ç­–ç•¥ï¼Œæ¥æ·±å…¥ç†è§£Regionçš„åƒåœ¾å›æ”¶è¿‡ç¨‹ã€‚åœ¨G1çš„æœ€åï¼Œæˆ‘ä»¬åˆ—å‡ºäº†G1å¸¸ç”¨çš„å‚æ•°ä»¥ä¾›å„ä½æœ‹å‹æŸ¥è¯¢é…ç½®ã€‚åœ¨æ¢³ç†å®Œç»å…¸åƒåœ¾æ”¶é›†å™¨ä¹‹åï¼Œæˆ‘ä»¬ç®€å•èŠäº†èŠGCçš„é€‰æ‹©ç­–ç•¥ï¼Œååé‡é€‰æ‹©Parallelï¼Œä½å»¶è¿Ÿä½†å†…å­˜ç©ºé—´æ²¡é‚£ä¹ˆå¤§CMSï¼Œå†…å­˜å¤§GCæ—¶é—´å¯æ§é€‰G1ã€‚è¿™é‡Œæ’ä¸€å˜´æˆ‘ä¸ªäººçš„çœ‹æ³•ï¼Œæˆ‘ä¸æ˜¯å¾ˆå–œæ¬¢CMSã€‚å®ƒæ˜¯å¯¹ä½å»¶è¿Ÿçš„åƒåœ¾æ”¶é›†å™¨çš„ä¸€æ¬¡æˆåŠŸå°è¯•è¿™ä¸å¯å¦è®¤ï¼Œä½†æ˜¯ç®—ä¸ä¸Šä¸€æ¬¾æˆåŠŸçš„åƒåœ¾å¤„ç†å™¨ã€‚ä½†æ˜¯æ¢ä¸€ä¸ªè§’åº¦æƒ³å¦‚æœæ²¡æœ‰CMSçš„å°è¯•ï¼Œåˆæ€ä¼šæœ‰åæ¥å¤§æˆè€…G1å‘¢ï¼ŸğŸ¤”  </p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰</li><li>å¸¸ç”¨åƒåœ¾æ”¶é›†å™¨çš„å…·ä½“å®ç°</li><li><a href="https://www.cnblogs.com/thisiswhy/p/12388638.html">é¢è¯•å®˜é—®æˆ‘G1å›æ”¶å™¨æ€ä¹ˆçŸ¥é“ä½ æ˜¯ä»€ä¹ˆæ—¶å€™çš„åƒåœ¾ï¼Ÿ</a></li><li><a href="https://blog.csdn.net/h2604396739/article/details/107957569">G1è¯¦è§£</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM GCç¯‡ â€” ä¸€èˆ¬åŸç†ä¸åƒåœ¾æ”¶é›†ç®—æ³•</title>
    <link href="/2021/06/01/gc-basic/"/>
    <url>/2021/06/01/gc-basic/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“ Java ç¨‹åºå‘˜ä¸ç”¨åƒ C++ ç¨‹åºå‘˜ä¸€æ ·æ‰‹åŠ¨ç”³è¯·å’Œé‡Šæ”¾å¯¹è±¡ç©ºé—´ï¼Œè¿™æ˜¯å› ä¸º JVM åƒåœ¾å›æ”¶å™¨çš„å­˜åœ¨ã€‚ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶å‘¢ï¼Ÿå› ä¸ºç©ºé—´æ˜¯æœ‰é™çš„ï¼Œè€Œæˆ‘ä»¬è¿è¡Œç¨‹åºå®Œæˆå„ç§å„æ ·çš„è®¡ç®—éœ€è¦ç”³è¯·ç©ºé—´ã€‚ä½†æ˜¯ç©ºé—´ä¸æ˜¯æ— é™çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„ç©ºé—´ä¸å¤Ÿç”³è¯·æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªæ—¶å€™å°±è¦é‡Šæ”¾å†…å­˜ï¼Œåˆ é™¤æ‰ä¸€äº›ä¸ç”¨çš„æ— æ•ˆçš„ç©ºé—´ï¼Œæ¥è…¾å‡ºç©ºé—´æ¥åˆ›å»ºæˆ‘ä»¬éœ€è¦çš„å¯¹è±¡ã€‚è¿™å°±åƒæˆ‘ä»¬çš„è¡£æŸœä¸€æ ·ï¼Œæˆ‘ä»¬ä¹°è¡£æœå›æ¥æ”¾åœ¨è¡£æŸœé‡Œé¢ï¼Œä½†æ˜¯è¡£æŸœä¸æ˜¯æ— é™å¤§çš„ï¼Œæ‰€ä»¥å½“è¡£æŸœæ”¾ä¸ä¸‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±è¦æ¸…ç†ä¸¢æ‰å°äº†çš„æˆ–è€…æˆ‘ä»¬ä¸ç©¿çš„è¡£æœï¼Œè¿™æ ·ä¸ºæ–°çš„è¡£æœè…¾å‡ºç©ºé—´ã€‚Java è‡ªå¸¦GCä¼šè‡ªåŠ¨æ¸…ç†å†…å­˜ç©ºé—´ï¼Œè€ŒC++è¿™ç§æ²¡æœ‰GCçš„è¯­è¨€ï¼Œå°±éœ€è¦ä½¿ç”¨æ‰‹åŠ¨æ¸…ç†ç©ºé—´äº†ã€‚å…¨è‡ªåŠ¨ä¸ç”¨ç¨‹åºå‘˜æ“å¿ƒçš„ç¡®å¾ˆå¥½ï¼Œå¦‚æœæ”¾ä»ä¸ç®¡ä¹Ÿä¼šå¼•èµ·å…¶ä»–çš„é—®é¢˜ï¼Œé‚£ä¹ˆæ€ä¹ˆæ¸…ç†èµ·æ¥æ‰æ˜¯æ­£ç¡®ä¸”é«˜æ•ˆã€‚è¿™å°±æ˜¯ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬å°†ä» GC çš„ä¸€èˆ¬åŸç†å’Œåƒåœ¾å›æ”¶ç®—æ³•å¼€å§‹ï¼Œé€æ­¥å±•å¼€ Java GC çš„ä¸–ç•Œã€‚</p><h2 id="GCä¸€èˆ¬åŸç†"><a href="#GCä¸€èˆ¬åŸç†" class="headerlink" title="GCä¸€èˆ¬åŸç†"></a>GCä¸€èˆ¬åŸç†</h2><h3 id="æ‰‹åŠ¨ç®¡ç†å†…å­˜"><a href="#æ‰‹åŠ¨ç®¡ç†å†…å­˜" class="headerlink" title="æ‰‹åŠ¨ç®¡ç†å†…å­˜"></a>æ‰‹åŠ¨ç®¡ç†å†…å­˜</h3><p>æœ‰C++ç¼–ç¨‹ç»éªŒæˆ–è€…äº†è§£è®¡ç®—æœºåŸç†çš„åŒå­¦å¾ˆå®¹æ˜“å°±èƒ½ç†è§£ï¼Œ<code>å†…å­˜åˆ†é…</code>å’Œ<code>å†…å­˜é‡Šæ”¾</code>ä¸¤ä¸ªæ¦‚å¿µï¼Œè®¡ç®—æœºç¨‹åºåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œéœ€è¦æœ‰åœ°æ–¹å­˜æ”¾è¾“å…¥å‚æ•°ã€ä¸­é—´å˜é‡ä»¥åŠè¿ç®—ç»“æœã€‚é€šè¿‡å‰é¢çš„å­¦ä¹ æˆ‘ä»¬çŸ¥é“ï¼Œè¿™äº›è¿è¡Œæ—¶æ•°æ®éƒ½æ”¾åœ¨å †æ ˆå†…å­˜ä¸­ï¼Œæ ˆä¸­çš„æ•°æ®çš„ç©ºé—´ä¼šéšç€æ ˆçš„åˆ›å»ºåˆ†é…ï¼Œéšç€æ ˆç©ºé—´é”€æ¯è€Œé‡Šæ”¾ã€‚ä½†æ˜¯å¦‚æœä¸šåŠ¡å¤„ç†ä»£ç ä¸­éœ€è¦ä½¿ç”¨åˆ°å †å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™å°±è¦æ³¨æ„äº†ã€‚å› ä¸ºç©ºé—´æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ä½¿ç”¨å®Œçš„ç©ºé—´è¦å³æ—¶é‡Šæ”¾è¿™æ ·æ‰ä¸ä¼šé€ æˆå†…å­˜æº¢å‡ºçš„é—®é¢˜ã€‚å› æ­¤C++ç¨‹åºå‘˜éœ€è¦æ‰‹åŠ¨è°ƒç”¨æ–¹æ³•å®Œæˆå†…å­˜ç©ºé—´çš„é‡Šæ”¾ã€‚è¿™ç§å†…å­˜ç®¡ç†æ–¹å¼æˆ‘ä»¬ç§°ä¸º<code>æ‰‹åŠ¨å†…å­˜ç®¡ç†</code>ã€‚</p><p>è¿™ç§ç®¡ç†æ–¹å¼çš„ä¼˜ç‚¹å°±æ˜¯<code>ç®€å•ä¸”é«˜æ•ˆ</code>ï¼Œå› ä¸ºç”¨å®Œçš„ç©ºé—´èƒ½è¢«ç«‹åˆ»é‡Šæ”¾ï¼Œç›´æ¥æé«˜å†…å­˜ç©ºé—´çš„ä½¿ç”¨ç‡ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯å¾ˆæ˜æ˜¾çš„ï¼Œå°±æ˜¯å¦‚æœä¸€æ—¦æ“ä½œçš„äººå¤šäº†ï¼Œå®¹æ˜“å‡ºç°æ“ä½œä¸ç»Ÿä¸€ï¼Œé€ æˆ<code>å†…å­˜èµ„æºæŠ¢å é”™è¯¯</code>æˆ–<code>å†…å­˜é”™è¯¯é‡Šæ”¾</code>çš„é—®é¢˜ã€‚å¹¶ä¸”å†…å­˜ç©ºé—´çš„ç®¡ç†éš¾åº¦æ˜¯éšç€æ“ä½œæ–¹æ•°é‡åœ°å¢åŠ è€Œç›´çº¿ä¸Šå‡ã€‚åœ¨å¤§å‹å¤æ‚çš„é¡¹ç›®ä¸­ï¼Œå¤šçº¿ç¨‹çš„å†…å­˜æ“ä½œæ˜¯ä¸é¿å…çš„ï¼Œå› æ­¤æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„å¼Šç«¯è¢«ä¸æ–­æ”¾å¤§ã€‚ å¼€å‘äººå‘˜å°±æƒ³ä¸ºä»€ä¹ˆä¸è®¾è®¡ä¸€ä¸ªåƒåœ¾å›æ”¶å™¨è‡ªåŠ¨çš„æ”¶é›†åƒåœ¾ï¼Œè¿™æ ·æ—¢å¯ä»¥<strong>å‡å°‘ç¨‹åºå‘˜ä»£ç é‡ï¼Œä¹Ÿå¯ä»¥å°½å¯èƒ½çš„é¿å…å†…å­˜æº¢å‡º</strong>ã€‚å› æ­¤GCé¡ºåŠ¿è€Œæ¥ï¼Œå…¶å®GCçš„å†å²æ¯” Java è¿˜è¦ä¹…è¿œï¼Œç¬¬ä¸€ä¸ªå¸¦æœ‰åŠ¨æ€åˆ†é…å’ŒGCçš„è¯­è¨€å¹¶ä¸æ˜¯Javaï¼Œ1960å¹´è¯ç”Ÿçš„Lispæ˜¯ç¬¬ä¸€é—¨ä½¿ç”¨å†…å­˜åŠ¨æ€åˆ†é…å’Œåƒåœ¾æ”¶é›†çš„ç¼–ç¨‹è¯­è¨€ã€‚</p><h3 id="å¯¹è±¡å·²æ­»ï¼Ÿ"><a href="#å¯¹è±¡å·²æ­»ï¼Ÿ" class="headerlink" title="å¯¹è±¡å·²æ­»ï¼Ÿ"></a>å¯¹è±¡å·²æ­»ï¼Ÿ</h3><h4 id="å¼•ç”¨è®¡æ•°æ³•"><a href="#å¼•ç”¨è®¡æ•°æ³•" class="headerlink" title="å¼•ç”¨è®¡æ•°æ³•"></a>å¼•ç”¨è®¡æ•°æ³•</h4><p>è¶Šæ˜¯çœ‹èµ·æ¥ç®€å•çš„ä¸œè¥¿ï¼Œè®¡ç®—æœºå®ç°èµ·æ¥è¶Šæ˜¯å¤æ‚ã€‚å°±æ¯”å¦‚è¿™ä¸ªä¾‹å­ï¼Œå¦‚æœåˆ¤æ–­ä¸€ä¸ªå¯¹è±¡å·²ç»æ­»äº¡äº†ã€‚å¼€å‘å°å“¥å“¥æƒ³åˆ°äº†ä¸€ä¸ªå¥½åŠæ³•ï¼Œè¿™ä¸ªå¯¹è±¡æˆ‘åˆ›å»ºçš„ä¸ç”¨äº†ä»–å°±æ­»äº¡äº†ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆæ”¾åœ¨GCä¸Šå¯è¡Œä¹ˆï¼ŸGCå¹¶ä¸çŸ¥é“ä¸€ä¸ªå¯¹è±¡ä»€ä¹ˆæ—¶å€™ä¸ä¼šåœ¨è¢«ä½¿ç”¨äº†ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œè¿™æˆä¸ºGCè®¾è®¡çš„ç¬¬ä¸€ä¸ªå›°éš¾ã€‚é‡åˆ°å›°éš¾ï¼Œæ­£é¢é¢å¯¹ã€‚ä»å¯¹è±¡çš„å¼•ç”¨å…³ç³»ä¸Šä¸‹æ‰‹æˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°ä¸€ä¸ªåŠæ³•ã€‚<strong>å…ˆåˆ›å»ºä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œå¦‚æœè¿™ä¸ªè¿™ä¸ªå¯¹è±¡æœ‰ä¸ªä¸€åœ°æ–¹å¼•ç”¨äº†æˆ‘ä»¬æŠŠå¼•ç”¨è®¡æ•°å™¨åŠ ä¸€ï¼Œå¦‚æœä¸å†å¼•ç”¨äº†å¼•ç”¨è®¡æ•°å™¨å‡ä¸€</strong>ã€‚å½“æŸä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨ä¸º0çš„æ—¶å€™å°±æ„å‘³ç€æ²¡æœ‰åœ°æ–¹å¼•ç”¨è¿™ä¸ªå¯¹è±¡ï¼Œå³å¯¹è±¡å·²ç»â€œæ­»äº¡â€äº†ï¼Œå¯ä»¥è¿›è¡Œåƒåœ¾å›æ”¶äº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210529164736.png"></p><p>ä½†æ˜¯è¿™ä¸ªçœ‹ä¼¼å¾ˆå®Œç¾çš„æ–¹æ¡ˆå­˜åœ¨å¼Šç«¯å˜›ï¼Ÿæ²¡é”™å°±æ˜¯<code>å¾ªç¯å¼•ç”¨</code>çš„é—®é¢˜ï¼Œä¸Šé¢è¿™ä¸ªå›¾æ˜¯ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œä½†æ˜¯å®é™…ä¸­æˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡å¼•ç”¨å…³ç³»å¯æ¯”è¿™ä¸ªå¤æ‚å¤šäº†ã€‚å¦‚æœå¯¹è±¡ä¹‹é—´çš„ç›¸äº’å¼•ç”¨ï¼Œå³ä¾¿å…¶ä»–å¼•ç”¨å…¨éƒ¨ç§»é™¤ã€‚å¼•ç”¨è®¡æ•°å™¨ä¾æ—§ä¸ä¸º0å¯¹è±¡ä¾æ—§æ— æ³•å›æ”¶ã€‚å¦‚ä¸‹å›¾å…¶å®å¯¹è±¡1å’Œå¯¹è±¡2å·²ç»æ²¡æœ‰å…¶ä»–çš„å¼•ç”¨äº†ï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªå¯¹è±¡ç›¸äº’ä¾èµ–å¯ä»¥ç›´æ¥è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œä½†æ˜¯å¯¹è±¡1å’Œå¯¹è±¡2çš„å¼•ç”¨ä¸ä¸º0ï¼Œåƒåœ¾å›æ”¶å™¨åˆ¤æ–­ä»–ä»¬è¿˜æ˜¯â€œå­˜æ´»â€çŠ¶æ€ï¼Œä»è€Œæ— æ³•å›æ”¶è¿™ä¸¤ä¸ªå¯¹è±¡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210529171629.png"></p><h4 id="å¯è¾¾æ€§åˆ†æç®—æ³•"><a href="#å¯è¾¾æ€§åˆ†æç®—æ³•" class="headerlink" title="å¯è¾¾æ€§åˆ†æç®—æ³•"></a>å¯è¾¾æ€§åˆ†æç®—æ³•</h4><p>å¼•ç”¨è®¡æ•°æ³•ï¼Œè™½ç„¶ä¹ä¸€çœ‹è¿˜ä¸é”™ä½†æ˜¯æœ‰ä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜<code>å¾ªç¯å¼•ç”¨</code>ï¼Œå› æ­¤åŸºäºå¼•ç”¨è®¡æ•°çš„æ–¹å¼å¹¶ä¸å‡†ç¡®ã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ä¸ªå‡†ç¡®ä¸”æ€§èƒ½ä¹Ÿä¸é”™çš„æ–¹æ³•æ¥åˆ¤æ–­å¯¹è±¡å­˜æ´»å‘¢ï¼ŸåŠæ³•ä¸æ˜¯çµå…‰ä¸€çº¿è¹¦å‡ºæ¥çš„ï¼Œæ˜¯åŸºäºç°å®çš„æƒ…å†µæ¨æ•²å‡ºæ¥çš„ã€‚æˆ‘ä»¬åœ¨å¼•ç”¨è®¡æ•°æ³•é‡åˆ°çš„é—®é¢˜æ˜¯å¾ªç¯å¼•ç”¨ã€‚é‚£æˆ‘ä»¬æ˜¯å¦å¯ä»¥ä»å¯¹è±¡é—´äº’ç›¸å¼•ç”¨çš„è§’åº¦æ¥æ€è€ƒæ˜¯å¦èƒ½åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚å¯è¾¾æ€§åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸€äº›åˆ— <code>GC Roots</code>çš„<strong>æ ¹å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹é›†åˆï¼Œä»è¿™äº›èµ·å§‹ç‚¹å¼€å§‹ï¼Œæ ¹æ®å¼•ç”¨å…³ç³»å‘ä¸‹æœç´¢ï¼Œæœç´¢è¿‡ç¨‹æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºâ€œå¼•ç”¨é“¾â€ï¼ˆReference Chainï¼‰ï¼Œå¦‚æœæŸäº›å¯¹è±¡ä¸å¯è¾¾ï¼Œåˆ™è¯æ˜æ¬¡å¯¹è±¡æ˜¯ä¸å¯èƒ½åœ¨è¢«ä½¿ç”¨çš„</strong>ã€‚é€šä¿—ç‚¹æ¥è¯´å°±æ˜¯é€šè¿‡ä»ä¸€ä¸ªå›ºå®šæ ¹èŠ‚ç‚¹ç„¶åéå†æ‰€æœ‰çš„å…³è”å¯¹è±¡çš„æ–¹å¼åˆ¤æ–­æŸä¸€ä¸ªå¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210530002244.png"></p><p>å…¶ä¸­GC Root åŒ…å«ä»¥ä¸‹å‡ ç§ï¼š</p><ul><li>åœ¨è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°æ–¹æ³•å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚</li><li>åœ¨æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ï¼Œè­¬å¦‚Javaç±»ä¸­å¼•ç”¨ç±»å‹é™æ€å˜é‡ã€‚</li><li>åœ¨æ–¹æ³•å»ä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ï¼Œè­¬å¦‚å­—ç¬¦ä¸²å¸¸é‡æ± ï¼ˆString tableï¼‰é‡Œçš„å¼•ç”¨ã€‚</li><li>åœ¨æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNIï¼ˆå³é€šå¸¸æ‰€è¯´çš„Nativeæ–¹æ³•ï¼‰å¼•ç”¨å¯¹è±¡ã€‚</li><li>Java è™šæ‹Ÿæœºå†…éƒ¨çš„å¼•ç”¨ï¼Œå¦‚åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„ Class å¯¹è±¡ï¼Œä¸€äº›å¸¸é©»çš„å¼‚å¸¸å¯¹è±¡ç­‰ï¼Œè¿˜æœ‰ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚</li><li>æ‰€æœ‰è¢«åŒæ­¥é”ï¼ˆsynchronzieå…³é”®å­—ï¼‰æŒæœ‰å¯¹è±¡ã€‚</li><li>åæ˜ Javaè™šæ‹Ÿæœºå†…éƒ¨æƒ…å†µçš„ JMXBeanï¼ŒJVMTTä¸­æ³¨å†Œçš„å›è°ƒã€æœ¬åœ°ä»£ç ç¼“å­˜ç­‰ã€‚</li></ul><p>é™¤äº†è¿™äº›å›ºå®šçš„ GC Roots é›†åˆä»¥å¤–ï¼Œ<strong>æ ¹æ®ç”¨æˆ·æ‰€é€‰ç”¨çš„åƒåœ¾æ”¶é›†å™¨ä»¥åŠå½“å‰å›æ”¶çš„å†…å­˜åŒºåŸŸä¸åŒï¼Œè¿˜å¯ä»¥æœ‰å…¶ä»–å¯¹è±¡â€œä¸´æ—¶æ€§â€åœ°åŠ å…¥</strong>ï¼Œå…±åŒæ„æˆå®Œæ•´ GC Roots é›†åˆã€‚</p><h4 id="å¼•ç”¨ä¸å¯¹è±¡ç”Ÿæ­»"><a href="#å¼•ç”¨ä¸å¯¹è±¡ç”Ÿæ­»" class="headerlink" title="å¼•ç”¨ä¸å¯¹è±¡ç”Ÿæ­»"></a>å¼•ç”¨ä¸å¯¹è±¡ç”Ÿæ­»</h4><p>æ— è®ºå‰é¢é€šè¿‡å¼•ç”¨è®¡æ•°æ³•åˆ¤æ–­å¯¹è±¡å¼•ç”¨æ•°é‡ï¼Œè¿˜æ˜¯é€šè¿‡å¯è¾¾æ€§åˆ†æç®—æ³•åˆ¤å¯¹è±¡æ˜¯å¦å¼•ç”¨é“¾å¯è¾¾æ¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Œè¿™éƒ½å’Œå¼•ç”¨ç¦»ä¸å¼€å…³ç³»ï¼Œåœ¨<code>JDK1.2</code>ä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå¼•ç”¨å®šä¹‰éå¸¸ä¼ ç»Ÿï¼Œ<strong>å¦‚æœreferenceç±»å‹çš„æ•°æ®ä¸­å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦å¤–ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¯¥ refrence æ•°æ®ä»£è¡¨æŸå—å†…å­˜ã€æŸä¸ªå¯¹è±¡çš„å¼•ç”¨ã€‚</strong>è¿™ç§å®šä¹‰å¹¶æ²¡æœ‰ä»€ä¹ˆä¸å¯¹ï¼Œä½†æ˜¯ç°åœ¨çœ‹è¿‡äºç‹­éš˜äº†ã€‚å¼•ç”¨çŠ¶æ€éé»‘å³ç™½ï¼Œå¯¹äºä¸€ä¸ªå¯¹è±¡çš„æè¿°åªæœ‰ä¸¤ç§çŠ¶æ€å³<code>è¢«å¼•ç”¨</code>å’Œ<code>æœªè¢«å¼•ç”¨</code>ã€‚å¦‚æœæ˜¯ä¸€ç§å¯¹è±¡åœ¨å†…å­˜å……è¶³çš„æ—¶å€™å¯ä»¥ä¿ç•™ï¼Œä½†æ˜¯åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™å¯ä»¥æŠ›å¼ƒçš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ç§å¼•ç”¨å°†å¾ˆéš¾æè¿°ï¼Œç³»ç»Ÿä¸­å¾ˆå¤šç¼“å­˜å¯¹è±¡éƒ½ç¬¦åˆè¿™ç§åœºæ™¯ã€‚å› æ­¤åœ¨<code>JDK1.2</code>ä¹‹åï¼ŒJavaå¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸º<code>å¼ºå¼•ç”¨ï¼ˆStrongly Refrenceï¼‰</code>ã€<code>è½¯å¼•ç”¨ï¼ˆSoft Refrenceï¼‰</code>ã€<code>å¼±å¼•ç”¨ï¼ˆWeek Refrenceï¼‰</code>ã€<code>è™šå¼•ç”¨ï¼ˆPhantom Refrenceï¼‰</code>ï¼Œè¿™å››ç§å¼•ç”¨å…³ç³»é€æ¸å‡å¼±ã€‚å¼•ç”¨çš„å®šä¹‰é€šè¿‡è¿™å››ç§æè¿°çš„è¡¥å……ï¼Œå››ç§å¼•ç”¨å…³ç³»å¯ä»¥æ›´å¥½çš„æè¿°å¼•ç”¨ï¼Œæ›´å¥½çš„ååŠ©åƒåœ¾å›æ”¶å™¨åˆ¤æ–­å¯¹è±¡å­˜æ´»çŠ¶æ€è¿›è¡Œåƒåœ¾å›æ”¶ã€‚å…¶ä¸­å¼•ç”¨ä¸GCåŠ¨ä½œçš„æè¿°å¦‚ä¸‹ï¼š</p><ul><li><code>å¼ºå¼•ç”¨</code>æ˜¯æœ€ä¼ ç»Ÿçš„â€œå¼•ç”¨â€çš„å®šä¹‰ï¼ŒæŒ‡åœ¨ç¨‹åºä»£ç ä¹‹ä¸­æ™®éå­˜åœ¨çš„å¼•ç”¨èµ‹å€¼ï¼Œ<strong>è¿™ç§å¼•ç”¨å…³ç³»ä¸‹çš„å¯¹è±¡æ— è®ºåœ¨ä»€ä¹ˆæƒ…å†µä¸‹éƒ½ä¸ä¼šè¢«åƒåœ¾å›æ”¶å™¨å›æ”¶ã€‚</strong></li><li><code>è½¯å¼•ç”¨</code>æ˜¯ç”¨æ¥æè¿°ä¸€äº›<code>è¿˜æœ‰ç”¨ï¼Œä½†éå¿…é¡»</code>çš„å¯¹è±¡ã€‚åªè¢«è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨ç³»ç»Ÿå‘ç”Ÿ<strong>å†…å­˜æº¢å‡ºä¹‹å‰ï¼Œä¼šæŠŠè¿™äº›å¯¹è±¡åˆ—å…¥åˆ°å›æ”¶èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶</strong>ã€‚å¦‚æœè¿™æ¬¡å›æ”¶è¿˜æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºOOMå¼‚å¸¸ï¼Œ<code>JDK1.2ç‰ˆæœ¬ä¹‹å</code>æä¾›<code>SoftRefrence</code>ç±»æ¥å®ç°è½¯å¼•ç”¨ã€‚ </li><li><code>å¼±å¼•ç”¨</code>ä¹Ÿæ˜¯ç”¨æ¥æè¿°é‚£äº›éå¿…é¡»å¯¹è±¡ï¼Œä½†æ˜¯ä»–çš„å¼ºåº¦æ¯”è½¯å¼•ç”¨è¦æ›´å¼±ä¸€äº›ã€‚<strong>è¢«è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½å­˜æ´»åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¸ºæ­¢ï¼Œä¸ç®¡å½“å‰å†…å­˜æ˜¯å¦è¶³å¤Ÿéƒ½ä¼šè¢«å›æ”¶ã€‚</strong> <code>JDK1.2</code>ç‰ˆæœ¬ä¹‹åæä¾›<code>WeekRefence</code>ç±»æ¥å®ç°å¼±å¼•ç”¨ã€‚</li><li><code>è™šå¼•ç”¨</code>ä¹Ÿç§°ä¸ºâ€œå¹½çµå¼•ç”¨â€å’Œâ€œå¹»å½±å¼•ç”¨â€ï¼Œå®ƒæ˜¯æœ€å¼±çš„ä¸€ç§å¼•ç”¨å…³ç³»ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æœ‰è™šå¼•ç”¨çš„å­˜åœ¨<strong>å®Œå…¨ä¸ä¼šå¯¹å…¶ç”Ÿå­˜æ—¶é—´æ„æˆå½±å“</strong>ï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–ä¸€ä¸ªå¯¹è±¡å®ä¾‹ã€‚ä¸ºä¸€ä¸ªå¯¹è±¡è®¾ç½®è™šæ‹Ÿå¼•ç”¨å…³è”çš„å”¯ä¸€ç›®çš„åªæ˜¯ä¸ºäº†<strong>èƒ½åœ¨è¿™ä¸ªå¯¹è±¡è¢«å›æ”¶æ—¶æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥</strong>ã€‚åœ¨<code>JDK1.2</code>ç‰ˆæœ¬ä¹‹åæä¾›äº†<code>PhantomRefrence</code>ç±»æ¥å®ç°è™šå¼•ç”¨ã€‚</li></ul><p>å¤šç§å¤šæ ·å¼•ç”¨å…³ç³»çš„è¡ç”Ÿå¾ˆåƒæˆ‘ä»¬å¹³æ—¶ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºæŸç§çŠ¶æ€çš„å±€é™æ€§ä»è€Œå¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚ä»åŸæœ¬çš„æœ€åŸºæœ¬çš„<code>è¢«å¼•ç”¨</code>ï¼Œæ‹“å±•ä¸º<code>å¼ºå¼•ç”¨</code>ã€<code>è½¯å¼•ç”¨</code>ã€<code>å¼±å¼•ç”¨</code>å’Œ<code>è™šå¼•ç”¨</code>å››ç§å½¢å¼ã€‚è¿™å››ç§å¼•ç”¨å½±å“åƒåœ¾å›æ”¶å™¨çš„è¡Œä¸ºï¼Œå¸®åŠ©å…¶é«˜æ•ˆåˆ¤æ–­å¹¶å›æ”¶åƒåœ¾ï¼Œä»è€Œæé«˜å†…å­˜ç©ºé—´çš„åˆ©ç”¨æ•ˆç‡ã€‚</p><table><thead><tr><th>å¼•ç”¨ç±»å‹</th><th>å¯¹åƒåœ¾å›æ”¶å™¨çš„å½±å“</th><th>å›æ”¶æ—¶æœº</th></tr></thead><tbody><tr><td>å¼ºå¼•ç”¨ï¼ˆstrongly refrenceï¼‰</td><td>æ— è®ºä»€ä¹ˆæƒ…å†µä¸‹éƒ½ä¸ä¼šè¿›è¡Œå›æ”¶</td><td>ä¸å›æ”¶</td></tr><tr><td>è½¯å¼•ç”¨ï¼ˆsoft refrenceï¼‰</td><td>å†…å­˜æº¢å‡ºä¹‹å‰ï¼Œä¼šæŠŠè¢«è¯¥å¼•ç”¨å¯¹è±¡ç±»å¦‚å›æ”¶èŒƒå›´</td><td>å†…å­˜æº¢å‡ºå‰å›æ”¶</td></tr><tr><td>å¼±å¼•ç”¨ï¼ˆweek refrenceï¼‰</td><td>è¢«å¼•ç”¨å¯¹è±¡å­˜æ´»åˆ°ä¸‹æ¬¡åƒåœ¾å›æ”¶ä¸ºæ­¢</td><td>ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶æ—¶å›æ”¶</td></tr><tr><td>è™šå¼•ç”¨ï¼ˆphantom refrenceï¼‰</td><td>å¯¹è¢«å¼•ç”¨å¯¹è±¡ç”Ÿå‘½å‘¨æœŸä¸äº§ç”Ÿå½±å“ï¼Œå¯¹è±¡è¢«å›æ”¶æ—¶æä¾›ç³»ç»Ÿé€šçŸ¥</td><td>æ— å…³è”</td></tr></tbody></table><p>å‰é¢æˆ‘ä»¬çœ‹è¿‡äº†å¯¹è±¡çš„å¼•ç”¨å…³ç³»å’Œå¼•ç”¨å…³ç³»å¯¹åƒåœ¾å›æ”¶å™¨çš„å½±å“ã€‚ç»†å¿ƒçš„æœ‹å‹åº”è¯¥å‘ç°äº†ä¸Šé¢çš„å¼•ç”¨å…³ç³»æ˜¯å¯è¾¾å¯¹è±¡ã€‚é‚£ä¸å¯è¾¾å¯¹è±¡æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿç›´æ¥å›æ”¶å—ï¼Ÿä¸æ˜¯çš„ã€‚ä¸å¯è¾¾å¯¹è±¡ä¼šå…ˆè¢«åˆ¤<code>â€œæ­»ç¼“â€</code>ï¼Œå¾…å›æ”¶å¯¹è±¡ä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡Œ<code>finalize()</code>æ–¹æ³•ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰é‡å†™finalize()æ–¹æ³•æˆ–è€…å·²ç»æ‰§è¡Œè¿‡finalize()æ–¹æ³•ï¼Œéƒ½ä¼šè§†ä¸º<code>ä¸éœ€è¦æ‰§è¡Œ</code>ã€‚å¦‚æœéœ€è¦æ‰§è¡Œï¼Œå¯¹è±¡ä¼šè¢«æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œä¾æ¬¡æ‰§è¡Œfinalize()æ–¹æ³•ã€‚åœ¨æ‰§è¡Œ finalize() æ–¹æ³•ï¼Œå¯¹è±¡è¿˜å¯ä»¥æŠ¢æ•‘ä¸‹è‡ªå·±ï¼Œ<strong>åªè¦é‡æ–°å’Œä»»ä½•ä¸€ä¸ªå¼•ç”¨æˆ–è€…å¯¹è±¡å»ºç«‹å…³è”ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°±ä¼šè¢«æˆåŠŸå¤æ´»</strong>ã€‚ä½†æ˜¯å¦‚æœåœ¨è¿™ä¸ªé˜¶æ®µæ²¡æœ‰â€œæˆåŠŸè‡ªæ•‘â€é‚£å°±çœŸçš„è¢«å›æ”¶äº†ã€‚å½“ç„¶æ²¡æœ‰ finalize() æ–¹æ³•ï¼Œé‚£å°±ä¼šè¢«ç›´æ¥è¢«å›æ”¶ã€‚finalize()çœ‹ä¼¼æ˜¯ä¸€ä¸ªå¾ˆæ£’çš„è®¾è®¡ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿä¼šäº§ç”Ÿå¾ˆå¤šçš„é—®é¢˜ã€‚å¯èƒ½ä¼šå› ä¸ºé˜Ÿåˆ—ä¸­å¯¹è±¡ä¸èƒ½å³æ—¶å¤„ç†é€ æˆå¯¹è±¡æ²¡æ³•å›æ”¶ä»è€Œé€ æˆOOMï¼Œç”šè‡³å¦‚æœ finalize() ä¸­æœ‰æ¶æ€§å¾ªç¯ï¼Œä¼šå¯¼è‡´æ•´ä¸ªå†…å­˜å›æ”¶å­ç³»ç»Ÿå´©æºƒã€‚<strong>finalize()æ–¹æ³•è‡ª JDK9 å¼€å§‹è¢«åºŸå¼ƒã€‚</strong></p><blockquote><p>æƒ³è¦æ·±å…¥ç†è§£ finalize æœºåˆ¶çš„å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼Œè™½ç„¶æ˜¯å…¨è‹±æ–‡çš„ä½†çœ‹èµ·æ¥å‹åŠ›å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§ <a href="https://plumbr.io/blog/garbage-collection/debugging-to-understand-finalizer">debugging-to-understand-finalizer</a></p></blockquote><h4 id="å¹¶å‘çš„å¯è¾¾æ€§åˆ†æ"><a href="#å¹¶å‘çš„å¯è¾¾æ€§åˆ†æ" class="headerlink" title="å¹¶å‘çš„å¯è¾¾æ€§åˆ†æ"></a>å¹¶å‘çš„å¯è¾¾æ€§åˆ†æ</h4><p>å¾ˆå¤šä¸œè¥¿æ²¾ä¸Šäº†å¹¶å‘ï¼Œäº‹æƒ…çš„å¤æ‚åº¦ä¹Ÿå°±ä¸Šå»äº†ä½†æ˜¯ä»”ç»†æ¢³ç†ä¸‹æ¥ä¹Ÿæ²¡é‚£ä¹ˆå¤æ‚ã€‚å¯è¾¾æ€§åˆ†æç®—æ³•ç†è®ºä¸Šè¦æ±‚å…¨è¿‡ç¨‹éƒ½æ˜¯åŸºäºèƒ½ä¿è¯ä¸€è‡´æ€§çš„å¿«ç…§ä¸­æ‰èƒ½è¿›è¡Œåˆ†æçš„ï¼Œè¿™æ ·å°±æ„å‘³ç€éœ€è¦STWï¼Œå†»ç»“æ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚åœ¨æšä¸¾æ ¹èŠ‚ç‚¹å› ä¸ºGC Roots æ˜¯æå°‘æ•°ï¼ŒSTWæ˜¯èƒ½æ¥å—çš„ã€‚è€Œå †æ•´ä¸ªå †è¿›è¡Œå¯è¾¾æ€§åˆ†ææ—¶ STWï¼Œå¯¹äºå¹¶å‘çš„åƒåœ¾æ”¶é›†å™¨æ¥è¯´æ˜¯ä¸èƒ½æ¥å—çš„ã€‚å› æ­¤å®ç°å¹¶å‘çš„å¯è¾¾æ€§åˆ†æè‡³å…³é‡è¦ã€‚å¯è¾¾æ€§ç®—æ³•å½’æ ¹åˆ°åº•å°±æ˜¯å›¾çš„éå†ï¼Œé‚£ä¹ˆè¿™ä¸ªé—®é¢˜å¯ä»¥è½¬åŒ–ä¸ºï¼Œ<strong>å¦‚æœåœ¨å¼•ç”¨å¤„äºå˜åŒ–çŠ¶æ€ä¸‹ï¼Œå®ŒæˆåŸºæœ¬å‡†ç¡®çš„éå†ã€‚</strong>ä¸ºä»€ä¹ˆæ˜¯åŸºæœ¬çš„å‘¢ï¼Ÿå› ä¸ºè¾¹æ˜¯å¤„äºå˜åŒ–çŠ¶æ€çš„ï¼ŒåŸºæœ¬ä¸å¯èƒ½æ ‡è®°å‡ºæ¥çš„ç»“æœç™¾åˆ†ç™¾å‡†ç¡®ã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œæˆ‘ä»¬è¦ä¿è¯ä¸€ä¸ªæœ€åŸºæœ¬çš„åŸåˆ™ï¼š<code>å¯ä»¥é”™æ ‡ï¼Œä½†æ˜¯ä¸èƒ½æ¼æ ‡è®°</code>ã€‚<strong>å¦‚æœé”™æ ‡ä¹Ÿå°±ä¼šäº§ç”Ÿä¸€äº›æµ®åŠ¨åƒåœ¾ï¼Œæ¼æ ‡å°±ä¼šå¯¼è‡´å¯¹è±¡æ¶ˆå¤±ä¼šå½±å“åº”ç”¨çº¿ç¨‹ã€‚</strong>é‚£æˆ‘ä»¬è¦æ€ä¹ˆåœ¨å¼•ç”¨å˜åŒ–çš„è¿‡ç¨‹ä¸­è¿›è¡ŒåŠ¨æ€æ ‡è®°å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬å¼•å…¥<code>ä¸‰è‰²æ ‡è®°ï¼ˆTri-color Markingï¼‰</code>ï¼Œåœ¨éå†å¯¹è±¡å›¾è¿‡ç¨‹ä¸­é‡åˆ°çš„å¯¹è±¡ï¼Œæˆ‘ä»¬æŒ‰ç…§<strong>â€œæ˜¯å¦è®¿é—®è¿‡â€</strong>è¿™ä¸ªæ¡ä»¶æ ‡è®°æˆä¸‹é¢ä¸‰ç§é¢œè‰²ã€‚</p><ul><li><strong>ç™½è‰²ï¼š</strong>è¡¨ç¤ºå°šæœªè¢«åƒåœ¾æ”¶é›†å™¨æ ‡è®¿é—®è¿‡ã€‚åœ¨æ ‡è®°å¼€å§‹æ—¶ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ç™½è‰²çš„ï¼Œ<strong>å½“æ ‡è®°ç»“æŸæ—¶ï¼Œå¦‚æœå¯¹è±¡è¿˜æ˜¯ç™½è‰²çš„é‚£è¡¨æ˜å¯¹è±¡ä¸å¯è¾¾</strong>ã€‚</li><li><strong>é»‘è‰²</strong>ï¼šè¡¨ç¤ºå¯¹è±¡å·²ç»è¢«åƒåœ¾æ”¶é›†å™¨è®¿é—®è¿‡ï¼Œå¹¶ä¸”æ¯ä¸ªè¿™ä¸ªå¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨éƒ½å·²ç»æ‰«æè¿‡äº†ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ˜¯é»‘è‰²çš„é‚£å®ƒå°±æ˜¯<strong>æœ‰æ•ˆçš„å¯è¾¾å¯¹è±¡ã€‚</strong>é»‘è‰²å¯¹è±¡ä¸å¯èƒ½ç›´æ¥æŒ‡å‘æŸä¸ªç™½è‰²å¯¹è±¡ã€‚æ‰€ä»¥é»‘è‰²å¯¹è±¡ä¸éœ€è¦é‡æ–°æ‰«æã€‚</li><li><strong>ç°è‰²ï¼š</strong>è¡¨ç¤ºå¯¹è±¡å·²ç»è¢«åƒåœ¾æ”¶é›†å™¨æ‰«æè¿‡ï¼Œä½†æ˜¯<strong>è‡³å°‘å­˜åœ¨ä¸€ä¸ªå¼•ç”¨è¿˜æ²¡æœ‰è¢«æ‰«æè¿‡ã€‚</strong></li></ul><p>åœ¨å¼•ç”¨å…³ç³»ä¸å˜åŒ–åº”ç”¨çº¿ç¨‹å†»ç»“çš„æƒ…å†µä¸‹ï¼Œæ•´ä¸ªå›¾éå†è¿‡ç¨‹ä¼šç”±å‡ ä¸ªç‚¹å¼€å§‹ï¼Œç„¶åå›¾ä¼šåƒæ°´æ³¢çº¹ä¸€æ ·å„ä¸ªèŠ‚ç‚¹ä»ç™½å˜æˆé»‘ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210607223934.png"></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210607223854.png"> </p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210607224130.png"></p><p>ä¸Šé¢è¿™å‡ å¼ å›¾æ˜¯åœ¨åº”ç”¨çº¿ç¨‹åœæ­¢çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ˜¯åœ¨å›æ”¶çº¿ç¨‹ä¸åº”ç”¨çº¿ç¨‹å¹¶å‘ï¼Œåº”ç”¨çº¿ç¨‹ä¸æ–­çš„ä¿®æ”¹å¼•ç”¨å…³ç³»çš„æƒ…å†µä¸‹ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿå°±åƒä¸Šé¢æˆ‘ä»¬æåˆ°çš„ï¼Œæˆ‘ä»¬å¯ä»¥å®¹å¿å°‘é‡çš„é”™æ ‡ï¼ˆ<strong>åŸæœ¬åº”è¯¥å›æ”¶çš„å¯¹è±¡ï¼Œä½†æ˜¯æ ‡è®°æˆäº†é»‘è‰²</strong>ï¼‰ä½†ä¸å¯ä»¥å®¹å¿æ¼æ ‡ï¼ˆ<strong>åŸæœ¬ä¸è¯¥è¢«å›æ”¶çš„å¯¹è±¡ï¼Œå› ä¸ºæ²¡æœ‰æ ‡è®°ä¸Šé»‘è‰²è€Œè¢«å›æ”¶</strong>ï¼‰ã€‚æ¥æˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ä¸‹é¢ä¸¤ä¸ªæ¼æ ‡çš„æƒ…å†µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210607230158.png"></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210607230554.png"></p><p>é€šè¿‡ä¸Šé¢çš„å›¾æˆ‘ä»¬ä¸éš¾å‘ç°ä¸¤ç§æƒ…å†µéƒ½æœ‰ä¸€ä¸ªç›¸åŒé—®é¢˜ï¼š<strong>åˆ é™¤äº†ç°è‰²å¯¹è±¡åˆ°æŸä¸ªç™½è‰²å¯¹è±¡ä¹‹é—´çš„æ‰€æœ‰å¼•ç”¨ï¼Œå¹¶ä¸”åŒæ—¶ä¸€ä¸ªæ ‡è®°è¿‡çš„é»‘è‰²å¯¹è±¡æŒ‡å‘äº†è¿™ä¸ªç™½è‰²æˆ–è€…è¿™ä¸ªç™½è‰²å¯¹è±¡æ‰€åœ¨é“¾ä¸Šçš„ç™½è‰²å¯¹è±¡</strong>ï¼Œå½’çº³ä¸‹æ¥å°±æ˜¯ä¸¤ä¸ªç›¸åŒçš„åŠ¨ä½œï¼š</p><ul><li><code>èµ‹å€¼å™¨æ’å…¥äº†ä¸€æ¡æˆ–å¤šæ¡ä»é»‘è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„æ–°å¼•ç”¨ã€‚</code></li><li><code>èµ‹å€¼å™¨åˆ é™¤äº†å…¨éƒ¨ä»ç°è‰²å¯¹è±¡åˆ°è¯¥ç™½è‰²å¯¹è±¡çš„ç›´æ¥æˆ–è€…é—´æ¥å¼•ç”¨ã€‚</code></li></ul><p>å½“è¿™ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æˆç«‹æ—¶å€™ï¼Œå°±ä¼šäº§ç”Ÿæ¶ˆå¤±å¯¹è±¡ã€‚æ‰€ä»¥åªè¦èƒ½ç ´åä¸¤ä¸ªå½“ä¸­çš„ä¸€ä¸ªæ¡ä»¶é—®é¢˜å°±è§£å†³äº†ã€‚é‚£è§£å†³æ–¹æ¡ˆæœ‰ä¸‹é¢ä¸¤ä¸ªï¼š</p><ol><li><code>å¢é‡æ›´æ–°ï¼ˆIncrement Updateï¼‰</code>ï¼šç ´åç¬¬ä¸€ä¸ªæ¡ä»¶ï¼Œå¦‚æœå‘ç°æœ‰ä»é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªè¿™ä¸ªå¼•ç”¨è®°å½•ä¸‹æ¥ï¼Œåœ¨æœ€åæ ‡è®°STWçš„æ—¶å€™ï¼Œä»¥é»‘è‰²å¯¹è±¡ä¸ºæ ¹é‡æ–°æ ‡è®°ä¸€éï¼Œ<strong>ç®€å•æ¥è¯´å°±æ˜¯ï¼Œé»‘è‰²å¯¹è±¡ä¸€æ—¦æ–°æ’å…¥äº†ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ä¸ªé»‘è‰²å¯¹è±¡å˜æˆç°è‰²ï¼Œæœ€ååœ¨éå†ä¸€æ¬¡ã€‚CMSé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚</strong></li><li><code>åŸå§‹å¿«ç…§ï¼ˆSnapshot At The Beginningï¼Œ SATBï¼‰</code>ï¼šç ´åç¬¬äºŒä¸ªæ¡ä»¶ï¼Œå¦‚æœå‘ç°ç°è‰²å¯¹è±¡åˆ é™¤æŒ‡å‘ç™½è‰²å¯¹è±¡çš„å¼•ç”¨ï¼Œå°±æŠŠè¿™ä¸ªå¼•ç”¨è®°å½•ä¸‹æ¥ï¼Œå¹¶ä¸”åœ¨æœ€åæ ‡è®°çš„æ—¶å€™ï¼Œä»¥å½“æ—¶çš„ç°è‰²å¯¹è±¡ä¸ºæ ¹ï¼ŒæŒ‰ç…§åŸæ¥çš„å¼•ç”¨å…³ç³»å†æ ‡è®°ä¸€æ¬¡ã€‚<strong>ç®€å•æ¥è¯´ï¼Œæ— è®ºå¼•ç”¨å…³ç³»æ˜¯å¦åˆ é™¤ï¼Œå°±æŒ‰ç…§åˆšå¼€å§‹æ‰«æé‚£ä¸€åˆ»çš„å¿«ç…§è¿›è¡Œéå†ï¼ŒG1 é‡‡ç”¨çš„æ˜¯è¿™ç§æ–¹å¼ã€‚</strong></li></ol><blockquote><p>æˆ‘ä¹‹å‰ä¸€ç›´åœ¨æ€è€ƒä¸€ä¸ªé—®é¢˜ï¼Œæ–°åˆ†é…æˆ–æ–°åˆ›å»ºçš„å¯¹è±¡æ€ä¹ˆåŠï¼ŸCMSä¸­åœ¨å¹¶å‘æ ‡è®°æ—¶å€™ï¼Œæ–°æ™‹å‡çš„å¯¹è±¡åˆšè¿›å…¥è€å¹´ä»£ä¸€å®šæ˜¯ç™½çš„ï¼Œè¿™æ€ä¹ˆå¤„ç†ï¼Ÿåæ¥æˆ‘å‘ç°åœ¨å¹¶å‘é¢„å¤„ç†ï¼ˆConcurrent percleanï¼‰é˜¶æ®µï¼Œä¼šæ ‡è®°ä¸€éæ™‹å‡å¯¹è±¡ã€‚G1 çš„è¯åˆ™é‡‡ç”¨TAMSï¼ˆTop at Mark Startï¼‰æŠ€æœ¯é»˜è®¤æ ‡è®°æ–°åˆ†é…çš„å¯¹è±¡ã€‚è¿™æ ·å°±ä¸ä¼šæ¼æ ‡æ–°å¯¹è±¡äº†ã€‚</p></blockquote><h2 id="åƒåœ¾æ”¶é›†ç®—æ³•"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•"></a>åƒåœ¾æ”¶é›†ç®—æ³•</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“æˆ‘ä»¬å¯¹è±¡å®ä¾‹æ˜¯åˆ†é…åœ¨å †ç©ºé—´ä¸­æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ï¼Œæˆ‘ä»¬ä¼šåœ¨åœ¨åˆ›å»ºå†…å­˜çš„æ—¶å€™éƒ½æ˜¯åœ¨å †ç©ºé—´ä¸Šåˆ†é…ä¸€ä¸ªå—å†…å­˜ã€‚ç”±äºå®é™…æƒ…å†µçš„ä¸åŒï¼Œæ¯ä¸ªå®ä¾‹å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½ä¸ä¸€æ ·ã€‚æœ‰çš„å¯¹è±¡å¯èƒ½åˆšåˆ†é…ä½¿ç”¨å®Œæˆå°±ä¼šè¢«å›æ”¶ï¼Œæœ‰çš„å¯èƒ½ä¼šå­˜åœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´ã€‚è¿™æ ·åƒåœ¾å›æ”¶å™¨å¤šæ¬¡å·¥ä½œä¸‹æ¥å†…å­˜ä¸­å¯èƒ½å­˜åœ¨å¤šä¸ªå†…å­˜é—´éš™è€Œå¯¼è‡´æ–°çš„å¯¹è±¡æ— æ³•ç»§ç»­åˆ†é…ã€‚è¿™æ˜æ˜¾ä¸èƒ½å……åˆ†åˆ©ç”¨æœ‰é™çš„å †å†…å­˜ç©ºé—´è£…å°½å¯èƒ½å¤šçš„å¯¹è±¡ã€‚å¦‚æœå°†ä¸€å—å®Œæ•´çš„å †å†…å­˜ç©ºé—´åˆ‡åˆ†æˆå¤šä¸ªé€»è¾‘ç©ºé—´ï¼Œæ¯ä¸ªç©ºé—´æ”¾ç”Ÿå‘½å‘¨æœŸä¸ä¸€æ ·çš„å¯¹è±¡ï¼Œåœ¨æ¯ä¸ªé€»è¾‘ç©ºé—´ä½¿ç”¨ä¸ä¸€æ ·çš„æ”¶é›†ç­–ç•¥æ˜¯å¦å°±èƒ½å°½å¯èƒ½çš„æé«˜ç©ºé—´çš„ä½¿ç”¨ç‡å‘¢ï¼Ÿå½“ç„¶æ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬ä¸€èµ·å¾€ä¸‹çœ‹ã€‚</p><h3 id="åˆ†ä»£æ”¶é›†ç†è®º"><a href="#åˆ†ä»£æ”¶é›†ç†è®º" class="headerlink" title="åˆ†ä»£æ”¶é›†ç†è®º"></a>åˆ†ä»£æ”¶é›†ç†è®º</h3><p>å½“å‰å•†ä¸šè™šæ‹Ÿæœºçš„åƒåœ¾æ”¶é›†å™¨ï¼Œå¤§å¤šæ•°éƒ½éµå¾ªäº†â€œåˆ†ä»£æ”¶é›†â€ï¼ˆGenerational Collectionï¼‰ çš„ç†è®ºè¿›è¡Œè®¾è®¡ï¼Œåˆ†ä»£æ”¶é›†è™½ç„¶æ˜¯ç†è®ºï¼Œä½†æ˜¯å®è´¨ä¸Šæ˜¯ä¸€å¥—ç¬¦åˆå¤§å¤šæ•°ç¨‹åºå®é™…è¿è¡Œæƒ…å†µçš„ç»éªŒæ³•åˆ™ï¼Œå®ƒå»ºç«‹åœ¨ä¸¤ä»£å‡è¯´çš„åŸºç¡€ä¹‹ä¸Šï¼š</p><ol><li>å¼±åˆ†ä»£å‡è¯´ï¼ˆWeek Generational Hyoothesisï¼‰ï¼šç»å¤§å¤šæ•°å¯¹è±¡é‚£ä¸ªéƒ½æ˜¯æœç”Ÿå¤•ç­çš„ã€‚</li><li>å¼ºåˆ†ä»£å‡è¯´ï¼ˆStrong Generational Hyoothesisï¼‰ï¼šç†¬è¿‡å¤šæ¬¡åƒåœ¾å›æ”¶è¿‡ç¨‹çš„å¯¹è±¡å°±è¶Šéš¾æ¶ˆäº¡ã€‚</li></ol><p>è¿™ä¸¤ä¸ªåˆ†ä»£å‡è¯´å…±åŒå¥ å®šäº†å¤šæ¬¾å¸¸ç”¨çš„åƒåœ¾å›æ”¶å™¨çš„ä¸€è‡´è®¾è®¡åŸåˆ™ï¼š<strong>æ”¶é›†å™¨åº”è¯¥å°† Java åˆ’åˆ†å‡ºä¸åŒçš„åŒºåŸŸï¼Œç„¶åå°†å›æ”¶å¯¹è±¡ä¾æ®å…¶å¹´é¾„ï¼ˆå³ç†¬è¿‡çš„åƒåœ¾å›æ”¶è¿‡ç¨‹çš„æ¬¡æ•°ï¼‰åˆ†é…åˆ°ä¸åŒçš„åŒºåŸŸä¹‹ä¸­å­˜å‚¨ã€‚</strong></p><h3 id="å†…å­˜åŒºåŸŸçš„åˆ’åˆ†"><a href="#å†…å­˜åŒºåŸŸçš„åˆ’åˆ†" class="headerlink" title="å†…å­˜åŒºåŸŸçš„åˆ’åˆ†"></a>å†…å­˜åŒºåŸŸçš„åˆ’åˆ†</h3><p>å†…å­˜çš„åˆ’åˆ†ä¹Ÿä¸æ˜¯ä¸€è¹´è€Œå°±çš„ä¹Ÿæ˜¯æ…¢æ…¢å‘å±•æ¥çš„ï¼Œåœ¨å‰é¢çš„ä»‹ç»Java å†…å­˜ç»“æ„çš„å°èŠ‚ä¸­æˆ‘ä»¬ä¹Ÿç®€å•çš„ä»‹ç»äº†å †ä¸­çš„é€»è¾‘åˆ’åˆ†ï¼Œè¿™é‡Œæˆ‘ä»¬å±•å¼€èŠèŠè¿™æ ·åˆ’åˆ†èƒŒåçš„è®¾è®¡ã€‚æ ¹æ®å‰é¢çš„åˆ†ä»£æ”¶é›†ç†è®ºå¯ä»¥æŒ‰ç…§å¯¹è±¡ç”Ÿå‘½å‘¨æœŸï¼Œå°†å †ç©ºé—´åˆ’åˆ†ä¸º<code>ç”Ÿå‘½å‘¨æœŸçŸ­</code>å’Œ<code>ç”Ÿå‘½å‘¨æœŸé•¿</code>çš„åŒºåŸŸå³<code>å¹´è½»ä»£</code>å’Œ<code>è€å¹´ä»£</code>ã€‚å…¶ä¸­ä¸ºäº†æ›´å¥½çš„æå‡åƒåœ¾å›æ”¶æ•ˆç‡<code>å¹´è½»ä»£</code>è¿˜åˆ’åˆ†ä¸º<code>ä¼Šç”¸åŒº</code> å’Œ <code>å­˜æ´»åŒº</code>ã€‚ä¸ºäº†é¿å…åœ¨åˆ†é…å†…å­˜ç©ºé—´æ—¶çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œä¼Šç”¸åŒºåŸŸä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€å°å—å†…å­˜ç©ºé—´ï¼Œç¡®ä¿åœ¨çº¿ç¨‹å¹¶å‘åˆ›å»ºå¯¹è±¡æ—¶ç©ºé—´ä¸Šçš„ç«äº‰è¿™å°±æ˜¯<code>TLAB</code>ï¼ˆThread Local Allocation Bufferï¼‰ã€‚å¤§è‡´çš„å†…å­˜åŒºåŸŸåˆ’åˆ†å›¾å¦‚ä¸‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210530222916.png"></p><h4 id="æ–°ç”Ÿä»£ï¼ˆEden-Spaceï¼‰"><a href="#æ–°ç”Ÿä»£ï¼ˆEden-Spaceï¼‰" class="headerlink" title="æ–°ç”Ÿä»£ï¼ˆEden Spaceï¼‰"></a>æ–°ç”Ÿä»£ï¼ˆEden Spaceï¼‰</h4><p>Eden Spaceï¼Œä¹Ÿå«åš<code>ä¼Šç”¸åŒº</code>ï¼Œæ˜¯å†…å­˜ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œç”¨æ¥åˆ†é…æ–°çš„å¯¹è±¡ï¼Œé€šå¸¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ Eden åŒºè¢«åˆ’åˆ†ä¸ºå¤šä¸ª<strong>çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒº</strong>ï¼ˆThread Local Allocation Buffer, ç®€ç§° TLABï¼‰ã€‚é€šè¿‡è¿™ç§ç¼“å†²åŒºåˆ’åˆ†ï¼Œå¤§éƒ¨åˆ†å¯¹è±¡ç›´æ¥ç”±JVMåœ¨å¯¹åº”çº¿ç¨‹çš„ TLAB ä¸­åˆ†é…ï¼Œé¿å…ä¸å…¶ä»–çº¿ç¨‹åŒæ­¥æ“ä½œã€‚å¦‚æœ TLAB ä¸­æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œå°±ä¼šåœ¨å…±äº« Eden åŒºï¼ˆShared Eden Spaceï¼‰ä¹‹ä¸­è¿›è¡Œåˆ†é…ã€‚å¦‚æœå…±äº«çš„ Eden åŒºï¼Œä¹Ÿæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œå°±ä¼šè§¦å‘ä¸€æ¬¡å¹´è½»ä»£çš„ GC æ¥é‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œå¦‚æœ GC ä¹‹å Eden åŒºä¾æ—§æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ç©ºé—´ï¼Œåˆ™å¯¹è±¡å°±ä¼šè¢«åˆ†é…åˆ°è€å¹´ä»£ç©ºé—´ï¼ˆOld Generationï¼‰ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210531211459.png"></p><p>å½“ Eden åŒºè¿›è¡Œåƒåœ¾å›æ”¶çš„æ—¶å€™ï¼ŒGC å°†ä» GC Roots å¼€å§‹æŠŠæ‰€æœ‰çš„å…³è”çš„å¯¹è±¡éƒ½è¿‡ä¸€éï¼Œå¹¶æ ‡è®°ä¸ºå­˜æ´»å¯¹è±¡ã€‚<strong>æ ‡è®°å®Œæˆåä¼šå°†æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡éƒ½ä¼šè¢«å¤åˆ¶åˆ°å­˜æ´»åŒºï¼ˆSurvivor spacesï¼‰</strong>ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥è®¤ä¸ºEdenåŒºåŸŸæ˜¯ç©ºçš„ï¼Œå°±å¯ä»¥é‡æ–°è¿›è¡Œå¯¹è±¡çš„åˆ†é…ï¼Œè¿™ä¸ªç®—æ³•å«åš<code>æ ‡è®°å¤åˆ¶ç®—æ³•</code>ï¼ˆMark and Copyï¼‰ã€‚</p><h4 id="å­˜æ´»åŒºï¼ˆSurvivor-spacesï¼‰"><a href="#å­˜æ´»åŒºï¼ˆSurvivor-spacesï¼‰" class="headerlink" title="å­˜æ´»åŒºï¼ˆSurvivor spacesï¼‰"></a>å­˜æ´»åŒºï¼ˆSurvivor spacesï¼‰</h4><p>EdenåŒºæ—è¾¹ä¸¤ä¸ªå°±æ˜¯å­˜æ´»åŒºï¼ˆSurvivor spaceï¼‰ï¼Œæˆä¸º <code>fromç©ºé—´</code>å’Œ <code>toç©ºé—´</code>ã€‚éœ€è¦ç€é‡å¼ºè°ƒçš„æ˜¯ä»»æ„ä¸€ä¸ªæ—¶åˆ»æ€»æœ‰ä¸€ä¸ªå­˜æ´»åŒºæ˜¯<code>ç©ºçš„ï¼ˆEmptyï¼‰éƒ½æ˜¯toç©ºé—´</code>ã€‚æ¯æ¬¡çš„å¹´è½»ä»£çš„ GC <strong>éƒ½ä¼šæŠŠfromåŒºä¸­çš„å­˜æ´»å¯¹è±¡å’ŒEdenåŒºä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°</strong><code>toåŒº</code>ä¸­ï¼Œfromå’Œtoè§’è‰²åˆ‡æ¢fromå˜æˆtoï¼Œtoå˜æˆfromã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210530235921.png"></p><p>å­˜æ´»çš„å¯¹è±¡ä¼šåœ¨å­˜æ´»åŒºä¸­æ¥å›å¤åˆ¶ã€‚<strong>å¤åˆ¶ä¸€æ¬¡å¯¹è±¡å­˜æ´»å¹´é¾„+1</strong>ï¼ŒæŒ‰ç…§å¼ºåˆ†ä»£å‡è®¾ï¼Œå­˜æ´»è¶…è¿‡ä¸€å®šæ—¶é—´çš„å¯¹è±¡å¾ˆå¯èƒ½ä¼šå­˜æ´»æ›´é•¿æ—¶é—´ã€‚è¿™ç±»å¯¹è±¡å½“å­˜æ´»å¹´é¾„è¶…è¿‡<code>å½“ï¦é¾„è¶…è¿‡æå‡é˜ˆå€¼(tenuring threshold)</code>ï¼Œå°±ä¼šè¢«<code>æå‡ï¼ˆPromotionï¼‰</code>è‡³è€å¹´ä»£åŒºåŸŸã€‚å½“ç„¶è¿™ä¸ªé˜ˆå€¼å‚æ•°æ˜¯å¯ä»¥è°ƒæ•´çš„ï¼Œå¯ä»¥é€šè¿‡å‚æ•° <code>-XX:+MaxTenuringThreshold</code> æ¥æŒ‡å®šä¸Šé™ã€‚å¦‚æœè®¾ç½® <code>-XX:+MaxTenuringThreshold=0</code>ï¼Œå¯¹è±¡ä¸ä¼šåœ¨å­˜æ´»åŒºä¹‹é—´å¤åˆ¶ä¼šç›´æ¥æå‡åˆ°è€å¹´ä»£ã€‚JVM ä¸­è¿™ä¸ªé˜ˆå€¼çš„é»˜è®¤å€¼æ˜¯<code>15ä¸ªGCå‘¨æœŸ</code>ï¼Œå¦‚æœå­˜æ´»åŒºç©ºé—´ä¸å¤Ÿå­˜æ”¾å¯¹è±¡ï¼Œ<code>æå‡ï¼ˆPromotionï¼‰</code>ä¹Ÿå¯èƒ½æ›´æ—©åœ°æ‰§è¡Œã€‚å…¶ä¸­<strong>å­˜æ´»åŒºå’ŒEdenåŒºçš„é»˜è®¤æ¯”ä¾‹æ˜¯ 1 : 1 : 8 ã€‚</strong></p><h4 id="è€å¹´ä»£ï¼ˆOld-Genï¼‰"><a href="#è€å¹´ä»£ï¼ˆOld-Genï¼‰" class="headerlink" title="è€å¹´ä»£ï¼ˆOld Genï¼‰"></a>è€å¹´ä»£ï¼ˆOld Genï¼‰</h4><p>è€å¹´ä»£çš„GCå®ç°è¦å¤æ‚å¾—å¤šã€‚<strong>è€å¹´ä»£çš„å†…å­˜ç©ºé—´é€šå¸¸ä¼šæ›´å¤§ï¼Œé‡Œé¢çš„äº§ç”Ÿåƒåœ¾å¯¹è±¡çš„æ¦‚ç‡ä¹Ÿæ›´å°ï¼Œè€å¹´ä»£GCå‘ç”Ÿçš„é¢‘ç‡æ¯”å¹´è½»ä»£å°å¾ˆå¤š</strong>ã€‚åŒæ—¶ï¼Œå› ä¸ºé¢„æœŸè€å¹´ä»£çš„å¯¹è±¡å¤§éƒ¨åˆ†éƒ½æ˜¯å­˜æ´»çš„ï¼Œæ‰€ä»¥ä¸å†ä½¿ç”¨æ ‡è®°å’Œå¤åˆ¶ï¼ˆMark and Copyï¼‰ç®—æ³•ã€‚è€Œæ˜¯é‡‡ç”¨ç§»åŠ¨å¯¹è±¡çš„æ–¹å¼æ¥å®ç°æœ€å°å†…å­˜ç¢ç‰‡ã€‚è€å¹´ä»£ç©ºé—´çš„æ¸…ç†ç®—æ³•é€šå¸¸æ˜¯å»ºç«‹åœ¨ä¸åŒçš„åŸºç¡€ä¸Šçš„ã€‚åŸåˆ™ä¸Šæ‰§è¡Œä»¥ä¸‹è¿™äº›æ­¥éª¤ï¼š</p><ul><li>é€šè¿‡æ ‡å¿—ä½ï¼ˆmarked bitï¼‰ï¼Œæ ‡è®°æ‰€æœ‰é€šè¿‡ GC Roots å¯è¾¾å¯¹è±¡ï¼›</li><li>åˆ é™¤ä¸å¯è¾¾å¯¹è±¡ï¼›</li><li>æ•´ç†è€å¹´ä»£ç©ºé—´ä¸­çš„å†…å®¹ï¼Œæ–¹æ³•æ˜¯æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å¤åˆ¶ï¼Œä»è€å¹´ä»£ç©ºé—´å¼€å§‹çš„åœ°æ–¹ä¾æ¬¡å­˜æ”¾ã€‚</li></ul><p>é€šè¿‡ä¸Šé¢çš„æè¿°å¯çŸ¥ï¼Œ<strong>è€å¹´ä»£GCå¿…é¡»æ˜ç¡®åœ°è¿›è¡Œæ•´ç†ï¼Œä»¥é¿å…å†…å­˜ç¢ç‰‡è¿‡å¤š</strong>ã€‚è¿™ä¹Ÿæ˜¯<code>æ ‡è®°æ•´ç†ç®—æ³•</code>ã€‚</p><h4 id="æ°¸ä¹…ä»£ï¼ˆPerm-Genï¼‰"><a href="#æ°¸ä¹…ä»£ï¼ˆPerm-Genï¼‰" class="headerlink" title="æ°¸ä¹…ä»£ï¼ˆPerm Genï¼‰"></a>æ°¸ä¹…ä»£ï¼ˆPerm Genï¼‰</h4><p>åœ¨ Java8 ä¹‹å‰æœ‰ä¸€ä¸ªå¾ˆç‰¹æ®Šçš„ç©ºé—´ï¼Œç§°ä¸ºâ€œæ°¸ä¹…ä»£â€ï¼ˆPermanent Generationï¼‰ã€‚è¿™é‡Œå­˜å‚¨æ•°æ®ï¼ˆmetadataï¼‰çš„åœ°æ–¹ï¼Œæ¯”å¦‚ class ä¿¡æ¯ç­‰ã€‚æ­¤å¤–ï¼Œè¿™ä¸ªåŒºåŸŸä¸­ä¹Ÿä¿å­˜æœ‰å…¶ä»–çš„æ•°æ®å’Œä¿¡æ¯ã€‚åŒ…æ‹¬å†…éƒ¨åŒ–çš„å­—ç¬¦ä¸²ï¼ˆinternalized stringsï¼‰ç­‰ç­‰ã€‚å®é™…ä¸Šè¿™å—å†…å­˜åŒºåŸŸç»™å¼€å‘è¿™é€ æˆå¾ˆå¤šçš„éº»çƒ¦ï¼Œå› ä¸º<strong>å¾ˆéš¾å»è®¡ç®—è¿™å—åŒºåŸŸåˆ°åº•éœ€è¦å ç”¨å¤šå°‘çš„ç©ºé—´</strong>ï¼Œé¢„æµ‹å¤±è´¥çš„ç»“æœå°±æ˜¯äº§ç”Ÿ<code>java.lang.OutOfMemoryError: Permgen space</code> è¿™ç§å½¢å¼çš„é”™è¯¯ã€‚é™¤é<code>OutOfMemoryError</code> ç¡®å®æ˜¯å†…å­˜æ³„æ¼å¯¼è‡´çš„ï¼Œå¦åˆ™åªèƒ½å¢åŠ  permgen çš„å¤§å°ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">-XX:MaxPermSize=<span class="hljs-number">256</span>m <span class="hljs-regexp">//</span>permGen å¤§å°è®¾ç½®ä¸º<span class="hljs-number">256</span>mï¼Œå®¹æ˜“å‘ç”Ÿoom<br></code></pre></td></tr></table></figure><h4 id="å…ƒæ•°æ®åŒºï¼ˆMataSpaceï¼‰"><a href="#å…ƒæ•°æ®åŒºï¼ˆMataSpaceï¼‰" class="headerlink" title="å…ƒæ•°æ®åŒºï¼ˆMataSpaceï¼‰"></a>å…ƒæ•°æ®åŒºï¼ˆMataSpaceï¼‰</h4><p>æ—¢ç„¶ä¼°ç®—PermGenéœ€è¦çš„ç©ºé—´é‚£ä¹ˆå¤æ‚ï¼ŒJava8ä¸­ç´¢æ€§ç›´æ¥åˆ é™¤äº†æ°¸ä¹…ä»£ï¼ˆPermanent Generationï¼‰æ”¹ç”¨<code>MetaSpace</code>ä»–ä¿©æœ¬è´¨ä¸Šè¿˜æ˜¯ç›¸åŒçš„ã€‚ä»æ­¤ä»¥åï¼ŒJava ä¸­å¾ˆå¤šæ‚ä¸ƒæ‚å…«çš„ä¸œè¥¿éƒ½æ”¾åœ¨æ™®é€šçš„å †å†…å­˜ä¸­ã€‚å½“ç„¶ï¼Œåƒç±»å®šä¹‰ï¼ˆclass definitionsï¼‰ä¹‹ç±»çš„ä¿¡æ¯è¿˜æ˜¯ä¼šè¢«åŠ è½½åˆ° MetaSpace ä¸­ã€‚<strong>å…ƒæ•°æ®åŒºåŸŸä½äºæœ¬åœ°å†…å­˜ï¼ˆnative memoryï¼‰</strong>ï¼Œä¸å†å½±å“åˆ°æ™®é€šçš„Javaå¯¹è±¡ã€‚<code>é»˜è®¤æƒ…å†µä¸‹ï¼ŒMetaSpace çš„å¤§å°åªå—é™äº Java è¿›ç¨‹å¯ç”¨çš„æœ¬åœ°å†…å­˜ã€‚</code>è¿™æ ·çš„è¯å°±é¿å…äº† PermGen å› ä¸ºé¢„æµ‹ä¸å‡†ç¡®è€ŒOOMçš„å°´å°¬äº†ã€‚ä½†æ˜¯è‡ªç”±ä¹Ÿä¸æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œå¦‚æœ MetaSpace æ— é™æ‰©å¼ å¤±æ§ï¼Œåˆ™å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„ç¨‹åºæ€§èƒ½é—®é¢˜ï¼Œæˆ–è€…å¯¼è‡´æœ¬åœ°å†…å­˜åˆ†é…å¤±è´¥ã€‚ä¸ºäº†é¿å…è¿™ç§äº‹çš„å‘ç”Ÿæˆ‘ä»¬è¿˜æ˜¯è¦é™åˆ¶ MetaSpace çš„å¤§å°ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼é™åˆ¶å…¶å¤§å°ã€‚</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">-XX:MaxMetaspaceSize=<span class="hljs-number">512</span>m <span class="hljs-regexp">//</span> è®¾ç½®metaSpaceç©ºé—´å¤§å°ä¸º<span class="hljs-number">512</span>m<br></code></pre></td></tr></table></figure><h3 id="åƒåœ¾æ”¶é›†ç®—æ³•è®¾è®¡ä¸åº”ç”¨"><a href="#åƒåœ¾æ”¶é›†ç®—æ³•è®¾è®¡ä¸åº”ç”¨" class="headerlink" title="åƒåœ¾æ”¶é›†ç®—æ³•è®¾è®¡ä¸åº”ç”¨"></a>åƒåœ¾æ”¶é›†ç®—æ³•è®¾è®¡ä¸åº”ç”¨</h3><p>å‰é¢è®²äº†å¾ˆå¤šçš„ä¸œè¥¿éƒ½æ˜¯é“ºå«ï¼Œä½†æ˜¯ç©ºä¸­æ¥¼é˜ä¸å¯èƒ½è…¾ç©ºè€Œèµ·ï¼Œæ²¡æœ‰ç»¿å¶åˆå“ªæ¥é²œèŠ±ã€‚æˆ‘ä»¬æ¥ä¸€èµ·é¸Ÿç°å…¨å±€ä½“ä¼šåƒåœ¾å›æ”¶ç®—æ³•åœ¨è®¾è®¡çš„ç²¾å¦™ä¹‹å¤„ã€‚æˆ‘ä»¬é€šè¿‡å‰é¢çš„æ¢³ç†ï¼Œæˆ‘ä»¬å¯¹å †ç©ºé—´è¿›è¡Œäº†é€»è¾‘ä¸Šçš„åˆ’åˆ†ï¼Œåˆ†æˆäº†<code>å¹´è½»ä»£</code>å’Œ<code>è€å¹´ä»£</code>ï¼Œè€Œå¹´è½»ä»£å­˜æ”¾çš„éƒ½æ˜¯æœç”Ÿå¤•æ­»çš„å¯¹è±¡ã€‚è€å¹´ä»£åˆ™å­˜æ”¾ä¸€äº›ä¸å®¹æ˜“è¢«æ¸…ç†æ‰ç”Ÿå‘½å‘¨æœŸé•¿çš„å¯¹è±¡ã€‚å¹´è½»ä»£åˆæœ‰ä¸¤ä¸ªå¹¸å­˜åŒºé…åˆåƒåœ¾å›æ”¶ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“äº†æˆ‘ä»¬å†…å­˜å¸ƒå±€äº†ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯•ç€è¿›è¡Œåƒåœ¾å›æ”¶ã€‚é¦–å…ˆæˆ‘ä»¬è¦æ ‡è®°å‡ºå·²ç»â€œæ­»äº¡â€çš„å¯¹è±¡ï¼Œé€šè¿‡å¯è¾¾æ€§ç®—æ³•åˆ†ææˆ‘ä»¬å¾ˆæ¸…æ¥šæ ‡è®°å‡ºæ¥çš„å°±æ˜¯ä¸å¯è¾¾çš„å¯¹è±¡ã€‚å¹´è½»ä»£å’Œè€å¹´ä»£æ ¹æ®æˆ‘ä»¬æ¸…ç†ç›®æ ‡ç©ºé—´çš„éœ€è¦è¿›è¡Œæ ‡è®°ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210530223844.png"></p><p>è¿™ä¸ªæ ‡è®°çš„è¿‡ç¨‹ä¸­ï¼Œå³éœ€è¦æš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ä»¥éå†æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨å…³ç³»ï¼Œå› ä¸ºæˆ‘ä»¬æ— æ³•è¿½è¸ªä¸æ–­å‘ç”Ÿå˜åŒ–çš„å¼•ç”¨å…³ç³»ã€‚ç­‰ç¡®å®šè¿™äº›å¼•ç”¨å…³ç³»åï¼Œåº”ç”¨çº¿ç¨‹åˆèƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™ä¸ªæš‚åœçš„è¿‡ç¨‹å«åš<code>Stop The World pauseï¼ˆå…¨çº¿ç¨‹æš‚åœï¼‰</code>ï¼Œç®€ç§°ä¸º<code>STW</code>ã€‚çº¿ç¨‹ä¹Ÿä¸å¯èƒ½åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çªç„¶åœä¸‹æ¥ï¼Œè€Œæ˜¯éœ€è¦è¿è¡Œå¯ä»¥å®‰å…¨åœä¸‹æ¥çš„ç‚¹ï¼Œè¿™äº›å¯ä»¥åœä¸‹æ¥çš„åœ°æ–¹å«åš<code>å®‰å…¨ç‚¹ï¼ˆsafe pointï¼‰</code>ï¼Œç„¶åæ ‡è®°å®Œæˆå JVM å°±å¯ä»¥å®‰å¿ƒå¤„ç†åƒåœ¾äº†ã€‚</p><p>è¿™é‡Œæœ‰ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼š<strong>å¦‚æœä¸€ä¸ªæ–°ç”Ÿä»£çš„å¯¹è±¡æœ‰ä¸”åªè¢«ä¸€ä¸ªè€å¹´ä»£çš„å¯¹è±¡å¼•ç”¨ï¼Œæˆ‘ä»¬åœ¨å¹´è½»ä»£è¿›è¡ŒGCæ—¶ï¼Œæˆ‘ä»¬è¯¥æ€ä¹ˆåˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å­˜æ´»çš„ï¼Ÿ</strong></p><p>å¦‚æœæˆ‘ä»¬ä»…ä»…æ‰«æå¹´è½»ä»£ï¼Œè¿™ä¸ªå¯¹è±¡ä¸€å®šæ˜¯ä¸€ä¸ªä¸å¯è¾¾å¯¹è±¡ï¼Œå› ä¸ºå®ƒè¢«æœ‰ä¸”ä»…è¢«ä¸€ä¸ªè€å¹´ä»£å¯¹è±¡å¼•ç”¨ã€‚éš¾é“æˆ‘ä»¬è¿›è¡Œä¸€æ¬¡å¹´è½»ä»£GCè¿è€å¹´ä»£ä¹Ÿè¦æ‰«ä¸€éï¼Ÿå¦‚æœæ‰«ï¼Œæ—¶é—´æ¶ˆè€—å¤ªå¤§ï¼Œä¸æ‰«ï¼Œä¸€å®šä¼šå‡ºç°è¿™ç§è¯¯åˆ¤çš„æƒ…å†µã€‚é‚£è¯¥æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>æ‰¾è„å¡</code>çš„æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ä»€ä¹ˆæ˜¯è„å¡ï¼Ÿè¿™æ˜¯ HotSpot ä¸­ä¸€é¡¹å«å¡è¡¨ï¼ˆcard tableï¼‰çš„æŠ€æœ¯ä¸­çš„ä¸€ä¸ªåè¯ã€‚è¯¥æŠ€æœ¯<strong>å°†æ•´ä¸ªå †åˆ’åˆ†ä¸ºä¸€ä¸ªä¸ªå¤§å°ä¸º 512 å­—èŠ‚çš„å¡</strong>ï¼Œå¹¶ä¸”ç»´æŠ¤ä¸€ä¸ªå¡è¡¨ï¼Œç”¨æ¥å­˜å‚¨æ¯å¼ å¡çš„ä¸€ä¸ªæ ‡è¯†ä½ã€‚è¿™ä¸ªæ ‡è¯†ä½ä»£è¡¨å¯¹åº”çš„å¡<strong>æ˜¯å¦å¯èƒ½å­˜æœ‰æŒ‡å‘æ–°ç”Ÿä»£å¯¹è±¡çš„å¼•ç”¨</strong>ã€‚å¦‚æœå¯èƒ½å­˜åœ¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è®¤ä¸ºè¿™å¼ å¡æ˜¯<strong>è„</strong>çš„<strong>ã€‚åœ¨è¿›è¡Œå¹´è½»ä»£GCçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¾¿å¯ä»¥</strong>ä¸ç”¨æ‰«ææ•´ä¸ªè€å¹´ä»£ï¼Œè€Œæ˜¯åœ¨å¡è¡¨ä¸­å¯»æ‰¾è„å¡<strong>ï¼Œå¹¶å°†è„å¡ä¸­çš„å¯¹è±¡åŠ å…¥åˆ°å¹´è½»ä»£GCçš„ GC Roots é‡Œ</strong>ã€‚<strong>å½“å®Œæˆæ‰€æœ‰</strong>è„å¡çš„æ‰«æä¹‹å<strong>ï¼ŒJava è™šæ‹Ÿæœºä¾¿ä¼šå°†æ‰€æœ‰è„å¡çš„æ ‡è¯†ä½æ¸…é›¶</strong>ã€‚ç”±äºå¹´è½»ä»£GCä¼´éšç€å­˜æ´»å¯¹è±¡çš„å¤åˆ¶ï¼Œè€Œå¤åˆ¶éœ€è¦æ›´æ–°æŒ‡å‘è¯¥å¯¹è±¡çš„å¼•ç”¨ã€‚å› æ­¤ï¼Œ<strong>åœ¨æ›´æ–°å¼•ç”¨çš„åŒæ—¶ï¼Œæˆ‘ä»¬åˆä¼šè®¾ç½®å¼•ç”¨æ‰€åœ¨çš„å¡çš„æ ‡è¯†ä½</strong>ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿è„å¡ä¸­å¿…å®šåŒ…å«æŒ‡å‘æ–°ç”Ÿä»£å¯¹è±¡çš„å¼•ç”¨ã€‚</p><blockquote><p>è„å¡æ˜¯åŒ…å«æŒ‡å‘æ–°ç”Ÿä»£å¼•ç”¨çš„å¡ï¼Œå¹´è½»ä»£GCï¼Œä¸æ‰«æè€å¹´ä»£è€Œæ˜¯å¯»æ‰¾è„å¡å¹¶åŠ å…¥åˆ°å¹´è½»ä»£GC Rootsä¸­ï¼Œæ‰«æå®Œè„å¡åè¡¨ç¤ºä½å³è„å¡å»è„ï¼Œå¤åˆ¶ç®—æ³•åå­˜æ´»å¯¹è±¡åœ°å€å˜åŒ–ï¼Œé‡æ–°è€å¹´ä»£ä¸­å¼•ç”¨å˜åŒ–æ˜¯åŒæ—¶è®¾ç½®è„å¡æ ‡å¿—ã€‚è¿™ä¸ªè¿‡ç¨‹éšç€GCå‘¨æœŸä¸æ–­å¾ªç¯ä¸‹å»ã€‚</p></blockquote><h4 id="æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-and-Sweepï¼‰"><a href="#æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark-and-Sweepï¼‰" class="headerlink" title="æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark and Sweepï¼‰"></a>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark and Sweepï¼‰</h4><p>æ ‡è®°å®Œæˆåæˆ‘ä»¬è¿›è¡Œç®€å•çš„æ¸…ç†å¯ä»¥å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„å›¾ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210531231800.png"></p><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢å›¾ä¸­ï¼Œåœ¨ä¸€æ®µè¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œæˆ‘ä»¬ä¾æ¬¡æœ‰<code>obj1åˆ°obj6</code>è¿™6ä¸ªå¯¹è±¡ã€‚è¿™6ä¸ªå¯¹è±¡ä¹‹é—´ä¸ä¸€å®šæ˜¯ç´§ç´§é åœ¨ä¸€èµ·çš„ï¼Œè€Œæ˜¯éƒ¨åˆ†å¯¹è±¡ä¹‹é—´æ˜¯æœ‰â€œé—´éš™â€çš„ã€‚åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•æ ‡è®°è¿‡åï¼Œæˆ‘ä»¬å‘ç° obj1ï¼Œobj2, obj5ä¸ºå¯¹è±¡ä¸å¯è¾¾å³â€œæ­»äº¡å¯¹è±¡â€ã€‚ç„¶åæˆ‘ä»¬å¯¹è¿™æ­»äº¡çš„å¯¹è±¡è¿›è¡Œæ¸…ç†ã€‚æ¸…ç†å®Œæˆåå°±å¾—åˆ°äº†ä¸‹é¢è¿™ä¸ªå›¾ï¼ˆè¿™é‡Œä¸è€ƒè™‘ finalize() æ–¹æ³•å¯¹åƒåœ¾å›æ”¶è¿‡ç¨‹äº§ç”Ÿçš„å½±å“ï¼‰ã€‚è¿™ä¸ªå…¶å®å°±æ˜¯åƒåœ¾å›æ”¶ç®—æ³•ä¸­çš„<code>æ ‡è®°-æ¸…é™¤ç®—æ³•ï¼ˆMark and Sweepï¼‰</code> ï¼Œè¿™ä¸ªè¿‡ç¨‹å¾ˆç®€å•ç®€å•åˆ†æˆä¸‹é¢ä¸¤æ­¥ï¼š</p><ul><li><strong>é€šè¿‡å¯è¾¾æ€§ç®—æ³•æ ‡è®°å‡ºä¸å¯è¾¾å¯¹è±¡å³â€œæ­»äº¡å¯¹è±¡â€ã€‚</strong></li><li><strong>â€œæ¸…ç†â€ä¸å¯è¾¾å¯¹è±¡ã€‚</strong></li></ul><p>è¿™é‡Œæœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œè¿™é‡Œçš„â€œæ¸…ç†â€å¹¶ä¸æ˜¯çœŸæ­£çš„æ¸…ç†ï¼Œè€Œæ˜¯<strong>å°†æ­»äº¡å¯¹è±¡çš„å†…å­˜ç©ºé—´åœ°å€è®°å½•åˆ°ç©ºé—²è¡¨ï¼ˆfree-listï¼‰ä¸Šï¼Œç„¶åç›´æ¥ä½¿ç”¨è¿™å—ç©ºé—´è¿›è¡Œç©ºé—´åˆ†é…ã€‚</strong></p><h4 id="æ¸…ç†è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå°é—®é¢˜"><a href="#æ¸…ç†è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå°é—®é¢˜" class="headerlink" title="æ¸…ç†è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå°é—®é¢˜"></a>æ¸…ç†è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå°é—®é¢˜</h4><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰å‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œè¿™é‡Œçš„ç©ºé—´å†…å­˜è™½ç„¶æ˜¯è®°å½•åœ¨ç©ºé—²è¡¨<code>free-list</code>ä¸Šï¼Œä½†æ˜¯æ–°æ¥ä¸€ä¸ªå¯¹è±¡å¯èƒ½ä¸ä¸€å®šèƒ½åˆ†é…çš„äº†ã€‚å› ä¸ºè¿™ä¸ªç©ºé—´ä¸æ˜¯è¿ç»­çš„ï¼Œæ¥ä¸€ä¸ªå¯¹è±¡å¯èƒ½æ¯”ç©ºé—´è¡¨ free-list ä¸Šæ‰€æœ‰çš„ç©ºé—²ç©ºé—´éƒ½è¦å¤§ï¼Œä½†æ˜¯æ‰€æœ‰çš„ç©ºé—²ç©ºé—´åŠ åœ¨ä¸€èµ·åˆå®Œå…¨è¶³å¤Ÿè®©è¿™ä¸ªå¯¹è±¡è¿›è¡Œåˆ†é…ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ä¸æ˜¯å°±å¾ˆéš¾å—ï¼Ÿåˆ«æ€¥è¿˜æœ‰æ›´éš¾å—çš„ï¼Œåˆ«å¿˜äº†æˆ‘ä»¬å¯ä»¥é€šè¿‡GCä¹Ÿå°±æ˜¯ä¸Šé¢è¿™ä¸ªè¿‡ç¨‹é‡Šæ”¾ç©ºé—´ï¼ŒGCå®Œæˆåå¾ˆé¡ºåˆ©ï¼Œåˆšå¥½æœ‰ä¸€ä¸ªå¯¹è±¡è¢«é‡Šæ”¾ï¼Œä¸€æ®µè¿ç»­çš„å†…å­˜åˆšå¥½å¤Ÿæ”¾ä¸‹è¿™ä¸ªå¯¹è±¡ã€‚æˆ‘ä»¬æ”¾æ¾ä¸€å£æ°”ã€‚è¿™æ—¶åˆæ¥äº†ä¸€ä¸ªå¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å’Œä¸Šä¸€ä¸ªå¯¹è±¡é‡åˆ°äº†åŒæ ·çš„é—®é¢˜ï¼Œè¿™æ˜¯æˆ‘ä»¬è¯¥æ€ä¹ˆåŠï¼ŸGCï¼Ÿè¿™æ—¶åˆšGCå®Œæˆï¼Œåº”è¯¥æ˜¯æ²¡æœ‰ç©ºé—´å¯ä»¥é‡Šæ”¾çš„ï¼ŒæŠ¥OOMè®©ç¨‹åºå‘˜å°å“¥å“¥è§£å†³ï¼Ÿæ˜æ˜æˆ‘ä»¬è¿˜æœ‰ç©ºé—´å•Šï¼Œåªä¸è¿‡éƒ½æ˜¯ä¸è¿ç»­çš„ç¢ç‰‡ç©ºé—´ã€‚æˆ‘ä»¬åœ¨è¿™ä¸ªåœºæ™¯ä¸­é‡åˆ°çš„å°é—®é¢˜å°±æ˜¯<strong>å› ä¸ºæ ‡è®°æ¸…é™¤ç®—æ³•åœ¨æ¸…é™¤å®Œæ¯•åä¸å¯¹ç©ºé—´è¿›è¡Œæ•´ç†ï¼Œå¯¼è‡´GCä¹‹åäº§ç”Ÿå¾ˆå¤šçš„ä¸è¿ç»­çš„ç¢ç‰‡ç©ºé—´ï¼Œè¿™äº›ç¢ç‰‡ç©ºé—´æ— æ³•è¿›è¡Œç©ºé—´åˆ†é…ä»è€Œå¯¼è‡´OOMçš„å‘ç”Ÿã€‚</strong>æˆ‘ä»¬è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªåŠæ³•å‘¢ï¼Ÿ</p><h4 id="æ ‡è®°-æ¸…é™¤-æ•´ç†ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰"><a href="#æ ‡è®°-æ¸…é™¤-æ•´ç†ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰" class="headerlink" title="æ ‡è®°-æ¸…é™¤-æ•´ç†ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰"></a>æ ‡è®°-æ¸…é™¤-æ•´ç†ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰</h4><p>é¢å¯¹ä¸Šé¢çš„é—®é¢˜å…¶å®æœ€ç®€å•çš„åŠæ³•å°±æ˜¯åœ¨æ¸…ç†å®Œæˆåæˆ‘ä»¬æ•´ç†ä¸‹å†…å­˜ç©ºé—´ï¼ŒæŠŠè¿˜å­˜æ´»çš„å¯¹è±¡å†æ¬¡æ’å¥½ã€‚æœ‰äº†æ•´ç†éƒ¨åˆ†çš„åŠ å…¥åä¸Šé¢çš„è¿‡ç¨‹å˜æˆä¸‹é¢è¿™æ ·ï¼š</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210531235410.png"></p><p>è¿™ä¸ªç®—æ³•å°±æ˜¯åƒåœ¾å›æ”¶ç®—æ³•ä¸­çš„<code>æ ‡è®°-æ¸…é™¤-æ•´ç†ç®—æ³•ï¼ˆMark-Sweep-Compactï¼‰</code>ä¹Ÿç§°ä½œ <code>Compactå‹ç¼©ç®—æ³•</code>ã€‚å‹ç¼©ç®—æ³•åˆ†ä¸ºä¸‹é¢ä¸‰æ­¥ï¼Œå…¶ä¸­å‰é¢ä¸¤æ­¥å’Œæ ‡è®°-æ¸…é™¤ç®—æ³•ä¸€è‡´ã€‚</p><ul><li><strong>é€šè¿‡å¯è¾¾æ€§ç®—æ³•æ ‡è®°å‡ºä¸å¯è¾¾å¯¹è±¡å³â€œæ­»äº¡å¯¹è±¡â€ã€‚</strong></li><li><strong>â€œæ¸…ç†â€ä¸å¯è¾¾å¯¹è±¡ã€‚</strong></li><li><strong>æ•´ç†å‹ç¼©å¯¹è±¡ç©ºé—´ã€‚</strong></li></ul><p>è¿™ä¸ªæ–¹æ¡ˆå¾ˆå®Œç¾ï¼Œå› ä¸ºè¿™ä¸ªç›¸è¾ƒäºæ ‡è®°-æ¸…ç†ç®—æ³•å¤šäº†ä¸€æ­¥ï¼Œè¿™ä¸€æ­¥è™½ç„¶å‹ç¼©äº†å¯¹è±¡ï¼Œç©ºé—²ç©ºé—´ä¹Ÿå˜æˆ<strong>è¿ç»­çš„ç©ºé—´æå‡äº†ç©ºé—´çš„åˆ©ç”¨ç‡</strong>ã€‚ä½†æ˜¯å¤šè¿™ä¸€æ­¥çš„æ“ä½œä¹Ÿä¸º<strong>å¢åŠ äº†</strong>æ¯æ¬¡GCå¤æ‚åº¦<strong>å¢åŠ æ¯æ¬¡çš„GCè€—æ—¶ã€‚è€Œè€å¹´ä»£å¯¹è±¡åŸºæœ¬ä¸Šéƒ½æ˜¯å­˜æ´»å¯¹è±¡ä¸”ç©ºé—´æ›´å¤§ï¼Œå‘ç”ŸGCçš„æ¦‚ç‡æ›´ä½</strong>ï¼Œå› æ­¤<strong>å‹ç¼©ç®—æ³•æ›´å¤šçš„ç”¨åœ¨äº†è€å¹´ä»£ã€‚</strong></p><h4 id="å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰"><a href="#å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰" class="headerlink" title="å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰"></a>å¤åˆ¶ç®—æ³•ï¼ˆCopyingï¼‰</h4><p>ä¸Šé¢çš„å‹ç¼©ç®—æ³•çš„å¼Šç«¯æ˜¯æ•´ç†ç©ºé—´å¢åŠ äº†GCçš„æ—¶é—´å¤æ‚åº¦ï¼Œæœ‰æ²¡æœ‰ä¼˜åŒ–çš„æ–¹æ¡ˆå‘¢ï¼Ÿæœ‰çš„ï¼Œåœ¨ç®—æ³•ä¸­æˆ‘ä»¬ç»å¸¸ä¼šä½¿ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ€æƒ³å¢åŠ ç¨‹åºçš„ç©ºé—´å¤æ‚åº¦æ¥é™ä½æ—¶é—´å¤æ‚åº¦ã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥ç›´æ¥<strong>å°†æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡å¤åˆ¶å¦å¤–ä¸€ä¸ªå†…å­˜ç©ºé—´ä¸­ï¼ŒåŸæœ¬çš„å†…å­˜ç©ºé—´ç›´æ¥æ¸…ç©º</strong>ã€‚å¤åˆ¶è¿‡å»çš„å¯¹è±¡å†…å­˜ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨æ–°ç©ºå‡ºæ¥çš„ç©ºé—´åˆ†é…å¯¹è±¡ï¼Œè¿™ä¸ªå¤åˆ¶è¿‡å»çš„ç›®æ ‡ç©ºé—´å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„<code>å­˜æ´»åŒºï¼ˆSurvivor spaceï¼‰</code>ï¼Œè¿™ä¸ªGCç®—æ³•ä¹Ÿå°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„<code>æ ‡è®°å¤åˆ¶ç®—æ³•</code>ï¼ˆMark and Copyï¼‰</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210530235921.png"></p><p>åœ¨å®é™…ä½¿ç”¨ä¸­é…åˆæ–°ç”Ÿä»£EdenåŒºå’Œæ¥å›å¤åˆ¶çš„ä¸¤ä¸ªSurvivorå­˜æ´»åŒºï¼Œå®ç°é«˜æ•ˆçš„å¤åˆ¶ç®—æ³•ã€‚å› æ­¤å¤åˆ¶ç®—æ³•åˆ†ä¸ºä»¥ä¸‹ä¸‰æ­¥ï¼š</p><ul><li><strong>é€šè¿‡å¯è¾¾æ€§ç®—æ³•æ ‡è®°å‡ºä¸å¯è¾¾å¯¹è±¡å³â€œæ­»äº¡å¯¹è±¡â€ã€‚</strong></li><li><strong>å¤åˆ¶å­˜æ´»å¯¹è±¡åˆ°Survivorçš„toåŒºã€‚</strong></li><li><strong>æ¸…ç©ºEdenåŒºå’ŒSurvivorçš„fromåŒºï¼Œå¹¶ä¸”fromå’ŒtoåŒºå¯¹æ¢ã€‚ï¼ˆé€»è¾‘ä¸Šçš„æ¸…ç©ºå’Œå¯¹æ¢ï¼‰</strong></li></ul><p>å¤åˆ¶ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦è¦æ˜æ˜¾ä¼˜äºå‹ç¼©ç®—æ³•ï¼Œå› æ­¤å¤åˆ¶ç®—æ³•æ›´åŠ é€‚åˆâ€œèŠ‚å¥æ›´å¿«â€çš„å¹´è½»ä»£ã€‚<strong>å¤åˆ¶ç®—æ³•æ˜¯è¿ç”¨åœ¨å¹´è½»ä»£çš„GCç®—æ³•ã€‚</strong></p><blockquote><p>æ–°ç”Ÿä»£å‘ç”Ÿçš„GC æˆ‘ä»¬ä¸€èˆ¬æˆä¸º<code>MinorGC</code>æˆ–è€…<code>YoungGC</code>ï¼Œè€å¹´ä»£å‘ç”Ÿçš„GCæˆ‘ä»¬ä¸€èˆ¬ç§°ä¸º<code>MajorGC</code>æˆ–<code>OldGC</code>ï¼Œè€Œ<code>FullGC</code>åˆ™æ˜¯è€å¹´ä»£å’Œæ–°ç”Ÿä»£éƒ½è§¦å‘çš„GCã€‚</p></blockquote><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä»æœ€åŸå§‹çš„æ‰‹åŠ¨ç®¡ç†å†…å­˜å¼€å§‹ï¼Œç®€å•åˆ†æå…¶åˆ©å¼Šä¹‹åï¼Œæˆ‘ä»¬é€æ­¥å¼€å§‹èµ°å‘è‡ªåŠ¨çš„åƒåœ¾å›æ”¶æœºåˆ¶ï¼Œç¬¬ä¸€ä¸ªåƒåœ¾å›æ”¶æœºå™¨å¹¶ä¸æ˜¯è¯ç”Ÿåœ¨Javaè¯­è¨€ä¸Šï¼Œåœ¨è¿›è¡Œåƒåœ¾å›æ”¶ä¹‹å‰æˆ‘ä»¬è¦åšçš„ç¬¬ä¸€ä»¶äº‹ä¸æ˜¯æ¸…ç†å›æ”¶ï¼Œè€Œæ˜¯åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯â€œæ´»ç€â€è¿˜æ˜¯å·²ç»â€œæ­»äº¡â€ã€‚è¿™é‡Œæˆ‘ä»¬ç®€å•ä»‹ç»äº†å¼•ç”¨è®¡æ•°æ³•ã€‚åœ¨ç”¨è®¡æ•°æ³•è§£å†³ä¸äº†å¾ªç¯å¼•ç”¨ä¹‹åï¼Œæˆ‘ä»¬ä»‹ç»äº†å¯è¾¾æ€§åˆ†æç®—æ³•ï¼Œé€šè¿‡ä¸€äº›åˆ—GC Roots åˆ¤æ–­æŸä¸ªå¯¹è±¡æ˜¯å¦å¯è¾¾ä»è€Œåˆ¤æ–­è¿™ä¸ªå¯¹è±¡æ˜¯å¦å­˜æ´»ã€‚ä¸ºäº†æ›´å¥½çš„è¿›è¡Œåƒåœ¾å›æ”¶ï¼Œå¼•ç”¨çš„ä¸¤ç§çŠ¶æ€å¼•ç”¨å’Œè¢«å¼•ç”¨æ˜¾ç„¶ä¸èƒ½å¾ˆå¥½çš„æè¿°å¼•ç”¨çš„ç±»å‹çŠ¶æ€ï¼Œå› æ­¤æˆ‘ä»¬å¼•å…¥äº†å¼ºå¼•ç”¨ã€è½¯å¼•ç”¨ã€å¼±å¼•ç”¨å’Œè™šå¼•ç”¨ï¼Œé¡ºä¾¿æäº†è¿™å‡ ç§å¼•ç”¨å¯¹åƒåœ¾å›æ”¶å™¨è¡Œä¸ºçš„å½±å“ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¿›å…¥åƒåœ¾å›æ”¶ç®—æ³•ï¼Œåœ¨æ­£å¼ä»‹ç»ç®—æ³•ä¹‹å‰æˆ‘ä»¬èŠäº†èŠåˆ†ä»£æ”¶é›†ç†è®ºã€‚ä¸ºäº†æ›´é«˜æ•ˆçš„è¿›è¡Œåƒåœ¾å›æ”¶ï¼ŒJVMä¾æ®å¯¹è±¡çš„â€œå­˜æ´»æ—¶é—´â€çš„é•¿çŸ­ï¼Œåˆ†ä¸ºå¹´è½»ä»£ã€è€å¹´ä»£å’Œæ°¸ç”Ÿä»£ä»¥åŠåç»­æ›¿ä»£æ°¸ç”Ÿä»£çš„å…ƒæ•°æ®åŒºã€‚å¹¶ä¸ºäº†æ›´å¥½çš„é…åˆåƒåœ¾å›æ”¶å™¨çš„å·¥ä½œåˆå°†å¹´è½»ä»£åˆ‡åˆ†æˆæ–°ç”Ÿä»£å’Œå­˜æ´»ä»£ã€‚æœ€åæˆ‘ä»¬ç»“åˆå›¾æ–‡ç®€å•ä»‹ç»æ ‡è®°æ¸…é™¤ã€æ ‡è®°æ•´ç†ï¼ˆå‹ç¼©ç®—æ³•ï¼‰å’Œå¤åˆ¶ç®—æ³•ã€‚ç®€å•æ˜äº†çš„è¯´æ˜äº†å„ç§ç®—æ³•çš„ç‰¹ç‚¹å’Œå·¥ä½œçš„å†…å­˜åŒºåŸŸã€‚æˆ‘ä»¬è¿˜æåˆ°äº†ä¸€äº›ç»†èŠ‚ä¸è¦å¿˜äº†å“¦ï¼Œæˆ‘ä»¬å³å°†è¢«æ·˜æ±°çš„ finalize() æ–¹æ³•å¯¹åƒåœ¾å›æ”¶çš„ä¸€ä¸¢ä¸¢å½±å“å’Œå³å°†åœ¨åƒåœ¾å›æ”¶å™¨ä¸­å¤§æ”¾å¼‚å½©çš„å¡è¡¨è®¾è®¡ã€‚</p><p>ä»Šå¤©è¿™å°èŠ‚å†…å®¹å¾ˆåŸºç¡€ä½†æ˜¯æ¢³ç†ä¸‹æ¥çœŸçš„å¾ˆå¤šä¹Ÿç”»äº†ä¸å°‘å›¾ï¼ŒæŒ‰ç…§è‡ªå·±çš„é€»è¾‘èµ°ä¸€éä¸‹æ¥çœŸçš„é€å½»äº†å¾ˆå¤šã€‚ä¹å±‚ä¹‹å°ï¼Œèµ·äºç´¯åœŸã€‚åŠ æ²¹ï½ã€‚</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºâ€”åƒåœ¾å›æ”¶ï¼ˆä¸Šï¼‰ã€‹</li><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºâ€”åƒåœ¾å›æ”¶ï¼ˆä¸‹ï¼‰ã€‹</li><li>å¸¸è§çš„çš„GCç®—æ³•ï¼ˆGCçš„èƒŒæ™¯ä¸åŸç†ï¼‰</li><li>æ·±å…¥ç†è§£ Java è™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰</li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM ç›‘æ§ä¸è¯Šæ–­å·¥å…·</title>
    <link href="/2021/05/26/jvm-monitor-tool/"/>
    <url>/2021/05/26/jvm-monitor-tool/</url>
    
    <content type="html"><![CDATA[<blockquote><p>ğŸ˜ å‰æ–¹å¤šå›¾å¤šä»£ç å—é¢„è­¦ï¼ï¼ï¼</p></blockquote><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Java è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿï¼Œå¦‚æœè¿™ä¸ªå¤æ‚çš„ç³»ç»Ÿæ˜¯ä¸€ä¸ªé»‘ç›’å­ï¼Œé‚£ä¸€æ—¦å‡ºç°äº†é—®é¢˜é‚£å°†æ˜¯éå¸¸æ£˜æ‰‹çš„ï¼Œæˆ‘ä»¬å°†æ²¡æœ‰ä»»ä½•çš„æ–¹å¼æ–¹æ³•æ¥å®šä½é—®é¢˜ï¼Œè¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚å› æ­¤ JDK å†…ç½®äº†å¾ˆå¤šçš„å·¥å…·å»è¯Šæ–­åˆ†æé—®é¢˜ï¼Œè¿™é‡Œé¢ä¸ä»…åŒ…æ‹¬ä¸€äº›å‘½ä»¤è¡Œå·¥å…·è¿˜æœ‰ä¸€äº›å›¾å½¢åŒ–å·¥å…·ï¼Œæ¯”å¦‚å‘½ä»¤è¡Œæœ‰å¸¸è§çš„ <code>jps</code>ã€<code>jinfo</code>ã€<code>jstat</code>ã€<code>jmap</code>ç­‰ï¼Œå›¾å½¢åŒ–å·¥å…·ä¹Ÿæœ‰ <code>jconsole</code>ã€<code>jvisualvm</code>ã€<code>jmc</code>ç­‰ã€‚å½“ç„¶å®é™…ä¸Šç”Ÿäº§ä¸Šè¿™ç±»å·¥å…·ç”¨çš„è¿˜æ˜¯æ¯”è¾ƒå°‘çš„ã€‚è¿™äº›å·¥å…·äº†å°±å¥½æ¯”æ˜¯èœåˆ€é˜Ÿäº†ï¼Œè€Œæ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬å®šä½é—®é¢˜éƒ½æ˜¯æœ‰æœºæªå¤§ç‚®çš„ã€‚åœ¨å·¥å…·å®Œå¤‡å‡†å¤‡å……åˆ†çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ Prometheus é…ä¸Šé›†æˆå¯è§†åŒ–å·¥å…· Grafana æˆ– DataDogã€‚å‡ºç°é—®é¢˜ä¹‹åï¼Œä¼šä½¿ç”¨ä¸€äº›åˆ†æå·¥å…·ï¼Œå¦‚ <code>Eclipse MAT</code>å†ç»“åˆä¸€äº›åœ¨çº¿å·¥å…·è¿›è¡Œæ•°æ®åˆ†æå¦‚ GCEasy å’Œ FastThreadã€‚</p><h2 id="ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Œç›‘æ§çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Œç›‘æ§çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Œç›‘æ§çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Œç›‘æ§çš„åˆæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æˆ‘ä»¬çš„é‡è¦å·¥ä½œä¹‹ä¸€å°±æ˜¯è¦ä¿è¯æˆ‘ä»¬å†™å‡ºæ¥çš„ç¨‹åºæ˜¯æ­£ç¡®çš„ä¸”å¥å£®çš„ï¼Œä¸èƒ½å› ä¸ºä¸€äº›å°å°çš„é—®é¢˜ä»£ç å°±å˜å¾—ä¸å¯ç”¨ï¼Œè¿™æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•å‘ç°æˆ‘ä»¬çš„ç³»ç»Ÿå‡ºç°äº†å¼‚æ ·å‘¢ï¼Ÿå¾ˆç®€å•å°±æ˜¯ç›‘æ§å®ƒï¼Œç±»æ¯”åˆ°äººç±»ä¸–ç•Œï¼Œå°±æ˜¯æˆ‘ä»¬çš„å°åŒºä¿å®‰æ˜¯å¦‚ä½•å¢å¼ºæˆ‘ä»¬çš„å®‰å…¨æ„Ÿçš„å‘¢ï¼Ÿä¹Ÿæ˜¯é€šè¿‡ç›‘æ§çš„æ‰‹æ®µï¼Œåªä¸è¿‡ä¿å®‰ç›‘æ§çš„æ˜¯å°åŒºå†…éƒ¨çš„æƒ…å†µï¼Œè€Œæˆ‘ä»¬ç›‘æ§çš„æ˜¯JVMçš„è¿è¡ŒæŒ‡æ ‡ã€‚è¿™äº›æŒ‡æ ‡åŒ…æ‹¬ä¸€äº›å¸¸è§çš„è¿è¡Œæ—¶æ•°æ®ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„å †æ ˆçš„å ç”¨æ•°æ®ï¼Œä»¥åŠæˆ‘ä»¬åé¢ä¼šæåˆ°çš„GCæœ‰å…³æ•°æ®ï¼Œå½“ç„¶è¿˜æœ‰æˆ‘ä»¬æœåŠ¡å™¨æœ¬èº«çš„å†…å­˜å’Œ CPU è´Ÿè½½æƒ…å†µç­‰ã€‚åªæœ‰æœ‰äº†è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬æ‰èƒ½è¿˜åŸå¼‚å¸¸æƒ…å†µå‘ç”Ÿæ—¶çš„ç³»ç»Ÿç¯å¢ƒã€‚è¿™å°±æ˜¯åƒæ˜¯è¿˜åŸå‡¶æ€ç°åœºä¸€æ ·åˆºæ¿€ã€‚åˆ†äº«ä¸€ä¸ªçœŸå®çš„æ¡ˆä¾‹ï¼Œæˆ‘ä»¬å…¬å¸ä¹‹å‰çš„ç³»ç»Ÿæ˜¯æ²¡æœ‰ç›‘æ§çš„ï¼Œæ‰€æœ‰çš„æœåŠ¡å°±æ˜¯ä¸€ä¸ªå•ä½“ç³»ç»Ÿå¹¶ä¸”æ•´ä½“ä»£ç è´¨é‡ä¹Ÿä¸é«˜ï¼Œæœ‰ä¸€æ¬¡ä¸Šçº¿ä¸€ä¸ªç‰ˆæœ¬ç„¶åç¬¬äºŒå¤©ä¸‹åˆä¸šåŠ¡é«˜å³°çš„æ—¶å€™ï¼ŒJVM çªç„¶å¼€å§‹å®•æœºæ‰€æœ‰æœåŠ¡å…¨éƒ¨æŒ‚æ‰ã€‚å½“æ—¶æˆ‘ä»¬æ˜¯å•ä½“æœåŠ¡ï¼ŒJVM ä¹Ÿæ²¡æœ‰é…ç½®ä»»ä½•çš„å¯ä»¥å¯¼å‡ºå †æ ˆä¿¡æ¯çš„JVMå‚æ•°ï¼Œä½†æ˜¯ä¸šåŠ¡æ˜¯åœ¨é«˜å³°æœŸä¸èƒ½åœï¼Œæ‰€ä»¥æˆ‘ä»¬åªæœ‰é‡å¯ï¼Œé‡å¯å®Œè¿‡äº†10åˆ†é’Ÿç»§ç»­æŒ‚æ‰ï¼Œç„¶åæ¥ç€é‡å¯ï¼ŒæœåŠ¡é•¿æ—¶é—´å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚è¿™å°±åƒæ˜¯å‡¶æ¡ˆç°åœºå‡¶æ‰‹ä½œæ¡ˆåï¼Œå‡¶æ€ç°åœºå´ä¸€ä¸ç—•è¿¹éƒ½æ²¡ç•™ä¸‹ï¼Œä¸ä»…æ€ä¼¤åŠ›å·¨å¤§è€Œä¸”ä¾®è¾±æ€§æå¼ºã€‚ æ‰€ä»¥å†å›åˆ°è¿™ä¸ªé—®é¢˜ä¸Šæ¥ï¼Œä¸ºä»€ä¹ˆéœ€è¦ç›‘æ§ï¼Œ<code>å› ä¸ºæˆ‘ä»¬è¦ä¿è¯ç³»ç»Ÿçš„ç¨³å®šè¿è¡Œã€éœ€è¦å¯¹ç³»ç»Ÿè¿›è¡Œæ€§èƒ½åˆ†æã€éœ€è¦åœ¨ç³»ç»Ÿå‡ºç°å¼‚å¸¸æ—¶ä¿ç•™è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œç³»ç»Ÿçš„ç›‘æ§å¿…ä¸å¯å°‘ã€‚</code></p><h2 id="JDK-å†…ç½®å·¥å…·"><a href="#JDK-å†…ç½®å·¥å…·" class="headerlink" title="JDK å†…ç½®å·¥å…·"></a>JDK å†…ç½®å·¥å…·</h2><p>æˆ‘ä»¬è¿™é‡Œä¸»è¦è¦ç›‘æ§çš„æ˜¯JVMï¼Œè™½ç„¶ä¸€èˆ¬ç¬¬ä¸€ç›´è§‰æƒ³åˆ°çš„éƒ½æ˜¯ä¸€äº›é«˜å¤§ä¸Šçš„ç›‘æ§å·¥å…·ï¼Œä½†æ˜¯JDKæœ¬èº«ä¹Ÿæä¾›äº†å¾ˆå¤šçš„å·¥å…·ã€‚è¿™é‡Œé¢ä¸ä»…æœ‰å‘½ä»¤è¡Œå·¥å…·è¿˜æœ‰ä¸€äº›å›¾å½¢åŒ–å·¥å…·ã€‚</p><h3 id="å‘½ä»¤è¡Œå·¥å…·"><a href="#å‘½ä»¤è¡Œå·¥å…·" class="headerlink" title="å‘½ä»¤è¡Œå·¥å…·"></a>å‘½ä»¤è¡Œå·¥å…·</h3><blockquote><p>ä»¥ä¸‹çš„æµ‹è¯•å…¨éƒ¨åŸºäº jdk11 è¾“å‡ºç»“æœï¼Œæµ‹è¯•ä½¿ç”¨ jdk8 æ—¶åŸºæœ¬å…¨éƒ¨ç¿»è½¦ã€‚</p></blockquote><h4 id="jps"><a href="#jps" class="headerlink" title="jps"></a>jps</h4><p>jps æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­çš„ Java è¿›ç¨‹ã€‚è¿™ä¸ªå‘½ä»¤å­˜åœ¨ç”¨æˆ·æƒé™éš”ç¦»ï¼Œä¹Ÿå°±æ˜¯ root ç”¨æˆ·èƒ½çœ‹åˆ°æ‰€æœ‰çš„ Java è¿›ç¨‹ï¼Œå…¶ä»–çš„ç”¨æˆ·åªèƒ½çœ‹åˆ°è‡ªå·±çš„ Java çš„è¿›ç¨‹ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘å¯åŠ¨äº† HelloServer å’Œ CxfDemoApplication å…¶ä¸­å‰é¢çš„æ•°å­— 5455 å’Œ 5350 æ˜¯ä»–ä»¬çš„<code>pid</code>ã€‚</p><figure class="highlight fsharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs fsharp">daiwei@daiweideMacBook-Pro ~ % jps -help<br>usage: jps [-help]<br>       jps [-q] [-mlvV] <span class="hljs-meta">[&lt;hostid&gt;]</span><br><br>Definitions:<br>    &lt;hostid&gt;:      &lt;hostname&gt;[:&lt;port&gt;]<br>    <br>daiwei@daiweideMacBook-Pro ~ % jps<br><span class="hljs-number">5780</span> Jps<br><span class="hljs-number">5350</span> CxfDemoApplication<br><span class="hljs-number">1560</span> RemoteMavenServer36<br><span class="hljs-number">394</span><br><span class="hljs-number">5454</span> Launcher<br><span class="hljs-number">5455</span> HelloServer<br></code></pre></td></tr></table></figure><h4 id="jinfo"><a href="#jinfo" class="headerlink" title="jinfo"></a>jinfo</h4><p>è¿™ä¸ªå‘½ä»¤çš„å…¨ç¨‹æ˜¯ Java Configuration Infoï¼Œæ‰€ä»¥å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å®æ—¶æŸ¥çœ‹å’Œè°ƒæ•´JVMé…ç½®å‚æ•°ã€‚</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs gradle">daiwei@daiweideMacBook-Pro ~ % jinfo -help<br>Usage:<br>    jinfo [option] &lt;pid&gt;<br>        (to connect to running process)<br>    jinfo [option] &lt;executable &lt;core&gt;<br>        (to connect to a core <span class="hljs-keyword">file</span>)<br>    jinfo [option] [server_id@]&lt;remote server IP or hostname&gt;<br>        (to connect to remote debug server)<br><br>where &lt;option&gt; is one of:<br>    -flag &lt;name&gt;         to <span class="hljs-keyword">print</span> the value of the named VM flag<br>    -flag [+|-]&lt;name&gt;    to enable or disable the named VM flag<br>    -flag &lt;name&gt;=&lt;value&gt; to set the named VM flag to the given value<br>    -flags               to <span class="hljs-keyword">print</span> VM flags<br>    -sysprops            to <span class="hljs-keyword">print</span> Java system properties<br>    &lt;no option&gt;          to <span class="hljs-keyword">print</span> both of the above<br>    -h | -help           to <span class="hljs-keyword">print</span> <span class="hljs-keyword">this</span> help message<br>daiwei@daiweideMacBook-Pro ~ % jinfo -flalgs <span class="hljs-number">8386</span><br>Java System Properties:<br>#Thu May <span class="hljs-number">20</span> <span class="hljs-number">23</span>:<span class="hljs-number">25</span>:<span class="hljs-number">31</span> CST <span class="hljs-number">2021</span><br>java.<span class="hljs-keyword">runtime</span>.name=Java(TM) SE <span class="hljs-keyword">Runtime</span> Environment<br>sun.boot.library.path=<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<br>java.vm.version=<span class="hljs-number">25.231</span>-b11<br>gopherProxySet=<span class="hljs-keyword">false</span><br>java.vm.vendor=Oracle Corporation<br>java.vendor.url=http\:<span class="hljs-comment">//java.oracle.com/</span><br>path.separator=\:<br>java.vm.name=Java HotSpot(TM) <span class="hljs-number">64</span>-Bit Server VM<br><span class="hljs-keyword">file</span>.encoding.pkg=sun.io<br>user.country=CN<br>sun.java.launcher=SUN_STANDARD<br>sun.os.patch.level=unknown<br>java.vm.specification.name=Java Virtual Machine Specification<br>user.dir=<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/github/</span>thinking-in-code<br>java.<span class="hljs-keyword">runtime</span>.version=<span class="hljs-number">1.8</span>.<span class="hljs-number">0</span>_231-b11<br>java.awt.graphicsenv=sun.awt.CGraphicsEnvironment<br>java.endorsed.dirs=<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib/endorsed<br>os.arch=x86_64<br>java.io.tmpdir=<span class="hljs-regexp">/var/</span>folders<span class="hljs-regexp">/4_/</span>dbqw6z6100535snfk5508v080000gn<span class="hljs-regexp">/T/</span><br>line.separator=\n<br>java.vm.specification.vendor=Oracle Corporation<br>os.name=Mac OS X<br>sun.jnu.encoding=UTF-<span class="hljs-number">8</span><br>java.library.path=<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/Extensions\:/</span>Library<span class="hljs-regexp">/Java/</span>Extensions\:<span class="hljs-regexp">/Network/</span>Library<span class="hljs-regexp">/Java/</span>Extensions\:<span class="hljs-regexp">/System/</span>Library<span class="hljs-regexp">/Java/</span>Extensions\:<span class="hljs-regexp">/usr/</span>lib/java\:.<br>sun.nio.ch.bugLevel=<br>java.specification.name=Java Platform API Specification<br>java.<span class="hljs-keyword">class</span>.version=<span class="hljs-number">52.0</span><br>sun.management.compiler=HotSpot <span class="hljs-number">64</span>-Bit Tiered Compilers<br>os.version=<span class="hljs-number">10.16</span><br>user.home=<span class="hljs-regexp">/Users/</span>daiwei<br>user.timezone=Asia/Shanghai<br>java.awt.printerjob=sun.lwawt.macosx.CPrinterJob<br><span class="hljs-keyword">file</span>.encoding=UTF-<span class="hljs-number">8</span><br>java.specification.version=<span class="hljs-number">1.8</span><br>java.<span class="hljs-keyword">class</span>.path=<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/charsets.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>deploy.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>cldrdata.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>dnsns.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>jaccess.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>jfxrt.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>localedata.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>nashorn.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunec.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunjce_provider.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunpkcs11.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>zipfs.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/javaws.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>jce.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jfr.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>jfxswt.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jsse.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/m</span>anagement-agent.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/plugin.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>resources.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/rt.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/ant-javafx.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/dt.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/javafx-mx.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/jconsole.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/packager.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/sa-jdi.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/tools.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/gi</span>thub<span class="hljs-regexp">/thinking-in-code/</span>thinking-in-grpc<span class="hljs-regexp">/target/</span>classes\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/io/g</span>rpc<span class="hljs-regexp">/grpc-netty-shaded/</span><span class="hljs-number">1.34</span>.<span class="hljs-number">1</span><span class="hljs-regexp">/grpc-netty-shaded-1.34.1.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/i</span>o<span class="hljs-regexp">/grpc/g</span>rpc-core<span class="hljs-regexp">/1.34.1/g</span>rpc-core-<span class="hljs-number">1.34</span>.<span class="hljs-number">1</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/com/g</span>oogle<span class="hljs-regexp">/android/</span>annotations<span class="hljs-regexp">/4.1.1.4/</span>annotations-<span class="hljs-number">4.1</span>.<span class="hljs-number">1.4</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/io/</span>perfmark<span class="hljs-regexp">/perfmark-api/</span><span class="hljs-number">0.19</span>.<span class="hljs-number">0</span><span class="hljs-regexp">/perfmark-api-0.19.0.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/i</span>o<span class="hljs-regexp">/grpc/g</span>rpc-protobuf<span class="hljs-regexp">/1.34.1/g</span>rpc-protobuf-<span class="hljs-number">1.34</span>.<span class="hljs-number">1</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/io/g</span>rpc<span class="hljs-regexp">/grpc-api/</span><span class="hljs-number">1.34</span>.<span class="hljs-number">1</span><span class="hljs-regexp">/grpc-api-1.34.1.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/i</span>o<span class="hljs-regexp">/grpc/g</span>rpc-context<span class="hljs-regexp">/1.34.1/g</span>rpc-context-<span class="hljs-number">1.34</span>.<span class="hljs-number">1</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/com/g</span>oogle<span class="hljs-regexp">/code/</span>findbugs<span class="hljs-regexp">/jsr305/</span><span class="hljs-number">3.0</span>.<span class="hljs-number">2</span><span class="hljs-regexp">/jsr305-3.0.2.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/</span>protobuf<span class="hljs-regexp">/protobuf-java/</span><span class="hljs-number">3.14</span>.<span class="hljs-number">0</span><span class="hljs-regexp">/protobuf-java-3.14.0.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/</span>api<span class="hljs-regexp">/grpc/</span>proto-google-common-protos<span class="hljs-regexp">/1.17.0/</span>proto-google-common-protos-<span class="hljs-number">1.17</span>.<span class="hljs-number">0</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/io/g</span>rpc<span class="hljs-regexp">/grpc-protobuf-lite/</span><span class="hljs-number">1.34</span>.<span class="hljs-number">1</span><span class="hljs-regexp">/grpc-protobuf-lite-1.34.1.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/gu</span>ava<span class="hljs-regexp">/guava/</span><span class="hljs-number">29.0</span>-android<span class="hljs-regexp">/guava-29.0-android.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/gu</span>ava<span class="hljs-regexp">/failureaccess/</span><span class="hljs-number">1.0</span>.<span class="hljs-number">1</span><span class="hljs-regexp">/failureaccess-1.0.1.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/gu</span>ava<span class="hljs-regexp">/listenablefuture/</span><span class="hljs-number">9999.0</span>-empty-to-avoid-conflict-with-guava<span class="hljs-regexp">/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>org<span class="hljs-regexp">/checkerframework/</span>checker-compat-qual<span class="hljs-regexp">/2.5.5/</span>checker-compat-qual-<span class="hljs-number">2.5</span>.<span class="hljs-number">5</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/com/g</span>oogle<span class="hljs-regexp">/j2objc/</span>j2objc-annotations<span class="hljs-regexp">/1.3/</span>j2objc-annotations-<span class="hljs-number">1.3</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/com/g</span>oogle<span class="hljs-regexp">/errorprone/</span>error_prone_annotations<span class="hljs-regexp">/2.3.4/</span>error_prone_annotations-<span class="hljs-number">2.3</span>.<span class="hljs-number">4</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/org/</span>codehaus<span class="hljs-regexp">/mojo/</span>animal-sniffer-annotations<span class="hljs-regexp">/1.18/</span>animal-sniffer-annotations-<span class="hljs-number">1.18</span>.jar\:<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/.m2/</span>repository<span class="hljs-regexp">/io/g</span>rpc<span class="hljs-regexp">/grpc-stub/</span><span class="hljs-number">1.34</span>.<span class="hljs-number">1</span><span class="hljs-regexp">/grpc-stub-1.34.1.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/</span>protobuf<span class="hljs-regexp">/protobuf-java-util/</span><span class="hljs-number">3.12</span>.<span class="hljs-number">0</span><span class="hljs-regexp">/protobuf-java-util-3.12.0.jar\:/U</span>sers<span class="hljs-regexp">/daiwei/</span>.m2<span class="hljs-regexp">/repository/</span>com<span class="hljs-regexp">/google/</span>code<span class="hljs-regexp">/gson/g</span>son<span class="hljs-regexp">/2.8.6/g</span>son-<span class="hljs-number">2.8</span>.<span class="hljs-number">6</span>.jar\:<span class="hljs-regexp">/Applications/I</span>ntelliJ IDEA.app<span class="hljs-regexp">/Contents/</span>lib/idea_rt.jar<br>user.name=daiwei<br>java.vm.specification.version=<span class="hljs-number">1.8</span><br>sun.java.command=io.daiwei.grpc.HelloServer<br>java.home=<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home/jre<br>sun.arch.data.model=<span class="hljs-number">64</span><br>user.language=zh<br>java.specification.vendor=Oracle Corporation<br>awt.toolkit=sun.lwawt.macosx.LWCToolkit<br>java.vm.info=mixed mode<br>java.version=<span class="hljs-number">1.8</span>.<span class="hljs-number">0</span>_231<br>java.ext.dirs=<span class="hljs-regexp">/Users/</span>daiwei<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/Extensions\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>ext\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/Extensions\:/</span>Network<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/Extensions\:/</span>System<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/Extensions\:/u</span>sr<span class="hljs-regexp">/lib/</span>java<br>sun.boot.<span class="hljs-keyword">class</span>.path=<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/resources.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>rt.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/sunrsasign.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>jsse.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jce.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>charsets.jar\:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jfr.jar\:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre/classes<br>java.vendor=Oracle Corporation<br><span class="hljs-keyword">file</span>.separator=/<br>java.vendor.url.bug=http\:<span class="hljs-comment">//bugreport.sun.com/bugreport/</span><br>sun.io.unicode.encoding=UnicodeBig<br>sun.cpu.endian=little<br>sun.cpu.isalist=<br><br>VM Flags:<br>-XX:CICompilerCount=<span class="hljs-number">4</span> -XX:InitialHeapSize=<span class="hljs-number">268435456</span> -XX:MaxHeapSize=<span class="hljs-number">4294967296</span> -XX:MaxNewSize=<span class="hljs-number">1431306240</span> -XX:MinHeapDeltaBytes=<span class="hljs-number">524288</span> -XX:NewSize=<span class="hljs-number">89128960</span> -XX:OldSize=<span class="hljs-number">179306496</span> -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseFastUnorderedTimeStamps -XX:+UseParallelGC<br><br>VM Arguments:<br>jvm_args: -javaagent:<span class="hljs-regexp">/Applications/I</span>ntelliJ IDEA.app<span class="hljs-regexp">/Contents/</span>lib<span class="hljs-regexp">/idea_rt.jar=51341:/</span>Applications<span class="hljs-regexp">/IntelliJ IDEA.app/</span>Contents/bin -Dfile.encoding=UTF-<span class="hljs-number">8</span><br>java_command: io.daiwei.grpc.HelloServer<br>java_class_path (initial): <span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/charsets.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>deploy.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>cldrdata.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>dnsns.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>jaccess.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>jfxrt.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>localedata.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>nashorn.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunec.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunjce_provider.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>sunpkcs11.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/ext/</span>zipfs.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/javaws.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>jce.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jfr.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>jfxswt.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/jsse.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/m</span>anagement-agent.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/plugin.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>jre<span class="hljs-regexp">/lib/</span>resources.jar:<span class="hljs-regexp">/Library/</span>Java<span class="hljs-regexp">/JavaVirtualMachines/</span>jdk1.<span class="hljs-number">8.0</span>_231.jdk<span class="hljs-regexp">/Contents/</span>Home<span class="hljs-regexp">/jre/</span>lib<span class="hljs-regexp">/rt.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents<span class="hljs-regexp">/Home/</span>lib<span class="hljs-regexp">/ant-javafx.jar:/</span>Library<span class="hljs-regexp">/Java/</span>JavaVirtualMachines<span class="hljs-regexp">/jdk1.8.0_231.jdk/</span>Contents/Home<br>Launcher Type: SUN_STANDARD<br></code></pre></td></tr></table></figure><h4 id="jstat"><a href="#jstat" class="headerlink" title="jstat"></a>jstat</h4><p>è¿™æ˜¯æˆ‘ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„ä¸€ä¸ªå‘½ä»¤ï¼Œä¹Ÿæ˜¯ç”¨çš„ç¨å¾®å¤šé‚£ä¹ˆä¸€äº›çš„å‘½ä»¤ï¼Œå°±åƒè¿™ä¸ªåå­—ä¸€æ ·ï¼Œjstat å¯ä»¥è¾“å‡ºä¸€äº› jvm çš„çŠ¶æ€ä¿¡æ¯ã€‚å…¶ä¸­ä¸»è¦ç”¨å®ƒå¯ä»¥å®æ—¶åœ°è¾“å‡º GC æœ‰å…³æ•°æ®ã€‚</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs dns">daiwei@daiweideMacBook-Pro ~ % jstat<br>Usage: jstat --help|-options<br>       jstat -&lt;option&gt; [-t] [-h&lt;lines&gt;] &lt;vmid&gt; [&lt;interval&gt; [&lt;count&gt;]]<br><br>Definitions:<br>  &lt;option&gt;      An option reported by the -options option<br>  &lt;vmid&gt;        Virtual Machine Identifier. <span class="hljs-keyword">A</span> vmid takes the following form:<br>                     &lt;lvmid&gt;[@&lt;hostname&gt;[:&lt;port&gt;]]<br>                Where &lt;lvmid&gt; is the local vm identifier for the target<br>                Java virtual machine, typically a process id<span class="hljs-comment">; &lt;hostname&gt; is</span><br>                the name of the host running the target Java virtual machine<span class="hljs-comment">;</span><br>                and &lt;port&gt; is the port number for the rmiregistry on the<br>                target host. See the jvmstat documentation for a more complete<br>                description of the Virtual Machine Identifier.<br>  &lt;lines&gt;       Number of samples between header lines.<br>  &lt;interval&gt;    Sampling interval. The following forms are allowed:<br>                    &lt;n&gt;[&quot;ms&quot;|&quot;s&quot;]<br>                Where &lt;n&gt; is an integer and the suffix specifies the units as<br>                milliseconds(&quot;ms&quot;) or seconds(&quot;s&quot;). The default units are &quot;ms&quot;.<br>  &lt;count&gt;       Number of samples to take before terminating.<br>  -J&lt;flag&gt;      Pass &lt;flag&gt; directly to the runtime system.<br>  -? -h --help  Prints this help message.<br>  -help         Prints this help message.<br>  <br>daiwei@daiweideMacBook-Pro ~ % jstat -options<br>-class                          # ç±»åŠ è½½ï¼ˆClass loaderï¼‰ä¿¡æ¯ç»Ÿè®¡<br>-compiler                       # JITå³æ—¶ç¼–è¯‘å™¨ç›¸å…³ç»Ÿè®¡ä¿¡æ¯<br>-gc                                 # GCç›¸å…³çš„å †å†…å­˜ä¿¡æ¯ï¼Œç”¨æ³• jstat -gc -h <span class="hljs-number">10</span> -t <span class="hljs-number">864</span> <span class="hljs-number">1</span>s <span class="hljs-number">20</span><br>-gccapacity                 # å„ä¸ªå†…å­˜æ± åˆ†ä»£ç©ºé—´çš„å®¹é‡<br>-gccause                        # çœ‹ä¸Šæ¬¡GCï¼Œæœ¬æ¬¡GCï¼ˆå¦‚æœæ­£åœ¨GCä¸­ï¼‰çš„åŸå› ï¼Œå…¶ä»–è¾“å‡ºå’Œ -gcutil çš„é€‰é¡¹ä¸€è‡´<br>-gcmetacapacity     # å…ƒæ•°æ®åŒºå¤§å°ç»Ÿè®¡<br>-gcnew                          # å¹´è½»ä»£çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œï¼ˆNEW = YOUNG = Eden + S0 + S1ï¼‰<br>-gcnewcapacity          # å¹´è½»ä»£ç©ºé—´å¤§å°ç»Ÿè®¡<br>-gcold                          # è€å¹´ä»£å’Œå…ƒæ•°æ®åŒºçš„è¡Œä¸ºç»Ÿè®¡<br>-gcoldcapacity          # è€å¹´ä»£çš„ç©ºé—´ç»Ÿè®¡<br>-gcutil                         # GCç›¸å…³åŒºåŸŸçš„ä½¿ç”¨ç‡ï¼ˆutillizationï¼‰ç»Ÿè®¡<br>-printcompilation       # æ‰“å°JVMç¼–è¯‘ç»Ÿè®¡ä¿¡æ¯ <br><br><br>jstat -gcutil <span class="hljs-number">11064 1000</span> <span class="hljs-number">15</span><br>  S0     S1     E      O      M     CCS    YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT<br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">26</span>.<span class="hljs-number">20</span>   <span class="hljs-number">5</span>.<span class="hljs-number">81</span>  <span class="hljs-number">97</span>.<span class="hljs-number">40</span>  <span class="hljs-number">94</span>.<span class="hljs-number">92</span>    <span class="hljs-number">156</span>    <span class="hljs-number">0</span>.<span class="hljs-number">200</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">200</span><br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">99</span>.<span class="hljs-number">77</span>   <span class="hljs-number">5</span>.<span class="hljs-number">81</span>  <span class="hljs-number">97</span>.<span class="hljs-number">40</span>  <span class="hljs-number">94</span>.<span class="hljs-number">92</span>    <span class="hljs-number">156</span>    <span class="hljs-number">0</span>.<span class="hljs-number">200</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">200</span><br> <span class="hljs-number">43</span>.<span class="hljs-number">75</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">6</span>.<span class="hljs-number">00</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">164</span>    <span class="hljs-number">0</span>.<span class="hljs-number">209</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">209</span><br>  <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">43</span>.<span class="hljs-number">75</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">6</span>.<span class="hljs-number">18</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">171</span>    <span class="hljs-number">0</span>.<span class="hljs-number">216</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">216</span><br> <span class="hljs-number">50</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">49</span>.<span class="hljs-number">84</span>   <span class="hljs-number">6</span>.<span class="hljs-number">34</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">178</span>    <span class="hljs-number">0</span>.<span class="hljs-number">223</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">223</span><br>  <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">37</span>.<span class="hljs-number">50</span>  <span class="hljs-number">53</span>.<span class="hljs-number">75</span>   <span class="hljs-number">6</span>.<span class="hljs-number">49</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">185</span>    <span class="hljs-number">0</span>.<span class="hljs-number">231</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">231</span><br>  <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">50</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">6</span>.<span class="hljs-number">69</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">193</span>    <span class="hljs-number">0</span>.<span class="hljs-number">239</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">239</span><br> <span class="hljs-number">25</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">14</span>.<span class="hljs-number">03</span>   <span class="hljs-number">6</span>.<span class="hljs-number">80</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">200</span>    <span class="hljs-number">0</span>.<span class="hljs-number">246</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">246</span><br> <span class="hljs-number">50</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">32</span>.<span class="hljs-number">01</span>   <span class="hljs-number">6</span>.<span class="hljs-number">93</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">206</span>    <span class="hljs-number">0</span>.<span class="hljs-number">253</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">253</span><br> <span class="hljs-number">50</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">47</span>.<span class="hljs-number">99</span>   <span class="hljs-number">7</span>.<span class="hljs-number">08</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">212</span>    <span class="hljs-number">0</span>.<span class="hljs-number">259</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">259</span><br> <span class="hljs-number">50</span>.<span class="hljs-number">00</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">27</span>.<span class="hljs-number">80</span>   <span class="hljs-number">7</span>.<span class="hljs-number">21</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">218</span>    <span class="hljs-number">0</span>.<span class="hljs-number">266</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">266</span><br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">57</span>.<span class="hljs-number">97</span>   <span class="hljs-number">7</span>.<span class="hljs-number">34</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">57</span>.<span class="hljs-number">97</span>   <span class="hljs-number">7</span>.<span class="hljs-number">34</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">57</span>.<span class="hljs-number">97</span>   <span class="hljs-number">7</span>.<span class="hljs-number">34</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br> <span class="hljs-number">37</span>.<span class="hljs-number">50</span>   <span class="hljs-number">0</span>.<span class="hljs-number">00</span>  <span class="hljs-number">57</span>.<span class="hljs-number">97</span>   <span class="hljs-number">7</span>.<span class="hljs-number">34</span>  <span class="hljs-number">96</span>.<span class="hljs-number">34</span>  <span class="hljs-number">94</span>.<span class="hljs-number">93</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>     <span class="hljs-number">0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">000</span>     -        -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br> <br>daiwei@daiweideMacBook-Pro ~ % jstat -gc <span class="hljs-number">11064 1000</span> <span class="hljs-number">15</span><br> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT    CGC    CGCT     GCT<br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">192</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">19405.0</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">12854.1</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">19977.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2673.3</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">192</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">19405.1</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">12854.1</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">19977.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2673.3</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">192</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">19405.1</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">12854.1</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">19977.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2673.3</span>    <span class="hljs-number">224</span>    <span class="hljs-number">0</span>.<span class="hljs-number">272</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">272</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">160</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>   <span class="hljs-number">5617</span>.<span class="hljs-number">8</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">13354.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20071.3</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">230</span>    <span class="hljs-number">0</span>.<span class="hljs-number">279</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">279</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">224</span>.<span class="hljs-number">0</span>  <span class="hljs-number">31232.0</span>  <span class="hljs-number">10477.4</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">13674.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">237</span>    <span class="hljs-number">0</span>.<span class="hljs-number">286</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">286</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">256</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">21876.8</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">13986.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">244</span>    <span class="hljs-number">0</span>.<span class="hljs-number">294</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">294</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">224</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">0</span>     <span class="hljs-number">175104.0</span>   <span class="hljs-number">14306.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">252</span>    <span class="hljs-number">0</span>.<span class="hljs-number">303</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">303</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">256</span>.<span class="hljs-number">0</span>  <span class="hljs-number">31232.0</span>  <span class="hljs-number">11824.0</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">14658.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.0</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">259</span>    <span class="hljs-number">0</span>.<span class="hljs-number">310</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">310</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">256</span>.<span class="hljs-number">0</span>  <span class="hljs-number">31232.0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">0</span>     <span class="hljs-number">175104.0</span>   <span class="hljs-number">15042.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.8</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">267</span>    <span class="hljs-number">0</span>.<span class="hljs-number">318</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">318</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">256</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>   <span class="hljs-number">6867</span>.<span class="hljs-number">3</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">15330.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.8</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">274</span>    <span class="hljs-number">0</span>.<span class="hljs-number">326</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">326</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">224</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">15562.0</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">15562.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.8</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">280</span>    <span class="hljs-number">0</span>.<span class="hljs-number">332</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">332</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">160</span>.<span class="hljs-number">0</span>  <span class="hljs-number">31232.0</span>    <span class="hljs-number">0</span>.<span class="hljs-number">0</span>     <span class="hljs-number">175104.0</span>   <span class="hljs-number">15842.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20073.8</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">287</span>    <span class="hljs-number">0</span>.<span class="hljs-number">340</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">340</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">192</span>.<span class="hljs-number">0</span>  <span class="hljs-number">31232.0</span>   <span class="hljs-number">7477</span>.<span class="hljs-number">3</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">16090.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20074.2</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">293</span>    <span class="hljs-number">0</span>.<span class="hljs-number">346</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">346</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">224</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">21846.6</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">16138.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20074.2</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">294</span>    <span class="hljs-number">0</span>.<span class="hljs-number">347</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">347</span><br><span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">512</span>.<span class="hljs-number">0</span>  <span class="hljs-number">224</span>.<span class="hljs-number">0</span>   <span class="hljs-number">0</span>.<span class="hljs-number">0</span>   <span class="hljs-number">31232.0</span>  <span class="hljs-number">21846.6</span>   <span class="hljs-number">175104.0</span>   <span class="hljs-number">16138.2</span>   <span class="hljs-number">20736.0</span> <span class="hljs-number">20074.2</span> <span class="hljs-number">2816</span>.<span class="hljs-number">0 2674.4</span>    <span class="hljs-number">294</span>    <span class="hljs-number">0</span>.<span class="hljs-number">347</span>   <span class="hljs-number">0</span>      <span class="hljs-number">0</span>.<span class="hljs-number">000</span>   -          -    <span class="hljs-number">0</span>.<span class="hljs-number">347</span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸€æ¬¡æŒç»­ 10 ç§’çš„æœåŠ¡å‹æµ‹ï¼Œå¯ä»¥çœ‹åˆ°ä¸€äº›æ•°æ®æŒç»­ä¸æ–­çš„å˜åŒ–ã€‚-gc å’Œ-gcutil çš„å‚æ•°éƒ½æ˜¯ä¸€æ ·çš„ <code>11064</code> æ˜¯ pidï¼Œ<code>1000</code> æ˜¯æ‰“å°æ—¶é—´é—´éš”å•ä½ msï¼Œ<code>15</code> æ˜¯æ‰“å°æ¬¡æ•°ï¼Œæ‰“å°15æ¬¡ã€‚</p><p>gcutil çš„ è¾“å‡ºå‚æ•°ï¼š</p><ul><li><code>S0</code> 0 å· Survivor åŒºçš„ä½¿ç”¨ç™¾åˆ†æ¯”ï¼ˆS0 å’Œ S1 æ€»æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„ï¼‰ã€‚</li><li><code>S1</code> 1 å· Survivor åŒºçš„ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</li><li><code>E</code> Eden åŒºï¼Œä¹Ÿå°±æ˜¯æ–°ç”Ÿä»£çš„ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</li><li><code>O</code> Old åŒºè€å¹´ä»£çš„ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</li><li><code>M</code> MetaåŒºå…ƒæ•°æ®åŒºçš„ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</li><li><code>CSS</code> å‹ç¼©classç©ºé—´ï¼ˆCompress class spaceï¼‰çš„ä½¿ç”¨ç™¾åˆ†æ¯”ã€‚</li><li><code>YGC</code> youngGC æ¬¡æ•°</li><li><code>YGCT</code> youngGC æ€»è€—æ—¶ï¼Œå•ä½ç§’</li><li><code>FGC</code> fullGC çš„æ¬¡æ•°ï¼Œå¯ä»¥çœ‹åˆ° fullGC ä¸€æ¬¡éƒ½æ²¡æœ‰ã€‚</li><li><code>FGCT</code> fullGC çš„æ€»æ•°æ—¶é—´ï¼Œä¸€æ¬¡FullGC éƒ½æ²¡æœ‰ï¼Œæ‰€ä»¥FullGC æ—¶é—´ä¸º 0</li><li><code>CGC</code> concurrentGC å¹¶å‘åƒåœ¾æ”¶é›†æ¬¡æ•°ï¼Œå› ä¸º jdk8 çš„é»˜è®¤å›æ”¶å™¨æ˜¯ parallelGC æ²¡æœ‰å¹¶å‘é˜¶æ®µæ‰€ä»¥è¿™é‡Œæ˜¯ - </li><li><code>CGCT</code> concurrentGC æ”¶é›†æ€»æ—¶é—´ã€‚</li><li><code>GCT</code> æ‰€æœ‰ GC åŠ åœ¨ä¸€èµ·çš„æ—¶é—´ã€‚</li></ul><p>å…¶å® -gcutil å’Œ -gc è¾“å‡ºé€»è¾‘æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯ -gc è¾“å‡ºçš„<code>å®é™…å ç”¨çš„å¤§å°å•ä½ kb</code>ï¼Œå¹¶ä¸” -gc è¾“å‡ºçš„éƒ½æ˜¯ <code>XXU</code>ã€ <code>XXC</code> è¿™ä»£è¡¨ç€ <code>XX Usage</code> å’Œ <code>XX Capacity</code> çš„æ„æ€ã€‚</p><h4 id="jmap"><a href="#jmap" class="headerlink" title="jmap"></a>jmap</h4><p>ç”¨äºè¾“å‡ºç³»ç»Ÿ JVM å †ä¿¡æ¯ã€‚ç”¨çš„æœ€å¤šçš„ä¸¤ä¸ªå‘½ä»¤ <code>-histo</code> å’Œ <code>-dump</code> ã€‚å…¶ä¸­<code>-histo</code>ï¼ˆæŸ±çŠ¶å›¾ï¼‰è¾“å‡ºå½“å‰å †ä¸­çš„å¯¹è±¡å¹¶æŒ‰ç…§å ç”¨ç©ºé—´ä»å¤§åˆ°å°æ’åºã€‚<code>-dump</code> dump å½“å‰å †ä¿¡æ¯ã€‚jmap åœ¨ jdk8 ä¸­è¿˜æœ‰ä¸€ä¸ª <code>-heap</code> å‘½ä»¤ï¼Œä½†æ˜¯åœ¨è¿™ä¸€ç‰ˆçš„ jdk11 ä¸­ç§»é™¤äº†ï¼Œä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯æœ‰åŠæ³•è¾“å‡º -heap çš„å†…å®¹ï¼Œåˆ«ç€æ€¥å¾€ä¸‹çœ‹ã€‚</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">daiwei@daiweideMacBook-Pro ~ % <span class="hljs-keyword">jmap </span>-help<br><span class="hljs-symbol">Usage:</span><br>    <span class="hljs-keyword">jmap </span>-clstats &lt;pid&gt;<br>        to connect to running process <span class="hljs-keyword">and </span>print class loader statistics<br>    <span class="hljs-keyword">jmap </span>-finalizerinfo &lt;pid&gt;<br>        to connect to running process <span class="hljs-keyword">and </span>print information on objects awaiting finalization<br>    <span class="hljs-keyword">jmap </span>-histo[:live] &lt;pid&gt;<br>        to connect to running process <span class="hljs-keyword">and </span>print histogram of <span class="hljs-keyword">java </span>object heap<br>        if the <span class="hljs-string">&quot;live&quot;</span> <span class="hljs-keyword">suboption </span>is specified, only <span class="hljs-built_in">count</span> live objects<br>    <span class="hljs-keyword">jmap </span>-dump:&lt;dump-options&gt; &lt;pid&gt;<br>        to connect to running process <span class="hljs-keyword">and </span>dump <span class="hljs-keyword">java </span>heap<br>    <span class="hljs-keyword">jmap </span>-? -h --help<br>        to print this help message<br><br>    dump-options:<br>      live         dump only live objects<span class="hljs-comment">; if not specified,</span><br>                   all objects in the heap are dumped.<br>      format=<span class="hljs-keyword">b </span>    <span class="hljs-keyword">binary </span>format<br>      file=&lt;file&gt;  dump heap to &lt;file&gt;<br><br><span class="hljs-symbol">    Example:</span> <span class="hljs-keyword">jmap </span>-dump:live,format=<span class="hljs-keyword">b,file=heap.bin </span>&lt;pid&gt;<br>    <br> daiwei@daiweideMacBook-Pro ~ % <span class="hljs-keyword">jmap </span>-histo <span class="hljs-number">33208</span><br><br> num     <span class="hljs-comment">#instances         #bytes  class name</span><br>----------------------------------------------<br><span class="hljs-symbol">   1:</span>        <span class="hljs-number">106522</span>        <span class="hljs-number">4260880</span>  <span class="hljs-keyword">java.lang.ref.Finalizer</span><br><span class="hljs-keyword"> </span>  <span class="hljs-number">2</span>:        <span class="hljs-number">106222</span>        <span class="hljs-number">4248880</span>  <span class="hljs-keyword">java.util.WeakHashMap$Entry</span><br><span class="hljs-keyword"> </span>  <span class="hljs-number">3</span>:        <span class="hljs-number">106200</span>        <span class="hljs-number">3398400</span>  <span class="hljs-keyword">java.lang.ref.WeakReference</span><br><span class="hljs-keyword"> </span>  <span class="hljs-number">4</span>:          <span class="hljs-number">4569</span>        <span class="hljs-number">2491656</span>  [I<br><span class="hljs-symbol">   5:</span>         <span class="hljs-number">67343</span>        <span class="hljs-number">2154976</span>  com.sun.<span class="hljs-keyword">jna.Memory</span><br><span class="hljs-keyword"> </span>  <span class="hljs-number">6</span>:         <span class="hljs-number">46271</span>        <span class="hljs-number">1698896</span>  [Ljava.lang.Object;<br><span class="hljs-symbol">   7:</span>         <span class="hljs-number">28666</span>        <span class="hljs-number">1330904</span>  [C<br><span class="hljs-symbol">   8:</span>         <span class="hljs-number">13698</span>        <span class="hljs-number">1271480</span>  [<span class="hljs-keyword">B</span><br><span class="hljs-keyword"> </span>  <span class="hljs-number">9</span>:         <span class="hljs-number">31081</span>        <span class="hljs-number">1243240</span>  com.sun.<span class="hljs-keyword">jna.NativeString$StringMemory</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">10</span>:         <span class="hljs-number">14391</span>        <span class="hljs-number">1036744</span>  [<span class="hljs-keyword">J</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">11</span>:         <span class="hljs-number">31081</span>         <span class="hljs-number">745944</span>  com.sun.<span class="hljs-keyword">jna.NativeString</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">12</span>:          <span class="hljs-number">7526</span>         <span class="hljs-number">613808</span>  [Ljava.util.HashMap$Node;<br><span class="hljs-symbol">  13:</span>            <span class="hljs-number">46</span>         <span class="hljs-number">527904</span>  [Ljava.util.WeakHashMap$Entry;<br><span class="hljs-symbol">  14:</span>         <span class="hljs-number">20227</span>         <span class="hljs-number">485448</span>  <span class="hljs-keyword">java.lang.String</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">15</span>:          <span class="hljs-number">6157</span>         <span class="hljs-number">443304</span>  <span class="hljs-keyword">java.lang.reflect.Field</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">16</span>:          <span class="hljs-number">7534</span>         <span class="hljs-number">361632</span>  <span class="hljs-keyword">java.util.HashMap</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">17</span>:         <span class="hljs-number">12098</span>         <span class="hljs-number">290352</span>  <span class="hljs-keyword">java.util.ArrayList</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">18</span>:          <span class="hljs-number">7771</span>         <span class="hljs-number">248672</span>  com.sun.<span class="hljs-keyword">jna.Structure$AutoAllocated</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">19</span>:         <span class="hljs-number">15131</span>         <span class="hljs-number">242096</span>  <span class="hljs-keyword">java.lang.Integer</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">20</span>:          <span class="hljs-number">7074</span>         <span class="hljs-number">226368</span>  <span class="hljs-keyword">java.util.HashMap$Node</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">21</span>:          <span class="hljs-number">3969</span>         <span class="hljs-number">190512</span>  [Loshi.hardware.CentralProcessor$TickType;<br><span class="hljs-symbol">  22:</span>          <span class="hljs-number">2987</span>         <span class="hljs-number">167272</span>  <span class="hljs-keyword">java.util.LinkedHashMap</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">23</span>:          <span class="hljs-number">1277</span>         <span class="hljs-number">146176</span>  <span class="hljs-keyword">java.lang.Class</span><br><span class="hljs-keyword"> </span> <span class="hljs-number">24</span>:          <span class="hljs-number">5978</span>         <span class="hljs-number">144200</span>  [Ljava.lang.reflect.Field;<br>  ......<br><span class="hljs-symbol"> 517:</span>             <span class="hljs-number">1</span>             <span class="hljs-number">16</span>  sun.util.resources.LocaleData<br><span class="hljs-symbol"> 518:</span>             <span class="hljs-number">1</span>             <span class="hljs-number">16</span>  sun.util.resources.LocaleData$LocaleDataResourceBundleControl<br>Total        <span class="hljs-number">710496</span>       <span class="hljs-number">29890984</span><br><br>daiwei@daiweideMacBook-Pro ~ % <span class="hljs-keyword">jmap </span>-dump:format=<span class="hljs-keyword">b,file=dump.hprof </span><span class="hljs-number">34471</span><br>Heap dump file created<br></code></pre></td></tr></table></figure><h4 id="jstack"><a href="#jstack" class="headerlink" title="jstack"></a>jstack</h4><p>jmap å¯ä»¥è¾“å‡ºå †ç©ºé—´çš„ä¿¡æ¯ï¼Œjstack å°±æ˜¯è¾“å‡º<code>æ ˆç©ºé—´</code>çš„ä¿¡æ¯ã€‚æœ€ä¸»è¦ä½¿ç”¨çš„<code>-l</code>å³æ‰“å° jvm ä¸­çš„é”ä¿¡æ¯ï¼Œ<code>-e</code>æ‰“å° jvm ä¸­çš„çº¿ç¨‹ä¿¡æ¯ã€‚</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs routeros">daiwei@daiweideMacBook-Pro ~ % jstack -help<br>Usage:<br>    jstack [-l][-e] &lt;pid&gt;<br>        (<span class="hljs-keyword">to</span> connect <span class="hljs-keyword">to</span> running process)<br><br>Options:<br>    -l  long listing. Prints additional information about locks<br>    -e  extended listing. Prints additional information about threads<br>    -? -h --help -help <span class="hljs-keyword">to</span> <span class="hljs-builtin-name">print</span> this help message<br><br>daiwei@daiweideMacBook-Pro ~ % jstack -l 34979<br>2021-05-22 21:49:23<br>Full thread dump Java HotSpot(TM) 64-Bit<span class="hljs-built_in"> Server </span>VM (25.231-b11 mixed mode):<br><br><span class="hljs-string">&quot;Attach Listener&quot;</span> #11 daemon <span class="hljs-attribute">prio</span>=9 <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff5270d5800 <span class="hljs-attribute">nid</span>=0xa803 waiting on condition [0x0000000000000000]<br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>    - None<br><br><span class="hljs-string">&quot;Service Thread&quot;</span> #10 daemon <span class="hljs-attribute">prio</span>=9 <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff526079800 <span class="hljs-attribute">nid</span>=0x3e03 runnable [0x0000000000000000]<br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>    - None<br><br><span class="hljs-string">&quot;C1 CompilerThread3&quot;</span> #9 daemon <span class="hljs-attribute">prio</span>=9 <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff526040800 <span class="hljs-attribute">nid</span>=0x3c03 waiting on condition [0x0000000000000000]<br>   java.lang.Thread.State: RUNNABLE<br><br>   Locked ownable synchronizers:<br>    - None<br><br><span class="hljs-built_in">..</span><span class="hljs-built_in">..</span>.<br><br><span class="hljs-string">&quot;main&quot;</span> #1 <span class="hljs-attribute">prio</span>=5 <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528809000 <span class="hljs-attribute">nid</span>=0xf03 waiting on condition [0x0000700001c52000]<br>   java.lang.Thread.State: TIMED_WAITING (sleeping)<br>    at java.lang.Thread.sleep(Native Method)<br>    at io.daiwei.TestCPULoadMain.main(TestCPULoadMain.java:21)<br><br>   Locked ownable synchronizers:<br>    - None<br><br><span class="hljs-string">&quot;VM Thread&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528840800 <span class="hljs-attribute">nid</span>=0x5003 runnable<br><br><span class="hljs-string">&quot;GC task thread#0 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff52880a800 <span class="hljs-attribute">nid</span>=0x2607 runnable<br><br><span class="hljs-string">&quot;GC task thread#1 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528816000 <span class="hljs-attribute">nid</span>=0x2503 runnable<br><br><span class="hljs-string">&quot;GC task thread#2 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528816800 <span class="hljs-attribute">nid</span>=0x2303 runnable<br><br><span class="hljs-string">&quot;GC task thread#3 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528817000 <span class="hljs-attribute">nid</span>=0x2a03 runnable<br><br><span class="hljs-string">&quot;GC task thread#4 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528817800 <span class="hljs-attribute">nid</span>=0x5403 runnable<br><br><span class="hljs-string">&quot;GC task thread#5 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528818800 <span class="hljs-attribute">nid</span>=0x5203 runnable<br><br><span class="hljs-string">&quot;GC task thread#6 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528819000 <span class="hljs-attribute">nid</span>=0x2c03 runnable<br><br><span class="hljs-string">&quot;GC task thread#7 (ParallelGC)&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528819800 <span class="hljs-attribute">nid</span>=0x2e03 runnable<br><br><span class="hljs-string">&quot;VM Periodic Task Thread&quot;</span> <span class="hljs-attribute">os_prio</span>=31 <span class="hljs-attribute">tid</span>=0x00007ff528875000 <span class="hljs-attribute">nid</span>=0x5503 waiting on condition<br><br>JNI global references: 375<br></code></pre></td></tr></table></figure><h4 id="jcmd"><a href="#jcmd" class="headerlink" title="jcmd"></a>jcmd</h4><p>ä»€ä¹ˆä½ è¯´å‘½ä»¤å¤ªå¤šè®°ä¸ä½ï¼Ÿæ²¡å…³ç³»ã€‚jcmd æ˜¯ä¸€ä¸ªå‘½ä»¤çš„èšåˆï¼Œé‡Œé¢æœ‰å¾ˆå¤šçš„ optionï¼ŒåŸºæœ¬ä¸Šå‰é¢çš„å‘½ä»¤éƒ½å¯ä»¥ç”¨ jcmd è¾“å‡ºï¼Œæ¥çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs vim">daiwei@daiweideMacBook-Pro ~ % jcmd -<span class="hljs-keyword">help</span><br>Usage: jcmd &lt;pid | main class&gt; &lt;<span class="hljs-keyword">command</span> ...|PerfCounter.<span class="hljs-keyword">print</span>|-<span class="hljs-keyword">f</span> <span class="hljs-keyword">file</span>&gt;<br>   <span class="hljs-built_in">or</span>: jcmd -<span class="hljs-keyword">l</span><br>   <span class="hljs-built_in">or</span>: jcmd -h<br><br>  <span class="hljs-keyword">command</span> must <span class="hljs-keyword">be</span> <span class="hljs-keyword">a</span> valid jcmd <span class="hljs-keyword">command</span> <span class="hljs-keyword">for</span> the selected jvm.<br>  Use the <span class="hljs-keyword">command</span> <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">to</span> see which commands are available.<br>  If the pid <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>, commands will <span class="hljs-keyword">be</span> sent <span class="hljs-keyword">to</span> <span class="hljs-keyword">all</span> Java processes.<br>  The main class <span class="hljs-keyword">argument</span> will <span class="hljs-keyword">be</span> used <span class="hljs-keyword">to</span> <span class="hljs-keyword">match</span> (either partially<br>  <span class="hljs-built_in">or</span> fully) the class used <span class="hljs-keyword">to</span> start Java.<br>  If <span class="hljs-keyword">no</span> <span class="hljs-keyword">options</span> are given, lists Java processes (same <span class="hljs-keyword">as</span> -<span class="hljs-keyword">l</span>).<br><br>  PerfCounter.<span class="hljs-keyword">print</span> <span class="hljs-keyword">display</span> the counters exposed by this process<br>  -<span class="hljs-keyword">f</span>  <span class="hljs-keyword">read</span> <span class="hljs-built_in">and</span> <span class="hljs-keyword">execute</span> commands from the <span class="hljs-keyword">file</span><br>  -<span class="hljs-keyword">l</span>  <span class="hljs-keyword">list</span> JVM processes <span class="hljs-keyword">on</span> the local machine<br>  -? -h --<span class="hljs-keyword">help</span> <span class="hljs-keyword">print</span> this <span class="hljs-keyword">help</span> message<br>  <br>daiwei@daiweideMacBook-Pro ~ % jcmd <span class="hljs-number">34979</span><br><span class="hljs-number">34979</span>:<br>The following commands are available:<br>JFR.<span class="hljs-keyword">stop</span><br>JFR.start<br>JFR.dump<br>JFR.check<br>VM.native_memory<br>VM.check_commercial_features<br>VM.unlock_commercial_features<br>ManagementAgent.<span class="hljs-keyword">stop</span><br>ManagementAgent.start_local<br>ManagementAgent.start<br>VM.classloader_stats<br>GC.rotate_log<br>Thread.<span class="hljs-keyword">print</span><br>GC.class_stats<br>GC.class_histogram<br>GC.heap_dump<br>GC.finalizer_info<br>GC.heap_info<br>GC.run_finalization<br>GC.run<br>VM.uptime<br>VM.dynlibs<br>VM.flags<br>VM.system_properties<br>VM.command_line<br>VM.<span class="hljs-keyword">version</span><br><span class="hljs-keyword">help</span><br><br>For more information about <span class="hljs-keyword">a</span> specific <span class="hljs-keyword">command</span> use <span class="hljs-string">&#x27;help &lt;command&gt;&#x27;</span>.<br><br># <span class="hljs-keyword">help</span> å‘½ä»¤<br>daiwei@daiweideMacBook-Pro ~ % jcmd <span class="hljs-number">34979</span> <span class="hljs-keyword">help</span> GC.heap_info<br><span class="hljs-number">34979</span>:<br>GC.heap_info<br>Provide generic Java heap information.<br><br>Impac<span class="hljs-variable">t:</span> Medium<br><br>Permission: java.lang.management.ManagementPermission(monitor)<br><br>Syntax: GC.heap_info<br><br># cmd å‘½ä»¤ä½¿ç”¨ è¿™é‡Œå°±æ˜¯å‰é¢æåˆ°çš„ï¼Œjmap ä¸­ç§»é™¤çš„å‘½ä»¤ï¼Œè¾“å‡ºå †å†…å­˜ä¿¡æ¯ã€‚<br>daiwei@daiweideMacBook-Pro ~ % jcmd <span class="hljs-number">34979</span> GC.heap_info<br><span class="hljs-number">34979</span>:<br> PSYoungGen      total <span class="hljs-number">76288</span>K, used <span class="hljs-number">47314</span>K [<span class="hljs-number">0</span>x000000076ab00000, <span class="hljs-number">0</span>x0000000770000000, <span class="hljs-number">0</span>x00000007c0000000)<br>  eden space <span class="hljs-number">65536</span>K, <span class="hljs-number">55</span>% used [<span class="hljs-number">0</span>x000000076ab00000,<span class="hljs-number">0</span>x000000076cebc930,<span class="hljs-number">0</span>x000000076eb00000)<br>  from space <span class="hljs-number">10752</span>K, <span class="hljs-number">99</span>% used [<span class="hljs-number">0</span>x000000076eb00000,<span class="hljs-number">0</span>x000000076f578010,<span class="hljs-number">0</span>x000000076f580000)<br>  <span class="hljs-keyword">to</span>   space <span class="hljs-number">10752</span>K, <span class="hljs-number">0</span>% used [<span class="hljs-number">0</span>x000000076f580000,<span class="hljs-number">0</span>x000000076f580000,<span class="hljs-number">0</span>x0000000770000000)<br> ParOldGen       total <span class="hljs-number">175104</span>K, used <span class="hljs-number">4582</span>K [<span class="hljs-number">0</span>x00000006c0000000, <span class="hljs-number">0</span>x00000006cab00000, <span class="hljs-number">0</span>x000000076ab00000)<br>  object space <span class="hljs-number">175104</span>K, <span class="hljs-number">2</span>% used [<span class="hljs-number">0</span>x00000006c0000000,<span class="hljs-number">0</span>x00000006c0479a48,<span class="hljs-number">0</span>x00000006cab00000)<br> Metaspace       used <span class="hljs-number">7205</span>K, capacity <span class="hljs-number">7438</span>K, committed <span class="hljs-number">7552</span>K, reserved <span class="hljs-number">1056768</span>K<br>  class space    used <span class="hljs-number">759</span>K, capacity <span class="hljs-number">838</span>K, committed <span class="hljs-number">896</span>K, reserved <span class="hljs-number">1048576</span>K<br></code></pre></td></tr></table></figure><h3 id="å›¾å½¢åŒ–å·¥å…·"><a href="#å›¾å½¢åŒ–å·¥å…·" class="headerlink" title="å›¾å½¢åŒ–å·¥å…·"></a>å›¾å½¢åŒ–å·¥å…·</h3><p>å›¾å½¢åŒ–å·¥å…·å¯ä»¥ä»¥å›¾è¡¨çš„å½¢å¼æ›´ç›´è§‚çš„æŠŠç›‘æ§æ•°æ®å±•ç°å‡ºæ¥ï¼ŒJDKè‡ªå¸¦çš„å›¾å½¢åŒ–å·¥å…·ä¸»è¦åŒ…æ‹¬ <code>jconsole</code>ã€<code>jvisualvm</code>ã€<code>jmc</code>ã€‚è¿™äº›å·¥å…·éƒ½æä¾›äº†ä¸°å¯Œçš„åŠŸèƒ½ï¼Œæ–¹ä¾¿å¼€å‘è€…å¯¹ JVM è¿›è¡Œç›‘æ§ã€‚</p><blockquote><p>jmc åœ¨ JDK11 ä»¥ä¸Šç‰ˆè¢«è¢«ç§»é™¤ï¼Œç‹¬ç«‹ä½œä¸ºä¸€ä¸ªç¨‹åºåŒ…æä¾›ã€‚ JDK 11 ä¾æ—§æœ‰ jmc è¿™ä¸ªå‘½ä»¤ä½†æ˜¯æ‰“ä¸å¼€ã€‚ jmc æˆ‘ä»¬ä¸‹è½½äº†ç‹¬ç«‹è½¯ä»¶åŒ…ï¼Œè¿›è¡Œæ“ä½œã€‚åŒæ—¶ä¸‹é¢çš„æ‰€æœ‰æ —å­éƒ½åŸºäº jdk11 è¿›è¡Œæµ‹è¯•ã€‚</p></blockquote><h4 id="jconsole"><a href="#jconsole" class="headerlink" title="jconsole"></a>jconsole</h4><p>åœ¨å‘½ä»¤è¡Œè¾“å…¥<code>jconsole</code>å³å¯æ‰“å¼€ï¼Œæ‰“å¼€åå¯ä»¥é€‰æ‹©æœ¬åœ° JVM ç›´æ¥è¿æ¥ä¹Ÿå¯ä»¥é€‰æ‹©ï¼ŒJMX çš„æ–¹å¼è¿œç¨‹è¿æ¥ JVMã€‚ä¸‹é¢è¿™å¼ å›¾å°±æ˜¯æ‰“å¼€æœ¬åœ° JVM ç›‘æ§çš„æ¦‚è§ˆé¡µé¢ï¼Œå…¶ä¸­å›¾ä¸­æœ‰6ä¸ª tab é¡µï¼Œåˆ†åˆ«æ˜¯<code>æ¦‚è§ˆ</code>ã€<code>å†…å­˜</code>ã€<code>çº¿ç¨‹</code>ã€<code>ç±»</code>ã€<code>VMæ¦‚è¦</code>ã€<code>Mbean</code>ï¼Œä»æ¦‚è¿°è¿™ä¸ªé¡µé¢ä¸Šèƒ½çœ‹åˆ°å †å†…å­˜ä½¿ç”¨é‡ã€çº¿ç¨‹ã€ç±»ã€CPU å ç”¨ç‡çš„ç³»ç»ŸæŒ‡æ ‡æ•°æ®ã€‚</p><ul><li><code>å †å†…å­˜ä½¿ç”¨é‡</code> è¿™é‡Œæ˜¯å‰é¢æåˆ°çš„ Java å †å†…å­˜çš„ä½¿ç”¨æƒ…å†µã€‚</li><li><code>çº¿ç¨‹</code> å½“å‰ JVM ä¸­æ´»è·ƒçš„çº¿ç¨‹æ•°ã€‚</li><li><code>ç±»</code> JVM åŠ è½½çš„ç±»çš„ä¸ªæ•°ã€‚</li><li><code>CPUå ç”¨ç‡</code> å½“å‰ç‰©ç†æœºçš„ CPU ä½¿ç”¨æƒ…å†µã€‚</li></ul><p>å›¾ä¸­è¿˜æœ‰å¤šä¸ªæ—¶é—´èŒƒå›´çš„é€‰é¡¹å¯ä»¥é€‰æ‹©ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº 1åˆ†é’Ÿã€5åˆ†é’Ÿã€10åˆ†é’Ÿã€30åˆ†é’Ÿã€1å°æ—¶ã€2å°æ—¶ â€¦â€¦ 1å¤©ã€7å¤© â€¦â€¦ 1ä¸ªæœˆ â€¦â€¦ 1å¹´ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210523105811.png"></p><p>ç¬¬äºŒä¸ªé¢æ¿æ˜¯<code>å†…å­˜</code> è¿™ä¸ªéƒ¨åˆ†æä¾›äº†å¾ˆå¤šçš„å›¾è¡¨ï¼Œå±•ç¤ºäº†å„ä¸ªå†…å­˜éƒ¨åˆ†çš„ä½¿ç”¨æƒ…å†µã€‚æˆ‘è¿™é‡Œè¢«ç›‘æ§åº”ç”¨ä½¿ç”¨çš„æ˜¯ jdk8 ï¼ŒGCæ˜¯é»˜è®¤çš„ parallelGC æ‰€ä»¥è¿™é‡Œå±•ç¤º PS XXX å†…å­˜å›¾è¡¨ï¼Œè¿˜æœ‰ä¸€äº› MetaSpaceã€CodeCacheã€CCS éå †éƒ¨åˆ†å†…å­˜ä½¿ç”¨é‡å›¾ ã€‚å³ä¸Šè§’æœ‰ä¸ª<code>æ‰§è¡ŒGC</code>çš„æŒ‰é’®ï¼Œè¿™ä¸ªæŒ‰é’®å¯ä»¥ç›´æ¥è§¦å‘ JVM çš„ <code>fullGC</code>ï¼Œå³ä¸‹çš„æ•°æ®å°±æ˜¯æ•´ä¸ªå †æŒ‰ç…§å †å’Œéå †é€»è¾‘åˆ’åˆ†åï¼Œå„ä¸ªéƒ¨åˆ†å†…å­˜ä½¿ç”¨æƒ…å†µçš„æŸ±çŠ¶å›¾ï¼Œæˆ‘ä»¬å †é€»è¾‘å†…å­˜åŒºçš„å‘½å<code>å †</code>ä¸<code>éå †</code>ä¹Ÿæ˜¯ä»è¿™æ¥çš„ã€‚å·¦ä¸‹çš„è¯¦ç»†ä¿¡æ¯åˆ™æ˜¯å †ç©ºé—´ GC çš„ç®€å•ç»Ÿè®¡ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210523110244.png"></p><p>ç¬¬ä¸‰ä¸ªé¢æ¿æ˜¯<code>çº¿ç¨‹æœ‰å…³</code>ä¿¡æ¯ï¼Œä¸ŠåŠéƒ¨åˆ†æ˜¯ä¸€ä¸ªæŠ˜çº¿å›¾ï¼Œå±•ç¤ºJVMä¸­æ´»è·ƒå’Œå³°å€¼çš„çº¿ç¨‹æ•°é‡ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯æ´»è·ƒçš„çŠ¶æ€ä»¥åŠå †æ ˆè¿½è¸ªã€‚å…¶ä¸­é¢æ¿çš„ä¸‹åŠéƒ¨åˆ†æœ‰ä¸ª<code>æ­»é”æ£€æµ‹</code>çš„æŒ‰é’®ï¼Œå¯ä»¥ç”¨æ¥æ£€æµ‹å½“å‰JVM ä¸­æ˜¯å¦å­˜åœ¨æ­»é”ã€‚</p><p>  <img src="https://gitee.com/realDaiwei/img/raw/master/20210524154459.png"></p><p>ç¬¬å››ä¸ªé¢æ¿æ˜¯<code>ç±»åŠ è½½</code>æƒ…å†µï¼Œä¸ŠåŠéƒ¨åˆ†æ˜¯ç±»åŠ è½½æ•°é‡çš„æŠ˜çº¿å›¾ï¼Œä¸‹åŠéƒ¨åˆ†æ˜¯è¯¦ç»†æ•°æ®çš„è¾“å‡ºã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524155552.png"></p><p><code>VMæ¦‚è¿°</code> è¿™ä¸ªéƒ¨åˆ†å±•ç¤ºè™šæ‹Ÿæœºå†…éƒ¨çš„ä¸€äº›æ¦‚è¦ä¿¡æ¯ï¼ŒåŒ…æ‹¬çº¿ç¨‹ã€å †æ ˆå†…å­˜ã€ç‰©ç†æœºçš„ä¸€äº›å’ŒJVMçš„å‚æ•°ç­‰ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524155942.png"></p><p>MBean çš„æ˜¯ä¸€äº› manage Bean çš„ä¸€äº›è¯¦æƒ…ä¿¡æ¯ã€‚</p><h4 id="jvisualvm"><a href="#jvisualvm" class="headerlink" title="jvisualvm"></a>jvisualvm</h4><p>jvisualvm å’Œ jconsole éƒ½æ˜¯ JDK æ‰“åŒ…çš„ç›‘æ§å›¾å½¢åŒ–å·¥å…·ã€‚è¿™ä¸ªç›‘æ§å·¥å…·æˆ‘æ„Ÿè§‰ç”¨ä¸‹æ¥æ¯” jconsole æ›´å‹å¥½ä¸€äº›ï¼Œjconsole æœ‰ä¸ªåŠŸèƒ½ä»–åŸºæœ¬éƒ½æœ‰ï¼Œå¹¶ä¸” jvisualvm è¿˜å¢åŠ äº†<code>æŠ½æ ·å™¨</code>å’Œ<code>VM dumpåˆ†æ</code>çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å¯¹è¿è¡Œçš„ JVM è¿›è¡Œå–æ ·åˆ†æã€‚jvisualvm çš„å·¦è¾¹éƒ¨åˆ†æ˜¯åº”ç”¨ç¨‹åºçš„èœå•æ ï¼Œé™¤äº†æœ¬åœ°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ†æè¿œç¨‹çš„JVMï¼ŒVMæ ¸å¿ƒ dumpç­‰ï¼Œå¯ä»¥å¯¹æœ¬åœ°æˆ–è€…å–æ ·å‡ºçš„ JVM æ•°æ®è¿›è¡Œåˆ†æã€‚æˆ‘ä»¬è¿™é‡Œé€‰æ‹© TestCPULoadMain çš„ JVM å®ä¾‹è¿›è¡Œåˆ†æã€‚åœ¨å³è¾¹æ˜¯è¯¦æƒ…é¡µé¢ï¼Œä¸Šé¢æœ‰å‡ ä¸ªtabé¡µé¢ï¼Œæœ‰<code>æ¦‚è¿°</code>ã€<code>ç›‘æ§</code>ã€<code>çº¿ç¨‹</code>ã€<code>æŠ½æ ·å™¨</code>ã€<code>Profiler</code>ï¼Œå…¶ä¸­æŠ½æ ·å™¨æ˜¯ç”¨æ¥åšæŠ½æ ·åˆ†æï¼Œå¯ä»¥æŠ½æ ·å †ç©ºé—´æ•°æ®å’Œçº¿ç¨‹çš„æ•°æ®ï¼ŒProfiler ç”¨æ¥è¿›è¡Œæ€§èƒ½æŠ½æ ·åˆ†æã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524161742.png"></p><p>è¿™é‡Œå¾ˆç›´æ¥çš„æ„Ÿå—åˆ° jvisualvm çš„ä¸€ä¸ªä¼˜ç‚¹ï¼Œjvisualvm æ˜¯å½©è‰²çš„ï¼ï¼jvisualvmåœ¨ç›‘æ§é¡µé¢æŠŠ<code>CPU</code>ã€<code>å †/MetaSpace</code>ã€<code>ç±»</code>ã€<code>çº¿ç¨‹</code>è¿™å››ä¸ªçš„æŠ˜çº¿å›¾å…¨éƒ¨å±•ç¤ºå‡ºæ¥äº†ï¼Œè€Œä¸æ˜¯åƒ jconsole éœ€è¦ä¸€ä¸ªä¸ªé€‰æ‹©åˆ‡æ¢ã€‚å…¶ä¸­ç›‘æ§çš„é¡¹æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰å‹¾é€‰ã€‚è¿™é‡Œå¤„ç†åŸºæœ¬çš„ç›‘æ§æ•°æ®å±•ç¤ºï¼Œé¡µé¢ä¸Šè¿˜æœ‰ä¸¤ä¸ªæŒ‰é’®åˆ†åˆ«æ˜¯<code>æ‰§è¡Œåƒåœ¾å›æ”¶</code> å’Œ <code>å †Dump</code>ã€‚å’Œjconsoleä¸€æ ·ï¼Œæ‰§è¡Œåƒåœ¾å›æ”¶å¯ä»¥ç›´æ¥è§¦å‘ JVM çš„<code>fullGC</code>è€Œ<code>å †Dump</code>å¯ä»¥ç›´æ¥<code>dumpå½“å‰å †ç©ºé—´</code>ã€‚ç›¸æ¯”äº jconsole å‹å¥½å¤ªå¤šã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524162959.png"></p><p>åŒæ—¶ jvisualvm å¯¹äºçº¿ç¨‹çš„ç›‘æ§ä¹Ÿéå¸¸å‹å¥½ï¼Œä¹Ÿéƒ½æ˜¯å½©è‰²çš„ã€‚åŒæ—¶ä¹Ÿæä¾›äº†<code>çº¿ç¨‹Dump</code> çš„æŒ‰é’®ï¼Œç”¨äºdump å½“å‰çš„çº¿ç¨‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524163015.png"></p><p>ä¸Šé¢è¿™ä¸¤ä¸ªé¢æ¿éƒ½æœ‰ Dump æ“ä½œï¼Œç‚¹å‡» dump ä¹‹åå¯ä»¥ç›´æ¥è·³è½¬åˆ°ä¸€ä¸ªæ–°çš„é¢æ¿ç›´æ¥å±•ç¤º dump åçš„æ•°æ®ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524170053.png"></p><p>æŠ½æ ·å™¨çš„é¡¾åæ€ä¹‰ï¼Œåœ¨JVM è¿è¡ŒæœŸé—´ï¼Œå¯¹æŸä¸ªæ—¶é—´æ®µè¿›è¡ŒæŠ½æ ·ï¼ŒæŠ½æ ·ç›®æ ‡çš„æ•°æ®ä¿¡æ¯ï¼ŒæŠ½æ ·çš„å¯¹è±¡åŒ…æ‹¬<code>CPU</code>å’Œ<code>å†…å­˜</code>ï¼ŒæŠ½æ ·å®Œæˆåç‚¹å‡»<code>å¿«ç…§</code>å³å¯ç”Ÿæˆç”±æŠ½æ ·çš„æ•°æ®ç”Ÿæˆçš„åˆ†æå¿«ç…§ï¼Œå¹¶ä¸”å¯ä»¥è¿›è¡Œå¤šæ¬¡é‡‡æ ·æˆ–è€…å¢é‡é‡‡æ ·æ¥é€‚åº”ä¸åŒçš„æŠ½æ ·éœ€æ±‚ï¼ŒåŒæ—¶åœ¨æŠ½æ ·è¿‡ç¨‹ä¸­ä¹Ÿèƒ½è¿›è¡Œ GC æ“ä½œå’Œ Dump æ“ä½œã€‚æœ€åçš„ profiler å’Œ æŠ½æ ·å™¨åŠŸèƒ½ç±»ä¼¼ç”¨äº JVM æ€§èƒ½çš„æŠ½æ ·åˆ†æã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524171625.png"></p><h4 id="jmcï¼ˆjava-mission-controllerï¼‰"><a href="#jmcï¼ˆjava-mission-controllerï¼‰" class="headerlink" title="jmcï¼ˆjava mission controllerï¼‰"></a>jmcï¼ˆjava mission controllerï¼‰</h4><p>Oracle Java Mission Controlï¼ˆJMCï¼‰æ˜¯ä¸€ç»„åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥åœ¨Oracle JDKä¸Šè¿è¡Œå¹¶ä¸Oracle Java SE Embedded 8è™šæ‹Ÿæœºï¼ˆVMï¼‰è¿›è¡Œäº¤äº’ã€‚è¿™å¥—å·¥å…·æä¾›äº†å¯¹Java SE Embedded 8 VMçš„é«˜çº§ï¼Œç®€å•çš„Javaç›‘è§†å’Œç®¡ç†ï¼Œé€‚ç”¨äºå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒã€‚è¿™ä¸ªå·¥å…·ç›¸è¾ƒäºå‰é¢çš„ jvisualvm æ›´åŠ å¼ºå¤§ã€‚æœ‰æ›´å¤šçš„ç›‘æ§é¡¹ï¼Œåœ¨ jvisualvm æˆ‘ä»¬æåˆ°äº†ä¸€ä¸ªæŠ½æ ·çš„åŠŸèƒ½ï¼Œè€Œè¿™ä¸ªåŠŸèƒ½åœ¨ jmc ç›´æ¥å‡çº§æˆäº† <code>javaé£è¡Œè®°å½•ï¼ˆJFRï¼‰</code> ã€‚JMC åœ¨ jdk 8 ä¹‹åçš„ç‰ˆæœ¬éƒ½æ˜¯ä»¥ç‹¬ç«‹è½¯ä»¶åŒ…çš„å½¢å¼æä¾›ï¼Œä¼ é€é—¨ ===&gt;<a href="http://jdk.java.net/jmc/8/">ä¸‹è½½åœ°å€</a>ã€‚</p><blockquote><p>jmc æˆ‘ä¹‹å‰æ€ä¹ˆå°è¯•éƒ½æ˜¯ç¿»è½¦éƒ½æ²¡æœ‰æˆåŠŸçš„æ‰“å¼€ï¼Œä½†æ˜¯è¿™æ¬¡æˆ‘æ‰“å¼€äº†ã€‚è®°å½•ä¸‹æˆ‘çš„ç¯å¢ƒ ï¼ˆmacos BigSur 11.3.1 (20E241) + jdk 1.8.0.231ï¼‰</p></blockquote><p>jms çš„Mbean æ¦‚è§ˆé¡µé¢æ˜¯ä¸‰ä¸ªä»ªè¡¨ç›˜ï¼Œåˆ†åˆ«æ˜¯å †å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ CPU ä½¿ç”¨ç‡ï¼Œæœ€è¿‘ä¸€æ¬¡ youngGC å¯¹è±¡å­˜æ´»çš„æ¯”ä¾‹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524185656.png"></p><p><code>JFR</code>JVM å†…ç½®çš„æ•°æ®æ”¶é›†å¼•æ“ï¼Œæ­£å¦‚è¿™ä¸ªåå­—ä¸€æ · JFRï¼ˆJava flight recoderï¼‰ ä¼šåœ¨è¿è¡ŒæœŸé—´æ”¶é›†JVMå’ŒJava åº”ç”¨çš„è¿è¡Œæ•°æ®ï¼Œå¸®åŠ©å¼€å‘è€…è¯Šæ–­åˆ†æ Java åº”ç”¨ã€‚ä½¿ç”¨ JFR è¦å…ˆè¿›è¡Œ jfr æ–‡ä»¶çš„å½•åˆ¶ï¼Œç„¶å jmc å¯¹ jfr æ–‡ä»¶è¿›è¡Œåˆ†æå¹¶ä»¥å›¾è¡¨çš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚å…¶ä¸­å·¦è¾¹çš„åˆ†æç»“æœçš„èœå•æ ‘ï¼Œè€Œå³è¾¹åˆ™æ˜¯åˆ†æç»“æœçš„å›¾è¡¨å±•ç¤ºï¼Œå±•ç¤ºçš„æ•°æ®å†…å®¹éå¸¸çš„è¯¦ç»†ã€‚jfr ä¸ä»…å¯ä»¥é€šè¿‡ jmc è¿›è¡Œå½•åˆ¶ï¼Œè¿˜å¯ä»¥é€šè¿‡å‰é¢æåˆ°çš„<code>jcmd</code>å‘½ä»¤è¿›è¡Œå½•åˆ¶ã€‚å½•åˆ¶å®Œæˆä¹‹åå¯¼å…¥åˆ° jmc ä¸­è¿›è¡Œåˆ†æå³å¯ã€‚JFR å¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒå’Œä¸ªäººç”µè„‘ä¸Šå…è´¹ä½¿ç”¨ï¼Œä½†æ˜¯å¦‚æœç”¨äºç”Ÿäº§æœåŠ¡å™¨éœ€è¦å•†ä¸šè®¸å¯è¯ï¼ŒJFRè™½ç„¶å¥½ï¼Œä½†æ˜¯å½•åˆ¶è¿‡ç¨‹å¯¹ä¸­å¯¹æ€§èƒ½è¿˜æ˜¯ä¼šæœ‰ä¸€å®šçš„å½±å“ï¼Œå¤§çº¦ 2% å·¦å³ï¼Œè¿™ä¸ªéœ€è¦æ³¨æ„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210524231602.png"></p><h2 id="å¯è§†åŒ–ç›‘æ§é›†æˆå·¥å…·"><a href="#å¯è§†åŒ–ç›‘æ§é›†æˆå·¥å…·" class="headerlink" title="å¯è§†åŒ–ç›‘æ§é›†æˆå·¥å…·"></a>å¯è§†åŒ–ç›‘æ§é›†æˆå·¥å…·</h2><p>å‰é¢ä»‹ç»äº†JDK è‡ªå¸¦çš„ä¸€äº›ç›‘æ§å·¥å…·ï¼Œå…¶ä¸­åŒ…æ‹¬å‘½ä»¤è¡Œçš„å·¥å…·å’Œä¸€äº›å›¾å½¢åŒ–çš„å·¥å…·ï¼Œä¸Šé¢çš„é™¤äº† JFR æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨ï¼Œå…¶ä»–çš„åŸºæœ¬ä¸Šéƒ½ç”¨ä¸ä¸Šã€‚å› ä¸ºç”Ÿäº§ç¯å¢ƒçš„æœåŠ¡å™¨ä¸æ˜¯è°éƒ½èƒ½è¿ä¸Šçš„ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯è¿ç»´ç®¡ç†ï¼Œé‚£æˆ‘ä»¬è¿˜æœ‰å…¶ä»–çš„æ‰‹æ®µå»æ–¹ä¾¿åœ°ç›‘æ§å—ï¼Ÿæœ‰çš„ï¼Œæˆ‘ä»¬ç”Ÿäº§ä½¿ç”¨çš„æ˜¯ grafana + prometheus çš„ç»„åˆã€‚ä¸‹å›¾æ˜¯ç›‘æ§çš„ JVM dashbord æ˜¯å¯¹ JVM å †ç©ºé—´å’Œçº¿ç¨‹çš„ç›‘æ§ã€‚æœ€ä¸Šé¢çš„æ˜¯CPU ä½¿ç”¨ç‡ï¼Œç»¿è‰²è¡¨ç¤ºSystem CPU ä½¿ç”¨ç‡ï¼Œé»„è‰²è¡¨ç¤ºJVM çš„ CPU ä½¿ç”¨ç‡ã€‚ä¸‹é¢çš„ä¸¤ä¸ªå›¾è¡¨åˆ™è¡¨ç¤ºå †ç©ºé—´å’Œéå †éƒ¨åˆ†çš„ç©ºé—´ä½¿ç”¨æƒ…å†µã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525005416.png"></p><p>ä¸‹é¢è¿™å¼ å›¾ä¸»è¦å±•ç¤ºäº†çº¿ä¸ŠçœŸå®çš„JVM GCçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°å †ç©ºé—´æ›²çº¿éšç€æ—¶é—´æ˜¯å‘ˆç°ä¸€ä¸ªé”¯é½¿çŠ¶çš„ã€‚è€Œéå †éƒ¨åˆ†åˆ™æ˜¯ä¸€ç›´éƒ½æ˜¯å¹³ç›´çš„ï¼Œè¿™æ˜¯åƒåœ¾å›æ”¶å™¨åœ¨å †ä¸­å·¥ä½œçš„ç»“æœã€‚ä¸‹é¢çš„ä¸¤ä¸ªæŠ˜çº¿å›¾åˆ™åˆ†åˆ«æ˜¯GCæ¬¡æ•°å’ŒGCæ—¶é•¿çš„ç»Ÿè®¡å›¾ï¼Œä½†çœ‹åˆ°è¿™ä¸ªå›¾çš„æ—¶å€™æˆ‘æœ‰ä¸€ç‚¹ç–‘æƒ‘çš„åœ°æ–¹ï¼Œå †ç©ºé—´èƒ½æ¸…æ¥šçš„çœ‹åˆ°æ¯æ¬¡åƒåœ¾çš„å›æ”¶äº§ç”Ÿçš„æ›²çº¿ä¸‹é™ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä»–ä¸‹é¢çš„è®°å½•GCæ¬¡æ•°çš„å›¾ä¸­å´æ²¡æœ‰å‘¢ï¼Ÿåæ¥æˆ‘æŸ¥äº†çº¿ä¸Šçš„çš„GCæ—¥å¿—ï¼Œç¡®è®¤æ˜¯GC countä¸­æ¼è®°äº†ã€‚æœ‰å“ªä½å¤§ç¥çŸ¥é“è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Œå¸®æˆ‘ç­”ç–‘è§£æƒ‘ä¸€ä¸‹ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯GC countå’ŒGC timeå›¾è¡¨ä¸‹é¢çš„<code>PS MarkSweep</code>å’Œ <code>PS Scavenge</code> ï¼Œè¿™åˆ†åˆ«ä»£è¡¨è¿™ Parallel GC çš„è€å¹´ä»£å›æ”¶å™¨å’Œæ–°ç”Ÿä»£å›æ”¶å™¨ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525005443.png"></p><p>JVM dashbord è¿˜æœ‰å¾ˆå¤šçš„å›¾è¡¨ï¼Œè¿™äº›éƒ½æ˜¯å¯ä»¥é…ç½®çš„ï¼Œä½†æ˜¯éƒ½æ˜¯å¯¹å †æ ˆçº¿ç¨‹çš„ç›‘æ§ã€‚å½“ç„¶ grafana è¿˜å¯ä»¥é›†æˆå…¶ä»–ç±»å‹çš„ç›‘æ§ï¼Œæ¯”å¦‚ä¸»æœºèµ„æºã€eså’Œhttpè¯·æ±‚ç­‰ç›‘æ§å†…å®¹éå¸¸ä¸°å¯Œã€‚ä½†æ˜¯grafana æˆ–è€… datadog è¿™ç§ç›‘æ§é›†æˆå·¥å…·ä¹Ÿå°±æ˜¯åªæœ‰å±•ç¤ºçš„åŠŸèƒ½ï¼Œå®ƒå¹¶ä¸å…·å¤‡åƒ JFR æˆ– jvisualvm æŠ½æ ·åˆ†æçš„åŠŸèƒ½ã€‚å¦‚æœçœŸçš„å‡ºç°äº†é—®é¢˜è¿˜æ˜¯è¦dumpå†…å­˜çº¿ç¨‹æˆ–è€…å¼€å¯JFRè¿›è¡Œæ’æŸ¥åˆ†æã€‚</p><h2 id="å†…å­˜æ³„æ¼åˆ†æå®ä¾‹"><a href="#å†…å­˜æ³„æ¼åˆ†æå®ä¾‹" class="headerlink" title="å†…å­˜æ³„æ¼åˆ†æå®ä¾‹"></a>å†…å­˜æ³„æ¼åˆ†æå®ä¾‹</h2><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€æ®µä¼šä¸æ–­äº§ç”Ÿåƒåœ¾çš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬è®¾ç½® JVM çš„å¯åŠ¨å‚æ•°ä¸º <code>-Xmx128m -Xms128m -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=./heap.hprof</code> ï¼ˆjdk8ï¼‰ã€‚è¿™æ®µå‚æ•°é™åˆ¶çš„å †ç©ºé—´çš„å¤§å°ä¸º<code>128m</code>ï¼Œå¹¶ä¸”åœ¨å †ç©ºé—´æº¢å‡ºæ—¶dumpå †å†…å­˜åˆ°<code>./heap.hprof</code>ä¸­ã€‚åƒåœ¾ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> class GCLogAnalysis &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Random <span class="hljs-built_in">random</span> = <span class="hljs-keyword">new</span> Random();<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span>[] args) &#123;<br>        <span class="hljs-comment">// å½“å‰æ¯«ç§’æ—¶é—´æˆ³</span><br>        <span class="hljs-keyword">long</span> startMillis = System.currentTimeMillis();<br>        <span class="hljs-comment">// æŒç»­è¿è¡Œæ¯«ç§’æ•°; å¯æ ¹æ®éœ€è¦è¿›è¡Œä¿®æ”¹</span><br>        <span class="hljs-keyword">long</span> timeoutMillis = TimeUnit.SECONDS.toMillis(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">// ç»“æŸæ—¶é—´æˆ³</span><br>        <span class="hljs-keyword">long</span> endMillis = startMillis + timeoutMillis;<br>        LongAdder counter = <span class="hljs-keyword">new</span> LongAdder();<br>        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;æ­£åœ¨æ‰§è¡Œ...&quot;</span>);<br>        <span class="hljs-comment">// ç¼“å­˜ä¸€éƒ¨åˆ†å¯¹è±¡; è¿›å…¥è€å¹´ä»£</span><br>        <span class="hljs-built_in">int</span> cacheSize = <span class="hljs-number">2000</span>;<br>        <span class="hljs-keyword">Object</span>[] cachedGarbage = <span class="hljs-keyword">new</span> <span class="hljs-keyword">Object</span>[cacheSize];<br>        <span class="hljs-comment">// åœ¨æ­¤æ—¶é—´èŒƒå›´å†…,æŒç»­å¾ªç¯</span><br>        <span class="hljs-keyword">while</span> (System.currentTimeMillis() &lt; endMillis) &#123;<br>            <span class="hljs-comment">// ç”Ÿæˆåƒåœ¾å¯¹è±¡</span><br>            <span class="hljs-keyword">Object</span> garbage = generateGarbage(<span class="hljs-number">100</span>*<span class="hljs-number">1024</span>);<br>            counter.increment();<br>            <span class="hljs-built_in">int</span> randomIndex = <span class="hljs-built_in">random</span>.nextInt(<span class="hljs-number">2</span> * cacheSize);<br>            <span class="hljs-keyword">if</span> (randomIndex &lt; cacheSize) &#123;<br>                cachedGarbage[randomIndex] = garbage;<br>            &#125;<br>        &#125;<br>        System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">&quot;æ‰§è¡Œç»“æŸ!å…±ç”Ÿæˆå¯¹è±¡æ¬¡æ•°:&quot;</span> + counter.longValue());<br>    &#125;<br><br>    <span class="hljs-comment">// ç”Ÿæˆå¯¹è±¡</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">Object</span> generateGarbage(<span class="hljs-built_in">int</span> <span class="hljs-built_in">max</span>) &#123;<br>        <span class="hljs-built_in">int</span> randomSize = <span class="hljs-built_in">random</span>.nextInt(<span class="hljs-built_in">max</span>);<br>        <span class="hljs-built_in">int</span> type = randomSize % <span class="hljs-number">4</span>;<br>        <span class="hljs-keyword">Object</span> result = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">switch</span> (type) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span>[randomSize];<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[randomSize];<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>                result = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[randomSize];<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder();<br>                <span class="hljs-keyword">String</span> randomString = <span class="hljs-string">&quot;randomString-Anything&quot;</span>;<br>                <span class="hljs-keyword">while</span> (builder.length() &lt; randomSize) &#123;<br>                    builder.<span class="hljs-built_in">append</span>(randomString);<br>                    builder.<span class="hljs-built_in">append</span>(<span class="hljs-built_in">max</span>);<br>                    builder.<span class="hljs-built_in">append</span>(randomSize);<br>                &#125;<br>                result = builder.toString();<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¦‚æœä¸€åˆ‡é¡ºåˆ©å †ç©ºé—´æº¢å‡ºå°±å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª<code>heap.hprof</code>æ–‡ä»¶ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬åˆ†æçš„ç›®æ ‡æ–‡ä»¶äº†ã€‚å‰é¢æˆ‘ä»¬æåˆ°çš„jmcå¯ä»¥ç”¨æ¥åˆ†æ<code>.hprof</code>æ–‡ä»¶ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨<code>Eclipse MAT</code>è¿›è¡Œåˆ†æã€‚ä»¥æˆ‘ä»¬çš„ç»éªŒä¸€èˆ¬å †æ ˆæº¢å‡ºéƒ½æ˜¯å†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥æˆ‘ä»¬é€‰æ‹©æ³„æ¼åˆ†ææŠ¥å‘Šã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525223345.png"></p><p>æ‰“å¼€åç›´æ¥å°±èƒ½çœ‹åˆ° MAT æ ¹æ®å†…å­˜æ•°æ®åˆ†ææ¨æµ‹å‡ºçš„å†…å­˜æ³„æ¼çš„åŸå› ï¼Œä¸‹å›¾å¯ä»¥çœ‹åˆ°<code>Problem Suspect 1</code>å åˆ°äº†<code>99.69%</code>çš„å†…å­˜ï¼Œè™½ç„¶è¿™é‡Œåªæ˜¯åˆšåˆšæ‰“å¼€.hprof æ–‡ä»¶ä½†åŸºæœ¬ä¸Šå¯ä»¥æ¨æµ‹å‡ºå†…å­˜æ³„æ¼çš„åŸå› äº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210526175246.png"></p><p>åœ¨ Suspect Report ä¸­æœ‰å¾ˆå¤šçš„é€‰é¡¹ï¼ŒåŒ…æ‹¬ä¸€äº›<code>çº¿ç¨‹</code>å’Œ<code>å †ç§¯å¯¹è±¡</code>ä¿¡æ¯ã€‚åœ¨è¿™ä¸ªéƒ¨åˆ†åŸºæœ¬å¯ä»¥æ¨æ–­å‡ºç³»ç»Ÿå‘ç”Ÿå†…å­˜æº¢å‡ºçš„åŸå› äº†ã€‚ä¹Ÿå°±æ˜¯æˆ‘ä»¬åƒåœ¾ç”Ÿæˆç±»çš„ä¸»çº¿ç¨‹äº§ç”Ÿäº†å¤ªå¤šçš„åƒåœ¾ï¼Œå¯¼è‡´è¾ƒå°çš„å†…å­˜æº¢å‡ºäº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525224907.png"></p><p>å¦‚æœåˆ°è¿™é‡Œè¿˜æ˜¯ä¸èƒ½ç¡®å®šé—®é¢˜å‘ç”Ÿçš„æ ¹æºæ²¡å…³ç³»ã€‚MAT è¿˜æœ‰ä¸€äº›å…¶ä»–çš„åˆ†ææ–¹å¼ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹ MAT çš„é¦–é¡µä¿¡æ¯ã€‚é¦–å…ˆæœ€ä¸Šé¢æ˜¯ä¸€ä¸ªé¥¼çŠ¶å›¾ï¼Œç„¶åä¸‹é¢æœ‰å„ç§å„æ ·çš„æ“ä½œå’ŒæŠ¥å‘Šå¯ä»¥é€‰æ‹©ï¼Œè¿™é‡Œé¢åŒ…æ‹¬<code>å¯¹è±¡å®ä¾‹çš„æŸ±çŠ¶å›¾</code>ã€<code>å¯¹è±¡çš„æ ‘å½¢ç»“æ„</code>ã€<code>æ‰“å°å¼€é”€æœ€å¤§çš„å‡ ä¸ªå¯¹è±¡</code>å’Œ<code>é‡å¤ç±»åˆ†æ</code>ç­‰ï¼Œè¿˜æœ‰ä¸€äº›åˆ†ææŠ¥å‘Šå¯ä»¥é€‰æ‹©ã€‚åŠŸèƒ½æ–¹é¢è™½ç„¶åˆ†æçš„å†…å®¹æ²¡æœ‰ JFR å…¨é¢ï¼Œä½†æ˜¯é€šå¸¸æ¥è¯´è¿™ä¹ˆå¤šä¿¡æ¯å·²ç»è¶³å¤Ÿå¸®åŠ©æˆ‘ä»¬åˆ†æå‡ºå†…å­˜æ³„æ¼çš„æ ¹æºäº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525225515.png"></p><h2 id="çº¿ä¸Šåˆ†æå·¥å…·"><a href="#çº¿ä¸Šåˆ†æå·¥å…·" class="headerlink" title="çº¿ä¸Šåˆ†æå·¥å…·"></a>çº¿ä¸Šåˆ†æå·¥å…·</h2><h3 id="FastThread"><a href="#FastThread" class="headerlink" title="FastThread"></a>FastThread</h3><p>fastThread æ˜¯ä¸€ä¸ªä¼˜ç§€çš„Java dumpçº¿ç¨‹åˆ†æå·¥å…·ï¼Œåªè¦æŠŠçº¿ç¨‹ dump ä¸Šä¼ ï¼Œå³å¯è¿›è¡Œåœ¨çº¿åˆ†æï¼Œåˆ†æç»“æœéƒ½æ˜¯ä»¥å›¾è¡¨å±•ç¤ºï¼Œå¯å±•ç¤ºé¡¹éå¸¸å¤šå¹¶æ”¯æŒç»“æœ pdf å¯¼å‡ºï¼Œæ˜¯ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„åœ¨çº¿åˆ†æå·¥å…·ã€‚è¿™é‡Œå°±ä¸å…·ä½“å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªå·±åŠ¨æ‰‹å®æ“è¯•è¯•ã€‚ä¼ é€é—¨ ==&gt; <a href="https://fastthread.io/">fastThread</a></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525233153.png"></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525233653.png"></p><h3 id="GCEasy"><a href="#GCEasy" class="headerlink" title="GCEasy"></a>GCEasy</h3><p>GCEasy æ˜¯ä¸€æ¬¾ä¼˜ç§€å¯è§†åŒ–çš„ GC æ—¥å¿—åˆ†æå·¥å…·ï¼Œä½¿ç”¨å‰éœ€è¦æŠŠæ—¥å¿—ä¿¡æ¯ä¸Šä¼ ç„¶åè¿›è¡Œåˆ†æï¼Œåˆ†æç»“æœä»¥å›¾è¡¨çš„æ–¹å¼å±•ç¤ºï¼ŒåŒæ ·ä¹Ÿæ”¯æŒç»“æœ pdf å¯¼å‡ºã€‚GCEasy å’Œ fastThread æ˜¯åŒä¸€å®¶çš„äº§å“ï¼Œä¸¤è€…å›¾è¡¨é£æ ¼æ˜¯ä¸€è‡´çš„ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åŠ¨æ‰‹å®æ“è¯•è¯•ï¼Œå¾ˆæœ‰æ„æ€ã€‚ä¼ é€é—¨ ==&gt; <a href="https://www.gceasy.io/">GCEasy</a></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525235015.png"></p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210525235015.png"></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä¹‹å‰éƒ½ä¸æ˜¯å¾ˆé‡è§† JVM çš„ç›‘æ§ï¼Œä½†æ˜¯é‚£æ¬¡çº¿ä¸Šäº‹æ•…ä¹‹åæˆ‘æ„è¯†åˆ°JVMç›‘æ§çš„é‡è¦æ€§ã€‚è¿™ä¸€å°èŠ‚æˆ‘ä»¬ä¸€èµ·ä»JDKè‡ªå¸¦çš„ç›‘æ§å·¥å…·å¼€å§‹æ¢³ç†ï¼Œå…¶ä¸­å‘½ä»¤è¡Œå·¥å…·åŒ…æ‹¬å¸¸ç”¨çš„ <code>jps</code>ã€<code>jstatck</code>ã€<code>jmap</code>ã€<code>jstat</code>ã€<code>jcmd</code> ç­‰ï¼Œå›¾å½¢åŒ–å·¥å…·åŒ…æ‹¬ <code>jconsole</code>ã€<code>jvisualvm</code>å’Œåæ¥ç‹¬ç«‹è½¯ä»¶åŒ…çš„<code>jmc</code>ï¼Œå…¶ä¸­jmcä¸­çš„<code>jfr</code>åŸºæœ¬å¯ä»¥æ»¡è¶³ç›‘æ§çš„éœ€æ±‚ã€‚jdk æä¾›çš„å·¥å…·åœ¨ç†æƒ³æƒ…å†µä¸‹æ˜¯èƒ½å¤Ÿæ­£å¸¸ç›‘æ§çš„ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™æ˜¯æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ï¼Œä¼šæŠ¥æ— æ³• attach çš„å¼‚å¸¸ï¼Œè¿˜æœ‰æˆ‘ä»¬ä¹Ÿå¹³æ—¶ä¸ä¼šæœ‰ç”Ÿäº§ç¯å¢ƒæœåŠ¡å™¨çš„æƒé™ã€‚æ‰€ä»¥ä»…ä»…ä½¿ç”¨ JDK è‡ªå¸¦çš„å·¥å…·è¿›è¡Œç›‘æ§æ˜¯ä¸å¤ªç°å®çš„ã€‚é‚£æˆ‘ä»¬è¦å¦‚ä½•è¿›è¡Œç›‘æ§å‘¢ï¼Ÿæˆ‘ä»¬ä½¿ç”¨å¯è§†åŒ–é›†æˆå·¥å…·ï¼Œæˆ‘ä»¬æ¼”ç¤ºçš„æ˜¯ <code>grafana</code> é€šè¿‡é›†æˆ <code>prometheus</code> å®ç°å¯¹ JVM åŸºæœ¬ä¿¡æ¯çš„ç›‘æ§ã€‚åŸºæœ¬å¯ä»¥æ»¡è¶³æˆ‘ä»¬å¯¹äºçº¿ä¸ŠæœåŠ¡å¤§ä½“è¿è¡Œæƒ…å†µçš„ç›‘æ§ã€‚å¦‚æœæˆ‘ä»¬çº¿ä¸Šé‡åˆ°äº†é—®é¢˜æˆ‘ä»¬è¦æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿç´§æ¥ç€æˆ‘ä»¬æ¼”ç¤ºäº†ä¸€ä¸ªå†…å­˜æ³„æ¼çš„åˆ†ææ¡ˆä¾‹ï¼Œä½¿ç”¨<code>Eclipse MAT</code>å¯¹ä¸€ä¸ªå†…å­˜æº¢å‡ºçš„<code>.hprof</code>æ–‡ä»¶è¿›è¡Œç®€å•å®ä¾‹åˆ†æã€‚æœ€åæˆ‘ä»¬ç®€å•ä»‹ç»äº†ä¸¤ä¸ªåœ¨çº¿åˆ†æå·¥å…· fastThread å’Œ GCEasyã€‚JVM ç›‘æ§è¿˜æœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å¼€æºå·¥å…·<code>Arthas</code>ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åŠ¨æ‰‹å®è·µã€‚</p><p>è¿™ä¸€å°èŠ‚æœ‰å¤§é‡çš„åŠ¨æ‰‹å®è·µï¼Œå†åŠ ä¸Šæˆ‘æœ€è¿‘ä¹ŸæŒºå¿™çš„ï¼Œè¿™ä¸€å°èŠ‚æˆ‘å†™äº†å¥½ä¹…å¥½ä¹…ğŸ˜…ğŸ˜…ã€‚ç»ˆäºè¦è¿›å…¥ JVM å¾ˆç²¾å½©çš„GCæ¨¡å—äº†ï¼Œæ¢³ç†å®ŒGCæ¨¡å—ä»€ä¹ˆJVMè°ƒä¼˜ï¼ŒGCåˆ†æå°±éƒ½ä¸æ˜¯äº‹äº†ã€‚åŠ æ²¹ï¼Œä½ çš„åŠªåŠ›ç»ˆç©¶ä¼šç…§äº®ä½ çš„ç”Ÿæ´»ï¼Œæ™šå®‰ï½</p>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM å†…å­˜ç»“æ„ä¸å†…å­˜æ¨¡å‹åˆæ­¥</title>
    <link href="/2021/05/17/java-memory-structure-and-basic-model/"/>
    <url>/2021/05/17/java-memory-structure-and-basic-model/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å‰é¢çš„å°èŠ‚ä¸­ï¼Œæ€»ç»“æ¢³ç†äº† JVM åº•å±‚çš„ä¸€äº›åŸºç¡€çš„ä¸œè¥¿ï¼ŒåŒ…æ‹¬ JVM å­—èŠ‚ç æŠ€æœ¯ï¼Œæ–¹æ³•çš„è°ƒç”¨ï¼Œåå°„ï¼Œå¼‚å¸¸ç­‰æ–¹æ³•æµç¨‹ï¼ŒåŸºç¡€çš„æœ€åä¸€éƒ¨åˆ†æ¢³ç†äº†ç±»åŠ è½½æœºåˆ¶å’Œå¯¹è±¡çš„å†…å­˜å¸ƒå±€ã€‚æœ‰äº†è¿™ä¸€å¥—æœºåˆ¶ JVM èƒ½å¤Ÿé¡ºåˆ©çš„è¯»å–Javaæ–‡ä»¶ï¼Œå¹¶è¡Œæ‰§è¡Œé€»è¾‘ã€‚çœ‹èµ·æ¥éƒ½æœ‰äº†ï¼Œä½†æ˜¯å°‘äº†ä¸€ä¸ªé‡è¦çš„éƒ¨åˆ†æ²¡é”™ï¼Œå°±æ˜¯å†…å­˜ã€‚è¿™è®¡ç®—æœºçš„å†…å­˜è¿™ä¸ªéƒ¨åˆ†æ¥çš„åƒç†æ‰€å½“ç„¶ä¸€æ ·ã€‚å…¶å®æœ€åŸå§‹çš„è®¡ç®—æœºæ˜¯æ²¡æœ‰å†…å­˜è¿™ä¸ªæ¦‚å¿µçš„ï¼Œåæ¥å†¯è¯ºä¾æ›¼æå‡ºäº†å†¯è¯ºä¾æ›¼ç»“æ„ï¼Œå†¯è¯ºä¾æ›¼ç¡®å®šäº†è®¡ç®—æœºçš„ç»“æ„ï¼Œå³ç¡®å®šäº†è®¡ç®—æœºçš„ 5 å¤§éƒ¨ä»¶ï¼Œå³<code>è¿ç®—å™¨</code>ã€<code>æ§åˆ¶å™¨</code>ã€<code>å­˜å‚¨å™¨</code>ã€<code>è¾“å…¥è®¾å¤‡</code>å’Œ<code>è¾“å‡ºè®¾å¤‡</code>ã€‚ç°ä»£è®¡ç®—æœºçš„éƒ½æ˜¯éµå¾ªå†¯è¯ºä¾æ›¼ç»“æ„çš„ï¼Œå› æ­¤åˆç§°ä¸ºå†¯è¯ºä¾æ›¼æœºã€‚æ‰€ä»¥ä½œä¸ºè™šæ‹Ÿæœºæ€ä¹ˆèƒ½æ²¡æœ‰å†…å­˜å‘¢ï¼ŸJava å†…å­˜æ¨¡å‹è§„å®šäº† JVM åº”è¯¥å¦‚ä½•ä½¿ç”¨è®¡ç®—æœºå†…å­˜ï¼ˆRAMï¼‰ã€‚å¹¿ä¹‰ä¸Šæ¥è®²ï¼ŒJavaå†…å­˜æ¨¡å‹åˆ†åˆ«ä¸ºä¸¤ä¸ªéƒ¨åˆ† <code>JVMå†…å­˜ç»“æ„</code> å’Œ <code>JMMä¸çº¿ç¨‹è§„èŒƒ</code>ã€‚</p><h2 id="JVM-å†…å­˜ç»“æ„"><a href="#JVM-å†…å­˜ç»“æ„" class="headerlink" title="JVM å†…å­˜ç»“æ„"></a>JVM å†…å­˜ç»“æ„</h2><p>JVM å†…å­˜ç»“æ„æ˜¯ JVM çš„åº•å±‚çš„å®ç°ï¼Œå®ƒå†³å®šäº†è¿è¡Œæ—¶æ•°æ®çš„æ•°æ®åŒºåˆ’åˆ†ã€‚é‚£ä¹ˆå¦‚æœè®©ä½ ç»“åˆæˆ‘ä»¬å‰é¢çš„çŸ¥è¯†è®¾è®¡ä¸€ä¸ª JVM ç»“æ„æ¨¡å‹ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿ</p><h3 id="åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ª-JVM-å†…å­˜ç»“æ„"><a href="#åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ª-JVM-å†…å­˜ç»“æ„" class="headerlink" title="åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ª JVM å†…å­˜ç»“æ„"></a>åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ª JVM å†…å­˜ç»“æ„</h3><p>ä»æˆ‘ä»¬å‰é¢æ¢³ç†çš„ JVM æ–¹æ³•è°ƒç”¨å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æ–¹æ³•è°ƒç”¨ä¼šç”¨åˆ°æ ˆï¼Œæ¯ä¸ªæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹æ ˆï¼Œçº¿ç¨‹æ¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ã€‚åœ¨ç±»åŠ è½½é‚£ä¸€å°èŠ‚æˆ‘ä»¬çŸ¥é“äº†å¯¹è±¡å®ä¾‹å­˜åœ¨å †ä¸Šï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜åœ¨æ ˆä¸Šçš„å¼•ç”¨æŒ‡å‘å †ä¸­çš„å®ä¾‹å¯¹è±¡çš„åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå †ç©ºé—´ã€‚æ‰€ä»¥å†…å­˜ç©ºé—´æˆ‘ä»¬å¯ä»¥ç®€å•åˆ’åˆ†ä¸ºæ ˆï¼ˆstackï¼‰ + å †ï¼ˆheapï¼‰ çš„ç»“æ„ï¼ˆ1.0 ç‰ˆæœ¬ï¼‰ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210515190729.png"></p><p>çº¿ç¨‹æ ˆä¸Šæ˜¯æœ‰æ•°æ®çš„ï¼ŒåŒ…æ‹¬ä¸€äº›å±€éƒ¨æ–¹æ³•å†…éƒ¨çš„åŸºç¡€ç±»å‹å˜é‡å’Œä¸€äº›å¯¹è±¡çš„å¼•ç”¨æŒ‡å‘å †ä¸­å®ä¾‹åœ°å€ã€‚ä¸Šé¢è¿™ä¸ªå›¾å¤ªè¿‡äºç²—ç•¥äº†æˆ‘ä»¬åŠ å…¥ä¸€ç‚¹ç‚¹ç»†èŠ‚ã€‚å°±åƒä¸‹å›¾é…±ç´«ï¼Œæ¯ä¸ªæ ˆæœ‰å±€éƒ¨å˜é‡å’Œå¯¹è±¡å¼•ç”¨ï¼Œå¯¹è±¡çš„å¼•ç”¨åœ°å€æŒ‡å‘å †ä¸­ã€‚ï¼ˆ2.0 ç‰ˆæœ¬ï¼‰</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210515192514.png"></p><p>ç»“åˆä¸‹æˆ‘ä»¬ä¹‹å‰æ¢³ç†çš„ç±»åˆå§‹åŒ–å’Œå®ä¾‹å¯¹è±¡æœ‰å…³å†…å­˜çš„éƒ¨åˆ†å†æ¬¡ç®€å•è¿‡ä¸€éã€‚ç±»åŠ è½½å™¨åŠ è½½ç±»å¹¶ä¸”è§£ææˆå­—èŠ‚ç ï¼Œå­—èŠ‚ç ä¸­ä¼šæœ‰ä¼šæœ‰æµç¨‹æ§åˆ¶æ–¹æ³•å­—èŠ‚ç å’Œå¸¸é‡æ± ç­‰ä¿¡æ¯ã€‚å…¶ä¸­æ–¹æ³•åå’Œç±»åéƒ½ä¼šå…ˆç”¨å¸¸é‡ä»£æ›¿ï¼Œç„¶ååœ¨ç±»åŠ è½½çš„è§£æé˜¶æ®µæ›¿æ¢æˆå¼•ç”¨ã€‚æœ€åå®ä¾‹å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæ ¹æ®ç±»çš„ class çš„å¸¸é‡ä¿¡æ¯åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå®ä¾‹å¯¹è±¡ã€‚å®ä¾‹å¯¹è±¡ä¸»è¦æœ‰ä¸‰ä¸ªéƒ¨åˆ†å¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®ã€å¡«å……æ•°æ®ã€‚è¿™é‡Œé¢å¯¹è±¡å¤´é‡Œé¢åˆæœ‰ä¸€ä¸ª markWord å’Œ classPointerï¼ŒclassPointer æŒ‡å‘æ–¹æ³•åŒºä¸­å®ä¾‹çš„ class å¯¹è±¡ã€‚è¿™ä¸€è·¯æ¢³ç†ä¸‹æ¥ä¸éš¾å‘ç°ï¼Œæˆ‘ä»¬å°‘äº†ä¸€ä¸ªå¸¸é‡æ± å’Œä¸€ä¸ªæ–¹æ³•åŒºã€‚æˆ‘ä»¬å†åŠ å…¥ä¸€ç‚¹ç‚¹ç»†èŠ‚ã€‚ï¼ˆ3.0 ç‰ˆæœ¬ï¼‰</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210515195133.png"></p><p>ç»“åˆä¹‹å‰çš„çŸ¥è¯†æˆ‘è®¾è®¡çš„ä¸€ä¸ªç®€å•çš„ JVM å†…å­˜ç»“æ„å°±å‡ºæ¥äº†ï¼Œå¤§å®¶å¯ä»¥æŒ‰ç…§è‡ªå·±çš„ç†è§£åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ªå†…å­˜ç»“æ„ï¼Œä¸€å®šä¼šæœ‰ä¸ä¸€æ ·çš„æ”¶è·ã€‚ </p><h3 id="JVM-å†…å­˜ç»“æ„æ¦‚è¿°"><a href="#JVM-å†…å­˜ç»“æ„æ¦‚è¿°" class="headerlink" title="JVM å†…å­˜ç»“æ„æ¦‚è¿°"></a>JVM å†…å­˜ç»“æ„æ¦‚è¿°</h3><p> å‰é¢æ˜¯ç»“åˆ JVM çš„å­—èŠ‚ç ç±»åŠ è½½ç­‰æœºåˆ¶æ„æƒ³è®¾è®¡å‡ºæ¥çš„ JVM å†…å­˜ï¼ŒçœŸæ­£çš„ JVM å†…å­˜å¯èƒ½ä¸é•¿è¿™ä¸ªæ ·å­ï¼Œé‚£çœŸæ­£çš„ JVM å†…å­˜ç»“æ„é•¿ä»€ä¹ˆæ ·å­å‘¢ï¼Ÿå› ä¸ºæˆ‘åœ¨ä¹‹å‰è¿˜æ˜¯æœ‰æ¥è§¦è¿‡ä¸€äº› JVM å†…å­˜ç»“æ„è¿™å—çš„çŸ¥è¯†ï¼Œä¹‹å‰çš„çŸ¥è¯†å·²ç»ç»™æˆ‘çš„è®¾è®¡æ‰“ä¸‹ä¸€ä¸ªå¤§è‡´çš„æ–¹å‘äº†ï¼Œæ‰€ä»¥æˆ‘ç”»å‡ºæ¥çš„ JVM çš„åŸºæœ¬é€»è¾‘ç»“æ„å’Œæˆ‘ä»¬è®¾è®¡çš„å¤§ä½“çš„æ–¹å‘ä¸Šè¿˜æ˜¯ä¸€è‡´çš„ã€‚JVM å†…å­˜ç»“æ„é€»è¾‘ä¸Šå¤§ä½“åˆ†ä¸ºï¼šçº¿ç¨‹æ ˆï¼ˆstackï¼‰å’Œ å †å†…å­˜ï¼ˆheapï¼‰ä¸¤ä¸ªéƒ¨åˆ†ã€‚ä¹Ÿå°±æ˜¯ 1.0 ç‰ˆæœ¬ä¸€è‡´ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210515190729.png" alt="image.png"></p><p>JVM ä¸­ï¼ŒçœŸåœ¨è¿è¡Œçš„æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹æ ˆã€‚çº¿ç¨‹æ ˆä¸ŠåŒ…å«æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•é“¾/è°ƒç”¨é“¾ä¸Šçš„æ‰€æœ‰æ–¹æ³•çš„çŠ¶æ€ä¿¡æ¯ã€‚æ‰€æœ‰çº¿ç¨‹æ ˆåˆè¢«æˆä¸º<code>æ–¹æ³•æ ˆ</code>æˆ–<code>è°ƒç”¨æ ˆ</code>ï¼ˆcall stackï¼‰ã€‚çº¿ç¨‹åœ¨æ‰§è¡Œä»£ç çš„æ—¶å€™ï¼Œè°ƒç”¨æ ˆä¸­çš„ä¿¡æ¯ä¼šä¸€ç›´å˜æ¢ã€‚æˆ‘ä»¬æŠ›å‡ºå¼‚å¸¸æ—¶æ‰“å°å‡ºçš„å †æ ˆä¿¡æ¯ä¹Ÿå°±æ˜¯è¿™ä¸ªæ–¹æ³•è°ƒç”¨æ ˆã€‚</p><p>çº¿ç¨‹æ ˆä¸Šä¿å­˜äº†è°ƒç”¨é“¾ä¸Šçš„æ­£åœ¨æ‰§è¡Œçš„æ‰€æœ‰æ–¹æ³•çš„å±€éƒ¨å˜é‡ã€‚</p><ul><li>æ¯ä¸ªçº¿ç¨‹åªèƒ½è®¿é—®è‡ªå·±çš„çº¿ç¨‹æ ˆã€‚</li><li>æ¯ä¸ªçº¿ç¨‹æ ˆéƒ½ä¸èƒ½è®¿é—®ï¼ˆçœ‹ä¸è§ï¼‰å…¶ä»–çš„çº¿ç¨‹çš„å±€éƒ¨å˜é‡ã€‚</li></ul><p>å³æ—¶ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œå…¨ç›¸åŒçš„ä»£ç ï¼Œä»–ä»¬ä¹Ÿçœ‹ä¸åˆ°å½¼æ­¤çš„å±€éƒ¨å˜é‡ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåœ¨è‡ªå·±çš„çº¿ç¨‹<code>æ ˆå†…åˆ›å»º</code>ä»£ç ä¸­å¯¹åº”çš„å±€éƒ¨å˜é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æ ˆä¸­çš„æ•°æ®åªæ˜¯ä¸€ä¸ª<code>å‰¯æœ¬</code>ï¼Œçº¿ç¨‹ä¸çº¿ç¨‹ä¹‹é—´å¹¶ä¸å…±äº«ã€‚</p><ul><li>æ‰€æœ‰çš„åŸç”Ÿæ•°æ®å˜é‡éƒ½å­˜å‚¨åœ¨çº¿ç¨‹æ ˆä¸­ï¼Œå› æ­¤å¯¹å…¶ä»–çº¿ç¨‹ä¸å¯è§ã€‚</li><li>çº¿ç¨‹æ ˆå¯ä»¥å°†ä¸€ä¸ªåŸç”Ÿå˜é‡çš„å‰¯æœ¬ä¼ ç»™å¦å¤–ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†ä¸å…±äº«åŸç”Ÿå˜é‡å‰¯æœ¬æœ¬èº«ã€‚</li><li>å †ä¸­åŒ…å«äº†Java ä»£ç ä¸­åˆ›å»ºçš„æ‰€æœ‰å¯¹è±¡ï¼Œä¸ç®¡æ˜¯å“ªä¸ªçº¿ç¨‹åˆ›å»ºçš„ï¼Œå…¶ä¸­ä¹Ÿæ¶µç›–äº†åŒ…è£…ç±»å‹ï¼ˆä¾‹å¦‚ Byteã€Integerã€Boolean ç­‰ï¼‰ã€‚</li><li>ä¸ç®¡æ˜¯åˆ›å»ºç»™å±€éƒ¨å˜é‡ï¼Œè¿˜æ˜¯åˆ›å»ºå¯¹è±¡èµ‹ç»™å±€éƒ¨å˜é‡ï¼Œåˆ›å»ºçš„å¯¹è±¡éƒ½ä¼šä¿å­˜åœ¨å †ä¸­ã€‚</li></ul><blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼ŒåŸç”Ÿæ•°æ®ç±»å‹å’Œå¯¹è±¡å¼•ç”¨åœ¨çº¿ç¨‹æ ˆä¸Šï¼Œå®ä¾‹å¯¹è±¡ï¼Œå¯¹è±¡æˆå‘˜æ¥ã€ç±»å®šä¹‰å’Œé™æ€å˜é‡éƒ½åœ¨å †ä¸Šã€‚çº¿ç¨‹æ ˆä¸Šçš„æ•°æ®æ˜¯å‰¯æœ¬ï¼Œæ‰€ä»¥çº¿ç¨‹ä¹‹é—´ç›¸äº’éš”ç¦»ã€‚</p></blockquote><p>å †å†…å­˜åˆç§°ä¸º<code>å…±äº«å †</code>ï¼Œ<code>å †ä¸­çš„æ‰€æœ‰å¯¹è±¡å¯ä»¥è¢«æ‰€æœ‰çš„çº¿ç¨‹è®¿é—®åˆ°</code>ï¼Œåªè¦ä»–ä»¬èƒ½æ‹¿åˆ°å¯¹è±¡çš„å¼•ç”¨åœ°å€ã€‚</p><ul><li>å¦‚æœä¸€ä¸ªçº¿ç¨‹èƒ½è®¿é—®åˆ°æŸä¸ªå¯¹è±¡ï¼Œä¹Ÿå°±å¯ä»¥è®¿é—®è¯¥å¯¹è±¡çš„æˆå‘˜å˜é‡ã€‚</li><li>å¦‚æœä¸¤ä¸ªçº¿ç¨‹èƒ½åŒæ—¶è°ƒç”¨åŒä¸€ä¸ªæ–¹æ³•ï¼Œåˆ™å®ƒä»¬å®ƒä»¬éƒ½å¯ä»¥è®¿é—®åˆ°è¿™ä¸ªå¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œä½†æ¯ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡å‰¯æœ¬éƒ½æ˜¯ç‹¬ç«‹çš„ã€‚ï¼ˆæ–¹æ³•ä¼ å…¥åŒä¸€å¯¹è±¡ï¼Œåªè¦æ˜¯åŒä¸€å¼•ç”¨å°±éƒ½èƒ½çœ‹è§ã€‚ï¼‰</li></ul><p>æŠŠä¸Šé¢è¿™äº›ä¸œè¥¿è½å®åˆ°å›¾ä¸Šå°±æ˜¯æˆ‘ä»¬çš„ 2.0 ç‰ˆæœ¬ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210515192514.png"></p><blockquote><p>ç®€å•å°æ€»ç»“ä¸‹ï¼šè™½ç„¶å„ä¸ªçº¿ç¨‹è‡ªå·±ä½¿ç”¨çš„å±€éƒ¨å˜é‡éƒ½åœ¨è‡ªå·±çš„çº¿ç¨‹æ ˆä¸Šï¼Œä½†æ˜¯å¤§å®¶å¯ä»¥å…±äº«å †ä¸Šçš„å¯¹è±¡ã€‚å¦‚æœä¸åŒçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯¹è±¡å®ä¾‹çš„åŸºç¡€ç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå¹¶å¾€è‡ªå·±çš„çº¿ç¨‹æ ˆä¸Šèµ‹å€¼ï¼Œå®ä¾‹å¯¹è±¡ä¼šç»™çº¿ç¨‹ä¸€ä¸ªå˜é‡å‰¯æœ¬ã€‚</p></blockquote><h3 id="æ ˆå†…å­˜ç»“æ„"><a href="#æ ˆå†…å­˜ç»“æ„" class="headerlink" title="æ ˆå†…å­˜ç»“æ„"></a>æ ˆå†…å­˜ç»“æ„</h3><p>å‰é¢æˆ‘ä»¬è‡ªå·±å°è¯•è®¾è®¡çš„æ ˆç»“æ„éå¸¸çš„ç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªç®€å•æ ˆçš„æ•°æ®ç»“æ„ï¼Œå®é™…ä¸Šå¹¶ä¸å®Œå…¨æ˜¯è¿™æ ·ã€‚ç»“åˆå‰é¢æ–¹æ³•è°ƒç”¨éƒ¨åˆ†çš„çŸ¥è¯†ï¼Œæ ˆçš„é€»è¾‘åŒºåŸŸé‡Œåº”è¯¥æœ‰å¾ˆå¤šçš„çº¿ç¨‹æ ˆï¼Œæ¯•ç«Ÿä¸€ä¸ªçº¿ç¨‹å°±ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ ˆï¼ˆè°ƒç”¨ JNI æ–¹æ³•ä¼šä½¿ç”¨ Native æ ˆï¼‰ã€‚è€Œä¸”çº¿ç¨‹æ ˆé‡Œé¢åº”è¯¥ä¹Ÿä¼šæœ‰å¾ˆå¤šçš„æ ˆå¸§ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“æ¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•å°±ä¼šåˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œå°±ç±»ä¼¼ä¸‹é¢è¿™æ ·çš„ä¸€ä¸ªç»“æ„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210516153009.png"></p><p>æˆ‘ä»¬çŸ¥é“è°ƒç”¨æ–¹æ³•å°±ä¼šåˆ›å»ºæ ˆå¸§ï¼Œæ ˆå¸§é‡Œé¢æœ‰<code>æ“ä½œæ•°æ ˆ</code>ï¼Œ<code>å±€éƒ¨å˜é‡è¡¨</code>å’Œä¸€ä¸ª<code>class/methodå¼•ç”¨</code>ï¼Œæœ‰äº†è¿™äº›è¿˜ä¸å¤Ÿè¿™äº›åªèƒ½ä¿è¯æ–¹æ³•çš„é¡ºåˆ©æ‰§è¡Œï¼Œæ–¹æ³•æ‰§è¡Œä¹‹åè¿˜è¦è¿”å›ã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ä¸ª<code>è¿”å›åœ°å€</code>ã€‚æ‰€ä»¥æ ˆå¸§å†…éƒ¨çš„å›¾å¤§è‡´æ˜¯è¿™æ ·çš„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210516154106.png"></p><h3 id="å †å†…å­˜çš„ç»“æ„"><a href="#å †å†…å­˜çš„ç»“æ„" class="headerlink" title="å †å†…å­˜çš„ç»“æ„"></a>å †å†…å­˜çš„ç»“æ„</h3><p>åœ¨ä¸Šé¢çš„çº¿ç¨‹çš„åˆ†æå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ JVM è¿›ç¨‹é‡Œé¢æœ‰å †å†…å­˜å’Œéå †å†…å­˜ï¼Œè¿™ä¸ªéå †åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåˆ«ç€æ€¥æˆ‘ä»¬æ…¢æ…¢å¾€ä¸‹çœ‹ã€‚åœ¨å‰é¢çš„æ¦‚è¿°ä»‹ç»å †çš„æ—¶å€™è¯´å †æ˜¯å¯¹æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸã€‚å¤§å®¶éƒ½çŸ¥é“æˆ‘ä»¬ JVM æ˜¯ä¼šè‡ªåŠ¨GCçš„ï¼Œä¸ä¼šåœ¨è¢«å¼•ç”¨æˆ–è€…è¯´æ­»æ‰çš„å¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œä½†æ˜¯æ‰€æœ‰çš„å¯¹è±¡ä»–ä»¬å‘¢ç”Ÿå‘½å‘¨æœŸéƒ½æ˜¯ä¸€æ ·çš„å—ï¼Ÿä¼šä¸ä¼šå­˜åœ¨ä¸€äº›æ°¸è¿œä¸ä¼šè¢«å›æ”¶çš„å¯¹è±¡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å­˜åœ¨çš„ã€‚åœ¨å‰é¢çš„ç±»åŠ è½½çš„å°èŠ‚ä¸­æˆ‘ä»¬è¯´è¿‡ï¼ŒJVM ä¼šæŠŠç±»åŠ è½½è¿›å†…å­˜ï¼Œä¼šåˆ›å»º Class å¯¹è±¡å¹¶ä¸”ä¼šä¿å­˜ç±»å¸¸é‡æ± ä¸­çš„å¸¸é‡ã€‚å¦‚æœæˆ‘ä»¬è¿™éƒ¨åˆ†çš„æ•°æ®è¢« GC äº†ï¼Œé‚£æˆ‘ä»¬é‡åˆ°æ‰€æœ‰çš„éœ€è¦åŠ è½½ç±»çš„åœºæ™¯åˆå°†é‡æ–°åŠ è½½ã€‚è¿™å°†æå¤§å½±å“ JVM æ•´ä½“çš„æ€§èƒ½ã€‚æ‰€ä»¥è¿™é‡Œçš„å †ä¹Ÿè¢«ç§°ä¸ºï¼šGC ç®¡ç†çš„å †ï¼ˆGC Heapï¼‰ã€‚å¦‚æœå †å’Œæ ˆçš„é€»è¾‘åˆ’åˆ†æ˜¯å»ºç«‹åœ¨çº¿ç¨‹æ˜¯å¦å¯ä»¥å…±äº«çš„çº¬åº¦é€»è¾‘ä¸Šï¼Œé‚£ä¹ˆå †å’Œéå †çš„é€»è¾‘åˆ’åˆ†å°±æ˜¯å»ºç«‹å®ä¾‹å¯¹è±¡ç”Ÿå‘½å‘¨æœŸçš„çº¬åº¦ä¸Šçš„ã€‚</p><p>ä¸ºäº†æœ€é«˜åŒ–çš„æé«˜ GC çš„æ•ˆç‡ï¼Œå †ä¹Ÿåˆ’åˆ†é™¤äº†æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œå°±åƒè¿™ä¸ªå­—é¢æ„æ€ä¸€æ ·ï¼Œæ–°ç”Ÿä»£éƒ½æ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åœ¨æ–°ç”Ÿä»£ç»å†å‡ æ¬¡GCï¼Œå¦‚æœä»–ä»¬è¿˜æ´»ç€é‚£ä¹ˆå®ƒä»¬å°†è¿›å…¥è€å¹´ä»£ã€‚ä½†è¿™ä¹Ÿä¸ç»å¯¹ï¼Œåœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸‹æ–°åˆ›å»ºçš„å¯¹è±¡ä¼šç›´æ¥è¿›å…¥è€å¹´ä»£ã€‚</p><p>éå †æœ¬è´¨ä¸Šè¿˜æ˜¯å †ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸å½’ GC ç®¡ç†ã€‚é‡Œé¢å¤§è‡´åˆ’åˆ†ä¸º3ä¸ªå†…å­˜æ± ã€‚</p><ul><li><code>Metaspace</code>, ä»¥å‰å«æŒä¹…ä»£(æ°¸ä¹…ä»£, Permanent generation), Java8æ¢äº†ä¸ªåå­—å« Metaspace.  Java8å°†æ–¹æ³•åŒºç§»åŠ¨åˆ°äº†MetaåŒºé‡Œé¢ï¼Œè€Œæ–¹æ³•åˆæ˜¯classçš„ä¸€éƒ¨åˆ†ã€‚ã€‚ã€‚å’ŒCCSäº¤å‰äº†? </li><li><code>CCS, Compressed Class Space,</code> å­˜æ”¾classä¿¡æ¯çš„ï¼Œå’Œ Metaspace æœ‰äº¤å‰ã€‚ </li><li><code>Code Cache</code>, å­˜æ”¾ JIT ç¼–è¯‘å™¨ç¼–è¯‘åçš„æœ¬åœ°æœºå™¨ä»£ç ã€‚ </li></ul><h3 id="å…¶ä»–éƒ¨åˆ†å’Œé¸Ÿç°-JVM-å†…å­˜"><a href="#å…¶ä»–éƒ¨åˆ†å’Œé¸Ÿç°-JVM-å†…å­˜" class="headerlink" title="å…¶ä»–éƒ¨åˆ†å’Œé¸Ÿç° JVM å†…å­˜"></a>å…¶ä»–éƒ¨åˆ†å’Œé¸Ÿç° JVM å†…å­˜</h3><p>é™¤äº†æ ˆå’Œå † JVM è¿˜æœ‰ä¸€ä¸ª <code>PC è®¡æ•°å™¨</code> è¿™ä¸ªè®¡æ•°å™¨ç±»ä¼¼äº CPU çš„å¯„å­˜å™¨ï¼Œ<code>ç”¨äºè®°å½•ä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®</code>ã€‚åœ¨æ—©æœŸçš„CPU éƒ½æ˜¯å•æ ¸çš„ï¼Œé‚£å¦‚æœå®ç°å¤šçº¿ç¨‹å‘¢ï¼Ÿæ²¡é”™ï¼Œä½¿ç”¨åˆ‡æ¢æ‰§è¡Œä¸Šä¸‹æ–‡çš„æ–¹å¼ ã€‚æ‰€ä»¥ PC è®¡æ•°å™¨è®°å½•çš„å°±æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œè®© CPU åˆ‡æ¢å›æ¥çš„æ—¶å€™èƒ½ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚è¿˜æœ‰ä¸€ä¸ªéƒ¨åˆ†å°±æ˜¯ç›´æ¥å†…å­˜ã€‚ç›´æ¥å†…å­˜ä¸æ˜¯è¿è¡Œæ—¶æ•°æ®çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaå†…å­˜è§„èŒƒã€‹ä¸­å®šä¹‰çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒæ˜¯ JVM ç›´æ¥å‘å†…å­˜ç”³è¯·çš„ç©ºé—´ã€‚ä¸€èˆ¬ä¸ä¼šç›´æ¥æ“ä½œï¼Œä½†æ˜¯åœ¨Nettyä¸­æœ‰ç›¸å…³çš„é…ç½®å‚æ•°ã€‚ç»“åˆä¸Šé¢æ‰€æœ‰çš„æ¢³ç†çš„ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥è¯•ç€ç”»å‡ºä¸€ä¸ªå¤§è‡´çš„ JVM å†…å­˜å›¾äº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210516164240.png"></p><h3 id="å†…å­˜æº¢å‡ºåˆ†æ"><a href="#å†…å­˜æº¢å‡ºåˆ†æ" class="headerlink" title="å†…å­˜æº¢å‡ºåˆ†æ"></a>å†…å­˜æº¢å‡ºåˆ†æ</h3><p>Java è™½ç„¶æœ‰å…¨è‡ªåŠ¨çš„ GCï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½é¿å…å†…å­˜æº¢å‡ºçš„é—®é¢˜ã€‚é‚£å¦‚ä½•è§£å†³å†…å­˜æº¢å‡ºçš„é—®é¢˜ï¼Œè¦æƒ³è§£å†³è¿™ä¸ªé—®é¢˜å…ˆè¦ææ˜ç™½å†…å­˜æº¢å‡ºæ˜¯ä»€ä¹ˆï¼Ÿå†…å­˜æº¢å‡ºï¼ˆOOMï¼‰æŒ‡çš„æ˜¯å½“ç¨‹åºéœ€è¦çš„å†…å­˜ä¸­å­˜åœ¨è¿‡å¤šæ— æ³•å›æ”¶çš„å†…å­˜ï¼Œæœ€ç»ˆä½¿å¾—<code>å†…å­˜éœ€è¦çš„ç©ºé—´å¤§äºç³»ç»Ÿèƒ½æä¾›çš„æœ€å¤§ç©ºé—´</code>ï¼Œè¿™æ—¶å€™ä¸€èˆ¬ç³»ç»Ÿä¼šæŠ›å‡º OOM å¼‚å¸¸ã€‚</p><blockquote><p>è¿™ä¸ªç±»ä¼¼äºå¾ˆæ—©ä¹‹å‰æˆ‘ä»¬å†…å­˜å¾ˆå°çš„æ‰‹æœºåŒæ—¶æ‰“å¼€äº†å¾ˆå¤šçš„åå°åº”ç”¨ï¼Œè¿™ä¸ªæ—¶å€™ä½ åˆæ‰“å¼€äº†ä¸€ä¸ªå¾ˆåƒå†…å­˜çš„æ¸¸æˆï¼Œç„¶åè¿™ä¸ªæ¸¸æˆçªç„¶é—ªé€€äº†ã€‚ã€‚ã€‚è¿™ä¸ªæ—¶å€™å¾€å¾€é€šè¿‡æ‰‹åŠ¨æ¸…ç†åå°æˆ–è€…é‡å¯æ‰‹æœºä¹‹åå†æ¬¡æ‰“å¼€çš„æ–¹å¼è§£å†³ã€‚</p></blockquote><p>å‰æ®µæ—¶é—´çœ‹åˆ°ä¸€ä¸ªé—®é¢˜å†…å­˜æº¢å‡ºå’Œå†…å­˜æ³„æ¼æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å†…å­˜æ³„æ¼è¿™ä¸€å¬å°±çŸ¥é“ä¸æ˜¯ä¸€ä¸ªå¥½è¯ï¼Œå†…å­˜æ³„æ¼<code>å¾€å¾€æŒ‡çš„æ˜¯ç”³è¯·äº†å†…å­˜èµ„æºä¹‹åç”±äºæŸäº›åŸå› è¿Ÿè¿Ÿä¸èƒ½é‡Šæ”¾</code>ã€‚é€ æˆç³»ç»Ÿèµ„æºçš„æµªè´¹ï¼Œå‡æ…¢ç¨‹åºè¿è¡Œé€Ÿåº¦ï¼Œæœ€ç»ˆå¯èƒ½ä¼šå†…å­˜æº¢å‡ºæ‹–å®æ•´ä¸ªç³»ç»Ÿã€‚æ‰€ä»¥å†…å­˜æ³„æ¼æ›´å¤šçš„åå‘æ˜¯ä»£ç å±‚é¢é€ æˆçš„èµ„æºæµªè´¹ï¼Œå†…å­˜æ³„æ¼æœ‰å¯èƒ½ä¼šå¯¼è‡´OOMã€‚</p><blockquote><p>ä¸¤è€…å…³ç³» å†…å­˜æ³„æ¼å¯èƒ½ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºï¼Œå†…å­˜æº¢å‡ºä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå†…å­˜æ³„æ¼ä¸ä¼šï¼Œå¹¶ä¸”å¤§å¤šæ•°æ—¶å€™ç³»ç»Ÿçœ‹ä¸Šå»åƒæ˜¯æ­£å¸¸è¿è¡Œçš„ã€‚</p></blockquote><p>æ‰€ä»¥å“ªäº› JVM é‡Œé¢å“ªäº›åŒºåŸŸä¼šå†…å­˜æ³„æ¼å‘¢ï¼Ÿåœ¨é‚£äº›åŒºåŸŸä¸ä¼šå†…å­˜æº¢å‡ºå‘¢ï¼Ÿåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­åªå®šä¹‰ä¸€ä¸ªåœ°æ–¹ä¸ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºã€‚é‚£å°±æ˜¯ PC è®¡æ•°å™¨ï¼Œå› ä¸º PC è®°å½•å™¨è®°å½•çš„å°±æ˜¯å½“å‰çº¿ç¨‹æ‰§è¡Œçš„ä½ç½®ï¼Œæ‰€ä»¥ PC è®¡æ•°å™¨ä¸­åªä¿å­˜ä¸€ä¸ªæ•°ã€‚è¿™ä¸ªå†…å­˜å¤§å°ä¸ä¼šéšç€ç¨‹åºçš„æ‰§è¡Œè€Œå¢åŠ ã€‚æ¯ç”³è¯·ä¸€ä¸ªçº¿ç¨‹å°±ä¼šåˆ›å»ºä¸€ä¸ª PC è®¡æ•°å™¨ã€‚å…¶ä»–çš„å†…å­˜åŒºåŸŸéšç€ç©ºé—´çš„åˆ†é…éƒ½å¯èƒ½å­˜åœ¨ OOMã€‚</p><h2 id="JMM-å†…å­˜æ¨¡å‹ä»‹ç»"><a href="#JMM-å†…å­˜æ¨¡å‹ä»‹ç»" class="headerlink" title="JMM å†…å­˜æ¨¡å‹ä»‹ç»"></a>JMM å†…å­˜æ¨¡å‹ä»‹ç»</h2><h3 id="CPU-æŒ‡ä»¤ä¸ä¹±åºæ‰§è¡Œ"><a href="#CPU-æŒ‡ä»¤ä¸ä¹±åºæ‰§è¡Œ" class="headerlink" title="CPU æŒ‡ä»¤ä¸ä¹±åºæ‰§è¡Œ"></a>CPU æŒ‡ä»¤ä¸ä¹±åºæ‰§è¡Œ</h3><p>å­¦è®¡ç®—æœºçš„éƒ½çŸ¥é“ï¼ŒåŸºæœ¬ä¸Šè®¡ç®—æœºçš„æŒ‡ä»¤é›†åˆ†ä¸ºä¸¤ç§ï¼Œç²¾ç®€æŒ‡ä»¤é›†å’Œå¤æ‚æŒ‡ä»¤é›†åˆï¼Œå…¶ä¸­ç²¾ç®€æŒ‡ä»¤é›†æ˜¯ä»¥ ARM æ¶æ„ä¸ºä¸»ï¼Œç°åœ¨çš„æ‰‹æœºèŠ¯ç‰‡å’Œè‹¹æœçš„ m1 éƒ½æ˜¯åŸºäº ARM æ¶æ„çš„ï¼Œå…¶ç‰¹ç‚¹å°±æ˜¯åŠŸè€—ä½ä½†æ˜¯æ€§èƒ½è¾ƒå¼±ï¼Œä½†æ˜¯éšç€è¿™å‡ å¹´çš„èŠ¯ç‰‡æŠ€æœ¯çš„æå‡ï¼ŒARM æ¶æ„èŠ¯ç‰‡çš„æ€§èƒ½ä¹Ÿåœ¨é€æ­¥æé«˜ï¼Œä¾‹å¦‚è‹¹æœçš„M1èŠ¯ç‰‡ä¹Ÿå¯ä»¥åŠæ‰“ Intel çš„CPUã€‚å¤æ‚æŒ‡ä»¤é›†çš„ä»£è¡¨å°±æ˜¯ Intel å’Œ AMD çš„ x86 æ¶æ„çš„èŠ¯ç‰‡ï¼ŒåŸºäºå¤æ‚æŒ‡ä»¤é›†çš„ç‰¹ç‚¹å°±æ˜¯åŠŸè€—æ¯”è¾ƒé«˜ï¼Œä½†æ˜¯æ€§èƒ½å¼ºã€‚æˆ‘ä»¬éƒ½çŸ¥é“ CPU æœ‰å¾ˆå¤šçš„æŒ‡ä»¤ï¼Œå®ç°ä¸€ä¸ªæ“ä½œæœ‰å¾ˆå¤šçš„æ–¹å¼ï¼Œå¤æ‚æŒ‡ä»¤é›†æŠŠè¿™äº›æ“ä½œå°æˆä¸€ä¸ªå¤æ‚æŒ‡ä»¤ï¼Œè€ŒåŸºäºç®€å•æŒ‡ä»¤é›†çš„CPUæŠŠè¿™ä¸ªå¤æ‚æ“ä½œæ‹†åˆ†å¤šä¸ªç®€å•æŒ‡ä»¤å»å®Œæˆã€‚ä¸¤è€…éƒ½å¯ä»¥å®Œæˆè¿™ä¸ªæ“ä½œï¼Œä½†æ˜¯ï¼Œå°±æ•ˆç‡è€Œè¨€è¿˜æ˜¯å¤æ‚æŒ‡ä»¤é›†æ›´é«˜ã€‚</p><p>ä¸ç®¡æ˜¯å“ªä¸€ç§æŒ‡ä»¤é›†ï¼ŒCPU çš„æµæ°´çº¿å·¥ä½œæ–¹å¼éƒ½æ˜¯ä¸€è‡´çš„ã€‚å¦‚æœä¸€ä¸ªæ“ä½œçš„æ‰€æœ‰çš„æŒ‡ä»¤éƒ½æ”¾åœ¨ä¸€ä¸ªæµæ°´çº¿ä¸Šï¼Œè¿™æ ·å¾ˆå¤šçš„æµæ°´çº¿å°±æ˜¯é—²ç½®çš„ï¼Œæ‰€ä»¥èªæ˜çš„å¼€å‘è€…æƒ³åˆ°ä¸€ä¸ªåŠæ³•å°±æ˜¯ï¼Œåªè¦ä¿è¯æœ€åçš„æ‰§è¡Œç»“æœæ˜¯æ­£ç¡®çš„ï¼Œä¹±åºæ‰§è¡Œä¹Ÿæ²¡å…³ç³»ã€‚æ‰€ä»¥CPUå®Œå…¨å¯ä»¥æ ¹æ®éœ€è¦é€šè¿‡å†…éƒ¨è°ƒåº¦æŠŠè¿™äº›æŒ‡ä»¤æ‰“ä¹±äº†æ‰§è¡Œï¼Œå……åˆ†åˆ©ç”¨æµæ°´çº¿èµ„æºï¼Œåªè¦æœ€ç»ˆç»“æœæ˜¯ç­‰ä»·çš„é‚£ä¹ˆç¨‹åºçš„æ­£ç¡®æ€§å°±æ²¡æœ‰é—®é¢˜ã€‚ä½†è¿™åœ¨å¦‚ä»Šå¤šCPUå†…æ ¸çš„æ—¶ä»£ï¼Œéšç€å¤æ‚åº¦çš„æå‡ï¼Œå¹¶å‘æ‰§è¡Œçš„ç¨‹åºé¢ä¸´äº†å¾ˆå¤šé—®é¢˜ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210517004750.png"></p><h3 id="JMM-æ¦‚è¿°"><a href="#JMM-æ¦‚è¿°" class="headerlink" title="JMM æ¦‚è¿°"></a>JMM æ¦‚è¿°</h3><p>éšç€å¤šæ ¸æ—¶ä»£çš„åˆ°æ¥å’Œ JVM å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼ŒJVMåœ¨ä¸åŒç¯å¢ƒä¸‹ä¿è¯ç¨‹åºæ‰§è¡Œç»“æœæ­£ç¡®æ€§å˜å¾—è¶Šæ¥è¶Šå¤æ‚ã€‚å› æ­¤ JVM æ¨å‡ºä¸€å¥— Java  å†…å­˜æ¨¡å‹æ¥ç»Ÿä¸€çº¦æŸçº¿ç¨‹ä¹‹é—´å¯è§æ€§ç­‰ä¸€ç³»åˆ—è§„åˆ™ï¼Œæ¥ä¿è¯æœ€ç»ˆæ‰§è¡Œç»“æœçš„æ­£ç¡®æ€§ã€‚JMMè§„èŒƒæ˜ç¡®å®šä¹‰äº†ä¸åŒçš„çº¿ç¨‹ä¹‹é—´ï¼Œé€šè¿‡å“ªäº›æ–¹å¼ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™å¯ä»¥çœ‹è§å…¶ä»–çº¿ç¨‹ä¿å­˜åˆ°å…±äº«å˜é‡ä¸­çš„å€¼ï¼›ä»¥åŠåœ¨å¿…æ—¶å¦‚ä½•å¯¹å…±äº«å˜é‡çš„è®¿é—®è¿›è¡ŒåŒæ­¥ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯å±è”½å„ç§ç¡¬ä»¶å¹³å°å’Œæ“ä½œç³»ç»Ÿä¹‹é—´çš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®ç°äº†Javaå¹¶å‘ç¨‹åºçœŸæ­£çš„è·¨å¹³å°ã€‚ å…¶ä¸­å¹¶å‘ä¸­çš„å¾ˆå¤šçš„å…³é”®å­—åŒ…æ‹¬ synchronziedï¼Œvolatile éƒ½æ˜¯ JMM å®šä¹‰çš„ã€‚è¿™äº›å†…å®¹æˆ‘ä»¬å°†æ”¾åˆ°å¤šçº¿ç¨‹å®æˆ˜éƒ¨åˆ†è¿›è¡Œæ¢³ç†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€å°èŠ‚æˆ‘ä»¬æ‰¿æ¥ä¹‹å‰çš„å­¦çš„å…³äºJavaè¿è¡Œæ—¶æ•°æ®çš„ä¸€äº›çŸ¥è¯†ï¼Œå°è¯•åŠ¨æ‰‹è®¾è®¡ä¸€ä¸ªç®€å•çš„ Java å†…å­˜ç»“æ„ã€‚Java å†…å­˜ç»“æ„åŒ…æ‹¬ å †ã€æ ˆã€PC è®¡æ•°å™¨ï¼Œå…¶ä¸­æ ˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ ˆï¼Œæ ˆä¹Ÿåˆ†æ–¹æ³•æ ˆå’Œ Native æ ˆï¼Œçº¿ç¨‹æ ˆå†…åˆåŒ…æ‹¬å¾ˆå¤šçš„æ ˆå¸§ç”¨äºå­˜å‚¨å½“å‰çº¿ç¨‹æ–¹æ³•è°ƒç”¨çš„æ•°æ®ã€‚å †çš„é€»è¾‘å†…å­˜åŒºä¹Ÿåˆ†å †å’Œéå †ï¼Œå †ä¹Ÿç§°ä¸º GC ç®¡ç†çš„å †ï¼Œå› ä¸ºå †æ˜¯ GC å·¥ä½œçš„åŒºåŸŸï¼Œå †é‡Œé¢ä¹Ÿåˆ†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ã€‚éå †ä¸­ä¸»è¦åŒ…æ‹¬å…ƒæ•°æ®åŒºã€Compressed class space å’Œ code cache ï¼Œå…¶ä¸­å…ƒæ•°æ®åŒºåŸŸä¸»è¦åŒ…æ‹¬æ–¹æ³•åŒºå’Œå¸¸é‡æ± ï¼ŒCCS ä¿å­˜çš„ Class ä¿¡æ¯ï¼ŒCode cache å­˜å‚¨ JIT ç¼–è¯‘åçš„æœºå™¨ç ã€‚æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„ PC è®¡æ•°å™¨ï¼ŒPC è®¡æ•°å™¨è´Ÿè´£è®°å½•å½“å‰ç¨‹åºæ‰§è¡Œçš„ä½ç½®ï¼Œæ–¹ä¾¿ CPU è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢å›æ¥ä¹‹åèƒ½è·³åˆ°æ­£ç¡®çš„ä½ç½®ç»§ç»­æ‰§è¡Œã€‚åœ¨è¿™äº›åŒºåŸŸä¸­ï¼Œé™¤äº†äº†PC è®¡æ•°å™¨æ‰€æœ‰çš„å†…å­˜åŒºåŸŸéƒ½ä¼šå‘ç”Ÿå†…å­˜æº¢å‡ºã€‚æœ€åæˆ‘ä»¬ç®€å•è¿‡äº†ä¸‹ JMM ä¹Ÿå°±æ˜¯ Java å†…å­˜æ¨¡å‹ï¼ŒJMMè§„èŒƒæ˜ç¡®å®šä¹‰äº†ä¸åŒçš„çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§å’Œè®¿é—®åŒæ­¥ï¼Œä¿è¯ JVM åœ¨ä¸åŒçš„ç¯å¢ƒä¸‹éƒ½èƒ½å¾—åˆ°ä¸€è‡´ä¸”æ­£ç¡®çš„ç»“æœã€‚å…·ä½“çš„ JMM çš„ç»†èŠ‚æˆ‘ä»¬æ”¾åœ¨å¹¶å‘ç¼–ç¨‹æ¨¡å—å†æ¥ç»†ç»†çš„æ¢³ç†ã€‚åŠ æ²¹ï¼Œæ™šå®‰ï¼</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/136748306">ä¸‰åˆ†é’Ÿå¸¦ä½ äº†è§£å†¯.è¯ºä¾æ›¼ç»“æ„</a></li><li>Javaå†…å­˜æ¨¡å‹ï¼šæµ·ä¸è¾æ°´ï¼Œæ•…èƒ½æˆå…¶æ·± </li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM åŸºç¡€ â€” ç±»åŠ è½½æœºåˆ¶å’Œå¯¹è±¡å†…å­˜å¸ƒå±€</title>
    <link href="/2021/05/14/class-load-and-jol/"/>
    <url>/2021/05/14/class-load-and-jol/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å‰é¢ä¸€ç¯‡ä¸­æåˆ°äº†æ–¹æ³•çš„è°ƒç”¨ï¼Œæ–¹æ³•åœ¨ç±»åŠ è½½é˜¶æ®µä¼šç”±ç¬¦å·å¼•ç”¨æ›¿æ¢å®é™…å¼•ç”¨æˆ–è€…æ–¹æ³•è¡¨çš„ç´¢å¼•ã€‚Java çš„ç±»åŠ è½½æœºåˆ¶åˆæ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™é‡ŒèŠä¸€ä¸ªå°æ’æ›²ï¼Œæˆ‘è®°å¾—æˆ‘åˆšæ¯•ä¸šé‚£ä¼šå»é¢ä¸­å…´ï¼ŒåŸºç¡€çš„é—®é¢˜éƒ½å›ç­”çš„æŒºå¥½çš„ä½†æ˜¯æœ€åé¢è¯•å®˜é—®äº†æˆ‘è¿™ä¸ªé—®é¢˜ï¼ŒJava è™šæ‹Ÿæœºæ˜¯æ€ä¹ˆåŠ è½½ä¸€ä¸ªç±»çš„ï¼Ÿæˆ‘å½“æ—¶è„‘å­æ‡µäº†ï¼Œå¯¹è±¡æ€ä¹ˆåŠ è½½åˆ°å†…å­˜ï¼Ÿå¯¹è±¡æ˜¯ new å‡ºæ¥çš„çš„å•Šï¼Œè¿˜è¦åŠ è½½ï¼Ÿæˆ‘ä¹Ÿå¯¹è¿™å—ä¸å¤ªäº†è§£ï¼Œç„¶åé¢è¯•å®˜ä¹Ÿå°±æ²¡æ·±äº†é—®ã€‚ä½†æ˜¯ç°åœ¨çœ‹æ¥ï¼Œå¦‚æœæ˜¯è¿›é˜¶ Java çš„è¯è¿™æ˜¯ä¸€ä¸ªåŸºç¡€ä¸èƒ½åœ¨åŸºç¡€çš„é—®é¢˜äº†ã€‚ç±»åŠ è½½äº†è¿™è¿˜ä¸ç®—å®Œï¼ŒJava çš„ç±»æ˜¯æ€ä¹ˆä¿å­˜çš„ï¼Œæˆ‘ç›¸ä¿¡å¾ˆå¤šæœ‹å‹ä¼šå›ç­”å­˜æ”¾åœ¨å †é‡Œï¼Œé‚£å…¶ä»–ç‰¹æ®Šçš„ç±»å‹å‘¢ ä¾‹å¦‚ String ç±»å‹åˆæ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨å†…å­˜æº¢å‡ºçš„æ—¶å€™ï¼Œå¯¹è±¡æ€ä¹ˆå°±æŠŠæˆ‘ä»¬çš„å †ç»™å †æ»¡äº†ï¼Œæ¯ä¸ªå¯¹è±¡å äº†å¤šå¤§çš„ç©ºé—´å‘¢ï¼Ÿè¯·æœ‹å‹ä»¬æ…¢æ…¢å¾€ä¸‹çœ‹ã€‚</p><h2 id="ç±»åŠ è½½æœºåˆ¶"><a href="#ç±»åŠ è½½æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½æœºåˆ¶"></a>ç±»åŠ è½½æœºåˆ¶</h2><p>æƒ³è¦çŸ¥é“ä¸€å¤„çš„ç»†èŠ‚ä¸å¦‚å…ˆé¸Ÿç°å…¨å±€ï¼Œå…ˆäº†è§£ç±»çš„å£°æ˜å‘¨æœŸæ˜¯ä»€ä¹ˆæ ·çš„å…ˆæœ‰ä¸ªå¤§ä½“çš„æ¦‚å¿µã€‚åœ¨äº†è§£çš„ç±»çš„å£°æ˜å‘¨æœŸä¹‹åæ‰èƒ½æ›´å¥½çš„ç†è§£ JVM æ˜¯å¦‚ä½•åŠ è½½ä¸€ä¸ªç±»çš„</p><h3 id="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ç±»çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç±»çš„ç”Ÿå‘½å‘¨æœŸ"></a>ç±»çš„ç”Ÿå‘½å‘¨æœŸ</h3><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210511003453.png"></p><p>ä¸Šé¢è¿™å¼ å›¾æ˜¯éå¸¸ç»å…¸çš„ä¸€å¼ å›¾ï¼Œç±»çš„ç”Ÿå‘½å‘¨æœŸæœ‰7ä¸ªæ­¥éª¤ï¼Œåˆ†åˆ«æ˜¯ <code>åŠ è½½ï¼ˆLoadingï¼‰</code>ã€ <code>éªŒè¯ï¼ˆVerificationï¼‰</code>ã€<code>å‡†å¤‡ï¼ˆPreparationï¼‰</code>ã€<code>è§£æï¼ˆResolutionï¼‰</code>ã€<code>åˆå§‹åŒ–ï¼ˆInitializationï¼‰</code>ã€<code>ä½¿ç”¨ï¼ˆUsingï¼‰</code>ã€<code>å¸è½½ï¼ˆUnloadingï¼‰</code>ã€‚å…¶ä¸­å‰äº”ä¸ªéƒ¨åˆ†ï¼ˆåŠ è½½ã€éªŒè¯ã€å‡†å¤‡ã€è§£æã€åˆå§‹åŒ–ï¼‰ç»Ÿç§°ä¸ºç±»åŠ è½½ã€‚</p><h4 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h4><p>åŠ è½½é˜¶æ®µä¹Ÿç§°ä½œâ€è£…è½½â€é˜¶æ®µã€‚è¿™ä¸ªé˜¶æ®µä¸»è¦çš„æ“ä½œæ˜¯ï¼Œæ›´å…·æ˜ç¡®çŸ¥é“çš„ class å®Œå…¨é™å®šåï¼Œæ¥è·å–ç±»çš„äºŒè¿›åˆ¶çš„ .class æ–‡ä»¶</p><p>ç®€å•æ¥è¯´å°±æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿ/jaråŒ…ä¸­/æˆ–è€…ç½‘è·¯ä¸­ï¼Œä»»ä½•åœ°æ–¹å­˜åœ¨çš„<code>classæ–‡ä»¶</code>ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ä¼šæŠ›å‡º <code>NoClassDefFound</code> é”™è¯¯ã€‚åŠ è½½é˜¶æ®µä¸ä¼šæ£€æŸ¥ classfile çš„æ ¼å¼å’Œè¯­æ³•é—®é¢˜ï¼Œåªæ˜¯å•çº¯çš„åŠ è½½æ–‡ä»¶ã€‚ç±»åŠ è½½çš„æ•´ä¸ªé˜¶æ®µç”± JVM å’Œç±»åŠ è½½å™¨ï¼ˆæŸä¸€ä¸ªï¼‰å…±åŒåä½œå®Œæˆã€‚</p><h4 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h4><p>éªŒè¯é˜¶æ®µä¹Ÿæ˜¯é“¾æ¥è¿‡ç¨‹çš„ç¬¬ä¸€ä¸ªé˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µçš„æ“ä½œé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯ç¡®ä¿ class æ–‡ä»¶çš„å­—èŠ‚æµæ•°æ®æ˜¯ç¬¦åˆè™šæ‹Ÿæœºè¦æ±‚çš„ä¸ä¼šå±å®³åˆ°è™šæ‹Ÿæœºçš„å®‰å…¨ã€‚ç®€å•æ¥è¯´å°±æ˜¯ä¸€äº›æ ¼å¼å’Œè¯­æ³•çš„æ ¡éªŒï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¯èƒ½ä¼šæŠ›å‡º <code>VerifyError</code>ï¼Œ<code>ClassFormatError</code> æˆ– <code>UnsupportedClassVersionError</code>ï¼Œæ³¨æ„è¿™é‡Œæ’é™¤çš„ Error é”™è¯¯ï¼ŒError åªæœ‰è™šæ‹Ÿæœºæ— æ³•æ­£å¸¸æ‰§è¡Œäº†æ‰ä¼šæŠ›å‡ºçš„å¼‚å¸¸ã€‚</p><p>éªŒè¯ä¹Ÿæ˜¯é“¾æ¥çš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªéƒ¨åˆ† JVM å¿…é¡»åŠ è½½æ‰€æœ‰çš„è¶…ç±»å’Œæ¥å£ã€‚å¦‚æœå‘ç°ç±»çš„å±‚æ¬¡ç»“æ„æœ‰é—®é¢˜ JVM ä¼šæŠ›å‡º <code>ClassCircularityError</code>ã€‚è€Œå¦‚æœå®ç°æ¥å£ä¸æ˜¯ä¸€ä¸ª interfaceï¼Œæˆ–è€…å£°æ˜çš„è¶…ç±»ä¸æ˜¯ä¸€ä¸ª interface ä¹Ÿä¼šæŠ›å‡º IncompatibleClassChangeErrorã€‚</p><h4 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h4><p>åœ¨è¿™ä¸ªé˜¶æ®µä¼šåˆ›å»ºé™æ€å­—æ®µå¹¶ä¸ºå…¶åˆå§‹åŒ–æ ‡å‡†é»˜è®¤å€¼ï¼ˆæ¯”å¦‚ <code>null</code> æˆ–è€… 0ï¼‰ï¼Œå¹¶åˆ†é…æ–¹æ³•è¡¨ï¼ŒåŠåœ¨æ–¹æ³•åŒºä¸­åˆ†é…è¿™äº›æ–¹æ³•çš„ä½¿ç”¨çš„<code>å†…å­˜ç©ºé—´</code>ã€‚âš ï¸ è¯·æ³¨æ„ï¼Œåœ¨è¿™ä¸ªé˜¶æ®µæ²¡æœ‰æ‰§è¡Œä»»ä½•çš„ Java ä»£ç ã€‚</p><h4 id="è§£æ"><a href="#è§£æ" class="headerlink" title="è§£æ"></a>è§£æ</h4><p>ç„¶åJVM ä¼šè¿›å…¥å¯é€‰çš„è§£æç¬¦å·å¼•ç”¨é˜¶æ®µã€‚ä¹Ÿå°±æ˜¯è§£æç±»æ–‡ä»¶é‡Œé¢çš„å¸¸é‡æ± ï¼Œä¸»è¦æœ‰ä¸‹é¢å››ç§ï¼šç±»æˆ–æ¥å£çš„è§£æã€å­—æ®µè§£æã€ç±»æ–¹æ³•è§£æã€æ¥å£æ–¹æ³•è§£æã€‚åœ¨è§£æé˜¶æ®µè¦åšçš„æ˜¯å°±æ˜¯æŠŠç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨ï¼ˆç›¸å½“äºç›´æ¥æŒ‡å‘äº†å®é™…çš„å¯¹è±¡ï¼‰ï¼Œå¦‚æœæœ‰äº†ç›´æ¥å¼•ç”¨ï¼Œé‚£ä¹ˆå¼•ç”¨çš„ç›®æ ‡å¯¹è±¡ä¸€å®šåœ¨å †ä¸­ã€‚</p><h4 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h4><p>å¦‚æœç›´æ¥èµ‹å€¼çš„é™æ€å­—æ®µè¢« final æ‰€ä¿®é¥°ï¼Œå¹¶ä¸”å®ƒçš„ç±»å‹æ˜¯åŸºæœ¬ç±»å‹æˆ–å­—ç¬¦ä¸²æ—¶ï¼Œé‚£ä¹ˆè¯¥å­—æ®µä¾¿ä¼šè¢« Java ç¼–è¯‘å™¨æ ‡è®°æˆå¸¸é‡å€¼ï¼ˆConstantValueï¼‰ï¼Œå…¶åˆå§‹åŒ–ç›´æ¥ç”± Java è™šæ‹Ÿæœºå®Œæˆã€‚é™¤æ­¤ä¹‹å¤–çš„ç›´æ¥èµ‹å€¼æ“ä½œï¼Œä»¥åŠæ‰€æœ‰é™æ€ä»£ç å—ä¸­çš„ä»£ç åˆ™ä¼šè¢« Java ç¼–è¯‘å™¨ç½®äºåŒä¸€æ–¹æ³•ä¸­ï¼Œå¹¶æŠŠå®ƒå‘½åä¸º<code>&lt;clinit&gt;</code>ã€‚</p><p>ç±»åªæœ‰åœ¨é¦–æ¬¡ â€œä¸»åŠ¨ä½¿ç”¨â€ æ‰èƒ½æ‰§è¡Œç±»çš„åˆå§‹åŒ–ã€‚æ˜¯ <clinit> æ–¹æ³•ä¸æ˜¯æ„é€ å™¨ï¼Œåªæœ‰ä¸»åŠ¨ä½¿ç”¨æ‰ä¼šè°ƒç”¨æ„é€ å™¨æ–¹æ³•ã€‚</p><p>ç±»åŠ è½½çš„æœ€åä¸€æ­¥æ˜¯åˆå§‹åŒ–ï¼Œä¾¿æ˜¯ä¸ºæ ‡è®°ä¸ºå¸¸é‡å€¼çš„å­—æ®µèµ‹å€¼ï¼Œä»¥åŠæ‰§è¡Œ &lt; clinit &gt; æ–¹æ³•çš„è¿‡ç¨‹ã€‚Java è™šæ‹Ÿæœºä¼šé€šè¿‡åŠ é”æ¥ç¡®ä¿ç±»çš„ &lt; clinit &gt; æ–¹æ³•ä»…è¢«æ‰§è¡Œä¸€æ¬¡ã€‚</p><blockquote><p>è¿™ä¸ªæµç¨‹åº”è¯¥æ˜¯æ¯ä¸ªJava ç¨‹åºå‘˜éƒ½åº”è¯¥ç†Ÿè®°äºèƒ¸çš„ï¼Œä¸€å¼€å§‹æˆ‘è®°å¿†è¿™ä¸ªéƒ¨åˆ†ä¹Ÿæ˜¯ç¡¬ç€å¤´çš®è®°ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¿˜ã€‚å¶ç„¶æœ‰ä¸€å¤©æˆ‘åœ¨é¥­ï¼Œçªç„¶å‘ç°è¿™ä¸ªç±»åŠ è½½æœºåˆ¶åƒåšé¥­çš„è¿‡ç¨‹ã€‚åŠ è½½è¿‡ç¨‹å°±åƒæ˜¯ä¹°èœï¼Œç±»åŠ è½½è¿›å…¥JVM å°±åƒæŠŠèœä¹°å›å®¶ã€‚ç„¶åèœä¹°å›æ¥ä¹‹åå‘¢ï¼Œè¦æ£€æŸ¥æ£€æŸ¥ï¼Œç¡®è®¤ä¹°çš„èœéƒ½æ˜¯å¯¹çš„ï¼Œä¸ç„¶ä¹°é”™äº†æˆ–è€…ä»€ä¹ˆæ¼ä¹°äº†å°±å¾ˆå°´å°¬äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹å‘¢å°±åƒç±»åŠ è½½æµç¨‹é‡Œé¢çš„éªŒè¯ï¼Œè¦æ£€æŸ¥å­—èŠ‚ç æ–‡ä»¶ç¬¦åˆè™šæ‹Ÿæœºè¦æ±‚ä¸ä¼šå±å®³åˆ°è™šæ‹Ÿæœºå®‰å…¨ã€‚åšé¥­ä¹Ÿè¦éœ€è¦å‡†å¤‡ï¼Œè¦æ´—èœæ‹©èœï¼Œå°±åƒæˆ‘ä»¬çš„å‡†å¤‡é˜¶æ®µä¸ºç±»å‡†å¤‡åˆ†é…å†…å­˜ç©ºé—´ã€‚è¿™éƒ¨åˆ†ç»“æŸäº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥çƒ­é”…å¼€å§‹åšèœäº†ã€‚è¿™ä¸ªéƒ¨åˆ†æŒ‰ç…§èœè°±åŠ å…¥å„ç§è°ƒå‘³æ–™ï¼ŒæŠŠå„ä¸ªé£Ÿææ··åˆåœ¨ä¸€èµ·ï¼Œå°±åƒè§£æï¼ŒæŠŠå„ä¸ªç¬¦å·å¼•ç”¨æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼Œè®©å„ä¸ªéƒ¨åˆ†å…³è”èµ·æ¥ã€‚ç„¶åæˆ‘ä»¬èœå°±åšå¥½äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥è£…ç›˜å‡ºé”…äº†ã€‚è¿™ä¸ªéƒ¨åˆ†å°±æ˜¯ç±»çš„åˆå§‹åŒ–ï¼Œç»è¿‡è¿™ä¸ªéƒ¨åˆ†ä¹‹åï¼Œä¸€ä¸ªç±»å°±å¯ä»¥æ­£å¸¸çš„ä½¿ç”¨äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åƒé¥­äº†ï¼Œæœ€åç±»ä½¿ç”¨å®Œä¹‹åå¸è½½ï¼Œæˆ‘ä»¬åƒå®Œäº†ä¹Ÿå°±è¦æ´—ç¢—äº†ã€‚å“ˆå“ˆæ˜¯ä¸æ˜¯å¾ˆåƒã€‚</p><p>åŠ è½½ -&gt; éªŒè¯ -&gt; å‡†å¤‡ -&gt; è§£æ -&gt; åˆå§‹åŒ– -&gt; ä½¿ç”¨ -&gt; å¸è½½ã€‚</p><p>ä¹°èœ -&gt; æ£€æŸ¥èœ -&gt; æ´—èœ -&gt; ç‚’èœ -&gt; è£…ç›˜ -&gt; åƒé¥­ -&gt; æ´—ç¢—ã€‚ </p></blockquote><h3 id="ç±»çš„åŠ è½½æ—¶æœº"><a href="#ç±»çš„åŠ è½½æ—¶æœº" class="headerlink" title="ç±»çš„åŠ è½½æ—¶æœº"></a>ç±»çš„åŠ è½½æ—¶æœº</h3><p>ç±»å¹¶ä¸æ˜¯åœ¨è™šæ‹Ÿæœºä¸€å¯åŠ¨å°±ä¼šå…¨éƒ¨åŠ è½½è¿›æ¥ï¼Œè€Œæ˜¯ä¼š<code>æŒ‰éœ€åŠ è½½</code>ï¼Œé‚£åœ¨ä»€ä¹ˆæ—¶å€™æ‰ä¼šåŠ è½½ç›®æ ‡ç±»å‘¢ï¼Ÿ</p><ol><li>å½“è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œåˆå§‹åŒ–ç”¨æˆ·æŒ‡å®šçš„ä¸»ç±»ã€‚</li><li>å½“é‡åˆ°ç”¨ä»¥æ–°å»ºç›®æ ‡ç±»å®ä¾‹çš„ new æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ– new æŒ‡ä»¤çš„ç›®æ ‡ç±»ã€‚</li><li>å½“é‡åˆ°è°ƒç”¨é™æ€æ–¹æ³•çš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€æ–¹æ³•æ‰€åœ¨çš„ç±»ã€‚</li><li>å½“é‡åˆ°è®¿é—®é™æ€å­—æ®µçš„æŒ‡ä»¤æ—¶ï¼Œåˆå§‹åŒ–è¯¥é™æ€å­—æ®µæ‰€åœ¨çš„ç±»ã€‚</li><li>å­ç±»çš„åˆå§‹åŒ–ä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–ã€‚</li><li>å¦‚æœä¸€ä¸ªæ¥å£å®šä¹‰äº† deault æ–¹æ³•ï¼Œé‚£ä¹ˆç›´æ¥å®ç°å¶ç€é—´æ¥å®ç°è¯¥æ¥å£çš„ç±»åˆå§‹åŒ–ï¼Œä¼šè§¦å‘è¯¥æ¥å£çš„åˆå§‹åŒ–ã€‚</li><li>ä½¿ç”¨åå°„ API å¯¹æŸä¸ªç±»è¿›è¡Œåå°„è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ–è¿™ä¸ªç±»ã€‚</li><li>å½“åˆæ¬¡è°ƒç”¨ MethodHandler å®ä¾‹ï¼Œåˆå§‹è¯¥ MethodHandler æŒ‡å‘çš„æ–¹æ³•æ‰€åœ¨ç±»ã€‚</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Singleton</span> </span>&#123;<br>  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Singleton</span><span class="hljs-params">()</span> </span>&#123;&#125;<br>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyHolder</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Singleton INSTANCE = <span class="hljs-keyword">new</span> Singleton();<br>  &#125;<br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Singleton <span class="hljs-title">getInstance</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">return</span> LazyHolder.INSTANCE;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜¯åœ¨è‘—åçš„å•ä¾‹å»¶è¿Ÿåˆå§‹åŒ–ï¼Œåªæœ‰å½“è°ƒç”¨ Singleton.getInstance æ—¶ï¼Œç¨‹åºæ‰ä¼šè®¿é—® LazyHolder.INSTANCEï¼Œæ‰ä¼šè§¦å‘å¯¹ LazyHolder çš„åˆå§‹åŒ–ï¼ˆå¯¹åº”ç¬¬ 4 ç§æƒ…å†µï¼‰ï¼Œç»§è€Œæ–°å»ºä¸€ä¸ª Singleton çš„å®ä¾‹ã€‚</p><h3 id="ç±»åŠ è½½å™¨æœºåˆ¶"><a href="#ç±»åŠ è½½å™¨æœºåˆ¶" class="headerlink" title="ç±»åŠ è½½å™¨æœºåˆ¶"></a>ç±»åŠ è½½å™¨æœºåˆ¶</h3><p>ç±»çš„åŠ è½½è¿‡ç¨‹å¯ä»¥æè¿°ä¸ºâ€é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šå a.b.c.xxx.XXClass æ¥è·å–æ­¤ç±»çš„ Class å¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹ç”±ç±»åŠ è½½å™¨æ¥å®Œæˆã€‚è¿™æ ·çš„å¥½å¤„åœ¨äºï¼Œå­ç±»åŠ è½½å™¨å¯ä»¥å¤ç”¨çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚ç³»ç»Ÿè‡ªå¸¦çš„åŠ è½½å™¨åˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li><code>å¯åŠ¨ç±»åŠ è½½å™¨</code>ï¼ˆBootstrapClassLoaderï¼‰</li><li><code>æ‰©å±•ç±»åŠ è½½å™¨</code>ï¼ˆExtClassLoaderï¼‰</li><li><code>åº”ç”¨ç±»åŠ è½½å™¨</code>ï¼ˆAppClassLoaderï¼‰</li></ul><p>ä¸€èˆ¬å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯ç”± JVM å†…éƒ¨å®ç°çš„ï¼Œåœ¨ Java çš„ API é‡Œé¢æ˜¯æ— æ³•æ‹¿åˆ°äº†ï¼Œæ˜¯ç”¨ C++ å®ç°çš„ï¼Œåé¢ä¸¤ç§åœ¨ Oracle Hotspot JVM ä¸­ï¼Œéƒ½åœ¨ sun.misc.Lanucher å®šä¹‰çš„ï¼Œæ‰©å±•ç±»åŠ è½½å™¨å’Œåº”ç”¨ç±»åŠ è½½å™¨ä¸€èˆ¬éƒ½ç»§æ‰¿è‡ª <code>URLClassLoader</code> ç±»ï¼Œè¿™ä¸ªç±»ä¹Ÿé»˜å®ç°äº†ä»ä¸åŒçš„æºæ¥åŠ è½½ class å­—èŠ‚ç æ¢æˆçš„ Class çš„æ–¹æ³•ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210512000947.png"></p><ol><li>å¯åŠ¨ç±»åŠ è½½å™¨ï¼ˆbootstrap class loaderï¼‰ï¼šå®ƒç”¨æ¥åŠ è½½ Java çš„æ ¸å¿ƒç±»ï¼Œç”¨åŸç”Ÿçš„ C++ å®ç°å¹¶ä¸ç»§æ‰¿è‡ª java.lang.Classloaderã€‚è´Ÿè´£åŠ è½½ JDK ä¸­ <code>jre/lib/rt.jar</code> ä¸­çš„æ‰€æœ‰ classã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ JVM è‡ªå¸¦çš„ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿæ— æ³•è·å–å®ƒçš„å¼•ç”¨ã€‚</li><li>æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆextensions class loaderï¼‰ï¼šå®ƒç”¨æ¥åŠ è½½ <code>lib/ext</code> æˆ–è€…ç”±ç³»ç»Ÿè·¯å¾„ <code>java.ext.dirs</code> æŒ‡å®šçš„ç›®å½•ä¸­çš„ Jar åŒ…ä¸­çš„ç±»ã€‚</li><li>åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆapplication class loaderï¼‰ï¼šå®ƒè´Ÿè´£åœ¨ JVM å¯åŠ¨æ—¶åŠ è½½æ¥è‡ª <code>Java å‘½ä»¤ -classpath</code> æˆ–è€… <code>-cp</code> æˆ–è€…æŒ‡å®šç³»ç»Ÿè·¯å¾„ <code>java.class.path</code> ç³»ç»Ÿå±æ€§æŒ‡å®šçš„ jar åŒ…å’Œç±»è·¯å¾„ã€‚ å¯ä»¥é€šè¿‡ <code>ClassLoader.getSystemClassLoader()</code> æ¥è·å–ç±»åº”ç”¨åŠ è½½å™¨ã€‚</li></ol><p>ç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œå¦‚æœè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨çš„åº”è¯¥ä»¥åº”ç”¨åŠ è½½å™¨ä½œä¸ºçˆ¶ç±»ã€‚ä¸‹é¢å°±æ˜¯ä¸€ä¸ªè‡ªå®šç±»åŠ è½½å™¨ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> HelloXlassLoader extends ClassLoader &#123;<br><br>    public static void main(String<span class="hljs-literal">[]</span> args) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Object hello = <span class="hljs-keyword">new</span> <span class="hljs-constructor">HelloXlassLoader()</span>.find<span class="hljs-constructor">Class(<span class="hljs-string">&quot;Hello&quot;</span>)</span>.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span>;<br>            Method <span class="hljs-keyword">method</span> = hello.get<span class="hljs-constructor">Class()</span>.get<span class="hljs-constructor">Method(<span class="hljs-string">&quot;hello&quot;</span>)</span>;<br>            <span class="hljs-keyword">method</span>.invoke(hello);<br>        &#125; catch (Exception e) &#123;<br>            e.print<span class="hljs-constructor">StackTrace()</span>;<br>        &#125;<br>    &#125;<br><br>    @Override<br>    protected Class&lt;?&gt; find<span class="hljs-constructor">Class(String <span class="hljs-params">name</span>)</span> throws ClassNotFoundException &#123;<br>        byte<span class="hljs-literal">[]</span> <span class="hljs-built_in">bytes</span> = get<span class="hljs-constructor">BytesFromXXX()</span>;<br>        handle<span class="hljs-constructor">Bytes(<span class="hljs-params">bytes</span>)</span>;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">bytes</span>.length<span class="hljs-operator"> == </span><span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-string">&quot;file load error&quot;</span>);<br>        &#125;<br>        return define<span class="hljs-constructor">Class(<span class="hljs-params">name</span>, <span class="hljs-params">bytes</span>, 0, <span class="hljs-params">bytes</span>.<span class="hljs-params">length</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç±»åŠ è½½å™¨æœ‰ä¸‰ä¸ªç‰¹ç‚¹ï¼š</p><ol><li><code>åŒäº²å§”æ´¾</code>ï¼šå¤§åé¼é¼çš„åŒäº²å§”æ´¾å…¶å®å¾ˆç®€å•ï¼Œä¹Ÿæ²¡æœ‰ä»€ä¹ˆæ‰€è°“çš„åŒäº²ï¼Œå°±æ˜¯ä¼˜å…ˆç»™çˆ¶ç±»åŠ è½½å™¨åŠ è½½ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½ä¸äº†å†è‡ªå·±æ¥åŠ è½½ã€‚ä¾‹å¦‚ String ç±»å‹ï¼ŒappClassLoader çœ‹åˆ°äº†ä¸åŠ è½½ï¼Œç»™ extClassLoaderï¼ŒextClassLoader ä¹Ÿä¸åŠ è½½ï¼Œç»™bootstrapClassLoader åŠ è½½ï¼ŒbootstrapClassLoader ä¸€çœ‹ java.lang.String æ˜¯åœ¨ rt åŒ…é‡Œçš„å°±ç»™åŠ è½½äº†ã€‚è¿™ä¹Ÿä¸æ˜¯è¯´åŠ è½½å™¨æ‡’ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ï¼Œ<code>æŸä¸€ä¸ªç±»æ¯æ¬¡éƒ½èƒ½è¢«ç‰¹å®šçš„æŸä¸ªåŠ è½½å™¨åŠ è½½ã€‚</code></li><li><code>è´Ÿè´£ä¾èµ–</code>ï¼šå¦‚æœä¸€ä¸ªåŠ è½½å™¨åœ¨åŠ è½½æŸä¸ªç±»çš„æ—¶å€™ï¼Œå‘ç°è¿™ä¸ªç±»ä¾èµ–çš„å¦å¤–å‡ ä¸ªç±»æˆ–è€…æ¥å£ï¼Œä¹Ÿä¼šå»æ˜¯è¿™å°è¯•åŠ è½½è¿™äº›ä¾èµ–ã€‚</li><li><code>ç¼“å­˜åŠ è½½</code>ï¼šä¸ºäº†æé«˜æ•ˆç‡é¿å…é‡å¤åŠ è½½ï¼Œä¸€æ—¦æŸä¸ªç±»è¢«ä¸€ä¸ªåŠ è½½å™¨åŠ è½½ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šç¼“å­˜è¿™ä¸ªåŠ è½½ç»“æœï¼Œä¸ä¼šé‡å¤åŠ è½½ã€‚è¿™ä¹Ÿæ˜¯åŒäº²å§”æ´¾çš„ç›®çš„ã€‚</li></ol><h2 id="å¯¹è±¡å†…å­˜å¸ƒå±€"><a href="#å¯¹è±¡å†…å­˜å¸ƒå±€" class="headerlink" title="å¯¹è±¡å†…å­˜å¸ƒå±€"></a>å¯¹è±¡å†…å­˜å¸ƒå±€</h2><p>å‰é¢çš„éƒ¨åˆ†æˆ‘ä»¬èŠåˆ°äº†ï¼ŒJava å¯¹è±¡æ˜¯å¦‚ä½•åŠ è½½ä¸€ä¸ªç±»çš„ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çœŸæ­£çš„ä½¿ç”¨ä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦æ ¹æ®æˆ‘ä»¬åŠ è½½çš„ç±»å»åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚é‚£åˆ›å»ºçš„è¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ</p><h3 id="å¯¹è±¡åˆ›å»º"><a href="#å¯¹è±¡åˆ›å»º" class="headerlink" title="å¯¹è±¡åˆ›å»º"></a>å¯¹è±¡åˆ›å»º</h3><p>æˆ‘æƒ³èµ·æ¥ä¸€ä¸ªæ®µå­ï¼ŒæŠŠå¤§è±¡æ”¾è¿›å†°ç®±éœ€è¦å‡ æ­¥ï¼Ÿéœ€è¦ä¸‰æ­¥ï¼æ‰“å¼€å†°ç®±é—¨ï¼ŒæŠŠå¤§è±¡æ”¾è¿›å†°ç®±ï¼ŒæŠŠé—¨å…³ä¸Šã€‚å…¶å®æˆ‘ä»¬çš„ Java åˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¹Ÿå¯ä»¥å¤§è‡´åˆ†ä¸ºä¸‰æ­¥ï¼Œç”³è¯·å†…å­˜ â€”&gt; åˆå§‹åŒ–æ•°æ®ï¼ˆä»£ç å—å’Œæ„é€ ï¼‰-&gt; å…³è”å¼•ç”¨ã€‚</p><ol><li><code>æ„å»ºå¯¹è±¡</code>ï¼ˆç”³è¯·ç©ºé—´ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹é¦–å…ˆçº¿ç¨‹ä¼šç”³è¯·ä¸€ä¸ªæ ˆç©ºé—´ï¼Œå¹¶ä¸”ç”Ÿæˆæ ˆå¸§ç„¶åæ‰§è¡Œ new æ“ä½œã€‚çº¿ç¨‹ä¼šæ ¹æ®åŠ è½½çš„ç±»ä¿¡æ¯ç”³è¯·ä¸€å—å†…å­˜æ„å»ºå¯¹è±¡ï¼Œå¹¶ä¸”ä¸ºæˆå‘˜å˜é‡èµ‹é»˜è®¤å€¼ã€‚</li><li><code>å¯¹è±¡åˆå§‹åŒ–</code>ï¼Œè¿™ä¸ªéƒ¨åˆ†å°±æ˜¯æ‰§è¡Œ {} ä»£ç å—å’Œæ„é€ æ–¹æ³•äº†ã€‚</li><li><code>å…³è”å¼•ç”¨</code>ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡çš„å¼•ç”¨æ˜¯åœ¨æ ˆä¸Šé¢ï¼Œç„¶è€Œæˆ‘ä»¬åˆ›å»ºçš„å¯¹è±¡æ˜¯åœ¨å †ä¸­ï¼Œæœ€åä¸€æ­¥å°±æ˜¯æŠŠæ ˆä¸Šçš„å¯¹è±¡å¼•ç”¨æŒ‡å‘å †ä¸­çš„åœ°å€ã€‚</li></ol><blockquote><p>æ‰“å¼€å†°ç®± = ç”³è¯·ç©ºé—´ï¼Œæ”¾å…¥å¤§è±¡ = å¯¹è±¡åˆå§‹åŒ–ï¼Œ å…³è”å¼•ç”¨ = å…³ä¸Šå†°ç®±é—¨ </p></blockquote><h3 id="å¯¹è±¡åœ¨å†…å­˜çš„å¸ƒå±€"><a href="#å¯¹è±¡åœ¨å†…å­˜çš„å¸ƒå±€" class="headerlink" title="å¯¹è±¡åœ¨å†…å­˜çš„å¸ƒå±€"></a>å¯¹è±¡åœ¨å†…å­˜çš„å¸ƒå±€</h3><p>æˆ‘ä»¬ç°åœ¨åˆ›å»ºå¥½äº†ä¸€ä¸ªå¯¹è±¡ï¼Œéš¾é“ä¸€ä¸ªå¯¹è±¡åœ¨å †ä¸­å­˜çš„å°±çœŸçš„æ˜¯ä¸€å †å˜é‡æ•°æ®å°±æ²¡æœ‰å…¶ä»–çš„ä¸œè¥¿å—ï¼Ÿ</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210513231532.png"></p><p>å¯¹è±¡åœ¨å†…å­˜çš„ä¸­å¹¶ä¸åªæœ‰å®ä¾‹çš„æ•°æ®ï¼Œè€Œæ˜¯åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼Œ<code>å¯¹è±¡å¤´</code>ã€<code>å®ä¾‹æ•°æ®</code>ã€<code>å†…å­˜å¡«å……</code>ã€‚</p><ul><li>å¯¹è±¡å¤´ï¼šæŒ‰ç…§å®ä¾‹å¯¹è±¡çš„ä¸åŒï¼Œå¯¹è±¡å¤´ä¹Ÿæœ‰ä¸åŒï¼Œä¸»è¦çš„å°±æ˜¯åŒ…å«<code>Mark word</code>ï¼Œ<code>class pointer</code>ï¼Œæ•°ç»„å¯¹è±¡è¿˜åŒ…æ‹¬æ•°ç»„é•¿åº¦ã€‚MarkWord é‡Œé¢åŒ…å«æœ‰å¯¹è±¡çš„å“ˆå¸Œç ï¼Œé”ä¿¡æ¯ï¼ŒGC ç­‰ä¿¡æ¯ã€‚ClassPointer è¿™ä¸ªå¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æ–¹æ³•åŒºçš„ Class å¯¹è±¡ ï¼Œåœ¨æ•°ç»„å®ä¾‹ä¸­è¿˜è¦è®°å½•æ•°ç»„çš„é•¿åº¦ï¼Œåœ¨ 64 ä½çš„ç³»ç»Ÿä¸­markWordå <code>8</code>ä¸ªå­—èŠ‚ï¼Œå¦‚æœå¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œè¿™ä¸ªå¤§å°å¯ä»¥å‹ç¼©åˆ° <code>4</code>ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯å¦‚æœä¸å¼€å¯æŒ‡é’ˆå‹ç¼©çš„è¯ï¼Œå†åŠ ä¸Š class pointer 4 ä¸ªå­—èŠ‚ï¼Œå®ä¾‹å¯¹è±¡å¤´ 12 ä¸ªå­—èŠ‚ï¼Œæ•°ç»„å¯¹è±¡å¤´å  16 ä¸ªå­—èŠ‚ï¼Œå¼€å¯æŒ‡é’ˆå‹ç¼©åï¼Œå®ä¾‹å¯¹è±¡ å¯¹è±¡å¤´8ä¸ªå­—èŠ‚ï¼Œæ•°ç»„å¯¹è±¡å¯¹è±¡å¤´ 12 ä¸ªå­—èŠ‚ã€‚</li></ul><blockquote><p>å¯¹è±¡å¤´ ä¸å¼€å¯æŒ‡é’ˆå‹ç¼© å®ä¾‹ 12 å­—èŠ‚ï¼Œæ•°ç»„ 16 å­—èŠ‚ï¼Œå¼€å¯æŒ‡é’ˆå‹ç¼© å®ä¾‹ 8 å­—èŠ‚ï¼Œæ•°ç»„ 12 å­—èŠ‚ã€‚</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">-XX:+UseCompressedOops  <span class="hljs-regexp">//</span> å¼€å¯æŒ‡é’ˆå‹ç¼©<br>-XX:-UseCompressedOops  <span class="hljs-regexp">//</span> å…³é—­æŒ‡é’ˆå‹ç¼©<br></code></pre></td></tr></table></figure><ul><li>å®ä¾‹æ•°æ®ï¼šè¿™ä¸ªå¾ˆå¥½ç†è§£å°±æ˜¯ç±»å®ä¾‹ä¸­çš„æ•°æ®ã€‚</li><li>å†…å­˜å¯¹é½ï¼šæˆ‘ä»¬çš„ CPU å¯„å­˜å™¨çš„ä½æ•°éƒ½æ˜¯ 8 çš„å€æ•°ï¼Œæ‰€ä»¥ä¸ºäº†æ–¹ä¾¿ CPU å¯„å­˜å™¨é«˜æ•ˆå¯»å€ï¼Œ64 ä½ JVM è¦æ±‚ Java å¯¹è±¡åœ°å€è¦æŒ‰ç…§ 8 å­—èŠ‚å¯¹é½ã€‚è¿™ä¸ªéƒ¨åˆ†åšæ•°æ®å¡«å……ä¿è¯ 8 å­—èŠ‚å¯¹é½ã€‚</li></ul><blockquote><p>âš ï¸è¿™é‡Œæœ‰ä¸ªå°çŸ¥è¯†ç‚¹ï¼ŒJava å®ä¾‹è¢« GC ä¹‹åï¼Œå¯¹è±¡çš„ Hash ç ä¼šå˜ç ï¼Ÿé‚£æ ˆä¸­çš„å¼•ç”¨åœ°å€ä¼šå˜åŒ–å—ï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ Java å¯¹è±¡çš„ Hash ç å’Œå¯¹è±¡åœ°å€æœ‰å…³ç³»ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡è¢« GC è¿‡åè¿˜å­˜æ´»çš„è¯ï¼Œå¦‚æœåœ¨ young åŒºï¼Œé‚£åœ°å€å¤§æ¦‚ç‡ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé‚£Hash ç æ˜¯ä¸æ˜¯ä¹Ÿä¸ä¸€æ ·å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡å®éªŒå¯ä»¥å¾ˆå®¹æ˜“éªŒè¯è¿™ä¸ªé—®é¢˜ï¼ŒHash ç ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯åœ°å€ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¿™æ˜¯æ€ä¹ˆåšåˆ°çš„ï¼Ÿæ¥ï¼ŒæŠ¬å¤´å¾€ä¸Šçœ‹ï¼Œå¯¹è±¡å¤´ä¸­æ˜¯ä¸æ˜¯æœ‰ä¸ªå“ˆå¸Œç ä¿¡æ¯ã€‚åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨å¯¹è±¡ hashCode æ–¹æ³•ï¼Œå°±ä¼šæŠŠ hashCode å­˜åœ¨è¿™é‡Œï¼Œåé¢çš„ hashCode ç›´æ¥æ¥è¿™é‡Œå–å°±å¥½äº†ã€‚ </p></blockquote><p>æ•´ä½“çš„å¤§è‡´çš„å¯¹è±¡å­˜å‚¨å¸ƒå±€å°±æ˜¯é…±å©¶å„¿çš„ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210513235300.png"></p><h3 id="JOL-å®è·µ"><a href="#JOL-å®è·µ" class="headerlink" title="JOL å®è·µ"></a>JOL å®è·µ</h3><p>ä»€ä¹ˆæ˜¯ JOL ï¼ŸJOL ï¼ˆJava object layoutï¼‰Java å¯¹è±¡å†…å­˜å¸ƒå±€ï¼Œæ˜¯ openjdk ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªå·¥å…·åŒ…ï¼Œå¯ä»¥ç”¨æ¥è·å–å¯¹è±¡çš„ä¿¡æ¯å’Œè™šæ‹Ÿæœºçš„ä¿¡æ¯ ã€‚æˆ‘ä»¬æ¥å¼•å…¥ä¸‹ jol-core çš„ä¾èµ–ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.15<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><p>ä¸»è¦ä¼šç”¨åˆ°çš„æ–¹æ³•ï¼š</p><ul><li><code>ClassLayout.parseInstance(object).toPrintable()</code>ï¼šæŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯ã€‚</li><li><code>GraphLayout.parseInstance(object).toPrintable()</code>ï¼šæŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¼•ç”¨çš„å¯¹è±¡ã€‚</li><li><code>GraphLayout.parseInstance(object).totalSize()</code>ï¼šæŸ¥çœ‹å¯¹è±¡æ€»å¤§å°ã€‚</li></ul><p>æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ™®é€šå¯¹è±¡ï¼Œç©ºå¯¹è±¡å¼€å¼€èƒƒã€‚</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">A</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå¯¹è±¡ä¸€ä¸ªæˆå‘˜å˜é‡éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆä¸€ä¸ª A å®ä¾‹å ç”¨å‡ ä¸ªå­—èŠ‚å‘¢ï¼Ÿæˆ‘ä»¬æ²¡æœ‰å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼ŒmarkWord 8 ä¸ªå­—èŠ‚ï¼Œ class pointer 4 ä¸ªå­—èŠ‚ï¼Œ8 + 4 = 12 ç„¶å 8 ä¸ªå­—èŠ‚å¯¹é½ ä¹Ÿå°±æ˜¯ 16 ä¸ªå­—èŠ‚ã€‚æˆ‘ä»¬ä½¿ç”¨ JOL æ‰“å°å‡ºæ¥çœ‹çœ‹ã€‚</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> static <span class="hljs-built_in">void</span> main(String[] args) &#123;<br>    A a = new A();<br>    System.<span class="hljs-keyword">out</span>.println(ClassLayout.parseInstance(a).toPrintable());<br>&#125;<br><br><span class="hljs-comment">// consoleï½</span><br>io.daiwei.jvm.jol.A object <span class="hljs-built_in">int</span>ernals:<br>OFF  SZ   TYPE DESCRIPTION               VALUE<br>  <span class="hljs-number">0</span>   <span class="hljs-number">8</span>        (object header: mark)     <span class="hljs-number">0x0000000000000001</span> (non-biasable; age: <span class="hljs-number">0</span>)<br>  <span class="hljs-number">8</span>   <span class="hljs-number">4</span>        (object header: <span class="hljs-keyword">class</span>)    <span class="hljs-symbol">0xf800c182</span><br> <span class="hljs-symbol">12</span>   <span class="hljs-symbol">4</span>        (<span class="hljs-symbol">object</span> <span class="hljs-symbol">alignment</span> <span class="hljs-symbol">gap</span>)    <br><span class="hljs-symbol">Instance</span> <span class="hljs-symbol">size: <span class="hljs-symbol">16</span></span> <span class="hljs-symbol">bytes</span><br><span class="hljs-symbol">Space</span> <span class="hljs-symbol">losses: <span class="hljs-symbol">0</span></span> <span class="hljs-symbol">bytes</span> <span class="hljs-symbol">internal</span> + <span class="hljs-symbol">4</span> <span class="hljs-symbol">bytes</span> <span class="hljs-symbol">external</span> = <span class="hljs-symbol">4</span> <span class="hljs-symbol">bytes</span> <span class="hljs-symbol">total</span><br></code></pre></td></tr></table></figure><p> é‚£ä¹ˆä¸€ä¸ªæ•°ç»„å¯¹è±¡å‘¢ï¼Ÿæˆ‘ä»¬å‰é¢æåˆ°æ•°ç»„å¯¹è±¡å®ä¾‹å¯¹è±¡å¤´ä¸­ä¼šå¤šä¸€ä¸ª<code>length field</code>ç”¨æ¥å­˜æ•°ç»„çš„é•¿åº¦ã€‚æŒ‰ç…§æˆ‘ä»¬çš„è®¡ç®—é€»è¾‘ï¼Œæˆ‘ä»¬æ²¡å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼ŒmarkWord å ç”¨ 8 ä¸ªå­—èŠ‚ï¼ŒclassPonter å  4 ä¸ªå­—èŠ‚ï¼Œå› ä¸ºæ•°æ•°ç»„å¯¹è±¡å¤šä¸€ä¸ª lengthField 4 ä¸ªå­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯ 4 + 4 + 8 = 16ï¼Œåˆšå¥½å¯¹é½ 16 ä¸ªå­—èŠ‚ã€‚çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿæ²¡è½ä¸‹ä»€ä¹ˆå—ï¼Ÿ</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs tap">public static void main(String[] args) &#123;<br>    int[] nums = new int[10];<br>    System.out.println(ClassLayout.parseInstance(nums).toPrintable());<br>&#125;<br><br>// consoleï½<br>[I object internals:<br>OFF  SZ   TYPE DESCRIPTION               VALUE<br> <span class="hljs-number"> 0 </span> <span class="hljs-number"> 8 </span>       (object header: mark)     0x0000000000000001 (non-biasable; age: 0)<br> <span class="hljs-number"> 8 </span> <span class="hljs-number"> 4 </span>       (object header: class)    0xf800016d<br><span class="hljs-number"> 12 </span> <span class="hljs-number"> 4 </span>       (array length)            10<br><span class="hljs-number"> 12 </span> <span class="hljs-number"> 4 </span>       (alignment/padding gap)   <br><span class="hljs-number"> 16 </span><span class="hljs-number"> 40 </span>   int [I.&lt;elements&gt;             N/A<br>Instance size:<span class="hljs-number"> 56 </span>bytes<br>Space losses:<span class="hljs-number"> 4 </span>bytes internal +<span class="hljs-number"> 0 </span>bytes external =<span class="hljs-number"> 4 </span>bytes total<br></code></pre></td></tr></table></figure><p> å®é™…çš„å®ä¾‹çš„å¤§å°æ˜¯56ï¼Œä»”ç»†çœ‹ï¼Œæ‰“å°ç»“æœçš„ç¬¬13è¡Œï¼Œå¤šäº† 40 ä¸ªå­—èŠ‚ï¼Œè¿™æ˜¯å•¥å‘¢ï¼Ÿæ²¡é”™æ˜¯æˆ‘ä»¬é•¿åº¦ä¸º10çš„æ•°ç»„å†…å®¹ï¼Œä¸€ä¸ª int ç±»å‹å››ä¸ªå­—èŠ‚å°±æ˜¯ 40 ä¸ªå­—èŠ‚ã€‚æ‰€ä»¥æœ€ç»ˆçš„å¤§å°å°±æ˜¯ 16 + 40 = 56 åˆšå¥½ä¹Ÿä¸ç”¨å¯¹é½ï½ã€‚ </p><p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œä¸€ä¸ªç¨å¾®æ­£å¸¸ç‚¹çš„å¯¹è±¡ Bã€‚</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-symbol">B</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String hello;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">int</span> a;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span>ean b;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>B å¯¹è±¡åŒ…å«ï¼Œä¸€ä¸ª Stringï¼Œä¸€ä¸ªint å’Œä¸€ä¸ª booleanï¼Œæˆ‘ä»¬æ ¹æ®ä¹‹å‰çš„ç»éªŒå¯ä»¥æ¨å‡º æ²¡æœ‰å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œå¯¹è±¡å¤´12ä¸ªå­—èŠ‚ï¼ŒString æ˜¯ä¸€ä¸ªå¼•ç”¨4ä¸ªå­—èŠ‚ï¼Œint  4 ä¸ªå­—èŠ‚ï¼Œboolean ä¸€ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥ 12 + 4 + 4 + 1 =  21 ä¸ªå­—èŠ‚ï¼Œç„¶åå†…å­˜å¯¹é½ï¼Œå®ä¾‹å¤§å° 24 ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static void main(String<span class="hljs-literal">[]</span> args) &#123;<br>    B b = <span class="hljs-keyword">new</span> <span class="hljs-constructor">B()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ClassLayout</span>.</span></span>parse<span class="hljs-constructor">Instance(<span class="hljs-params">b</span>)</span>.<span class="hljs-keyword">to</span><span class="hljs-constructor">Printable()</span>);<br>&#125;<br><br><span class="hljs-comment">// consoleï½</span><br>io.daiwei.jvm.jol.B <span class="hljs-keyword">object</span> internals:<br>OFF  SZ               TYPE DESCRIPTION               VALUE<br>  <span class="hljs-number">0</span>   <span class="hljs-number">8</span>                    (<span class="hljs-keyword">object</span> header: mark)     <span class="hljs-number">0x0000000000000001</span> (non-biasable; age: <span class="hljs-number">0</span>)<br>  <span class="hljs-number">8</span>   <span class="hljs-number">4</span>                    (<span class="hljs-keyword">object</span> header: <span class="hljs-keyword">class</span>)    <span class="hljs-number">0xf800c143</span><br> <span class="hljs-number">12</span>   <span class="hljs-number">4</span>                <span class="hljs-built_in">int</span> <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">B</span>.</span></span>a                       <span class="hljs-number">0</span><br> <span class="hljs-number">16</span>   <span class="hljs-number">1</span>            boolean <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">B</span>.</span></span>b                       <span class="hljs-literal">false</span><br> <span class="hljs-number">17</span>   <span class="hljs-number">3</span>                    (alignment/padding gap)   <br> <span class="hljs-number">20</span>   <span class="hljs-number">4</span>   java.lang.String <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">B</span>.</span></span>hello                   null<br>Instance size: <span class="hljs-number">24</span> <span class="hljs-built_in">bytes</span><br>Space losses: <span class="hljs-number">3</span> <span class="hljs-built_in">bytes</span> internal + <span class="hljs-number">0</span> <span class="hljs-built_in">bytes</span> <span class="hljs-keyword">external</span> = <span class="hljs-number">3</span> <span class="hljs-built_in">bytes</span> total<br></code></pre></td></tr></table></figure><p>æ²¡æ¯›ç—…ï¼Œæœ€ç»ˆå®ä¾‹å¤§å° 24 ä¸ªå­—èŠ‚ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸€å°èŠ‚å‘¢ï¼Œæˆ‘ä»¬ä»ç±»çš„ç”Ÿå‘½å‘¨æœŸå…¥æ‰‹æ·±å…¥äº†è§£äº†ç±»çš„åŠ è½½è¿‡ç¨‹å’Œå®ä¾‹åœ¨å†…å­˜ä¸­çš„å¯¹è±¡å¸ƒå±€ï¼Œç±»çš„ç”Ÿå‘½å‘¨æœŸåˆ†ä¸º åŠ è½½ï¼ŒéªŒè¯ï¼Œå‡†å¤‡ï¼Œè§£æï¼Œåˆå§‹åŒ–ï¼Œä½¿ç”¨ã€å¸è½½ã€‚è¿‡ç¨‹å¯ä»¥ç±»æ¯”åšèœçš„è¿‡ç¨‹ã€‚å…¶ä¸­ç±»å¹¶ä¸æ˜¯åœ¨ JVM å¯åŠ¨æ—¶å…¨éƒ¨åŠ è½½è€Œæ˜¯æŒ‰éœ€åŠ è½½çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»‹ç»äº†ç±»åŠ è½½å™¨ï¼Œæœ‰å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œæ‹“å±•ç±»åŠ è½½å™¨å’Œåº”ç”¨ç±»åŠ è½½å™¨ã€‚ä»–ä»¬é‡‡ç”¨åŒäº²å§”æ´¾çš„æ–¹å¼ï¼Œæ‰€è°“çš„åŒäº²å§”æ´¾å°±æ˜¯å…ˆç”±çˆ¶ç±»åŠ è½½ï¼Œçˆ¶ç±»å¦‚æœåŠ è½½åœ¨ä¸äº†å†ç”±å­ç±»åŠ è½½ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ¯ä¸ªç±»æ¯æ¬¡éƒ½ç”±æŸä¸ªç‰¹å®šçš„ç±»åŠ è½½å™¨åŠ è½½ã€‚æˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å®ç°åŠ è½½é€»è¾‘çš„è‡ªå®šä¹‰åŒ–ï¼Œè¿™ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çˆ¶ç±»æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚èŠå®Œç±»çš„åŠ è½½ï¼Œæˆ‘ä»¬æ¢è®¨äº†å®ä¾‹çš„å†…å­˜å¸ƒå±€ï¼Œä¸€ä¸ªå®ä¾‹åˆ†ä¸ºå¯¹è±¡å¤´ï¼Œå®ä¾‹æ•°æ®å’Œå¡«å……æ•°æ®è¿™ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå…¶ä¸­å¯¹è±¡å¤´åˆåŒ…æ‹¬ markWordã€klassPointerå’Œæ•°ç»„å¯¹è±¡ç‰¹æœ‰çš„ lengthFieldï¼Œå¯¹è±¡å¤´çš„å¤§å°å—æ˜¯å¦å¼€å¯æŒ‡é’ˆå‹ç¼©æœ‰å…³ã€‚æœ€åæˆ‘ä»¬ä½¿ç”¨ openJDK æä¾›çš„JOLå·¥å…·éªŒè¯äº†æˆ‘ä»¬çš„ç†è®ºå¯¹è±¡å¸ƒå±€ç†è®ºã€‚è¿™æ˜¯JVMåŸºç¡€æ­£å¼ç¯‡çš„æœ€åä¸€å°èŠ‚ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ä¼šä¸€èµ·æ¢è®¨ JVM çš„å†…å­˜ï¼ŒGC å’Œ é«˜æ•ˆç¼–è¯‘çš„éƒ¨åˆ†ã€‚æ¥ä¸‹æ¥çš„ JVM ä¼šæ›´åŠ ç²¾å½©ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥çœ‹çœ‹ï¼Œæœ‰äº†è¿™äº›ä¸œè¥¿ JVM ä¼šç©å‡ºäº›å•¥ä¸ä¸€æ ·çš„ã€‚å“ˆå“ˆï¼Œæ™šå®‰ï½</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/142614439">JVMåŸºç¡€ï¼ˆä¸‰ï¼‰ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹</a></li><li><a href="https://www.cnblogs.com/jajian/p/13681781.html">Java å¯¹è±¡çš„å†…å­˜å¸ƒå±€</a></li><li>Javaç±»åŠ è½½å™¨ï¼šå±±ä¸è¾åœŸï¼Œæ•…èƒ½æˆå…¶é«˜ </li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM åŸºç¡€ â€” Java æ–¹æ³•è°ƒç”¨ã€åå°„è°ƒç”¨ä¸å¼‚å¸¸</title>
    <link href="/2021/05/09/java-method-invoke/"/>
    <url>/2021/05/09/java-method-invoke/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åœ¨å‰ä¸€ç¯‡ä¸­ç®€å•ä»‹ç»äº†Java å­—èŠ‚ç ä¸­æœ‰å…³æ–¹æ³•è°ƒç”¨çš„ä¸€äº›æ“ä½œç ï¼Œä½†æ˜¯ java æ–¹æ³•çš„è°ƒç”¨å¾€æ·±äº†è®²åˆæœ‰å¾ˆå¤šçš„é—¨é“ï¼Œç®€å•çš„æœ‰æ–¹æ³•çš„é‡å†™å’Œé‡è½½ï¼Œæ·±å…¥ä¹Ÿæœ‰æ–¹æ³•çš„åŠ¨æ€ç»‘å®šå’Œé™æ€ç»‘å®šï¼Œé‚£JVMæ˜¯å¦‚æœè¯†åˆ«å’Œé€‰å®šæ–¹æ³•çš„å‘¢ï¼Ÿè¿˜æœ‰æœ‰äº›æ—¶å€™æˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥è°ƒç”¨æŸä¸ªç›®æ ‡æ–¹æ³•ï¼Œè€Œæ˜¯è¦ä½¿ç”¨ä¸€äº›ç‰¹åˆ«çš„æ‰‹æ®µå»è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼šç»å¸¸ç”¨åˆ°çš„åå°„ï¼Œåå°„ä¸åŒäºå¸¸è§„çš„æ–¹æ³•è°ƒç”¨ï¼Œè¿™è´§ä¸€ä¸Šæ¥å°±ä¸èµ°å¯»å¸¸è·¯ï¼Œä¸€èˆ¬æ–¹æ³•è°ƒç”¨éƒ½æ˜¯å…ˆ new ä¸€ä¸ªå¯¹è±¡ï¼Œå°±åƒæ˜¯æœ‹å‹æ¥å®¶é‡Œåšå®¢ä»æ­£é—¨è¿›æ¥ï¼Œåå°„æ˜¯å…ˆé€šè¿‡ class å¯¹è±¡æ‰¾åˆ°ç›®æ ‡æ–¹æ³•ç„¶åä¼ å…¥è°ƒç”¨å®ä¾‹ï¼Œè¿™æ›´åƒæ˜¯ç¿»å¢™è¿›æ¥ã€‚é‚£è¿™ä¸ªç¿»å¢™è¿›æ¥çš„å®ƒèƒŒåçš„åŸç†åˆæ˜¯æ€æ ·çš„å‘¢ï¼Ÿå‡å¦‚è¿™ä¸ªä¸–ç•Œæ˜¯ç¾å¥½çš„ï¼Œä½†ä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œå¯èƒ½æ²¡é‚£ä¹ˆé¡ºåˆ©ï¼Œä¸‡ä¸€å‘ç”Ÿäº†å¼‚å¸¸è¿™ä¸ªå¼‚å¸¸åˆæ˜¯æ€ä¹ˆæ•è·çš„å‘¢ï¼Ÿ</p><h2 id="Java-æ–¹æ³•è°ƒç”¨åŸç†"><a href="#Java-æ–¹æ³•è°ƒç”¨åŸç†" class="headerlink" title="Java æ–¹æ³•è°ƒç”¨åŸç†"></a>Java æ–¹æ³•è°ƒç”¨åŸç†</h2><h3 id="é‡å†™ä¸é‡è½½"><a href="#é‡å†™ä¸é‡è½½" class="headerlink" title="é‡å†™ä¸é‡è½½"></a>é‡å†™ä¸é‡è½½</h3><p>åœ¨ Java ç¨‹åºé‡Œå¦‚æœä¸€ä¸ªç±»å‡ºç°äº†å¤šä¸ªåå­—ç›¸åŒä¸”å‚æ•°ç±»å‹ç›¸åŒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆä»–ä»¬æ˜¯æ— æ³•é€šè¿‡ç¼–è¯‘çš„ã€‚åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œé€šå¸¸ä¼šå‡ºç°æ–¹æ³•åç›¸åŒä½†æ˜¯æ–¹æ³•å‚æ•°ç±»å‹ä¸ç›¸åŒã€‚è¿™ç§æƒ…å†µç§°ä¹‹ä¸º<code>é‡è½½</code>ã€‚</p><p>é‡è½½çš„æ–¹æ³•åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å³å¯å®Œæˆæ–¹æ³•çš„è¯†åˆ«ã€‚Java ç¼–è¯‘å™¨ä¼šæ ¹æ®æ–¹æ³•åå’Œä¼ å…¥çš„å‚æ•°çš„<code>å£°æ˜ç±»å‹</code>é€‰å–é‡è½½æ–¹æ³•ã€‚é€‰å–çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>åœ¨ä¸è€ƒè™‘å¯¹åŸºæœ¬ç±»å‹è‡ªåŠ¨è£…æ‹†ç®±ï¼ˆauto-boxingï¼Œ auto-unboxingï¼‰ï¼Œå·²ç»å¯å˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•ã€‚ï¼ˆ<code>ä¸è€ƒè™‘è‡ªåŠ¨è£…æ‹†ç®±ï¼Œä¸è€ƒè™‘å˜é•¿å‚æ•°</code>ï¼‰</li><li>å¦‚æœåœ¨ç¬¬ 1 ä¸ªé˜¶æ®µä¸­æ²¡æœ‰æ‰¾åˆ°é€‚é…çš„æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å…è®¸è‡ªåŠ¨è£…æ‹†ç®±ï¼Œä½†æ˜¯ä¸å…è®¸å¯å˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•ã€‚ï¼ˆ<code>è€ƒè™‘è‡ªåŠ¨è£…æ‹†ç®±ï¼Œä¸è€ƒè™‘å˜é•¿å‚æ•°</code>ï¼‰</li><li>å¦‚æœåœ¨ç¬¬ 2 ä¸ªé˜¶æ®µä¸­æ²¡æœ‰æ‰¾åˆ°é€‚é…æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å…è®¸è‡ªåŠ¨è£…æ‹†ç®±ä»¥åŠå˜é•¿å‚æ•°çš„æƒ…å†µä¸‹é€‰å–é‡è½½æ–¹æ³•ã€‚ï¼ˆ<code>è€ƒè™‘è‡ªåŠ¨è£…æ‹†ç®±ï¼Œè€ƒè™‘å˜é•¿å‚æ•°</code>ï¼‰</li></ol><p>å¦‚æœ Java ç¼–è¯‘å™¨åœ¨åŒä¸€é˜¶æ®µæ‰¾åˆ°å¤šä¸ªé€‚é…æ–¹æ³•ï¼Œå®ƒä¼šåœ¨å…¶ä¸­æ‰¾åˆ°ä¸€ä¸ªæœ€ä¸ºè´´åˆ‡çš„ã€‚è€Œå†³å®šè´´åˆ‡ç¨‹åº¦çš„ä¸€ä¸ªå…³é”®å°±æ˜¯å½¢å¼å‚æ•°ç±»å‹çš„ç»§æ‰¿å…³ç³»ã€‚é‡è½½ä¹Ÿé€‚ç”¨å­ç±»ä»çˆ¶ç±»ä¸­ç»§æ‰¿æ¥çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœå­ç±»ä¸­å®šä¹‰äº†å’Œçˆ¶ç±»éç§æœ‰æ–¹æ³•ä¸­æ–¹æ³•åç›¸åŒä¸”æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸åŒçš„æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨å­ç±»ä¸­è¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ„æˆäº†é‡è½½ã€‚</p><p>Java æ˜¯é¢å‘å¯¹è±¡çš„è¯­è¨€ï¼Œå…¶ä¸­æœ‰ä¸ªé‡è¦çš„ç‰¹æ€§å°±æ˜¯å¤šæ€ã€‚è€Œæ–¹æ³•çš„é‡å†™å°±æ˜¯å¤šæ€çš„æœ€é‡è¦çš„ä¸€ç§ä½“ç°å½¢å¼ã€‚é€šè¿‡å¯¹æ–¹æ³•çš„é‡å†™ï¼Œå…è®¸å­ç±»å¯¹äºä¸åŒçš„åŠ¨ä½œæœ‰è‡ªå·±ç‹¬ç‰¹çš„è¡Œä¸ºã€‚ åœ¨è°ƒç”¨é‡å†™çš„æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œç¼–è¯‘å™¨ä¼šæ›´å…·å…·ä½“çš„ç±»å‹è°ƒç”¨ç›®æ ‡å®é™…çš„æ–¹æ³•ã€‚</p><h3 id="JVM-çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®š"><a href="#JVM-çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®š" class="headerlink" title="JVM çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®š"></a>JVM çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®š</h3><p>å‰é¢è¯´åˆ° Java ç¼–è¯‘å™¨é€šè¿‡æ–¹æ³•åå’Œæ–¹æ³•å‚æ•°ç±»å‹è¯†åˆ«æ–¹æ³•ï¼ŒJVM æ˜¯é€šè¿‡æ–¹æ³•åå’Œæ–¹æ³•æè¿°ç¬¦å»è¯†åˆ«æ–¹æ³•çš„ï¼Œ<code>æ–¹æ³•æè¿°ç¬¦</code>åŒ…æ‹¬<code>æ–¹æ³•å‚æ•°ç±»å‹</code>å’Œ<code>è¿”å›å€¼</code>ï¼Œæ³¨æ„åœ¨JVMçš„æ–¹æ³•æè¿°ç¬¦ä¸­æ˜¯åŒ…æ‹¬æ–¹æ³•çš„è¿”å›å€¼çš„ã€‚æ‰€ä»¥åœ¨ä¸€ä¸ªç±»ä¸­å¦‚æœå‡ºç°å¤šä¸ªæ–¹æ³•åå’Œæ–¹æ³•æè¿°ç¬¦çš„JVMåœ¨ç±»åŠ è½½çš„éªŒè¯é˜¶æ®µå°±ä¼šæŠ¥é”™ã€‚</p><p>ç”±äºé‡è½½æ–¹æ³•åœ¨ç¼–è¯‘æœŸå·²ç»ç¡®å®šï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¤å®šï¼Œåœ¨ JVM å±‚é¢ä¸å­˜åœ¨é‡è½½è¿™ä¸€æ¦‚å¿µã€‚å› ä¸ºå¯¹äº JVMæ¥è¯´è¿™å°±æ˜¯ä¸¤ä¸ªæ–¹æ³•ã€‚æ‰€ä»¥é’ˆå¯¹JVMæ¥è¯´åœ¨<code>ç¼–è¯‘æœŸå¯ä»¥ç›´æ¥è§£æ</code>è¯†åˆ«çš„ç›®æ ‡æ–¹æ³•å°±æ˜¯<code>é™æ€ç»‘å®šï¼ˆstatic bindingï¼‰</code>ï¼Œè€Œ<code>åŠ¨æ€ç»‘å®šï¼ˆdynamic bindingï¼‰</code>æŒ‡çš„æ˜¯éœ€è¦åœ¨<code>è¿è¡ŒæœŸé—´æ ¹æ®è°ƒç”¨è€…çš„ç±»å‹æ¥è¯†åˆ«ç›®æ ‡æ–¹æ³•</code>çš„æƒ…å†µã€‚æ‰€ä»¥ Java ç¼–è¯‘å™¨ä¼šå°†æ‰€æœ‰å¯¹éç§æœ‰çš„å®ä¾‹æ–¹æ³•è§£æä¸ºéœ€è¦åŠ¨æ€ç»‘å®šçš„ç±»å‹ã€‚</p><p>åœ¨ä¸Šä¸€ç¯‡å­—èŠ‚ç ä¸­æåˆ°äº†äº”ç§å…³äºæ–¹æ³•è°ƒç”¨æ“ä½œç </p><ol><li>invokestaticï¼šç”¨äºè°ƒç”¨é™æ€æ–¹æ³•ã€‚</li><li>invokespecialï¼šç”¨äºè°ƒç”¨ç§æœ‰å®ä¾‹æ–¹æ³•ã€æ„é€ å™¨ï¼Œä»¥åŠä½¿ç”¨ super å…³é”®å­—è°ƒç”¨çˆ¶ç±»çš„å®ä¾‹æ–¹æ³•æˆ–æ„é€ å™¨ï¼Œå’Œæ‰€å®ç°æ¥å£çš„é»˜è®¤æ–¹æ³•ã€‚</li><li>invokevirtualï¼šç”¨äºè°ƒç”¨éç§æœ‰å®ä¾‹æ–¹æ³•ã€‚</li><li>invokeinterfaceï¼šç”¨äºè°ƒç”¨æ¥å£æ–¹æ³•ï¼ˆç”¨æ¥å£çš„å»è°ƒç”¨ï¼‰ã€‚</li><li>invokedynamicï¼šç”¨äºè°ƒç”¨åŠ¨æ€æ–¹æ³•ã€‚</li></ol><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-keyword">class</span> TestMain &#123;<br><br>    public static void main(String<span class="hljs-literal">[]</span> args) &#123;<br>        HiClass hiClass = <span class="hljs-keyword">new</span> <span class="hljs-constructor">HiClass()</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(hiClass.hi<span class="hljs-constructor">You(<span class="hljs-string">&quot;daiwei&quot;</span>)</span>);<br>        GoodNight goodNight = (GoodNight) hiClass;<br>        goodNight.good<span class="hljs-constructor">Night(<span class="hljs-string">&quot;daiwei&quot;</span>)</span>;<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>out.println(<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Arrays</span>.</span></span>stream(<span class="hljs-keyword">new</span> <span class="hljs-built_in">int</span><span class="hljs-literal">[]</span>&#123;<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>&#125;).reduce(<span class="hljs-number">0</span>, Integer::sum));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç”Ÿæˆçš„å­—èŠ‚ç å¦‚ä¸‹ï¼ˆåªæˆªå–æ–¹æ³•éƒ¨åˆ†ï¼‰</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">public</span> <span class="hljs-string">static</span> <span class="hljs-string">void</span> <span class="hljs-string">main(java.lang.String[]);</span><br>    <span class="hljs-attr">descriptor:</span> <span class="hljs-string">([Ljava/lang/String;)V</span><br>    <span class="hljs-attr">flags:</span> <span class="hljs-string">ACC_PUBLIC,</span> <span class="hljs-string">ACC_STATIC</span><br>    <span class="hljs-attr">Code:</span><br>      <span class="hljs-string">stack=5,</span> <span class="hljs-string">locals=3,</span> <span class="hljs-string">args_size=1</span><br>         <span class="hljs-attr">0:</span> <span class="hljs-string">new</span>           <span class="hljs-comment">#2                  // class io/daiwei/jvm/HiClass</span><br>         <span class="hljs-attr">3:</span> <span class="hljs-string">dup</span><br>         <span class="hljs-attr">4:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#3                  // Method io/daiwei/jvm/HiClass.&quot;&lt;init&gt;&quot;:()V</span><br>         <span class="hljs-attr">7:</span> <span class="hljs-string">astore_1</span><br>         <span class="hljs-attr">8:</span> <span class="hljs-string">getstatic</span>     <span class="hljs-comment">#4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-attr">11:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">12:</span> <span class="hljs-string">ldc</span>           <span class="hljs-comment">#5                  // String daiwei</span><br>        <span class="hljs-attr">14:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#6                  // Method io/daiwei/jvm/HiClass.hiYou:(Ljava/lang/String;)Ljava/lang/String;</span><br>        <span class="hljs-attr">17:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#7                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>        <span class="hljs-attr">20:</span> <span class="hljs-string">aload_1</span><br>        <span class="hljs-attr">21:</span> <span class="hljs-string">astore_2</span><br>        <span class="hljs-attr">22:</span> <span class="hljs-string">aload_2</span><br>        <span class="hljs-attr">23:</span> <span class="hljs-string">ldc</span>           <span class="hljs-comment">#5                  // String daiwei</span><br>        <span class="hljs-attr">25:</span> <span class="hljs-string">invokeinterface</span> <span class="hljs-comment">#8,  2            // InterfaceMethod io/daiwei/jvm/GoodNight.goodNight:(Ljava/lang/String;)V</span><br>        <span class="hljs-attr">30:</span> <span class="hljs-string">getstatic</span>     <span class="hljs-comment">#4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-attr">33:</span> <span class="hljs-string">iconst_3</span><br>        <span class="hljs-attr">34:</span> <span class="hljs-string">newarray</span>       <span class="hljs-string">int</span><br>        <span class="hljs-attr">36:</span> <span class="hljs-string">dup</span><br>        <span class="hljs-attr">37:</span> <span class="hljs-string">iconst_0</span><br>        <span class="hljs-attr">38:</span> <span class="hljs-string">iconst_1</span><br>        <span class="hljs-attr">39:</span> <span class="hljs-string">iastore</span><br>        <span class="hljs-attr">40:</span> <span class="hljs-string">dup</span><br>        <span class="hljs-attr">41:</span> <span class="hljs-string">iconst_1</span><br>        <span class="hljs-attr">42:</span> <span class="hljs-string">iconst_2</span><br>        <span class="hljs-attr">43:</span> <span class="hljs-string">iastore</span><br>        <span class="hljs-attr">44:</span> <span class="hljs-string">dup</span><br>        <span class="hljs-attr">45:</span> <span class="hljs-string">iconst_2</span><br>        <span class="hljs-attr">46:</span> <span class="hljs-string">iconst_3</span><br>        <span class="hljs-attr">47:</span> <span class="hljs-string">iastore</span><br>        <span class="hljs-attr">48:</span> <span class="hljs-string">invokestatic</span>  <span class="hljs-comment">#9                  // Method java/util/Arrays.stream:([I)Ljava/util/stream/IntStream;</span><br>        <span class="hljs-attr">51:</span> <span class="hljs-string">iconst_0</span><br>        <span class="hljs-attr">52:</span> <span class="hljs-string">invokedynamic</span> <span class="hljs-comment">#10,  0             // InvokeDynamic #0:applyAsInt:()Ljava/util/function/IntBinaryOperator;</span><br>        <span class="hljs-attr">57:</span> <span class="hljs-string">invokeinterface</span> <span class="hljs-comment">#11,  3           // InterfaceMethod java/util/stream/IntStream.reduce:(ILjava/util/function/IntBinaryOperator;)I</span><br>        <span class="hljs-attr">62:</span> <span class="hljs-string">invokevirtual</span> <span class="hljs-comment">#12                 // Method java/io/PrintStream.println:(I)V</span><br>        <span class="hljs-attr">65:</span> <span class="hljs-string">return</span><br></code></pre></td></tr></table></figure><p>ç»“åˆä¸Šä¸€ç¯‡å­—èŠ‚ç çš„çŸ¥è¯†ï¼Œè¿™é‡Œçš„å­—èŠ‚ç ä¸éš¾åˆ†æï¼Œ<code>4: invokespecial</code> è¿™é‡Œæ˜¯è°ƒç”¨æ„é€ å‡½æ•°ï¼Œ<code>14: invokevirtual #6 // Method io/daiwei/jvm/HiClass.hiYou</code> è¿™é‡Œæ˜¯ä½¿ç”¨ <code>invokevirutal</code> è°ƒç”¨ hiYou æ–¹æ³•ã€‚<code>invokeinterface #8,  2 // InterfaceMethod io/daiwei/jvm/GoodNight.goodNight:(Ljava/lang/String;)V</code> ä½¿ç”¨ <code>invokeinterface</code> è°ƒç”¨æ¥å£æ–¹æ³•ã€‚<code>52: invokedynamic #10,  0</code> è¿™é‡Œåˆ™æ˜¯ lambda è¡¨è¾¾å¼çš„ <code>invokedynamic</code>ã€‚</p><p>é€šå¸¸æƒ…å†µä¸‹ <code>invokestatic</code> å’Œ <code>invokespeical</code>ï¼ŒJVM èƒ½ç›´æ¥è¯†åˆ«å‡ºç›®æ ‡æ–¹æ³•ï¼ˆé™æ€ç»‘å®šï¼‰ï¼Œè€Œ <code>invokevirutal</code> å’Œ <code>invokeinterface</code> åˆ™éœ€è¦åœ¨è¿è¡Œæ—¶ï¼ŒåŠ¨æ€åˆ¤å®šç›®æ ‡ç±»å‹ä»è€Œç¡®å®šç›®æ ‡æ–¹æ³•ï¼ˆåŠ¨æ€ç»‘å®šï¼‰ã€‚å¯¹äº final æ–¹æ³•å¯ä»¥ç›´æ¥ç¡®å®šç›®æ ‡æ–¹æ³•ã€‚</p><h3 id="è°ƒç”¨æŒ‡ä»¤çš„ç¬¦å·å¼•ç”¨"><a href="#è°ƒç”¨æŒ‡ä»¤çš„ç¬¦å·å¼•ç”¨" class="headerlink" title="è°ƒç”¨æŒ‡ä»¤çš„ç¬¦å·å¼•ç”¨"></a>è°ƒç”¨æŒ‡ä»¤çš„ç¬¦å·å¼•ç”¨</h3><p>åœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“è°ƒç”¨ç›®æ ‡æ–¹æ³•çš„å†…å­˜åœ°å€ã€‚ç¼–è¯‘å™¨ä¼šæš‚æ—¶ç”¨æ–¹æ³•çš„ç¬¦å·å¼•ç”¨ä»£æ›¿ç›®æ ‡æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ–¹æ³•æ–¹æ³•åå’Œæ–¹æ³•æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ª <code>io/daiwei/jvm/HiClass.hiYou:(Ljava/lang/String;)Ljava/lang/String;</code></p><ul><li><code>io/daiwei/jvm/HiClass.hiYou</code> ç›®æ ‡ç±»åæ–¹æ³•åã€‚</li><li><code>(Ljava/lang/String;)</code> å‚æ•°ç±»å‹ï¼ŒLä»£è¡¨å¼•ç”¨ç±»å‹ ï¼Œè¿™é‡Œæ˜¯å¼•ç”¨ç±»å‹ Stringã€‚</li><li><code>Ljava/lang/String;</code> è¿”å›ç±»å‹ï¼Œå¼•ç”¨ç±»å‹ Stringã€‚</li></ul><p>è¿™äº›æ–¹æ³•æè¿°ç¬¦ä½œä¸ºå¸¸é‡ä¿¡æ¯å­˜åœ¨ç±»çš„<code>å¸¸é‡æ± </code>ä¸­ã€‚åœ¨ä½¿ç”¨è¿™äº›ç¬¦å·å¼•ç”¨å­—èŠ‚ç ä¹‹å‰ï¼ŒJVM ä¼šåœ¨ç±»åŠ è½½é˜¶æ®µæŠŠå®ƒæ›¿æ¢ä¸ºçœŸæ­£çš„å¼•ç”¨ã€‚</p><p>å¯¹äº<code>éæ¥å£</code>ç¬¦å·å¼•ç”¨ï¼Œå‡å®šè¯¥ç¬¦å·å¼•ç”¨æŒ‡å‘ç±»Cï¼Œåˆ™ Java è™šæ‹Ÿæœºä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤æŸ¥æ‰¾ã€‚ï¼ˆC -&gt; C çˆ¶ç±» -&gt; C é—´æ¥å®ç°æ¥å£ï¼‰</p><ol><li>åœ¨ C ä¸­æŸ¥æ‰¾ç¬¦åˆåå­—åŠæè¿°ç¬¦çš„æ–¹æ³•ã€‚</li><li>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨ C çš„çˆ¶äº²ç±»ä¸­ç»§ç»­æœç´¢ï¼Œç›´è‡³ Object ç±»ã€‚</li><li>å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåœ¨ C ç›´æ¥æˆ–è€…é—´æ¥å®ç°çš„æ¥å£ä¸­æœç´¢ã€‚è¿™ä¸€æ­¥æœç´¢çš„æ–¹æ³•å¿…é¡»æ˜¯ éç§æœ‰ï¼Œéé™æ€çš„ã€‚</li></ol><p>è°ƒç”¨<code>æ¥å£</code>ç¬¦å·å¼•ç”¨ï¼Œå‡å®šè¯¥ç¬¦å·å¼•ç”¨æŒ‡å‘ I ï¼Œåˆ™ Java è™šæ‹Ÿæœºä¼šæŒ‰ç…§å¦‚ä¸‹æ­¥éª¤è¿›è¡ŒæŸ¥æ‰¾ã€‚</p><ol><li>åœ¨ I ä¸­æŸ¥æ‰¾ç¬¦åˆåå­—åŠæè¿°ç¬¦çš„æ–¹æ³•ã€‚ï¼ˆI -&gt; Object -&gt;I è¶…ç±»æ¥å£ï¼‰</li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåœ¨ Object ç±»ä¸­çš„å…¬æœ‰å®ä¾‹æ–¹æ³•ä¸­æœç´¢ã€‚</li><li>å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™åœ¨ I çš„è¶…æ¥å£ä¸­æœç´¢ã€‚è¿™ä¸€æ­¥çš„æœç´¢ç»“æœçš„è¦æ±‚ä¸éæ¥å£ç¬¦å·å¼•ç”¨æ­¥éª¤ 3 çš„è¦æ±‚ä¸€è‡´ã€‚</li></ol><p>ç»è¿‡ä¸Šè¿°çš„è§£æä¹‹åï¼Œé™æ€æ–¹æ³•ä¼šè¢«è§£ææˆä¸€ä¸ªæ–¹æ³•çš„æŒ‡é’ˆï¼Œè€Œéœ€è¦åŠ¨æ€ç»‘å®šçš„æ–¹æ³•åˆ™ä¼šè¢«è§£ææˆä¸€ä¸ªæ–¹æ³•è¡¨çš„ç´¢å¼•ã€‚</p><h3 id="æ–¹æ³•è¡¨"><a href="#æ–¹æ³•è¡¨" class="headerlink" title="æ–¹æ³•è¡¨"></a>æ–¹æ³•è¡¨</h3><p>Java è™šæ‹Ÿæœºé€šè¿‡ä¸€ç§ç”¨ç©ºé—´æ¢æ—¶é—´çš„æ–¹æ³•æ¥å®ç°åŠ¨æ€ç»‘å®šã€‚åœ¨ç±»åŠ è½½çš„å‡†å¤‡é˜¶æ®µï¼Œä¸ä»…ä¼šä¸ºé™æ€å­—æ®µåˆ†é…å†…å­˜ï¼Œè¿˜ä¼šç”Ÿæˆç±»çš„æ–¹æ³•è¡¨ã€‚æ–¹æ³•è¡¨çš„æ˜¯ä¸€ä¸ªæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ã€‚è¿™ä¸ªæ•°æ®å°±æ˜¯åŠ¨æ€ç»‘å®šå®ç°çš„å…³é”®ï¼Œè°ƒç”¨ <code>invokevirutal</code> æœ‰ <code>è™šæ–¹æ³•è¡¨ï¼ˆvirtual method tableï¼Œvtableï¼‰</code></p><p>è°ƒç”¨ <code>invokeinterface</code> æœ‰<code>æ¥å£æ–¹æ³•è¡¨ï¼ˆinterface method tableï¼Œ itableï¼‰</code>ï¼Œitable ä¼šç¨å¾®å¤æ‚äº›ï¼Œä½†æ˜¯åŸç†æ˜¯ä¸€è‡´çš„ã€‚åœ¨è¿™ä¸ªæ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æŒ‡å‘ä¸€ä¸ªå½“å‰ç±»æˆ–è€…çˆ¶ç±»ä¸­çš„ä¸€ä¸ªéç§æœ‰çš„å®ä¾‹æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•å¯ä»¥æ˜¯å…·ä½“çš„å¯æ‰§è¡Œçš„æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥æ˜¯æŠ½è±¡çš„æ²¡æœ‰æ–¹æ³•ä½“çš„æŠ½è±¡æ–¹æ³•ã€‚æ–¹æ³•è¡¨æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªå…³é”®çš„ç‰¹è´¨ï¼š</p><ul><li>å­ç±»æ–¹æ³•è¡¨ä¸­åŒ…å«æ‰€æœ‰çš„çˆ¶ç±»æ–¹æ³•è¡¨çš„ä¸­çš„æ‰€æœ‰æ–¹æ³•ã€‚</li><li>å­ç±»æ–¹æ³•è¡¨ä¸­çš„ç´¢å¼•å€¼ä¸ä»–é‡å†™çˆ¶ç±»æ–¹æ³•åœ¨æ–¹æ³•è¡¨ä¸­çš„ç´¢å¼•å€¼ç›¸åŒã€‚</li></ul><table><thead><tr><th>Personæ–¹æ³•è¡¨</th><th>walk()</th><th>share()</th><th>talk()</th><th></th></tr></thead><tbody><tr><td>Chineseæ–¹æ³•è¡¨</td><td>walk()</td><td>share()</td><td>talk()</td><td>chineseDo()</td></tr></tbody></table><p>åœ¨ä¸Šé¢è¿™ä¸ªè¡¨ä¸­ Chinese ç±»æ˜¯ Person çš„å­ç±»ï¼Œåœ¨ç±»åŠ è½½é˜¶æ®µç”Ÿæˆæ–¹æ³•è¡¨ï¼Œé™æ€æ–¹æ³•è§£ææ–¹æ³•å¼•ç”¨çš„æ—¶å€™å°†å…·ä½“çš„æ–¹æ³•æ›¿æ¢å…·ä½“æ–¹æ³•çš„æŒ‡é’ˆï¼Œå¯¹äºåŠ¨æ€ç»‘å®šçš„æ–¹æ³•è€Œè¨€ï¼Œæ›¿æ¢çš„å¼•ç”¨åˆ™æ˜¯æ–¹æ³•è¡¨ä¸­çš„ç´¢å¼•å€¼ï¼ˆå®é™…ä¸Šå¹¶ä¸åªæ˜¯ç´¢å¼•å€¼ï¼‰ã€‚è¿™æ ·çš„è¯ï¼Œåœ¨æ–¹æ³•è¿è¡Œé˜¶æ®µåªè¦æ‹¿åˆ°è¿è¡Œæ—¶çš„å¯¹è±¡ï¼Œæ ¹æ®å®ƒçš„æ–¹æ³•è¡¨æ‹¿åˆ°å…·ä½“çš„è¦æ‰§è¡Œçš„ç›®æ ‡æ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¾¿æ˜¯åŠ¨æ€ç»‘å®šã€‚</p><p>æœ‰äº†é¢å¤–çš„æ“ä½œï¼Œå°±ä¼šæœ‰é¢å¤–çš„æ€§èƒ½æ¶ˆè€—ï¼Œä½†æ˜¯åœ¨ç±»åŠ è½½é˜¶æ®µç”Ÿæˆæ–¹æ³•è¡¨ï¼Œè§£ææ–¹æ³•æ›¿æ¢æˆç´¢å¼•ï¼Œæ‰§è¡Œé˜¶æ®µæŸ¥è¯¢ç›®æ ‡æ–¹æ³•ï¼Œè™½ç„¶è¿™ä¸ªè¿‡ç¨‹çš„å¾ˆç®€å•ï¼Œæ˜¯å¦å¯ä»¥çœ‹ä½œå¯¹JVM æ²¡æœ‰å¤ªå¤§çš„å½±å“å‘¢ï¼Ÿæ˜¾ç„¶æ˜¯ä¸èƒ½çš„ã€‚æ‰€ä»¥é’ˆå¯¹è¿™ä¸ªæƒ…å†µç¼–è¯‘å™¨æœ‰ä¸¤ä¸ªä¼˜åŒ–æ‰‹æ®µå†…è”ç¼“å­˜ï¼ˆinline cacheï¼‰å’Œæ–¹æ³•å†…è”ï¼ˆmethod inlineï¼‰ã€‚</p><h3 id="å†…è”ç¼“å­˜å’Œæ–¹æ³•å†…è”"><a href="#å†…è”ç¼“å­˜å’Œæ–¹æ³•å†…è”" class="headerlink" title="å†…è”ç¼“å­˜å’Œæ–¹æ³•å†…è”"></a>å†…è”ç¼“å­˜å’Œæ–¹æ³•å†…è”</h3><p>å†…è”ç¼“å­˜æ˜¯ä¸€ç§åŠ å¿«ç»‘å®šçš„æ–¹æ³•ï¼Œå®ƒèƒ½å¤Ÿç¼“å­˜åŠ¨æ€è°ƒç”¨çš„ç±»å‹ä»¥åŠè¯¥ç±»å‹å¯¹åº”çš„ç›®æ ‡æ–¹æ³•ï¼Œå¦‚æœåœ¨åé¢çš„è°ƒç”¨ä¸­å‡»ä¸­å·²ç¼“å­˜ç±»å‹ï¼Œä¼šç›´æ¥ä»ç¼“å­˜ä¸­è·å–ç›®æ ‡æ–¹æ³•æ‰§è¡Œã€‚å¦‚æœæ²¡æœ‰å‘½ä¸­è°ƒç”¨ç±»å‹ï¼Œåˆ™é€€åŒ–ä¸ºæ–¹æ³•è¡¨åŠ¨æ€ç»‘å®šã€‚è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„ç”¨ç©ºé—´æ¢æ¢æ—¶é—´çš„æ“ä½œã€‚</p><p>è¿˜æœ‰ä¸€ç§ä¼˜åŒ–æ‰‹æ®µé‚£ä¾¿æ˜¯æ–¹æ³•å†…è”ï¼Œç®€å•ä¸”é«˜é¢‘çš„æ–¹æ³•ä¾‹å¦‚ä¸€äº› get/set æ–¹æ³•ï¼ŒJava çš„å³æ—¶ç¼–è¯‘å™¨ä¼šç›´æ¥è¿›è¡Œæ–¹æ³•å†…è”ä¹Ÿå°±æ˜¯ç›´æ¥æŠŠè°ƒç”¨çš„æ–¹æ³•å’Œå¤–é¢çš„è°ƒç”¨ä¼˜åŒ–æˆä¸€ä¸ªå®Œæ•´çš„æ–¹æ³•æœºå™¨ç å­˜å‚¨èµ·æ¥ã€‚ç”¨è¿™ç§æ–¹æ³•æ¥æé«˜æ‰§è¡Œæ•ˆç‡ã€‚è¿™é‡Œè¦æ³¨æ„æ–¹æ³•å†…è”æ˜¯çœŸå†…è”ï¼Œè€Œå†…è”ç¼“å­˜é™„å¸¦å†…è”äºŒå­—ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰å†…è”ç›®æ ‡æ–¹æ³•ã€‚è¿™é‡Œéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œä»»ä½•æ–¹æ³•è°ƒç”¨é™¤éè¢«å†…è”ï¼Œå¦åˆ™éƒ½ä¼šæœ‰å›ºå®šå¼€é”€ã€‚è¿™äº›å¼€é”€æ¥æºäºä¿å­˜ç¨‹åºåœ¨è¯¥æ–¹æ³•ä¸­çš„æ‰§è¡Œä½ç½®ï¼Œä»¥åŠæ–°å»ºã€å‹å…¥å’Œå¼¹å‡ºæ–°æ–¹æ³•æ‰€ä½¿ç”¨çš„æ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯å†…è”ç¼“å­˜æ˜¯å‡å†…è”ã€‚</p><h2 id="Java-åå°„è°ƒç”¨æœºåˆ¶"><a href="#Java-åå°„è°ƒç”¨æœºåˆ¶" class="headerlink" title="Java åå°„è°ƒç”¨æœºåˆ¶"></a>Java åå°„è°ƒç”¨æœºåˆ¶</h2><p>Java çš„åå°„æœºåˆ¶å¯ä»¥è®©ä»£ç åœ¨è¿è¡Œé˜¶æ®µè‡ªçœï¼Œå¯ä»¥è®©ä»£ç çŸ¥é“è¿è¡Œé˜¶æ®µçš„æŸä¸ªå¯¹è±¡çš„æŸäº›å­—æ®µå’Œæ–¹æ³•ï¼Œå¹¶è¿›è¡Œè°ƒç”¨ï¼Œé‚£ Java çš„æ–¹æ³•åå°„è°ƒç”¨æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@CallerSensitive<br>public Object invoke(Object obj, Object... args)<br>    throws IllegalAccessException, IllegalArgumentException,<br>       InvocationTargetException<br>&#123;<br>    <span class="hljs-keyword">if</span> (!override) &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Reflection</span>.</span></span>quick<span class="hljs-constructor">CheckMemberAccess(<span class="hljs-params">clazz</span>, <span class="hljs-params">modifiers</span>)</span>) &#123;<br>            Class&lt;?&gt; caller = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Reflection</span>.</span></span>get<span class="hljs-constructor">CallerClass()</span>;<br>            check<span class="hljs-constructor">Access(<span class="hljs-params">caller</span>, <span class="hljs-params">clazz</span>, <span class="hljs-params">obj</span>, <span class="hljs-params">modifiers</span>)</span>;<br>        &#125;<br>    &#125;<br>    MethodAccessor ma = methodAccessor;             <span class="hljs-comment">// read volatile</span><br>    <span class="hljs-keyword">if</span> (ma<span class="hljs-operator"> == </span>null) &#123;<br>        ma = acquire<span class="hljs-constructor">MethodAccessor()</span>;<br>    &#125;<br>    return ma.invoke(obj, args);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° invoke æ–¹æ³•çš„æºç ï¼Œmethod.invoke()ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨ <code>MethodAccessor.invoke()</code>ï¼Œè€ŒMethodAccessor åˆæœ‰ä¸¤ä¸ªå®ç°ç±» <code>DeleagetingMethodAccessor</code> å’Œ <code>NativeMethodAccessor</code> ï¼Œä¸€ä¸ªæ˜¯ä½¿ç”¨äº†å§”æ´¾æ¨¡å¼å®ç°è°ƒç”¨ï¼Œå¦ä¸€ä¸ªåˆ™æ˜¯é€šè¿‡ Native æ–¹æ³•å®ç°åå°„è°ƒç”¨ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210509204937.png"></p><p>åœ¨æ‰§è¡Œåå°„çš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨<code>NativeMethodAccessor</code> ç›´æ¥è°ƒç”¨ Native æ–¹æ³•ï¼Œä½†æ˜¯è°ƒç”¨ Native æ–¹æ³•è¦åˆ‡æ¢æˆ C++ æ‰§è¡Œæ–¹æ³•ï¼Œè¿™ä¸ªæˆæœ¬æ˜¯å¤§äºä¸€èˆ¬çš„æ–¹æ³•è°ƒç”¨ã€‚é‚£æˆ‘ä»¬ç”Ÿæˆä»£ç†æ¯æ¬¡åå°„è°ƒç”¨æˆ‘ä»¬å°±å»è°ƒç”¨æˆ‘ä»¬çš„ä»£ç†å¯¹è±¡ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯å°±å¯ä»¥æ›´å¿«äº†å‘¢ï¼Ÿè¿™æ ·åªæ˜¯æ–¹æ³•è°ƒç”¨å˜å¿«äº†ï¼Œä½†æ˜¯ç”Ÿæˆä»£ç†å¯¹è±¡æ˜¯å¾ˆæ…¢çš„ï¼Œé‚£ç”Ÿæˆä»£ç†å¯¹è±¡çš„æ—¶é—´æˆæœ¬åˆæ€ä¹ˆè®¡ç®—å‘¢ï¼Ÿæ‰€ä»¥ JVM é‡‡ç”¨äº†æŠ˜ä¸­çš„åŠæ³•ï¼Œ<code>è®¾ç½®é˜ˆå€¼</code>ï¼Œå½“è°ƒç”¨æ¬¡æ•°è¶…è¿‡<code>é»˜è®¤çš„15</code>æ¬¡JVM ä¸ºå…¶ç”Ÿæˆä»£ç†å¯¹è±¡ï¼Œç”± Native æ–¹æ³•è°ƒç”¨åˆ‡æ¢ä¸º Delegate æ–¹æ³•è°ƒç”¨ï¼Œæ¥æé«˜æ•´ä½“çš„æ‰§è¡Œæ€§èƒ½ã€‚ä»¥ä¸ºä¸€åˆ‡éƒ½å¾ˆç¾å¥½äº†ï¼Œçªç„¶æˆ‘ä»¬çš„ä»£ç å‘ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¸€èµ·çœ‹çœ‹å¼‚å¸¸æ˜¯æ€ä¹ˆJVMå¼‚å¸¸æ˜¯æ€ä¹ˆå¤„ç†å§ã€‚</p><h2 id="Java-å¼‚å¸¸å¤„ç†æœºåˆ¶"><a href="#Java-å¼‚å¸¸å¤„ç†æœºåˆ¶" class="headerlink" title="Java å¼‚å¸¸å¤„ç†æœºåˆ¶"></a>Java å¼‚å¸¸å¤„ç†æœºåˆ¶</h2><h3 id="Java-å¼‚å¸¸"><a href="#Java-å¼‚å¸¸" class="headerlink" title="Java å¼‚å¸¸"></a>Java å¼‚å¸¸</h3><p>å¼‚å¸¸å¤„ç†ä¸­ä¸»è¦ç»„æˆè¦ç´ ï¼šæŠ›å‡ºå¼‚å¸¸å’Œæ•è·å¼‚å¸¸ã€‚ç”±äº Java ä¸­æ²¡æœ‰ gotoï¼Œæ‰€ä»¥è¿™ä¸¤å¤§è¦ç´ é…ç½®å…±åŒå®ç°ç¨‹åºæµç¨‹çš„éæ­£å¸¸è½¬ç§»ã€‚æŠ›å‡ºå¼‚å¸¸å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯<code>æ˜¾å¼æŠ›å‡º</code>å¦å¤–ä¸€ç§æ˜¯å¦å¤–ä¸€ç§æ˜¯<code>éšå¼æŠ›å‡º</code>ã€‚æ˜¾å¼æŠ›å‡ºæŒ‡çš„æ˜¯æˆ‘ä»¬åœ¨ç¨‹åºä¸­ä½¿ç”¨ new threw çš„æ–¹å¼æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œéšå¼æŠ›å‡ºåˆ™æ˜¯ Java è™šæ‹Ÿæœºæ‰§è¡Œåˆ°å¼‚å¸¸æƒ…å†µï¼Œæ— æ³•ç»§ç»­æŠ›å‡ºçš„å¼‚å¸¸ã€‚ä¾‹å¦‚æ•°ç»„è¶Šç•Œï¼Œé™¤0ç­‰ã€‚å¼‚å¸¸æ“ä½œé€šå¸¸åˆ†æˆä¸‹é¢ä¸‰å—ï¼š</p><ul><li>try ä»£ç å—ï¼šç”¨æ¥æ ‡è®°éœ€è¦å¼‚å¸¸ç›‘æµ‹çš„ä»£ç ã€‚</li><li>catch ä»£ç å—ï¼šåœ¨å¼‚å¸¸å‘ç”Ÿåæ‰§è¡Œçš„åç»­é€»è¾‘å—ã€‚åœ¨ Java ä¸­ä¸€ä¸ª try å—åé¢å¯ä»¥è·Ÿå¤šä¸ª catch ä»£ç å—ï¼Œç”¨æ¥æ•æ‰ä¸åŒçš„å¼‚å¸¸ï¼Œå‘ç”Ÿå¼‚å¸¸å JVM ä¼šä»ä¸Šåˆ°ä¸‹ä¾æ¬¡åŒ¹é…å¼‚å¸¸å¤„ç†ä»£ç ï¼Œå› æ­¤å‰é¢çš„ catch å—ä¸èƒ½è¦†ç›–åé¢çš„ catch å—ã€‚</li><li>finally ä»£ç å—ï¼šåœ¨ try å’Œ catch åé¢çš„ä»£ç å—ï¼Œç”¨æ¥å£°æ˜ä¸€æ®µå¿…ä¼šæ‰§è¡Œçš„é€»è¾‘ï¼Œå®ƒçš„è®¾è®¡åˆè¡·æ˜¯ç”¨æ¥é¿å…å› ä¸ºå¼‚å¸¸è·³è¿‡çš„æ²¡æœ‰æ‰§è¡Œçš„ä¸€äº›æ¸…ç†é€»è¾‘ã€‚</li></ul><p>æ‰€ä»¥æ­£å¸¸æµç¨‹ä¸‹æ¥ï¼Œå¦‚æœ try ä¸­çš„å¼‚å¸¸æ²¡æœ‰è¢«æ•è·ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸å¹¶æ‰§è¡Œ finally ã€‚å¦‚æœæ­£å¸¸æµç¨‹ä¸‹æ¥ï¼Œtry ä¸­æ²¡æœ‰å‘ç”Ÿå¼‚å¸¸ï¼Œè€Œæ˜¯ finally ä»£ç ä¸­å‡ºç°äº†å¼‚å¸¸ï¼Œé‚£ finally åªèƒ½ä¸­æ–­å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</p><h3 id="Java-è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ"><a href="#Java-è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ" class="headerlink" title="Java è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ"></a>Java è™šæ‹Ÿæœºæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ</h3><p>åœ¨ç¼–è¯‘ç”Ÿæˆçš„å­—èŠ‚ç ä¸­ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½ä¼šå¸¦æœ‰ä¸€ä¸ªå¼‚å¸¸è¡¨ï¼Œå¼‚å¸¸è¡¨ä¸­çš„æ¯ä¸€æ¡è®°å½•ä»£è¡¨ä¸€ä¸ªå¼‚å¸¸å¤„ç†å™¨ï¼Œå¹¶ä¸”ç”± from æŒ‡é’ˆã€to æŒ‡é’ˆã€target æ‰§æ”¿ä»¥åŠæ‰€æ•è·çš„ç±»å‹ã€‚æŒ‡é’ˆçš„å€¼æ˜¯<code>å­—èŠ‚ç ç´¢å¼•</code>ï¼ˆbytecode indexï¼Œbciï¼‰ï¼Œå·²ç»å®šä½å­—èŠ‚ç ã€‚å…¶ä¸­ from æŒ‡é’ˆå’Œ to æŒ‡é’ˆæ ‡å¿—äº†è¯¥å¼‚å¸¸å¤„ç†å™¨çš„ç›‘æ§èŒƒå›´ï¼Œä¾‹å¦‚ try ä»£ç æ‰€è¦†ç›–çš„èŒƒå›´ã€‚target æŒ‡é’ˆåˆ™æŒ‡å‘å¼‚å¸¸å¤„ç†å™¨çš„èµ·å§‹ä½ç½®ï¼Œä¾‹å¦‚ catch ä»£ç å—çš„èµ·å§‹ä½ç½®ã€‚</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span>[] args) &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;test&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>        e.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;finally!&quot;</span>);<br>    &#125;<br>&#125;<br><br>java codeï½ï½ï½<br><br><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> main(java.lang.<span class="hljs-keyword">String</span>[]);<br>    descriptor: ([Ljava/lang/<span class="hljs-keyword">String</span>;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      stack=<span class="hljs-number">3</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>         <span class="hljs-number">0</span>: <span class="hljs-keyword">new</span>           <span class="hljs-comment">#2                  // class java/lang/RuntimeException</span><br>         <span class="hljs-number">3</span>: dup<br>         <span class="hljs-number">4</span>: ldc           <span class="hljs-comment">#3                  // String test</span><br>         <span class="hljs-number">6</span>: invokespecial <span class="hljs-comment">#4                  // Method java/lang/RuntimeException.&quot;&lt;init&gt;&quot;:(Ljava/lang/String;)V</span><br>         <span class="hljs-number">9</span>: athrow<br>        <span class="hljs-number">10</span>: astore_1<br>        <span class="hljs-number">11</span>: aload_1<br>        <span class="hljs-number">12</span>: invokevirtual <span class="hljs-comment">#6                  // Method java/lang/Exception.printStackTrace:()V</span><br>        <span class="hljs-number">15</span>: getstatic     <span class="hljs-comment">#7                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-number">18</span>: ldc           <span class="hljs-comment">#8                  // String finally!</span><br>        <span class="hljs-number">20</span>: invokevirtual <span class="hljs-comment">#9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>        <span class="hljs-number">23</span>: <span class="hljs-keyword">goto</span>          <span class="hljs-number">37</span><br>        <span class="hljs-number">26</span>: astore_2<br>        <span class="hljs-number">27</span>: getstatic     <span class="hljs-comment">#7                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        <span class="hljs-number">30</span>: ldc           <span class="hljs-comment">#8                  // String finally!</span><br>        <span class="hljs-number">32</span>: invokevirtual <span class="hljs-comment">#9                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>        <span class="hljs-number">35</span>: aload_2<br>        <span class="hljs-number">36</span>: athrow<br>        <span class="hljs-number">37</span>: <span class="hljs-keyword">return</span><br>      <span class="hljs-built_in">Exception</span> table:<br>         <span class="hljs-keyword">from</span>    to  target type<br>             <span class="hljs-number">0</span>    <span class="hljs-number">10</span>    <span class="hljs-number">10</span>   <span class="hljs-class"><span class="hljs-keyword">Class</span> <span class="hljs-title">java</span>/<span class="hljs-title">lang</span>/<span class="hljs-title">Exception</span></span><br><span class="hljs-class">             0    15    26   <span class="hljs-title">any</span></span><br></code></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>Exception table</code>å°±æ˜¯å¼‚å¸¸è¡¨ï¼Œå¦‚æœå‘ç”Ÿäº†å¼‚å¸¸ä¼šä»å¼‚å¸¸è¡¨ä¸­æ‹›å½“å‰ä½ç½®æ˜¯åœ¨é‚£ä¸ªå¼‚å¸¸çš„è¿”å›ï¼Œå¦‚æœåŒ¹é…åˆ°å¤šä¸ªåˆ™ä»ä¸Šåˆ°ä¸‹ä¸€ä¸ªä¸ªåŒ¹é…ï¼Œå¹¶è·³è½¬åˆ°å¯¹åº”çš„ target çš„ä½ç½®å¾€ä¸‹æ‰§è¡Œï¼Œå‰é¢æåˆ°äº† target çš„ä½ç½®æ˜¯ catch å—ï¼ˆå¼‚å¸¸å¤„ç†å™¨ï¼‰å¼€å§‹çš„ä½ç½®ã€‚åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª<code>0 15 26 any</code> çš„å¼‚å¸¸è®°å½•ã€‚çœ‹åˆ°è¿™ä¸ªæˆ‘ä»¬å¯èƒ½ä¼šç–‘æƒ‘ï¼Œæ–¹æ³•ä¸­æ˜æ˜åªæœ‰ä¸€ä¸ªtry catch å—ï¼Œä¸ºä»€ä¹ˆå¼‚å¸¸è¡¨ä¸­ä¼šæœ‰ä¸¤æ¡è®°å½•ï¼Œè€Œä¸”æœ€åä¸€ä¸ªå¼‚å¸¸ç±»å‹æ˜¯ anyã€‚å…¶å®è¿™é‡Œçš„è®°å½•çš„æ˜¯ finallyå—ï¼Œä»target å­—èŠ‚ç å¯¹æ•ˆåº”çš„ä»£è¡¨æ‰§è¡Œçš„å¼€å§‹ä½ç½®ä¸éš¾å‘ç°è¿™æ˜¯ finlly å—çš„ä½ç½®ã€‚</p><p>ä»ä¸Šé¢çš„å­—èŠ‚ç è¿˜èƒ½çœ‹åˆ°ä¸€ä¸ªç»†èŠ‚ï¼Œå°±æ˜¯ finally å—çš„ä»£ç é‡å¤äº†ä¸¤æ¬¡ã€‚finally ä»£ç å—ç¼–è¯‘æ¯”è¾ƒå¤æ‚ï¼Œå½“å‰ç‰ˆæœ¬çš„åšæ³•å°±æ˜¯åœ¨åˆ†åˆ«åœ¨ try å’Œ catch çš„ä»£ç å‡ºå£æ·»åŠ ä¸€æ®µ finally çš„å†…å®¹ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210509205200.png"></p><p>é‚£å¦‚æœåœ¨ catch ä»£ç å—ä¸­è¿˜æ˜¯å‡ºç°äº†å¼‚å¸¸çš„åœºæ™¯ï¼Œå¼‚å¸¸å‘ç”Ÿçš„è¡Œæ•°è¿˜æ˜¯åœ¨ <code>0 15 26 any</code> çš„å¼‚å¸¸è®°å½•èŒƒå›´ï¼ŒåŒæ ·ä¼šåŒ¹é…åˆ° any ä¹Ÿå°±æ˜¯ finally çš„ä»£ç å—ï¼Œè¿™æ ·å°±ä¿è¯äº†ä¸ç®¡åœ¨ä»€ä¹ˆåœºæ™¯å‘ç”Ÿäº†å¼‚å¸¸éƒ½èƒ½æ‰§è¡Œ finally çš„å†…å®¹äº†ï¼Œä½†æ˜¯å¦‚æœ finally é‡Œé¢å‘ç”Ÿäº†å¼‚å¸¸å‘¢ï¼Ÿé‚£å°±æ²¡æœ‰åŠæ³•äº†ã€‚finally ä¼šä¸­æ­¢ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ã€‚ä»å­—èŠ‚ç åˆ†æçš„è§’åº¦ä¹Ÿç¬¦åˆæˆ‘ä»¬å‰é¢çš„ç»“è®ºã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ¥ç€ä¸Šä¸€ç¯‡çš„ Java å­—èŠ‚ç æŠ€æœ¯ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬é€šè¿‡è¿ç”¨å­—èŠ‚ç æŠ€æœ¯ï¼Œåˆ†ææ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä»¥åŠæ–¹æ³•çš„é™æ€ç»‘å®šå’ŒåŠ¨æ€ç»‘å®šã€‚ä»¥åŠä»ç®—æ³•å±‚é¢æ¢ç´¢äº†åŠ¨æ€ç»‘å®šçš„å®ç°åŸç†ä¹Ÿå°±æ˜¯æ–¹æ³•è¡¨ï¼Œä»¥åŠæ–¹æ³•è¡¨çš„ä¼˜åŒ–æ–¹æ¡ˆå†…è”ç¼“å­˜ã€‚å½“ç„¶é™¤äº†æ­£å¸¸çš„è°ƒç”¨æ–¹æ³•ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨åå°„çš„æ–¹å¼å»è¿›è¡Œæ–¹æ³•è°ƒç”¨ã€‚è¿™ä¸€å°èŠ‚è¿˜é€šè¿‡æºç åˆ†æçš„æ–¹å¼æ·±å…¥äº†åå°„çš„å®ç°ç»†èŠ‚ã€‚æœ€åæˆ‘ä»¬ä¸€èµ·çœ‹äº†å¼‚å¸¸è¿™ä¸ªè®©ç¨‹åºå‘˜å–œå¿§å‚åŠçš„æœºåˆ¶ï¼Œé€šè¿‡åˆ›å»ºå¼‚å¸¸è¡¨æ¥å¯¹å¼‚å¸¸çš„æ‰§è¡Œè·¯å¾„è¿›è¡Œç´¢å¼•ï¼Œæ¥ä¿è¯ç¨‹åºçš„æ‰§è¡Œæµç¨‹ã€‚æˆ‘å‘ç°åœ¨æ–¹æ³•è¿™å—JVM å¾ˆå–œæ¬¢ç”¨â€è¡¨â€å»è§£å†³ä¸€äº›é—®é¢˜, æ–¹æ³•è¡¨ï¼Œå¼‚å¸¸è¡¨â€¦</p><p>æ˜¨å¤©å’Œä¸€ä¸ªæœ‹å‹èŠå¤©ï¼ŒèŠåˆ°æ‰€æœ‰ä¸äº†è§£çš„ä¸œè¥¿éƒ½ä¼šè‡ªå¸¦ä¸€å±‚ç¥ç§˜æ„Ÿï¼Œä½†æ˜¯æˆ‘ä»¬çœŸæ­£å»äº†è§£å®ƒä¹‹åä¼šå‘ç°å…¶å®ä¹Ÿå°±é‚£æ ·ï¼Œéƒ½æ˜¯äººèƒ½æƒ³å‡ºæ¥çš„ç‚¹å­ã€‚çœŸæ­£è¦åšçš„æ˜¯ç§¯ç´¯ï¼ŒæŒæ¡å‘ä¸Šçš„åŠæ³•ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½è§æ‹›æ‹†æ‹›å¹¶åˆ›é€ å±äºæˆ‘ä»¬çš„æœªæ¥ã€‚</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœºã€‹JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸Šï¼‰</li><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœºã€‹JVMæ˜¯å¦‚ä½•æ‰§è¡Œæ–¹æ³•è°ƒç”¨çš„ï¼Ÿï¼ˆä¸‹ï¼‰</li><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœºã€‹JVMæ˜¯å¦‚ä½•å®ç°åå°„çš„ï¼Ÿ</li><li>æå®¢æ—¶é—´ä¸“æ ã€Šæ·±å…¥æ‹†è§£Javaè™šæ‹Ÿæœºã€‹JVMæ˜¯å¦‚ä½•å¤„ç†å¼‚å¸¸çš„ï¼Ÿ</li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JVM åŸºç¡€ â€” Java å­—èŠ‚ç </title>
    <link href="/2021/05/07/java-bytecode/"/>
    <url>/2021/05/07/java-bytecode/</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æˆ‘ä»¬é€šå¸¸è¡¨è¿°çš„ JVM é€šå¸¸æœ‰ä¸‰ç§æ„æ€ï¼ŒJVM æ˜¯ Java virtual machine å³ java è™šæ‹Ÿæœºçš„ç¼©å†™ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šå¸¸æ‰€æŒ‡çš„ JVMã€‚JVMè¿˜æ˜¯ä¸€ç§ç”¨äºè®¡ç®—è®¾å¤‡çš„è§„èŒƒï¼Œå®ƒæ˜¯ä¸€ä¸ªè™šæ„å‡ºæ¥çš„è®¡ç®—æœºï¼Œæ˜¯é€šè¿‡åœ¨å®é™…çš„è®¡ç®—æœºä¸Šä»¿çœŸæ¨¡æ‹Ÿå„ç§è®¡ç®—æœºåŠŸèƒ½æ¥å®ç°çš„ã€‚å› æ­¤ JVM ä¹Ÿæ˜¯å›¾çµå®Œå¤‡çš„ã€‚å½“ç„¶ JVM è¿˜å¯ä»¥è¡¨ç¤ºä¸€ä¸ªè™šæ‹Ÿæœºçš„å®ä¾‹ã€‚Java ä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§å°±æ˜¯å’Œå¹³å°æ— å…³ï¼Œè€Œ JVM æ˜¯å®ç°è¿™ä¸€ç‚¹çš„å…³é”®ã€‚JVM åº•å±‚ä½¿ç”¨ C è¿›è¡Œç¼–å†™ï¼Œåªè¦å¹³å°èƒ½æ‰§è¡Œ C è¯­è¨€ï¼Œè¿™ä¹Ÿå°±èƒ½å¯åŠ¨ JVM è¿è¡Œ Java ç¨‹åºã€‚JVM é€šè¿‡ç¼–è¯‘ Java è¯­è¨€ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œå­—èŠ‚ç æ–‡ä»¶åœ¨é€šè¿‡ JVM è¿›è¡Œè§£é‡Šæ‰§è¡Œã€‚å› æ­¤åªè¦è¿è¡Œåœ¨ä¸åŒçš„å¹³å°ä¸Šçš„JVM èƒ½æ‹¿åˆ°å­—èŠ‚ç æ–‡ä»¶ï¼Œå°±èƒ½è§£é‡Šæ‰§è¡Œå‡ºç›¸åŒçš„ç»“æœã€‚è¿™å°±æ˜¯ Java å¯ä»¥ â€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„æ‰§è¡Œâ€ çš„åŸå› ã€‚ </p><p>å½“ç„¶å¹¶ä¸æ˜¯Java è¯­è¨€æ˜¯è·¨å¹³å°çš„è¯­è¨€ï¼Œæ‹¿ C++ ä¸¾ä¸ªä¾‹å­ï¼ŒC++ ä¹Ÿæ˜¯ä¸€é—¨è·¨å¹³å°çš„è¯­è¨€ï¼Œä½†æ˜¯å’Œ Java è¯­è¨€ä¸åŒçš„æ˜¯ï¼ŒC++ éœ€è¦åˆ°ä¸åŒçš„å¹³å°ç”Ÿæˆä¸åŒçš„æ–‡ä»¶ï¼Œç„¶åè¿›è¡Œæ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯æºç è·¨å¹³å°ï¼Œè€Œ Java æ˜¯äºŒè¿›åˆ¶è·¨å¹³å°ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003029.png"></p><h2 id="Java-å­—èŠ‚ç æŠ€æœ¯"><a href="#Java-å­—èŠ‚ç æŠ€æœ¯" class="headerlink" title="Java å­—èŠ‚ç æŠ€æœ¯"></a>Java å­—èŠ‚ç æŠ€æœ¯</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>Java ä»£ç é€šè¿‡ç¼–è¯‘ç”Ÿæˆ Java å­—èŠ‚ç å³ .class æ–‡ä»¶ï¼Œä¸åŒçš„ JVM é€šè¿‡æ‰§è¡Œ .class æ–‡ä»¶å®ç°è·¨å¹³å°ã€‚Java bytecode ç”±ä½†å­—èŠ‚ ï¼ˆbyteï¼‰çš„æŒ‡ä»¤ç»„æˆï¼Œç†è®ºä¸Šæœ€å¤šæ”¯æŒ 256 ä¸ªæ“ä½œç ï¼ˆopencodeï¼‰ã€‚å®é™…ä¸Š Java åªç”¨äº† 200 å·¦å³çš„æ“ä½œç ï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œç åˆ™ä¿ç•™ç»™è°ƒè¯•æ“ä½œã€‚æ“ä½œç ï¼Œ ä¸‹é¢ç§°ä¸º æŒ‡ä»¤ , ä¸»è¦ç”± ç±»å‹å‰ç¼€ å’Œ æ“ä½œåç§° ä¸¤éƒ¨åˆ†ç»„æˆã€‚ </p><blockquote><p>ä¾‹å¦‚ï¼Œâ€™ i â€˜ å‰ç¼€ä»£è¡¨ â€˜ integer â€™ï¼Œæ‰€ä»¥ï¼Œâ€™ iadd â€˜ å¾ˆå®¹æ˜“ç†è§£, è¡¨ç¤ºå¯¹æ•´æ•°æ‰§è¡ŒåŠ æ³•è¿ç®—ã€‚</p></blockquote><p>æ ¹æ®æŒ‡ä»¤æ€§è´¨ï¼Œä¸»è¦åˆ†ä¸º 4 ä¸ªå¤§ç±»ï¼š</p><ol><li>æ ˆæ“ä½œæŒ‡ä»¤ï¼Œ åŒ…æ‹¬ä¸å±€éƒ¨å˜é‡äº¤äº’çš„æŒ‡ä»¤ã€‚</li><li>ç¨‹åºæµç¨‹æ§åˆ¶æŒ‡ä»¤ã€‚</li><li>å¯¹è±¡æ“ä½œæŒ‡ä»¤ï¼ŒåŒ…æ‹¬æ–¹æ³•è°ƒç”¨æŒ‡ä»¤ã€‚</li><li>ç®—æœ¯è¿ç®—ä»¥åŠç±»å‹è½¬æ¢æŒ‡ä»¤ã€‚</li></ol><h3 id="è·å–å­—èŠ‚ç "><a href="#è·å–å­—èŠ‚ç " class="headerlink" title="è·å–å­—èŠ‚ç "></a>è·å–å­—èŠ‚ç </h3><p>å¯ä»¥ä½¿ç”¨ javap å‘½ä»¤æ¥è·å– class æ–‡ä»¶ä¸­çš„å­—èŠ‚ç ï¼Œ javap æ˜¯ jdk ä¸­å†…ç½®çš„ç”¨äºåç¼–è¯‘å­—èŠ‚ç çš„å·¥å…·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloByteCode</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        HelloByteCode obj = <span class="hljs-keyword">new</span> HelloByteCode();<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure><p>ç°ä½¿ç”¨ javac å‘½ä»¤ç¼–è¯‘å‡º .classï¼Œåœ¨ä½¿ç”¨ <code>javap -c</code> å‘½ä»¤ç¼–è¯‘å¾—åˆ°å­—èŠ‚ç æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">daiwei@daiweideMacBook-Pro <span class="hljs-built_in">test</span> % javap -c HelloByteCode.class<br>Compiled from <span class="hljs-string">&quot;HelloByteCode.java&quot;</span><br>public class HelloByteCode &#123;<br>  public HelloByteCode();<br>    Code:<br>       0: aload_0<br>       1: invokespecial <span class="hljs-comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>       4: <span class="hljs-built_in">return</span><br><br>  public static void main(java.lang.String[]);<br>    Code:<br>       0: new           <span class="hljs-comment">#2                  // class HelloByteCode</span><br>       3: dup<br>       4: invokespecial <span class="hljs-comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br>       7: astore_1<br>       8: getstatic     <span class="hljs-comment">#4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>      11: ldc           <span class="hljs-comment">#5                  // String hello</span><br>      13: invokevirtual <span class="hljs-comment">#6                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>      16: <span class="hljs-built_in">return</span><br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢æ‹‰å‡º java çš„å­—èŠ‚ç æ¸…å•ä¹‹åï¼Œä¸‹é¢å¯¹å…¶è¿›è¡Œç®€å•çš„è§£è¯»</p><h3 id="è§£æå­—èŠ‚ç æ¸…å•"><a href="#è§£æå­—èŠ‚ç æ¸…å•" class="headerlink" title="è§£æå­—èŠ‚ç æ¸…å•"></a>è§£æå­—èŠ‚ç æ¸…å•</h3><p>åœ¨ä¸Šé¢çš„è¾“å‡ºä¿¡æ¯ä¸­ï¼Œç¬¬äºŒè¡Œä¹Ÿå°±æ˜¯æ‰“å°å‡ºæ¥çš„å­—èŠ‚ç çš„ç¬¬ä¸€è¡Œ<code>Compiled from &quot;HelloByteCode.java&quot;</code>è¡¨ç¤ºæˆ‘ä»¬æ˜¯ä» HelloByteCodeè¿™ä¸ªç±»åç¼–è¯‘è€Œæ¥çš„å­—èŠ‚ç æ–‡ä»¶ã€‚4ï½8 è¡Œæ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ€»æ‰€å‘¨çŸ¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¸ç¼–å†™æ„é€ å‡½æ•°ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„æ„é€ æ–¹æ³•ï¼Œè¿™ä¸ªå°±æ˜¯é»˜è®¤çš„æ„é€ æ–¹æ³•ã€‚è€Œè¿™ä¸ªæ„é€ æ–¹æ³•é‡Œä¹Ÿåªæœ‰ä¸€æ¡æŒ‡ä»¤å°±æ˜¯ <code>invokespecial</code> è¿™ä¸ªæ˜¯è°ƒç”¨çˆ¶ç±»Object å¯¹è±¡çš„æ„é€ æ–¹æ³•å³ <code>super()</code> æ–¹æ³•ã€‚</p><p>å¦‚æœæƒ³è¦çœ‹åˆ°æ›´å¤šçš„ä¿¡æ¯åˆ™éœ€è¦ä½¿ç”¨<code>javap -c -verbose</code> å‘½ä»¤è¾“å‡ºæ›´å¤šä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs bash">daiwei@daiweideMacBook-Pro <span class="hljs-built_in">test</span> % javap -c -verbose HelloByteCode.class<br>Classfile /Users/daiwei/study/java-course/JVM/<span class="hljs-built_in">test</span>/HelloByteCode.class<br>  Last modified 2021-1-7; size 442 bytes<br>  MD5 checksum 8e2a795fb147ef48ba63f55886005f32<br>  Compiled from <span class="hljs-string">&quot;HelloByteCode.java&quot;</span><br>public class HelloByteCode<br>  minor version: 0<br>  major version: 52<br>  flags: ACC_PUBLIC, ACC_SUPER<br>Constant pool:<br>   <span class="hljs-comment">#1 = Methodref          #7.#16         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>   <span class="hljs-comment">#2 = Class              #17            // HelloByteCode</span><br>   <span class="hljs-comment">#3 = Methodref          #2.#16         // HelloByteCode.&quot;&lt;init&gt;&quot;:()V</span><br>   <span class="hljs-comment">#4 = Fieldref           #18.#19        // java/lang/System.out:Ljava/io/PrintStream;</span><br>   <span class="hljs-comment">#5 = String             #20            // hello</span><br>   <span class="hljs-comment">#6 = Methodref          #21.#22        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>   <span class="hljs-comment">#7 = Class              #23            // java/lang/Object</span><br>   <span class="hljs-comment">#8 = Utf8               &lt;init&gt;</span><br>   <span class="hljs-comment">#9 = Utf8               ()V</span><br>  <span class="hljs-comment">#10 = Utf8               Code</span><br>  <span class="hljs-comment">#11 = Utf8               LineNumberTable</span><br>  <span class="hljs-comment">#12 = Utf8               main</span><br>  <span class="hljs-comment">#13 = Utf8               ([Ljava/lang/String;)V</span><br>  <span class="hljs-comment">#14 = Utf8               SourceFile</span><br>  <span class="hljs-comment">#15 = Utf8               HelloByteCode.java</span><br>  <span class="hljs-comment">#16 = NameAndType        #8:#9          // &quot;&lt;init&gt;&quot;:()V</span><br>  <span class="hljs-comment">#17 = Utf8               HelloByteCode</span><br>  <span class="hljs-comment">#18 = Class              #24            // java/lang/System</span><br>  <span class="hljs-comment">#19 = NameAndType        #25:#26        // out:Ljava/io/PrintStream;</span><br>  <span class="hljs-comment">#20 = Utf8               hello</span><br>  <span class="hljs-comment">#21 = Class              #27            // java/io/PrintStream</span><br>  <span class="hljs-comment">#22 = NameAndType        #28:#29        // println:(Ljava/lang/String;)V</span><br>  <span class="hljs-comment">#23 = Utf8               java/lang/Object</span><br>  <span class="hljs-comment">#24 = Utf8               java/lang/System</span><br>  <span class="hljs-comment">#25 = Utf8               out</span><br>  <span class="hljs-comment">#26 = Utf8               Ljava/io/PrintStream;</span><br>  <span class="hljs-comment">#27 = Utf8               java/io/PrintStream</span><br>  <span class="hljs-comment">#28 = Utf8               println</span><br>  <span class="hljs-comment">#29 = Utf8               (Ljava/lang/String;)V</span><br>&#123;<br>  public HelloByteCode();<br>    descriptor: ()V<br>    flags: ACC_PUBLIC<br>    Code:<br>      stack=1, locals=1, args_size=1<br>         0: aload_0<br>         1: invokespecial <span class="hljs-comment">#1                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br>         4: <span class="hljs-built_in">return</span><br>      LineNumberTable:<br>        line 1: 0<br><br>  public static void main(java.lang.String[]);<br>    descriptor: ([Ljava/lang/String;)V<br>    flags: ACC_PUBLIC, ACC_STATIC<br>    Code:<br>      stack=2, locals=2, args_size=1<br>         0: new           <span class="hljs-comment">#2                  // class HelloByteCode</span><br>         3: dup<br>         4: invokespecial <span class="hljs-comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br>         7: astore_1<br>         8: getstatic     <span class="hljs-comment">#4                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br>        11: ldc           <span class="hljs-comment">#5                  // String hello</span><br>        13: invokevirtual <span class="hljs-comment">#6                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br>        16: <span class="hljs-built_in">return</span><br>      LineNumberTable:<br>        line 3: 0<br>        line 4: 8<br>        line 5: 16<br>&#125;<br>SourceFile: <span class="hljs-string">&quot;HelloByteCode.java&quot;</span><br></code></pre></td></tr></table></figure><p>è¿™æ¬¡çš„è¾“å‡ºæ¯”ä¹‹å‰ä¸€æ¬¡å¤šäº†ä¸å°‘çš„ä¿¡æ¯ï¼Œé¦–å…ˆæ˜¯ 10ï½39 è¡Œçš„å¸¸é‡æ± ä¿¡æ¯ã€‚è¿™é‡Œè®°å½•äº†ä»£ç ä¸­ç”¨åˆ°çš„å¸¸é‡ã€‚40ï½68è¡Œæ˜¯ä¹‹å‰ä»£ç éƒ¨åˆ†çš„å­—èŠ‚ç ï¼Œè¿™ä¸€æ¬¡å¤šäº†ä¸€äº›å¦‚ <code>descriptor, flags</code> çš„ä¿¡æ¯ã€‚descriptor æ˜¯æ–¹æ³•çš„æè¿°ç¬¦ï¼Œflags åˆ™æ˜¯æ–¹æ³•çš„è®¿é—®æè¿°ç¬¦ï¼Œè¿™æ˜¯ä¸ª public static æ–¹æ³•ã€‚ç¬¬45è¡Œçš„ <code>stack=1, locals=1, args_size=1</code> è¡¨ç¤ºæ–¹æ³•æ ˆçš„æ·±åº¦ä¸º1ï¼Œ æœ¬åœ°å±€éƒ¨å˜é‡è¡¨å¤§å°ä¸º1 ï¼Œæ–¹æ³•çš„å…¥å‚ä¸º1ã€‚è¿™é‡Œæœ‰ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„åœ°æ–¹ï¼Œå°±æ˜¯æ— å‚æ„é€ çš„ args_size ä¸ä¸º0 è€Œæ˜¯ 1 ï¼Œè¿™æ˜¯å› ä¸ºå¯¹äºæ„é€ æ–¹æ³•éœ€è¦æœ‰ä¸€ä¸ªå¼•ç”¨åœ°å€ï¼Œä¹Ÿå°±æ˜¯ this çš„å¼•ç”¨åœ°å€ï¼Œè¿™ä¸ªå¯ä»¥ç±»æ¯”åå°„é‡Œé¢<code>Method#invoke(Object obj, Object... args);</code> ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯è¢«è°ƒç”¨å¯¹è±¡ä¸€æ ·ã€‚</p><h3 id="çº¿ç¨‹æ ˆå’Œå­—èŠ‚ç æ‰§è¡Œæ¨¡å‹"><a href="#çº¿ç¨‹æ ˆå’Œå­—èŠ‚ç æ‰§è¡Œæ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ ˆå’Œå­—èŠ‚ç æ‰§è¡Œæ¨¡å‹"></a>çº¿ç¨‹æ ˆå’Œå­—èŠ‚ç æ‰§è¡Œæ¨¡å‹</h3><p>JVM æ˜¯åŸºäºæ ˆçš„è®¡ç®—æœºæ¨¡å‹ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„çº¿ç¨‹æ ˆï¼ˆJVM stackï¼‰å’Œç”¨äºå­˜å‚¨çš„<code>æ ˆå¸§</code>ï¼ˆFrameï¼‰ï¼Œæ¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•JVMéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼Œæ ˆå¸§ä¸­åŒ…æ‹¬<code>æ“ä½œæ•°æ ˆ</code>ï¼Œ<code>å±€éƒ¨å˜é‡æ•°ç»„</code>å’Œä¸€ä¸ª <code>class å¼•ç”¨</code>æ„æˆï¼Œclass å¼•ç”¨æŒ‡å‘å½“å‰æ–¹æ³•åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­å¯¹åº”çš„classã€‚</p><p>â€‹       <img src="https://gitee.com/realDaiwei/img/raw/master/20210507003351.png"></p><p><code>å±€éƒ¨å˜é‡æ•°ç»„</code> ä¹Ÿæˆä¸º <code>å±€éƒ¨æ–¹æ³•è¡¨</code>ï¼ˆLocalVariableTableï¼‰ï¼Œå…¶ä¸­åŒ…æ‹¬æ–¹æ³•çš„å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚å±€éƒ¨å˜é‡æ•°ç»„é•¿åº¦åœ¨ç¼–è¯‘æ—¶å°±å·²ç»ç¡®å®šã€‚å’Œå±€éƒ¨å˜é‡å’Œæ–¹æ³•å½¢å‚æœ‰å…³ï¼Œä½†æ˜¯å…·ä½“é•¿åº¦è¿˜è¦çœ‹å…·ä½“æ¯ä¸ªå­—æ®µå ç”¨çš„é•¿åº¦ã€‚<code>æ“ä½œæ•°æ ˆ</code>ï¼ˆOperand Stackï¼‰æ˜¯ä¸€ä¸ª LIFO çš„ç»“æ„æ ˆï¼Œé€šè¿‡äºå‹å…¥å¼¹å‡ºè¿›è¡Œæ•°æ®æ“ä½œï¼Œå…¶å¤§å°åœ¨ç¼–è¯‘æ—¶ç¡®å®šã€‚</p><p>ä¸€äº›æ“ä½œç /æŒ‡ä»¤å¯ä»¥å°†å€¼å‹å…¥æ“ä½œæ•°æ ˆï¼Œè¿˜æœ‰ä¸€äº›æ“ä½œç /æŒ‡ä»¤ä»æ“ä½œæ•°æ ˆè·å–æ“ä½œæ•°ï¼Œå¹¶è¿›è¡Œè®¡ç®—ï¼Œç„¶åå†å‹å…¥æ“ä½œæ•°æ ˆã€‚æ“ä½œæ•°æ ˆè¿˜ç”¨äºæ¥å—è°ƒç”¨å…¶ä»–æ–¹æ³•çš„è¿”å›å€¼ã€‚</p><h3 id="æ–¹æ³•ä½“ä¸­çš„å­—èŠ‚ç è§£æ"><a href="#æ–¹æ³•ä½“ä¸­çš„å­—èŠ‚ç è§£æ" class="headerlink" title="æ–¹æ³•ä½“ä¸­çš„å­—èŠ‚ç è§£æ"></a>æ–¹æ³•ä½“ä¸­çš„å­—èŠ‚ç è§£æ</h3><p>åœ¨å‰é¢çš„å‡ ä¸ªä¾‹å­å½“ä¸­ï¼Œå­—èŠ‚ç çœ‹èµ·æ¥é—®é¢˜éƒ½ä¸å¤§ï¼Œä½†æ˜¯çœ‹æ–¹æ³•ä½“ä¸­çš„å­—èŠ‚ç çš„ç¼–å·æœ‰ç‚¹çœ‹ä¸æ‡‚ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢çš„ä¸€äº›å­—èŠ‚ç </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">0:</span> <span class="hljs-string">new</span>           <span class="hljs-comment">#2                  // class HelloByteCode</span><br><span class="hljs-attr">3:</span> <span class="hljs-string">dup</span><br><span class="hljs-attr">4:</span> <span class="hljs-string">invokespecial</span> <span class="hljs-comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br><span class="hljs-attr">7:</span> <span class="hljs-string">astore_1</span><br><span class="hljs-attr">8:</span> <span class="hljs-string">return</span><br></code></pre></td></tr></table></figure><p>å‰é¢çš„ä¸€æ’æ•°å­—æ˜¯<code>æŒ‡ä»¤é›†æ•°ç»„ä¸­çš„ç´¢å¼•</code> new æ“ä½œå ç”¨ä¸€ä¸ªæ§½ä½ï¼Œå¹¶ä¸” new æŒ‡ä»¤éœ€è¦æ¶ˆè€—ä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰€ä»¥ dup æŒ‡ä»¤æ˜¯ä»<code>3</code>å¼€å§‹çš„ï¼Œ<code>dup</code> æŒ‡ä»¤ä¸éœ€è¦æ“ä½œæ•°ï¼Œæ‰€ä»¥åªå ä¸€ä¸ªæ§½ä½ã€‚ä½äº<code>4</code>å·æ§½ä½ä¸­çš„ <code>invokespecial</code> æŒ‡ä»¤åŒæ ·éœ€è¦æ¶ˆè€—ä¸¤ä¸ªæ“ä½œæ•°ï¼Œæ‰€ä»¥ astore_1 ä»7å·æ§½ä½å¼€å§‹ã€‚<code>astore_1</code>æ„æ€æ˜¯å°†æ ˆé¡¶å…ƒç´ å­˜å…¥å±€éƒ¨å˜é‡è¡¨1å·æ§½ä½ï¼Œä¸éœ€è¦æ“ä½œæ•°ï¼Œæ‰€ä»¥ <code>return</code> ä½äº<code>8</code>å·æ§½ä½ã€‚<img src="https://gitee.com/realDaiwei/img/raw/master/20210507003454.png"></p><p>é€šè¿‡æ“ä½œç /æŒ‡ä»¤å¯¹ç…§è¡¨å¹¶æ¢ç®—åå…­è¿›åˆ¶ï¼ˆHEXï¼‰è¡¨ç¤ºå½¢å¼ä¹‹åã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003612.png"></p><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬é€šè¿‡åå…­è¿›åˆ¶æ‰“å¼€.class æ–‡ä»¶æ‰€èƒ½çœ‹åˆ°çš„æ•°æ®ç‰‡æ®µäº†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003708.png"></p><h3 id="å¯¹è±¡åˆå§‹åŒ–æŒ‡ä»¤"><a href="#å¯¹è±¡åˆå§‹åŒ–æŒ‡ä»¤" class="headerlink" title="å¯¹è±¡åˆå§‹åŒ–æŒ‡ä»¤"></a>å¯¹è±¡åˆå§‹åŒ–æŒ‡ä»¤</h3><p>new æ˜¯Java çš„å…³é”®å­—ï¼Œä½†æ˜¯åœ¨å­—èŠ‚ç ä¸­ï¼Œä¹Ÿæœ‰ä¸€ä¸ªæŒ‡ä»¤ new ä½†æ˜¯æ•´ä¸ª new çš„é€»è¾‘ï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹çš„å­—èŠ‚ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">0: new           <span class="hljs-comment">#2                  // class HelloByteCode</span><br>3: dup<br>4: invokespecial <span class="hljs-comment">#3                  // Method &quot;&lt;init&gt;&quot;:()V</span><br></code></pre></td></tr></table></figure><p>new æŒ‡ä»¤å’Œ invokespecial æŒ‡ä»¤åœ¨ä¸€èµ·ï¼Œé‚£ä¹ˆè¿™æ®µå­—èŠ‚ç ä¸€å®šæ˜¯åœ¨å®ä¾‹ä¸€ä¸ªå¯¹è±¡ã€‚é‚£ä¸ºä»€ä¹ˆå®ä¾‹ä¸€ä¸ªå¯¹è±¡ä¸æ˜¯ä¸€ä¸ªæŒ‡ä»¤è€Œæ˜¯ä¸‰ä¸ªæŒ‡ä»¤å‘¢ï¼Ÿ</p><ul><li><code>new</code> æŒ‡ä»¤åªæ˜¯åˆ›å»ºå¯¹è±¡ï¼Œè€Œå¹¶æ²¡æœ‰è°ƒç”¨æ„é€ å‡½æ•°ã€‚</li><li><code>dup</code> å¤åˆ¶æ ˆé¡¶å…ƒç´ ã€‚è¿™é‡Œä¸ºä»€ä¹ˆè¦å¤åˆ¶æ ˆé¡¶å…ƒç´ å‘¢ï¼Ÿå› ä¸ºæ„é€ å‡½æ•°ä¸ä¼šè¿”å›å®ä¾‹å¯¹è±¡å¼•ç”¨ï¼Œæ‰€ä»¥æ²¡ç”¨dupæŒ‡ä»¤ï¼Œæ“ä½œæ•°æ ˆæ˜¯ç©ºçš„ï¼Œåˆå§‹åŒ–ä¹‹åå°±ä¼šæœ‰é—®é¢˜ã€‚</li><li><code>invokespecial</code> å­—é¢æ„æ€ï¼Œè°ƒç”¨ç‰¹æ®Šçš„æ–¹æ³•ï¼Œåœ¨è¿™é‡Œå°±æ˜¯è°ƒç”¨æ„é€ å‡½æ•°ã€‚</li></ul><p>å®Œæˆäº†ä¸Šé¢çš„ä»£ç åä¸€èˆ¬ä¼šæ‰§è¡Œçš„æŒ‡ä»¤ä¼šæœ‰ä¸‹é¢å‡ ç§ï¼š</p><ul><li><code>astore &#123;N&#125;</code> æˆ–è€… <code>astore_&#123;N&#125;</code> ç»™å±€éƒ¨å˜é‡èµ‹å€¼ï¼Œå…¶ä¸­{N}ä»£è¡¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„ä½ç½®ã€‚</li><li><code>putfield</code>  å°†å€¼èµ‹ç»™å®ä¾‹ã€‚</li><li><code>putstatic</code> å°†å®ä¾‹èµ‹ç»™é™æ€å­—æ®µã€‚</li></ul><p>è¿™ä¸ªæ—¶å€™å¦‚æœæ²¡æœ‰é‚£ä¸ª dup çš„å¼•ç”¨çš„è¯è¿™é‡Œå°±æ²¡æœ‰å°±æ²¡æ³•è¿›è¡Œå‡ºæ ˆèµ‹å€¼æ“ä½œã€‚</p><p>åœ¨è°ƒç”¨æ„é€ å‡½æ•°ä¹‹å‰ï¼Œè¿˜ä¼šæ‰§è¡Œä¸€ä¸ªç±»ä¼¼ <init> çš„æ–¹æ³•ã€‚ä½†æ˜¯ <clinit> å¹¶ä¸èƒ½è¢«ç›´æ¥è°ƒç”¨ï¼Œè€Œæ˜¯ç”± <code>new</code>ï¼Œ<code>getstatic</code>ï¼Œ<code>putstatic</code> æˆ– <code>invokestatic</code> è§¦å‘ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œè®¿é—®é™æ€å­—æ®µæˆ–ä¸€äº›é™æ€æ–¹æ³•ï¼Œå°±ä¼šè§¦å‘è¿™ä¸ªç±»çš„é™æ€åˆå§‹åŒ–æ–¹æ³•ã€‚</p><h3 id="æ ˆå†…å­˜æ“ä½œæŒ‡ä»¤"><a href="#æ ˆå†…å­˜æ“ä½œæŒ‡ä»¤" class="headerlink" title="æ ˆå†…å­˜æ“ä½œæŒ‡ä»¤"></a>æ ˆå†…å­˜æ“ä½œæŒ‡ä»¤</h3><p>æœ‰å¾ˆå¤šæŒ‡ä»¤å¯ä»¥æ“ä½œæ–¹æ³•æ ˆã€‚å‹å…¥æ ˆæ•°æ®å’Œä»æ•°æ®æ ˆå¼¹å‡ºæ•°æ®ç­‰ä¸€äº›åŸºç¡€çš„æ“ä½œï¼Œæœ‰ <code>dup</code> å¤åˆ¶æ ˆé¡¶å…ƒç´ ï¼Œå’Œ <code>pop</code> å¼¹å‡ºæ ˆé¡¶å…ƒç´ çš„æŒ‡ä»¤ã€‚è¿˜æœ‰ä¸€äº›å¤æ‚ç‚¹çš„æŒ‡ä»¤ä¾‹å¦‚ï¼š</p><ul><li><code>swap</code> ï¼šäº¤æ¢ä¸¤ä¸ªæ ˆé¡¶å…ƒç´ ã€‚</li><li><code>dup_x1</code>ï¼šå¤åˆ¶æ ˆé¡¶çš„å€¼, å¹¶å°†å¤åˆ¶çš„å€¼æ’å…¥åˆ°æœ€ä¸Šé¢2ä¸ªå€¼çš„ä¸‹æ–¹ã€‚</li><li><code>dup2_x1</code>ï¼šåˆ¶æ ˆé¡¶ 1ä¸ª64ä½/æˆ–2ä¸ª32ä½çš„å€¼, å¹¶å°†å¤åˆ¶çš„å€¼æŒ‰ç…§åŸå§‹é¡ºåºï¼Œæ’å…¥åŸå§‹å€¼ä¸‹é¢ä¸€ä¸ª32ä½å€¼çš„ä¸‹æ–¹ã€‚ é…åˆä½¿ç”¨å¯ç”¨äºäº¤æ¢ä¸¤ä¸ª64ä½æ•°æ®çš„ä½ç½®ã€‚</li></ul><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003819.png"></p><blockquote><p>æ•°æ®ç±»å‹åˆ†ç»„ï¼ˆ1ä»£è¡¨32 ä½å…ƒç´ ï¼Œ 2ä»£è¡¨64ä½å…ƒç´ ï¼‰</p></blockquote><table><thead><tr><th>å®é™…ç±»å‹</th><th>JVM è®¡ç®—ç±»å‹</th><th>ç±»å‹åˆ†ç»„</th></tr></thead><tbody><tr><td>boolean</td><td>int</td><td>1</td></tr><tr><td>byte</td><td>int</td><td>1</td></tr><tr><td>char</td><td>int</td><td>1</td></tr><tr><td>short</td><td>int</td><td>1</td></tr><tr><td>int</td><td>int</td><td>1</td></tr><tr><td>float</td><td>float</td><td>1</td></tr><tr><td>refrence</td><td>refrence</td><td>1</td></tr><tr><td>retrunAddress</td><td>retrunAddress</td><td>1</td></tr><tr><td>long</td><td>long</td><td>2</td></tr><tr><td>double</td><td>double</td><td>2</td></tr></tbody></table><blockquote><p>âš ï¸ ç†è§£è¿™äº›å­—èŠ‚ç çš„è¯€çªåœ¨äº</p><p>ç»™å±€éƒ¨å˜é‡èµ‹å€¼æ—¶ï¼Œéœ€è¦ä½¿ç”¨ç›¸åº”çš„æŒ‡ä»¤æ¥è¿›è¡Œ <code>store</code> ï¼Œå¦‚ <code>astore_1</code>ã€ <code>store</code> ç±»çš„æŒ‡ä»¤éƒ½ä¼šåˆ é™¤æ ˆé¡¶å€¼ã€‚ ç›¸åº”çš„ load æŒ‡ä»¤åˆ™ä¼šå°†å€¼ä»å±€éƒ¨å˜é‡è¡¨å‹å…¥æ“ä½œæ•°æ ˆï¼Œä½†å¹¶ä¸ä¼šåˆ é™¤å±€éƒ¨å˜é‡ä¸­çš„å€¼ã€‚</p></blockquote><h3 id="ç®—æœ¯è¿ç®—æŒ‡ä»¤ä¸ç±»å‹è½¬æ¢æŒ‡ä»¤"><a href="#ç®—æœ¯è¿ç®—æŒ‡ä»¤ä¸ç±»å‹è½¬æ¢æŒ‡ä»¤" class="headerlink" title="ç®—æœ¯è¿ç®—æŒ‡ä»¤ä¸ç±»å‹è½¬æ¢æŒ‡ä»¤"></a>ç®—æœ¯è¿ç®—æŒ‡ä»¤ä¸ç±»å‹è½¬æ¢æŒ‡ä»¤</h3><p>Java å­—èŠ‚ç æœ‰å¾ˆå¤šçš„æŒ‡ä»¤å¯ä»¥æ‰§è¡Œç®—æœ¯è¿ç®—ã€‚å¯¹äºæ‰€æœ‰æ•°å€¼ç±»å‹ï¼ˆ<code>int</code>, <code>long</code>, <code>double</code>, <code>float</code>ï¼‰éƒ½æœ‰å„è‡ªçš„åŠ ã€å‡ã€ä¹˜ã€é™¤ã€å–åæŒ‡ä»¤ã€‚å½“ç„¶booleanã€byteã€shortã€char ç­‰éƒ½æ˜¯å½“ int ç±»å‹å¤„ç†ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003904.png"></p><p>åœ¨java æ˜¯ä¸€ä¸ªå¼ºç±»å‹çš„è¯­è¨€ï¼Œå¦‚æœç±»å‹ä¸åŒ¹é…éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå¦‚æœ<code>int</code>éœ€è¦è½¬æ¢ä¸º <code>double</code> ä¼šè°ƒç”¨ i2d æŒ‡ä»¤è¿›è¡Œç±»å‹è½¬æ¢ã€‚</p><p><img src="https://gitee.com/realDaiwei/img/raw/master/20210507003936.png"></p><p>å”¯ä¸€ä¸€ä¸ªä¸éœ€è¦å°†æ•°å€¼loadåˆ°æ“ä½œæ•°æ ˆçš„æŒ‡ä»¤æ˜¯ <code>iinc</code>ï¼Œä»–å¯ä»¥ç›´æ¥å¯¹ <code>LocalVariableTable</code> ä¸­çš„æ•°å€¼è¿›è¡Œè¿ç®—ã€‚å…¶ä»–çš„æ“ä½œå‡ä½¿ç”¨æ“ä½œæ•°æ ˆè¿›è¡Œè¿ç®—ã€‚</p><blockquote><p><a href="https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-7.html">æ“ä½œç å¯¹ç…§è¡¨</a></p></blockquote><h3 id="æ–¹æ³•è°ƒç”¨æŒ‡ä»¤"><a href="#æ–¹æ³•è°ƒç”¨æŒ‡ä»¤" class="headerlink" title="æ–¹æ³•è°ƒç”¨æŒ‡ä»¤"></a>æ–¹æ³•è°ƒç”¨æŒ‡ä»¤</h3><p>åœ¨å‰é¢å·²ç»åˆ°äº† <code>invokespceial</code> è°ƒç”¨æ„é€ æ–¹æ³•ï¼Œé‚£è°ƒç”¨å…¶ä»–ä¸åŒç±»å‹çš„æ–¹æ³•ç”¨ä»€ä¹ˆæŒ‡ä»¤å‘¢ï¼Ÿ</p><ul><li><code>invokestatic</code> è°ƒç”¨é™æ€æ–¹æ³•ï¼Œä¹Ÿæ˜¯å‡ ä¸ªè°ƒç”¨æŒ‡ä»¤å½“ä¸­æœ€å¿«çš„ã€‚</li><li><code>invokespeical</code> å¯ä»¥ç”¨æ¥è°ƒç”¨æ„é€ æ–¹æ³•ï¼ŒåŒæ—¶è¿™ä¸ªæŒ‡ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥è°ƒç”¨ <code>private</code> æ–¹æ³• å’Œå¯è§çš„ <code>super</code> ä¸­çš„æ–¹æ³•ã€‚</li><li><code>invokevirtual</code> å¯ä»¥è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„å®ä¾‹æ–¹æ³•ã€‚</li><li><code>invokeinterface</code> ç”¨äºè°ƒç”¨ç›®æ ‡æ¥å£æ–¹æ³•ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æœç´¢ä¸€ä¸ªå®ç°è¿™ä¸ªæ¥å£çš„å¯¹è±¡ï¼Œå¹¶æ‰¾å‡ºåˆé€‚çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ã€‚</li><li><code>invokedynamic</code> jdk 1.7 æ–°åŠ å…¥çš„ä¸€ä¸ªè™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå‰å››æ¡æŒ‡ä»¤çš„åˆ†æ´¾é€»è¾‘åœ¨è™šæ‹Ÿæœºå†…éƒ¨æ˜¯å›ºå®šçš„ï¼Œ<code>invokedynamic</code> å®ƒå…è®¸åº”ç”¨ä»£ç æ¥ç¡®å®šå…·ä½“æ‰§è¡Œçš„æ˜¯é‚£ä¸ªæ–¹æ³•ï¼Œä»è€Œåˆ°è¾¾å¯¹åŠ¨æ€è¯­è¨€çš„æ”¯æŒã€‚Lambda è¡¨è¾¾å¼åŸºäº <code>invokedynamic</code> å®ç°ã€‚</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸ªéƒ¨åˆ†ç®€å•ä»‹ç»äº†Java å­—èŠ‚ç ï¼Œä»å¼€ç¯‡ä»‹ç»æ€ä¹ˆæ‹‰å–ä¸€ä¸ª Java ä»£ç çš„å­—èŠ‚ç å¼€å§‹ï¼Œé€æ­¥å¤ä¹ äº†jvm æ–¹æ³•æ ˆçš„æ ˆå¸§ï¼Œä¹Ÿå°±æ˜¯ å­—èŠ‚ç çš„æ‰§è¡Œç¯å¢ƒï¼Œè¿™ä¸ªéƒ¨åˆ†ç”±ä¸€ä¸ªæ“ä½œæ•°æ ˆï¼Œä¸€ä¸ªæœ¬åœ°å±€éƒ¨å˜é‡è¡¨å’Œä¸€ä¸ªclass å¼•ç”¨æ„æˆã€‚é€šè¿‡åˆ†æä¸€äº›å¸¸è§çš„å­—èŠ‚ç ä¾‹å¦‚æ„é€ å‡½æ•°å’Œä¸€äº›ç®€å•çš„æ–¹æ³•ä½“ï¼Œç†Ÿæ‚‰äº†è§£äº†ä¸€äº›åŸºæœ¬çš„æ“ä½œç ï¼Œä¾‹å¦‚ dupã€popã€istoreã€iload ç­‰æŒ‡ä»¤ã€‚å…¶ä¸­ç†è§£çš„è¯€çªåœ¨äº ç»™å±€éƒ¨å˜é‡èµ‹å€¼æ—¶ï¼Œéœ€è¦ä½¿ç”¨ç›¸åº”çš„æŒ‡ä»¤æ¥è¿›è¡Œ <code>store</code> ï¼Œå¦‚ <code>astore_1</code>ã€ <code>store</code> ç±»çš„æŒ‡ä»¤éƒ½ä¼šåˆ é™¤æ ˆé¡¶å€¼ã€‚ ç›¸åº”çš„ load æŒ‡ä»¤åˆ™ä¼šå°†å€¼ä»å±€éƒ¨å˜é‡è¡¨å‹å…¥æ“ä½œæ•°æ ˆï¼Œä½†å¹¶ä¸ä¼šåˆ é™¤å±€éƒ¨å˜é‡ä¸­çš„å€¼ã€‚å½“ç„¶åœ¨è¿™äº›åŸºæœ¬çš„æ“ä½œæŒ‡ä»¤ä¸­è¿˜åŒ…æ‹¬ä¸€äº›ç±»å‹è½¬æ¢çš„æŒ‡ä»¤å’Œæ–¹æ³•çš„è°ƒç”¨çš„æŒ‡ä»¤ï¼Œæ–¹æ³•è°ƒç”¨åˆ°åé¢ä¼šæœ‰ä¸“é—¨æ¢³ç†ã€‚</p><h2 id="å­¦ä¹ èµ„æ–™"><a href="#å­¦ä¹ èµ„æ–™" class="headerlink" title="å­¦ä¹ èµ„æ–™"></a>å­¦ä¹ èµ„æ–™</h2><ul><li>Java å­—èŠ‚ç æŠ€æœ¯ï¼šä¸ç§¯ç»†æµï¼Œæ— ä»¥æˆæ±Ÿæ²³ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>Javaè™šæ‹Ÿæœº</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JVM</tag>
      
      <tag>JavaçŸ¥è¯†ç»“æ„æ¢³ç†</tag>
      
      <tag>å­¦ä¹ æ€»ç»“</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>leetcodes ä¹ é¢˜æ±‡æ€»</title>
    <link href="/2021/03/28/leetcodes/"/>
    <url>/2021/03/28/leetcodes/</url>
    
    <content type="html"><![CDATA[<h2 id="LeetCode-ä¹ é¢˜æ±‡æ€»"><a href="#LeetCode-ä¹ é¢˜æ±‡æ€»" class="headerlink" title="LeetCode ä¹ é¢˜æ±‡æ€»"></a>LeetCode ä¹ é¢˜æ±‡æ€»</h2><h5 id="æ•°ç»„ã€é“¾è¡¨"><a href="#æ•°ç»„ã€é“¾è¡¨" class="headerlink" title="æ•°ç»„ã€é“¾è¡¨"></a>æ•°ç»„ã€é“¾è¡¨</h5><ol><li><a href="https://leetcode-cn.com/problems/container-with-most-water/">ç››æ°´æœ€å¤šçš„å®¹å™¨</a></li><li><a href="https://leetcode-cn.com/problems/move-zeroes/">ç§»åŠ¨é›¶</a></li><li><a href="https://leetcode-cn.com/problems/climbing-stairs/">çˆ¬æ¥¼æ¢¯</a></li><li><a href="https://leetcode-cn.com/problems/two-sum/">ä¸¤æ•°ä¹‹å’Œ</a></li><li><a href="https://leetcode-cn.com/problems/3sum/">ä¸‰æ•°ä¹‹å’Œ</a></li><li><a href="https://leetcode-cn.com/problems/remove-duplicates-from-sorted-array/">åˆ é™¤æ’åºæ•°ç»„ä¸­çš„é‡å¤é¡¹</a></li><li><a href="https://leetcode-cn.com/problems/rotate-array/">æ—‹è½¬æ•°ç»„</a></li><li><a href="https://leetcode-cn.com/problems/reverse-linked-list/">åè½¬é“¾è¡¨</a></li><li><a href="https://leetcode-cn.com/problems/swap-nodes-in-pairs/">ä¸¤ä¸¤äº¤æ¢é“¾è¡¨ä¸­çš„èŠ‚ç‚¹</a></li><li><a href="https://leetcode-cn.com/problems/linked-list-cycle/">ç¯å½¢é“¾è¡¨</a></li><li><a href="https://leetcode-cn.com/problems/linked-list-cycle-ii/">ç¯å½¢é“¾è¡¨2</a></li><li><a href="https://leetcode-cn.com/problems/reverse-nodes-in-k-group/">K ä¸ªä¸€ç»„ç¿»è½¬é“¾è¡¨</a></li><li><a href="https://leetcode-cn.com/problems/merge-two-sorted-lists/">åˆå¹¶ä¸¤ä¸ªæœ‰åºé“¾è¡¨</a></li></ol><h5 id="æ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆé˜Ÿåˆ—ã€åŒç«¯é˜Ÿåˆ—"><a href="#æ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆé˜Ÿåˆ—ã€åŒç«¯é˜Ÿåˆ—" class="headerlink" title="æ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆé˜Ÿåˆ—ã€åŒç«¯é˜Ÿåˆ—"></a>æ ˆã€é˜Ÿåˆ—ã€ä¼˜å…ˆé˜Ÿåˆ—ã€åŒç«¯é˜Ÿåˆ—</h5><ol><li><a href="https://leetcode-cn.com/problems/valid-parentheses/">æœ‰æ•ˆçš„æ‹¬å·</a></li><li><a href="https://leetcode-cn.com/problems/min-stack/">æœ€å°æ ˆ</a></li><li><a href="https://leetcode-cn.com/problems/largest-rectangle-in-histogram/">æŸ±çŠ¶å›¾ä¸­çš„æœ€å¤§çŸ©å½¢</a></li><li><a href="https://leetcode-cn.com/problems/sliding-window-maximum/">æ»‘åŠ¨çª—å£æœ€å¤§å€¼</a></li><li><a href="https://leetcode-cn.com/problems/trapping-rain-water/">æ¥é›¨æ°´</a></li></ol>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
    </categories>
    
    
    <tags>
      
      <tag>leetcode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ¯å¤©ä¸€ä¸ªå¼€å‘å°æŠ€å·§</title>
    <link href="/2021/03/11/daily-tips/"/>
    <url>/2021/03/11/daily-tips/</url>
    
    <content type="html"><![CDATA[<h2 id="å°¬èŠ"><a href="#å°¬èŠ" class="headerlink" title="å°¬èŠ"></a>å°¬èŠ</h2><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œä¸å…ä¼šé‡åˆ°è‡ªå·±ä¸ç†Ÿæ‚‰çš„åœ°æ–¹ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™æˆ‘ä»¬æŸ¥å®Œç”¨å®Œç„¶åå°±æ˜¯æŠ€èƒ½å½’è¿˜ã€‚å¦‚æœèƒ½åœ¨è¿™é‡Œè®°å½•æ•´ç†æ”¶é›†ï¼Œé‚£ä¹Ÿæ˜¯ä¸€ç¬”å®è´µçš„çŸ¥è¯†åŠ›é‡ã€‚å¯èƒ½æœ‰çš„å°æŠ€å·§å¹¶æ²¡æœ‰å¤ªå¤šçš„å®ç”¨ä»·å€¼ï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„å¥‡æŠ€æ·«å·§ï¼Œä½†è¿™äº›ä»£ç é‡Œçš„ç²¾å½©çš„ç¢ç‰‡ã€‚æ—¥æ‹±ä¸€å’ï¼Œç§¯å°‘æˆå¤šï¼Œç›¸ä¿¡æ—¶é—´çš„åŠ›é‡ã€‚</p><h2 id="å°æŠ€å·§"><a href="#å°æŠ€å·§" class="headerlink" title="å°æŠ€å·§"></a>å°æŠ€å·§</h2><ul><li>Macæ ¡éªŒæ–‡ä»¶SHA</li></ul><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs zsh">shasum -a 256 <span class="hljs-variable">$&#123;file&#125;</span><br></code></pre></td></tr></table></figure><ul><li><a href="https://jaywcjlove.gitee.io/linux-command/c/tcpdump.html">Linux å‘½ä»¤è¡ŒæŠ“åŒ…</a></li></ul><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs zsh">tcpdump -D <span class="hljs-comment"># å½“å‰å¯ä»¥ç›‘å¬çš„ç½‘å¡</span><br></code></pre></td></tr></table></figure><ul><li>git tag é‡å‘½å</li></ul><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs zsh">daiwei@daiweideMacBook-Pro ~ % git tag [new_name] [old_name]  <span class="hljs-comment"># å¤åˆ¶åŸæœ‰çš„tag</span><br>daiwei@daiweideMacBook-Pro ~ % git tag -d [old_name] <span class="hljs-comment"># åˆ é™¤åŸæœ‰tag</span><br>daiwei@daiweideMacBook-Pro ~ % git push origin :refs/tag/v1.0 <span class="hljs-comment"># åˆ é™¤è¿œç¨‹ tag</span><br>daiwei@daiweideMacBook-Pro ~ % git push --tag <span class="hljs-comment">#æ¨é€æœ¬åœ°æ–°çš„tag</span><br></code></pre></td></tr></table></figure><ul><li>reflections åå°„å·¥å…·åŒ…ï¼Œå†…ç½®åå°„ç›¸å…³æ“ä½œï¼Œç®€åŒ–å¼€å‘</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.reflections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>reflections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li>ä¸ä½¿ç”¨ springboot-parent åˆ›å»º springboot é¡¹ç›®ï¼Œæ–¹ä¾¿æ¸…æ™°ç³»ç»Ÿæ•´ä½“ç»§æ‰¿ç»“æ„ã€‚åªéœ€è¦åœ¨ä¾èµ–çš„çˆ¶pom çš„ dependencyManagement ä¸­æ·»åŠ  spring-boot-dependencies ä¾èµ–å³å¯ã€‚</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;springboot.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><ul><li><p>ä¸‰ä¸ªæœ‰æ„æ€çš„åœ¨çº¿çš„ playgroud </p><ul><li><p>redis åœ¨çº¿çš„web shell <a href="https://try.redis.io/">try redis</a> ï¼Œå¯ä»¥æ‰§è¡Œä¸€äº› redis cmdsã€‚</p></li><li><p>docker çš„åœ¨çº¿ <a href="https://labs.play-with-docker.com/">docker lab</a>ï¼Œç™»å½•åæä¾›ä¸€ä¸ªæ—¶é•¿å››ä¸ªå°æ—¶çš„ sessionï¼Œè¿‡æœŸéœ€è¦é‡æ–°ç™»å½•ï¼Œç™»å½•éœ€è¦ docker hub çš„è´¦å·ï¼Œåœ¨ session ä¸­å¯ä»¥æ“ä½œå¤šä¸ªdockerå®ä¾‹ï¼Œæ­£å¦‚è¿™ä¸ª lab çš„åå­—ä¸€æ ·ï½paly with dockerã€‚</p></li><li><p>git åœ¨çº¿å­¦ä¹ ç½‘ç«™ <a href="https://learngitbranching.js.org/?locale=zh_CN">learn-git-branch</a>ï¼Œåœ¨è¿™ä¸ªç½‘ç«™é€šè¿‡å®Œæˆä¸€ä¸ªä¸ªä»»åŠ¡å­¦ä¹ å‘½ä»¤æ“ä½œå¯è§†åŒ–çš„gitèŠ‚ç‚¹åˆ°è¾¾å­¦ä¹  git çš„ç›®çš„ï¼Œå°±å¾ˆniceï½</p></li></ul></li><li><p>.gitignore æ–‡ä»¶ä¸ç”Ÿæ•ˆçš„é—®é¢˜ï¼Œæ¸…ç† git çš„æœ¬åœ°çš„ç¼“å­˜ï¼Œç„¶åé‡æ–° add commit å°±å¯ä»¥äº†</p></li></ul><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs zsh">daiwei@daiweideMacBook-Pro ~ % git rm -r --cached .<br>daiwei@daiweideMacBook-Pro ~ % git add .<br>daiwei@daiweideMacBook-Pro ~ % git commit -m<span class="hljs-string">&#x27;update msg&#x27;</span><br>daiwei@daiweideMacBook-Pro ~ % git push origin main<br></code></pre></td></tr></table></figure><ul><li><p>linux æŸ¥çœ‹ç«¯å£ï¼Œæ¯æ¬¡éƒ½è¦æŸ¥ï¼Œæ¯æ¬¡éƒ½è®°ä¸ä½ğŸ˜«</p><p>netstat å‘½ä»¤ ç”¨äºæŸ¥çœ‹ tcp å’Œ udp çš„ç«¯å£å ç”¨æƒ…å†µ</p><ul><li>-t (tcp) ä»…ä»…æ˜¾ç¤º tcp ç›¸å…³</li><li>-u(udp) ä»…ä»…æ˜¾ç¤º udp ç›¸å…³</li><li>-n æ‹’ç»æ˜¾ç¤ºåˆ«åï¼Œèƒ½æ˜¾ç¤ºæ•°å­—çš„å…¨éƒ¨è½¬åŒ–ä¸ºæ•°å­—</li><li>-l ä»…åˆ—å‡ºåœ¨Listen(ç›‘å¬)çš„æœåŠ¡çŠ¶æ€</li><li>-p æ˜¾ç¤ºå»ºç«‹ç›¸å…³é“¾æ¥çš„ç¨‹åºå</li></ul><p>æ‰€ä»¥æˆ‘å…¨éƒ½è¦ æ‰€ä»¥å‘½ä»¤å°±æ˜¯ -nptul (ç‰›æ‰¹åäº†)ğŸ˜</p><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs zsh">netstat -nptul | grep &lt;port&gt;<br></code></pre></td></tr></table></figure><p> <strong>æ³¨æ„è¿™ä¸ªå‘½ä»¤ mac ä¸Šå°±æ˜¯å¦å¤–ä¸€å¥—å‚æ•°äº†ï¼Œmac ä¸Šå¯ä»¥ä½¿ç”¨ lsof - i:port</strong></p></li><li><p>redis ä¸­ lua è„šæœ¬çš„ç¼–å†™çš„åŸºæœ¬æ–¹æ³•</p><p>ä» redis 2.6.0 å¼€å§‹å†…ç½®æ”¯æŒ lua è„šæœ¬ï¼Œå¯ä»¥é€šè¿‡ lua è„šæœ¬å®ç°æ‰§è¡Œå¤šæ¡å‘½ä»¤çš„åŸå­æ€§ï¼Œå…¸å‹çš„ä½¿ç”¨åœºæ™¯æœ‰ åˆ†å¸ƒå¼é” å’Œ åˆ†å¸ƒå¼æ‰£å‡ç­‰ã€‚åŸºæœ¬çš„æ“ä½œå‘½ä»¤å¦‚ä¸‹</p><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs zsh">127.0.0.1:6379&gt; EVAL script numkeys key [key...] arg [arg...]<br></code></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>script</td><td>è„šæœ¬å†…å®¹</td></tr><tr><td>numkeys</td><td>key çš„ä¸ªæ•°ï¼ˆåªæ˜¯ key çš„ä¸ªæ•°å’Œ argv æ²¡æœ‰å…³ç³»ï¼‰</td></tr><tr><td>key [keyâ€¦]</td><td>keyåˆ—è¡¨ï¼Œé”®åé€šè¿‡å…¨å±€å˜é‡ KEYS æ•°ç»„ï¼Œç”¨ 1 ä¸ºåŸºå€çš„å½¢å¼è®¿é—®( KEYS[1] ï¼Œ KEYS[2] ï¼Œä»¥æ­¤ç±»æ¨)</td></tr><tr><td>arg [argâ€¦]</td><td>å‚æ•°åˆ—è¡¨ï¼Œå‚æ•°é€šè¿‡å…¨å±€å˜é‡ ARGV æ•°ç»„ï¼Œç”¨ 1 ä¸ºåŸºå€çš„å½¢å¼è®¿é—®( ARGV[1] ï¼Œ ARGV[2] ï¼Œä»¥æ­¤ç±»æ¨)</td></tr></tbody></table><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs zsh">127.0.0.1:6379&gt; <span class="hljs-built_in">eval</span> <span class="hljs-string">&quot;return &#123;KEYS[1], KEYS[2], ARGV[1], ARGV[2], ARGV[3]&#125;&quot;</span> 2 key1 key2 avg1 avg2 avg3<br><span class="hljs-comment">## è¾“å‡º</span><br>1) <span class="hljs-string">&quot;key1&quot;</span><br>2) <span class="hljs-string">&quot;key2&quot;</span><br>3) <span class="hljs-string">&quot;avg1&quot;</span><br>4) <span class="hljs-string">&quot;avg2&quot;</span><br>5) <span class="hljs-string">&quot;avg3&quot;</span><br></code></pre></td></tr></table></figure><p>è¿˜å¯ä»¥é€šè¿‡ <strong>script load</strong> å‘½ä»¤ç¼“å­˜å‘½ä»¤ï¼Œå¹¶é€šè¿‡ <strong>evalsha</strong> å‘½ä»¤æ‰§è¡Œ</p><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs zsh">SCRIPT LOAD script <span class="hljs-comment"># ç¼“å­˜ lua è„šæœ¬</span><br>EVALSHA sha1 numkeys key [key ...] arg [arg ...]  <span class="hljs-comment"># æ‰§è¡Œ lua è„šæœ¬</span><br></code></pre></td></tr></table></figure><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs zsh">script load <span class="hljs-string">&quot;return &#123;KEYS[1], KEYS[2], ARGV[1], ARGV[2], ARGV[3]&#125;&quot;</span><br><span class="hljs-string">&quot;0e8e5b92bfe818cf5eb29a03465e71bd8ef3e95a&quot;</span><br></code></pre></td></tr></table></figure><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs zsh">127.0.0.1:6379&gt; evalsha 0e8e5b92bfe818cf5eb29a03465e71bd8ef3e95a 2 hello word arg1 arg2 arg3<br>1) <span class="hljs-string">&quot;hello&quot;</span><br>2) <span class="hljs-string">&quot;word&quot;</span><br>3) <span class="hljs-string">&quot;arg1&quot;</span><br>4) <span class="hljs-string">&quot;arg2&quot;</span><br>5) <span class="hljs-string">&quot;arg3&quot;</span><br></code></pre></td></tr></table></figure><p>å‡ ä¸ªå¸¸ç”¨çš„ redis lua è„šæœ¬</p><p>â€‹    åˆ†å¸ƒå¼é”</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-comment">--lock</span><br><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;setnx&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">1</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> redis.call(<span class="hljs-string">&#x27;expire&#x27;</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>]) <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;true&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;false&#x27;</span> <span class="hljs-keyword">end</span><br><span class="hljs-comment">-- unlock</span><br><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;get&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> redis.call(<span class="hljs-string">&#x27;del&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;true&#x27;</span><br></code></pre></td></tr></table></figure><p>â€‹    åˆ†å¸ƒå¼è®¡æ•°å™¨</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua"><span class="hljs-keyword">if</span> redis.call(<span class="hljs-string">&#x27;EXISTS&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) == <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> redis.call(<span class="hljs-string">&#x27;GET&#x27;</span>, KEYS[<span class="hljs-number">1</span>]) &gt; ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> redis.call(<span class="hljs-string">&#x27;decr&#x27;</span>, KEYS[<span class="hljs-number">1</span>])  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;true&#x27;</span> <span class="hljs-keyword">else</span>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;false&#x27;</span> <span class="hljs-keyword">end</span><br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    <categories>
      
      <category>éšç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å¼€å‘å°æŠ€å·§</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>100wæ•°æ®æ’å…¥å®ç°ä¸æ€è€ƒ</title>
    <link href="/2021/03/07/100w-data-insert/"/>
    <url>/2021/03/07/100w-data-insert/</url>
    
    <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>è¿™æ˜¯å­¦ä¹ ä¸­é‡åˆ°çš„ä¸€ä¸ªé¢˜ç›®ï¼Œå¾€ä¸€ä¸ªè¡¨ä¸­æ’å…¥100wæ¡æ•°æ®ï¼Œçœ‹åˆ°è¿™ä¸ªé¢˜ç›®çš„æ—¶å€™äººæ˜¯æ‡µé€¼çš„ã€‚å› ä¸ºç›®å‰å…¬å¸çº¿ä¸Šæœ€å¤§çš„è¡¨è®°å½•ä¸è¿‡100wå‡ºå¤´ï¼Œæ¯æ¬¡åšæ•°æ®æ¸…æ´—æˆ–è€…æ•°æ®è¿ç§»çš„æ—¶å€™ä¸€ä¸ªé€šå®µéƒ½ä¸ä¸€å®šèƒ½è·‘å®Œï¼Œé‚£ä¹ˆæ’å…¥100w åˆæ€ä¹ˆä¼šå¿«çš„èµ·æ¥å‘¢ï¼Ÿæ›´ä½•å†µè€å¸ˆé—®æ˜¯å¦èƒ½æŠŠæ€§èƒ½ä¼˜åŒ–åˆ° 10s ä¹‹å†…å‘¢ã€‚ã€‚</p><h3 id="æ€ç»´çˆ†ç‚¸"><a href="#æ€ç»´çˆ†ç‚¸" class="headerlink" title="æ€ç»´çˆ†ç‚¸"></a>æ€ç»´çˆ†ç‚¸</h3><p>åªè¦æ€æƒ³ä¸æ»‘å¡ï¼ŒåŠæ³•æ€»æ¯”æ–¹æ³•å¤šã€‚è€å¸ˆæ—¢ç„¶é—®äº†é‚£è¿™ä¸ªé—®é¢˜è‚¯å®šæ˜¯æœ‰è§£çš„ï¼Œå¦‚æœè„‘æš´åˆ†æä¸‹å¯ä»¥å¾—åˆ°ä¸‹é¢çš„ä¸€äº›ä¿¡æ¯çº¿ç´¢ã€‚</p><ul><li><p><strong>æ•°æ®åº“ä¼˜åŒ–ä¸»è¦åˆ†ä»¥ä¸‹ä¸‰éƒ¨åˆ†</strong></p><ul><li><strong>æ•°æ®åº“ç«¯å‚æ•°ä¼˜åŒ–</strong></li><li><strong>sql ä¼˜åŒ–</strong></li><li><strong>è¡¨ç»“æ„ä¼˜åŒ–</strong></li></ul></li><li><p>å½±å“æ•°æ®åº“ååé‡çš„å› ç´ </p><ul><li>å•ä¸ªäº‹åŠ¡å¤§å°</li><li>redologå†™å…¥æƒ…å†µå’Œè„é¡µæ•°é‡</li><li>æ•°æ®åº“è¿æ¥æ± ç©ºé—²æƒ…å†µå’Œä¸€äº›ç›¸å…³çš„buffer</li><li>ç´¢å¼•</li><li>æ•°æ®åº“å®ä¾‹æ€§èƒ½</li></ul></li><li><p>java ä»£ç çš„æ€§èƒ½å› ç´ </p><ul><li>å°è£…è¶Šå° é€Ÿåº¦è¶Šå¿«</li><li>å¤šçº¿ç¨‹</li><li>æ•°æ®åº“è¿æ¥æ± </li></ul></li><li><p>è¿è¡Œç¯å¢ƒå› ç´ </p><ul><li>cpu</li><li>io</li><li>system</li></ul></li></ul><p>ä»¥ä¸Šè¿™äº›æ˜¯æˆ‘èƒ½æƒ³åˆ°çš„ä¸€äº›å½±å“çš„æ–¹é¢ï¼Œå’Œå¯ä»¥é’ˆå¯¹ä¼˜åŒ–çš„ç‚¹ã€‚æœ¬æ¬¡æµ‹è¯•åŸºæœ¬ä¸Šéƒ½åœ¨æˆ‘è‡ªå·±çš„ mbp ä¸Šè·‘ï¼Œæ‰€ä»¥<strong>è¿è¡Œç¯å¢ƒè¿™ä¸ªæ¡ä»¶å˜é‡åŸºæœ¬æ˜¯æ§åˆ¶ä¸å˜</strong>çš„ã€‚</p><p>æ ¹æ®ä¸Šé¢çš„ä¸€äº›å› ç´ å¯ä»¥å¾—åˆ°ä¸€äº›å¯è¡Œçš„æ“ä½œæ–¹æ¡ˆ</p><ol><li>æ•°æ®åº“è¿æ¥å·¥å…·æ‰§è¡Œæ‰¹é‡sql</li><li>åŸºæœ¬çš„å¾ªç¯æ’å…¥</li><li>æ‹¼æ¥æ‰¹é‡ sql</li><li>ä½¿ç”¨preparedStatement + queryBatch</li><li>å¤šçº¿ç¨‹æå‡æ€§èƒ½</li></ol><h3 id="èµ°ä¸¤æ­¥è¯•è¯•"><a href="#èµ°ä¸¤æ­¥è¯•è¯•" class="headerlink" title="èµ°ä¸¤æ­¥è¯•è¯•"></a>èµ°ä¸¤æ­¥è¯•è¯•</h3><h4 id="æ•°æ®åº“ç¯å¢ƒ"><a href="#æ•°æ®åº“ç¯å¢ƒ" class="headerlink" title="æ•°æ®åº“ç¯å¢ƒ"></a>æ•°æ®åº“ç¯å¢ƒ</h4><blockquote><p>docker é»˜è®¤é…ç½® + mysql5.7</p></blockquote><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs zsh">docker pull mysql:5.7<br>docker run --name mysql-test -d -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 mysql:5.7<br></code></pre></td></tr></table></figure><h4 id="è¡¨ç»“æ„"><a href="#è¡¨ç»“æ„" class="headerlink" title="è¡¨ç»“æ„"></a>è¡¨ç»“æ„</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_order_test_1(<br>`id` <span class="hljs-type">int</span> auto_increment,<br>`good_id` <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;0&#x27;</span>,<br>`user_id` <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;0&#x27;</span>, <br>`good_status` tinyint <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;1&#x27;</span>,<br>`username` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;&#x27;</span>,<br><span class="hljs-keyword">primary</span> key(id)<br>) engine<span class="hljs-operator">=</span>innodb<br></code></pre></td></tr></table></figure><h4 id="æ•°æ®åº“è¿æ¥å·¥å…·æ‰§è¡Œæ‰¹é‡sql"><a href="#æ•°æ®åº“è¿æ¥å·¥å…·æ‰§è¡Œæ‰¹é‡sql" class="headerlink" title="æ•°æ®åº“è¿æ¥å·¥å…·æ‰§è¡Œæ‰¹é‡sql"></a>æ•°æ®åº“è¿æ¥å·¥å…·æ‰§è¡Œæ‰¹é‡sql</h4><p>ä»æ•°æ®åº“ä¸­åå‘å¯¼å‡ºæ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs sql">LOCK TABLES `tb_order_test_1` WRITE;<br><span class="hljs-comment">/*!40000 ALTER TABLE `tb_order_test_1` DISABLE KEYS */</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `tb_order_test_1` (`id`, `good_id`, `user_id`, `good_status`, `username`)<br><span class="hljs-keyword">VALUES</span><br>(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>..... <span class="hljs-number">100</span>w .....<br>(<span class="hljs-number">999997</span>,<span class="hljs-number">999996</span>,<span class="hljs-number">999996</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">999998</span>,<span class="hljs-number">999997</span>,<span class="hljs-number">999997</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">999999</span>,<span class="hljs-number">999998</span>,<span class="hljs-number">999998</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>),<br>(<span class="hljs-number">1000000</span>,<span class="hljs-number">999999</span>,<span class="hljs-number">999999</span>,<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;daiwei&#x27;</span>);<br><br><span class="hljs-comment">/*!40000 ALTER TABLE `tb_order_test_1` ENABLE KEYS */</span>;<br>UNLOCK TABLES;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œå¯¼å‡ºæ•°æ®å¯ä»¥å‘ç°ä¸¤ä¸ªé—®é¢˜ï¼Œé¦–å…ˆsql çš„å­˜å‚¨çš„æ–‡ä»¶æ˜¯æ‰¹é‡æ’å…¥çš„ï¼Œå…¶æ¬¡åœ¨æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œè¡¨æ˜¯é”å®šçŠ¶æ€çš„ã€‚</p><p>æœ€ç»ˆæ‰‹åŠ¨ğŸ™ˆæè¡¨æµ‹100w çš„æ•°æ®å¯¼å…¥å¤§æ¦‚éœ€è¦ 7.5 ç§’ã€‚</p><h4 id="åŸºç¡€çš„å¾ªç¯æ“ä½œæ’å…¥æ“ä½œ"><a href="#åŸºç¡€çš„å¾ªç¯æ“ä½œæ’å…¥æ“ä½œ" class="headerlink" title="åŸºç¡€çš„å¾ªç¯æ“ä½œæ’å…¥æ“ä½œ"></a>åŸºç¡€çš„å¾ªç¯æ“ä½œæ’å…¥æ“ä½œ</h4><p>è¿™ä¸ªæœ€åŸºæœ¬æœ€ç®€å•çš„å¾ªç¯æ’å…¥ï¼Œæ˜æ˜¾æ˜¯ä¸å¯èƒ½ä¼šæœ‰è¾ƒé«˜çš„æ’å…¥æ€§èƒ½çš„ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯æƒ³çŸ¥é“æœ€æ…¢ç€è¦å¤šä¹…ğŸ¤¤ã€‚è¿™æœ€åŸºæœ¬çš„å°±ä¸ç”¨é‚£äº›ORM æ¡†æ¶äº†å°±ç›´æ¥ä½¿ç”¨ jdbc æ“ä½œäº†ï¼Œå°è£…è¶Šé«˜é€Ÿåº¦ä¹Ÿå°±è¶Šæ…¢ã€‚åŒæ—¶ç¨å¾®æ§åˆ¶ä¸‹äº‹åŠ¡ï¼Œè¿™ç§ä¸è€ƒè™‘å¤§äº‹åŠ¡çš„å‰æä¸‹ï¼Œå‡å°‘äº‹åŠ¡æäº¤ï¼Œä¸€æ¬¡æäº¤ã€‚å¤§é‡æ•°æ®çš„æ’å…¥ä¼šå½±å“åˆ°æ•°æ®é¡µå¯¼è‡´é¡µåˆ†è£‚ï¼Œä¹Ÿä¼šæ‹–æ…¢æ•´ä½“çš„æ—¶é—´ï¼Œæ‰€ä»¥æ•´ä¸ªæµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œä¸é¢å¤–åˆ›å»ºç´¢å¼•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertByLoop</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>  Connection conn = JdbcUtil.getConnFromHikari();<br>  PreparedStatement stat = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>      String sql = <span class="hljs-string">&quot;insert into tb_order_test_1(good_id, user_id, good_status, username) values (?, ?, ?, ?)&quot;</span>;<br>      conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>      stat = conn.prepareStatement(sql);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">3000</span>; i++) &#123;<br>          stat.setLong(<span class="hljs-number">1</span>, i);<br>          stat.setLong(<span class="hljs-number">2</span>, i);<br>          stat.setInt(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<br>          stat.setString(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;daiwei&quot;</span>);<br>          stat.execute();<br>        &#125;<br>      conn.commit();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>      throwables.printStackTrace();<br>    &#125;<span class="hljs-keyword">finally</span> &#123;<br>      JdbcUtil.release(conn, stat, <span class="hljs-keyword">null</span>);<br>    &#125;<br>  System.out.println(System.currentTimeMillis() - start);<br>&#125;<br></code></pre></td></tr></table></figure><p>1wæ¡æ•°æ®æ’å…¥è€—æ—¶ 24015 msï¼Œæ’å…¥çš„æ•°æ®é‡å’Œæ’å…¥æ—¶é—´æ˜¯çº¿æ€§ç›¸å…³çš„ï¼Œæ‰€ä»¥å°±ä¸è¿‡å¤šçš„æµªè´¹æ—¶é—´äº†ã€‚ã€‚ã€‚ğŸ¤¨</p><h4 id="jdbc-batch-æ‰¹å¤„ç†"><a href="#jdbc-batch-æ‰¹å¤„ç†" class="headerlink" title="jdbc batch æ‰¹å¤„ç†"></a>jdbc batch æ‰¹å¤„ç†</h4><p>è¿™ä¸ªç‰ˆæœ¬çš„æ“ä½œç›¸è¾ƒäºä¸Šé¢çš„ä¸€ç§ï¼Œæœ€å¤§çš„æå‡å°±æ˜¯ç”¨äº†æ‰¹å¤„ç†æ“ä½œã€‚åœ¨æ‰¹é‡æ’å…¥ä¸Šæ€§èƒ½èƒ½æœ‰ä¸€å®šçš„æå‡ï¼Œä½†æ˜¯æå‡æ•ˆæœä¸æ˜¯å¾ˆå¤§ã€‚1w æ•°æ®é‡ 11358msã€‚<strong>ä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªå‚æ•°rewriteBatchedStatements=true</strong>ï¼ŒåŠ ä¸Šè¿™ä¸ªå‚æ•°å…è®¸å°†æ‰¹é‡å¤„ç†çš„ sql è¿›è¡Œé‡å†™ï¼Œæ¥æé«˜æ‰¹å¤„ç†æ€§èƒ½ï¼Œç›¸å½“äºé­”æ”¹äº†ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertSqlBatch</span><span class="hljs-params">()</span> </span>&#123;<br>  <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>  Connection conn = JdbcUtil.getConnFromHikari();<br>  PreparedStatement stat = <span class="hljs-keyword">null</span>;<br>  <span class="hljs-keyword">try</span> &#123;<br>      String sql = <span class="hljs-string">&quot;insert into tb_order_test_1(good_id, user_id, good_status, username) values (?, ?, ?, ?)&quot;</span>;<br>      conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>      stat = conn.prepareStatement(sql);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50000</span>; i++) &#123;<br>          stat.setLong(<span class="hljs-number">1</span>, i);<br>          stat.setLong(<span class="hljs-number">2</span>, i);<br>          stat.setInt(<span class="hljs-number">3</span>, <span class="hljs-number">1</span>);<br>          stat.setString(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;daiwei&quot;</span>);<br>          stat.addBatch();<br>        &#125;<br>      stat.executeBatch();<br>      conn.commit();<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>      throwables.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      JdbcUtil.release(conn, stat, <span class="hljs-keyword">null</span>);<br>    &#125;<br>  System.out.println(System.currentTimeMillis() - start);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">jdbc.url</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/test?rewriteBatchedStatements=true</span><br></code></pre></td></tr></table></figure><p>æ·»åŠ å‚æ•°ä¹‹åï¼Œbatch insert çš„æ€§èƒ½æœ‰æå¤§çš„æé«˜ã€‚100w çš„æ•°æ®é‡ 8775ms å°±æ“ä½œå®Œæˆã€‚</p><h4 id="æ‹¼æ¥sql-æ‰¹å¤„ç†"><a href="#æ‹¼æ¥sql-æ‰¹å¤„ç†" class="headerlink" title="æ‹¼æ¥sql + æ‰¹å¤„ç†"></a>æ‹¼æ¥sql + æ‰¹å¤„ç†</h4><p>åœ¨ä¸å¼€å¯rewriteBatchedStatements = true çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæˆ‘è‡ªå·±æ‰‹åŠ¨æ‹¼æ¥sql å‡å°‘ jdbc çš„å°è£…ï¼Œé€Ÿåº¦æ˜¯å¦èƒ½åœ¨å¾€ä¸Šæå‡å‘¢ï¼Ÿ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertByBatch</span><span class="hljs-params">()</span> </span>&#123;<br>  Connection conn = JdbcUtil.getConnFromHikari();<br>    Statement stat = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>    <span class="hljs-keyword">try</span> &#123;<br>      stat = conn.createStatement();<br>      String sql;<br>      StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;insert into tb_order_test_1(good_id, user_id, good_status, username) values&quot;</span>);<br>      conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) &#123;<br>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;<br>              sb.append(<span class="hljs-string">&quot;(&quot;</span> + i +<span class="hljs-string">&quot; , &quot;</span> + j +<span class="hljs-string">&quot;, 1 , &#x27;daiwei&#x27;),&quot;</span>);<br>            &#125;<br>          sql = sb.deleteCharAt(sb.length() - <span class="hljs-number">1</span>).toString();<br>          stat.addBatch(sql);<br>          sb.delete(<span class="hljs-number">75</span>, sb.length());<br>        &#125;<br>      stat.executeBatch();<br>      conn.commit();<br>      System.out.println(System.currentTimeMillis() - start);<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>      throwables.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      JdbcUtil.release(conn, stat, <span class="hljs-keyword">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ¡ˆè·‘ä¸‹æ¥ï¼Œä¼˜åŒ–æ•ˆæœè¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ï¼Œ100wçš„æ•°æ®æ’å…¥çš„æ—¶é—´å¤§æ¦‚åœ¨ 5s ï½6s è¿™ä¸ªåŒºé—´ã€‚</p><p>è¿™ä¸ªæ–¹æ¡ˆçš„å°ç¼ºç‚¹æ˜¯äº‹åŠ¡åˆ†å¼€çš„æ•´ä½“çš„æ•°æ®æ’å…¥ä¸æ˜¯åŸå­æ€§çš„ã€‚</p><h4 id="å¤šçº¿ç¨‹-æ‹¼æ¥sql-æ‰¹å¤„ç†"><a href="#å¤šçº¿ç¨‹-æ‹¼æ¥sql-æ‰¹å¤„ç†" class="headerlink" title="å¤šçº¿ç¨‹ + æ‹¼æ¥sql + æ‰¹å¤„ç†"></a>å¤šçº¿ç¨‹ + æ‹¼æ¥sql + æ‰¹å¤„ç†</h4><p>å•çº¿ç¨‹è·‘ä¸‹æ¥æ€§èƒ½éƒ½å·²ç»æå‡è¿™ä¹ˆæ˜æ˜¾äº†ï¼Œé‚£å¤šçº¿ç¨‹ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertConcurBatch</span><span class="hljs-params">()</span> </span>&#123;<br>  ExecutorService executor = Executors.newFixedThreadPool(<span class="hljs-number">4</span>);<br>  <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>  CyclicBarrier cyclicBarrier = <span class="hljs-keyword">new</span> CyclicBarrier(<span class="hljs-number">4</span>, () -&gt; &#123;<br>      System.out.println(System.currentTimeMillis() - start);<br>      executor.shutdown();<br>    &#125;);<br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;<br>      executor.execute(() -&gt; &#123;<br>          insertByBatch(<span class="hljs-number">250</span>);<br>          <span class="hljs-keyword">try</span> &#123;<br>              cyclicBarrier.await();<br>            &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>              e.printStackTrace();<br>            &#125; <span class="hljs-keyword">catch</span> (BrokenBarrierException e) &#123;<br>              e.printStackTrace();<br>            &#125;<br>        &#125;);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insertByBatch</span><span class="hljs-params">(<span class="hljs-keyword">int</span> n)</span> </span>&#123;<br>  Connection conn = JdbcUtil.getConnFromHikari();<br>    Statement stat = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>    <span class="hljs-keyword">try</span> &#123;<br>      stat = conn.createStatement();<br>      String sql;<br>      StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">&quot;insert into tb_order_test_1(good_id, user_id, good_status, username) values&quot;</span>);<br>      conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) &#123;<br>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) &#123;<br>              sb.append(<span class="hljs-string">&quot;(&quot;</span> + i +<span class="hljs-string">&quot; , &quot;</span> + j +<span class="hljs-string">&quot;, 1 , &#x27;daiwei&#x27;),&quot;</span>);<br>            &#125;<br>          sql = sb.deleteCharAt(sb.length() - <span class="hljs-number">1</span>).toString();<br>          stat.addBatch(sql);<br>          sb.delete(<span class="hljs-number">75</span>, sb.length());<br>        &#125;<br>      stat.executeBatch();<br>      conn.commit();<br>      System.out.println(System.currentTimeMillis() - start);<br>    &#125; <span class="hljs-keyword">catch</span> (SQLException throwables) &#123;<br>      throwables.printStackTrace();<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>      JdbcUtil.release(conn, stat, <span class="hljs-keyword">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>æœç„¶å‘æŒ¥å¤šçº¿ç¨‹çš„æ€§èƒ½ä¼˜åŠ¿ï¼Œæ•´ä½“æ€§èƒ½ä¼˜èƒ½å¾€ä¸Šæå‡ä¸€ç‚¹ç‚¹ã€‚</p><h3 id="æ³¥å·´è·¯ä¸Šèµ°ä¸€èµ°"><a href="#æ³¥å·´è·¯ä¸Šèµ°ä¸€èµ°" class="headerlink" title="æ³¥å·´è·¯ä¸Šèµ°ä¸€èµ°"></a>æ³¥å·´è·¯ä¸Šèµ°ä¸€èµ°</h3><p>å®é™…ç”Ÿäº§ç¯å¢ƒçš„è¯ï¼Œå¹¶ä¸ä¼šæœ‰å‡ ä¸ªè¡¨åªæœ‰ å‡ ä¸ªå­—æ®µï¼Œå¤šæ˜¯å­—æ®µ20+ ï¼Œæ‰€ä»¥å¦‚æœå­—æ®µå¤šä¸Šå»ï¼Œæ’å…¥æ€§èƒ½æ˜¯å¦ä¼šå—åˆ°å½±å“ï¼Ÿå¦‚æ­¤ä¾¿æœ‰äº†ä¸‹é¢çš„æµ‹è¯•</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `tb_order_test` (<br>  `id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `good_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `user_id` <span class="hljs-type">int</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `good_status` tinyint(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">&#x27;1&#x27;</span>,<br>  `field_4` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_5` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_6` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_7` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_8` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_9` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_10` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_11` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_12` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_13` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_14` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_15` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_16` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_17` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_18` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_19` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_20` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_21` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_22` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_23` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_24` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_25` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_26` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_27` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_28` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_29` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  `field_30` <span class="hljs-type">varchar</span>(<span class="hljs-number">16</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">5214001</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>latin1;<br></code></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç çš„è¯è¿™é‡Œç”¨çš„è¿˜æ˜¯ å¤šçº¿ç¨‹ + æ‹¼æ¥sql + æ‰¹å¤„ç† çš„ pro ç‰ˆæœ¬ï¼Œæœç„¶è¿™æ¬¡çš„æµ‹è¯•çš„é€Ÿåº¦æœ‰å¾ˆæ˜æ˜¾çš„ä¸‹é™ 100w çš„æ’å…¥æ—¶é—´ åˆ°äº† 19866msï¼Œæˆ‘çš„ç”µè„‘æ˜¯ 8 æ ¸çš„ï¼Œæœ¬ç€å……åˆ†åˆ©ç”¨ç³»ç»Ÿèµ„æºå’Œæ•°æ®åº“å¹¶å‘èµ„æºçš„åŸåˆ™ã€‚æœ€ç»ˆçš„ 100w æ—¶é—´åˆ°äº† 18080msã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸­æœ‰å¾ˆå¤šçš„ç¯å¢ƒå› ç´ ï¼šmysqlæ•°æ®åº“ã€sqlè¯­å¥å’Œ javaä»£ç ç­‰å¤šä¸ªæ–¹é¢ï¼Œå…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†å‡ºç°ç“¶é¢ˆï¼Œéƒ½ä¼šæ‹–ç´¯æ•´ä½“çš„æ€§èƒ½ï¼Œä½†æ˜¯å¦‚æœæ¢ä¸ªè§’åº¦å»çœ‹è¿™ä¸ªé—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬æ¯ä¸ªéƒ¨åˆ†çš„æ€§èƒ½éƒ½èƒ½å……åˆ†å‘æŒ¥æ•´ä½“çš„æ€§èƒ½ä¹Ÿç›¸åº”æé«˜ã€‚æœ¬æ¬¡çš„ä¼˜åŒ–è¿‡ç¨‹ä» sqléƒ¨åˆ†ï¼Œç¼–ç æŠ€å·§åˆ°è¡¨ç»“æ„ä¼˜åŒ–å»å°½å¯èƒ½æå‡100wæ•°æ®çš„æ’å…¥é€Ÿåº¦ã€‚è¿™é‡Œæ¼äº†ä¸€ä¸ªè§’åº¦ï¼Œå°±æ˜¯è°ƒæ•´mysql çš„å‚æ•°å»ä¼˜åŒ–ï¼Œåœ¨mysql å†™å…¥è¿‡ç¨‹ä¸­æœ‰ WAL æœºåˆ¶ï¼Œå¦‚æœè¿™é‡Œè°ƒå¤§ redolog buf å°½å¯èƒ½å°‘çš„å‡å°‘ redolog çš„ åˆ·è„é¡µæ“ä½œï¼Œæ˜¯å¦ä¹Ÿèƒ½æå‡å†™å…¥çš„æ€§èƒ½å‘¢ï¼ŸğŸ¤”ï¼Œæœ€åä¸‹é¢æ˜¯æœ¬æ¬¡æµ‹è¯•ç»“æœè¡¨æ ¼</p><table><thead><tr><th>æ’å…¥æ–¹å¼</th><th>1w</th><th>10w</th><th>100W</th></tr></thead><tbody><tr><td>æ•°æ®åº“å·¥å…·å¯¼å…¥</td><td>-</td><td>-</td><td>7500ms</td></tr><tr><td>å•ä¸ªäº‹åŠ¡å¾ªç¯æ’å…¥</td><td>24015ms</td><td>-</td><td>-</td></tr><tr><td>å•ä¸ªäº‹åŠ¡batchæ‰¹å¤„ç†</td><td>11358ms</td><td>-</td><td>-</td></tr><tr><td>é­”æ”¹ batch <br />ï¼ˆrewriteBatchedStatementsï¼‰</td><td>689ms</td><td>1562ms</td><td>8775ms</td></tr><tr><td>æ‹¼æ¥sql + æ‰¹å¤„ç†</td><td>105ms</td><td>992ms</td><td>5302ms</td></tr><tr><td>å¤šçº¿ç¨‹ + æ‹¼æ¥sql + æ‰¹å¤„ç†</td><td>-</td><td>-</td><td>4314ms</td></tr></tbody></table>]]></content>
    
    
    <categories>
      
      <category>éšç¬”è®°</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mysql</tag>
      
      <tag>jdbc</tag>
      
      <tag>å®æ“</tag>
      
      <tag>å­¦ä¹ ç¬”è®°</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
